var DeRender=(()=>{var mt=Object.defineProperty;var br=Object.getOwnPropertyDescriptor;var xr=Object.getOwnPropertyNames;var yr=Object.prototype.hasOwnProperty;var X=(o,e)=>()=>(o&&(e=o(o=0)),e);var pt=(o,e)=>{for(var t in e)mt(o,t,{get:e[t],enumerable:!0})},vr=(o,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of xr(e))!yr.call(o,r)&&r!==t&&mt(o,r,{get:()=>e[r],enumerable:!(i=br(e,r))||i.enumerable});return o};var _r=o=>vr(mt({},"__esModule",{value:!0}),o);var ft,c,z=X(()=>{ft=class{constructor(){this.enabled=!0,this.verbosity="info",this.maxLogs=100,this.logs=[],this.consoleHooked=!1,this.originalConsole={},this.outputElement=null,this.silenced=!1,this.silencedBuffer=[],this.maxSilencedLogs=5e3}setOutputElement(e){this.outputElement=e}setEnabled(e){this.enabled=e}setVerbosity(e){let t=this.verbosity==="silent";this.verbosity=e;let i=e==="silent";t&&!i?this.unsilence():!t&&i&&this.silence()}silence(){this.silenced||(this.silenced=!0,this.info("Entering silent mode - logs will be buffered",null,!1))}unsilence(){if(!this.silenced)return;let e=this.silencedBuffer.length;this.silenced=!1,this.flush(),this.info(`Exited silent mode - flushed ${e} buffered logs`,null,!1)}flush(){if(this.silencedBuffer.length===0)return;let e=this.silencedBuffer.length;this.info(`Flushing ${e} silenced logs...`,null,!1);let t=this.consoleHooked?this.originalConsole.log:console.log;for(let i of this.silencedBuffer){let r=`[${i.timestamp}] ${i.message}`;i.data?t(r,i.data):t(r),i.stack&&t("Stack trace:",i.stack)}this.logs.push(...this.silencedBuffer),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs)),this.silencedBuffer=[],this.updateUI()}clearSilencedBuffer(){let e=this.silencedBuffer.length;this.silencedBuffer=[],this.info(`Cleared ${e} buffered logs`,null,!1)}shouldLog(e){if(!this.enabled)return!1;let t={verbose:0,debug:1,info:2,warn:3,error:4,silent:0};return t[e]>=t[this.verbosity]}log(e,t,i=null,r=!0){if(!this.shouldLog(e))return;let n=new Date().toLocaleTimeString(),s=null;i instanceof Error&&(s=i.stack,i={message:i.message,name:i.name,stack:i.stack});let a={timestamp:n,level:e,message:t,data:i,stack:s};if(this.silenced&&r){this.silencedBuffer.push(a),this.silencedBuffer.length>this.maxSilencedLogs&&this.silencedBuffer.shift();return}this.logs.push(a),this.logs.length>this.maxLogs&&this.logs.shift();let l=this.consoleHooked?this.originalConsole.log:console.log,u=`[${n}] ${t}`;i?l(u,i):l(u),s&&l("Stack trace:",s),this.updateUI()}verbose(e,t=null,i=!0){this.log("verbose",e,t,i)}debug(e,t=null,i=!0){this.log("debug",e,t,i)}info(e,t=null,i=!0){this.log("info",e,t,i)}warn(e,t=null,i=!0){this.log("warn",e,t,i)}error(e,t=null,i=!0){this.log("error",e,t,i)}clear(){this.logs=[],this.updateUI()}updateUI(){let e=this.outputElement?$(this.outputElement):$("#debug-output");if(!(!e||e.length===0)){e.empty();for(let t of this.logs){let i=$('<div class="debug-log"></div>').addClass(t.level),r=$('<span class="debug-timestamp"></span>').text(t.timestamp),n=$("<span></span>").text(t.message);if(i.append(r).append(n),t.data){let s=typeof t.data=="object"?JSON.stringify(t.data,null,2):String(t.data),a=$("<span></span>").text(" | "+s).css("color","#888");i.append(a)}if(t.stack){let s=$("<span></span>").text(" [stack]").css({color:"#ff6b6b",cursor:"pointer","text-decoration":"underline"}),a=$("<pre></pre>").text(t.stack).css({display:"none",color:"#ff6b6b","font-size":"9px",margin:"4px 0 0 20px",padding:"4px",background:"#2a0000","border-left":"2px solid #ff6b6b","overflow-x":"auto"});s.on("click",function(){a.toggle()}),i.append(s),i.append(a)}e.append(i)}e.scrollTop(e[0].scrollHeight)}}getLogs(){return this.logs}getSilencedBuffer(){return this.silencedBuffer}isSilenced(){return this.silenced}getBufferStats(){return{silenced:this.silenced,bufferSize:this.silencedBuffer.length,maxBufferSize:this.maxSilencedLogs,bufferUsagePercent:Math.round(this.silencedBuffer.length/this.maxSilencedLogs*100)}}hookConsole(){if(this.consoleHooked){this.warn("Console already hooked");return}this.originalConsole={log:console.log,info:console.info,warn:console.warn,error:console.error};let e=this;console.log=function(...t){e.originalConsole.log.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.debug("[console.log] "+i)},console.info=function(...t){e.originalConsole.info.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.debug("[console.info] "+i)},console.warn=function(...t){e.originalConsole.warn.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.warn("[console] "+i)},console.error=function(...t){e.originalConsole.error.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.error("[console] "+i)},this.consoleHooked=!0,this.info("Console hooked - browser console calls will echo to debug console")}unhookConsole(){if(!this.consoleHooked){this.warn("Console not hooked");return}console.log=this.originalConsole.log,console.info=this.originalConsole.info,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,this.consoleHooked=!1,this.info("Console unhooked - restored original behavior")}},c=new ft});function gi(o){return o=o.replace(/([a-z]+)\^(\d+)/g,(e,t,i)=>{let r=parseInt(i);return r===0?"1":r===1?t:Array(r).fill(t).join("*")}),o=o.replace(/pow\(([a-z]+),\s*(\d+)\)/g,(e,t,i)=>{let r=parseInt(i);return r===0?"1":r===1?t:r<=4?Array(r).fill(t).join("*"):e}),o}function ee(o,e){if(c.verbosity="verbose",c.info("=== JACOBIAN COMPUTATION START ==="),c.info("Timestamp:",new Date().toISOString()),c.info("Nerdamer loaded:",!!window.nerdamer),c.info("Nerdamer type:",typeof window.nerdamer),c.info("Nerdamer is function:",typeof window.nerdamer=="function"),c.info("Nerdamer.diff exists:",window.nerdamer&&typeof window.nerdamer.diff=="function"),c.info("Nerdamer.clear exists:",window.nerdamer&&typeof window.nerdamer.clear=="function"),c.info("Input expressions:",o.toString()),c.info("Dimensions:",e),!window.nerdamer)return c.error("Nerdamer not loaded - cannot compute Jacobian"),null;if(typeof window.nerdamer!="function")return c.error("Nerdamer is not a function - invalid state"),null;if(!window.nerdamer.diff)return c.error("Nerdamer.diff not available - incomplete initialization"),null;try{window.nerdamer&&window.nerdamer.clear&&(c.verbose("Clearing Nerdamer cache"),window.nerdamer.clear("all")),c.verbose("Testing Nerdamer consistency...");try{let s=window.nerdamer.diff(window.nerdamer("x*y"),"x").toString();window.nerdamer.clear("all");let a=window.nerdamer.diff(window.nerdamer("x*y"),"x").toString();c.verbose("Consistency test: d(x*y)/dx"),c.verbose(`  First result:  ${s}`),c.verbose(`  Second result: ${a}`),c.verbose(`  Consistent: ${s===a}`),s!==a&&c.error("WARNING: Nerdamer is giving inconsistent results!")}catch(r){c.warn("Consistency test failed:",r.message)}let t=o.map(r=>{let n=r.replace(/atan2\s*\(\s*([^,]+)\s*,\s*([^)]+)\s*\)/g,"atan(($1)/($2))");return n!==r&&c.verbose(`Replaced atan2 for differentiation: "${r}" \u2192 "${n}"`),n}),i=[];for(let r=0;r<e;r++){let n=[],s=t[r];c.verbose(`Row ${r}: differentiating expression "${s}"`);for(let a=0;a<e;a++){let l=Cr[a];try{c.verbose(`  Computing \u2202(${s})/\u2202${l}...`);let u=window.nerdamer.diff(window.nerdamer(s),l).toString();c.verbose(`  Raw derivative: ${u}`);let d=gi(u);c.verbose(`  Optimized: ${d}`),n.push(d)}catch(u){c.warn(`Failed to differentiate expression "${s}" w.r.t. ${l}: ${u.message}`),n.push("0")}}i.push(n)}c.info("=== JACOBIAN COMPUTATION COMPLETE ==="),c.info("Final Jacobian matrix:");for(let r=0;r<i.length;r++)c.info(`  Row ${r}: [${i[r].join(", ")}]`);return i}catch(t){return c.error("Failed to compute Jacobian matrix",t),null}}function Te(o){if(!o||!Array.isArray(o))return!1;for(let e of o){if(!Array.isArray(e))return!1;for(let t of e)if(typeof t!="string"||t==="")return!1}return!0}function vt(o){if(!o||!Array.isArray(o))return c.error("Invalid Jacobian for inversion"),null;let e=o.length;if(e<2||e>4)return c.error(`Jacobian inversion only supported for 2x2, 3x3, and 4x4 matrices (got ${e}x${e})`),null;try{let t=o.map(r=>`[${r.join(",")}]`).join(",");c.verbose("Inverting Jacobian matrix:",`matrix(${t})`),window.nerdamer.setVar("J_temp",`matrix(${t})`),window.nerdamer.setVar("J_inv","invert(J_temp)");let i=[];for(let r=0;r<e;r++){let n=[];for(let s=0;s<e;s++){let a=window.nerdamer(`matget(J_inv, ${r}, ${s})`).toString(),l=gi(a);n.push(l)}i.push(n)}c.verbose("Inverted Jacobian:");for(let r=0;r<i.length;r++)c.verbose(`  Row ${r}: [${i[r].join(", ")}]`);return i}catch(t){return c.error("Failed to invert Jacobian:",t.message),null}}var Cr,_t=X(()=>{z();Cr=["x","y","z","w","u","v"]});function Hr(o){let e=[],t=/atan2\s*\(\s*([^,]+)\s*,\s*([^)]+)\s*\)/g,i;for(;(i=t.exec(o))!==null;)e.push({fullMatch:i[0],numerator:i[1].trim(),denominator:i[2].trim()});return e}function Ri(o,e){let{numerator:t,denominator:i,fullMatch:r}=e,n=`PI/2 - atan2(${i}, ${t})`,s=o.map(l=>l.replace(r,n));return{condition:`abs(${i}) <= abs(${t})`,forwardTransforms:s}}function Ci(o,e){let t=[],i=[];if(o.forEach((r,n)=>{Hr(r).forEach(a=>{i.push({...a,transformIndex:n})})}),i.length===0)return[{condition:"true",forwardTransforms:o}];if(e===2||e===3&&i.length===1){let r=i[0];return t.push({condition:`abs(${r.denominator}) >= abs(${r.numerator})`,forwardTransforms:o}),t.push(Ri(o,r)),t}if(e===3&&i.length>=2){let r=i[i.length-1];return t.push({condition:`abs(${r.denominator}) >= abs(${r.numerator})`,forwardTransforms:o}),t.push(Ri(o,r)),t}return[{condition:"true",forwardTransforms:o}]}function Mi(o,e){if(o==="true")return"true";let t=o;return e.forEach((i,r)=>{let n=["x","y","z","w"][r],s=new RegExp(`\\b${i}\\b`,"g");t=t.replace(s,`pos.${n}`)}),t=t.replace(/\bPI\b/g,"3.14159265359"),t}var Li=X(()=>{});var Bi={};pt(Bi,{CoordinateSystem:()=>k,PRESET_COORDINATE_SYSTEMS:()=>se,createCartesianSystem:()=>Pi,getCartesianSystem:()=>j,getCoordinateSystem:()=>Xr,getPresetsForDimension:()=>Bt});function Xr(o){return se[o]||null}function Bt(o){let e=[];for(let[t,i]of Object.entries(se))i.dimensions===o&&e.push({key:t,system:i});return e}function j(o){let e=`cartesian${o}d`;return se[e]||Pi(o)}function Pi(o){let e=["x","y","z","w","u","v"].slice(0,o);return new k(`Cartesian ${o}D`,o,e.map(t=>({label:t,displayLabel:t})),e)}var k,se,re=X(()=>{_t();Li();k=class o{constructor(e,t,i,r,n=null,s=!1,a=null){this.name=e,this.dimensions=t,this.variables=i,this.forwardTransforms=r,this.inverseTransforms=n,this.useIterativeSolver=s,this.charts=a||Ci(r,t)}getVariableNames(){return this.variables.map(e=>e.label)}getDisplayLabels(){return this.variables.map(e=>e.displayLabel)}generateForwardTransformGLSL(e,t){let i=this.getVariableNames(),r=`vec${this.dimensions}`,n=this.forwardTransforms.map((s,a)=>{let l=t(s,e);return`    result.${["x","y","z","w"][a]} = ${l};`}).join(`
`);return`
// Forward transform: Cartesian \u2192 ${this.name}
${r} transformToNative(${r} pos) {
    ${r} result;
    float ${e.map((s,a)=>`${s} = pos.${["x","y","z","w"][a]}`).join(", ")};
${n}
    return result;
}`}generateVelocityTransformGLSL(e,t){if(this.charts&&this.charts.length>1)return this.generateMultiChartVelocityTransformGLSL(e,t);let i=this.charts&&this.charts.length===1?this.charts[0].forwardTransforms:this.forwardTransforms,r=ee(i,this.dimensions);if(!r)return console.error("Failed to compute Jacobian for coordinate system:",this.name),`
// Velocity transform: ${this.name} \u2192 Cartesian (IDENTITY FALLBACK - ERROR)
// WARNING: Jacobian computation failed, using identity transform
vec${this.dimensions} transformVelocityToCartesian(vec${this.dimensions} vel_native, vec${this.dimensions} pos) {
    return vel_native; // INCORRECT: Should use inverse Jacobian
}`;let n=vt(r);if(!n)return console.error("Failed to invert Jacobian for coordinate system:",this.name),console.error("Forward Jacobian was:",r),`
// Velocity transform: ${this.name} \u2192 Cartesian (IDENTITY FALLBACK - ERROR)
// WARNING: Jacobian inversion failed, using identity transform
// This will produce INCORRECT results for non-Cartesian coordinates!
vec${this.dimensions} transformVelocityToCartesian(vec${this.dimensions} vel_native, vec${this.dimensions} pos) {
    return vel_native; // INCORRECT: Jacobian inversion failed
}`;let s=`vec${this.dimensions}`,a=["x","y","z","w"],l=[];for(let u=0;u<this.dimensions;u++){let h=n[u].map((p,m)=>`(${t(p,e)}) * vel_native.${a[m]}`);l.push(`    result.${a[u]} = ${h.join(" + ")};`)}return`
// Velocity transform: ${this.name} \u2192 Cartesian via Inverse Jacobian
// J_forward = [${r.map(u=>"["+u.join(", ")+"]").join(`,
//             `)}]
// J_inverse = [${n.map(u=>"["+u.join(", ")+"]").join(`,
//             `)}]
${s} transformVelocityToCartesian(${s} vel_native, ${s} pos) {
    ${s} result;
    float ${e.map((u,d)=>`${u} = pos.${a[d]}`).join(", ")};
${l.join(`
`)}
    return result;
}`}generateMultiChartVelocityTransformGLSL(e,t){let i=`vec${this.dimensions}`,r=["x","y","z","w"],n=this.charts.map((l,u)=>{let d=ee(l.forwardTransforms,this.dimensions);if(!d)return console.warn(`Failed to compute Jacobian for chart ${u} of ${this.name}`),null;let h=vt(d);if(!h)return console.warn(`Failed to invert Jacobian for chart ${u} of ${this.name}`),null;let p=[];for(let m=0;m<this.dimensions;m++){let b=h[m].map((x,g)=>`(${t(x,e)}) * vel_native.${r[g]}`);p.push(`        result.${r[m]} = ${b.join(" + ")};`)}return{condition:l.condition,jacobian:d,inverseJacobian:h,matrixMultCode:p}}).filter(l=>l!==null);if(n.length===0)return console.error("All charts failed for coordinate system:",this.name),`
// Velocity transform: ${this.name} \u2192 Cartesian (ERROR: All charts failed)
${i} transformVelocityToCartesian(${i} vel_native, ${i} pos) {
    return vel_native; // FALLBACK: All charts failed
}`;let s=n.map((l,u)=>{let d=Mi(l.condition,e),h=u===0?"if":"else if",p=d==="true"?"":` (${d})`;return`    ${h}${p} {
        // Chart ${u+1}: Avoid singularities when ${l.condition}
${l.matrixMultCode.join(`
`)}
    }`}).join(" "),a=n.map((l,u)=>`// Chart ${u+1}: condition=${l.condition}
//   J_forward = [${l.jacobian.map(d=>"["+d.join(", ")+"]").join(`,
//               `)}]
//   J_inverse = [${l.inverseJacobian.map(d=>"["+d.join(", ")+"]").join(`,
//               `)}]`).join(`
`);return`
// Velocity transform: ${this.name} \u2192 Cartesian via Multiple Charts
// Using ${n.length} charts to handle coordinate singularities
${a}
${i} transformVelocityToCartesian(${i} vel_native, ${i} pos) {
    ${i} result;
    float ${e.map((l,u)=>`${l} = pos.${r[u]}`).join(", ")};
${s}
    return result;
}`}generateInverseTransformGLSL(e,t){let i=`vec${this.dimensions}`,r=["x","y","z","w"],n=["x","y","z","w","u","v"].slice(0,this.dimensions);if(this.inverseTransforms&&this.inverseTransforms.length===this.dimensions){let s=this.inverseTransforms.map((a,l)=>`    result.${r[l]} = ${a};`).join(`
`);return`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// Using explicit inverse transform (Tier 1)
${i} transformToCartesian(${i} native_pos) {
    ${i} result;
    float ${e.map((a,l)=>`${a} = native_pos.${r[l]}`).join(", ")};
${s}
    return result;
}`}return this.useIterativeSolver?this.generateNewtonSolverGLSL(n,e,t):(console.warn(`No inverse transform defined for ${this.name}, using identity`),`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// WARNING: Using identity fallback - no inverse defined!
${i} transformToCartesian(${i} native_pos) {
    return native_pos; // INCORRECT: Identity fallback
}`)}generateNewtonSolverGLSL(e,t,i){let r=`vec${this.dimensions}`,n=`mat${this.dimensions}`,s=["x","y","z","w"],a=this.forwardTransforms.map((d,h)=>{let p=i(d,e);return`        native.${s[h]} = ${p};`}).join(`
`),l=ee(this.forwardTransforms,this.dimensions);if(!l)return console.error("Failed to compute Jacobian for Newton solver:",this.name),`
// Newton solver failed: could not compute Jacobian
${r} transformToCartesian(${r} native_pos) {
    return native_pos; // ERROR FALLBACK
}`;let u=[];for(let d=0;d<this.dimensions;d++)for(let h=0;h<this.dimensions;h++){let p=i(l[d][h],e);u.push(`        J[${d}][${h}] = ${p};`)}return`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// Using Newton's method iterative solver (Tier 3)
${r} transformToCartesian(${r} native_target) {
    // Use previous position as initial guess (stored in global)
    ${r} guess = vec${this.dimensions}(0.0); // TODO: Use previous frame position

    const int MAX_ITERATIONS = 10;
    const float TOLERANCE = 1e-6;

    for(int iter = 0; iter < MAX_ITERATIONS; iter++) {
        // Evaluate forward transform at current guess
        ${r} native;
        float ${e.map((d,h)=>`${d} = guess.${s[h]}`).join(", ")};
${a}

        // Compute error
        ${r} error = native - native_target;
        if(length(error) < TOLERANCE) {
            break; // Converged
        }

        // Build Jacobian matrix J = \u2202(native)/\u2202(cartesian)
        ${n} J;
${u.join(`
`)}

        // Newton step: guess -= inverse(J) * error
        guess -= inverse(J) * error;
    }

    return guess;
}`}toJSON(){return{name:this.name,dimensions:this.dimensions,variables:this.variables,forwardTransforms:this.forwardTransforms,inverseTransforms:this.inverseTransforms,useIterativeSolver:this.useIterativeSolver}}static fromJSON(e){return new o(e.name,e.dimensions,e.variables,e.forwardTransforms,e.inverseTransforms||null,e.useIterativeSolver||!1)}},se={cartesian2d:new k("Cartesian 2D",2,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"}],["x","y"],["x","y"]),polar2d:new k("Polar 2D",2,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"}],["sqrt(x^2 + y^2)","atan2(y, x)"],["r*cos(theta)","r*sin(theta)"]),cartesian3d:new k("Cartesian 3D",3,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"},{label:"z",displayLabel:"z"}],["x","y","z"],["x","y","z"]),cylindrical3d:new k("Cylindrical 3D",3,[{label:"rho",displayLabel:"\u03C1"},{label:"phi",displayLabel:"\u03C6"},{label:"z",displayLabel:"z"}],["sqrt(x^2 + y^2)","atan2(y, x)","z"],["rho*cos(phi)","rho*sin(phi)","z"]),spherical3d:new k("Spherical 3D",3,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"},{label:"phi",displayLabel:"\u03C6"}],["sqrt(x^2 + y^2 + z^2)","acos(z / sqrt(x^2 + y^2 + z^2))","atan2(y, x)"],["r*sin(theta)*cos(phi)","r*sin(theta)*sin(phi)","r*cos(theta)"]),cartesian4d:new k("Cartesian 4D",4,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"},{label:"z",displayLabel:"z"},{label:"w",displayLabel:"w"}],["x","y","z","w"],["x","y","z","w"]),hyperspherical4d:new k("Hyperspherical 4D",4,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"},{label:"phi",displayLabel:"\u03C6"},{label:"psi",displayLabel:"\u03C8"}],["sqrt(x^2 + y^2 + z^2 + w^2)","acos(w / sqrt(x^2 + y^2 + z^2 + w^2))","acos(z / sqrt(x^2 + y^2 + z^2))","atan2(y, x)"],["r*sin(theta)*sin(phi)*cos(psi)","r*sin(theta)*sin(phi)*sin(psi)","r*sin(theta)*cos(phi)","r*cos(theta)"])}});var Ii={};pt(Ii,{decodeFloatRGBA:()=>Dt,encodeFloatRGBA:()=>It,getDecodeGLSL:()=>qr,getEncodeGLSL:()=>Wr,getFixedPointConstantsGLSL:()=>jr});function It(o,e,t){o=Math.max(0,Math.min(1,o));let i=Math.floor(o*4294967295);e[t+0]=i>>>24&255,e[t+1]=i>>>16&255,e[t+2]=i>>>8&255,e[t+3]=i&255}function Dt(o,e,t,i){return((o<<24|e<<16|t<<8|i)>>>0)/4294967295}function jr(){return`
// Map to [0, 1] range for maximum precision at any zoom level
const float FIXED_POINT_SCALE = 4294967295.0; // 2^32 - 1
`}function Wr(){return`
// Encode float in [0, 1] range to RGBA bytes
vec4 encodeFloat(float v) {
    // Clamp to [0, 1]
    v = clamp(v, 0.0, 1.0);

    // Map to [0, 2^32-1]
    float normalized = v * FIXED_POINT_SCALE;

    // Split into 4 bytes (big-endian)
    float byte0 = floor(normalized / 16777216.0);  // 2^24
    normalized -= byte0 * 16777216.0;
    float byte1 = floor(normalized / 65536.0);      // 2^16
    normalized -= byte1 * 65536.0;
    float byte2 = floor(normalized / 256.0);        // 2^8
    normalized -= byte2 * 256.0;
    float byte3 = floor(normalized);

    return vec4(byte0, byte1, byte2, byte3) / 255.0;
}

// Helper to normalize world coordinate to [0, 1] relative to viewport
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return (worldValue - minVal) / (maxVal - minVal);
}

// Helper to denormalize from [0, 1] back to world coordinates
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return minVal + normalized * (maxVal - minVal);
}
`}function qr(){return`
// Decode RGBA bytes back to float in [0, 1] range
float decodeFloat(vec4 rgba) {
    // Reconstruct 32-bit integer from bytes (big-endian)
    vec4 bytes = rgba * 255.0;
    float intValue = bytes.r * 16777216.0 + bytes.g * 65536.0 + bytes.b * 256.0 + bytes.a;

    // Map from [0, 2^32-1] back to [0, 1]
    return intValue / FIXED_POINT_SCALE;
}
`}var Vt=X(()=>{});function Pe(o,...e){return e.reduce((t,i)=>i(t),o)}var Ht,Xt,jt,nr=X(()=>{Ht=o=>class extends o{constructor(){super(),this.settingsKey=null,this.defaultValue=null,this.onChange=null,this._callback=null}initializeControlProperties(){this.settingsKey=this.getAttribute("settings-key")||this.id;let e=this.getAttribute("default");e!==null&&this.defaultValue===null&&(this.defaultValue=parseFloat(e))}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}reset(){this.defaultValue!==null&&this.defaultValue!==void 0&&this.setValue(this.defaultValue)}attachListeners(e){this._callback=e}triggerChange(){let e=this.getValue();this.onChange&&typeof this.onChange=="function"&&this.onChange(e),this._callback&&typeof this._callback=="function"&&this._callback(),this.dispatchEvent(new CustomEvent("control-change",{detail:{value:e},bubbles:!0}))}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}},Xt=o=>class extends o{handleButtonAction(e){return e==="reset"?(this.reset(),!0):!1}registerActionButtons(e){for(let t of e){let i=this.querySelectorAll(`[${t}]`);for(let r of i)r.addEventListener("click",()=>{this.handleButtonAction(t)&&this.triggerChange})}}},jt=o=>class extends o{getNumberAttribute(e,t=0){let i=this.getAttribute(e);if(i===null)return t;let r=parseFloat(i);return isNaN(r)?t:r}getBooleanAttribute(e,t=!1){let i=this.getAttribute(e);return i===null?t:i===""||i===e?!0:i==="true"}}});var Wt,or=X(()=>{Wt=o=>class extends o{constructor(){super(),this.animationEnabled=!1,this.animationMin=null,this.animationMax=null,this.currentAlpha=0,this.isAnimating=!1}connectedCallback(){super.connectedCallback();let e=this.getAttribute("animation-min"),t=this.getAttribute("animation-max");e!==null&&(this.animationMin=parseFloat(e)),t!==null&&(this.animationMax=parseFloat(t)),this.animationMin===null&&(this.animationMin=this.min||0),this.animationMax===null&&(this.animationMax=this.max||100)}attachInternalListeners(){super.attachInternalListeners(),this.addAnimationButton(),this.addAnimationBoundsUI(),this.attachThumbDragHandlers()}addAnimationButton(){let e=this.querySelector(".slider-control");if(!e)return;let t=document.createElement("button");t.id=`${this.id}-anim-btn`,t.className="slider-btn anim-btn",t.title="Enable animation (\u{1F3AC})",t.textContent="\u{1F3AC}",t.addEventListener("click",i=>{i.stopPropagation(),this.setAnimationEnabled(!this.animationEnabled)}),e.appendChild(t)}addAnimationBoundsUI(){let e=this.querySelector(".slider-control");if(!e)return;let t=`
            <div id="${this.id}-animation-bounds" class="animation-bounds-slider" style="display: none;">
                <div class="bounds-labels">
                    <span>Min: <span id="${this.id}-min-display">${this.formatValue(this.animationMin)}</span></span>
                    <span>Max: <span id="${this.id}-max-display">${this.formatValue(this.animationMax)}</span></span>
                </div>
                <div class="multi-thumb-slider">
                    <div class="slider-track"></div>
                    <div id="${this.id}-range" class="slider-range"></div>
                    <div id="${this.id}-current-indicator" class="slider-current-indicator"></div>
                    <div id="${this.id}-min-handle" class="slider-thumb min-thumb" data-bound="min">
                        <span class="thumb-label">MIN</span>
                    </div>
                    <div id="${this.id}-max-handle" class="slider-thumb max-thumb" data-bound="max">
                        <span class="thumb-label">MAX</span>
                    </div>
                </div>
            </div>
        `;e.insertAdjacentHTML("afterend",t)}setAnimationEnabled(e){this.animationEnabled=e,this.updateAnimationUI()}updateAnimationUI(){let e=document.getElementById(`${this.id}-animation-bounds`),t=document.getElementById(`${this.id}-anim-btn`);!e||!t||(this.animationEnabled?(typeof $<"u"?$(e).slideDown(200,()=>{this.triggerAccordionResize&&this.triggerAccordionResize()}):(e.style.display="block",this.triggerAccordionResize&&this.triggerAccordionResize()),t.classList.add("active"),t.title="Disable animation (\u{1F3AC})",this.updateBoundsDisplay()):(typeof $<"u"?$(e).slideUp(200,()=>{this.triggerAccordionResize&&this.triggerAccordionResize()}):(e.style.display="none",this.triggerAccordionResize&&this.triggerAccordionResize()),t.classList.remove("active"),t.title="Enable animation (\u{1F3AC})"))}setAnimationBounds(e,t){this.animationMin=Math.min(e,t),this.animationMax=Math.max(e,t),this.updateBoundsDisplay()}updateFromAlpha(e){if(!this.animationEnabled)return;this.currentAlpha=e;let t=this.animationMin+e*(this.animationMax-this.animationMin);this.isAnimating=!0,this.setValue(t),this.updateCurrentIndicator(e),this.isAnimating=!1}updateCurrentIndicator(e){let t=document.getElementById(`${this.id}-current-indicator`);t&&(t.style.left=`${e*100}%`)}updateBoundsDisplay(){let e=document.getElementById(`${this.id}-min-handle`),t=document.getElementById(`${this.id}-max-handle`),i=document.getElementById(`${this.id}-min-display`),r=document.getElementById(`${this.id}-max-display`),n=document.getElementById(`${this.id}-range`);if(!e||!t)return;let s=this.valueToPercent(this.animationMin),a=this.valueToPercent(this.animationMax);e.style.left=`${s}%`,t.style.left=`${a}%`,n&&(n.style.left=`${s}%`,n.style.width=`${a-s}%`),i&&(i.textContent=this.formatValue(this.animationMin)),r&&(r.textContent=this.formatValue(this.animationMax))}valueToPercent(e){let t=this.min||0,i=this.max||100;return(e-t)/(i-t)*100}percentToValue(e){let t=this.min||0,i=this.max||100;return t+e/100*(i-t)}attachThumbDragHandlers(){let e=document.getElementById(`${this.id}-min-handle`),t=document.getElementById(`${this.id}-max-handle`);if(!e||!t)return;let i=e.parentElement;[{handle:e,bound:"min"},{handle:t,bound:"max"}].forEach(({handle:r,bound:n})=>{let s=!1;r.addEventListener("mousedown",a=>{s=!0,r.classList.add("dragging"),document.body.style.userSelect="none",a.preventDefault()}),document.addEventListener("mousemove",a=>{if(!s)return;let l=i.getBoundingClientRect(),u=a.clientX-l.left,d=l.width,h=u/d*100;h=Math.max(0,Math.min(100,h));let p=this.percentToValue(h);n==="min"?p<=this.animationMax&&(this.animationMin=p):p>=this.animationMin&&(this.animationMax=p),this.updateBoundsDisplay()}),document.addEventListener("mouseup",()=>{s&&(s=!1,r.classList.remove("dragging"),document.body.style.userSelect="")})})}saveToSettings(e){super.saveToSettings(e),this.animationEnabled&&(e.animations||(e.animations={}),e.animations[this.settingsKey]={enabled:!0,min:this.animationMin,max:this.animationMax})}restoreFromSettings(e){if(super.restoreFromSettings(e),e&&e.animations&&e.animations[this.settingsKey]){let t=e.animations[this.settingsKey];this.animationEnabled=t.enabled||!1,this.animationMin=t.min,this.animationMax=t.max,requestAnimationFrame(()=>{this.updateAnimationUI()})}}}});var qt,sr=X(()=>{qt=o=>class extends o{constructor(){super(),this._resizeObserver=null,this._accordionSection=null}connectedCallback(){super.connectedCallback(),requestAnimationFrame(()=>{this.setupAccordionResize()})}disconnectedCallback(){super.disconnectedCallback&&super.disconnectedCallback(),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null)}setupAccordionResize(){if(this._accordionSection=this.closest(".accordion-section"),!!this._accordionSection){if(typeof ResizeObserver>"u"){console.warn("ResizeObserver not available, accordion auto-resize disabled");return}this._resizeObserver=new ResizeObserver(e=>{this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(()=>{this.resizeAccordion()},50)}),this._resizeObserver.observe(this)}}resizeAccordion(){if(!this._accordionSection||this._accordionSection.classList.contains("collapsed"))return;let e=this._accordionSection.scrollHeight+"px";this._accordionSection.style.maxHeight=e}triggerAccordionResize(){this._accordionSection&&requestAnimationFrame(()=>{this.resizeAccordion()})}}});var Jt,ar=X(()=>{Jt=o=>class extends o{constructor(){super(),this._shadowRoot=null}ensureShadowRoot(){return this._shadowRoot||(this._shadowRoot=this.attachShadow({mode:"open"})),this._shadowRoot}getShadowRoot(){return this.ensureShadowRoot()}renderToShadow(e){let t=this.ensureShadowRoot();t.innerHTML=e}shadowQuery(e){return this._shadowRoot?this._shadowRoot.querySelector(e):null}shadowQueryAll(e){return this._shadowRoot?this._shadowRoot.querySelectorAll(e):[]}querySelector(e){return this._shadowRoot?this._shadowRoot.querySelector(e):super.querySelector(e)}querySelectorAll(e){return this._shadowRoot?this._shadowRoot.querySelectorAll(e):super.querySelectorAll(e)}}});var Kt,lr=X(()=>{Kt=o=>class extends o{constructor(){super(),this._childControls=new Map}registerChildControl(e,t,i,r){this._childControls.set(e,{getValue:t,setValue:i,reset:r})}getValue(){let e={};for(let[t,i]of this._childControls.entries())e[t]=i.getValue();return e}setValue(e){if(!(typeof e!="object"||e===null))for(let[t,i]of this._childControls.entries())e[t]!==void 0&&i.setValue(e[t])}reset(){for(let e of this._childControls.values())e.reset()}initializeChildren(){throw new Error("Subclass must implement initializeChildren()")}}});var st=X(()=>{nr();or();sr();ar();lr()});var H,ne=X(()=>{st();H=class extends Pe(HTMLElement,Ht,Xt,jt,qt){constructor(){super(),this.transform=1,this._bindings=new Map,this._boundProperties=new Set,this._initialized=!1}connectedCallback(){this._initialized||(this.id||(this.id=this.generateId()),this.initializeControlProperties(),this.initializeProperties(),this.discoverBoundProperties(),this.processTemplate(),this.attachInternalListeners(),this._initialized=!0)}generateId(){return`control-${Math.random().toString(36).substr(2,9)}`}initializeProperties(){}discoverBoundProperties(){for(let e of this.attributes)if(e.name.startsWith("bind-")){let t=e.value;this._boundProperties.add(t)}}processTemplate(){let e=null,t=this.getAttribute("template");if(t){let l=document.getElementById(t);l&&l.tagName==="TEMPLATE"&&(e=l.content.cloneNode(!0))}if(!e){let l=this.querySelector(":scope > template");l&&(e=l.content.cloneNode(!0))}let i;e?(this.innerHTML="",this.appendChild(e),i=this):i=this;let r=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT,null,!1),n=[],s;for(;s=r.nextNode();)if(s!==this)for(let l of Array.from(s.attributes)){let u=l.value.match(/\{\{(\w+)\}\}/g);if(u){let d=l.value;u.forEach(h=>{let p=h.slice(2,-2);if(p in this&&this[p]!==void 0){let m=this[p];d=d.replace(h,m),n.push({element:s,attrName:l.name,varName:p})}}),l.value=d}}let a=this.innerHTML;a=a.replace(/\{\{(\w+)\}\}/g,(l,u)=>u in this&&this[u]!==void 0?this.formatValue(this[u]):l),this.innerHTML=a;for(let l of n)this.registerAttributeBinding(l.varName,l.attrName);this.registerBindings(this)}registerAttributeBinding(e,t){let i=this.querySelectorAll(`[${t}]`);for(let r of i)this._bindings.has(e)||this._bindings.set(e,new Set),this._bindings.get(e).add({element:r,type:"attr",attr:t})}registerBindings(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1),i;for(;i=t.nextNode();)if(i!==this)for(let r of i.attributes)r.name.startsWith("bind-")&&this.registerBinding(i,r.name,r.value)}registerBinding(e,t,i){this._bindings.has(i)||this._bindings.set(i,new Set);let r=this._bindings.get(i);if(t==="bind-text")r.add({element:e,type:"text",attr:null});else if(t.startsWith("bind-attr-")){let n=t.substring(10);r.add({element:e,type:"attr",attr:n})}else if(t==="bind-value")r.add({element:e,type:"value",attr:null});else if(t.startsWith("bind-class-")){let n=t.substring(11);r.add({element:e,type:"class",attr:n})}else t==="bind-show"&&r.add({element:e,type:"show",attr:null})}updateBindings(e,t){if(!this._bindings.has(e))return;let i=this._bindings.get(e);for(let r of i)switch(r.type){case"text":r.element.textContent=this.formatValue(t);break;case"attr":r.element.setAttribute(r.attr,t);break;case"value":r.element.value=t;break;case"class":r.element.classList.toggle(r.attr,!!t);break;case"show":r.element.style.display=t?"":"none";break}}formatValue(e){return e==null?"":String(e)}attachInternalListeners(){}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}findInput(e=null,t="input"){let i=this.querySelector(`[data-role="${t}"]`);return i||e&&(i=this.querySelector(`input[type="${e}"]`),i)?i:this.querySelector("input")}createReactiveProperty(e,t){let i=`_${e}`;this[i]=t,Object.defineProperty(this,e,{get(){return this[i]},set(r){this[i]=r,this.updateBindings(e,r)},enumerable:!0,configurable:!0})}createReactiveProperties(e){for(let[t,i]of Object.entries(e))this.createReactiveProperty(t,i)}addInputListener(e,t,i=0){if(e)if(i>0){let r;e.addEventListener("input",()=>{clearTimeout(r),r=setTimeout(t,i)})}else e.addEventListener("input",t)}findByRole(e,t=null){let i=this.querySelector(`[data-role="${e}"]`);return!i&&t&&(i=this.querySelector(t)),i}findAllByRole(e){return this.querySelectorAll(`[data-role="${e}"]`)}}});var Y,fe=X(()=>{ne();Y=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:50,min:0,max:100,step:1}),this._displayFormat=null,this._displayMultiplier=1,this._displaySuffix="",this.sliderInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Value",this.min=this.getNumberAttribute("min",0),this.max=this.getNumberAttribute("max",100),this.step=this.getNumberAttribute("step",1),this.transform=this.getNumberAttribute("transform",1),this.defaultValue=this.getNumberAttribute("default",50),this._displayMultiplier=this.getNumberAttribute("display-multiplier",1),this._displaySuffix=this.getAttribute("display-suffix")||"";let e=this.getAttribute("display-format");if(e!==null){let t=parseInt(e);this._displayFormat=i=>i!=null?i.toFixed(t):"0"}else this._displayFormat=t=>t!=null?t.toFixed(2):"0";this.value=this.defaultValue}formatValue(e){if(this._displayFormat&&typeof e=="number"){let t=e*this._displayMultiplier;return this._displayFormat(t)+this._displaySuffix}return super.formatValue(e)}attachInternalListeners(){if(this.sliderInput=this.findByRole("slider",'input[type="range"]'),!this.sliderInput)return;let e=()=>{this.value=parseFloat(this.sliderInput.value)/this.transform,this.triggerChange()};this.addInputListener(this.sliderInput,e),this.sliderInput.addEventListener("change",e),this.sliderInput.addEventListener("click",t=>{e()}),this.registerActionButtons(["decrease","increase","decrease-large","increase-large","reset"])}getValue(){return this.sliderInput?parseFloat(this.sliderInput.value)/this.transform:this.value}setValue(e){this.value=e,this.sliderInput&&(this.sliderInput.value=e*this.transform)}handleButtonAction(e){let t=this.value,i=t,r=this.step/this.transform,n=this.min/this.transform,s=this.max/this.transform;if(e==="increase")i=Math.min(s,t+r);else if(e==="decrease")i=Math.max(n,t-r);else if(e==="increase-large")i=Math.min(s,t+r*10);else if(e==="decrease-large")i=Math.max(n,t-r*10);else if(e==="reset")i=this.defaultValue;else return!1;return i!==t?(this.setValue(i),this.triggerChange(),!0):!1}}});var ur={};pt(ur,{AnimatableSlider:()=>oe,createFadeTransform:()=>cr});function cr(){let t=Math.log(.9),r=(Math.log(.9999)-t)/100;return{transform:n=>{let s=100-n;return Math.exp(t+r*s)},inverseTransform:n=>100-(Math.log(n)-t)/r}}var oe,Be=X(()=>{fe();st();oe=class extends Wt(Y){constructor(){super()}valueToPercent(e){if(this._customTransform&&this._customInverseTransform){let t=this._customInverseTransform(e),i=this.min||0,r=this.max||100;return(t-i)/(r-i)*100}return super.valueToPercent?super.valueToPercent(e):(e-this.min)/(this.max-this.min)*100}percentToValue(e){if(this._customTransform&&this._customInverseTransform){let t=this.min||0,i=this.max||100,r=t+e/100*(i-t);return this._customTransform(r)}return super.percentToValue?super.percentToValue(e):this.min+e/100*(this.max-this.min)}getValue(){if(this._customTransform&&this.sliderInput){let e=parseFloat(this.sliderInput.value);return this._customTransform(e)}return super.getValue()}setValue(e){if(this._customInverseTransform&&this.sliderInput){this.value=e;let t=this._customInverseTransform(e);this.sliderInput.value=t}else super.setValue(e)}setCustomTransform(e,t){if(this._customTransform=e,this._customInverseTransform=t,this.value!==void 0&&this.sliderInput){let i=this._customInverseTransform(this.value);this.sliderInput.value=i}this.animationEnabled&&this.updateBoundsDisplay()}}});var $e=class{constructor(e,t,i,r){this.gl=e,this.dimensions=t,this.resolution=i,this.strategy=r,this.readTextures=[],this.writeTextures=[];for(let n=0;n<t;n++)this.readTextures.push(this.createTexture()),this.writeTextures.push(this.createTexture());this.lineMode=!1,this.prevTextures=[];for(let n=0;n<t;n++)this.prevTextures.push(this.createTexture());this.textureUnitOffset=0}createTexture(){let e=this.gl,t=e.createTexture(),i=this.strategy.getTextureFormat();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,null),t}setLineMode(e){this.lineMode=e}setNeedsPrevTextures(e){}initializeData(e){let t=this.gl,i=this.strategy.getTextureFormat();for(let s=0;s<this.dimensions;s++)t.bindTexture(t.TEXTURE_2D,this.readTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,e[s]),t.bindTexture(t.TEXTURE_2D,this.writeTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,null),t.bindTexture(t.TEXTURE_2D,this.prevTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,e[s]);let r=this.strategy.getArrayType(),n=this.strategy.getComponentsPerValue();if(i.format===t.RGBA){let s=e[0];for(let a=0;a<this.resolution*this.resolution;a++)n===4&&(s[a*4+3]=1);t.bindTexture(t.TEXTURE_2D,this.readTextures[0]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,s),t.bindTexture(t.TEXTURE_2D,this.prevTextures[0]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,s)}}bindReadTextures(e){let t=this.gl;for(let i=0;i<this.dimensions;i++){let r=`u_pos_${i}`,n=t.getUniformLocation(e,r);n!==null&&(t.activeTexture(t.TEXTURE0+this.textureUnitOffset+i),t.bindTexture(t.TEXTURE_2D,this.readTextures[i]),t.uniform1i(n,this.textureUnitOffset+i))}}bindPrevTextures(e){let t=this.gl;for(let i=0;i<this.dimensions;i++){let r=`u_prev_pos_${i}`,n=t.getUniformLocation(e,r);if(n!==null){let s=this.textureUnitOffset+this.dimensions+i;t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,this.prevTextures[i]),t.uniform1i(n,s)}}}getWriteTexture(e){return this.writeTextures[e]}swap(){let e=this.prevTextures;this.prevTextures=this.readTextures,this.readTextures=this.writeTextures,this.writeTextures=e}resize(e){let t=this.gl;this.resolution=e;for(let i=0;i<this.dimensions;i++)t.deleteTexture(this.readTextures[i]),t.deleteTexture(this.writeTextures[i]),t.deleteTexture(this.prevTextures[i]);this.readTextures=[],this.writeTextures=[],this.prevTextures=[];for(let i=0;i<this.dimensions;i++)this.readTextures.push(this.createTexture()),this.writeTextures.push(this.createTexture()),this.prevTextures.push(this.createTexture())}dispose(){let e=this.gl;for(let t=0;t<this.dimensions;t++)e.deleteTexture(this.readTextures[t]),e.deleteTexture(this.writeTextures[t]),e.deleteTexture(this.prevTextures[t]);this.readTextures=[],this.writeTextures=[],this.prevTextures=[]}getReadTextures(){return this.readTextures}readTexture(e){let t=this.gl,i=this.strategy.getTextureFormat(),r=this.strategy.getArrayType(),n=this.strategy.getComponentsPerValue(),s=new r(this.resolution*this.resolution*n),a=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.readTextures[e],0),t.readPixels(0,0,this.resolution,this.resolution,i.format,i.type,s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(a),s}};z();var we=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.useHDR=r.useHDR!==void 0?r.useHDR:!0,this.usePingPong=r.usePingPong!==void 0?r.usePingPong:!0,this.checkExtensions(),this.initialize(),c.info("FramebufferManager initialized",{width:t,height:i,useHDR:this.useHDR,hdrSupported:this.hdrSupported,textureFormat:this.getTextureFormatName()})}checkExtensions(){let e=this.gl;c.verbose("Checking WebGL extensions for HDR support..."),this.floatTextureExt=e.getExtension("OES_texture_float"),this.halfFloatTextureExt=e.getExtension("OES_texture_half_float"),this.floatColorBufferExt=e.getExtension("WEBGL_color_buffer_float")||e.getExtension("EXT_color_buffer_float"),this.halfFloatColorBufferExt=e.getExtension("EXT_color_buffer_half_float"),this.floatLinearExt=e.getExtension("OES_texture_float_linear"),this.halfFloatLinearExt=e.getExtension("OES_texture_half_float_linear"),this.floatBlendExt=e.getExtension("EXT_float_blend"),c.verbose("WebGL extension support:",{OES_texture_float:!!this.floatTextureExt,OES_texture_half_float:!!this.halfFloatTextureExt,WEBGL_color_buffer_float:!!this.floatColorBufferExt,EXT_color_buffer_half_float:!!this.halfFloatColorBufferExt,OES_texture_float_linear:!!this.floatLinearExt,OES_texture_half_float_linear:!!this.halfFloatLinearExt,EXT_float_blend:!!this.floatBlendExt}),this.hdrSupported=!!(this.floatColorBufferExt||this.halfFloatColorBufferExt),c.verbose(`HDR support determined: ${this.hdrSupported?"SUPPORTED":"NOT SUPPORTED"}`),this.useHDR&&!this.hdrSupported&&(c.warn("HDR rendering requested but not supported by device. Falling back to LDR."),this.useHDR=!1),this.useHDR?(this.floatColorBufferExt?(this.hdrType=e.FLOAT,this.hdrTypeExt=this.floatTextureExt,this.linearExt=this.floatLinearExt,c.info("Selected RGBA32F (full float) for HDR framebuffers")):this.halfFloatColorBufferExt&&(this.hdrType=this.halfFloatTextureExt.HALF_FLOAT_OES,this.hdrTypeExt=this.halfFloatTextureExt,this.linearExt=this.halfFloatLinearExt,c.info("Selected RGBA16F (half float) for HDR framebuffers")),this.linearExt||c.warn("Linear filtering not supported for float textures. Bloom quality may be affected.")):c.verbose("Using LDR (RGBA8) framebuffers")}initialize(){let e=this.gl;if(c.verbose(`Creating ${this.usePingPong?"ping-pong":"single"} framebuffers...`),this.usePingPong){this.framebuffers=[e.createFramebuffer(),e.createFramebuffer()],this.textures=[this.createTexture(),this.createTexture()],this.depthBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height);for(let t=0;t<2;t++)e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[t]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textures[t],0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(t);this.currentIndex=0}else this.framebuffers=[e.createFramebuffer()],this.textures=[this.createTexture()],this.depthBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[0]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textures[0],0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(0),this.currentIndex=0;e.bindFramebuffer(e.FRAMEBUFFER,null)}createTexture(){let e=this.gl,t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let i=this.useHDR&&this.linearExt?e.LINEAR:e.NEAREST,r=this.useHDR&&this.linearExt?e.LINEAR:e.NEAREST;return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),this.useHDR?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,this.hdrType,null):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),t}checkFramebufferStatus(e){let t=this.gl;if(t.isContextLost())throw new Error("WebGL context lost");let i=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i!==t.FRAMEBUFFER_COMPLETE){let r=this.getFramebufferStatusString(i);throw c.error(`Framebuffer ${e} is not complete: ${r}`,{format:this.getTextureFormatName(),size:`${this.width}x${this.height}`,status:i,contextLost:t.isContextLost()}),new Error(`Framebuffer ${e} incomplete: ${r}`)}c.verbose(`Framebuffer ${e} created successfully: ${this.getTextureFormatName()} at ${this.width}x${this.height}`)}getFramebufferStatusString(e){let t=this.gl;switch(e){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:return"UNSUPPORTED";default:return`UNKNOWN (${e})`}}getTextureFormatName(){return this.useHDR?this.hdrType===this.gl.FLOAT?"RGBA32F (Full HDR)":"RGBA16F (Half HDR)":"RGBA8 (LDR)"}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[this.currentIndex]),e.viewport(0,0,this.width,this.height)}bindCanvas(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}getCurrentTexture(){return this.textures[this.currentIndex]}getPreviousTexture(){return this.usePingPong?this.textures[1-this.currentIndex]:this.textures[0]}swap(){this.usePingPong&&(this.currentIndex=1-this.currentIndex)}clear(e=0,t=0,i=0,r=1){let n=this.gl;this.bind(),n.clearColor(e,t,i,r),n.clear(n.COLOR_BUFFER_BIT)}clearAll(e=0,t=0,i=0,r=1){let n=this.gl;for(let s=0;s<this.framebuffers.length;s++)n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffers[s]),n.clearColor(e,t,i,r),n.clear(n.COLOR_BUFFER_BIT);n.bindFramebuffer(n.FRAMEBUFFER,null)}resize(e,t){if(e===this.width&&t===this.height)return;c.info("Resizing HDR framebuffers",{from:`${this.width}x${this.height}`,to:`${e}x${t}`,format:this.getTextureFormatName()}),this.width=e,this.height=t;let i=this.gl;for(let r of this.textures)i.deleteTexture(r);this.depthBuffer&&i.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this.depthBuffer),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),this.textures=[];for(let r=0;r<this.framebuffers.length;r++)this.textures.push(this.createTexture()),i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffers[r]),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.textures[r],0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(r);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.clearAll()}dispose(){let e=this.gl;for(let t of this.framebuffers)e.deleteFramebuffer(t);for(let t of this.textures)e.deleteTexture(t);this.framebuffers=[],this.textures=[],c.verbose("FramebufferManager disposed")}isHDR(){return this.useHDR&&this.hdrSupported}getHDRSupport(){return{supported:this.hdrSupported,enabled:this.useHDR,format:this.getTextureFormatName(),hasFloatColorBuffer:!!this.floatColorBufferExt,hasHalfFloatColorBuffer:!!this.halfFloatColorBufferExt,hasLinearFiltering:!!this.linearExt}}};z();var Ve=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.enabled=r.enabled!==void 0?r.enabled:!0,this.intensity=r.intensity!==void 0?r.intensity:.5,this.threshold=r.threshold!==void 0?r.threshold:1,this.radius=r.radius!==void 0?r.radius:1,this.bloomScale=r.bloomScale!==void 0?r.bloomScale:1,this.bloomWidth=Math.floor(t*this.bloomScale),this.bloomHeight=Math.floor(i*this.bloomScale),this.checkExtensions(),this.initialize(),c.info("BloomManager initialized",{bloomSize:`${this.bloomWidth}x${this.bloomHeight}`,scale:this.bloomScale,threshold:this.threshold,intensity:this.intensity})}checkExtensions(){let e=this.gl;if(this.floatTextureExt=e.getExtension("OES_texture_float"),this.halfFloatTextureExt=e.getExtension("OES_texture_half_float"),this.floatColorBufferExt=e.getExtension("WEBGL_color_buffer_float")||e.getExtension("EXT_color_buffer_float"),this.halfFloatColorBufferExt=e.getExtension("EXT_color_buffer_half_float"),this.floatLinearExt=e.getExtension("OES_texture_float_linear"),this.halfFloatLinearExt=e.getExtension("OES_texture_half_float_linear"),this.floatBlendExt=e.getExtension("EXT_float_blend"),this.hdrSupported=!!(this.floatColorBufferExt||this.halfFloatColorBufferExt),!this.hdrSupported){c.warn("HDR not supported for bloom. Bloom effect will be disabled."),this.enabled=!1;return}this.floatColorBufferExt?(this.hdrType=e.FLOAT,this.linearExt=this.floatLinearExt):this.halfFloatColorBufferExt&&(this.hdrType=this.halfFloatTextureExt.HALF_FLOAT_OES,this.linearExt=this.halfFloatLinearExt),this.linearExt||c.warn("Linear filtering not supported for bloom textures. Bloom quality may be reduced.")}initialize(){if(!this.enabled||!this.hdrSupported)return;let e=this.gl;this.brightFBO=e.createFramebuffer(),this.blurFBO1=e.createFramebuffer(),this.blurFBO2=e.createFramebuffer(),this.brightTexture=this.createTexture(),this.blurTexture1=this.createTexture(),this.blurTexture2=this.createTexture(),e.bindFramebuffer(e.FRAMEBUFFER,this.brightFBO),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.brightTexture,0),this.checkFramebufferStatus("Bright extraction"),e.bindFramebuffer(e.FRAMEBUFFER,this.blurFBO1),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.blurTexture1,0),this.checkFramebufferStatus("Blur 1"),e.bindFramebuffer(e.FRAMEBUFFER,this.blurFBO2),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.blurTexture2,0),this.checkFramebufferStatus("Blur 2"),e.bindFramebuffer(e.FRAMEBUFFER,null),c.verbose("Bloom framebuffers initialized successfully")}createTexture(){let e=this.gl,t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let i=this.linearExt?e.LINEAR:e.NEAREST;return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.bloomWidth,this.bloomHeight,0,e.RGBA,this.hdrType,null),t}checkFramebufferStatus(e){let t=this.gl,i=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i!==t.FRAMEBUFFER_COMPLETE)throw c.error(`${e} framebuffer is not complete: ${i}`),new Error(`${e} framebuffer incomplete`);c.verbose(`${e} framebuffer created successfully`)}getBrightFBO(){return this.brightFBO}getBrightTexture(){return this.brightTexture}getBlurFBOs(){return[this.blurFBO1,this.blurFBO2]}getBlurTextures(){return[this.blurTexture1,this.blurTexture2]}getBloomSize(){return{width:this.bloomWidth,height:this.bloomHeight}}updateConfig(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.intensity!==void 0&&(this.intensity=e.intensity),e.threshold!==void 0&&(this.threshold=e.threshold),e.radius!==void 0&&(this.radius=e.radius)}resize(e,t){if(!this.enabled||!this.hdrSupported)return;let i=Math.floor(e*this.bloomScale),r=Math.floor(t*this.bloomScale);if(i===this.bloomWidth&&r===this.bloomHeight)return;c.info("Resizing bloom framebuffers",{from:`${this.bloomWidth}x${this.bloomHeight}`,to:`${i}x${r}`}),this.width=e,this.height=t,this.bloomWidth=i,this.bloomHeight=r;let n=this.gl;n.deleteTexture(this.brightTexture),n.deleteTexture(this.blurTexture1),n.deleteTexture(this.blurTexture2),this.brightTexture=this.createTexture(),this.blurTexture1=this.createTexture(),this.blurTexture2=this.createTexture(),n.bindFramebuffer(n.FRAMEBUFFER,this.brightFBO),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.brightTexture,0),this.checkFramebufferStatus("Bright extraction (resized)"),n.bindFramebuffer(n.FRAMEBUFFER,this.blurFBO1),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.blurTexture1,0),this.checkFramebufferStatus("Blur 1 (resized)"),n.bindFramebuffer(n.FRAMEBUFFER,this.blurFBO2),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.blurTexture2,0),this.checkFramebufferStatus("Blur 2 (resized)"),n.bindFramebuffer(n.FRAMEBUFFER,null)}dispose(){if(!this.enabled||!this.hdrSupported)return;let e=this.gl;e.deleteFramebuffer(this.brightFBO),e.deleteFramebuffer(this.blurFBO1),e.deleteFramebuffer(this.blurFBO2),e.deleteTexture(this.brightTexture),e.deleteTexture(this.blurTexture1),e.deleteTexture(this.blurTexture2),c.verbose("BloomManager disposed")}isEnabled(){return this.enabled&&this.hdrSupported}};z();var I={NUMBER:"NUMBER",VARIABLE:"VARIABLE",FUNCTION:"FUNCTION",OPERATOR:"OPERATOR",LPAREN:"LPAREN",RPAREN:"RPAREN",COMMA:"COMMA",EOF:"EOF"},gt={"+":{precedence:1,associativity:"L"},"-":{precedence:1,associativity:"L"},"*":{precedence:2,associativity:"L"},"/":{precedence:2,associativity:"L"},"^":{precedence:3,associativity:"R"},"%":{precedence:2,associativity:"L"}},ei=new Set(["sin","cos","tan","asin","acos","atan","atan2","sinh","cosh","tanh","exp","log","log2","sqrt","abs","floor","ceil","fract","sign","min","max","pow","mod","length","normalize","dot"]),ie={},bt={pi:"PI",e:"E",PI:"PI",E:"E"};function ze(o){let e=[],t=0,i=null;for(;t<o.length;){let r=o[t];if(/\s/.test(r)){t++;continue}if(/\d/.test(r)||r==="."&&/\d/.test(o[t+1])){let n="";for(;t<o.length&&/[\d.]/.test(o[t]);)n+=o[t++];let s={type:I.NUMBER,value:parseFloat(n)};e.push(s),i=s;continue}if(/[a-zA-Z_]/.test(r)){let n="";for(;t<o.length&&/[a-zA-Z_0-9]/.test(o[t]);)n+=o[t++];let s;ei.has(n)||ie.hasOwnProperty(n)?s={type:I.FUNCTION,value:n}:bt.hasOwnProperty(n)?s={type:I.NUMBER,value:bt[n],isConstant:!0}:s={type:I.VARIABLE,value:n},e.push(s),i=s;continue}if(gt.hasOwnProperty(r)){r==="-"&&(i===null||i.type===I.OPERATOR||i.type===I.LPAREN||i.type===I.COMMA)&&e.push({type:I.NUMBER,value:0});let n={type:I.OPERATOR,value:r};e.push(n),i=n,t++;continue}if(r==="("){let n={type:I.LPAREN};e.push(n),i=n,t++;continue}if(r===")"){let n={type:I.RPAREN};e.push(n),i=n,t++;continue}if(r===","){let n={type:I.COMMA};e.push(n),i=n,t++;continue}throw new Error(`Unexpected character: ${r} at position ${t}`)}return e.push({type:I.EOF}),e}function Ue(o){let e=[],t=[],i=0,r=()=>o[i],n=()=>o[i++];for(;r().type!==I.EOF;){let s=n();if(s.type===I.NUMBER)e.push(s);else if(s.type===I.VARIABLE)e.push(s);else if(s.type===I.FUNCTION)t.push(s);else if(s.type===I.COMMA)for(;t.length>0&&t[t.length-1].type!==I.LPAREN;)e.push(t.pop());else if(s.type===I.OPERATOR){let a=s;for(;t.length>0;){let l=t[t.length-1];if(l.type===I.OPERATOR){let u=gt[a.value],d=gt[l.value];if(u.associativity==="L"&&u.precedence<=d.precedence||u.associativity==="R"&&u.precedence<d.precedence)e.push(t.pop());else break}else break}t.push(a)}else if(s.type===I.LPAREN)t.push(s);else if(s.type===I.RPAREN){for(;t.length>0&&t[t.length-1].type!==I.LPAREN;)e.push(t.pop());if(t.length===0)throw new Error("Mismatched parentheses");t.pop(),t.length>0&&t[t.length-1].type===I.FUNCTION&&e.push(t.pop())}}for(;t.length>0;){let s=t.pop();if(s.type===I.LPAREN)throw new Error("Mismatched parentheses");e.push(s)}return e}function Er(o,e){let t=[],i=new Set(e);["dx","dy","dz","dw","du","dv"].forEach(n=>i.add(n)),i.add("a");for(let n of o)if(n.type===I.NUMBER)if(n.isConstant){let s={PI:"Math.PI",E:"Math.E"};t.push(s[n.value]||n.value.toString())}else t.push(n.value.toString());else if(n.type===I.VARIABLE)if(i.has(n.value))t.push(n.value);else throw new Error(`Unknown variable: ${n.value}. Available: ${e.join(", ")}, dx, dy, dz, dw, du, dv, a (animation alpha)`);else if(n.type===I.OPERATOR){if(t.length<2)throw new Error("Invalid expression");let s=t.pop(),a=t.pop();n.value==="^"?t.push(`Math.pow(${a}, ${s})`):t.push(`(${a} ${n.value} ${s})`)}else if(n.type===I.FUNCTION){let s=ii(n.value);if(t.length<s)throw new Error(`Not enough arguments for ${n.value}`);let a=[];for(let d=0;d<s;d++)a.unshift(t.pop());let u={mod:"%",fract:"(x => x - Math.floor(x))",mix:"(a, b, t) => a * (1 - t) + b * t"}[n.value]||`Math.${n.value}`;t.push(`${u}(${a.join(", ")})`)}if(t.length!==1)throw new Error("Invalid expression");return t[0]}function ti(o,e,t=!1,i="pos"){let r=[],n={};if(t)e.forEach(s=>{n[s]=s});else{let s=["x","y","z","w","u","v"],a=["dx","dy","dz","dw","du","dv"];e.forEach((l,u)=>{u<6?n[l]=`${i}.${s[u]}`:n[l]=`${i}[${u}]`}),a.forEach((l,u)=>{u<6?n[l]=`velocity.${s[u]}`:n[l]=`velocity[${u}]`}),n.a="u_alpha"}for(let s of o)if(s.type===I.NUMBER)if(s.isConstant){let a={PI:"3.14159265359",E:"2.71828182846"};r.push(a[s.value]||s.value.toString())}else{let a=s.value.toString();!a.includes(".")&&!a.includes("e")&&!a.includes("E")&&(a+=".0"),r.push(a)}else if(s.type===I.VARIABLE)if(n.hasOwnProperty(s.value))r.push(n[s.value]);else throw new Error(`Unknown variable: ${s.value}. Available: ${e.join(", ")}`);else if(s.type===I.OPERATOR){if(r.length<2)throw new Error("Invalid expression");let a=r.pop(),l=r.pop();if(s.value==="^"){let u=a.match(/^(\d+)\.0$/);if(u){let d=parseInt(u[1]);d===0?r.push("1.0"):d===1?r.push(l):d<=4?r.push(`(${Array(d).fill(l).join(" * ")})`):r.push(`pow(${l}, ${a})`)}else r.push(`pow(${l}, ${a})`)}else s.value==="%"?r.push(`mod(${l}, ${a})`):r.push(`(${l} ${s.value} ${a})`)}else if(s.type===I.FUNCTION){let a=ii(s.value);if(r.length<a)throw new Error(`Not enough arguments for ${s.value}`);let l=[];for(let d=0;d<a;d++)l.unshift(r.pop());let u=s.value;s.value==="atan2"&&(u="atan"),r.push(`${u}(${l.join(", ")})`)}if(r.length!==1)throw new Error("Invalid expression");return r[0]}function ii(o){return ie.hasOwnProperty(o)?ie[o].params.length:new Set(["min","max","pow","mod","dot","atan2"]).has(o)?2:1}function $r(o){let e="";for(let[t,i]of Object.entries(ie)){let r=ze(i.body),n=Ue(r),s=ti(n,i.params,!0);e+=`float ${t}(`,e+=i.params.map(a=>`float ${a}`).join(", "),e+=`) {
`,e+=`    return ${s};
`,e+=`}

`}return e}function K(o,e,t=null,i="pos"){let r=t||["x","y","z","w","u","v"].slice(0,e);try{let n=ze(o),s=Ue(n);return ti(s,r,!1,i)}catch(n){throw new Error(`Parse error: ${n.message}`)}}function ke(){return $r([])}function ri(o,e=null,t="pos"){let i=o.length;return o.map((r,n)=>{try{return K(r.trim(),i,e,t)}catch(s){throw new Error(`Error in dimension ${n}: ${s.message}`)}})}function xt(o,e=null){let t=o.length,i=e||["x","y","z","w","u","v"].slice(0,t);return o.map((r,n)=>{try{let s=ze(r.trim()),a=Ue(s),u=`return ${Er(a,i)};`;return new Function(...i,u)}catch(s){throw new Error(`Error creating evaluator for dimension ${n}: ${s.message}`)}})}function ni(o){for(let t in ie)delete ie[t];if(!o||!o.trim())return;let e=o.split(`
`);for(let t=0;t<e.length;t++){let i=e[t].trim();if(!i||i.startsWith("//")||i.startsWith("#"))continue;let r=i.match(/^([a-zA-Z_][a-zA-Z_0-9]*)\s*\(([^)]*)\)\s*=\s*(.+)$/);if(!r)throw new Error(`Line ${t+1}: Invalid function definition syntax. Expected: functionName(arg1, arg2) = expression`);let[,n,s,a]=r;if(ei.has(n))throw new Error(`Line ${t+1}: Cannot override built-in function '${n}'`);if(bt.hasOwnProperty(n))throw new Error(`Line ${t+1}: Cannot use constant name '${n}' as function name`);let l=s.split(",").map(u=>u.trim()).filter(u=>u);for(let u of l)if(!/^[a-zA-Z_][a-zA-Z_0-9]*$/.test(u))throw new Error(`Line ${t+1}: Invalid parameter name '${u}'`);try{let u=ze(a);Ue(u)}catch(u){throw new Error(`Line ${t+1}: Error parsing function body: ${u.message}`)}ie[n]={params:l,body:a}}}function oi(){return{...ie}}function si(o,e,t){let i=o.createShader(e);if(o.shaderSource(i,t),o.compileShader(i),!o.getShaderParameter(i,o.COMPILE_STATUS)){let r=o.getShaderInfoLog(i);throw o.deleteShader(i),new Error(`Shader compilation error: ${r}

Source:
${Tr(t)}`)}return i}function wr(o,e,t){let i=o.createProgram();if(o.attachShader(i,e),o.attachShader(i,t),o.linkProgram(i),!o.getProgramParameter(i,o.LINK_STATUS)){let r=o.getProgramInfoLog(i);throw o.deleteProgram(i),new Error(`Program linking error: ${r}`)}return i}function G(o,e,t){let i=si(o,o.VERTEX_SHADER,e),r=si(o,o.FRAGMENT_SHADER,t),n=wr(o,i,r);return o.deleteShader(i),o.deleteShader(r),n}function Tr(o){return o.split(`
`).map((e,t)=>`${t+1}: ${e}`).join(`
`)}function ai(){return`
precision highp float;

attribute vec2 a_pos;

void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`}function li(o,e,t,i,r=null,n=null){let s=Array.from({length:o},(g,y)=>`uniform sampler2D u_pos_${y};`).join(`
`),a=`vec${o}`,l=Array.from({length:o},(g,y)=>`decodeFloat(texture2D(u_pos_${y}, v_texcoord))`).join(", "),u=["x","y","z","w"],d=e.map((g,y)=>`    result.${u[y]} = ${g};`).join(`
`),h=n&&n.forwardTransform,p=h?`
// Coordinate system transformation functions (native-space integration)
${n.forwardTransform}
${n.inverseTransform}
// Note: velocityTransform not needed with native-space integration
`:"",m=r&&r.forward,f=m?`
// Domain transformation functions
${r.helpers||""}
${r.forward}
${r.inverse}
${r.jacobian}
`:"",b=h?`
// User-defined velocity field in native coordinates (${n.name||"custom"})
${a} get_velocity_native(${a} pos_native) {
    ${a} result;
    // Extract native coordinates for use in expressions
    float ${n.nativeVars?n.nativeVars.map((g,y)=>`${g} = pos_native.${u[y]}`).join(", "):u.slice(0,o).map((g,y)=>`${g} = pos_native.${g}`).join(", ")};
${d}
    return result;
}

// Velocity function in Cartesian (redirects to native, for use by integrator)
${a} get_velocity(${a} pos_native) {
    return get_velocity_native(pos_native);
}
`:m?`
// Original velocity field in world coordinates
${a} get_velocity_original(${a} pos) {
    ${a} result;
    float x = pos.x;
    ${o>1?"float y = pos.y;":""}
    ${o>2?"float z = pos.z;":""}
    ${o>3?"float w = pos.w;":""}

${d}

    return result;
}

// Transformed velocity field: dy/dt = J_T(x) * f(x)
// where y = T(x)
${a} get_velocity(${a} pos_transformed) {
    // Transform back to world coordinates
    ${a} pos = transform_inverse(pos_transformed);

    // Evaluate original velocity field
    ${a} vel_original = get_velocity_original(pos);

    // Apply Jacobian: component-wise multiplication
    ${a} jacobian = transform_jacobian(pos);
    return vel_original * jacobian;
}
`:`
// User-defined velocity field (no transform)
${a} get_velocity(${a} pos) {
    ${a} result;
    float x = pos.x;
    ${o>1?"float y = pos.y;":""}
    ${o>2?"float z = pos.z;":""}
    ${o>3?"float w = pos.w;":""}

${d}

    return result;
}
`,x=ke();return`
precision highp float;

${i.getGLSLConstants()}
${i.getGLSLDecodeFunction()}
${i.getGLSLEncodeFunction()}
${i.getGLSLNormalizeFunction()}
${i.getGLSLDenormalizeFunction()}

${x}

${s}

uniform vec2 u_min;
uniform vec2 u_max;
uniform float u_h;
uniform float u_rand_seed;
uniform float u_drop_rate;
uniform float u_respawn_margin;
uniform int u_out_coordinate;
uniform float u_particles_res;
uniform float u_max_velocity;
uniform float u_alpha;
${m?"uniform vec4 u_transform_params;":""}

${p}

${f}

${b}

${t}

// High-quality hash-based random number generator
// Returns value in [0, 1] with good distribution
float rand(vec2 co) {
    // Hash the input
    vec2 p = co + vec2(u_rand_seed, u_rand_seed * 1.61803398875);
    // Use a better hash function
    p = fract(p * vec2(443.897, 441.423));
    p += dot(p.yx, p.xy + vec2(19.19, 17.17));
    return fract(p.x * p.y);
}

// Secondary independent random function
float rand2(vec2 co) {
    vec2 p = co + vec2(u_rand_seed * 2.71828, u_rand_seed * 3.14159);
    p = fract(p * vec2(269.5, 271.3));
    p += dot(p.yx, p.xy + vec2(23.23, 29.29));
    return fract(p.x * p.y);
}

void main() {
    vec2 texcoord = gl_FragCoord.xy / u_particles_res;

    // Read current age from alpha channel of u_pos_0
    float current_age = texture2D(u_pos_0, texcoord).a;

    // Read current position from textures
    // Positions are stored as normalized [0,1] values, denormalize to world coords
    ${a} pos;
    ${Array.from({length:o},(g,y)=>{let _=["x","y","z","w"][y];return y===0?`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), u_min.x, u_max.x);`:y===1?`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), u_min.y, u_max.y);`:`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), -10.0, 10.0);`}).join(`
    `)}

    // Integrate to get new position
    ${a} new_pos;
    ${h?`
    // NATIVE-SPACE INTEGRATION:
    // 1. Transform position to native coordinates
    // 2. Integrate in native space (using velocity defined in native coords)
    // 3. Transform result back to Cartesian
    ${a} pos_native = transformToNative(pos);
    ${a} new_pos_native = integrate(pos_native, u_h);
    new_pos = transformToCartesian(new_pos_native);
    `:m?`
    // Transform to y-space, integrate, then transform back to x-space
    ${a} pos_transformed = transform_forward(pos);
    ${a} new_pos_transformed = integrate(pos_transformed, u_h);
    new_pos = transform_inverse(new_pos_transformed);
    `:`
    // Direct integration (no transform)
    new_pos = integrate(pos, u_h);
    `}

    // Check if particle is outside viewport bounds with configurable margin
    // Margin allows particles to flow off-screen before respawning
    float width = u_max.x - u_min.x;
    float height = u_max.y - u_min.y;
    bool outside = new_pos.x < (u_min.x - width * u_respawn_margin) || new_pos.x > (u_max.x + width * u_respawn_margin) ||
                   new_pos.y < (u_min.y - height * u_respawn_margin) || new_pos.y > (u_max.y + height * u_respawn_margin);

    // Random drop: reset particle to random position with small probability
    // Also reset if particle exits the viewport
    float drop_chance = rand(texcoord);
    bool should_respawn = drop_chance < u_drop_rate || outside;
    if (should_respawn) {
        // Spawn particles 2% OUTSIDE viewport for natural flow-in effect (negative margin)
        // Use texcoord + rand_seed for truly independent random values per particle per frame
        const float margin = -0.02;
        ${o===2?`new_pos.x = u_min.x + width * margin + rand(texcoord * 1.234 + vec2(u_rand_seed)) * width * (1.0 - 2.0 * margin);
        new_pos.y = u_min.y + height * margin + rand2(texcoord * 5.678 + vec2(u_rand_seed * 2.345)) * height * (1.0 - 2.0 * margin);`:Array.from({length:o},(g,y)=>{let _=["x","y","z","w"];return y===0?"new_pos.x = u_min.x + width * margin + rand(texcoord * 1.234 + vec2(u_rand_seed)) * width * (1.0 - 2.0 * margin);":y===1?"new_pos.y = u_min.y + height * margin + rand2(texcoord * 5.678 + vec2(u_rand_seed * 2.345)) * height * (1.0 - 2.0 * margin);":`new_pos.${_[y]} = -10.4 + rand(texcoord * ${y+1}.37 + vec2(u_rand_seed * ${y+3}.5)) * 20.8;`}).join(`
        `)}
    }

    // Calculate new age (based on all spawn conditions)
    float new_age;
    if (should_respawn) {
        new_age = 0.0; // Reset age for newly spawned particles
    } else {
        new_age = min(current_age + 0.5, 1.0); // Increment age, cap at 1.0
    }

    // Output the selected coordinate
    // Normalize world coords back to [0, 1] before encoding
    ${Array.from({length:o},(g,y)=>{let _=["x","y","z","w"][y],E;return y===0?E=`normalizeToViewport(new_pos.${_}, u_min.x, u_max.x)`:y===1?E=`normalizeToViewport(new_pos.${_}, u_min.y, u_max.y)`:E=`normalizeToViewport(new_pos.${_}, -10.0, 10.0)`,y===0?`if (u_out_coordinate == ${y}) {
        gl_FragColor = encodeFloat(${E});
        gl_FragColor.a = new_age; // Store age in alpha channel
    }`:y===o-1?` else {
        gl_FragColor = encodeFloat(${E});
    }`:` else if (u_out_coordinate == ${y}) {
        gl_FragColor = encodeFloat(${E});
    }`}).join("")}
}
`}function ci(o,e,t,i,r=!1,n=null){let s=n&&n.forwardTransform,a=Array.from({length:o},(b,x)=>`uniform sampler2D u_pos_${x};`).join(`
`),l=Array.from({length:o},(b,x)=>`uniform sampler2D u_prev_pos_${x};`).join(`
`),u=`vec${o}`,d=["x","y","z","w"],h=t.map((b,x)=>`    result.${d[x]} = ${b};`).join(`
`),p=s?`
// Coordinate system transformation functions
${n.forwardTransform}
${n.inverseTransform}
// Note: inverseTransform needed for computing Cartesian velocity via finite differences
`:"",m=s?`
// User-defined velocity field in native coordinates
${u} get_velocity_native(${u} pos_native) {
    ${u} result;
${h}
    return result;
}

// Velocity field for visualization (no Cartesian transform needed with native-space integration)
${u} get_velocity(${u} pos_cartesian) {
    ${u} pos_native = transformToNative(pos_cartesian);
    return get_velocity_native(pos_native);
}
`:`
// User-defined velocity field
${u} get_velocity(${u} pos) {
    ${u} result;
    float x = pos.x;
    ${o>1?"float y = pos.y;":""}
    ${o>2?"float z = pos.z;":""}
    ${o>3?"float w = pos.w;":""}

${h}

    return result;
}
`,f=ke();return`
precision highp float;

${i.getGLSLConstants()}
${i.getGLSLDecodeFunction()}
${i.getGLSLDenormalizeFunction()}

${f}

attribute float a_index;
${r?"attribute float a_vertex_id; // 0 = prev, 1 = current":""}

${a}
${l}

uniform float u_particles_res;
uniform vec2 u_min;
uniform vec2 u_max;
uniform float u_alpha;
uniform float u_particle_size;
uniform vec2 u_viewport_size;  // Actual render resolution (renderWidth, renderHeight)
uniform vec2 u_canvas_size;    // Canvas resolution (canvas.width, canvas.height)

varying vec${o} v_pos;
varying vec${o} v_velocity;          // Actual particle velocity (pos - prev_pos)
varying vec${o} v_field_velocity;    // Vector field at particle position
varying vec${o} v_velocity_projected; // Projected 2D velocity (for angle-based color modes)

${e}

${p}

${m}

void main() {
    ${r?`
    // Line mode: index buffer has [0,0,1,1,2,2,3,3,...], vertex ID buffer has [0,1,0,1,0,1,...]
    // a_vertex_id = 0 means previous position, 1 means current position
    float particle_index = a_index;
    bool is_current = a_vertex_id > 0.5;
    `:`
    // Point mode: one vertex per particle
    float particle_index = a_index;
    `}

    // Calculate texture coordinate from particle index
    // Add 0.5 to sample from texel centers
    vec2 texcoord = vec2(
        (mod(particle_index, u_particles_res) + 0.5) / u_particles_res,
        (floor(particle_index / u_particles_res) + 0.5) / u_particles_res
    );

    // Read age from alpha channel of u_pos_0
    float age = texture2D(u_pos_0, texcoord).a;

    // Read position from textures and denormalize to world coordinates
    ${u} pos;
    ${r?`
    if (is_current) {
        // Current position
        ${Array.from({length:o},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
        `)}
    } else {
        // Previous position
        ${Array.from({length:o},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
        `)}
    }
    `:`
    ${Array.from({length:o},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
    `)}
    `}

    // Calculate ACTUAL particle velocity for coloring (not vector field!)
    // This gives correct colors based on particle motion, not field strength
    ${u} prev_pos;
    ${Array.from({length:o},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.y, u_max.y);`:`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
    `)}

    // Actual particle velocity from position difference
    ${u} velocity = pos - prev_pos;

    // Also compute vector field at current position (for field-based color modes)
    ${u} field_velocity = get_velocity(pos);

    // Pass N-dimensional position and full velocity to fragment shader
    v_pos = pos;
    v_velocity = velocity; // Actual particle velocity for expression mode
    v_field_velocity = field_velocity; // Vector field at position

    // Skip newly spawned particles (age < 1) by moving them off-screen
    if (age < 1.0) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0); // Far outside clip space
        gl_PointSize = 0.0;
        v_velocity_projected = velocity; // Won't be used since particle is off-screen
    } else {
        // Project position to 3D (with depth)
        vec3 pos_3d = project_to_3d(pos);

        // Project velocity to 2D (using same mapper)
        // For linear projections, this is correct for tangent vectors
        vec2 velocity_2d = project_to_2d(velocity);

        // Create 2D velocity vector (pad to match dimensions for varying)
        ${u} velocity_projected;
        velocity_projected.x = velocity_2d.x;
        velocity_projected.y = velocity_2d.y;
        ${o>2?"velocity_projected.z = 0.0;":""}
        ${o>3?"velocity_projected.w = 0.0;":""}

        // Pass projected 2D velocity to fragment shader (for angle-based color modes)
        v_velocity_projected = velocity_projected;

        // Map to screen space
        vec2 normalized = (pos_3d.xy - u_min) / (u_max - u_min);

        // Use depth value (normalized to [-1, 1] range)
        // For now, assume depth is in similar range to x/y coordinates
        float depth_normalized = (pos_3d.z - (u_min.x + u_min.y) * 0.5) / ((u_max.x - u_min.x + u_max.y - u_min.y) * 0.5);
        depth_normalized = clamp(depth_normalized, -1.0, 1.0);

        gl_Position = vec4(normalized * 2.0 - 1.0, depth_normalized, 1.0);

        // Scale particle size by render scale to maintain consistent visual size
        // Calculate render scale as viewport size / canvas size
        float render_scale = u_viewport_size.x / u_canvas_size.x;
        gl_PointSize = u_particle_size * render_scale;
    }
}
`}function ui(o,e,t){return`
precision highp float;

${ke()}

varying vec${o} v_pos;
varying vec${o} v_velocity;          // Actual particle velocity (pos - prev_pos)
varying vec${o} v_field_velocity;    // Vector field at particle position
varying vec${o} v_velocity_projected; // Projected 2D velocity (for angle-based color modes)

${t?`uniform float u_max_velocity;
uniform float u_velocity_log_scale;`:""}
uniform float u_particle_intensity;
uniform float u_color_saturation;
uniform float u_alpha;
uniform vec2 u_viewport_size;  // Actual render resolution
uniform vec2 u_canvas_size;    // Canvas resolution

${e}

void main() {
    // Get color based on position, particle velocity, and field velocity
    vec3 color = getColor(v_pos, v_velocity, v_field_velocity, v_velocity_projected);

    // Apply saturation adjustment (for attractor visualization)
    // 0.0 = grayscale, 1.0 = full saturation
    if (u_color_saturation < 1.0) {
        float luminance = dot(color, vec3(0.2126, 0.7152, 0.0722));
        vec3 grayscale = vec3(luminance);
        color = mix(grayscale, color, u_color_saturation);
    }

    // Scale by intensity for HDR (allows colors > 1.0)
    color *= u_particle_intensity;

    // Calculate render scale factor
    float render_scale = u_viewport_size.x / u_canvas_size.x;

    // Compensate alpha for particle size scaling to maintain constant brightness
    // Particle area scales with render_scale\xB2, so divide alpha by render_scale\xB2
    // This ensures that larger particles contribute the same total brightness
    float area_compensation = 1.0 / (render_scale * render_scale);
    float adjusted_alpha = 0.35 * area_compensation;

    // Alpha blending allows proper fade to black
    gl_FragColor = vec4(color, adjusted_alpha);
}
`}function di(){return`
precision highp float;

attribute vec2 a_pos;
varying vec2 v_texcoord;

void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`}function hi(){return`
precision highp float;

uniform sampler2D u_screen;
uniform float u_fade;

varying vec2 v_texcoord;

void main() {
    vec4 color = texture2D(u_screen, v_texcoord);
    vec3 faded = color.rgb * u_fade;

    // Snap to black if very dark (prevents floating point precision issues)
    // This ensures trails fade completely to black
    float brightness = max(max(faded.r, faded.g), faded.b);
    if (brightness < 0.003) {
        faded = vec3(0.0);
    }

    gl_FragColor = vec4(faded, 1.0);
}
`}function mi(o=""){return o||(o=`
vec3 tonemap(vec3 color) {
    return color * u_exposure;
}

vec3 applyGamma(vec3 color) {
    return pow(color, vec3(1.0 / u_gamma));
}
`),`
precision highp float;

uniform sampler2D u_screen;
uniform sampler2D u_bloom;
uniform float u_bloom_intensity;
uniform float u_bloom_alpha;
uniform bool u_bloom_enabled;
uniform float u_exposure;
uniform float u_gamma;
uniform float u_whitePoint;
uniform float u_brightness_desat;
uniform float u_brightness_sat;
uniform float u_hdr_max_brightness;
uniform float u_hdr_avg_brightness;
uniform float u_highlight_compression;
uniform float u_compression_threshold;

varying vec2 v_texcoord;

// Logarithmic highlight compression (pre-tone mapping)
// Only compresses values above threshold to help tone mapper cover full dynamic range
// Preserves hue by compressing luminance only, then scaling RGB to match
vec3 compressHighlights(vec3 color, float strength, float threshold) {
    if (strength < 0.0001) return color; // Disabled

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return color;

    // Compress luminance only
    float compressedLuma;
    if (luma <= threshold) {
        compressedLuma = luma; // Below threshold: unchanged
    } else {
        // Above threshold: compress the excess
        float excess = luma - threshold;
        float compressed = log(1.0 + excess * strength) / strength;
        compressedLuma = threshold + compressed;
    }

    // Scale RGB to match compressed luminance (preserves hue and saturation)
    return color * (compressedLuma / luma);
}

${o}

void main() {
    // Read HDR color from framebuffer
    vec3 hdrColor = texture2D(u_screen, v_texcoord).rgb;

    // Blend bloom if enabled (before tone mapping)
    if (u_bloom_enabled) {
        vec3 bloomColor = texture2D(u_bloom, v_texcoord).rgb * u_bloom_intensity;
        // Alpha blend: mix base color with bloom using alpha
        hdrColor = mix(hdrColor, hdrColor + bloomColor, u_bloom_alpha);
    }

    // Calculate HDR brightness once for both effects (Rec. 709 luminance)
    float hdrBrightness = dot(hdrColor, vec3(0.2126, 0.7152, 0.0722));
    vec3 hdrGray = vec3(hdrBrightness);

    // Get adaptive thresholds based on actual HDR buffer statistics
    float avgBrightness = max(u_hdr_avg_brightness, 0.1); // Avoid division by zero
    float maxBrightness = max(u_hdr_max_brightness, 1.0);

    // Work in log space to handle the massive dynamic range (0.1 to 100,000+)
    float logAvg = log2(avgBrightness + 1.0);
    float logMax = log2(maxBrightness + 1.0);
    float logBrightness = log2(hdrBrightness + 1.0);

    // Apply brightness-based DESATURATION (desaturates BRIGHT regions)
    // Prevents oversaturation and RGB clipping in dense accumulations
    if (u_brightness_desat > 0.0) {
        // Target brighter-than-average regions (where particles accumulate)
        // Start desaturating at 2x average, full desat at 100x average
        // This hits the actual bright accumulations, not just the max peaks
        float brightStart = avgBrightness * 2.0;
        float brightEnd = avgBrightness * 100.0;
        float logBrightStart = log2(brightStart + 1.0);
        float logBrightEnd = log2(brightEnd + 1.0);
        float desatFactor = smoothstep(logBrightStart, logBrightEnd, logBrightness) * u_brightness_desat;

        // Blend toward grayscale
        hdrColor = mix(hdrColor, hdrGray, desatFactor);
    }

    // Apply brightness-based SATURATION BUILDUP (desaturates DIM regions)
    // Creates effect where sparse particles are washed out, dense accumulations pop with color
    if (u_brightness_sat > 0.0) {
        // Slider controls the threshold: higher values = more aggressive desaturation
        // - At 0.3: pixels below ~1000x average are desaturated
        // - At 0.5: pixels below ~4000x average are desaturated
        // - At 1.0: pixels below ~137,000 (max) are desaturated (very aggressive)
        float threshold = avgBrightness * pow(10.0, u_brightness_sat * 3.0); // 1x to 1000x average
        float logThreshold = log2(threshold + 1.0);

        // Narrow transition for sharp cutoff
        float logTransitionStart = log2(avgBrightness * 0.1 + 1.0); // 10% of average
        float satFactor = smoothstep(logTransitionStart, logThreshold, logBrightness);

        // Apply the effect: low brightness gets desaturated AND dimmed
        float desatAmount = (1.0 - satFactor) * u_brightness_sat;
        hdrColor = mix(hdrColor, hdrGray, desatAmount);

        // Also reduce brightness in desaturated regions
        // This makes sparse trails even more subtle (both dim and colorless)
        hdrColor *= (1.0 - desatAmount * 0.5); // Reduce brightness by up to 50%
    }

    // Apply gamma correction in HDR space (before tone mapping)
    // This prevents clipping and gives the tone mapper more headroom
    vec3 gammaCorrected = applyGamma(hdrColor);

    // Apply luminance gamma in HDR space (hue-preserving brightness adjustment)
    vec3 hdrGammaCorrected = applyLuminanceGamma(gammaCorrected);

    // Apply highlight compression to compress bright values before tone mapping
    // This helps the tone mapper cover the full dynamic range more effectively
    vec3 compressed = compressHighlights(hdrGammaCorrected, u_highlight_compression, u_compression_threshold);

    // Apply tone mapping operator to compress HDR values into LDR range
    vec3 ldrColor = tonemap(compressed);

    gl_FragColor = vec4(ldrColor, 1.0);
}
`}function pi(){return`
precision highp float;

uniform sampler2D u_screen;
uniform float u_threshold;

varying vec2 v_texcoord;

void main() {
    vec3 color = texture2D(u_screen, v_texcoord).rgb;

    // Calculate luminance
    float brightness = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Extract bright regions above threshold
    // Use smooth step for soft transition
    float contribution = smoothstep(u_threshold * 0.8, u_threshold * 1.2, brightness);

    // Output bright pixels only
    gl_FragColor = vec4(color * contribution, 1.0);
}
`}function yt(o=!0,e=1){return`
precision highp float;

uniform sampler2D u_texture;
uniform vec2 u_texel_size;
uniform float u_radius;

varying vec2 v_texcoord;

void main() {
    vec2 direction = ${o?"vec2(1.0, 0.0)":"vec2(0.0, 1.0)"};
    vec3 result = vec3(0.0);

    // Bilinear-optimized 13-tap Gaussian blur
    // Uses hardware linear filtering to sample between pixels for smoother results
    // This reduces the blocky appearance by effectively sampling at sub-pixel positions

    vec2 off1 = vec2(1.3846153846) * direction * u_texel_size * u_radius;
    vec2 off2 = vec2(3.2307692308) * direction * u_texel_size * u_radius;
    vec2 off3 = vec2(5.0769230769) * direction * u_texel_size * u_radius;

    result += texture2D(u_texture, v_texcoord).rgb * 0.2270270270;
    result += texture2D(u_texture, v_texcoord + off1).rgb * 0.3162162162;
    result += texture2D(u_texture, v_texcoord - off1).rgb * 0.3162162162;
    result += texture2D(u_texture, v_texcoord + off2).rgb * 0.0702702703;
    result += texture2D(u_texture, v_texcoord - off2).rgb * 0.0702702703;
    result += texture2D(u_texture, v_texcoord + off3).rgb * 0.0162162162;
    result += texture2D(u_texture, v_texcoord - off3).rgb * 0.0162162162;

    gl_FragColor = vec4(result, 1.0);
}
`}function fi(){return`
precision highp float;

uniform sampler2D u_base;
uniform sampler2D u_bloom;
uniform float u_bloom_intensity;

varying vec2 v_texcoord;

void main() {
    vec3 baseColor = texture2D(u_base, v_texcoord).rgb;
    vec3 bloomColor = texture2D(u_bloom, v_texcoord).rgb;

    // Add bloom to base with intensity control
    vec3 result = baseColor + bloomColor * u_bloom_intensity;

    gl_FragColor = vec4(result, 1.0);
}
`}function Sr(){return`
precision highp float;

uniform sampler2D u_screen;
uniform vec2 u_resolution;
uniform float u_spatialSigma;   // Spatial blur radius
uniform float u_intensitySigma; // Edge preservation threshold

varying vec2 v_uv;

// Gaussian function
float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma));
}

// Luminance for edge detection
float luminance(vec3 color) {
    return dot(color, vec3(0.299, 0.587, 0.114));
}

void main() {
    vec2 texelSize = 1.0 / u_resolution;

    vec3 centerColor = texture2D(u_screen, v_uv).rgb;
    float centerLum = luminance(centerColor);

    // Single-pass noise detection using simple statistics
    const float brightnessThreshold = 0.05;

    // Sample 3x3 neighborhood (unrolled - no arrays)
    float s0 = luminance(texture2D(u_screen, v_uv + vec2(-1.0, -1.0) * texelSize).rgb);
    float s1 = luminance(texture2D(u_screen, v_uv + vec2( 0.0, -1.0) * texelSize).rgb);
    float s2 = luminance(texture2D(u_screen, v_uv + vec2( 1.0, -1.0) * texelSize).rgb);
    float s3 = luminance(texture2D(u_screen, v_uv + vec2(-1.0,  0.0) * texelSize).rgb);
    float s4 = luminance(texture2D(u_screen, v_uv + vec2( 0.0,  0.0) * texelSize).rgb);
    float s5 = luminance(texture2D(u_screen, v_uv + vec2( 1.0,  0.0) * texelSize).rgb);
    float s6 = luminance(texture2D(u_screen, v_uv + vec2(-1.0,  1.0) * texelSize).rgb);
    float s7 = luminance(texture2D(u_screen, v_uv + vec2( 0.0,  1.0) * texelSize).rgb);
    float s8 = luminance(texture2D(u_screen, v_uv + vec2( 1.0,  1.0) * texelSize).rgb);

    // Compute statistics
    float sum = s0 + s1 + s2 + s3 + s4 + s5 + s6 + s7 + s8;
    float sumSquares = s0*s0 + s1*s1 + s2*s2 + s3*s3 + s4*s4 + s5*s5 + s6*s6 + s7*s7 + s8*s8;

    float brightCount = 0.0;
    if (s0 > brightnessThreshold) brightCount += 1.0;
    if (s1 > brightnessThreshold) brightCount += 1.0;
    if (s2 > brightnessThreshold) brightCount += 1.0;
    if (s3 > brightnessThreshold) brightCount += 1.0;
    if (s4 > brightnessThreshold) brightCount += 1.0;
    if (s5 > brightnessThreshold) brightCount += 1.0;
    if (s6 > brightnessThreshold) brightCount += 1.0;
    if (s7 > brightnessThreshold) brightCount += 1.0;
    if (s8 > brightnessThreshold) brightCount += 1.0;

    float mean = sum / 9.0;
    float variance = (sumSquares / 9.0) - (mean * mean);

    // Simple edge detection: check gradient magnitude
    float gradX = abs(s5 - s3); // right - left
    float gradY = abs(s7 - s1); // bottom - top
    float gradient = gradX + gradY;

    // Noise detection: sparse scattered particles
    // If there's ANY variance in a dark region with low gradient, it's probably noise

    bool isDarkAndSparse = (mean < 0.2) && (brightCount < 5.0);
    bool hasNoEdges = (gradient < 0.15);

    // Apply blur to dark sparse regions with no strong edges
    bool shouldBlur = isDarkAndSparse && hasNoEdges;

    if (!shouldBlur) {
        // Structured region - pass through unchanged
        gl_FragColor = vec4(centerColor, 1.0);
        return;
    }

    // Sparse region - apply aggressive gaussian blur
    vec3 colorSum = vec3(0.0);
    float weightSum = 0.0;

    // Larger kernel radius for stronger smoothing
    const int radius = 5; // 11x11 kernel

    for (int x = -radius; x <= radius; x++) {
        for (int y = -radius; y <= radius; y++) {
            vec2 offset = vec2(float(x), float(y)) * texelSize;
            vec3 sampleColor = texture2D(u_screen, v_uv + offset).rgb;

            // Only spatial weight (pure gaussian blur in sparse regions)
            float spatialDist = length(vec2(float(x), float(y)));
            float weight = gaussian(spatialDist, u_spatialSigma);

            colorSum += sampleColor * weight;
            weightSum += weight;
        }
    }

    // Normalize
    vec3 result = colorSum / weightSum;

    gl_FragColor = vec4(result, 1.0);
}
`}var Ne=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.enabled=r.enabled!==void 0?r.enabled:!1,this.spatialSigma=r.spatialSigma!==void 0?r.spatialSigma:4,this.intensitySigma=r.intensitySigma!==void 0?r.intensitySigma:.2,this.framebuffer=null,this.texture=null,this.program=null,this.quadBuffer=null,this.initialize(),c.info("BilateralFilterManager initialized",{size:`${t}x${i}`,enabled:this.enabled,spatialSigma:this.spatialSigma,intensitySigma:this.intensitySigma})}initialize(){let e=this.gl;if(this.createFramebuffer(),this.compileShader(),!this.quadBuffer){let t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)}}createFramebuffer(){let e=this.gl;this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),this.framebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0);let t=e.checkFramebufferStatus(e.FRAMEBUFFER);t!==e.FRAMEBUFFER_COMPLETE&&c.error("Bilateral filter framebuffer incomplete",{status:t}),e.bindFramebuffer(e.FRAMEBUFFER,null)}compileShader(){let e=this.gl,t=`
attribute vec2 a_pos;
varying vec2 v_uv;

void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=Sr();this.program=G(e,t,i),this.program||c.error("Failed to compile bilateral filter shader")}apply(e){if(!this.enabled)return e;let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.viewport(0,0,this.width,this.height),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),t.uniform1i(t.getUniformLocation(this.program,"u_screen"),0),t.uniform2f(t.getUniformLocation(this.program,"u_resolution"),this.width,this.height),t.uniform1f(t.getUniformLocation(this.program,"u_spatialSigma"),this.spatialSigma),t.uniform1f(t.getUniformLocation(this.program,"u_intensitySigma"),this.intensitySigma);let i=t.getAttribLocation(this.program,"a_pos");return t.bindBuffer(t.ARRAY_BUFFER,this.quadBuffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,6),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture}updateConfig(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.spatialSigma!==void 0&&(this.spatialSigma=e.spatialSigma),e.intensitySigma!==void 0&&(this.intensitySigma=e.intensitySigma)}isEnabled(){return this.enabled}resize(e,t){this.width=e,this.height=t,this.cleanup(),this.createFramebuffer()}cleanup(){let e=this.gl;this.framebuffer&&(e.deleteFramebuffer(this.framebuffer),this.framebuffer=null),this.texture&&(e.deleteTexture(this.texture),this.texture=null)}setQuadBuffer(e){this.quadBuffer=e}};z();function Fr(){return`
precision highp float;

uniform sampler2D u_screen;
uniform vec2 u_resolution;
uniform float u_threshold;

varying vec2 v_uv;

float luminance(vec3 color) {
    return dot(color, vec3(0.299, 0.587, 0.114));
}

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    // Sample center
    vec3 center = texture2D(u_screen, v_uv).rgb;
    float lumC = luminance(center);

    // Sample neighbors
    float lumL = luminance(texture2D(u_screen, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).rgb);
    float lumR = luminance(texture2D(u_screen, v_uv + vec2(1.0, 0.0) * inverseScreenSize).rgb);
    float lumT = luminance(texture2D(u_screen, v_uv + vec2(0.0, -1.0) * inverseScreenSize).rgb);
    float lumB = luminance(texture2D(u_screen, v_uv + vec2(0.0, 1.0) * inverseScreenSize).rgb);

    // Compute delta (edge strength)
    float deltaL = abs(lumC - lumL);
    float deltaR = abs(lumC - lumR);
    float deltaT = abs(lumC - lumT);
    float deltaB = abs(lumC - lumB);

    // Horizontal and vertical edges
    vec2 edges = vec2(0.0);

    // Horizontal edge (top-bottom difference)
    float maxDeltaH = max(deltaT, deltaB);
    if (maxDeltaH > u_threshold) {
        edges.x = maxDeltaH;
    }

    // Vertical edge (left-right difference)
    float maxDeltaV = max(deltaL, deltaR);
    if (maxDeltaV > u_threshold) {
        edges.y = maxDeltaV;
    }

    gl_FragColor = vec4(edges, 0.0, 1.0);
}
`}function Ar(){return`
precision highp float;

uniform sampler2D u_edgesTex;
uniform vec2 u_resolution;

varying vec2 v_uv;

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    vec2 edges = texture2D(u_edgesTex, v_uv).xy;
    vec4 weights = vec4(0.0);

    // If no edges detected, skip
    if (dot(edges, vec2(1.0)) < 0.001) {
        gl_FragColor = weights;
        return;
    }

    // Simplified weight calculation
    // For horizontal edge, blend vertically
    if (edges.x > 0.0) {
        // Check how far edge extends
        float edgeT = texture2D(u_edgesTex, v_uv + vec2(0.0, -1.0) * inverseScreenSize).x;
        float edgeB = texture2D(u_edgesTex, v_uv + vec2(0.0, 1.0) * inverseScreenSize).x;

        // Weight based on edge continuity
        weights.x = edges.x * 0.5; // Top blend
        weights.y = edges.x * 0.5; // Bottom blend

        // Reduce weight if edge continues (sharp feature, not aliasing)
        if (edgeT > 0.0 && edgeB > 0.0) {
            weights.x *= 0.25;
            weights.y *= 0.25;
        }
    }

    // For vertical edge, blend horizontally
    if (edges.y > 0.0) {
        float edgeL = texture2D(u_edgesTex, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).y;
        float edgeR = texture2D(u_edgesTex, v_uv + vec2(1.0, 0.0) * inverseScreenSize).y;

        weights.z = edges.y * 0.5; // Left blend
        weights.w = edges.y * 0.5; // Right blend

        // Reduce weight if edge continues
        if (edgeL > 0.0 && edgeR > 0.0) {
            weights.z *= 0.25;
            weights.w *= 0.25;
        }
    }

    gl_FragColor = weights;
}
`}function Rr(){return`
precision highp float;

uniform sampler2D u_colorTex;
uniform sampler2D u_blendTex;
uniform vec2 u_resolution;
uniform float u_intensity;

varying vec2 v_uv;

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    // Get blend weights
    vec4 weights = texture2D(u_blendTex, v_uv) * u_intensity;

    // If no blending needed, return original color
    if (dot(weights, vec4(1.0)) < 0.001) {
        gl_FragColor = texture2D(u_colorTex, v_uv);
        return;
    }

    // Sample neighbors
    vec3 colorC = texture2D(u_colorTex, v_uv).rgb;
    vec3 colorT = texture2D(u_colorTex, v_uv + vec2(0.0, -1.0) * inverseScreenSize).rgb;
    vec3 colorB = texture2D(u_colorTex, v_uv + vec2(0.0, 1.0) * inverseScreenSize).rgb;
    vec3 colorL = texture2D(u_colorTex, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).rgb;
    vec3 colorR = texture2D(u_colorTex, v_uv + vec2(1.0, 0.0) * inverseScreenSize).rgb;

    // Blend based on weights
    vec3 result = colorC;
    result += colorT * weights.x;
    result += colorB * weights.y;
    result += colorL * weights.z;
    result += colorR * weights.w;

    // Normalize
    float totalWeight = 1.0 + weights.x + weights.y + weights.z + weights.w;
    result /= totalWeight;

    gl_FragColor = vec4(result, 1.0);
}
`}var Oe=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.enabled=r.enabled!==void 0?r.enabled:!0,this.intensity=r.intensity!==void 0?r.intensity:.75,this.threshold=r.threshold!==void 0?r.threshold:.1,this.edgesFramebuffer=null,this.edgesTexture=null,this.blendFramebuffer=null,this.blendTexture=null,this.edgeDetectionProgram=null,this.blendingWeightProgram=null,this.neighborhoodBlendProgram=null,this.quadBuffer=null,this.initialize(),c.info("SMAAManager initialized",{size:`${t}x${i}`,enabled:this.enabled,intensity:this.intensity,threshold:this.threshold})}initialize(){let e=this.gl;if(this.createFramebuffers(),this.compileShaders(),!this.quadBuffer){let t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)}}createFramebuffers(){let e=this.gl;this.edgesTexture=this.createTexture(),this.edgesFramebuffer=this.createFramebuffer(this.edgesTexture),this.blendTexture=this.createTexture(),this.blendFramebuffer=this.createFramebuffer(this.blendTexture)}createTexture(){let e=this.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),t}createFramebuffer(e){let t=this.gl,i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0);let r=t.checkFramebufferStatus(t.FRAMEBUFFER);return r!==t.FRAMEBUFFER_COMPLETE&&c.error("SMAA framebuffer incomplete",{status:r}),t.bindFramebuffer(t.FRAMEBUFFER,null),i}compileShaders(){let e=this.gl,t=`
attribute vec2 a_pos;
varying vec2 v_uv;

void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`;this.edgeDetectionProgram=G(e,t,Fr()),this.blendingWeightProgram=G(e,t,Ar()),this.neighborhoodBlendProgram=G(e,t,Rr()),(!this.edgeDetectionProgram||!this.blendingWeightProgram||!this.neighborhoodBlendProgram)&&c.error("Failed to compile SMAA shaders")}applyToFramebuffer(e,t,i){if(!this.enabled||this.intensity<=0){let n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),n.viewport(0,0,this.width,this.height),this.copyToFramebuffer(e,i);return}let r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.edgesFramebuffer),r.viewport(0,0,this.width,this.height),r.useProgram(this.edgeDetectionProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.uniform1i(r.getUniformLocation(this.edgeDetectionProgram,"u_screen"),0),r.uniform2f(r.getUniformLocation(this.edgeDetectionProgram,"u_resolution"),this.width,this.height),r.uniform1f(r.getUniformLocation(this.edgeDetectionProgram,"u_threshold"),this.threshold),this.drawQuad(this.edgeDetectionProgram,i),r.bindFramebuffer(r.FRAMEBUFFER,this.blendFramebuffer),r.viewport(0,0,this.width,this.height),r.useProgram(this.blendingWeightProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.edgesTexture),r.uniform1i(r.getUniformLocation(this.blendingWeightProgram,"u_edgesTex"),0),r.uniform2f(r.getUniformLocation(this.blendingWeightProgram,"u_resolution"),this.width,this.height),this.drawQuad(this.blendingWeightProgram,i),r.bindFramebuffer(r.FRAMEBUFFER,t),r.viewport(0,0,this.width,this.height),r.useProgram(this.neighborhoodBlendProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.uniform1i(r.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.blendTexture),r.uniform1i(r.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),r.uniform2f(r.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),r.uniform1f(r.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),this.intensity),this.drawQuad(this.neighborhoodBlendProgram,i)}applyToCanvas(e,t){this.applyToFramebuffer(e,null,t)}applyToCanvas_OLD(e,t){if(!this.enabled||this.intensity<=0){this.copyToCanvas(e,t);return}let i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.edgesFramebuffer),i.viewport(0,0,this.width,this.height),i.useProgram(this.edgeDetectionProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.edgeDetectionProgram,"u_screen"),0),i.uniform2f(i.getUniformLocation(this.edgeDetectionProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.edgeDetectionProgram,"u_threshold"),this.threshold),this.drawQuad(this.edgeDetectionProgram,t),i.bindFramebuffer(i.FRAMEBUFFER,this.blendFramebuffer),i.viewport(0,0,this.width,this.height),i.useProgram(this.blendingWeightProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.edgesTexture),i.uniform1i(i.getUniformLocation(this.blendingWeightProgram,"u_edgesTex"),0),i.uniform2f(i.getUniformLocation(this.blendingWeightProgram,"u_resolution"),this.width,this.height),this.drawQuad(this.blendingWeightProgram,t),i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.width,this.height),i.useProgram(this.neighborhoodBlendProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.blendTexture),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),i.uniform2f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),this.intensity),this.drawQuad(this.neighborhoodBlendProgram,t)}drawQuad(e,t){let i=this.gl,r=i.getAttribLocation(e,"a_pos");i.bindBuffer(i.ARRAY_BUFFER,t),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,2,i.FLOAT,!1,0,0),i.drawArrays(i.TRIANGLES,0,6)}copyToFramebuffer(e,t){let i=this.gl;i.useProgram(this.neighborhoodBlendProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.blendTexture),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),i.uniform2f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),0),this.drawQuad(this.neighborhoodBlendProgram,t)}copyToCanvas(e,t){let i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.width,this.height),this.copyToFramebuffer(e,t)}updateConfig(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.intensity!==void 0&&(this.intensity=e.intensity),e.threshold!==void 0&&(this.threshold=e.threshold)}isEnabled(){return this.enabled&&this.intensity>0}resize(e,t){this.width=e,this.height=t,this.cleanup(),this.createFramebuffers()}cleanup(){let e=this.gl;this.edgesFramebuffer&&e.deleteFramebuffer(this.edgesFramebuffer),this.blendFramebuffer&&e.deleteFramebuffer(this.blendFramebuffer),this.edgesTexture&&e.deleteTexture(this.edgesTexture),this.blendTexture&&e.deleteTexture(this.blendTexture),this.edgesFramebuffer=null,this.blendFramebuffer=null,this.edgesTexture=null,this.blendTexture=null}setQuadBuffer(e){this.quadBuffer=e}get framebuffer(){return null}};z();var Ge=class{constructor(e){this.gl=e,this.reductionProgram=null,this.finalProgram=null,this.quadBuffer=null,this.reductionFBOs=[],this.reductionTextures=[],this.stats={red:{min:0,max:0,avg:0},green:{min:0,max:0,avg:0},blue:{min:0,max:0,avg:0},maxBrightness:0,avgBrightness:0,histogram:[],timestamp:0},this.initialized=!1}initialize(){let e=this.gl;this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW);let t=`
attribute vec2 a_pos;
varying vec2 v_texcoord;
void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=`
precision highp float;
uniform sampler2D u_texture;
uniform vec2 u_texel_size;
varying vec2 v_texcoord;

void main() {
    // Sample 2x2 block
    vec2 base = v_texcoord;
    vec3 s0 = texture2D(u_texture, base).rgb;
    vec3 s1 = texture2D(u_texture, base + vec2(u_texel_size.x, 0.0)).rgb;
    vec3 s2 = texture2D(u_texture, base + vec2(0.0, u_texel_size.y)).rgb;
    vec3 s3 = texture2D(u_texture, base + u_texel_size).rgb;

    // Compute min/max across the 2x2 block
    vec3 minVal = min(min(s0, s1), min(s2, s3));
    vec3 maxVal = max(max(s0, s1), max(s2, s3));

    // Store: R=min, G=max, B=sum (for averaging)
    // We'll pack min in R channel, max in G channel, sum in B channel
    // Actually, we need all three channels for each stat, so let's use a different approach
    // Let's just compute the max for now (most useful for saturation buildup)

    gl_FragColor = vec4(maxVal, 1.0);
}
`;return this.reductionProgram=this.createProgram(t,i),this.reductionProgram?(this.initialized=!0,!0):(c.error("Failed to create reduction shader"),!1)}createProgram(e,t){let i=this.gl,r=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))return c.error("Vertex shader compile error:",i.getShaderInfoLog(r)),null;let n=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(n,t),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))return c.error("Fragment shader compile error:",i.getShaderInfoLog(n)),null;let s=i.createProgram();return i.attachShader(s,r),i.attachShader(s,n),i.linkProgram(s),i.getProgramParameter(s,i.LINK_STATUS)?s:(c.error("Program link error:",i.getProgramInfoLog(s)),null)}compute(e,t,i,r=!0){if(!this.initialized&&!this.initialize())return this.stats;let n=this.gl,s=r?16:2;return this.computeCPUSampled(e,t,i,s)}computeCPUSampled(e,t,i,r){let n=this.gl,s=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,s),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,e,0),n.checkFramebufferStatus(n.FRAMEBUFFER)!==n.FRAMEBUFFER_COMPLETE)return c.error("Framebuffer not complete for stats readback"),n.deleteFramebuffer(s),this.stats;let a=4,l=16,u=a*a*l*l,d=new Float32Array(u*4),h=0;for(let A=0;A<a;A++)for(let L=0;L<a;L++){let T=Math.floor(t/a*L+(t/a-l)/2),C=Math.floor(i/a*A+(i/a-l)/2),P=new Float32Array(l*l*4);n.readPixels(T,C,l,l,n.RGBA,n.FLOAT,P),d.set(P,h*4),h+=l*l}n.deleteFramebuffer(s),n.bindFramebuffer(n.FRAMEBUFFER,null);let p=1/0,m=-1/0,f=0,b=1/0,x=-1/0,g=0,y=1/0,_=-1/0,E=0,R=u;for(let A=0;A<R;A++){let L=A*4,T=d[L],C=d[L+1],P=d[L+2];p=Math.min(p,T),m=Math.max(m,T),f+=T,b=Math.min(b,C),x=Math.max(x,C),g+=C,y=Math.min(y,P),_=Math.max(_,P),E+=P}let w=R>0?f/R:0,S=R>0?g/R:0,M=R>0?E/R:0,B=20,v=new Array(B).fill(0),F=Math.max(m,x,_);if(F>0){let A=Math.log2(F+1);for(let L=0;L<R;L++){let T=L*4,C=Math.max(d[T],d[T+1],d[T+2]),P=Math.log2(C+1),U=Math.min(Math.floor(P/A*B),B-1);v[U]++}}return this.stats={red:{min:p,max:m,avg:w},green:{min:b,max:x,avg:S},blue:{min:y,max:_,avg:M},maxBrightness:Math.max(m,x,_),avgBrightness:(w+S+M)/3,histogram:v,timestamp:Date.now(),sampledPixels:R,sampleRate:r},this.stats}getCached(){return this.stats}dispose(){let e=this.gl;this.quadBuffer&&e.deleteBuffer(this.quadBuffer),this.reductionProgram&&e.deleteProgram(this.reductionProgram),this.finalProgram&&e.deleteProgram(this.finalProgram),this.reductionFBOs.forEach(t=>e.deleteFramebuffer(t)),this.reductionTextures.forEach(t=>e.deleteTexture(t)),this.reductionFBOs=[],this.reductionTextures=[]}};z();var He=class{constructor(e){this.gl=e,this.program=null,this.quadBuffer=null,this.resultTexture=null,this.resultFBO=null,this.stats={maxVelocity:5,avgVelocity:2,sampleCount:0,timestamp:0},this.initialized=!1,this.shaderSource=null}initialize(e,t,i=null){let r=this.gl;if(this.quadBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.quadBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r.STATIC_DRAW),this.resultTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.resultTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,64,1,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.resultFBO=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this.resultFBO),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.resultTexture,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)return c.error("Velocity stats framebuffer not complete"),this.dispose(),!1;r.bindFramebuffer(r.FRAMEBUFFER,null);let n=`vec${e}`,s=["x","y","z","w"],a=t.map((f,b)=>`    result.${s[b]} = ${f};`).join(`
`),l=i&&i.forwardTransform,u=l?`
// User-defined velocity field in native coordinates
${n} get_velocity_native(${n} pos_native) {
    ${n} result;
${a}
    return result;
}

// Velocity field for statistics (native-space integration)
${n} get_velocity(${n} pos_cartesian) {
    ${n} pos_native = transformToNative(pos_cartesian);
    return get_velocity_native(pos_native);
}
`:`
// User-defined velocity field
${n} get_velocity(${n} pos) {
    ${n} result;
    float x = pos.x;
    ${e>1?"float y = pos.y;":""}
    ${e>2?"float z = pos.z;":""}
    ${e>3?"float w = pos.w;":""}

${a}

    return result;
}
`,d=`
attribute vec2 a_pos;
varying vec2 v_texcoord;
void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,h=`
precision highp float;

${Array.from({length:e},(f,b)=>`uniform sampler2D u_pos_${b};`).join(`
`)}
uniform vec2 u_bbox_min;
uniform vec2 u_bbox_max;
uniform float u_resolution;
uniform float u_sample_count;
uniform float u_alpha;

varying vec2 v_texcoord;

${l?i.forwardTransform:""}

${u}

void main() {
    // Each output pixel computes velocity for one sampled particle
    float particleIndex = floor(v_texcoord.x * u_sample_count);

    // Random sampling across all particles
    float totalParticles = u_resolution * u_resolution;
    float stride = totalParticles / u_sample_count;
    float sampleIdx = particleIndex * stride;

    // Convert to texture coordinates
    float x = mod(sampleIdx, u_resolution);
    float y = floor(sampleIdx / u_resolution);
    vec2 texCoord = (vec2(x, y) + 0.5) / u_resolution;

    // Read position from textures
    vec${e} position;
    ${Array.from({length:e},(f,b)=>`position[${b}] = texture2D(u_pos_${b}, texCoord).r;`).join(`
    `)}

    // Compute velocity
    vec${e} velocity = get_velocity(position);

    // Compute magnitude
    float speed = length(velocity);

    // Output: R = velocity magnitude, G = 1.0 (for counting), B/A unused
    gl_FragColor = vec4(speed, 1.0, 0.0, 1.0);
}
`,p=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(p,d),r.compileShader(p),!r.getShaderParameter(p,r.COMPILE_STATUS))return c.error("Velocity stats vertex shader error:",r.getShaderInfoLog(p)),!1;let m=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(m,h),r.compileShader(m),r.getShaderParameter(m,r.COMPILE_STATUS)?(this.program=r.createProgram(),r.attachShader(this.program,p),r.attachShader(this.program,m),r.linkProgram(this.program),r.getProgramParameter(this.program,r.LINK_STATUS)?(this.initialized=!0,this.dimensions=e,this.shaderSource=h,c.verbose("VelocityStatsManager initialized"),!0):(c.error("Velocity stats program link error:",r.getProgramInfoLog(this.program)),!1)):(c.error("Velocity stats fragment shader error:",r.getShaderInfoLog(m)),c.error(`Generated shader code:
`+h),!1)}compute(e,t,i,r=0){if(!this.initialized)return this.stats;let n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,this.resultFBO),n.viewport(0,0,64,1),n.useProgram(this.program);for(let b=0;b<this.dimensions;b++)n.activeTexture(n.TEXTURE0+b),n.bindTexture(n.TEXTURE_2D,e[b]),n.uniform1i(n.getUniformLocation(this.program,`u_pos_${b}`),b);n.uniform2f(n.getUniformLocation(this.program,"u_bbox_min"),t.min[0],t.min[1]),n.uniform2f(n.getUniformLocation(this.program,"u_bbox_max"),t.max[0],t.max[1]),n.uniform1f(n.getUniformLocation(this.program,"u_resolution"),i),n.uniform1f(n.getUniformLocation(this.program,"u_sample_count"),64),n.uniform1f(n.getUniformLocation(this.program,"u_alpha"),r),n.bindBuffer(n.ARRAY_BUFFER,this.quadBuffer);let s=n.getAttribLocation(this.program,"a_pos");n.enableVertexAttribArray(s),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,6);let a=new Float32Array(256);n.readPixels(0,0,64,1,n.RGBA,n.FLOAT,a),n.bindFramebuffer(n.FRAMEBUFFER,null);let l=[],u=0,d=0;for(let b=0;b<64;b++){let x=a[b*4];isFinite(x)&&x>0&&(l.push(x),u=Math.max(u,x),d+=x)}let h=l.length,p=h>0?d/h:0,m=p,f=p;if(h>0){l.sort((g,y)=>g-y);let b=Math.floor(h*.9),x=Math.floor(h*.95);m=l[Math.min(b,h-1)],f=l[Math.min(x,h-1)]}return this.stats={maxVelocity:u>0?u:this.stats.maxVelocity,avgVelocity:p>0?p:this.stats.avgVelocity,percentile90:m>0?m:this.stats.percentile90||p,percentile95:f>0?f:this.stats.percentile95||p,sampleCount:h,timestamp:Date.now()},this.stats}getCached(){return this.stats}dispose(){let e=this.gl;this.quadBuffer&&e.deleteBuffer(this.quadBuffer),this.program&&e.deleteProgram(this.program),this.resultTexture&&e.deleteTexture(this.resultTexture),this.resultFBO&&e.deleteFramebuffer(this.resultFBO),this.initialized=!1}needsRecompile(){return!0}getShaderSource(){return this.shaderSource}};z();var Xe=class{constructor(e,t,i,r){this.particleCount=e,this.dimensions=t,this.bbox=i||this.getDefaultBBox(t),this.strategy=r,this.resolution=Math.ceil(Math.sqrt(e)),this.actualParticleCount=this.resolution*this.resolution,this.initializeParticles()}getDefaultBBox(e){return{min:new Array(e).fill(-5),max:new Array(e).fill(5)}}initializeParticles(){this.data=[];let e=[],t=this.strategy.getArrayType(),i=this.strategy.getComponentsPerValue();for(let r=0;r<this.dimensions;r++){let n=new t(this.actualParticleCount*i);for(let s=0;s<this.actualParticleCount;s++){let l;if(r<2&&this.bbox.min&&this.bbox.max){let m=r===0?this.bbox.min[0]:this.bbox.min[1],b=(r===0?this.bbox.max[0]:this.bbox.max[1])-m;l=m+b*-.02+Math.random()*b*(1-2*-.02)}else l=-10.4+Math.random()*20.8;let u=r<2?r===0?this.bbox.min[0]:this.bbox.min[1]:-10,d=r<2?r===0?this.bbox.max[0]:this.bbox.max[1]:10,h=this.strategy.encodeValue(l,u,d),p=s*i;for(let m=0;m<i;m++)n[p+m]=h[m];if(s<10&&r<2){let m=new t(i);for(let x=0;x<i;x++)m[x]=n[p+x];let f=this.strategy.decodeValue(m,u,d);e[s]||(e[s]={});let b;i===4?b=`[${h[0].toFixed?.(0)||h[0]}, ${h[1].toFixed?.(0)||h[1]}, ${h[2].toFixed?.(0)||h[2]}, ${h[3].toFixed?.(0)||h[3]}]`:b=h[0].toString(),e[s][r===0?"x":"y"]={worldValue:l.toFixed(4),encoded:b,decodedWorld:f.toFixed(4),error:Math.abs(l-f).toFixed(6)}}}this.data.push(n)}e.length>0&&c.info("Particle initialization - first 10 particles:",{strategy:this.strategy.getName(),bbox:`[${this.bbox.min[0]}, ${this.bbox.min[1]}] to [${this.bbox.max[0]}, ${this.bbox.max[1]}]`,samples:e.filter(r=>r)}),this.indices=new Float32Array(this.actualParticleCount);for(let r=0;r<this.actualParticleCount;r++)this.indices[r]=r}getDimensionData(e){return this.data[e]}getAllData(){return this.data}getIndices(){return this.indices}setParticleCount(e){this.particleCount=e,this.resolution=Math.ceil(Math.sqrt(e)),this.actualParticleCount=this.resolution*this.resolution,this.initializeParticles()}setDimensions(e){this.dimensions=e,this.bbox=this.getDefaultBBox(e),this.initializeParticles()}setBBox(e){this.bbox=e}getResolution(){return this.resolution}getActualParticleCount(){return this.actualParticleCount}};_t();z();var Mr=["x","y","z","w","u","v"];function Re(o){let e=o===2?"mat2":o===3?"mat3":"mat4",t=`inverse${o}`;if(o===2)return`
// Compute inverse of 2x2 matrix (closed form)
// For matrix [a c; b d] (column-major), inverse is [d -c; -b a] / det
mat2 inverse2(mat2 m) {
    float det = m[0][0]*m[1][1] - m[1][0]*m[0][1];
    return mat2(m[1][1], -m[1][0], -m[0][1], m[0][0]) / det;
}`;let i=`
// Compute inverse of ${o}x${o} matrix using Gauss-Jordan elimination
${e} ${t}(${e} m) {
    // Create augmented matrix [m | I] stored as ${o} column vectors
`;for(let r=0;r<o;r++){i+=`    vec${o} aug${r} = vec${o}(`;for(let n=0;n<o;n++)n>0&&(i+=", "),i+=`m[${r}][${n}]`;i+=`);
`}for(let r=0;r<o;r++){i+=`    vec${o} aug${o+r} = vec${o}(`;for(let n=0;n<o;n++)n>0&&(i+=", "),i+=n===r?"1.0":"0.0";i+=`);
`}i+=`
`;for(let r=0;r<o;r++){i+=`    // Pivot ${r}: Make diagonal element = 1 and eliminate column ${r}
`,i+=`    float scale${r} = aug${r}[${r}];
`,i+=`    if (abs(scale${r}) < 0.0001) scale${r} = 0.0001;
`;for(let n=0;n<2*o;n++)i+=`    aug${n}[${r}] /= scale${r};
`;i+=`
`;for(let n=0;n<o;n++)if(n!==r){i+=`    // Eliminate row ${n}
`,i+=`    float factor${r}_${n} = aug${r}[${n}];
`;for(let s=0;s<2*o;s++)i+=`    aug${s}[${n}] -= factor${r}_${n} * aug${s}[${r}];
`;i+=`
`}}i+=`    // Extract inverse from augmented matrix
`,i+=`    return ${e}(
`;for(let r=0;r<o;r++)r>0&&(i+=`,
`),i+=`        aug${o+r}`;return i+=`
    );
`,i+=`}
`,i}function je(o,e){let t=e===2?"mat2":e===3?"mat3":"mat4",i=`vec${e}`,r="";for(let a=0;a<e;a++)r+=`    float ${Mr[a]} = pos.${["x","y","z","w"][a]};
`;let n=[];for(let a=0;a<e;a++)for(let l=0;l<e;l++){let u=o[l][a];try{let d=K(u,e);n.push(d)}catch(d){c.warn(`Failed to compile Jacobian element [${l}][${a}]: ${u}`,d),n.push("0.0")}}return`
${Re(e)}

// Compute Jacobian matrix at given position
${t} computeJacobian(${i} pos) {
${r}
    return ${t}(
        ${n.join(`,
        `)}
    );
}`}function Z(o,e,t){let i=e(o);return`        ${o} = ${i};`}function Se(o,e,t){let i=`vec${t}`,r=`${o}_pred`,n=`${o}_mid`,s=e(o),a=e(n);return`        // Predictor: standard fixed-point step
        ${i} ${r} = ${s};

        // Corrector: evaluate at midpoint between current and predictor
        ${i} ${n} = (${o} + ${r}) * 0.5;
        ${o} = ${a};`}function Fe(o,e,t,i){let r=`vec${i}`,n=i===2?"mat2":i===3?"mat3":"mat4",s=`inverse${i}`,a=e(o),l=t(o);return`        ${r} F_${o} = ${a};
        ${n} J_${o} = ${l};

        // Newton step: x -= J^(-1) * F
        ${r} delta_${o} = ${s}(J_${o}) * F_${o};
        ${o} -= delta_${o};`}function Ae(o,e,t,i="h",r=null){let n=`vec${t}`,s=t===2?"mat2":t===3?"mat3":"mat4",a=`inverse${t}`,l=["x","y","z","w"],u="1e-4",d="",h=[];for(let f=0;f<t;f++){let b=`Df_col${f}_${o}`,x=Array.from({length:t},(_,E)=>E===f?u:"0.0").join(", "),g=e(`${o} + ${n}(${x})`),y=e(o);d+=`
        // Velocity Jacobian column ${f}: d(velocity)/d${l[f]}
        ${n} ${b} = (${g} - ${y}) / ${u};`,h.push(b)}d+=`

        // Velocity Jacobian matrix Df
        ${s} Df_${o} = ${s}(${h.join(", ")});

        // Residual Jacobian: J_F = I - ${i} * Df
        ${s} J_${o} = ${s}(1.0) - ${i} * Df_${o};`;let p=e(o),m=r||`pos + ${i} * ${p}`;return`        // Finite difference Jacobian approximation (epsilon = ${u})${d}

        // Compute residual: F(x) = x - RHS
        ${n} F_${o} = ${o} - (${m});

        // Newton step: x -= J^(-1) * F
        ${n} delta_${o} = ${a}(J_${o}) * F_${o};
        ${o} -= delta_${o};`}function Lr(o){return{name:"Euler",costFactor:1,code:`
// Euler integration
vec${o} integrate(vec${o} pos, float h) {
    vec${o} velocity = get_velocity(pos);
    return pos + h * velocity;
}
`}}function bi(o){return{name:"Explicit Midpoint",costFactor:2,code:`
// Explicit Midpoint (RK2) integration
vec${o} integrate(vec${o} pos, float h) {
    vec${o} k1 = get_velocity(pos);
    vec${o} k2 = get_velocity(pos + h * 0.5 * k1);
    return pos + h * k2;
}
`}}function Pr(o){return{name:"Heun (Explicit Trapezoidal)",costFactor:2,code:`
// Heun's Method (Explicit Trapezoidal) integration
vec${o} integrate(vec${o} pos, float h) {
    vec${o} k1 = get_velocity(pos);
    vec${o} k2 = get_velocity(pos + h * k1);
    return pos + h * 0.5 * (k1 + k2);
}
`}}function xi(o){return{name:"RK4",costFactor:4,code:`
// Runge-Kutta 4 integration
vec${o} integrate(vec${o} pos, float h) {
    vec${o} k1 = get_velocity(pos);
    vec${o} k2 = get_velocity(pos + h * 0.5 * k1);
    vec${o} k3 = get_velocity(pos + h * 0.5 * k2);
    vec${o} k4 = get_velocity(pos + h * k3);

    return pos + h * (k1 / 6.0 + k2 / 3.0 + k3 / 3.0 + k4 / 6.0);
}
`}}function yi(o,e=3,t="fixed-point",i=null){c.info(`*** Implicit Euler integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${o}`,n=o===2?"mat2":o===3?"mat3":"mat4",s="pos + h * get_velocity(pos)",a=p=>`pos + h * get_velocity(${p})`,l=p=>`get_velocity(${p})`,u,d,h="";if(t==="newton"&&i){c.info("Computing Jacobian for Newton's method");let p=ee(i,o);Te(p)?(c.info("\u2713 Successfully using Newton's method for Implicit Euler"),h=je(p,o),u=Fe("x_new",b=>`${b} - pos - h * get_velocity(${b})`,b=>`${n}(1.0) - h * computeJacobian(${b})`,o),d="Newton"):(c.warn("\u2717 Failed to compute Jacobian for Newton's method"),c.warn("Falling back to fixed-point iteration"),u=Z("x_new",a,o),d="Fixed-Point")}else t==="newton-fd"?(c.info("\u2713 Using finite difference Newton's method for Implicit Euler"),h=Re(o),u=Ae("x_new",l,o),d="Newton (FD)"):t==="midpoint"?(u=Se("x_new",a,o),d="Midpoint"):(u=Z("x_new",a,o),d="Fixed-Point");return{name:`Implicit Euler (${d})`,costFactor:1,code:`
${h}
// Implicit Euler integration (${d.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    // Start with initial guess
    ${r} x_new = ${s};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${u}
    }

    return x_new;
}
`}}function Br(o,e=4,t="fixed-point",i=null){c.info(`*** Implicit Midpoint integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${o}`,n=o===2?"mat2":o===3?"mat3":"mat4",a="pos + h * get_velocity(pos + h * 0.5 * get_velocity(pos))",l=m=>`pos + h * get_velocity((pos + ${m}) * 0.5)`,u=m=>`get_velocity((pos + ${m}) * 0.5)`,d,h,p="";if(t==="newton"&&i){c.info("Computing Jacobian for Newton's method (Implicit Midpoint)");let m=ee(i,o);Te(m)?(c.info("\u2713 Successfully using Newton's method for Implicit Midpoint"),p=je(m,o),d=Fe("x_new",x=>`${x} - pos - h * get_velocity((pos + ${x}) * 0.5)`,x=>`${n}(1.0) - (h * 0.5) * computeJacobian((pos + ${x}) * 0.5)`,o),h="Newton"):(c.warn("\u2717 Failed to compute Jacobian for Newton's method (Implicit Midpoint)"),c.warn("Falling back to fixed-point iteration"),d=Z("x_new",l,o),h="Fixed-Point")}else t==="newton-fd"?(c.info("\u2713 Using finite difference Newton's method for Implicit Midpoint"),p=Re(o),d=Ae("x_new",u,o,"h * 0.5"),h="Newton (FD)"):t==="midpoint"?(d=Se("x_new",l,o),h="Midpoint"):(d=Z("x_new",l,o),h="Fixed-Point");return{name:`Implicit Midpoint (${h})`,costFactor:2,code:`
${p}
// Implicit Midpoint integration (${h.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    // Start with initial guess
    ${r} x_new = ${a};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${d}
    }

    return x_new;
}
`}}function Ir(o,e=4,t="fixed-point",i=null){c.info(`*** Trapezoidal integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${o}`,n=o===2?"mat2":o===3?"mat3":"mat4",s="pos + h * f0",a=p=>`pos + h * 0.5 * (f0 + get_velocity(${p}))`,l=p=>`get_velocity(${p})`,u,d,h="";if(t==="newton"&&i){c.info("Computing Jacobian for Newton's method (Trapezoidal)");let p=ee(i,o);Te(p)?(c.info("\u2713 Successfully using Newton's method for Trapezoidal"),h=je(p,o),u=Fe("x_new",b=>`${b} - pos - h * 0.5 * (f0 + get_velocity(${b}))`,b=>`${n}(1.0) - (h * 0.5) * computeJacobian(${b})`,o),d="Newton"):(c.warn("\u2717 Failed to compute Jacobian for Newton's method (Trapezoidal)"),c.warn("Falling back to fixed-point iteration"),u=Z("x_new",a,o),d="Fixed-Point")}else t==="newton-fd"?(c.info("\u2713 Using finite difference Newton's method for Trapezoidal"),h=Re(o),u=Ae("x_new",l,o,"h * 0.5","pos + h * 0.5 * (f0 + "+l("x_new")+")"),d="Newton (FD)"):t==="midpoint"?(u=Se("x_new",a,o),d="Midpoint"):(u=Z("x_new",a,o),d="Fixed-Point");return{name:`Trapezoidal (${d})`,costFactor:2,code:`
${h}
// Trapezoidal Rule integration (${d.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    ${r} f0 = get_velocity(pos);

    // Start with initial guess
    ${r} x_new = ${s};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${u}
    }

    return x_new;
}
`}}function Dr(o,e=5,t="fixed-point",i=null){c.info(`*** Implicit RK4 integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${o}`,n=o===2?"mat2":o===3?"mat3":"mat4",s=`
    // Gauss-Legendre coefficients for 2-stage method
    const float a11 = 0.25;
    const float a12 = 0.25 - sqrt(3.0) / 6.0;
    const float a21 = 0.25 + sqrt(3.0) / 6.0;
    const float a22 = 0.25;
    const float b1 = 0.5;
    const float b2 = 0.5;
    const float c1 = 0.5 - sqrt(3.0) / 6.0;
    const float c2 = 0.5 + sqrt(3.0) / 6.0;`,a=`
    // Start with explicit RK4 as initial guess
    ${r} k1_guess = get_velocity(pos);
    ${r} k2_guess = get_velocity(pos + h * 0.5 * k1_guess);

    ${r} k1 = k1_guess;
    ${r} k2 = k2_guess;`,l=g=>`get_velocity(pos + h * (a11 * ${g} + a12 * k2))`,u=g=>`get_velocity(pos + h * (a21 * k1 + a22 * ${g}))`,d=g=>`get_velocity(pos + h * (a11 * ${g} + a12 * k2))`,h=g=>`get_velocity(pos + h * (a21 * k1 + a22 * ${g}))`,p,m,f,b="";if(t==="newton"&&i){c.info("Computing Jacobian for Newton's method (Implicit RK4 - simplified)");let g=ee(i,o);if(Te(g)){c.info("\u2713 Successfully using simplified Newton's method for Implicit RK4"),b=je(g,o);let y=w=>`${w} - get_velocity(pos + h * (a11 * ${w} + a12 * k2))`,_=w=>`${n}(1.0) - (h * a11) * computeJacobian(pos + h * (a11 * ${w} + a12 * k2))`,E=w=>`${w} - get_velocity(pos + h * (a21 * k1 + a22 * ${w}))`,R=w=>`${n}(1.0) - (h * a22) * computeJacobian(pos + h * (a21 * k1 + a22 * ${w}))`;p=Fe("k1",y,_,o),m=Fe("k2",E,R,o),f="Newton"}else c.warn("\u2717 Failed to compute Jacobian for Newton's method (Implicit RK4)"),c.warn("Falling back to fixed-point iteration"),p=Z("k1",l,o),m=Z("k2",u,o),f="Fixed-Point"}else t==="newton-fd"?(c.info("\u2713 Using finite difference Newton's method for Implicit RK4 (simplified)"),b=Re(o),p=Ae("k1",d,o,"h * a11"),m=Ae("k2",h,o,"h * a22"),f="Newton (FD)"):t==="midpoint"?(p=Se("k1",l,o),m=Se("k2",u,o),f="Midpoint"):(p=Z("k1",l,o),m=Z("k2",u,o),f="Fixed-Point");let x=`
    // Iterative solver for coupled stages (Gauss-Seidel style)
    for (int i = 0; i < ${e}; i++) {
        // Stage 1
${p}

        // Stage 2
${m}
    }`;return{name:`Implicit RK4 (${f})`,costFactor:4,code:`
${b}
// Implicit RK4 (Gauss-Legendre 2-stage) integration (${f.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
${s}
${a}
${x}

    return pos + h * (b1 * k1 + b2 * k2);
}
`}}function vi(o,e,t={}){let i=t.iterations||3,r=t.solutionMethod||"fixed-point",n=t.expressions||null;switch(o){case"euler":return Lr(e);case"explicit-midpoint":return bi(e);case"heun":return Pr(e);case"rk4":return xi(e);case"implicit-euler":return yi(e,i,r,n);case"implicit-midpoint":return Br(e,t.iterations||4,r,n);case"trapezoidal":return Ir(e,t.iterations||4,r,n);case"implicit-rk4":return Dr(e,t.iterations||5,r,n);case"rk2":return bi(e);case"implicit":return yi(e,i,r,n);default:return xi(e)}}function We(o,e,t,i=null){i===null&&(i=t>=3?2:-1);let r=i>=0&&i<t;return{name:"Select",params:{dim1:o,dim2:e,depthDim:i},code:`
// Select 2 dimensions for display${r?" (with depth)":""}
vec2 project_to_2d(vec${t} pos) {
    return vec2(pos[${o}], pos[${e}]);
}

vec3 project_to_3d(vec${t} pos) {
    return vec3(pos[${o}], pos[${e}], ${r?`pos[${i}]`:"0.0"});
}
`}}function Vr(o,e){let t=o[0].map((n,s)=>`${n.toFixed(6)} * pos[${s}]`).join(" + "),i=o[1].map((n,s)=>`${n.toFixed(6)} * pos[${s}]`).join(" + "),r=o[2]?o[2].map((n,s)=>`${n.toFixed(6)} * pos[${s}]`).join(" + "):null;return{name:"Linear Projection",params:{matrix:o},code:`
// Linear projection matrix
vec2 project_to_2d(vec${e} pos) {
    return vec2(
        ${t},
        ${i}
    );
}

vec3 project_to_3d(vec${e} pos) {
    return vec3(
        ${t},
        ${i},
        ${r||"0.0"}
    );
}
`}}function zr(o,e){let t=o===0?1:0,i=t+1;return i===o&&i++,{name:"Orthographic",params:{axis:o},code:`
// Orthographic projection (remove axis ${o}, use as depth)
vec2 project_to_2d(vec${e} pos) {
    return vec2(pos[${t}], pos[${i}]);
}

vec3 project_to_3d(vec${e} pos) {
    return vec3(pos[${t}], pos[${i}], pos[${o}]);
}
`}}function Ur(){return{name:"Spherical",params:{},code:`
// Spherical projection (3D only)
vec2 project_to_2d(vec3 pos) {
    float r = length(pos);
    if (r < 0.001) return vec2(0.0, 0.0);

    float theta = atan(pos.y, pos.x);
    float phi = acos(pos.z / r);

    return vec2(theta, phi);
}

vec3 project_to_3d(vec3 pos) {
    float r = length(pos);
    if (r < 0.001) return vec3(0.0, 0.0, 0.0);

    float theta = atan(pos.y, pos.x);
    float phi = acos(pos.z / r);

    return vec3(theta, phi, r);  // Use radius as depth
}
`}}function kr(o){return{name:"Stereographic",params:{},code:`
// Stereographic projection
vec2 project_to_2d(vec${o} pos) {
    float denom = 1.0 - pos[${o-1}];
    if (abs(denom) < 0.001) denom = 0.001;
    return vec2(pos[0] / denom, pos[1] / denom);
}

vec3 project_to_3d(vec${o} pos) {
    float denom = 1.0 - pos[${o-1}];
    if (abs(denom) < 0.001) denom = 0.001;
    return vec3(pos[0] / denom, pos[1] / denom, pos[${o-1}]);
}
`}}function _i(o,e,t={}){switch(o){case"select":{let i=t.dim1!==void 0?t.dim1:0,r=t.dim2!==void 0?t.dim2:Math.min(1,e-1),n=t.depthDim!==void 0?t.depthDim:null;return We(i,r,e,n)}case"project":{let i=t.matrix||[[1,0,...Array(Math.max(0,e-2)).fill(0)],[0,1,...Array(Math.max(0,e-2)).fill(0)]];return Vr(i,e)}case"orthographic":{let i=t.axis!==void 0?t.axis:e-1;return zr(i,e)}case"spherical":return e===3?Ur():We(0,1,e);case"stereographic":return e>=3?kr(e):We(0,1,e);case"custom":{let i=t.horizontalExpr||"x",r=t.verticalExpr||"y",n=t.depthExpr||"";return Nr(i,r,n,e)}default:return We(0,1,e)}}function Nr(o,e,t,i){let r=K(o||"x",i),n=K(e||"y",i),s=t?K(t,i):"0.0";return{name:"Custom",params:{horizontalExpr:o,verticalExpr:e,depthExpr:t},code:`
// Custom mapper
vec2 project_to_2d(vec${i} pos) {
    return vec2(
        ${r},
        ${n}
    );
}

vec3 project_to_3d(vec${i} pos) {
    return vec3(
        ${r},
        ${n},
        ${s}
    );
}
`}}var J=class{constructor(e,t){this.name=e,this.description=t}generateHelpers(e){return""}generateForward(e){throw new Error("generateForward must be implemented")}generateInverse(e){throw new Error("generateInverse must be implemented")}generateJacobian(e){throw new Error("generateJacobian must be implemented")}getParameters(){return[]}},ce=class extends J{constructor(){super("identity","No transformation (identity)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    return x;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    return y;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    return ${t}(1.0);
}`}},Et=class extends J{constructor(){super("power","Power transform (zoom lens effect)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`    result.${n} = sign(x.${n}) * pow(abs(x.${n}) + 1e-8, alpha);`}).join(`
`)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    float inv_alpha = 1.0 / alpha;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`    result.${n} = sign(y.${n}) * pow(abs(y.${n}) + 1e-8, inv_alpha);`}).join(`
`)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`    result.${n} = alpha * pow(abs(x.${n}) + 1e-8, alpha - 1.0);`}).join(`
`)}
    return result;
}`}getParameters(){return[{name:"alpha",label:"Exponent (\u03B1)",type:"slider",min:1e-4,max:25,step:1e-4,default:.5,info:"\u03B1 < 1.0: zoom into origin; \u03B1 > 1.0: compress origin"}]}},$t=class extends J{constructor(){super("tanh","Hyperbolic tangent (compress infinity)")}generateHelpers(e){return`
// Helper: tanh(x) = (exp(2x) - 1) / (exp(2x) + 1)
float tanh_scalar(float x) {
    float e2x = exp(2.0 * x);
    return (e2x - 1.0) / (e2x + 1.0);
}
`}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float beta = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = tanh_scalar(beta * x.${n});`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float beta = u_transform_params.x;
    // atanh(y) = 0.5 * log((1+y)/(1-y))
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${n}, -0.99999, 0.99999);
        result.${n} = 0.5 * log((1.0 + y_clamped) / (1.0 - y_clamped)) / beta;
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float beta = u_transform_params.x;
    // Jacobian of tanh: d/dx tanh(x) = 1 - tanh^2(x)
    ${t} tanh_vals;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`tanh_vals.${n} = tanh_scalar(beta * x.${n});`}).join(`
    `)}
    return beta * (${t}(1.0) - tanh_vals * tanh_vals);
}`}getParameters(){return[{name:"beta",label:"Compression (\u03B2)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Higher = more compression. Maps infinite space to [-1,1]"}]}},wt=class extends J{constructor(){super("sigmoid","Logistic Sigmoid (smooth S-curve)")}generateHelpers(e){return`
// Helper: sigmoid(x) = 1 / (1 + exp(-x))
float sigmoid_scalar(float x) {
    return 1.0 / (1.0 + exp(-x));
}
`}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float k = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = 2.0 * sigmoid_scalar(k * x.${n}) - 1.0;`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float k = u_transform_params.x;
    // Inverse: x = ln((y+1)/(1-y)) / k
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${n}, -0.99999, 0.99999);
        result.${n} = log((y_clamped + 1.0) / (1.0 - y_clamped)) / k;
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float k = u_transform_params.x;
    // Jacobian: d/dx [2*sigmoid(k*x) - 1] = 2k * sigmoid(k*x) * (1 - sigmoid(k*x))
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float sig = sigmoid_scalar(k * x.${n});
        result.${n} = 2.0 * k * sig * (1.0 - sig);
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"k",label:"Steepness (k)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Higher = steeper transition. Maps infinite space to [-1,1] with logistic curve."}]}},Tt=class extends J{constructor(){super("rational","Rational (bell-shaped Jacobian)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float a = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = x.${n} / sqrt(x.${n} * x.${n} + a);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float a = u_transform_params.x;
    // Inverse: x = y * sqrt(a / (1 - y^2))
    // Note: y is bounded to [-1, 1] regardless of a
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${n}, -0.99999, 0.99999);
        float y_sq = y_clamped * y_clamped;
        result.${n} = y_clamped * sqrt(a / (1.0 - y_sq));
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float a = u_transform_params.x;
    // Jacobian: d/dx [x/sqrt(x^2+a)] = a/(x^2+a)^(3/2)
    // This is bell-shaped! Peaks at x=0, decays at infinity
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float x_sq = x.${n} * x.${n};
        float denom = x_sq + a;
        result.${n} = a / (denom * sqrt(denom));
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"a",label:"Width (a)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Controls bell curve width. Higher = wider/shallower, lower = narrower/sharper."}]}},St=class extends J{constructor(){super("sine","Sine wave distortion (periodic speed bumps)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;
    return x + amplitude * sin(frequency * x);
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;

    // Newton's method: x_{n+1} = x_n - (f(x_n) - y) / f'(x_n)
    // where f(x) = x + a*sin(f*x)
    // f'(x) = 1 + a*f*cos(f*x)
    ${t} x = y; // Initial guess
    for (int iter = 0; iter < 5; iter++) {
        ${t} fx = x + amplitude * sin(frequency * x);
        ${t} dfx = ${t}(1.0) + amplitude * frequency * cos(frequency * x);
        x = x - (fx - y) / dfx;
    }
    return x;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;
    return ${t}(1.0) + amplitude * frequency * cos(frequency * x);
}`}getParameters(){return[{name:"amplitude",label:"Amplitude",type:"slider",min:1e-4,max:25,step:1e-4,default:.5,info:"Strength of distortion"},{name:"frequency",label:"Frequency",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Number of waves per unit length"}]}},Ft=class extends J{constructor(){super("radial_power","Radial power (compress/expand by distance)")}generateForward(e){let t=`vec${e}`;return e===2?`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    if (r < 1e-8) return x;
    float r_new = pow(r, alpha);
    return x * (r_new / r);
}`:`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    if (r < 1e-8) return x;
    float r_new = pow(r, alpha);
    return x * (r_new / r);
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    float inv_alpha = 1.0 / alpha;
    float r = length(y);
    if (r < 1e-8) return y;
    float r_new = pow(r, inv_alpha);
    return y * (r_new / r);
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    float jacobian_scalar = alpha * pow(r + 1e-8, alpha - 1.0);
    return ${t}(jacobian_scalar);
}`}getParameters(){return[{name:"alpha",label:"Radial Exponent (\u03B1)",type:"slider",min:.1,max:3,step:.1,default:.5,info:"\u03B1 < 1.0: zoom into origin; \u03B1 > 1.0: compress origin"}]}},At=class extends J{constructor(){super("log","Logarithmic (stretch near zero)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = sign(x.${n}) * log(abs(x.${n}) + 1.0);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = sign(y.${n}) * (exp(abs(y.${n})) - 1.0);`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    // Jacobian: d/dx [sign(x)*log(|x|+1)] = 1/(|x|+1)
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = 1.0 / (abs(x.${n}) + 1.0);`}).join(`
    `)}
    return result;
}`}getParameters(){return[]}},Rt=class extends J{constructor(){super("exp","Exponential (compress near zero)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = sign(x.${n}) * (exp(alpha * abs(x.${n})) - 1.0);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = sign(y.${n}) * log(abs(y.${n}) + 1.0) / alpha;`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    // Jacobian: d/dx [sign(x)*(exp(\u03B1|x|)-1)] = \u03B1*exp(\u03B1|x|)
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = alpha * exp(alpha * abs(x.${n}));`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"alpha",label:"Growth Rate (\u03B1)",type:"slider",min:.1,max:2,step:.1,default:.5,info:"Higher \u03B1 = stronger exponential growth. Use small values (0.1-0.5) to avoid overflow."}]}},Ct=class extends J{constructor(){super("softsign","Soft-sign (smooth compression to [-1,1])")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`result.${n} = x.${n} / (1.0 + abs(x.${n}));`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${n}, -0.99999, 0.99999);
        result.${n} = y_clamped / (1.0 - abs(y_clamped));
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    // Jacobian: d/dx [x/(1+|x|)] = 1/(1+|x|)^2
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let n=["x","y","z","w"][r]||`[${r}]`;return`{
        float denom = 1.0 + abs(x.${n});
        result.${n} = 1.0 / (denom * denom);
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[]}},Mt=class extends J{constructor(){super("custom","Custom (user-defined GLSL)"),this.forwardCode="",this.inverseCode="",this.jacobianCode=""}setCode(e,t,i){this.forwardCode=e,this.inverseCode=t,this.jacobianCode=i}generateForward(e){return this.forwardCode||new ce().generateForward(e)}generateInverse(e){return this.inverseCode||new ce().generateInverse(e)}generateJacobian(e){return this.jacobianCode||new ce().generateJacobian(e)}},Ei={identity:new ce,power:new Et,log:new At,exp:new Rt,softsign:new Ct,tanh:new $t,sigmoid:new wt,rational:new Tt,sine:new St,radial_power:new Ft,custom:new Mt};function qe(o){return Ei[o]||Ei.identity}function $i(o,e){let t=`vec${e}`,r={white:{name:"Solid White",code:`
// Simple solid white particles
vec3 getColor(${t} pos, ${t} velocity, ${t} field_velocity, ${t} velocity_proj) {
    return vec3(1.0, 1.0, 1.0);
}
`},velocity_magnitude:{name:"Velocity Magnitude",usesMaxVelocity:!0,usesGradient:!0},velocity_angle:{name:"Velocity Angle",usesGradient:!0},velocity_combined:{name:"Velocity Angle + Magnitude",usesMaxVelocity:!0,usesGradient:!0},field_magnitude:{name:"Field Magnitude",usesMaxVelocity:!0,usesGradient:!0},field_angle:{name:"Field Angle",usesGradient:!0},field_combined:{name:"Field Angle + Magnitude",usesMaxVelocity:!0,usesGradient:!0},expression:{name:"Expression",usesMaxVelocity:!1,requiresExpression:!0,code:null},custom:{name:"Custom (Advanced)",code:`
// Custom color function
// Inputs: pos (position vector), velocity (full N-D velocity), velocity_proj (projected 2D velocity)
// Output: RGB color vec3
vec3 getColor(${t} pos, ${t} velocity, ${t} field_velocity, ${t} velocity_proj) {
    return vec3(1.0, 1.0, 1.0);
}
`}}[o];if(!r)throw new Error(`Unknown color mode: ${o}`);return r}function wi(o,e,t){let i=`vec${o}`,r=[],n=["x","y","z","w","u","v"],s=["dx","dy","dz","dw","du","dv"];for(let a=0;a<o;a++)r.push(`float ${n[a]} = pos.${n[a]};`),r.push(`float ${s[a]} = velocity.${n[a]};`);return`
${t}

vec3 getColor(${i} pos, ${i} velocity, ${i} field_velocity, ${i} velocity_proj) {
    // Unpack position and FULL velocity components for user expression
    ${r.join(`
    `)}

    // Evaluate user expression
    float value = ${e};

    // Map through gradient
    return evaluateGradient(value);
}
`}function Ti(o,e,t){let i=`vec${e}`,r;switch(o){case"velocity_magnitude":r=`
    // Use full N-dimensional velocity magnitude
    float speed = length(velocity);
    float normalized;
    if (u_velocity_log_scale > 0.5) {
        // Logarithmic scaling: log(1 + speed) / log(1 + max_velocity)
        normalized = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        // Linear scaling
        normalized = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }
    return evaluateGradient(normalized);`;break;case"velocity_angle":r=`
    // Use projected 2D velocity angle
    float angle = atan(velocity_proj.y, velocity_proj.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    return evaluateGradient(hue);`;break;case"velocity_combined":r=`
    // Full velocity for magnitude, projected velocity for angle
    float speed = length(velocity);
    float angle = atan(velocity_proj.y, velocity_proj.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    float saturation;
    if (u_velocity_log_scale > 0.5) {
        // Logarithmic scaling: log(1 + speed) / log(1 + max_velocity)
        saturation = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        // Linear scaling
        saturation = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }

    // Get color from gradient based on angle
    vec3 fullColor = evaluateGradient(hue);

    // Desaturate based on speed (slow \u2192 grey, fast \u2192 full color)
    const vec3 grey = vec3(0.5, 0.5, 0.5);
    return mix(grey, fullColor, saturation);`;break;case"field_magnitude":r=`
    // Use field velocity magnitude
    float speed = length(field_velocity);
    float normalized;
    if (u_velocity_log_scale > 0.5) {
        normalized = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        normalized = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }
    return evaluateGradient(normalized);`;break;case"field_angle":r=`
    // Use field velocity angle in 2D
    vec2 field_2d = vec2(field_velocity.x, field_velocity.y);
    float angle = atan(field_2d.y, field_2d.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    return evaluateGradient(hue);`;break;case"field_combined":r=`
    // Field velocity for both magnitude and angle
    float speed = length(field_velocity);
    vec2 field_2d = vec2(field_velocity.x, field_velocity.y);
    float angle = atan(field_2d.y, field_2d.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    float saturation;
    if (u_velocity_log_scale > 0.5) {
        saturation = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        saturation = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }

    vec3 fullColor = evaluateGradient(hue);
    const vec3 grey = vec3(0.5, 0.5, 0.5);
    return mix(grey, fullColor, saturation);`;break;default:throw new Error(`Cannot create gradient version of color mode: ${o}`)}return`
${t}

vec3 getColor(${i} pos, ${i} velocity, ${i} field_velocity, ${i} velocity_proj) {
    ${r}
}
`}function Lt(o){let e=[...o].sort((i,r)=>i.position-r.position);if(e.length<2)throw new Error("Gradient must have at least 2 color stops");e.forEach(i=>{if(i.position<0||i.position>1)throw new Error(`Stop position must be in [0, 1], got ${i.position}`)});let t=`vec3 evaluateGradient(float t) {
    t = clamp(t, 0.0, 1.0);
`;for(let i=0;i<e.length-1;i++){let r=e[i],n=e[i+1],s=Si(r.color),a=Si(n.color),l=r.position.toFixed(6),u=n.position.toFixed(6);i===0?t+=`    if (t <= ${u}) {
`:i===e.length-2?t+=`    } else {
`:t+=`    } else if (t <= ${u}) {
`,t+=`        float segmentT = (t - ${l}) / (${u} - ${l});
`,t+=`        return mix(${s}, ${a}, segmentT);
`}return t+=`    }
`,t+=`}
`,t}function Si(o){return`vec3(${o[0].toFixed(6)}, ${o[1].toFixed(6)}, ${o[2].toFixed(6)})`}function Or(){return[{position:0,color:[1,0,0]},{position:.17,color:[1,1,0]},{position:.33,color:[0,1,0]},{position:.5,color:[0,1,1]},{position:.67,color:[0,0,1]},{position:.83,color:[1,0,1]},{position:1,color:[1,0,0]}]}function ue(){return Or()}function Fi(o){o=o.replace("#","");let e=parseInt(o.substring(0,2),16)/255,t=parseInt(o.substring(2,4),16)/255,i=parseInt(o.substring(4,6),16)/255;return[e,t,i]}function Pt(o){let e=Math.round(o[0]*255).toString(16).padStart(2,"0"),t=Math.round(o[1]*255).toString(16).padStart(2,"0"),i=Math.round(o[2]*255).toString(16).padStart(2,"0");return`#${e}${t}${i}`}function Gr(o){let e={linear:{name:"Linear (No Tone Mapping)",description:"Direct exposure and gamma, no compression. Values > 1 will clip.",usesWhitePoint:!1,defaultExposure:1},reinhard:{name:"Reinhard",description:"Simple, preserves hues. Formula: color / (1 + color)",usesWhitePoint:!1,defaultExposure:1},reinhard_extended:{name:"Reinhard Extended",description:"Reinhard with adjustable white point for highlight control",usesWhitePoint:!0,defaultExposure:1,defaultWhitePoint:2},filmic:{name:"Filmic (ACES Approximation)",description:"Film-like S-curve, industry standard look",usesWhitePoint:!1,defaultExposure:1},uncharted2:{name:"Uncharted 2",description:"Popular in games, punchy highlights and saturated colors",usesWhitePoint:!0,defaultExposure:2,defaultWhitePoint:11.2},aces:{name:"ACES (Academy Color)",description:"Academy standard, natural film-like response",usesWhitePoint:!1,defaultExposure:1},hable:{name:"Hable (Uncharted 2 Filmic)",description:"John Hable's filmic curve, excellent highlight rolloff",usesWhitePoint:!0,defaultExposure:2,defaultWhitePoint:11.2},luminance_reinhard:{name:"Luminance Reinhard (Hue Preserving)",description:"Tone maps brightness only, preserves color hue/saturation perfectly. Ideal for attractors.",usesWhitePoint:!1,defaultExposure:1},luminance_extended:{name:"Luminance Extended (Hue Preserving)",description:"Extended Reinhard on luminance only. Best for colorful attractor density visualization.",usesWhitePoint:!0,defaultExposure:1,defaultWhitePoint:5}};return e[o]||e.linear}function Ai(o,e={}){let t=Gr(o),i=e.exposure!==void 0?e.exposure:t.defaultExposure,r=e.gamma!==void 0?e.gamma:2.2,n=e.whitePoint!==void 0?e.whitePoint:t.defaultWhitePoint||1,s=e.luminanceGamma!==void 0?e.luminanceGamma:1,a=`
// Tone mapping operator: ${t.name}
// ${t.description}

`;switch(o){case"linear":a+=`
vec3 tonemap(vec3 color) {
    // Simple exposure, no compression
    return color * ${i.toFixed(6)};
}
`;break;case"reinhard":a+=`
vec3 tonemap(vec3 color) {
    // Reinhard tone mapping: color / (1 + color)
    color *= ${i.toFixed(6)};
    return color / (vec3(1.0) + color);
}
`;break;case"reinhard_extended":a+=`
vec3 tonemap(vec3 color) {
    // Reinhard with white point
    color *= ${i.toFixed(6)};
    float whitePoint = ${n.toFixed(6)};
    vec3 numerator = color * (vec3(1.0) + (color / (whitePoint * whitePoint)));
    return numerator / (vec3(1.0) + color);
}
`;break;case"filmic":case"aces":a+=`
// ACES approximation (simplified)
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // ACES fitted curve
    const float a = 2.51;
    const float b = 0.03;
    const float c = 2.43;
    const float d = 0.59;
    const float e = 0.14;

    return clamp((color * (a * color + b)) / (color * (c * color + d) + e), 0.0, 1.0);
}
`;break;case"uncharted2":case"hable":a+=`
// Uncharted 2 filmic tone mapping by John Hable
vec3 uncharted2Curve(vec3 x) {
    const float A = 0.15; // Shoulder strength
    const float B = 0.50; // Linear strength
    const float C = 0.10; // Linear angle
    const float D = 0.20; // Toe strength
    const float E = 0.02; // Toe numerator
    const float F = 0.30; // Toe denominator
    return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;
}

vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Apply curve
    vec3 curr = uncharted2Curve(color);

    // White point scaling
    float whitePoint = ${n.toFixed(6)};
    vec3 whiteScale = vec3(1.0) / uncharted2Curve(vec3(whitePoint));

    return curr * whiteScale;
}
`;break;case"luminance_reinhard":a+=`
// Luminance-based Reinhard (hue-preserving)
// Tone maps brightness only, keeps color ratios intact
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Apply Reinhard to luminance only
    float toneMappedLuma = luma / (1.0 + luma);

    // Scale color to match tone-mapped luminance
    // This preserves hue and saturation perfectly
    return color * (toneMappedLuma / luma);
}
`;break;case"luminance_extended":a+=`
// Luminance-based Extended Reinhard (hue-preserving)
// Best for attractor visualization with dense bright regions
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Extended Reinhard with white point on luminance only
    float whitePoint = ${n.toFixed(6)};
    float numerator = luma * (1.0 + (luma / (whitePoint * whitePoint)));
    float toneMappedLuma = numerator / (1.0 + luma);

    // Scale color to match tone-mapped luminance
    // This preserves hue and saturation perfectly
    return color * (toneMappedLuma / luma);
}
`;break;default:a+=`
vec3 tonemap(vec3 color) {
    return color * ${i.toFixed(6)};
}
`}return a+=`
vec3 applyGamma(vec3 color) {
    return pow(color, vec3(1.0 / ${r.toFixed(6)}));
}

vec3 applyLuminanceGamma(vec3 color) {
    // Luminance-preserving gamma: adjusts brightness only, preserves hue
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Apply gamma to luminance only
    float gammaCorrectedLuma = pow(luma, 1.0 / ${s.toFixed(6)});

    // Scale color to match gamma-corrected luminance
    // This preserves hue and saturation perfectly
    return color * (gammaCorrectedLuma / luma);
}
`,a}re();z();var de=class{constructor(e){this.gl=e}getTextureFormat(){throw new Error("getTextureFormat() must be implemented by subclass")}getArrayType(){throw new Error("getArrayType() must be implemented by subclass")}getComponentsPerValue(){throw new Error("getComponentsPerValue() must be implemented by subclass")}requiresExtension(){return!1}getExtensionName(){return null}encodeValue(e,t,i){throw new Error("encodeValue() must be implemented by subclass")}decodeValue(e,t,i){throw new Error("decodeValue() must be implemented by subclass")}normalizeWorld(e,t,i){throw new Error("normalizeWorld() must be implemented by subclass")}denormalizeWorld(e,t,i){throw new Error("denormalizeWorld() must be implemented by subclass")}getGLSLConstants(){throw new Error("getGLSLConstants() must be implemented by subclass")}getGLSLDecodeFunction(){throw new Error("getGLSLDecodeFunction() must be implemented by subclass")}getGLSLEncodeFunction(){throw new Error("getGLSLEncodeFunction() must be implemented by subclass")}getGLSLNormalizeFunction(){throw new Error("getGLSLNormalizeFunction() must be implemented by subclass")}getGLSLDenormalizeFunction(){throw new Error("getGLSLDenormalizeFunction() must be implemented by subclass")}getName(){throw new Error("getName() must be implemented by subclass")}};Vt();var Ce=class extends de{constructor(e){super(e)}getName(){return"RGBA Fixed-Point Encoding"}getTextureFormat(){let e=this.gl;return{internalFormat:e.RGBA,format:e.RGBA,type:e.UNSIGNED_BYTE}}getArrayType(){return Uint8Array}getComponentsPerValue(){return 4}requiresExtension(){return!1}getExtensionName(){return null}encodeValue(e,t,i){let r=(e-t)/(i-t),n=new Uint8Array(4);return It(r,n,0),n}decodeValue(e,t,i){let r=Dt(e[0],e[1],e[2],e[3]);return t+r*(i-t)}normalizeWorld(e,t,i){return(e-t)/(i-t)}denormalizeWorld(e,t,i){return t+e*(i-t)}getGLSLConstants(){return`
// Map to [0, 1] range for maximum precision at any zoom level
const float FIXED_POINT_SCALE = 4294967295.0; // 2^32 - 1
`}getGLSLDecodeFunction(){return`
// Decode RGBA bytes back to float in [0, 1] range
float decodeFloat(vec4 rgba) {
    // Reconstruct 32-bit integer from bytes (big-endian)
    vec4 bytes = rgba * 255.0;
    float intValue = bytes.r * 16777216.0 + bytes.g * 65536.0 + bytes.b * 256.0 + bytes.a;

    // Map from [0, 2^32-1] back to [0, 1]
    return intValue / FIXED_POINT_SCALE;
}
`}getGLSLEncodeFunction(){return`
// Encode float in [0, 1] range to RGBA bytes
vec4 encodeFloat(float v) {
    // Clamp to [0, 1]
    v = clamp(v, 0.0, 1.0);

    // Map to [0, 2^32-1]
    float normalized = v * FIXED_POINT_SCALE;

    // Split into 4 bytes (big-endian)
    float byte0 = floor(normalized / 16777216.0);  // 2^24
    normalized -= byte0 * 16777216.0;
    float byte1 = floor(normalized / 65536.0);      // 2^16
    normalized -= byte1 * 65536.0;
    float byte2 = floor(normalized / 256.0);        // 2^8
    normalized -= byte2 * 256.0;
    float byte3 = floor(normalized);

    return vec4(byte0, byte1, byte2, byte3) / 255.0;
}
`}getGLSLNormalizeFunction(){return`
// Helper to normalize world coordinate to [0, 1] relative to viewport
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return (worldValue - minVal) / (maxVal - minVal);
}
`}getGLSLDenormalizeFunction(){return`
// Helper to denormalize from [0, 1] back to world coordinates
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return minVal + normalized * (maxVal - minVal);
}
`}};z();var Je=class extends de{constructor(e){if(super(e),!e.getExtension("OES_texture_float"))throw new Error("OES_texture_float extension not supported");c.info("Float texture support detected",{extension:"OES_texture_float"})}getName(){return"Float Textures (Direct Storage)"}getTextureFormat(){let e=this.gl;return{internalFormat:e.RGBA,format:e.RGBA,type:e.FLOAT}}getArrayType(){return Float32Array}getComponentsPerValue(){return 4}requiresExtension(){return!0}getExtensionName(){return"OES_texture_float"}encodeValue(e,t,i){let r=new Float32Array(4);return r[0]=e,r[1]=0,r[2]=0,r[3]=1,r}decodeValue(e,t,i){return e[0]}normalizeWorld(e,t,i){return e}denormalizeWorld(e,t,i){return e}getGLSLConstants(){return`
// Float strategy: no constants needed
`}getGLSLDecodeFunction(){return`
// Decode float from RGBA - just read the red channel directly
float decodeFloat(vec4 rgba) {
    return rgba.r;
}
`}getGLSLEncodeFunction(){return`
// Encode float to RGBA - store in red channel
vec4 encodeFloat(float v) {
    return vec4(v, 0.0, 0.0, 1.0);
}
`}getGLSLNormalizeFunction(){return`
// Float strategy: no normalization needed, pass through directly
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return worldValue;
}
`}getGLSLDenormalizeFunction(){return`
// Float strategy: no denormalization needed, pass through directly
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return normalized;
}
`}};var Ke=class{constructor(e,t={}){if(this.canvas=e,this.gl=e.getContext("webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!0}),!this.gl)throw new Error("WebGL not supported");let i=this.gl;i.disable(i.DEPTH_TEST),i.disable(i.STENCIL_TEST),i.enable(i.BLEND);let r=t.storageStrategy||"rgba";try{r==="float"?(this.strategy=new Je(i),c.info("Using Float texture strategy")):(this.strategy=new Ce(i),c.info("Using RGBA encoded texture strategy"))}catch(b){c.warn(`Failed to initialize ${r} strategy: ${b.message}`),c.info("Falling back to RGBA strategy"),this.strategy=new Ce(i)}this.dimensions=2,this.expressions=["-y","x"],this.coordinateSystem=j(this.dimensions);try{let b=this.coordinateSystem.getVariableNames();this.velocityEvaluators=xt(this.expressions,b),c.verbose("Initial velocity evaluators created",{coordinateSystem:this.coordinateSystem.name,variables:b})}catch(b){c.warn("Failed to create initial velocity evaluators",b),this.velocityEvaluators=null}this.integratorType="rk4",this.integratorParams={iterations:3},this.integratorCostFactor=1,this.solutionMethod="fixed-point",this.transformType="identity",this.transformParams={},this.mapperType="select",this.mapperParams={dim1:0,dim2:1},this.colorMode="white",this.colorExpression="x * y",this.colorGradient=ue(),this.velocityScaleMode="percentile95",this.velocityLogScale=!1,this.useHDR=t.useHDR!==void 0?t.useHDR:!0,this.tonemapOperator=t.tonemapOperator||"aces",this.exposure=t.exposure!==void 0?t.exposure:1,this.gamma=t.gamma!==void 0?t.gamma:2.2,this.luminanceGamma=t.luminanceGamma!==void 0?t.luminanceGamma:1,this.highlightCompression=t.highlightCompression!==void 0?t.highlightCompression:0,this.compressionThreshold=t.compressionThreshold!==void 0?t.compressionThreshold:1,this.whitePoint=t.whitePoint!==void 0?t.whitePoint:2,this.particleIntensity=t.particleIntensity!==void 0?t.particleIntensity:1,this.particleSize=t.particleSize!==void 0?t.particleSize:1,this.particleRenderMode=t.particleRenderMode||"points",this.useDepthTest=t.useDepthTest!==void 0?t.useDepthTest:!1,this.colorSaturation=t.colorSaturation!==void 0?t.colorSaturation:1,this.brightnessDesaturation=t.brightnessDesaturation!==void 0?t.brightnessDesaturation:0,this.brightnessSaturation=t.brightnessSaturation!==void 0?t.brightnessSaturation:0,this.bloomEnabled=t.bloomEnabled!==void 0?t.bloomEnabled:!1,this.bloomIntensity=t.bloomIntensity!==void 0?t.bloomIntensity:.3,this.bloomRadius=t.bloomRadius!==void 0?t.bloomRadius:1,this.bloomAlpha=t.bloomAlpha!==void 0?t.bloomAlpha:1,this.currentBloomTexture=null,this.smaaEnabled=t.smaaEnabled!==void 0?t.smaaEnabled:!0,this.smaaIntensity=t.smaaIntensity!==void 0?t.smaaIntensity:.75,this.smaaThreshold=t.smaaThreshold!==void 0?t.smaaThreshold:.1,this.bilateralEnabled=t.bilateralEnabled!==void 0?t.bilateralEnabled:!1,this.bilateralSpatialSigma=t.bilateralSpatialSigma!==void 0?t.bilateralSpatialSigma:4,this.bilateralIntensitySigma=t.bilateralIntensitySigma!==void 0?t.bilateralIntensitySigma:.2;let n=t.supersampleFactor!==void 0?t.supersampleFactor:1;(typeof n!="number"||isNaN(n)||n<=0)&&(c.warn(`Invalid supersampleFactor: ${n}, using default 1.0`),n=1),this.supersampleFactor=Math.max(.5,Math.min(4,n)),c.info(`Initial render scale factor set to: ${this.supersampleFactor}`),this.timestep=.01,this.fadeOpacity=.99,this.dropProbability=.003,this.respawnMargin=.2,this.animationAlpha=0,this.lockShaderRecompilation=!1,this.enableDebugStats=!1,this.maxVelocity=5,this.prevMaxVelocity=5,this.velocityEMAAlpha=.1,this.velocitySampleInterval=10,this.velocitySampleIntervalMin=5,this.velocitySampleIntervalMax=60,this.framesSinceLastSample=0,this.lowVelocityThreshold=.02;let l=10*(e.width/e.height);this.bbox={min:[-l/2,-5],max:[l/2,5]},this.particleSystem=new Xe(1e4,this.dimensions,this.bbox,this.strategy),this.textureManager=new $e(i,this.dimensions,this.particleSystem.getResolution(),this.strategy),this.particleRenderMode==="lines"&&this.textureManager.setLineMode(!0),this.updateFramebuffer=i.createFramebuffer();let u=Math.max(1,e.width||800),d=Math.max(1,e.height||600);this.renderWidth=Math.max(1,Math.floor(u*this.supersampleFactor)),this.renderHeight=Math.max(1,Math.floor(d*this.supersampleFactor)),c.verbose("Render dimensions calculated",{canvasSize:`${u}x${d}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),c.info("Initializing HDR rendering system...",{requested:this.useHDR,canvasSize:`${e.width}x${e.height}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),this.framebufferManager=new we(i,this.renderWidth,this.renderHeight,{useHDR:this.useHDR,usePingPong:!0});let h=this.framebufferManager.getHDRSupport();c.info("HDR rendering system initialized",{hdrEnabled:h.enabled,hdrSupported:h.supported,textureFormat:h.format,extensions:{floatColorBuffer:h.hasFloatColorBuffer,halfFloatColorBuffer:h.hasHalfFloatColorBuffer,linearFiltering:h.hasLinearFiltering},exposure:this.exposure,gamma:this.gamma}),this.useHDR&&!h.supported&&c.warn("HDR rendering requested but not supported by device. Using LDR fallback."),h.enabled&&!h.hasLinearFiltering&&c.warn("Linear filtering not available for HDR textures. Bloom quality will be affected."),c.info("Initializing bloom system...",{enabled:this.bloomEnabled,intensity:this.bloomIntensity,threshold:this.whitePoint}),this.bloomManager=new Ve(i,this.renderWidth,this.renderHeight,{enabled:this.bloomEnabled&&h.enabled,intensity:this.bloomIntensity,threshold:this.whitePoint,radius:this.bloomRadius}),c.info("Bloom system initialized",{enabled:this.bloomManager.isEnabled(),bloomSize:this.bloomManager.isEnabled()?`${this.bloomManager.getBloomSize().width}x${this.bloomManager.getBloomSize().height}`:"N/A"}),this.smaaManager=new Oe(i,this.renderWidth,this.renderHeight,{enabled:this.smaaEnabled,intensity:this.smaaIntensity,threshold:this.smaaThreshold}),c.info("SMAA system initialized",{enabled:this.smaaManager.isEnabled(),intensity:this.smaaIntensity,threshold:this.smaaThreshold}),this.bilateralManager=new Ne(i,this.renderWidth,this.renderHeight,{enabled:this.bilateralEnabled,spatialSigma:this.bilateralSpatialSigma,intensitySigma:this.bilateralIntensitySigma}),c.info("Bilateral filter initialized",{enabled:this.bilateralManager.isEnabled(),spatialSigma:this.bilateralSpatialSigma,intensitySigma:this.bilateralIntensitySigma}),this.ldrFramebuffer=i.createFramebuffer(),this.ldrTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.ldrTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindFramebuffer(i.FRAMEBUFFER,this.ldrFramebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.ldrTexture,0);let p=i.checkFramebufferStatus(i.FRAMEBUFFER);p!==i.FRAMEBUFFER_COMPLETE&&c.error("LDR framebuffer incomplete",{status:p}),i.bindFramebuffer(i.FRAMEBUFFER,null),c.info("LDR framebuffer created for tone mapping output"),this.finalFramebuffer=i.createFramebuffer(),this.finalTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.finalTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindFramebuffer(i.FRAMEBUFFER,this.finalFramebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.finalTexture,0);let m=i.checkFramebufferStatus(i.FRAMEBUFFER);m!==i.FRAMEBUFFER_COMPLETE&&c.error("Final framebuffer incomplete",{status:m}),i.bindFramebuffer(i.FRAMEBUFFER,null),c.info("Final framebuffer created for supersampling output"),this.bufferStatsManager=new Ge(i),this.velocityStatsManager=new He(i),this.statsUpdateInterval=60,this.statsUpdateIntervalSlow=120,this.statsCoarseMode=!0,this.quadBuffer=this.createBuffer(new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])),this.smaaManager.setQuadBuffer(this.quadBuffer),this.bilateralManager.setQuadBuffer(this.quadBuffer),c.info("Compiling shaders...",{dimensions:this.dimensions,integrator:this.integratorType});let f=this.compileShaders();if(f)throw c.error("Shader compilation failed",f),new Error(`Shader compilation failed: ${f}`);c.info("Shaders compiled successfully"),c.info("Initializing particle textures...",{resolution:this.particleSystem.getResolution(),particleCount:this.particleSystem.getActualParticleCount()}),this.textureManager.initializeData(this.particleSystem.getAllData()),this.indexBufferPoints=this.createBuffer(this.particleSystem.getIndices()),this.indexBufferLines=this.createLineIndexBuffer(this.particleSystem.getActualParticleCount()),this.vertexIdBufferLines=this.createLineVertexIdBuffer(this.particleSystem.getActualParticleCount()),this.isRunning=!1,this.frame=0,this.hdrLogged=!1}createBuffer(e){let t=this.gl,i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i}createLineIndexBuffer(e){let t=this.gl,i=new Float32Array(e*2);for(let n=0;n<e;n++)i[n*2]=n,i[n*2+1]=n;let r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),r}createLineVertexIdBuffer(e){let t=this.gl,i=new Float32Array(e*2);for(let n=0;n<e*2;n++)i[n]=n%2;let r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),r}compileShaders(){let e=this.gl;try{let t=this.coordinateSystem.getVariableNames(),i=this.coordinateSystem.name.includes("Cartesian"),r=i?"pos":"pos_native",n=ri(this.expressions,t,r);c.verbose("Generated velocity GLSL",{expressions:this.expressions,coordinateSystem:this.coordinateSystem.name,variables:t,posVarName:r,glsl:n});let s=null;if(!i){let S=["x","y","z","w","u","v"].slice(0,this.dimensions),M=this.coordinateSystem.getVariableNames();s={name:this.coordinateSystem.name,nativeVars:M,forwardTransform:this.coordinateSystem.generateForwardTransformGLSL(S,(B,v)=>K(B,v.length,v)),inverseTransform:this.coordinateSystem.generateInverseTransformGLSL(M,(B,v)=>K(B,v.length,v))},c.verbose("Generated coordinate system code",{name:s.name,forward:s.forwardTransform,inverse:s.inverseTransform})}let a={...this.integratorParams,expressions:this.expressions,solutionMethod:this.solutionMethod},l=vi(this.integratorType,this.dimensions,a);this.integratorCostFactor=l.costFactor||1;let u=_i(this.mapperType,this.dimensions,this.mapperParams),d=null;if(this.transformType!=="identity"){let S=qe(this.transformType);d={helpers:S.generateHelpers(this.dimensions),forward:S.generateForward(this.dimensions),inverse:S.generateInverse(this.dimensions),jacobian:S.generateJacobian(this.dimensions)}}let h=$i(this.colorMode,this.dimensions),p=h.code,m=h.usesMaxVelocity||!1;if(this.colorMode==="expression"){let S=K(this.colorExpression,this.dimensions),M=Lt(this.colorGradient);p=wi(this.dimensions,S,M)}else if(h.usesGradient){let S=Lt(this.colorGradient);p=Ti(this.colorMode,this.dimensions,S)}let f=ai(),b=li(this.dimensions,n,l.code,this.strategy,d,s);this.updateProgram=G(e,f,b);let x=this.particleRenderMode==="lines",g=ci(this.dimensions,u.code,n,this.strategy,x,s),y=ui(this.dimensions,p,m);this.drawProgram=G(e,g,y),this.usesMaxVelocity=m,this.shaderSource={updateVertex:f,updateFragment:b,drawVertex:g,drawFragment:y,velocityField:n},this.dumpShadersOnCompile&&(console.log(`
========== SHADER DUMP ==========`),console.log(`Config: ${this.dimensions}D, ${this.integratorType}, ${this.mapperType}, ${this.colorMode}`),console.log(`
--- UPDATE VERTEX SHADER ---`),console.log(f),console.log(`
--- UPDATE FRAGMENT SHADER ---`),console.log(b),console.log(`
--- DRAW VERTEX SHADER ---`),console.log(g),console.log(`
--- DRAW FRAGMENT SHADER ---`),console.log(y),console.log(`
=================================
`),this.dumpShadersOnCompile=!1),this.velocityStatsManager&&(this.velocityStatsManager.dispose(),this.velocityStatsManager.initialize(this.dimensions,n,s)?c.verbose("Velocity stats manager initialized"):c.warn("Failed to initialize velocity stats manager"));let _=di(),E=hi(),R=Ai(this.tonemapOperator,{exposure:this.exposure,gamma:this.gamma,luminanceGamma:this.luminanceGamma,whitePoint:this.whitePoint}),w=mi(R);if(this.screenFadeProgram=G(e,_,E),this.tonemapProgram=G(e,_,w),this.bloomManager.isEnabled()){let S=pi(),M=yt(!0,this.bloomRadius),B=yt(!1,this.bloomRadius),v=fi();this.bloomBrightPassProgram=G(e,_,S),this.bloomBlurHProgram=G(e,_,M),this.bloomBlurVProgram=G(e,_,B),this.bloomCombineProgram=G(e,_,v),c.verbose("Bloom shaders compiled",{threshold:this.whitePoint,intensity:this.bloomIntensity,radius:this.bloomRadius})}return this.shaderSource.screenFade=E,this.shaderSource.tonemap=w,c.verbose("Tone mapping operator compiled",{operator:this.tonemapOperator,exposure:this.exposure,gamma:this.gamma,whitePoint:this.whitePoint}),this.shadersJustRecompiled=!0,null}catch(t){return t.message}}updatePositions(){let e=this.gl,t=this.updateProgram;this.enableDebugStats&&this.frame%60===0&&this.sampleParticleData(),this.frame%600===0&&c.verbose(`Frame ${this.frame}: Shader uniforms`,{u_min:[this.bbox.min[0],this.bbox.min[1]],u_max:[this.bbox.max[0],this.bbox.max[1]],u_h:this.timestep*(this.integratorCostFactor||1),timestep_base:this.timestep,costFactor:this.integratorCostFactor||1,u_drop_rate:this.dropProbability}),e.useProgram(t);let i=e.getAttribLocation(t,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.textureManager.bindReadTextures(t);let r=this.particleSystem.getResolution(),n=Math.random();e.uniform2f(e.getUniformLocation(t,"u_min"),this.bbox.min[0],this.bbox.min[1]),e.uniform2f(e.getUniformLocation(t,"u_max"),this.bbox.max[0],this.bbox.max[1]),e.uniform1f(e.getUniformLocation(t,"u_h"),this.timestep*(this.integratorCostFactor||1)),e.uniform1f(e.getUniformLocation(t,"u_rand_seed"),n),e.uniform1f(e.getUniformLocation(t,"u_drop_rate"),this.dropProbability),e.uniform1f(e.getUniformLocation(t,"u_respawn_margin"),this.respawnMargin),e.uniform1f(e.getUniformLocation(t,"u_particles_res"),r);let s=this.getVelocityScale();e.uniform1f(e.getUniformLocation(t,"u_max_velocity"),s);let a=e.getUniformLocation(t,"u_alpha");if(a!==null&&e.uniform1f(a,this.animationAlpha),this.transformType!=="identity"){let l=this.transformParams||{},u=[l.alpha||l.beta||l.k||l.amplitude||.5,l.frequency||0,0,0];e.uniform4f(e.getUniformLocation(t,"u_transform_params"),u[0],u[1],u[2],u[3])}for(let l=0;l<this.dimensions;l++){e.uniform1i(e.getUniformLocation(t,"u_out_coordinate"),l);let u=this.textureManager.getWriteTexture(l);e.bindFramebuffer(e.FRAMEBUFFER,this.updateFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,u,0),e.viewport(0,0,r,r),e.drawArrays(e.TRIANGLES,0,6)}this.textureManager.swap(),this.frame++}drawParticles(){let e=this.gl,t=this.drawProgram;if(e.useProgram(t),e.blendFunc(e.SRC_ALPHA,e.ONE),this.framesSinceLastSample++,this.framesSinceLastSample>=this.velocitySampleInterval){if(this.framesSinceLastSample=0,this.velocityStatsManager&&this.velocityStatsManager.initialized){let u=this.textureManager.getReadTextures(),d=this.velocityStatsManager.compute(u,this.bbox,this.particleSystem.getResolution(),this.animationAlpha);if(this.frame%600===0&&d.sampleCount>0&&c.debug(`GPU velocity stats: avg=${d.avgVelocity.toFixed(3)}, max=${d.maxVelocity.toFixed(3)} (${d.sampleCount} samples)`),d.maxVelocity>0){let h=d.maxVelocity>this.maxVelocity?this.velocityEMAAlpha*2:this.velocityEMAAlpha;this.prevMaxVelocity=this.maxVelocity,this.maxVelocity=h*d.maxVelocity+(1-h)*this.maxVelocity}}else this.velocityStatsWarningLogged||(c.warn("Velocity stats manager not initialized - max velocity will not be computed"),this.velocityStatsWarningLogged=!0);let s=Math.abs(this.maxVelocity-this.prevMaxVelocity)/Math.max(this.maxVelocity,.1),a=.05,l=.01;if(s>a)this.velocitySampleInterval=this.velocitySampleIntervalMin;else if(s<l)this.velocitySampleInterval=this.velocitySampleIntervalMax;else{let u=(s-l)/(a-l);this.velocitySampleInterval=Math.round(this.velocitySampleIntervalMax*(1-u)+this.velocitySampleIntervalMin*u)}}this.maxVelocity=Math.max(this.maxVelocity,.5);let i=e.getAttribLocation(t,"a_index"),r=this.particleRenderMode==="lines"?this.indexBufferLines:this.indexBufferPoints;if(e.bindBuffer(e.ARRAY_BUFFER,r),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,1,e.FLOAT,!1,0,0),this.particleRenderMode==="lines"){let s=e.getAttribLocation(t,"a_vertex_id");s!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,this.vertexIdBufferLines),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,1,e.FLOAT,!1,0,0))}this.textureManager.bindReadTextures(t),this.textureManager.bindPrevTextures(t),e.uniform1f(e.getUniformLocation(t,"u_particles_res"),this.particleSystem.getResolution()),e.uniform2f(e.getUniformLocation(t,"u_min"),this.bbox.min[0],this.bbox.min[1]),e.uniform2f(e.getUniformLocation(t,"u_max"),this.bbox.max[0],this.bbox.max[1]),e.uniform1f(e.getUniformLocation(t,"u_particle_intensity"),this.particleIntensity),e.uniform1f(e.getUniformLocation(t,"u_particle_size"),this.particleSize),e.uniform2f(e.getUniformLocation(t,"u_viewport_size"),this.renderWidth,this.renderHeight),e.uniform2f(e.getUniformLocation(t,"u_canvas_size"),this.canvas.width,this.canvas.height),e.uniform1f(e.getUniformLocation(t,"u_color_saturation"),this.colorSaturation);let n=e.getUniformLocation(t,"u_alpha");if(n!==null&&e.uniform1f(n,this.animationAlpha),this.usesMaxVelocity){let s=this.getVelocityScale();e.uniform1f(e.getUniformLocation(t,"u_max_velocity"),s),e.uniform1f(e.getUniformLocation(t,"u_velocity_log_scale"),this.velocityLogScale?1:0)}this.particleRenderMode==="lines"?e.drawArrays(e.LINES,0,this.particleSystem.getActualParticleCount()*2):e.drawArrays(e.POINTS,0,this.particleSystem.getActualParticleCount())}getVelocityScale(){if(!this.velocityStatsManager||!this.velocityStatsManager.initialized)return this.maxVelocity;let e=this.velocityStatsManager.getCached();switch(this.velocityScaleMode){case"max":return e.maxVelocity||this.maxVelocity;case"average":return e.avgVelocity||this.maxVelocity;case"percentile90":return e.percentile90||e.avgVelocity||this.maxVelocity;case"percentile95":return e.percentile95||e.avgVelocity||this.maxVelocity;default:return this.maxVelocity}}fadeScreen(){let e=this.gl,t=this.framebufferManager.getCurrentTexture();this.framebufferManager.swap(),this.framebufferManager.bind(),e.viewport(0,0,this.renderWidth,this.renderHeight),e.disable(e.BLEND),e.useProgram(this.screenFadeProgram);let i=e.getAttribLocation(this.screenFadeProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),e.uniform1i(e.getUniformLocation(this.screenFadeProgram,"u_screen"),0),e.uniform1f(e.getUniformLocation(this.screenFadeProgram,"u_fade"),this.fadeOpacity),e.drawArrays(e.TRIANGLES,0,6),e.enable(e.BLEND)}applyBloom(){if(!this.bloomManager.isEnabled())return;let e=this.gl,t=this.bloomManager.getBloomSize();e.bindFramebuffer(e.FRAMEBUFFER,this.bloomManager.getBrightFBO()),e.viewport(0,0,t.width,t.height),e.disable(e.BLEND),e.useProgram(this.bloomBrightPassProgram);let i=e.getAttribLocation(this.bloomBrightPassProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.framebufferManager.getCurrentTexture()),e.uniform1i(e.getUniformLocation(this.bloomBrightPassProgram,"u_screen"),0),e.uniform1f(e.getUniformLocation(this.bloomBrightPassProgram,"u_threshold"),this.whitePoint),e.drawArrays(e.TRIANGLES,0,6);let r=this.bloomManager.getBlurFBOs(),n=this.bloomManager.getBlurTextures();e.bindFramebuffer(e.FRAMEBUFFER,r[0]),e.useProgram(this.bloomBlurHProgram);let s=e.getAttribLocation(this.bloomBlurHProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.bloomManager.getBrightTexture()),e.uniform1i(e.getUniformLocation(this.bloomBlurHProgram,"u_texture"),0),e.uniform2f(e.getUniformLocation(this.bloomBlurHProgram,"u_texel_size"),1/t.width,1/t.height),e.uniform1f(e.getUniformLocation(this.bloomBlurHProgram,"u_radius"),this.bloomRadius),e.drawArrays(e.TRIANGLES,0,6),e.bindFramebuffer(e.FRAMEBUFFER,r[1]),e.useProgram(this.bloomBlurVProgram);let a=e.getAttribLocation(this.bloomBlurVProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,n[0]),e.uniform1i(e.getUniformLocation(this.bloomBlurVProgram,"u_texture"),0),e.uniform2f(e.getUniformLocation(this.bloomBlurVProgram,"u_texel_size"),1/t.width,1/t.height),e.uniform1f(e.getUniformLocation(this.bloomBlurVProgram,"u_radius"),this.bloomRadius),e.drawArrays(e.TRIANGLES,0,6),this.currentBloomTexture=n[1]}downsampleToCanvas(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.canvas.width,this.canvas.height),e.useProgram(this.screenFadeProgram);let t=e.getAttribLocation(this.screenFadeProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.finalTexture),e.uniform1i(e.getUniformLocation(this.screenFadeProgram,"u_screen"),0),e.uniform1f(e.getUniformLocation(this.screenFadeProgram,"u_fade"),1),e.drawArrays(e.TRIANGLES,0,6)}render(e=!0){let t=this.gl;if(!this.hdrLogged){let a=this.framebufferManager.getHDRSupport();c.info("First frame render",{renderingMode:a.enabled?"HDR":"LDR",textureFormat:a.format,exposure:this.exposure,gamma:this.gamma}),this.hdrLogged=!0}this.updatePositions(),this.fadeScreen(),this.framebufferManager.bind(),this.useDepthTest&&(t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.clear(t.DEPTH_BUFFER_BIT)),this.drawParticles(),this.useDepthTest&&t.disable(t.DEPTH_TEST),this.applyBloom(),t.bindFramebuffer(t.FRAMEBUFFER,this.ldrFramebuffer),t.viewport(0,0,this.renderWidth,this.renderHeight),t.disable(t.BLEND),t.useProgram(this.tonemapProgram);let i=t.getAttribLocation(this.tonemapProgram,"a_pos");t.bindBuffer(t.ARRAY_BUFFER,this.quadBuffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.framebufferManager.getCurrentTexture()),t.uniform1i(t.getUniformLocation(this.tonemapProgram,"u_screen"),0),this.bloomManager.isEnabled()&&this.currentBloomTexture?(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.currentBloomTexture),t.uniform1i(t.getUniformLocation(this.tonemapProgram,"u_bloom"),1),t.uniform1i(t.getUniformLocation(this.tonemapProgram,"u_bloom_enabled"),1),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_bloom_intensity"),this.bloomIntensity),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_bloom_alpha"),this.bloomAlpha)):t.uniform1i(t.getUniformLocation(this.tonemapProgram,"u_bloom_enabled"),0);let r=this.bufferStatsManager.getCached();t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_exposure"),this.exposure),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_gamma"),this.gamma),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_whitePoint"),this.whitePoint),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_highlight_compression"),this.highlightCompression),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_compression_threshold"),this.compressionThreshold),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_brightness_desat"),this.brightnessDesaturation),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_brightness_sat"),this.brightnessSaturation),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_hdr_max_brightness"),r.maxBrightness),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_hdr_avg_brightness"),r.avgBrightness),t.drawArrays(t.TRIANGLES,0,6);let n=this.bilateralManager.apply(this.ldrTexture);this.smaaManager.applyToFramebuffer(n,this.finalFramebuffer,this.quadBuffer),e&&this.downsampleToCanvas(),this.frame||(this.frame=0),this.frame++;let s=this.isRunning?this.statsUpdateInterval:this.statsUpdateIntervalSlow;if(this.frame%s===0){let a=this.framebufferManager.getCurrentTexture(),l=this.bufferStatsManager.compute(a,this.renderWidth,this.renderHeight,!0);this.enableDebugStats&&this.frame%(s*10)===0&&c.info("HDR Buffer Stats (sampled)",{avgBrightness:l.avgBrightness.toFixed(2),maxBrightness:l.maxBrightness.toFixed(2),sampledPixels:l.sampledPixels,sampleRate:l.sampleRate})}}getBufferStats(){let e=this.bufferStatsManager.getCached(),t=this.velocityStatsManager?this.velocityStatsManager.getCached():null;return e.maxVelocity=this.maxVelocity,e.avgVelocity=t?t.avgVelocity:0,e.velocitySampleCount=t?t.sampleCount:0,e}logBufferStats(){let e=this.getBufferStats(),t=Date.now()-e.timestamp;c.info("=== HDR Buffer Statistics (Sampled) ==="),c.info(`Cached age: ${(t/1e3).toFixed(1)}s`),c.info(`Sample rate: every ${e.sampleRate}th pixel (${e.sampledPixels} total)`),c.info(`Red   - Min: ${e.red.min.toFixed(6)}, Max: ${e.red.max.toFixed(6)}, Avg: ${e.red.avg.toFixed(6)}`),c.info(`Green - Min: ${e.green.min.toFixed(6)}, Max: ${e.green.max.toFixed(6)}, Avg: ${e.green.avg.toFixed(6)}`),c.info(`Blue  - Min: ${e.blue.min.toFixed(6)}, Max: ${e.blue.max.toFixed(6)}, Avg: ${e.blue.avg.toFixed(6)}`),c.info(`Max Brightness: ${e.maxBrightness.toFixed(6)}`),c.info(`Avg Brightness: ${e.avgBrightness.toFixed(6)}`),c.info(`Max Velocity: ${e.maxVelocity.toFixed(6)} (GPU-sampled, ${e.velocitySampleCount} particles, EMA-smoothed)`),e.avgVelocity&&c.info(`Avg Velocity: ${e.avgVelocity.toFixed(6)}`)}calculateParticleStatistics_REMOVED(){let e=this.particleSystem.getResolution(),t=[];for(let l=0;l<this.dimensions;l++)t.push(this.textureManager.readTexture(l));let i=[],r=[],n=this.strategy.getComponentsPerValue(),s=this.strategy.getArrayType(),a=[];for(let l=0;l<this.particleSystem.getActualParticleCount();l++){let u=[];for(let d=0;d<this.dimensions;d++){let h=t[d],p=l*n,m=new s(n);for(let g=0;g<n;g++)m[g]=h[p+g];let f=d===0?this.bbox.min[0]:d===1?this.bbox.min[1]:-10,b=d===0?this.bbox.max[0]:d===1?this.bbox.max[1]:10,x=this.strategy.decodeValue(m,f,b);u.push(x)}a.push(u)}for(let l=0;l<this.dimensions;l++){let u=1/0,d=-1/0,h=0;for(let m of a)u=Math.min(u,m[l]),d=Math.max(d,m[l]),h+=m[l];let p=["x","y","z","w"][l]||`dim${l}`;i.push({dim:p,min:u.toFixed(3),max:d.toFixed(3),avg:(h/a.length).toFixed(3)})}if(this.velocityEvaluators)for(let l=0;l<this.dimensions;l++){let u=1/0,d=-1/0,h=0;try{for(let m of a){let f=this.velocityEvaluators[l](...m);u=Math.min(u,f),d=Math.max(d,f),h+=f}let p=["x","y","z","w"][l]||`dim${l}`;r.push({dim:`v${p}`,min:u.toFixed(3),max:d.toFixed(3),avg:(h/a.length).toFixed(3)})}catch(p){c.warn(`Error computing velocity for dim ${l}`,p)}}c.verbose(`Frame ${this.frame}: Particle statistics`,{bounds:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`,position:i,velocity:r.length>0?r:"N/A"})}sampleParticleVelocity(){let e=this.gl,t=[];for(let l=0;l<this.dimensions;l++)t.push(this.textureManager.readTexture(l));let i=this.strategy.getComponentsPerValue(),r=this.strategy.getArrayType(),s=Math.floor(Math.random()*this.particleSystem.getActualParticleCount())*i,a=[];for(let l=0;l<this.dimensions;l++){let u=t[l],d=new r(i);for(let f=0;f<i;f++)d[f]=u[s+f];let h=l===0?this.bbox.min[0]:l===1?this.bbox.min[1]:-10,p=l===0?this.bbox.max[0]:l===1?this.bbox.max[1]:10,m=this.strategy.decodeValue(d,h,p);a.push(m)}if(!this.velocityEvaluators||this.velocityEvaluators.length===0)return 0;try{let l=[];for(let h=0;h<this.dimensions;h++){let p=this.velocityEvaluators[h](...a);l.push(p)}let u=l.reduce((h,p)=>h+p*p,0),d=Math.sqrt(u);return isFinite(d)?d:(this.velocityNaNWarningLogged||(c.warn("Invalid velocity magnitude detected",{position:a,velocity:l,magnitude:d}),this.velocityNaNWarningLogged=!0),0)}catch(l){return this.velocityErrorLogged||(c.error("Error computing velocity",l),this.velocityErrorLogged=!0),0}}sampleParticleData(){let t=this.particleSystem.getResolution(),i=[],r=[];for(let a=0;a<this.dimensions;a++)r.push(this.textureManager.readTexture(a));let n=this.strategy.getComponentsPerValue(),s=this.strategy.getArrayType();for(let a=0;a<5;a++){let l=Math.floor(Math.random()*this.particleSystem.getActualParticleCount()),u=l*n,d=[];for(let m=0;m<this.dimensions;m++){let f=r[m],b=new s(n);for(let _=0;_<n;_++)b[_]=f[u+_];let x=m===0?this.bbox.min[0]:m===1?this.bbox.min[1]:-10,g=m===0?this.bbox.max[0]:m===1?this.bbox.max[1]:10,y=this.strategy.decodeValue(b,x,g);d.push(y.toFixed(3))}let h=r[0],p=n===4?h[u+3]:1;i.push({particle:l,position:d.join(", "),age:p.toFixed(2)})}c.verbose(`Frame ${this.frame}: Sampled 5 particles (with age)`,{bounds:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`,samples:i})}decodeFloatRGBA(e,t,i,r){return((e<<24|t<<16|i<<8|r)>>>0)/4294967295}start(){this.isRunning=!0,this.frameCount=0,this.totalFrames=0,this.lastFpsUpdate=performance.now(),this.fps=0,this.frameLimitEnabled===void 0&&(this.frameLimitEnabled=!1),this.frameLimit===void 0&&(this.frameLimit=1e3),c.verbose(`Starting render loop (frameLimitEnabled: ${this.frameLimitEnabled}, frameLimit: ${this.frameLimit})`);let e=()=>{if(!this.isRunning)return;this.frameCount++,this.totalFrames++;let t=performance.now(),i=t-this.lastFpsUpdate;if(i>=500&&(this.fps=Math.round(this.frameCount*1e3/i),this.frameCount=0,this.lastFpsUpdate=t),this.render(),this.frameLimitEnabled&&this.totalFrames>=this.frameLimit){let n=performance.now()-this.lastFpsUpdate;n>0&&(this.fps=Math.round(this.frameCount*1e3/n)),c.info(`Frame limit reached (${this.frameLimit} frames), stopping render loop`),this.stop();return}requestAnimationFrame(e)};e()}stop(){this.isRunning=!1}setAnimationAlpha(e){this.animationAlpha=Math.max(0,Math.min(1,e))}clearRenderBuffer(e=!1){this.framebufferManager.clearAll(0,0,0,1),this.totalFrames=0,!this.isRunning&&!e&&(c.info("Restarting render loop after render buffer clear"),this.start()),c.verbose("Render buffer cleared (particles preserved)")}resetParticles(e=!1){if(this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),c.verbose("Particles reinitialized to random positions"),e){c.info("Recompiling shaders after particle reset...");try{this.compileShaders(),c.info("Shaders recompiled successfully")}catch(t){c.error("Failed to recompile shaders:",t)}}}step(e=1){for(let t=0;t<e;t++)this.updatePositions()}clearScreen(){this.framebufferManager.clearAll(0,0,0,1),this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),this.totalFrames=0,this.isRunning||(c.info("Restarting render loop after screen clear"),this.start()),c.verbose("Screen cleared and particles reinitialized")}captureRenderBuffer(){return new Promise((e,t)=>{let i=this.gl;try{i.bindFramebuffer(i.FRAMEBUFFER,this.finalFramebuffer);let r=new Uint8Array(this.renderWidth*this.renderHeight*4);i.readPixels(0,0,this.renderWidth,this.renderHeight,i.RGBA,i.UNSIGNED_BYTE,r),i.bindFramebuffer(i.FRAMEBUFFER,null);let n=document.createElement("canvas");n.width=this.renderWidth,n.height=this.renderHeight;let s=n.getContext("2d"),a=s.createImageData(this.renderWidth,this.renderHeight);a.data.set(r),s.save(),s.scale(1,-1),s.translate(0,-this.renderHeight),s.putImageData(a,0,0),s.restore(),n.toBlob(l=>{l?e(l):t(new Error("Failed to create blob from canvas"))},"image/png")}catch(r){c.error("Failed to capture render buffer:",r),t(r)}})}resize(e,t){let i=this.gl;if(!e||!t||e<=0||t<=0){c.warn(`Invalid resize dimensions: ${e}x${t}, skipping resize`);return}this.canvas.width=e,this.canvas.height=t,this.renderWidth=Math.max(1,Math.floor(e*this.supersampleFactor)),this.renderHeight=Math.max(1,Math.floor(t*this.supersampleFactor)),c.info("Resizing renderer",{canvasSize:`${e}x${t}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),this.framebufferManager.resize(this.renderWidth,this.renderHeight),this.bloomManager.resize(this.renderWidth,this.renderHeight),this.bilateralManager.resize(this.renderWidth,this.renderHeight),this.smaaManager.resize(this.renderWidth,this.renderHeight),i.bindTexture(i.TEXTURE_2D,this.ldrTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindTexture(i.TEXTURE_2D,null),i.bindTexture(i.TEXTURE_2D,this.finalTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindTexture(i.TEXTURE_2D,null),this.gl.viewport(0,0,e,t),this.clearScreen()}updateConfig(e){c.info("Updating configuration",e);let t=!1;if(e.dimensions!==void 0&&e.dimensions!==this.dimensions&&(c.info(`Changing dimensions: ${this.dimensions} \u2192 ${e.dimensions}`),this.dimensions=e.dimensions,t=!0,this.coordinateSystem=j(this.dimensions),c.info(`Updated coordinate system to ${this.dimensions}D Cartesian`),this.particleSystem.setDimensions(this.dimensions),this.textureManager.dispose(),this.textureManager=new $e(this.gl,this.dimensions,this.particleSystem.getResolution(),this.strategy),this.particleRenderMode==="lines"&&this.textureManager.setLineMode(!0),this.textureManager.initializeData(this.particleSystem.getAllData())),e.coordinateSystem!==void 0&&(c.info(`Updating coordinate system: ${this.coordinateSystem.name} \u2192 ${e.coordinateSystem.name}`),this.coordinateSystem=e.coordinateSystem,t=!0,c.info("  needsRecompile flag set to true (coordinate system change)")),e.expressions!==void 0){c.info("Updating vector field expressions",e.expressions),this.expressions=e.expressions;try{let i;this.coordinateSystem&&typeof this.coordinateSystem.getVariableNames=="function"?i=this.coordinateSystem.getVariableNames():(c.warn("coordinateSystem missing getVariableNames(), using Cartesian fallback"),i=["x","y","z","w","u","v"].slice(0,this.dimensions)),this.velocityEvaluators=xt(e.expressions,i),c.verbose("Velocity evaluators created successfully",{coordinateSystem:this.coordinateSystem?this.coordinateSystem.name:"unknown",variables:i})}catch(i){c.warn("Failed to create velocity evaluators",i),this.velocityEvaluators=null}t=!0,c.info("  needsRecompile flag set to true (expressions change)")}if(e.integratorType!==void 0&&e.integratorType!==this.integratorType&&(c.info(`Changing integrator: ${this.integratorType} \u2192 ${e.integratorType}`),this.integratorType=e.integratorType,t=!0),e.integratorParams!==void 0&&(c.verbose("Updating integrator parameters",e.integratorParams),this.integratorParams={...this.integratorParams,...e.integratorParams},t=!0),e.solutionMethod!==void 0&&e.solutionMethod!==this.solutionMethod&&(c.info(`Changing solution method: ${this.solutionMethod} \u2192 ${e.solutionMethod}`),this.solutionMethod=e.solutionMethod,t=!0,c.info("  needsRecompile flag set to true (solutionMethod change)")),c.info("Solution method update complete, continuing..."),e.transformType!==void 0&&e.transformType!==this.transformType&&(c.info(`Changing transform: ${this.transformType} \u2192 ${e.transformType}`),this.transformType=e.transformType,t=!0),e.transformParams!==void 0&&(c.verbose("Updating transform parameters",e.transformParams),this.transformParams=e.transformParams,t=!0),e.mapperType!==void 0&&e.mapperType!==this.mapperType&&(c.info(`Changing mapper: ${this.mapperType} \u2192 ${e.mapperType}`),this.mapperType=e.mapperType,t=!0),e.mapperParams!==void 0&&(c.verbose("Updating mapper parameters",e.mapperParams),this.mapperParams=e.mapperParams,t=!0),e.colorMode!==void 0&&e.colorMode!==this.colorMode&&(c.info(`Changing color mode: ${this.colorMode} \u2192 ${e.colorMode}`),this.colorMode=e.colorMode,t=!0),e.colorExpression!==void 0&&e.colorExpression!==this.colorExpression&&(c.info(`Changing color expression: ${this.colorExpression} \u2192 ${e.colorExpression}`),this.colorExpression=e.colorExpression,t=!0),e.colorGradient!==void 0&&JSON.stringify(e.colorGradient)!==JSON.stringify(this.colorGradient)&&(c.info("Changing color gradient"),this.colorGradient=e.colorGradient,t=!0),e.velocityScaleMode!==void 0&&e.velocityScaleMode!==this.velocityScaleMode&&(c.info(`Changing velocity scale mode: ${this.velocityScaleMode} \u2192 ${e.velocityScaleMode}`),this.velocityScaleMode=e.velocityScaleMode),e.velocityLogScale!==void 0&&e.velocityLogScale!==this.velocityLogScale&&(c.info(`Changing velocity log scale: ${this.velocityLogScale} \u2192 ${e.velocityLogScale}`),this.velocityLogScale=e.velocityLogScale,t=!0),e.timestep!==void 0&&(c.verbose(`Timestep: ${this.timestep} \u2192 ${e.timestep}`),this.timestep=e.timestep),e.fadeOpacity!==void 0&&(c.verbose(`Fade opacity: ${this.fadeOpacity} \u2192 ${e.fadeOpacity}`),this.fadeOpacity=e.fadeOpacity),e.dropProbability!==void 0&&(c.verbose(`Drop probability: ${this.dropProbability} \u2192 ${e.dropProbability}`),this.dropProbability=e.dropProbability),e.respawnMargin!==void 0&&(c.verbose(`Respawn margin: ${this.respawnMargin} \u2192 ${e.respawnMargin}`),this.respawnMargin=e.respawnMargin),e.lockShaderRecompilation!==void 0&&(c.info(`Shader recompilation lock: ${this.lockShaderRecompilation} \u2192 ${e.lockShaderRecompilation}`),this.lockShaderRecompilation=e.lockShaderRecompilation),e.useHDR!==void 0&&e.useHDR!==this.useHDR){c.info(`Changing HDR rendering: ${this.useHDR} \u2192 ${e.useHDR}`),this.useHDR=e.useHDR,this.framebufferManager.dispose(),this.framebufferManager=new we(this.gl,this.canvas.width,this.canvas.height,{useHDR:this.useHDR,usePingPong:!0});let i=this.framebufferManager.getHDRSupport();c.info("HDR rendering system reconfigured",{hdrEnabled:i.enabled,hdrSupported:i.supported,textureFormat:i.format}),this.useHDR&&!i.supported&&c.warn("HDR requested but not supported. Falling back to LDR."),this.clearScreen()}if(e.exposure!==void 0&&(c.verbose(`Exposure: ${this.exposure} \u2192 ${e.exposure}`),this.exposure=e.exposure,t=!0),e.gamma!==void 0&&(c.verbose(`Gamma: ${this.gamma} \u2192 ${e.gamma}`),this.gamma=e.gamma,t=!0),e.luminanceGamma!==void 0&&(c.verbose(`Luminance Gamma: ${this.luminanceGamma} \u2192 ${e.luminanceGamma}`),this.luminanceGamma=e.luminanceGamma,t=!0),e.highlightCompression!==void 0&&(c.verbose(`Highlight Compression: ${this.highlightCompression} \u2192 ${e.highlightCompression}`),this.highlightCompression=e.highlightCompression),e.compressionThreshold!==void 0&&(c.verbose(`Compression Threshold: ${this.compressionThreshold} \u2192 ${e.compressionThreshold}`),this.compressionThreshold=e.compressionThreshold),e.whitePoint!==void 0&&(c.verbose(`White point: ${this.whitePoint} \u2192 ${e.whitePoint}`),this.whitePoint=e.whitePoint,t=!0,this.bloomManager.updateConfig({threshold:e.whitePoint})),e.tonemapOperator!==void 0&&e.tonemapOperator!==this.tonemapOperator&&(c.info(`Tone mapping operator: ${this.tonemapOperator} \u2192 ${e.tonemapOperator}`),this.tonemapOperator=e.tonemapOperator,t=!0),e.particleIntensity!==void 0&&(c.verbose(`Particle intensity: ${this.particleIntensity} \u2192 ${e.particleIntensity}`),this.particleIntensity=e.particleIntensity),e.particleSize!==void 0&&(c.verbose(`Particle size: ${this.particleSize} \u2192 ${e.particleSize}`),this.particleSize=e.particleSize),e.particleRenderMode!==void 0&&e.particleRenderMode!==this.particleRenderMode){c.info(`Particle render mode: ${this.particleRenderMode} \u2192 ${e.particleRenderMode}`),this.particleRenderMode=e.particleRenderMode;let i=this.particleRenderMode==="lines";this.textureManager.setLineMode(i),t=!0}if(e.colorSaturation!==void 0&&(c.verbose(`Color saturation: ${this.colorSaturation} \u2192 ${e.colorSaturation}`),this.colorSaturation=e.colorSaturation),e.brightnessDesaturation!==void 0&&(c.verbose(`Brightness desaturation: ${this.brightnessDesaturation} \u2192 ${e.brightnessDesaturation}`),this.brightnessDesaturation=e.brightnessDesaturation),e.brightnessSaturation!==void 0&&(c.verbose(`Brightness saturation: ${this.brightnessSaturation} \u2192 ${e.brightnessSaturation}`),this.brightnessSaturation=e.brightnessSaturation),e.useDepthTest!==void 0&&(c.verbose(`Depth testing: ${this.useDepthTest} \u2192 ${e.useDepthTest}`),this.useDepthTest=e.useDepthTest),e.bloomEnabled!==void 0&&(c.verbose(`Bloom enabled: ${this.bloomEnabled} \u2192 ${e.bloomEnabled}`),this.bloomEnabled=e.bloomEnabled,this.bloomManager.updateConfig({enabled:e.bloomEnabled})),e.bloomIntensity!==void 0&&(c.verbose(`Bloom intensity: ${this.bloomIntensity} \u2192 ${e.bloomIntensity}`),this.bloomIntensity=e.bloomIntensity,this.bloomManager.updateConfig({intensity:e.bloomIntensity})),e.bloomRadius!==void 0&&(c.verbose(`Bloom radius: ${this.bloomRadius} \u2192 ${e.bloomRadius}`),this.bloomRadius=e.bloomRadius,this.bloomManager.updateConfig({radius:e.bloomRadius}),t=!0),e.bloomAlpha!==void 0&&(c.verbose(`Bloom alpha: ${this.bloomAlpha} \u2192 ${e.bloomAlpha}`),this.bloomAlpha=e.bloomAlpha),e.smaaEnabled!==void 0&&(c.verbose(`SMAA enabled: ${this.smaaEnabled} \u2192 ${e.smaaEnabled}`),this.smaaEnabled=e.smaaEnabled,this.smaaManager.updateConfig({enabled:e.smaaEnabled})),e.smaaIntensity!==void 0&&(c.verbose(`SMAA intensity: ${this.smaaIntensity} \u2192 ${e.smaaIntensity}`),this.smaaIntensity=e.smaaIntensity,this.smaaManager.updateConfig({intensity:e.smaaIntensity})),e.smaaThreshold!==void 0&&(c.verbose(`SMAA threshold: ${this.smaaThreshold} \u2192 ${e.smaaThreshold}`),this.smaaThreshold=e.smaaThreshold,this.smaaManager.updateConfig({threshold:e.smaaThreshold})),e.bilateralEnabled!==void 0&&(c.verbose(`Bilateral filter enabled: ${this.bilateralEnabled} \u2192 ${e.bilateralEnabled}`),this.bilateralEnabled=e.bilateralEnabled,this.bilateralManager.updateConfig({enabled:e.bilateralEnabled})),e.bilateralSpatialSigma!==void 0&&(c.verbose(`Bilateral spatial sigma: ${this.bilateralSpatialSigma} \u2192 ${e.bilateralSpatialSigma}`),this.bilateralSpatialSigma=e.bilateralSpatialSigma,this.bilateralManager.updateConfig({spatialSigma:e.bilateralSpatialSigma})),e.bilateralIntensitySigma!==void 0&&(c.verbose(`Bilateral intensity sigma: ${this.bilateralIntensitySigma} \u2192 ${e.bilateralIntensitySigma}`),this.bilateralIntensitySigma=e.bilateralIntensitySigma,this.bilateralManager.updateConfig({intensitySigma:e.bilateralIntensitySigma})),e.supersampleFactor!==void 0&&e.supersampleFactor!==this.supersampleFactor){c.info(`Render scale factor: ${this.supersampleFactor} \u2192 ${e.supersampleFactor}`);let i=Math.max(.5,Math.min(4,e.supersampleFactor));i!==e.supersampleFactor&&c.warn(`Invalid render scale factor ${e.supersampleFactor}, clamping to ${i}`),this.supersampleFactor=i,c.info(`Applying render scale factor: ${this.supersampleFactor}`),this.resize(this.canvas.width,this.canvas.height)}if(e.particleCount!==void 0&&e.particleCount!==this.particleSystem.particleCount&&(this.particleSystem.setParticleCount(e.particleCount),this.textureManager.resize(this.particleSystem.getResolution()),this.textureManager.initializeData(this.particleSystem.getAllData()),this.gl.deleteBuffer(this.indexBufferPoints),this.gl.deleteBuffer(this.indexBufferLines),this.gl.deleteBuffer(this.vertexIdBufferLines),this.indexBufferPoints=this.createBuffer(this.particleSystem.getIndices()),this.indexBufferLines=this.createLineIndexBuffer(this.particleSystem.getActualParticleCount()),this.vertexIdBufferLines=this.createLineVertexIdBuffer(this.particleSystem.getActualParticleCount())),e.bbox!==void 0&&(this.bbox=e.bbox,this.particleSystem.setBBox(this.bbox),e.reinitializeParticles&&(this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),c.info("Particles reinitialized to new viewport bounds")),this.clearScreen()),c.info(`Checking needsRecompile flag: ${t}`),t)if(this.lockShaderRecompilation)c.info("Shader recompilation needed but LOCKED - skipping recompilation");else{c.info("Recompiling shaders...");try{let i=this.compileShaders();if(i){c.error("Recompilation failed",i),c.warn("Shader compilation failed - visualization will not render until error is resolved");return}this.frame=0,c.info("Clearing screen after recompilation..."),this.clearScreen(),c.info("Configuration updated successfully, shaders recompiled")}catch(i){c.error("EXCEPTION during shader recompilation:",i),c.error("Stack trace:",i.stack),c.warn("Shader compilation exception - visualization will not render until error is resolved")}}else c.info("Configuration updated (no recompile needed)");c.info("Current settings applied",{dimensions:this.dimensions,expressions:this.expressions,integrator:this.integratorType,mapper:this.mapperType,timestep:this.timestep,particleCount:this.particleSystem.particleCount,fadeOpacity:this.fadeOpacity,dropProbability:this.dropProbability,bbox:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`})}testEncodeDecodeSymmetry(){let{encodeFloatRGBA:e,decodeFloatRGBA:t}=(Vt(),_r(Ii)),i=[0,.1,.25,.5,.75,.9,1];for(let d=0;d<100;d++)i.push(Math.random());let r=0,n=0,s=[],a=[];c.info("Testing encode/decode symmetry...");for(let d of i){let h=new Uint8Array(4);e(d,h,0);let p=t(h[0],h[1],h[2],h[3]),m=Math.abs(d-p);s.push(m),n+=m,r=Math.max(r,m),m>1e-6&&a.push({original:d,encoded:`[${h[0]}, ${h[1]}, ${h[2]}, ${h[3]}]`,decoded:p,error:m})}n/=i.length,c.info("Encode/Decode symmetry test results:",{testCount:i.length,maxError:r.toExponential(3),avgError:n.toExponential(3),problematicCount:a.length,problematicSamples:a.slice(0,5)}),c.info("Testing world coordinate round-trip [-5, 5]...");let l=[-5,-4,-2.5,0,2.5,4,5],u=[];for(let d of l){let h=(d-this.bbox.min[0])/(this.bbox.max[0]-this.bbox.min[0]),p=new Uint8Array(4);e(h,p,0);let m=t(p[0],p[1],p[2],p[3]),f=this.bbox.min[0]+m*(this.bbox.max[0]-this.bbox.min[0]),b=Math.abs(d-f);u.push({world:d.toFixed(3),normalized:h.toFixed(6),decoded:f.toFixed(6),error:b.toExponential(3)})}return c.info("World coordinate round-trip results:",{tests:u}),{maxError:r,avgError:n,problematic:a.length}}logBufferStats(){let e=this.gl;if(!this.framebufferManager){c.warn("No framebuffer manager available");return}let t=this.framebufferManager.currentIndex;e.bindFramebuffer(e.FRAMEBUFFER,this.framebufferManager.framebuffers[t]);let i=this.canvas.width,r=this.canvas.height,n=i*r,s=this.framebufferManager.isHDR(),a=s?new Float32Array(n*4):new Uint8Array(n*4);e.readPixels(0,0,i,r,e.RGBA,s?e.FLOAT:e.UNSIGNED_BYTE,a);let l=1/0,u=1/0,d=1/0,h=-1/0,p=-1/0,m=-1/0,f=0,b=0,x=0,g=-1/0,y=0;for(let w=0;w<n;w++){let S=w*4,M=a[S],B=a[S+1],v=a[S+2];s||(M/=255,B/=255,v/=255),l=Math.min(l,M),u=Math.min(u,B),d=Math.min(d,v),h=Math.max(h,M),p=Math.max(p,B),m=Math.max(m,v),f+=M,b+=B,x+=v;let F=Math.max(M,B,v);g=Math.max(g,F),F>1&&y++}let _=f/n,E=b/n,R=x/n;c.info("=== HDR Buffer Statistics ==="),c.info(`Framebuffer: ${i}x${r} (${n.toLocaleString()} pixels)`),c.info(`Format: ${s?"HDR Float":"LDR RGBA8"}`),c.info(`Red   - Min: ${l.toFixed(6)}, Max: ${h.toFixed(6)}, Avg: ${_.toFixed(6)}`),c.info(`Green - Min: ${u.toFixed(6)}, Max: ${p.toFixed(6)}, Avg: ${E.toFixed(6)}`),c.info(`Blue  - Min: ${d.toFixed(6)}, Max: ${m.toFixed(6)}, Avg: ${R.toFixed(6)}`),c.info(`Max Brightness (max of R/G/B): ${g.toFixed(6)}`),c.info(`Pixels above 1.0: ${y.toLocaleString()} (${(y/n*100).toFixed(2)}%)`),e.bindFramebuffer(e.FRAMEBUFFER,null)}logShaders(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== UPDATE VERTEX SHADER ==="),console.log(this.shaderSource.updateVertex),console.log(`=== END SHADER ===
`),console.log("=== UPDATE FRAGMENT SHADER ==="),console.log(this.shaderSource.updateFragment),console.log(`=== END SHADER ===
`),console.log("=== DRAW VERTEX SHADER ==="),console.log(this.shaderSource.drawVertex),console.log(`=== END SHADER ===
`),console.log("=== DRAW FRAGMENT SHADER ==="),console.log(this.shaderSource.drawFragment),console.log("=== END SHADER ==="),c.info("Shaders logged to console")}logUpdateShader(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== UPDATE FRAGMENT SHADER (Integrator + Jacobian) ==="),console.log(this.shaderSource.updateFragment),console.log("=== END SHADER ==="),c.info("Update shader logged to browser console")}logDrawShader(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== DRAW VERTEX SHADER ==="),console.log(this.shaderSource.drawVertex),console.log("=== END VERTEX SHADER ==="),console.log(""),console.log("=== DRAW FRAGMENT SHADER (Color Mode) ==="),console.log(this.shaderSource.drawFragment),console.log("=== END FRAGMENT SHADER ==="),c.info("Draw shaders (vertex + fragment) logged to browser console")}logScreenShader(){if(!this.shaderSource||!this.shaderSource.screenFragment){console.warn("No screen shader source available");return}console.log("=== SCREEN FRAGMENT SHADER (Tone Mapping) ==="),console.log(this.shaderSource.screenFragment),console.log("=== END SHADER ==="),c.info("Screen shader logged to browser console")}logStatsShaders(){if(c.info("=== DIAGNOSTIC STATS SHADERS ==="),this.velocityStatsManager&&this.velocityStatsManager.getShaderSource){let e=this.velocityStatsManager.getShaderSource();e?(console.log("=== VELOCITY STATS FRAGMENT SHADER ==="),console.log(e),console.log("=== END SHADER ===")):console.warn("Velocity stats shader not available")}else console.warn("VelocityStatsManager not initialized or no getShaderSource method");if(this.bufferStatsManager&&this.bufferStatsManager.getShaderSource){let e=this.bufferStatsManager.getShaderSource();e?(console.log("=== BRIGHTNESS STATS FRAGMENT SHADER ==="),console.log(e),console.log("=== END SHADER ===")):console.warn("Buffer stats shader not available")}else console.warn("BufferStatsManager not initialized or no getShaderSource method");c.info("Stats shaders logged to browser console")}readPixelAt(e,t){let i=this.gl,r=Math.floor(e*(this.renderWidth/this.canvas.width)),n=Math.floor(t*(this.renderHeight/this.canvas.height)),s=this.renderHeight-n-1;if(r<0||r>=this.renderWidth||s<0||s>=this.renderHeight)return null;let a={hdr:null,ldr:null};if(this.useHDR&&this.framebufferManager){let l=this.framebufferManager.getCurrentTexture(),u=this.framebufferManager.framebuffers[this.framebufferManager.currentIndex];if(i.bindFramebuffer(i.FRAMEBUFFER,u),this.framebufferManager.hdrType===i.FLOAT){let d=new Float32Array(4);i.readPixels(r,s,1,1,i.RGBA,i.FLOAT,d),a.hdr=[d[0],d[1],d[2]]}else{let d=new Uint8Array(4);i.readPixels(r,s,1,1,i.RGBA,i.UNSIGNED_BYTE,d),a.hdr=[d[0]/255,d[1]/255,d[2]/255]}}if(this.ldrFramebuffer&&this.ldrTexture){i.bindFramebuffer(i.FRAMEBUFFER,this.ldrFramebuffer);let l=new Uint8Array(4);i.readPixels(r,s,1,1,i.RGBA,i.UNSIGNED_BYTE,l),a.ldr=[l[0]/255,l[1]/255,l[2]/255]}return i.bindFramebuffer(i.FRAMEBUFFER,null),a}};re();var Q=class{constructor(e,t,i={}){this.id=e,this.defaultValue=t,this.settingsKey=i.settingsKey||e,this.onChange=i.onChange||null,this.element=null}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}reset(){this.setValue(this.defaultValue)}attachListeners(e){throw new Error("attachListeners() must be implemented by subclass")}getMousePositionInElement(e,t){let r=$(t).offset();return{x:e.pageX-r.left,y:e.pageY-r.top}}handleButtonAction(e){return!1}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};var Ye=class extends Q{constructor(e,t,i={}){super(e,t,i),this.trim=i.trim!==void 0?i.trim:!0}getValue(){let t=$(`#${this.id}`).val();return this.trim&&(t=t.trim()),t}setValue(e){$(`#${this.id}`).val(e)}attachListeners(e){let t=$(`#${this.id}`);this.element=t,this.setValue(this.defaultValue),t.on("input",()=>{let i=this.getValue();this.onChange&&this.onChange(i),e&&e()})}};var Ze=class{constructor(e={}){this.controls=new Map,this.storageKey=e.storageKey||"settings",this.onApply=e.onApply||null,this.debounceTime=e.debounceTime||300,this.applyTimeout=null,this.renderer=e.renderer||null}register(e){return this.controls.set(e.id,e),e}registerAll(e){e.forEach(t=>this.register(t))}initializeControls(){let e=()=>this.debouncedApply();for(let t of this.controls.values())t.attachListeners(e)}attachAllListeners(){this.initializeControls()}applySettings(e){this.setSettings(e)}get(e){return this.controls.get(e)}getSettings(){let e={};for(let t of this.controls.values())t.saveToSettings(e);return e}setSettings(e){if(e.coordinateSystem&&e.dimensions)try{let t=e.coordinateSystem,i=k.fromJSON(t);if(i.dimensions===e.dimensions){this.renderer&&(this.renderer.coordinateSystem=i);let r=this.get("dimension-inputs");r&&r.setCoordinateSystem&&r.setCoordinateSystem(i,!1)}}catch(t){console.error("Failed to restore coordinate system from settings:",t)}for(let t of this.controls.values())t.restoreFromSettings(e);for(let t of this.controls.values())t.onChange&&e&&e[t.settingsKey]!==void 0&&t.onChange(t.getValue())}resetAll(){for(let e of this.controls.values())e.reset()}saveToStorage(){let e=this.getSettings();return localStorage.setItem(this.storageKey,JSON.stringify(e)),e}loadFromStorage(){try{let e=localStorage.getItem(this.storageKey);if(e){let t=JSON.parse(e);return this.setSettings(t),t}}catch(e){console.warn("Failed to load settings from localStorage:",e)}return null}clearStorage(){localStorage.removeItem(this.storageKey)}debouncedApply(){this.applyTimeout&&clearTimeout(this.applyTimeout),this.applyTimeout=setTimeout(()=>{if(this.onApply){let e=this.getSettings();this.onApply(e)}},this.debounceTime)}apply(){if(this.onApply){let e=this.getSettings();this.onApply(e)}}};function Jr(o=2,e=10){return t=>{let i=Math.abs(t);return i>=e||i<1/e&&i!==0?t.toExponential(o):t.toFixed(o+1)}}function Kr(o=2){return e=>e.toFixed(o)}function Yr(){return o=>o.toFixed(0)}function Di(o,e,t){return o>0&&e/o>1e3?"adaptive":"linear"}function Vi(o,e,t=!1){let i=Math.abs(o),r=i<e?e:Math.pow(10,Math.floor(Math.log10(i))-1);return r=Math.max(e,r),t&&(r*=10),r}function zi(o=!1){return o?10:1}function Ui(o,e=!1){return e?o*10:o}function ki(o){if(typeof o.displayFormat=="function")return o.displayFormat;let e=o.displayPrecision??2;switch(o.displayFormat){case"scientific":return Jr(e,o.scientificThreshold??10);case"integer":return Yr();case"decimal":default:return Kr(e)}}function ae(o,e=0){setTimeout(()=>{let t;if(typeof o=="string"?t=$(o):t=o,!t.length){console.warn("resizeAccordion: Element not found",o);return}let i=t.closest(".accordion-section");i.length&&!i.hasClass("collapsed")&&i.css("max-height",i[0].scrollHeight+"px")},e)}var zt=class extends Q{constructor(e,t,i,r={}){super(e,i,r),this.parameterDef=t,this.scale=t.scale||Di(t.min,t.max,t.step),this.formatter=ki(t),this.displayElement=null}calculateIncrement(e,t=!1){switch(this.scale){case"adaptive":return Vi(e,this.parameterDef.step,t);case"log":return zi(t);case"linear":default:return Ui(this.parameterDef.step,t)}}handleButtonAction(e){let t=$(`#${this.id}`);if(!t.length)return!1;let i=this.getValue(),r=this.parameterDef.min,n=this.parameterDef.max,s=i;if(e==="reset")s=this.defaultValue;else{let a=this.calculateIncrement(i,e.includes("large"));if(e.startsWith("increase"))s=Math.min(n,i+a);else if(e.startsWith("decrease"))s=Math.max(r,i-a);else return!1}return s!==i?(this.setValue(s),t.trigger("input"),!0):!1}render(){let e=`${this.id}-display`,t=this.defaultValue;return`
            <div class="control-group">
                <label>
                    ${this.parameterDef.label}:
                    <span class="range-value" id="${e}">
                        ${this.formatter(t)}
                    </span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease-large">--</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease">-</button>
                    <input type="range" id="${this.id}">
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase-large">++</button>
                </div>
                ${this.parameterDef.info?`<div class="info">${this.parameterDef.info}</div>`:""}
            </div>
        `}attachListeners(e){let t=$(`#${this.id}`);if(this.element=t,this.displayElement=$(`#${this.id}-display`),!t.length){console.error(`ParameterControl: Element #${this.id} not found in DOM`);return}t.attr("min",this.parameterDef.min),t.attr("max",this.parameterDef.max),t.attr("step",this.parameterDef.step),t.val(this.defaultValue),this.updateDisplay(this.defaultValue),t.on("input",()=>{let i=this.getValue();this.updateDisplay(i),this.onChange&&this.onChange(i),e&&e()})}updateDisplay(e){this.displayElement&&this.displayElement.length&&this.displayElement.text(this.formatter(e))}getValue(){return!this.element||!this.element.length?this.defaultValue:parseFloat(this.element.val())}setValue(e){this.element&&this.element.length&&(this.element.val(e),this.updateDisplay(e))}reset(){this.setValue(this.defaultValue)}},he=class extends zt{constructor(e,t,i,r={}){super(e,t,i,r),this.animationEnabled=!1;let n=t.max-t.min;this.animationMin=r.animationMin??t.min+n*.25,this.animationMax=r.animationMax??t.min+n*.75,this.currentAlpha=0,this.isAnimating=!1}setAnimationEnabled(e){this.animationEnabled=e,this.updateAnimationUI()}setAnimationBounds(e,t){this.animationMin=Math.min(e,t),this.animationMax=Math.max(e,t),this.updateBoundsDisplay()}updateFromAlpha(e){if(!this.animationEnabled)return;this.currentAlpha=e;let t=this.animationMin+e*(this.animationMax-this.animationMin);this.isAnimating=!0,this.setValue(t),this.updateCurrentIndicator(e),this.isAnimating=!1}updateCurrentIndicator(e){let t=$(`#${this.id}-current-indicator`);t.length&&t.css("left",`${e*100}%`)}updateBoundsDisplay(){let e=$(`#${this.id}-min-handle`),t=$(`#${this.id}-max-handle`),i=$(`#${this.id}-min-display`),r=$(`#${this.id}-max-display`),n=$(`#${this.id}-range`);if(e.length&&t.length){let s=this.parameterDef.min,a=this.parameterDef.max,l=(this.animationMin-s)/(a-s)*100,u=(this.animationMax-s)/(a-s)*100;e.css("left",`${l}%`),t.css("left",`${u}%`),n.css({left:`${l}%`,width:`${u-l}%`}),i.length&&i.text(this.formatter(this.animationMin)),r.length&&r.text(this.formatter(this.animationMax))}}updateAnimationUI(){let e=$(`#${this.id}-animation-bounds`),t=$(`#${this.id}-anim-btn`);this.animationEnabled?(e.slideDown(200),t.addClass("active"),t.attr("title","Disable animation (\u{1F3AC})"),this.updateBoundsDisplay(),setTimeout(()=>{this.updateAccordionHeight()},0),setTimeout(()=>{this.updateAccordionHeight()},250)):(e.slideUp(200),t.removeClass("active"),t.attr("title","Enable animation (\u{1F3AC})"),setTimeout(()=>{this.updateAccordionHeight()},250))}updateAccordionHeight(){ae("#transform-controls",0)}render(){let e=`${this.id}-display`,t=this.defaultValue;return`
            <div class="control-group">
                <label>
                    ${this.parameterDef.label}:
                    <span class="range-value" id="${e}">
                        ${this.formatter(t)}
                    </span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease-large">--</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease">-</button>
                    <input type="range" id="${this.id}">
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase-large">++</button>
                    <button class="slider-btn anim-btn" id="${this.id}-anim-btn" title="Enable animation (\u{1F3AC})">\u{1F3AC}</button>
                </div>
                ${this.parameterDef.info?`<div class="info">${this.parameterDef.info}</div>`:""}
            </div>
        `}attachListeners(e){super.attachListeners(e),setTimeout(()=>{let t=$(`#${this.id}`);if(!t.length)return;let i=$(`#${this.id}-anim-btn`);if(!i.length)return;i.on("click",s=>{s.stopPropagation(),this.setAnimationEnabled(!this.animationEnabled)});let r=`
                <div id="${this.id}-animation-bounds" class="animation-bounds-slider" style="display: none;">
                    <div class="bounds-labels">
                        <span>Min: <span id="${this.id}-min-display">${this.formatter(this.animationMin)}</span></span>
                        <span>Max: <span id="${this.id}-max-display">${this.formatter(this.animationMax)}</span></span>
                    </div>
                    <div class="multi-thumb-slider">
                        <div class="slider-track"></div>
                        <div id="${this.id}-range" class="slider-range"></div>
                        <div id="${this.id}-current-indicator" class="slider-current-indicator"></div>
                        <div id="${this.id}-min-handle" class="slider-thumb min-thumb" data-bound="min">
                            <span class="thumb-label">MIN</span>
                        </div>
                        <div id="${this.id}-max-handle" class="slider-thumb max-thumb" data-bound="max">
                            <span class="thumb-label">MAX</span>
                        </div>
                    </div>
                </div>
            `,n=t.closest(".control-group");n.length?(n.after(r),this.attachThumbDragHandlers()):console.warn(`AnimatableParameterControl: Could not find .control-group parent for #${this.id}`)},0)}attachThumbDragHandlers(){let e=$(`#${this.id}-min-handle`),t=$(`#${this.id}-max-handle`),i=e.parent();[{handle:e,bound:"min"},{handle:t,bound:"max"}].forEach(({handle:n,bound:s})=>{let a=!1,l=0,u=0;n.on("mousedown",d=>{a=!0,l=d.pageX,u=parseFloat(n.css("left"))||0,n.addClass("dragging"),e.css("z-index","10"),t.css("z-index","10"),n.css("z-index","11"),$("body").css("user-select","none"),d.preventDefault()}),$(document).on("mousemove",d=>{if(!a)return;let h=i.offset(),p=i.width(),f=(d.pageX-h.left)/p*100;f=Math.max(0,Math.min(100,f));let b=this.parameterDef.min,x=this.parameterDef.max,g=b+f/100*(x-b);s==="min"?g<=this.animationMax&&(this.animationMin=g):g>=this.animationMin&&(this.animationMax=g),this.updateBoundsDisplay()}),$(document).on("mouseup",()=>{a&&(a=!1,n.removeClass("dragging"),$("body").css("user-select",""))})})}saveToSettings(e){super.saveToSettings(e),this.animationEnabled&&(e.animations||(e.animations={}),e.animations[this.settingsKey]={enabled:!0,min:this.animationMin,max:this.animationMax})}restoreFromSettings(e){if(super.restoreFromSettings(e),e.animations&&e.animations[this.settingsKey]){let t=e.animations[this.settingsKey];this.animationEnabled=t.enabled||!1,this.animationMin=t.min,this.animationMax=t.max,this.updateAnimationUI()}}};z();var Qe=class extends Q{constructor(e,t={}){super("dimension-inputs",e,t),this.dimensionsControl=null,this.varNames=["x","y","z","w","u","v"],this.coordinateSystem=null}setDimensionsControl(e){this.dimensionsControl=e}setCoordinateSystem(e,t=!0){this.coordinateSystem=e,e&&e.getDisplayLabels?this.varNames=e.getDisplayLabels():this.varNames=["x","y","z","w","u","v"],t&&this.updateInputs()}getDimensions(){if(this.dimensionsControl)return this.dimensionsControl.getValue();let e=document.getElementById("dimensions");return e&&e.getValue?e.getValue():2}getValue(){let e=this.getDimensions(),t=[];for(let i=0;i<e;i++){let r=$(`#expr-${i}`).val(),n=r?r.trim():"0";n&&window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii&&(n=window.UnicodeAutocomplete.unicodeToAscii(n)),t.push(n||"0")}return t}setValue(e){Array.isArray(e)&&this.updateInputs(e.length,e)}updateInputs(e=null,t=null){e===null&&(e=this.getDimensions()),c.verbose("updateInputs called with dimensions:",e);let i=$("#dimension-inputs");if(c.verbose("Container found:",i.length),i.length===0){c.error("Could not find #dimension-inputs element");return}let r;if(t&&Array.isArray(t))r=t,c.verbose("Using provided newValues");else{let n=$("#expr-0");c.verbose("firstElement exists:",n.length>0);try{if(n.length>0){let s=[],a=0;for(;$(`#expr-${a}`).length>0;){let l=$(`#expr-${a}`).val();s.push(l?l.trim():"0"),a++}r=s,c.verbose("Got current values from existing inputs:",r)}else r=this.defaultValue,c.verbose("Using defaultValue")}catch(s){c.error("Error getting values:",s),r=this.defaultValue}}if(r.length<e){let n=[...r];for(let s=r.length;s<e;s++)n[s]="0";r=n,c.verbose("Padded values to match dimensions:",r)}c.verbose("Values to use:",r),i.empty(),c.verbose("Container emptied, now creating",e,"inputs");for(let n=0;n<e;n++){let s=["x","y","z","w","u","v"],a=this.varNames[n]||s[n]||`v${n}`,l=r[n]||"0",u=$('<div class="dimension-input"></div>');u.append(`<label>d${a}/dt =</label>`),u.append(`<input type="text" id="expr-${n}" value="${l}">`),i.append(u),c.verbose("Created input",n,"with value:",l)}c.verbose("All inputs created, container now has",i.children().length,"children"),this.attachInputListeners(),window.unicodeAutocomplete&&window.unicodeAutocomplete.attachToAll('[id^="expr-"]'),this.updateAccordionHeight()}updateAccordionHeight(){ae("#dimension-inputs",0)}attachInputListeners(){let e=this.onChangeCallback;$(document).off("input",'[id^="expr-"]'),$(document).on("input",'[id^="expr-"]',()=>{this.onChange&&this.onChange(this.getValue()),e&&e()})}attachListeners(e){this.onChangeCallback=e,this.updateInputs(),this.attachInputListeners()}reset(){this.setValue(this.defaultValue)}},et=class extends Q{constructor(e,t={}){super("mapper-params",e,t),this.dimensionsControl=null,this.mapperControl=null,this.varNames=["x","y","z","w","u","v"]}setRelatedControls(e,t){this.dimensionsControl=e,this.mapperControl=t}getContext(){let e=this.dimensionsControl?this.dimensionsControl.getValue():2,t=this.mapperControl?this.mapperControl.getValue():"select";return{dimensions:e,mapper:t}}getValue(){let{mapper:e}=this.getContext();if(e==="custom"){let r=$("#mapper-horizontal-expr"),n=$("#mapper-vertical-expr"),s=$("#mapper-depth-expr");return r.length&&n.length?{horizontalExpr:r.val()||"x",verticalExpr:n.val()||"y",depthExpr:s.val()||""}:this.currentParams||{horizontalExpr:"x",verticalExpr:"y",depthExpr:""}}let t=$("#mapper-dim1"),i=$("#mapper-dim2");if(t.length&&i.length){let r=parseInt(t.val()),n=parseInt(i.val());return isNaN(r)||isNaN(n)?(console.warn("Invalid mapper dimensions, using defaults"),this.defaultValue):{dim1:r,dim2:n}}return this.defaultValue}setValue(e){this.currentParams=e,this.updateControls()}updateControls(){let{dimensions:e,mapper:t}=this.getContext(),i=$("#mapper-controls");if(i.length!==0){if(i.empty(),t==="select"){let r=$('<div class="control-row"></div>'),n=$('<div class="control-group" style="flex: 1;"></div>');n.append("<label>Horizontal</label>");let s=$('<select id="mapper-dim1"></select>'),a=this.currentParams?this.currentParams.dim1:this.defaultValue.dim1;for(let h=0;h<e;h++){let p=h===a?"selected":"";s.append(`<option value="${h}" ${p}>${this.varNames[h]}</option>`)}n.append(s);let l=$('<div class="control-group" style="flex: 1;"></div>');l.append("<label>Vertical</label>");let u=$('<select id="mapper-dim2"></select>'),d=this.currentParams?this.currentParams.dim2:this.defaultValue.dim2;for(let h=0;h<e;h++){let p=h===d?"selected":"";u.append(`<option value="${h}" ${p}>${this.varNames[h]}</option>`)}l.append(u),r.append(n),r.append(l),i.append(r),this.attachSelectListeners()}else if(t==="project"){let r=$('<div class="info">Linear projection uses default 2D projection</div>');i.append(r)}else if(t==="custom"){let r=this.varNames.slice(0,e).join(", "),n=$('<div class="control-group"></div>');n.append("<label>Horizontal (X):</label>");let s=this.currentParams?.horizontalExpr||"x",a=$(`<input type="text" id="mapper-horizontal-expr" value="${s}" placeholder="e.g., sin(x) + sin(y)" style="font-family: monospace; width: 100%;" />`);n.append(a),i.append(n);let l=$('<div class="control-group"></div>');l.append("<label>Vertical (Y):</label>");let u=this.currentParams?.verticalExpr||"y",d=$(`<input type="text" id="mapper-vertical-expr" value="${u}" placeholder="e.g., -cos(x) - cos(y)" style="font-family: monospace; width: 100%;" />`);l.append(d),i.append(l);let h=$('<div class="control-group"></div>');h.append("<label>Depth (Z, optional):</label>");let p=this.currentParams?.depthExpr||"",m=$(`<input type="text" id="mapper-depth-expr" value="${p}" placeholder="optional, e.g., z" style="font-family: monospace; width: 100%;" />`);h.append(m),i.append(h);let f=$('<div class="info">Define math expressions using variables: '+r+". Functions: sin, cos, tan, exp, log, sqrt, abs, etc.</div>");i.append(f),this.attachCustomListener()}}}attachSelectListeners(){let e=this.onChangeCallback;$(document).off("change","#mapper-dim1, #mapper-dim2"),$("#mapper-dim1, #mapper-dim2").on("change",()=>{this.currentParams=this.getValue(),this.onChange&&this.onChange(this.currentParams),e&&e()})}attachCustomListener(){let e=this.onChangeCallback;$(document).off("input","#mapper-horizontal-expr, #mapper-vertical-expr, #mapper-depth-expr"),$("#mapper-horizontal-expr, #mapper-vertical-expr, #mapper-depth-expr").on("input",()=>{this.currentParams=this.getValue(),this.onChange&&this.onChange(this.currentParams),e&&e()})}attachListeners(e){this.onChangeCallback=e,this.currentParams=this.defaultValue,this.updateControls()}reset(){this.currentParams=this.defaultValue,this.updateControls()}},tt=class extends Q{constructor(e,t={}){super("color-gradient",e,t),this.gradientEditor=null}setGradientEditor(e){this.gradientEditor=e}getValue(){return this.gradientEditor&&this.gradientEditor.getGradient?this.gradientEditor.getGradient():this.currentGradient||this.defaultValue}setValue(e){this.currentGradient=e,this.gradientEditor&&this.gradientEditor.setGradient&&this.gradientEditor.setGradient(e)}attachListeners(e){this.onChangeCallback=e}notifyChange(e){this.currentGradient=e,this.onChange&&this.onChange(e),this.onChangeCallback&&this.onChangeCallback()}reset(){this.setValue(this.defaultValue)}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!==void 0&&this.setValue(e[this.settingsKey])}},it=class extends Q{constructor(e,t={}){super("transform-params",e,t),this.transformControl=null,this.currentParams=e||{},this.parameterControls=new Map}setTransformControl(e){this.transformControl=e}getTransformType(){return this.transformControl?this.transformControl.getValue():"identity"}getValue(){let e={};for(let[t,i]of this.parameterControls.entries()){let r=i.settingsKey;e[r]=i.getValue()}return e}setValue(e){this.currentParams=e||{},this.updateControls()}updateControls(){let e=this.getTransformType(),t=$("#transform-controls");if(t.length===0)return;t.empty(),this.parameterControls.clear();let i=qe(e);if(!i){c.warn(`Transform not found: ${e}`),this.updateAccordionHeight();return}let r=i.getParameters();if(r.length===0){this.updateAccordionHeight();return}r.forEach((n,s)=>{let a=`transform-param-${s}`,l=this.currentParams[n.name]??n.default,u=new he(a,n,l,{settingsKey:n.name,onChange:d=>{this.currentParams[n.name]=d,this.onChange&&this.onChange(this.currentParams)}});t.append(u.render()),u.attachListeners(this.onChangeCallback),this.parameterControls.set(a,u)}),this.updateAccordionHeight()}updateAccordionHeight(){ae("#transform-controls",0)}handleTransformParamButton(e,t){let i=this.parameterControls.get(e);return i?i.handleButtonAction(t):!1}attachListeners(e){this.onChangeCallback=e,this.updateControls()}reset(){this.currentParams=this.defaultValue,this.updateControls()}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!==void 0&&this.setValue(e[this.settingsKey])}};function Ni(o,e,t){let i=$(`#${o}`);if(!i.length)return console.error(`Gradient editor container #${o} not found`),null;let r=e.map(u=>({...u}));function n(){let u=[...r].sort((h,p)=>h.position-p.position),d='<div class="gradient-stops">';u.forEach((h,p)=>{let m=r.indexOf(h),f=Pt(h.color);d+=`
                <div class="gradient-stop" data-index="${m}">
                    <input type="color" class="color-picker" value="${f}" data-index="${m}">
                    <input type="number" class="stop-position" min="0" max="1" step="0.01" value="${h.position.toFixed(2)}" data-index="${m}">
                    ${r.length>2?`<button class="remove-stop" data-index="${m}">\xD7</button>`:""}
                </div>
            `}),d+="</div>",d+='<button id="add-stop" class="secondary" style="margin-top: 5px;">Add Color Stop</button>',d+='<div class="gradient-preview" id="gradient-preview"></div>',i.html(d),s(),a()}function s(){let u=$("#gradient-preview");if(!u.length)return;let h=[...r].sort((p,m)=>p.position-m.position).map(p=>`${Pt(p.color)} ${(p.position*100).toFixed(1)}%`).join(", ");u.css("background",`linear-gradient(to right, ${h})`)}function a(){$(".color-picker").off("change").on("change",function(){let u=parseInt($(this).data("index")),d=$(this).val();r[u].color=Fi(d),s(),t(r)}),$(".stop-position").off("change").on("change",function(){let u=parseInt($(this).data("index")),d=parseFloat($(this).val());d=Math.max(0,Math.min(1,d)),r[u].position=d,n(),t(r)}),$(".remove-stop").off("click").on("click",function(){let u=parseInt($(this).data("index"));r.length>2&&(r.splice(u,1),n(),t(r))}),$("#add-stop").off("click").on("click",function(){let u=[...r].sort((f,b)=>f.position-b.position),d=.5,h=0,p=.5;for(let f=0;f<u.length-1;f++){let b=u[f+1].position-u[f].position;b>h&&(h=b,p=(u[f].position+u[f+1].position)/2)}d=p;let m=l(r,d);r.push({position:d,color:m}),n(),t(r)})}function l(u,d){let h=[...u].sort((p,m)=>p.position-m.position);if(d<=h[0].position)return[...h[0].color];if(d>=h[h.length-1].position)return[...h[h.length-1].color];for(let p=0;p<h.length-1;p++)if(d>=h[p].position&&d<=h[p+1].position){let m=h[p].position,f=h[p+1].position,b=(d-m)/(f-m),x=h[p].color,g=h[p+1].color;return[x[0]+(g[0]-x[0])*b,x[1]+(g[1]-x[1])*b,x[2]+(g[2]-x[2])*b]}return[.5,.5,.5]}return n(),{getGradient:()=>r.map(u=>({...u})),setGradient:u=>{r=u.map(d=>({...d})),n()}}}re();z();function Oi(o,e,t,i){if(c.info("=== SYMBOLIC INVERSE SOLVING ==="),c.info("Forward transforms:",o),c.info("Cartesian vars:",t),c.info("Native vars:",i),!window.nerdamer)return c.error("Nerdamer not loaded - cannot solve inverse symbolically"),null;try{window.nerdamer.clear&&window.nerdamer.clear("all");let r=[];if(e===2&&Zr(o))return c.info("Detected 2D polar coordinates - using standard inverse"),[`${i[0]}*cos(${i[1]})`,`${i[0]}*sin(${i[1]})`];if(e===3&&Qr(o))return c.info("Detected 3D cylindrical coordinates - using standard inverse"),[`${i[0]}*cos(${i[1]})`,`${i[0]}*sin(${i[1]})`,i[2]];if(e===3&&en(o))return c.info("Detected 3D spherical coordinates - using standard inverse"),[`${i[0]}*sin(${i[1]})*cos(${i[2]})`,`${i[0]}*sin(${i[1]})*sin(${i[2]})`,`${i[0]}*cos(${i[1]})`];c.info("Attempting general symbolic solve...");for(let n=0;n<e;n++){let s=t[n],a=null;for(let l=0;l<e;l++){let u=i[l],d=o[l];try{let h=`${u} - (${d})`,p=window.nerdamer.solve(h,s);if(p){let m=p.toString();if(c.verbose(`Solved ${s} from equation ${l}:`,m),!t.some((b,x)=>x!==n&&m.includes(b))){a=m;break}}}catch(h){c.verbose(`Failed to solve ${s} from equation ${l}:`,h.message)}}if(!a)return c.warn(`Could not solve for ${s} - symbolic solving failed`),null;r.push(a)}return c.info("Successfully solved inverse transforms:",r),r}catch(r){return c.error("Symbolic inverse solving failed:",r.message),null}}function Zr(o){if(o.length!==2)return!1;let e=o[0],t=o[1],i=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2/.test(e),r=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(t);return i&&r}function Qr(o){if(o.length!==3)return!1;let e=o[0],t=o[1],i=o[2],r=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2/.test(e),n=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(t),s=i.trim()==="z";return r&&n&&s}function en(o){if(o.length!==3)return!1;let e=o[0],t=o[1],i=o[2],r=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2\s*\+\s*z\s*\^?\*?\*?\s*2/.test(e),n=/acos/.test(t),s=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(i);return r&&n&&s}function tn(o,e,t,i){let r=$(`#${o}`);if(!r.length)return console.error(`Coordinate editor container #${o} not found`),null;let n=t||j(e),s=e,a={render:l,update:h,getCurrentSystem:()=>n,setDimensions:p};function l(){let m=Bt(s),f='<div class="coordinate-editor-content">';f+='<div class="control-group">',f+='<label for="coord-preset">Preset</label>',f+='<select id="coord-preset">';let b="custom";for(let[g,y]of Object.entries(se))if(y.name===n.name&&y.dimensions===n.dimensions){b=g;break}f+='<option value="custom">Custom</option>',m.forEach(({key:g,system:y})=>{f+=`<option value="${g}" ${g===b?"selected":""}>${y.name}</option>`}),f+="</select>",f+="</div>",f+='<div class="coordinate-variables">',f+='<div style="font-weight: bold;">Coordinate Variables:</div>';for(let g=0;g<s;g++){let y=n.variables[g]||{label:"x",displayLabel:"x"},_=n.forwardTransforms[g]||"x",E=["x","y","z","w","u","v"][g];f+='<div class="coord-var-row">',f+=`<input type="text" class="coord-var-label" data-index="${g}" value="${y.displayLabel}" placeholder="${E}" title="Variable label (can use Greek letters like \u03B8)">`,f+="<span>=</span>",f+=`<input type="text" class="coord-var-transform coord-math-input" data-index="${g}" value="${_}" placeholder="${E}" title="Transformation expression in Cartesian coordinates">`,f+="</div>"}f+="</div>",f+='<div class="coordinate-inverse">',f+='<div style="font-weight: bold; margin-top: 15px;">Inverse Transform (Native \u2192 Cartesian):</div>';let x=n.useIterativeSolver||!1;for(let g=0;g<s;g++){let y=["x","y","z","w","u","v"][g],_=n.inverseTransforms&&n.inverseTransforms[g]?n.inverseTransforms[g]:"",E=n.variables.map(R=>R.label||R.displayLabel).join(", ");f+='<div class="coord-var-row">',f+=`<span style="min-width: 20px;">${y}</span>`,f+="<span>=</span>",f+=`<input type="text" class="coord-inverse-transform coord-math-input" data-index="${g}" value="${_}" placeholder="(e.g., r*cos(theta))" title="Inverse transformation from native coordinates" ${x?"disabled":""}>`,f+="</div>"}f+="</div>",f+='<div class="coordinate-tools" style="margin-top: 10px;">',f+='<button id="coord-solve-inverse" class="secondary" title="Attempt to solve inverse transforms automatically using symbolic math">\u26A1 Solve Inverse Symbolically</button>',f+='<div style="margin-top: 8px;">',f+='<label style="display: flex; align-items: center; font-size: 0.9em;">',f+=`<input type="checkbox" id="coord-use-iterative" ${x?"checked":""} style="margin-right: 5px;">`,f+=`<span title="Use GPU-based Newton's method to compute inverse. Slower but works for any transform.">Use iterative Newton solver (GLSL)</span>`,f+="</label>",f+="</div>",f+="</div>",f+='<div class="info-text" style="margin-top: 15px;">',f+="<strong>Forward Transform:</strong> Define each native coordinate in terms of Cartesian variables (x, y, z, w, ...). ",f+="<strong>Inverse Transform:</strong> Define each Cartesian coordinate in terms of native variables. ",f+='Use the "Solve" button to attempt automatic computation, or enable iterative solver for complex transforms. ',f+='Type "theta", "phi", etc. to insert Greek letters.',f+="</div>",f+='<div class="coordinate-editor-buttons">',f+='<button id="coord-apply" class="primary">Apply</button>',f+='<button id="coord-cancel" class="secondary">Cancel</button>',f+="</div>",f+="</div>",r.html(f),u(),window.unicodeAutocomplete&&($(".coord-math-input").each(function(){window.unicodeAutocomplete.attach(this)}),$(".coord-var-label").each(function(){window.unicodeAutocomplete.attach(this)}))}function u(){$("#coord-preset").off("change").on("change",function(){let m=$(this).val();if(m==="custom")return;let f=se[m];f&&(n=f,l())}),$(".coord-var-label").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();n.variables[m]||(n.variables[m]={label:"",displayLabel:""}),n.variables[m].displayLabel=f,n.variables[m].label=f,$("#coord-preset").val("custom")}),$(".coord-var-transform").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();n.forwardTransforms[m],n.forwardTransforms[m]=f,$("#coord-preset").val("custom")}),$(".coord-inverse-transform").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();n.inverseTransforms||(n.inverseTransforms=new Array(s).fill("")),n.inverseTransforms[m]=f,$("#coord-preset").val("custom")}),$("#coord-solve-inverse").off("click").on("click",function(){let m=$(this);m.prop("disabled",!0);let f=m.text();m.text("Solving...");try{let b=["x","y","z","w","u","v"].slice(0,s),x=n.variables.map(y=>y.label||y.displayLabel),g=Oi(n.forwardTransforms,s,b,x);g?(n.inverseTransforms=g,$(".coord-inverse-transform").each(function(){let y=parseInt($(this).data("index"));$(this).val(g[y])}),m.text("\u2713 Solved!"),setTimeout(()=>{m.text(f),m.prop("disabled",!1)},1500)):(alert(`Could not solve inverse transforms symbolically. You can:
1. Define the inverse transforms manually
2. Enable "Use iterative Newton solver" checkbox`),m.text(f),m.prop("disabled",!1)),$("#coord-preset").val("custom")}catch(b){console.error("Error solving inverse:",b),alert("Error solving inverse: "+b.message),m.text(f),m.prop("disabled",!1)}}),$("#coord-use-iterative").off("change").on("change",function(){let m=$(this).is(":checked");n.useIterativeSolver=m,$(".coord-inverse-transform").prop("disabled",m),m?$(".coord-inverse-transform").css("opacity","0.5"):$(".coord-inverse-transform").css("opacity","1.0"),$("#coord-preset").val("custom")}),$("#coord-apply").off("click").on("click",function(){let m=$(this);m.prop("disabled",!0);let f=m.text();m.text("Applying...");try{if(d()){let x=n.forwardTransforms.map(_=>window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(_):_),g=n.inverseTransforms?n.inverseTransforms.map(_=>window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(_):_):null,y=new k(n.name,n.dimensions,n.variables,x,g,n.useIterativeSolver||!1);setTimeout(()=>{i(y),m.prop("disabled",!1),m.text(f)},100)}else alert("Invalid coordinate system. Please check your expressions."),m.prop("disabled",!1),m.text(f)}catch(b){console.error("Error in apply handler:",b),m.prop("disabled",!1),m.text(f)}}),$("#coord-cancel").off("click").on("click",function(){i(null)})}function d(){for(let m=0;m<s;m++)if(!n.variables[m]||!n.variables[m].label||!n.forwardTransforms[m]||n.forwardTransforms[m].trim()==="")return!1;return!0}function h(m){n=m,l()}function p(m){m!==s&&(s=m,n=j(m),l())}return l(),a}function Gi(o,e,t){let i=$("#coordinate-editor-panel");i.length||($("body").append(`
            <div id="coordinate-editor-panel" class="floating-panel" style="display: none;">
                <button class="floating-panel-close" style="display: none;">&times;</button>
                <div class="floating-panel-header">
                    <h3>Coordinate System</h3>
                </div>
                <div id="coordinate-editor-container" class="floating-panel-content">
                </div>
            </div>
        `),i=$("#coordinate-editor-panel")),i.show();let r=tn("coordinate-editor-container",o,e,l=>{l===null||t(l),i.hide()});$(".floating-panel-close",i).off("click").on("click",function(){i.hide()});let n=!1,s=0,a=0;return $(".panel-header",i).off("mousedown").on("mousedown",function(l){n=!0,s=l.clientX-i.offset().left,a=l.clientY-i.offset().top,$(document).on("mousemove.panelDrag",function(u){n&&i.css({left:u.clientX-s,top:u.clientY-a})})}),$(document).on("mouseup.panelDrag",function(){n=!1,$(document).off("mousemove.panelDrag")}),r}re();z();var rt=class{constructor(e){this.manager=e,this.registrationPromises=[]}register(e,t){let i=customElements.whenDefined(e).then(()=>new Promise(r=>{requestAnimationFrame(()=>{let n=document.getElementById(t);if(n&&n._initialized){this.manager.register(n);let s=()=>this.manager.debouncedApply();n.attachListeners(s),r(n)}else console.warn(`Web Component ${e}#${t} not found or not initialized`),r(null)})}));return this.registrationPromises.push(i),i}whenAllReady(){return Promise.all(this.registrationPromises)}async restoreSettings(e){let t=await this.whenAllReady();for(let i of t)i&&e[i.settingsKey]!==void 0&&i.setValue(e[i.settingsKey])}async applyWhenReady(e=null){await this.whenAllReady(),e&&(this.manager.applySettings(e),await this.restoreSettings(e)),this.manager.apply()}};z();var nt=class{constructor(e,t){this.renderer=e,this.controlManager=t,this.isRunning=!1,this.animationFrameId=null,this.direction=1,this.alpha=0,this.stepsPerIncrement=10,this.stepCounter=0,this.options={clearParticles:!1,clearScreen:!1,smoothTiming:!1,lockShaders:!1},this.ALPHA_STEP_TIME_TARGET_PERCENTILE=95,this.ALPHA_STEP_TIME_DECAY=.002,this.ALPHA_STEP_TIME_UPWARD=this.ALPHA_STEP_TIME_TARGET_PERCENTILE/(100-this.ALPHA_STEP_TIME_TARGET_PERCENTILE)*this.ALPHA_STEP_TIME_DECAY,this.ALPHA_STEP_TIME_WARMUP_CYCLES=3,this.ALPHA_STEP_TIME_DISPLAY_INTERVAL=10,this.alphaStepTimeEMA=null,this.alphaStepStartTime=null,this.alphaStepWarmupCounter=0,this.alphaStepDisplayCounter=0,this.cachedAnimatableControls=null,this.cachedAnimatableParams=null,this.lastAppliedSettings=null,this.shaderLockWasEnabled=!1,this.savedLoggerVerbosity=null,this.frameCaptureMode=null,this.frameCaptureTotal=0,this.frameCaptureCount=0,this.frameCaptureAlphaIncrement=.01,this.capturedFrames=[],this.frameCaptureOnProgress=null,this.frameCaptureOnComplete=null,this._alphaChangedListeners=[]}setAlpha(e,t=!0){this.alpha=Math.max(0,Math.min(1,e)),this.renderer&&this.renderer.setAnimationAlpha(this.alpha),t&&(this._updateAnimatableControls(this.alpha),this._applyChangedSettings(),this.options.clearParticles&&this.renderer&&this.renderer.resetParticles(),this.options.clearScreen&&this.renderer&&this.renderer.clearRenderBuffer()),this._emitAlphaChanged(this.alpha)}getAlpha(){return this.alpha}setSpeed(e){this.stepsPerIncrement=Math.max(1,Math.round(e))}setOptions(e){Object.assign(this.options,e)}start(e={}){if(this.isRunning)return;let{captureFrames:t=!1,totalFrames:i=0,loops:r=1,halfLoops:n=!1,onProgress:s=null,onComplete:a=null}=e;if(t){this.frameCaptureMode="fixed",this.frameCaptureTotal=i,this.frameCaptureCount=0,this.capturedFrames=[],this.frameCaptureOnProgress=s,this.frameCaptureOnComplete=a;let l=n?1:2;this.frameCaptureAlphaIncrement=r*l/i}else this.frameCaptureMode="continuous",this.frameCaptureAlphaIncrement=.01;this.isRunning=!0,this.renderer&&this.renderer.stop(),this._resetTimingState(),this.options.lockShaders&&this.renderer?(this.renderer.lockShaderRecompilation=!0,this.shaderLockWasEnabled=!0,c.info("Shader recompilation lock ENABLED (animation started)",null,!1)):this.shaderLockWasEnabled=!1,this.savedLoggerVerbosity=c.verbosity,c.setVerbosity("silent"),this._cacheAnimatableControls(),this._renderLoop()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.renderer&&!this.renderer.isRunning&&this.renderer.start();let e=document.getElementById("step-time-counter");e&&(e.style.display="none"),this.cachedAnimatableControls=null,this.cachedAnimatableParams=null,this.lastAppliedSettings=null,this.savedLoggerVerbosity!==null&&(c.setVerbosity(this.savedLoggerVerbosity),this.savedLoggerVerbosity=null),this.shaderLockWasEnabled&&this.renderer&&(this.renderer.lockShaderRecompilation=!1,this.shaderLockWasEnabled=!1,c.info("Shader recompilation lock DISABLED (animation stopped)")),this.frameCaptureMode=null}getFrames(){return this.capturedFrames}onAlphaChanged(e){this._alphaChangedListeners.push(e)}offAlphaChanged(e){let t=this._alphaChangedListeners.indexOf(e);t!==-1&&this._alphaChangedListeners.splice(t,1)}_resetTimingState(){this.stepCounter=0,this.alphaStepTimeEMA=null,this.alphaStepStartTime=null,this.alphaStepWarmupCounter=0,this.alphaStepDisplayCounter=0,this.lastAppliedSettings=null}_cacheAnimatableControls(){this.cachedAnimatableControls=[],this.controlManager.controls.forEach(t=>{t&&typeof t.animationEnabled<"u"&&t.updateFromAlpha&&this.cachedAnimatableControls.push(t)}),this.cachedAnimatableParams=[];let e=this.controlManager.controls.get("transform-params");e&&e.parameterControls&&e.parameterControls.forEach(t=>{t instanceof he&&this.cachedAnimatableParams.push(t)})}_updateAnimatableControls(e){this.cachedAnimatableControls||this._cacheAnimatableControls();for(let t=0;t<this.cachedAnimatableControls.length;t++){let i=this.cachedAnimatableControls[t];i.animationEnabled&&i.updateFromAlpha(e)}for(let t=0;t<this.cachedAnimatableParams.length;t++){let i=this.cachedAnimatableParams[t];i.animationEnabled&&i.updateFromAlpha(e)}}_applyChangedSettings(){if(!this.renderer||!this.cachedAnimatableControls)return;let e={};for(let t=0;t<this.cachedAnimatableControls.length;t++){let i=this.cachedAnimatableControls[t],r=i.getValue();(this.lastAppliedSettings===null||r!==this.lastAppliedSettings[i.settingsKey])&&(e[i.settingsKey]=r)}for(let t=0;t<this.cachedAnimatableParams.length;t++){let i=this.cachedAnimatableParams[t],r=i.getValue(),n=i.parameterName;e.transformParams||(e.transformParams=this.lastAppliedSettings?.transformParams?{...this.lastAppliedSettings.transformParams}:{}),(this.lastAppliedSettings===null||r!==this.lastAppliedSettings.transformParams?.[n])&&(e.transformParams[n]=r)}if(Object.keys(e).length>0)try{this.renderer.updateConfig(e),this.lastAppliedSettings===null&&(this.lastAppliedSettings={}),Object.assign(this.lastAppliedSettings,e)}catch(t){c.error("Failed to apply animation settings:",t)}else this.lastAppliedSettings===null&&(this.lastAppliedSettings={})}_renderLoop(){if(this.isRunning){if(this.stepCounter++,this.stepCounter===1&&(this.renderer&&this.renderer.shadersJustRecompiled&&(this.renderer.shadersJustRecompiled=!1),this.alphaStepStartTime=performance.now()),this.stepCounter>=this.stepsPerIncrement){this.stepCounter=0,this.options.clearScreen&&this.renderer&&this.renderer.render(!0);let t=performance.now()-this.alphaStepStartTime;if(this._updateTimingEMA(t),this.alpha+=this.direction*this.frameCaptureAlphaIncrement,this.alpha>=1?(this.alpha=1,this.direction=-1):this.alpha<=0&&(this.alpha=0,this.direction=1),this._updateAnimatableControls(this.alpha),this.renderer&&this.renderer.setAnimationAlpha(this.alpha),this._applyChangedSettings(),this._emitAlphaChanged(this.alpha),this.options.clearParticles&&this.renderer&&this.renderer.resetParticles(),this.renderer&&(this.options.clearScreen||this.renderer.render(!0),this.options.clearScreen&&this.renderer.clearRenderBuffer(!0)),this.frameCaptureMode==="fixed"&&this._captureFrame(),this.options.smoothTiming&&this.alphaStepTimeEMA!==null&&t<this.alphaStepTimeEMA){let i=this.alphaStepTimeEMA-t;setTimeout(()=>{this.isRunning&&(this.animationFrameId=requestAnimationFrame(()=>this._renderLoop()))},i);return}}else this.renderer&&(this.options.clearScreen?this.renderer.render(!1):this.renderer.render(!0));this.isRunning&&(this.animationFrameId=requestAnimationFrame(()=>this._renderLoop()))}}_updateTimingEMA(e){if(this.alphaStepWarmupCounter<this.ALPHA_STEP_TIME_WARMUP_CYCLES?this.alphaStepWarmupCounter++:this.alphaStepTimeEMA===null?this.alphaStepTimeEMA=e:e>this.alphaStepTimeEMA?this.alphaStepTimeEMA=this.ALPHA_STEP_TIME_UPWARD*e+(1-this.ALPHA_STEP_TIME_UPWARD)*this.alphaStepTimeEMA:this.alphaStepTimeEMA=this.ALPHA_STEP_TIME_DECAY*e+(1-this.ALPHA_STEP_TIME_DECAY)*this.alphaStepTimeEMA,this.options.smoothTiming){if(this.alphaStepDisplayCounter++,this.alphaStepDisplayCounter>=this.ALPHA_STEP_TIME_DISPLAY_INTERVAL){this.alphaStepDisplayCounter=0;let t=document.getElementById("step-time-counter");t&&(this.alphaStepTimeEMA===null?t.textContent=`Step: ${e.toFixed(1)}ms (warming up...)`:t.textContent=`Step: ${e.toFixed(1)}ms (EMA: ${this.alphaStepTimeEMA.toFixed(1)}ms)`,t.style.display="block")}}else{let t=document.getElementById("step-time-counter");t&&(t.style.display="none")}}async _captureFrame(){if(this.renderer)try{let e=await this.renderer.captureRenderBuffer();this.capturedFrames.push(e),this.frameCaptureCount++,this.frameCaptureOnProgress&&this.frameCaptureOnProgress(this.frameCaptureCount,this.frameCaptureTotal,this.alpha),this.frameCaptureCount>=this.frameCaptureTotal&&(this.stop(),this.frameCaptureOnComplete&&this.frameCaptureOnComplete(this.capturedFrames))}catch(e){console.error("Failed to capture animation frame:",e),this.stop(),alert("Failed to capture animation frame. Check console for details.")}}_emitAlphaChanged(e){for(let t of this._alphaChangedListeners)t(e)}};var W={GRID:1,COUNTERS:10,CONTROLS_PANEL:200,COORDINATE_EDITOR:300,GRADIENT_PANEL:325,RENDERING_PANEL:350,MOBILE_VIEW_CONTROLS:9998,MOBILE_MENU_BAR:1e4,MENU_BAR:10001,MENU_BAR_LOWERED:1,MOBILE_PANEL:2e4,CLOSE_BUTTON:99999};function Hi(){$("#menu-bar").css("z-index",W.MENU_BAR_LOWERED)}function Xi(){$("#menu-bar").css("z-index",W.MENU_BAR)}function me(){return window.innerWidth<=768}var pe=class{constructor(e,t={}){this.panel=$(e),this.panelSelector=e,this.closeButton=this.panel.find(".floating-panel-close, .mobile-overlay-close"),this.onShow=t.onShow,this.onHide=t.onHide,this.zIndex=t.zIndex||W.MOBILE_PANEL,this.manageMobileOnly=t.manageMobileOnly!==!1,this.panel.length||console.warn(`PanelManager: Panel not found: ${e}`)}show(){this.panel.length&&(this.panel.show(),(!this.manageMobileOnly||me())&&(this.panel.css("z-index",this.zIndex),this.closeButton.css("z-index",W.CLOSE_BUTTON),Hi()),this.onShow&&this.onShow())}hide(){this.panel.length&&(this.panel.hide(),(!this.manageMobileOnly||me())&&Xi(),this.onHide&&this.onHide())}toggle(){this.isVisible()?this.hide():this.show()}isVisible(){return this.panel.is(":visible")}setZIndex(e){this.zIndex=e,this.isVisible()&&(!this.manageMobileOnly||me())&&this.panel.css("z-index",e)}getPanel(){return this.panel}wireCloseButton(){this.closeButton.off("click.panelManager").on("click.panelManager",()=>{this.hide()})}enableClickOutside(e=[]){this.clickOutsideExclusions=[this.panelSelector,...e],$(document).off("click.panelManager"+this.panelSelector),$(document).on("click.panelManager"+this.panelSelector,t=>{for(let i of this.clickOutsideExclusions)if($(t.target).is(i)||$(t.target).closest(i).length>0)return;this.isVisible()&&this.hide()}),this.panel.off("click.panelManagerStop").on("click.panelManagerStop",t=>{t.stopPropagation()})}disableClickOutside(){$(document).off("click.panelManager"+this.panelSelector),this.panel.off("click.panelManagerStop"),this.clickOutsideExclusions=null}destroy(){this.closeButton.off("click.panelManager"),this.disableClickOutside()}};function Me(o){let t=["reinhard_extended","uncharted2","hable","luminance_extended"].includes(o);$("#white-point-control").toggle(t)}function Ut(o){o==="expression"?$("#expression-controls").show():$("#expression-controls").hide()}function kt(o){o==="expression"||o==="velocity_magnitude"||o==="velocity_angle"||o==="velocity_combined"?$("#gradient-button-container").show():$("#gradient-button-container").hide(),o==="expression"?$("#gradient-preset-toggle").hide():$("#gradient-preset-toggle").show()}function Nt(o){o==="velocity_magnitude"||o==="velocity_combined"?($("#velocity-scaling-container").show(),$("#velocity-log-container").show()):($("#velocity-scaling-container").hide(),$("#velocity-log-container").hide())}re();z();function rn(o){try{let e=o.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";let t=atob(e);return JSON.parse(t)}catch(e){return console.error("Failed to decode settings:",e),null}}function nn(o){try{let e=JSON.stringify(o);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){return console.error("Failed to encode settings:",e),null}}function ji(){try{let o=new URLSearchParams(window.location.search),e=o.get("s"),t=null;if(e){if(t=rn(e),t){console.log("Loaded settings from URL parameter"),localStorage.setItem("vectorFieldSettings",JSON.stringify(t)),o.delete("s");let i=o.toString(),r=window.location.pathname+(i?"?"+i:"");window.history.replaceState({},"",r),console.log("URL cleaned, settings now in localStorage")}}else{let i=localStorage.getItem("vectorFieldSettings");i&&(t=JSON.parse(i),console.log("Loaded settings from localStorage"))}return t}catch(o){return console.warn("Failed to load settings:",o),null}}function Wi(o,e){let t=o.getSettings();return e&&e.bbox&&(t.bbox={min:[...e.bbox.min],max:[...e.bbox.max]}),e&&e.coordinateSystem&&(t.coordinateSystem=e.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(t)),t}function qi(o){let e=nn(o);if(!e){alert("Failed to encode settings");return}let t=new URL(window.location.href);t.search="";let i=new URLSearchParams(window.location.search).get("storage");i&&t.searchParams.set("storage",i),t.searchParams.set("s",e);let r=t.toString();if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(r).then(()=>{let n=$("#share-url"),s=n.text();n.text("URL Copied!"),setTimeout(()=>{n.text(s)},2e3)}).catch(n=>{console.error("Failed to copy URL to clipboard:",n),alert(`Share this URL:

`+r)});else{let n=document.createElement("input");n.value=r,document.body.appendChild(n),n.select(),n.setSelectionRange(0,99999);try{let s=document.execCommand("copy");if(document.body.removeChild(n),s){let a=$("#share-url"),l=a.text();a.text("URL Copied!"),setTimeout(()=>{a.text(l)},2e3)}else throw new Error("execCommand failed")}catch{document.body.removeChild(n),alert(`Copy this URL to share:

`+r)}}}function on(o,e,t){if(!o||!o.coordinateSystem||!o.dimensions)return!1;try{let i=o.coordinateSystem;i.forwardTransforms&&window.UnicodeAutocomplete&&(i.forwardTransforms=i.forwardTransforms.map(n=>typeof n=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(n):n));let r=k.fromJSON(i);if(r.dimensions===o.dimensions)return e.coordinateSystem=r,t.setCoordinateSystem(r,!1),console.log("Restored coordinate system:",r.name),!0;{console.warn(`Coordinate system dimension mismatch: system has ${r.dimensions}D but settings use ${o.dimensions}D. Resetting to Cartesian.`);let n=j(o.dimensions);return e.coordinateSystem=n,t.setCoordinateSystem(n,!1),!1}}catch(i){if(console.warn("Failed to restore coordinate system:",i),o.dimensions){let r=j(o.dimensions);e.coordinateSystem=r,t.setCoordinateSystem(r,!1)}return!1}}function sn(o){o.expressions&&Array.isArray(o.expressions)&&window.UnicodeAutocomplete&&(o.expressions=o.expressions.map(e=>typeof e=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(e):e))}function an(o){if(o.mapperParams){let e=o.mapperParams;e.dim1!==void 0&&e.dim2!==void 0&&e.dim1===e.dim2&&(console.warn("Invalid mapper params: dim1 and dim2 are the same, fixing to default"),o.mapperParams={dim1:0,dim2:1})}}function ln(o,e){if(!e)return o;let t=e.width/e.height,i=o.max[0]-o.min[0],r=o.max[1]-o.min[1],n=i/r,s=(o.min[0]+o.max[0])/2,a=(o.min[1]+o.max[1])/2,l=i,u=r;return t>n?l=r*t:u=i/t,{min:[s-l/2,a-u/2],max:[s+l/2,a+u/2]}}function Ji(o,e,t,i){if(!o){i&&i();return}let r=e.get("dimension-inputs");r&&on(o,t,r),sn(o),an(o),e.webComponentRegistry?e.webComponentRegistry.applyWhenReady(o).then(()=>{i&&i()}):(e.applySettings(o),e.apply(),i&&i())}function Ki(o,e){if(o&&o.bbox&&e){let t=e.gl?.canvas,i=ln(o.bbox,t);e.updateConfig({bbox:i,reinitializeParticles:!1}),c.verbose("Restored bbox expanded for aspect ratio")}}re();z();var Gt="customPresets";function Yi(){window.presets={"2d_rotation":{dimensions:2,expressions:["-y","x"],integratorType:"rk2",colorMode:"velocity_angle",name:"Simple Rotation"},"2d_vortex":{dimensions:2,expressions:["-y + x*(1 - x*x - y*y)","x + y*(1 - x*x - y*y)"],integratorType:"rk4",colorMode:"velocity_angle",bbox:{min:[-3,-3],max:[3,3]},name:"Vortex"},"2d_vanderpol":{dimensions:2,expressions:["y","(1 - x*x)*y - x"],integratorType:"rk4",colorMode:"velocity_angle",name:"Van der Pol Oscillator"},"3d_lorenz":{dimensions:3,expressions:["10*(y - x)","x*(28 - z) - y","x*y - 2.67*z"],integratorType:"rk4",colorMode:"velocity_angle",name:"Lorenz Attractor"},"3d_rossler":{dimensions:3,expressions:["-y - z","x + 0.2*y","0.2 + z*(x - 5.7)"],colorMode:"velocity_angle",name:"R\xF6ssler Attractor"},"4d_hypersphere":{dimensions:4,expressions:["-y","x","-w","z"],colorMode:"velocity_angle",name:"4D Hypersphere Rotation"},"2d_fluid_stirring":{dimensions:2,expressions:["-y + sin(x)*cos(y)*3.0 - 0.1*x","x + cos(x)*sin(y)*3.0 - 0.1*y"],colorMode:"velocity_angle",name:"Fluid Transport with Stirring"},"4d_double_pendulum":{dimensions:4,expressions:["z","w","(-10*(2*sin(x) + sin(x - 2*y)) - 2*sin(x - y)*(w*w + z*z*cos(x - y))) / (3 - cos(2*x - 2*y))","(2*sin(x - y)*(2*z*z + 20*cos(x) + w*w*cos(x - y))) / (3 - cos(2*x - 2*y))"],name:"Double Pendulum (Chaotic)",timestep:.005,colorMode:"velocity_angle",mapperType:"custom",mapperParams:{horizontalExpr:"sin(x) + sin(y)",verticalExpr:"-cos(x) - cos(y)",depthExpr:""}},"2d_strange_attractor":{dimensions:2,expressions:["-y + x*(1 - x*x*x*x - y*y*y*y)","x + y*(1 - x*x*x*x - y*y*y*y)"],bbox:{min:[-3.5719104227544065,-1.7259582784950003],max:[3.5719104227544065,1.7259582784950003]},integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.472,implicitIterations:3,particleCount:880100,fadeOpacity:.9999,colorMode:"velocity_angle",supersampleFactor:2,smaaEnabled:!1,"smaa-intensity":1,"smaa-threshold":1,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.01,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13,name:"Strange Attractor (Chaotic Limit Cycle)"}}}function cn(o,e){if(!e)return o;let t=e.width/e.height,i=o.max[0]-o.min[0],r=o.max[1]-o.min[1],n=i/r,s=(o.min[0]+o.max[0])/2,a=(o.min[1]+o.max[1])/2,l=i,u=r;return t>n?l=r*t:u=i/t,{min:[s-l/2,a-u/2],max:[s+l/2,a+u/2]}}function ot(o,e){let t=window.presets[o];if(t||(t=Le()[o]),!t){console.error("Preset not found:",o),c.error(`Preset not found: ${o}`);return}if(c.info(`Loading preset: ${t.name||o} (dimensions=${t.dimensions}, expressions=${t.expressions.length})`),t.dimensions){let a;t.coordinateSystem?a=k.fromJSON(t.coordinateSystem):a=j(t.dimensions),window.renderer&&(window.renderer.coordinateSystem=a);let l=e.get("dimension-inputs");l&&l.setCoordinateSystem(a),c.info(`Preset loaded with coordinate system: ${a.name}`)}e.webComponentRegistry?e.webComponentRegistry.applyWhenReady(t):(e.applySettings(t),e.apply());let i=e.get("dimension-inputs");i&&t.dimensions&&i.updateInputs(t.dimensions);let r=e.get("mapper-params");r&&r.updateControls();let n=e.get("transform-params");n&&n.updateControls();let s=e.getSettings();if(t.bbox){let a=window.renderer?.gl?.canvas,l=cn(t.bbox,a);s.bbox=l;let u=t.bbox.max[0]-t.bbox.min[0],d=t.bbox.max[1]-t.bbox.min[1],h=l.max[0]-l.min[0],p=l.max[1]-l.min[1];a?c.info(`Preset bbox expanded from [${u.toFixed(2)} x ${d.toFixed(2)}] to [${h.toFixed(2)} x ${p.toFixed(2)}] for aspect ratio ${(a.width/a.height).toFixed(2)}`):c.info(`Preset bbox: min=${t.bbox.min}, max=${t.bbox.max}`)}s.implicitIterations!==void 0&&(s.integratorParams={iterations:s.implicitIterations}),window.renderer&&window.renderer.updateConfig(s),c.info(`Preset ${t.name||o} loaded successfully`)}function Le(){try{let o=localStorage.getItem(Gt);return o?JSON.parse(o):{}}catch(o){return console.error("Failed to load custom presets:",o),{}}}function un(o,e){let t=Le();t[o]=e;try{localStorage.setItem(Gt,JSON.stringify(t))}catch(i){console.error("Failed to save custom preset:",i),alert("Failed to save preset: "+i.message)}}function dn(o){let e=Le();delete e[o];try{localStorage.setItem(Gt,JSON.stringify(e))}catch(t){console.error("Failed to delete custom preset:",t)}}function Ot(){let o=Le(),e=$("#custom-presets-group");e.empty();let t=Object.keys(o).sort();t.length>0?(e.show(),t.forEach(i=>{let n=o[i].name||i;e.append(`<option value="${i}">${n}</option>`)})):e.hide()}function Zi(o){$("#preset-selector").on("change",function(){let e=$(this).val();e&&(ot(e,o),$(this).val(""),Le()[e]?($("#preset-name-input").val(e),$("#delete-preset-btn").show()):($("#preset-name-input").val(""),$("#delete-preset-btn").hide()))}),$("#save-preset-btn").on("click",function(){let e=$("#preset-name-input").val().trim();if(!e){alert("Please enter a preset name");return}let i={...o.getSettings(),name:e};un(e,i),Ot(),$("#delete-preset-btn").show(),c.info("Preset saved: "+e)}),$("#delete-preset-btn").on("click",function(){let e=$("#preset-name-input").val().trim();e&&confirm(`Delete preset "${e}"?`)&&(dn(e),Ot(),$("#preset-name-input").val(""),$("#delete-preset-btn").hide(),c.info("Preset deleted: "+e))}),Ot()}function hn(o){o==="expression"||o==="velocity_magnitude"||o==="velocity_angle"||o==="velocity_combined"?$("#gradient-button-container").show():$("#gradient-button-container").hide(),o==="expression"?$("#gradient-preset-toggle").hide():$("#gradient-preset-toggle").show()}function Qi(o,e){let t=null,i=new pe("#gradient-panel",{zIndex:W.GRADIENT_PANEL,onShow:()=>{hn(o.get("color-mode").getValue()),t?t.setGradient(e.getValue()):(t=Ni("main-gradient-editor",e.getValue(),s=>{e.notifyChange(s)}),e.setGradientEditor(t))}});function r(){i.show()}function n(){i.hide()}return $("#open-gradient-editor").on("click",function(){r()}),$("#reset-gradient").on("click",function(){let s=ue();t&&(t.setGradient(s),e.notifyChange(s))}),i.enableClickOutside(["#open-gradient-editor"]),{showGradientPanel:r,hideGradientPanel:n,gradientEditor:t}}function er(o){let e=new pe("#rendering-panel",{zIndex:W.RENDERING_PANEL,onShow:()=>{Me(o.get("tonemap-operator").getValue())}});function t(){e.show()}function i(){e.hide()}return $("#open-rendering-settings").on("click",function(){t()}),$("#rendering-panel .floating-panel-close").on("click",function(){window.mobilePanelManager&&window.mobilePanelManager.getCurrentPanel()==="rendering"?window.mobilePanelManager.hidePanel("rendering"):i()}),e.enableClickOutside(["#open-rendering-settings","#mobile-menu-rendering"]),{showRenderingPanel:t,hideRenderingPanel:i,renderingPanelManager:e}}z();function tr(o,e,t){let i=new nt(e,o);window.animationController=i;let r=document.getElementById("animation-alpha"),n=document.getElementById("animation-speed");r&&(r.setController(i),t.register("animation-alpha","animation-alpha"),c.info("Animation alpha web component registered")),n&&(n.setController(i),c.info("Animation speed web component registered"));let s=document.getElementById("frame-limit"),a=document.getElementById("frame-limit-enabled"),l=document.getElementById("sync-steps-to-frame-limit");function u(){try{if(console.log("syncStepsToFrameLimit called"),typeof l?.getValue!="function"){console.log("bail: syncCheckbox no getValue");return}if(!l.getValue()){console.log("bail: syncCheckbox not checked");return}if(typeof n?.getValue!="function"){console.log("bail: animationSpeed no getValue");return}if(typeof s?.setValue!="function"){console.log("bail: frameLimit no setValue");return}let y=n.getValue();console.log("syncing steps:",y),s.setValue(y),a&&!a.getValue()&&a.setValue(!0),window.renderer&&(window.renderer.frameLimit=y,window.renderer.frameLimitEnabled=!0,window.renderer.totalFrames=0,window.renderer.clearRenderBuffer(),window.renderer.resetParticles(),window.renderer.isRunning||window.renderer.start())}catch(y){console.warn("syncStepsToFrameLimit error:",y)}}l?.addEventListener("change",function(){try{typeof l.getValue=="function"&&l.getValue()&&u()}catch(y){console.warn("sync checkbox change error:",y)}}),n&&(n.onChange=u),l&&t.register("check-box","sync-steps-to-frame-limit");let d=document.getElementById("animation-clear-particles"),h=document.getElementById("animation-clear-screen"),p=document.getElementById("animation-smooth-timing"),m=document.getElementById("animation-lock-shaders");d&&d.addEventListener("change",function(){i.setOptions({clearParticles:d.getValue()})}),h&&h.addEventListener("change",function(){i.setOptions({clearScreen:h.getValue()})}),p&&p.addEventListener("change",function(){i.setOptions({smoothTiming:p.getValue()})}),m&&m.addEventListener("change",function(){i.setOptions({lockShaders:m.getValue()})});let f=document.getElementById("animation-half-loops");f&&f.addEventListener("change",function(){let _=f.getValue()?"Number of half cycles (1 = 0.0 \u2192 1.0, 2 = 0.0 \u2192 1.0 \u2192 0.0)":"Number of complete alpha cycles (0.0 \u2192 1.0 \u2192 0.0)";$("#animation-loops-info").text(_)});let b=document.getElementById("animation-create-btn");b&&b.addEventListener("action",function(){if(i.isRunning){i.stop(),b.setLabel("Create Animation"),b.setIcon("\u25B6"),b.setStyle("#4CAF50");let B=document.getElementById("animation-frames"),v=document.getElementById("animation-loops"),F=document.getElementById("animation-half-loops"),A=document.getElementById("animation-download-btn");B&&(B.disabled=!1),v&&(v.disabled=!1),F&&(F.disabled=!1),A&&A.setEnabled(i.getFrames().length>0),$("#progress-text").text(`Stopped: ${i.getFrames().length} frames captured`),c.info(`Animation stopped early: ${i.getFrames().length} frames captured`);return}let y=document.getElementById("animation-frames"),_=document.getElementById("animation-loops"),E=document.getElementById("animation-half-loops"),R=document.getElementById("animation-download-btn"),w=y?y.getValue():100,S=_?_.getValue():1,M=E?.getValue?E.getValue():!1;b.setLabel("Stop Animation"),b.setIcon("\u23F9"),b.setStyle("#f44336"),y&&(y.disabled=!0),_&&(_.disabled=!0),E&&(E.disabled=!0),R&&R.setEnabled(!1),$("#animation-progress").show(),$("#progress-bar").css("width","0%"),$("#progress-text").text(`Frame 0 / ${w}`),$("#progress-alpha").text("\u03B1: 0.00"),i.start({captureFrames:!0,totalFrames:w,loops:S,halfLoops:M,onProgress:(B,v,F)=>{let A=B/v*100;$("#progress-bar").css("width",`${A}%`),$("#progress-text").text(`Frame ${B} / ${v}`),$("#progress-alpha").text(`\u03B1: ${F.toFixed(2)}`)},onComplete:B=>{b.setLabel("Create Animation"),b.setIcon("\u25B6"),b.setStyle("#4CAF50"),y&&(y.disabled=!1),_&&(_.disabled=!1),E&&(E.disabled=!1),R&&R.setEnabled(!0),$("#progress-bar").css("width","100%"),$("#progress-text").text(`Complete: ${B.length} frames`),c.info(`Animation creation complete: ${B.length} frames captured`)}})});let x=document.getElementById("animation-download-btn");x&&x.addEventListener("action",async function(){let y=i.getFrames();if(y.length===0){alert("No frames to download. Create an animation first.");return}x.setLoading(!0,"Creating ZIP...");try{let E=y.length,R=Math.ceil(E/300),w=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);c.info(`Splitting ${E} frames into ${R} ZIP file(s)`);for(let S=0;S<R;S++){let M=S*300,B=Math.min((S+1)*300,E);x.setLoading(!0,`Creating ZIP ${S+1}/${R}...`);let v=new JSZip,F=v.folder("frames");for(let P=M;P<B;P++){let U=String(P).padStart(5,"0");F.file(`frame_${U}.png`,y[P])}let A=await v.generateAsync({type:"blob"}),L=URL.createObjectURL(A),T=document.createElement("a"),C=R>1?`.${S+1}`:"";T.download=`animation-${w}${C}.zip`,T.href=L,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(L),c.info(`Part ${S+1}/${R} downloaded: frames ${M}-${B-1}`),S<R-1&&await new Promise(P=>setTimeout(P,500))}c.info(`Animation download complete: ${E} frames in ${R} ZIP file(s)`),R>1&&alert(`Animation split into ${R} ZIP files. Use create-video.sh with the base filename (without .1, .2, etc) to reconstruct.`)}catch(_){c.error("Failed to create ZIP:",_),alert("Failed to create ZIP file: "+_.message)}finally{x.setLoading(!1)}});let g=document.getElementById("export-animation-json");return g&&g.addEventListener("action",function(){let y=o.getSettings();e&&e.bbox&&(y.bbox={min:[e.bbox.min[0],e.bbox.min[1]],max:[e.bbox.max[0],e.bbox.max[1]]}),delete y.animationAlpha;let _={name:"Untitled Animation",description:"Animation created from current settings",fps:30,baseSettings:y,timeline:[{time:0,settings:{},easing:"linear"},{time:10,settings:{},easing:"linear"}],frameConfig:{burnInSteps:5e3,clearAfterBurnIn:!0,accumulationSteps:2e3}},E=new Blob([JSON.stringify(_,null,2)],{type:"application/json"}),R=URL.createObjectURL(E),w=document.createElement("a");w.href=R,w.download="animation-template.json",document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(R),c.info("Exported animation template JSON")}),i}z();function ir(o){let e={controls:$("#controls"),rendering:$("#rendering-panel")},t=null;function i(s){t&&r(t);let a=e[s];if(!a){c.warn(`Mobile panel not found: ${s}`);return}s==="rendering"?o.show():(a.addClass("mobile-overlay active"),a.find(".mobile-overlay-close").show(),a.css("z-index",W.MOBILE_PANEL),a.find(".mobile-overlay-close").css("z-index",W.CLOSE_BUTTON),$("#menu-bar").css("z-index",W.MENU_BAR_LOWERED)),$(`#mobile-menu-${s}`).addClass("active"),t=s}function r(s){let a=e[s];a&&(s==="rendering"?o.hide():(a.removeClass("mobile-overlay active"),a.find(".mobile-overlay-close").hide(),$("#menu-bar").css("z-index",W.MENU_BAR)),$(`#mobile-menu-${s}`).removeClass("active"),t===s&&(t=null))}function n(){Object.keys(e).forEach(r)}return $("#mobile-menu-controls").on("click",function(){t==="controls"?r("controls"):i("controls")}),$("#mobile-menu-rendering").on("click",function(){t==="rendering"?r("rendering"):i("rendering")}),$(".mobile-overlay-close").on("click",function(){let a=$(this).closest("[id]").attr("id"),u={controls:"controls"}[a];u&&r(u)}),{showPanel:i,hidePanel:r,hideAllPanels:n,getCurrentPanel:()=>t}}function rr(o,e){let t=document.getElementById("mobile-controls");if(!t){c.info("Mobile controls component not found, skipping sync setup");return}function i(){let n=o.get("timestep");n&&t.setTimestep(n.getValue())}$("#timestep").on("input change",i),t.onTimestepChange=n=>{let s=o.get("timestep");s&&(s.setValue(n),o.debouncedApply())},t.onFrameLimitEnabledChange=n=>{let s=o.get("frame-limit-enabled");s&&(s.setValue(n),o.debouncedApply())},t.onFrameLimitChange=n=>{let s=o.get("frame-limit");s&&(s.setValue(n),o.debouncedApply())};let r=o.webComponentRegistry;r?r.whenAllReady().then(()=>{setTimeout(()=>{i();let n=o.get("frame-limit-enabled"),s=o.get("frame-limit");n&&t.setFrameLimitEnabled(n.getValue()),s&&t.setFrameLimit(s.getValue())},100)}):c.warn("Web component registry not found on manager, mobile controls sync may not work properly")}function dr(o,e){let t=null,i=new Ze({renderer:o,storageKey:"vectorFieldSettings",debounceTime:300,onApply:v=>{v.implicitIterations!==void 0&&(v.integratorParams={iterations:v.implicitIterations});let F=v.dimensions;if(F!==t){let L=i.get("dimension-inputs");L&&(L.updateInputs(F),v.expressions=L.getValue());let T=i.get("mapper-params");T&&T.updateControls(),t=F}if(o.updateConfig(v),o.coordinateSystem){let L=i.get("dimension-inputs");L&&L.setCoordinateSystem(o.coordinateSystem,!1)}let A=i.getSettings();o&&o.bbox&&(A.bbox={min:[...o.bbox.min],max:[...o.bbox.max]}),o&&o.coordinateSystem&&(A.coordinateSystem=o.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(A)),mn()}}),r=new rt(i);i.webComponentRegistry=r,r.register("select-control","integrator");let n=document.getElementById("integrator");n&&n.addEventListener("change",()=>{let v=n.getValue(),F=v.startsWith("implicit-")||v==="trapezoidal";$("#implicit-iterations-group").toggle(F),$("#solution-method-group").toggle(F),ae("#integrator",0)}),r.register("select-control","solution-method"),r.register("animatable-timestep","timestep"),r.register("animatable-slider","fade").then(v=>{v&&Promise.resolve().then(()=>(Be(),ur)).then(F=>{let{createFadeTransform:A}=F,{transform:L,inverseTransform:T}=A();v.setCustomTransform(L,T),v.updateBoundsDisplay&&v.updateBoundsDisplay()})}),r.register("select-control","transform");let s=document.getElementById("transform");s&&s.addEventListener("change",()=>{let v=i.get("transform-params");v&&v.updateControls()}),i.register(new it({},{settingsKey:"transformParams"})).setTransformControl(s),r.register("select-control","mapper");let l=document.getElementById("mapper");l&&l.addEventListener("change",()=>{let v=i.get("mapper-params");v&&v.updateControls()});let u=i.register(new et({dim1:0,dim2:1},{settingsKey:"mapperParams"})),d=document.getElementById("dimensions");u.setRelatedControls(d,l),r.register("select-control","color-mode");let h=document.getElementById("color-mode");h&&h.addEventListener("change",()=>{let v=h.getValue();Ut(v),kt(v),Nt(v)});let p=i.register(new Ye("color-expression","x * y",{settingsKey:"colorExpression"})),m=i.register(new tt(ue(),{settingsKey:"colorGradient"}));r.register("select-control","velocity-scale-mode");let f=i.register(new Qe(["-y","x"],{settingsKey:"expressions"}));r.register("select-control","tonemap-operator");let b=document.getElementById("tonemap-operator");b&&b.addEventListener("change",()=>{let v=b.getValue();Me(v)}),r.register("select-control","particle-render-mode"),r.register("linear-slider","dimensions").then(v=>{v&&(v.onChange=F=>{c.verbose("Dimensions changed to:",F);let A=i.get("dimension-inputs");A&&(c.verbose("Updating dimension inputs with dimensions:",F),A.updateInputs(F))})}),r.register("linear-slider","implicit-iterations"),r.register("linear-slider","particles"),r.register("linear-slider","drop"),r.register("linear-slider","supersample-factor"),r.register("linear-slider","bloom-radius"),r.register("linear-slider","bilateral-spatial"),r.register("linear-slider","bilateral-intensity"),r.register("log-slider","exposure"),r.register("log-slider","gamma"),r.register("log-slider","luminance-gamma"),r.register("log-slider","highlight-compression"),r.register("log-slider","compression-threshold"),r.register("log-slider","white-point"),r.register("log-slider","particle-intensity"),r.register("log-slider","particle-size"),r.register("log-slider","frame-limit").then(v=>{v&&(v.onChange=F=>{window.renderer&&(window.renderer.frameLimit=F)})}),r.register("percent-slider","smaa-intensity"),r.register("percent-slider","smaa-threshold"),r.register("percent-slider","bloom-intensity"),r.register("percent-slider","bloom-alpha"),r.register("percent-slider","color-saturation"),r.register("percent-slider","brightness-desat"),r.register("percent-slider","saturation-buildup"),r.register("percent-slider","respawn-margin"),r.register("check-box","velocity-log-scale"),r.register("check-box","show-grid"),r.register("check-box","frame-limit-enabled"),r.register("check-box","use-hdr"),r.register("check-box","use-depth-test"),r.register("check-box","smaa-enabled"),r.register("check-box","bilateral-enabled"),r.register("check-box","bloom-enabled"),r.register("check-box","animation-clear-particles"),r.register("check-box","animation-clear-screen"),r.register("check-box","animation-smooth-timing"),r.register("check-box","animation-lock-shaders"),r.register("check-box","animation-half-loops");let x=document.getElementById("frame-limit-enabled");x&&x.addEventListener("change",()=>{window.renderer&&(window.renderer.frameLimitEnabled=x.getValue())}),r.register("select-control","theme-selector");let g=document.getElementById("theme-selector");g&&g.addEventListener("change",()=>{g.getValue()==="light"?$("body").addClass("light-theme"):$("body").removeClass("light-theme"),i.saveToStorage()}),$("#default-settings").on("click",function(){i.resetAll(),i.clearStorage(),i.apply()}),$("#share-url").on("click",function(){let v=i.getSettings();qi(v)}),$("#reset").on("click",function(){let v=o.gl.canvas,L=10*(v.width/v.height);o.updateConfig({bbox:{min:[-L/2,-5],max:[L/2,5]},reinitializeParticles:!0})}),$("#reset-particles").on("click",function(){o.clearScreen()}),$("#save-image").on("click",async function(){try{let v=await o.captureRenderBuffer(),F=URL.createObjectURL(v),A=document.createElement("a"),L=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),T=`${o.renderWidth}x${o.renderHeight}`;A.download=`vector-field-${L}-${T}.png`,A.href=F,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(F),c.info("Image saved: "+A.download)}catch(v){c.error("Failed to save image:",v),alert("Failed to save image. Check console for details.")}});let _=new URLSearchParams(window.location.search).get("storage")||"float";$("#storage-strategy").val(_),$("#storage-strategy").on("change",function(){let v=$(this).val(),F=i.getSettings();o&&o.bbox&&(F.bbox={min:[...o.bbox.min],max:[...o.bbox.max]}),o&&o.coordinateSystem&&(F.coordinateSystem=o.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(F));let A=new URL(window.location);A.searchParams.set("storage",v),window.location.href=A.toString()}),$(document).on("click",".slider-btn",function(){let v=$(this).data("slider"),F=$(this).data("action");if(!v){console.warn("Slider button missing data-slider attribute");return}let A=i.get(v);if(A&&A.handleButtonAction){A.handleButtonAction(F);return}if(v.startsWith("transform-param-")){let L=i.get("transform-params");L&&L.handleTransformParamButton&&L.handleTransformParamButton(v,F);return}console.warn(`No button handler found for slider: ${v}`)}),$("#configure-coordinates").on("click",function(){let v=o.dimensions,F=o.coordinateSystem;(!F||F.dimensions!==v)&&(console.warn("Coordinate system dimension mismatch, resetting to Cartesian"),F=j(v),o.coordinateSystem=F),Gi(v,F,A=>{o.updateConfig({coordinateSystem:A}),f.setCoordinateSystem(A),i.apply()})});let E=Qi(i,m),R=er(i),w=tr(i,o,r);Zi(i),Yi();let S=ir(R.renderingPanelManager);window.mobilePanelManager=S,rr(i,r),$(document).on("click","#menu-settings",function(){window.appModal&&window.appModal.show()}),$(document).on("click","#menu-docs",function(){window.appModal&&window.appModal.show("docs")}),$(document).on("keydown",function(v){(v.ctrlKey||v.metaKey)&&v.key===","&&(v.preventDefault(),window.appModal&&window.appModal.show())}),$("#animation-section-toggle").on("click",function(){let v=$("#animation-section-content"),F=$("#animation-section-arrow"),A=$("#histogram-panel"),L=$("#cursor-position");v.is(":visible")?(v.slideUp(200),F.text("\u25BC"),A.removeClass("shifted"),L.removeClass("shifted")):(v.slideDown(200),F.text("\u25B2"),A.addClass("shifted"),L.addClass("shifted"))}),i.initializeControls();let M=ji();if(me()&&(!M||M.frameLimitEnabled===void 0&&M.frameLimit===void 0)){x&&x.setValue(!0);let v=document.getElementById("frame-limit");v&&v.setValue(200),window.renderer&&(window.renderer.frameLimitEnabled=!0,window.renderer.frameLimit=200),c.info("Mobile detected: frame limit enabled at 200 frames")}r.whenAllReady().then(()=>{if(M&&(Ji(M,i,o),M.expressions&&Array.isArray(M.expressions)&&window.UnicodeAutocomplete&&(M.expressions=M.expressions.map(v=>typeof v=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(v):v)),M.mapperParams)){let v=M.mapperParams;v.dim1!==void 0&&v.dim2!==void 0&&v.dim1===v.dim2&&(console.warn("Invalid mapper params: dim1 and dim2 are the same, fixing to default"),M.mapperParams={dim1:0,dim2:1})}r.applyWhenReady(M).then(()=>{let v=document.getElementById("animation-clear-particles"),F=document.getElementById("animation-clear-screen"),A=document.getElementById("animation-smooth-timing"),L=document.getElementById("animation-lock-shaders");if(w.setOptions({clearParticles:v?.getValue?v.getValue():!1,clearScreen:F?.getValue?F.getValue():!1,smoothTiming:A?.getValue?A.getValue():!1,lockShaders:L?.getValue?L.getValue():!1}),o){o.frameLimitEnabled=x?.getValue?x.getValue():!1;let V=document.getElementById("frame-limit");V&&(o.frameLimit=V.getValue())}Me(i.get("tonemap-operator").getValue());let T=i.get("color-mode").getValue();Ut(T),kt(T),Nt(T);let C=i.get("integrator").getValue()||"rk2",P=C.startsWith("implicit-")||C==="trapezoidal";$("#implicit-iterations-group").toggle(P),$("#solution-method-group").toggle(P),i.get("theme-selector").getValue()==="light"&&$("body").addClass("light-theme")})}),window.unicodeAutocomplete&&(window.unicodeAutocomplete.setEnabled(!0),window.unicodeAutocomplete.attachToAll('[id^="expr-"]'),window.unicodeAutocomplete.attachToAll("#mapper-expression"),window.unicodeAutocomplete.attachToAll("#color-expression"),window.unicodeAutocomplete.attachToAll("#custom-color-code"),window.unicodeAutocomplete.attachToAll("#custom-integrator-code"),console.log("Unicode autocomplete enabled for all math inputs"));function B(){return Wi(i,o)}return e&&e({manager:i,state:i.getSettings(),saveSettings:B}),M&&M.bbox&&Ki(M,o),i}function mn(){$("#error-message").hide()}z();z();var hr={linear:o=>o,easeIn:o=>o*o,easeOut:o=>1-Math.pow(1-o,2),easeInOut:o=>o<.5?2*o*o:1-Math.pow(-2*o+2,2)/2,easeInCubic:o=>o*o*o,easeOutCubic:o=>1-Math.pow(1-o,3),easeInOutCubic:o=>o<.5?4*o*o*o:1-Math.pow(-2*o+2,3)/2,elastic:o=>{let e=2*Math.PI/3;return o===0?0:o===1?1:-Math.pow(2,10*o-10)*Math.sin((o*10-10.75)*e)},bounce:o=>o<1/2.75?7.5625*o*o:o<2/2.75?7.5625*(o-=1.5/2.75)*o+.75:o<2.5/2.75?7.5625*(o-=2.25/2.75)*o+.9375:7.5625*(o-=2.625/2.75)*o+.984375},at=class{constructor(e,t){this.renderer=e,this.manager=t,this.frames=[],this.isRunning=!1,this.isPaused=!1,this.script=null}loadScript(e){if(!e.baseSettings)throw new Error("Animation script missing baseSettings");if(!e.timeline||!Array.isArray(e.timeline))throw new Error("Animation script missing timeline array");if(e.timeline.length<2)throw new Error("Timeline must have at least 2 keyframes");for(let r=1;r<e.timeline.length;r++)if(e.timeline[r].time<=e.timeline[r-1].time)throw new Error("Timeline keyframes must be sorted by time");this.script={name:e.name||"Untitled Animation",description:e.description||"",fps:e.fps||30,baseSettings:e.baseSettings,timeline:e.timeline.map(r=>({time:r.time,settings:r.settings||{},easing:r.easing||"linear",convergenceSteps:r.convergenceSteps||0})),frameConfig:{burnInSteps:e.frameConfig?.burnInSteps||5e3,clearAfterBurnIn:e.frameConfig?.clearAfterBurnIn!==void 0?e.frameConfig.clearAfterBurnIn:!0,accumulationSteps:e.frameConfig?.accumulationSteps||2e3}};let t=this.script.timeline[this.script.timeline.length-1].time,i=Math.ceil(t*this.script.fps);return c.info(`Loaded animation: ${this.script.name}`),c.info(`  Duration: ${t}s @ ${this.script.fps} fps = ${i} frames`),c.info(`  Keyframes: ${this.script.timeline.length}`),this.script}getKeyframeIndices(e){let t=this.script.timeline;if(e<=t[0].time)return{prev:0,next:0,t:0};if(e>=t[t.length-1].time)return{prev:t.length-1,next:t.length-1,t:1};for(let i=1;i<t.length;i++)if(e<=t[i].time){let r=i-1,n=i,s=(e-t[r].time)/(t[n].time-t[r].time);return{prev:r,next:n,t:s}}return{prev:t.length-1,next:t.length-1,t:1}}interpolateValue(e,t,i,r="linear"){let s=(hr[r]||hr.linear)(i);if(typeof e=="number"&&typeof t=="number")return e+(t-e)*s;if(Array.isArray(e)&&Array.isArray(t))return e.map((a,l)=>{let u=t[l]!==void 0?t[l]:a;return typeof a=="number"?a+(u-a)*s:s<.5?a:u});if(typeof e=="object"&&e!==null&&typeof t=="object"&&t!==null){let a={...e};for(let l in t)e[l]!==void 0?a[l]=this.interpolateValue(e[l],t[l],s,r):a[l]=t[l];return a}return s<.5?e:t}getInterpolatedSettings(e){let{prev:t,next:i,t:r}=this.getKeyframeIndices(e),n=this.script.timeline;if(t===i)return{...this.script.baseSettings,...n[t].settings};let s={...this.script.baseSettings,...n[t].settings},a={...this.script.baseSettings,...n[i].settings},l=n[i].easing,u={...s};for(let d in a)s[d]!==void 0?u[d]=this.interpolateValue(s[d],a[d],r,l):u[d]=a[d];return u}getAnimationAlpha(e){let t=this.script.timeline[this.script.timeline.length-1].time;return Math.max(0,Math.min(1,e/t))}waitFrame(){return new Promise(e=>requestAnimationFrame(e))}async captureFrame(){return this.renderer.captureRenderBuffer()}async renderAnimationFrame(e,t,i){let{frameConfig:r}=this.script,n=this.getInterpolatedSettings(e),s=this.getAnimationAlpha(e);if(c.info(`Frame ${t+1}/${i}: t=${e.toFixed(3)}s, alpha=${s.toFixed(3)}`),this.manager.setSettings(n),this.renderer.setAnimationAlpha(s),await this.waitFrame(),this.renderer.clearRenderBuffer(),this.renderer.resetParticles(),r.burnInSteps>0&&(c.verbose(`  Burn-in: ${r.burnInSteps} steps`),this.renderer.step(r.burnInSteps)),r.clearAfterBurnIn&&this.renderer.clearRenderBuffer(),r.accumulationSteps>0){c.verbose(`  Accumulation: ${r.accumulationSteps} steps`);for(let l=0;l<r.accumulationSteps;l++)this.renderer.updatePositions(),this.renderer.drawParticles(),this.renderer.fadeScreen()}return this.renderer.render(),await this.waitFrame(),await this.captureFrame()}async run(e){if(this.isRunning)throw new Error("Animation already running");if(!this.script)throw new Error("No animation script loaded");this.isRunning=!0,this.isPaused=!1,this.frames=[];let t=this.script.timeline[this.script.timeline.length-1].time,i=Math.ceil(t*this.script.fps);try{c.info("Applying base settings...");let r={...this.script.baseSettings};if(delete r.coordinateSystem,this.manager.setSettings(r),this.script.baseSettings.coordinateSystem){let{CoordinateSystem:n}=await Promise.resolve().then(()=>(re(),Bi)),s=n.fromJSON(this.script.baseSettings.coordinateSystem);this.renderer.coordinateSystem=s,c.info(`Set coordinate system: ${s.name}`),this.renderer.compileShaders(),c.info("Shaders recompiled with coordinate system")}await this.waitFrame();for(let n=0;n<i;n++){for(;this.isPaused&&this.isRunning;)await new Promise(l=>setTimeout(l,100));if(!this.isRunning){c.info("Animation stopped");break}let s=n/this.script.fps,a=await this.renderAnimationFrame(s,n,i);this.frames.push({frameNum:n,time:s,blob:a,timestamp:Date.now()}),e&&e(n+1,i,s)}return c.info(`Animation complete: ${this.frames.length} frames captured`),this.frames}catch(r){throw c.error("Animation failed:",r),r}finally{this.isRunning=!1}}pause(){this.isPaused=!0}resume(){this.isPaused=!1}stop(){this.isRunning=!1,this.isPaused=!1}async downloadFrames(){if(this.frames.length===0)throw new Error("No frames to download");return window.JSZip?await this.downloadAsZip():await this.downloadIndividually()}async downloadAsZip(){let e=window.JSZip,t=new e;for(let{frameNum:s,blob:a}of this.frames){let l=`frame_${String(s).padStart(6,"0")}.png`;t.file(l,a)}let i={script:this.script,captureDate:new Date().toISOString(),frameCount:this.frames.length};t.file("metadata.json",JSON.stringify(i,null,2)),c.info("Generating ZIP archive...");let r=await t.generateAsync({type:"blob"}),n=`${this.script.name.replace(/\s+/g,"_")}.zip`;this.downloadBlob(r,n),c.info(`Downloaded ${n}`)}async downloadIndividually(){for(let{frameNum:e,blob:t}of this.frames){let i=`frame_${String(e).padStart(6,"0")}.png`;this.downloadBlob(t,i),await new Promise(r=>setTimeout(r,100))}c.info(`Downloaded ${this.frames.length} frames`)}downloadBlob(e,t){let i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}};var te=class{constructor(e,t){this.id=e,this.title=t,this._isRendered=!1,this._isActive=!1,this._contentElement=null}get isRendered(){return this._isRendered}get isActive(){return this._isActive}render(e){throw new Error("Tab subclass must implement render() method")}onActivate(){}onDeactivate(){}_activate(e){this._isRendered||(this._contentElement=this.render(e),this._isRendered=!0),this._contentElement&&(this._contentElement.style.display="block"),this._isActive=!0,this.onActivate()}_deactivate(){this._contentElement&&(this._contentElement.style.display="none"),this._isActive=!1,this.onDeactivate()}destroy(){this._contentElement&&this._contentElement.parentNode&&this._contentElement.parentNode.removeChild(this._contentElement),this._contentElement=null,this._isRendered=!1,this._isActive=!1}},lt=class{constructor(){this._tabs=new Map,this._activeTab=null,this._tabBarElement=null,this._contentElement=null}register(e){if(!(e instanceof te))throw new Error("Tab must be an instance of Tab class");if(this._tabs.has(e.id))throw new Error(`Tab with id '${e.id}' already registered`);this._tabs.set(e.id,e),this._tabBarElement&&this._addTabButton(e)}unregister(e){let t=this._tabs.get(e);if(t&&(t===this._activeTab&&(this._activeTab=null),t.destroy(),this._tabs.delete(e),this._tabBarElement)){let i=this._tabBarElement.querySelector(`[data-tab-id="${e}"]`);i&&i.remove()}}activate(e){let t=this._tabs.get(e);return t?(this._activeTab&&this._activeTab!==t&&(this._activeTab._deactivate(),this._updateTabButton(this._activeTab.id,!1)),this._activeTab=t,t._activate(this._contentElement),this._updateTabButton(e,!0),!0):(console.warn(`Tab '${e}' not found`),!1)}getActiveTab(){return this._activeTab}getAllTabs(){return Array.from(this._tabs.values())}initializeUI(e,t){this._tabBarElement=e,this._contentElement=t;for(let i of this._tabs.values())this._addTabButton(i)}_addTabButton(e){if(!this._tabBarElement)return;let t=document.createElement("button");t.className="modal-tab-button",t.textContent=e.title,t.dataset.tabId=e.id,t.addEventListener("click",()=>{this.activate(e.id)}),this._tabBarElement.appendChild(t)}_updateTabButton(e,t){if(!this._tabBarElement)return;let i=this._tabBarElement.querySelector(`[data-tab-id="${e}"]`);i&&(t?i.classList.add("active"):i.classList.remove("active"))}destroy(){for(let e of this._tabs.values())e.destroy();this._tabs.clear(),this._activeTab=null,this._tabBarElement=null,this._contentElement=null}};var Zt=class{constructor(){this.tabManager=new lt,this._modalElement=null,this._isVisible=!1,this._onCloseCallback=null,this._wasPaused=!1}initialize(){if(this._modalElement=document.getElementById("modal-overlay"),!this._modalElement){console.error("Modal overlay element not found");return}let e=document.getElementById("modal-tab-bar"),t=document.getElementById("modal-content");if(!e||!t){console.error("Modal tab bar or content element not found");return}this.tabManager.initializeUI(e,t);let i=document.getElementById("modal-close");i&&i.addEventListener("click",()=>this.hide()),this._modalElement.addEventListener("click",r=>{r.target===this._modalElement&&this.hide()}),document.addEventListener("keydown",r=>{r.key==="Escape"&&this._isVisible&&this.hide()})}registerTab(e){this.tabManager.register(e)}show(e=null,t=null){if(!this._modalElement){console.error("Modal not initialized");return}if(!e){let i=this.tabManager.getAllTabs();i.length>0&&(e=i[0].id)}if(e&&(this.tabManager.activate(e),t)){let i=this.tabManager.getAllTabs().find(r=>r.id===e);i&&typeof i.openToSection=="function"&&(i.isRendered?i.openToSection(t):typeof i.setPendingSection=="function"&&i.setPendingSection(t))}this._modalElement.style.display="flex",this._isVisible=!0,document.body.style.overflow="hidden",window.renderer&&window.renderer.isRunning?(window.renderer.stop(),this._wasPaused=!1):this._wasPaused=!0}hide(){this._modalElement&&(this._modalElement.style.display="none",this._isVisible=!1,document.body.style.overflow="",window.renderer&&!this._wasPaused&&window.renderer.start(),this._onCloseCallback&&this._onCloseCallback())}isVisible(){return this._isVisible}onClose(e){this._onCloseCallback=e}getActiveTab(){return this.tabManager.getActiveTab()}},Yt=null;function pn(){return Yt||(Yt=new Zt),Yt}function mr(){let o=pn();return o.initialize(),o}var ct=class extends te{constructor(e,t){super("custom-functions","Custom Functions"),this.mathParser=e,this.debouncedApply=t,this.textarea=null,this.applyButton=null,this.errorDiv=null,this.successDiv=null}render(e){let t=document.createElement("div");return t.id="custom-functions-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div class="info" style="margin-bottom: 16px;">
                Define custom functions using mathematical syntax. Functions can be used in vector field expressions, color expressions, and mapper functions.
            </div>

            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Syntax</h4>
            <div class="info" style="margin-bottom: 16px; font-family: monospace; background: #000; padding: 8px; border-radius: 4px; font-size: 11px;">
                functionName(arg1, arg2, ...) = expression<br>
                <br>
                <span style="color: #888;">Examples:</span><br>
                <span style="color: #4CAF50;">smoothstep(x, a, b) = ((x-a)/(b-a))^3 * (3 - 2*((x-a)/(b-a)))</span><br>
                <span style="color: #4CAF50;">lerp(a, b, t) = a * (1-t) + b * t</span><br>
                <span style="color: #4CAF50;">sqr(x) = x * x</span><br>
                <span style="color: #4CAF50;">cube(x) = x * x * x</span>
            </div>

            <h4 style="margin: 0 0 8px 0; padding: 0; font-size: 14px; color: #4CAF50;">Function Definitions</h4>
            <div class="control-group">
                <textarea id="custom-functions-textarea"
                    rows="12"
                    style="width: 100%; font-family: 'Courier New', monospace; font-size: 12px; background: #1a1a1a; color: #4CAF50; border: 1px solid #444; border-radius: 4px; padding: 10px; resize: vertical;"
                    placeholder="Enter custom function definitions (one per line)...&#10;&#10;Example:&#10;smoothstep(x, a, b) = ((x-a)/(b-a))^3 * (3 - 2*((x-a)/(b-a)))"></textarea>
                <div class="info">One function per line. Use standard math operators (+, -, *, /, ^) and built-in functions (sin, cos, exp, log, sqrt, abs, etc.)</div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="apply-custom-functions" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    Apply Functions
                </button>
            </div>

            <div id="custom-functions-error" style="display: none; margin-top: 12px; padding: 8px; background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; border-radius: 4px; color: #f44336; font-size: 11px;"></div>

            <div id="custom-functions-success" style="display: none; margin-top: 12px; padding: 8px; background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; border-radius: 4px; color: #4CAF50; font-size: 11px;"></div>
        `,e.appendChild(t),this.textarea=t.querySelector("#custom-functions-textarea"),this.applyButton=t.querySelector("#apply-custom-functions"),this.errorDiv=t.querySelector("#custom-functions-error"),this.successDiv=t.querySelector("#custom-functions-success"),this.applyButton.addEventListener("click",()=>this._applyFunctions()),this._loadSavedFunctions(),t}onActivate(){window.unicodeAutocomplete&&window.unicodeAutocomplete.attachToAll("#custom-functions-textarea")}_applyFunctions(){let e=this.textarea.value;this.errorDiv.style.display="none",this.successDiv.style.display="none";try{this.mathParser.setCustomFunctions(e);let t=e.trim()?e.trim().split(`
`).filter(i=>i.trim()&&!i.trim().startsWith("//")).length:0;this.successDiv.textContent=`\u2713 Successfully loaded ${t} custom function(s)`,this.successDiv.style.display="block",localStorage.setItem("customFunctions",e),this.debouncedApply()}catch(t){this.errorDiv.textContent=`Error: ${t.message}`,this.errorDiv.style.display="block"}}_loadSavedFunctions(){let e=localStorage.getItem("customFunctions");if(e&&this.textarea){this.textarea.value=e;try{this.mathParser.setCustomFunctions(e)}catch(t){console.error("Error loading saved custom functions:",t)}}}};var ut=class extends te{constructor(e){super("debug","Debug Console"),this.logger=e,this.debugToggle=null,this.debugVerbosity=null,this.debugOutput=null,this.bufferSizeSpan=null,this.bufferPercentSpan=null,this.bufferStatusDiv=null}render(e){let t=document.createElement("div");t.id="debug-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="debug-toggle" checked style="margin-right: 8px;">
                    <span style="font-weight: bold;">Enable Debug Logging</span>
                </label>
            </div>

            <div id="debug-controls" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                <select id="debug-verbosity" style="flex: 0 0 auto;">
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                    <option value="verbose">Verbose</option>
                    <option value="warn">Warnings Only</option>
                    <option value="error">Errors Only</option>
                    <option value="silent">Silent (Buffer)</option>
                </select>
                <button id="debug-log-update-shader" class="secondary" style="padding: 4px 8px;" title="Particle integration shader (updates positions each frame)">Update Shader</button>
                <button id="debug-log-draw-shader" class="secondary" style="padding: 4px 8px;" title="Particle rendering shaders (vertex + fragment for color/display)">Draw Shaders</button>
                <button id="debug-log-screen-shader" class="secondary" style="padding: 4px 8px;" title="Screen fade shader (trail decay)">Fade Shader</button>
                <button id="debug-log-stats-shaders" class="secondary" style="padding: 4px 8px;" title="Velocity statistics shader (max velocity tracking)">Velocity Stats</button>
                <button id="debug-buffer-stats" class="secondary" style="padding: 4px 8px;">Buffer Stats</button>
                <button id="debug-copy" class="secondary" style="padding: 4px 8px;">Copy Log</button>
                <button id="debug-clear" class="secondary" style="padding: 4px 8px;">Clear</button>
            </div>

            <div id="debug-buffer-status" style="display: none; padding: 8px; background: #2a2a2a; border-radius: 4px; margin-bottom: 12px; font-size: 11px; color: #888;">
                <span style="color: #FFA726; font-weight: bold;">SILENT MODE:</span>
                Buffering <span id="buffer-size" style="color: #4CAF50;">0</span> logs
                (<span id="buffer-percent">0</span>% of max)
                <button id="debug-flush-buffer" class="secondary" style="padding: 2px 6px; margin-left: 8px; font-size: 10px;">Flush Buffer</button>
                <button id="debug-clear-buffer" class="secondary" style="padding: 2px 6px; margin-left: 4px; font-size: 10px;">Clear Buffer</button>
            </div>

            <div style="padding: 8px; margin-bottom: 12px; background: #1f1f1f; border-radius: 4px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px;" title="Enable particle sampling and detailed logging (expensive GPU readback). Buffer stats for tone mapping are always enabled but optimized.">
                    <input type="checkbox" id="debug-enable-stats" style="margin-right: 6px;">
                    <span>Enable Particle Sampling (expensive GPU readback)</span>
                </label>
            </div>

            <div id="debug-output" style="background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 12px; height: calc(100vh - 450px); overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;"></div>
        `,e.appendChild(t),this.debugToggle=t.querySelector("#debug-toggle"),this.debugVerbosity=t.querySelector("#debug-verbosity"),this.debugOutput=t.querySelector("#debug-output"),this.bufferSizeSpan=t.querySelector("#buffer-size"),this.bufferPercentSpan=t.querySelector("#buffer-percent"),this.bufferStatusDiv=t.querySelector("#debug-buffer-status"),this._setupEventListeners(t),this.logger.setEnabled(this.debugToggle.checked);let i=this.debugVerbosity.value;return this.logger.setVerbosity(i),i==="silent"&&(this.bufferStatusDiv.style.display="block",this._updateBufferStatus()),this.logger.setOutputElement(this.debugOutput),t}_setupEventListeners(e){this.debugToggle.addEventListener("change",()=>{this.logger.setEnabled(this.debugToggle.checked),this.logger.info("Debug logging "+(this.debugToggle.checked?"enabled":"disabled"))}),this.debugVerbosity.addEventListener("change",()=>{let t=this.debugVerbosity.value;this.logger.setVerbosity(t),this.logger.info("Verbosity set to: "+t),t==="silent"?(this.bufferStatusDiv.style.display="block",this._updateBufferStatus()):this.bufferStatusDiv.style.display="none"}),e.querySelector("#debug-copy").addEventListener("click",()=>{let t=this.logger.getLogs(),i=`N-Dimensional Vector Field Renderer - Debug Log
`;i+="=".repeat(60)+`

`;for(let r of t){if(i+=`[${r.timestamp}] [${r.level.toUpperCase()}] ${r.message}`,r.data){let n=typeof r.data=="object"?JSON.stringify(r.data):String(r.data);i+=` | Data: ${n}`}r.stack&&(i+=`
Stack Trace:
${r.stack}`),i+=`
`}navigator.clipboard.writeText(i).then(()=>{this.logger.info("Log copied to clipboard ("+t.length+" entries)")}).catch(r=>{this.logger.error("Failed to copy log to clipboard",r)})}),e.querySelector("#debug-clear").addEventListener("click",()=>{this.logger.clear()}),e.querySelector("#debug-flush-buffer").addEventListener("click",()=>{this.logger.flush(),this._updateBufferStatus()}),e.querySelector("#debug-clear-buffer").addEventListener("click",()=>{this.logger.clearSilencedBuffer(),this._updateBufferStatus()}),e.querySelector("#debug-log-update-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logUpdateShader=="function"?window.renderer.logUpdateShader():this.logger.warn("Renderer not initialized - cannot log update shader")}),e.querySelector("#debug-log-draw-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logDrawShader=="function"?window.renderer.logDrawShader():this.logger.warn("Renderer not initialized - cannot log draw shader")}),e.querySelector("#debug-log-screen-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logScreenShader=="function"?window.renderer.logScreenShader():this.logger.warn("Renderer not initialized - cannot log screen shader")}),e.querySelector("#debug-log-stats-shaders").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logStatsShaders=="function"?window.renderer.logStatsShaders():this.logger.warn("Renderer not initialized - cannot log stats shaders")}),e.querySelector("#debug-buffer-stats").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logBufferStats=="function"?window.renderer.logBufferStats():this.logger.warn("Renderer not initialized - cannot log buffer stats")}),e.querySelector("#debug-enable-stats").addEventListener("change",t=>{if(window.renderer){let i=t.target.checked;window.renderer.enableDebugStats=i,this.logger.info(`GPU debug stats ${i?"ENABLED":"DISABLED"}`)}})}_updateBufferStatus(){let e=this.logger.getBufferStats();this.bufferSizeSpan.textContent=e.bufferSize,this.bufferPercentSpan.textContent=e.bufferUsagePercent,e.bufferUsagePercent>80?this.bufferSizeSpan.style.color="#EF5350":e.bufferUsagePercent>50?this.bufferSizeSpan.style.color="#FFA726":this.bufferSizeSpan.style.color="#4CAF50"}onActivate(){this._bufferUpdateInterval||(this._bufferUpdateInterval=setInterval(()=>{this.logger.isSilenced()&&this._isActive&&this._updateBufferStatus()},1e3))}onDeactivate(){this._bufferUpdateInterval&&(clearInterval(this._bufferUpdateInterval),this._bufferUpdateInterval=null)}destroy(){this._bufferUpdateInterval&&(clearInterval(this._bufferUpdateInterval),this._bufferUpdateInterval=null),super.destroy()}};var dt=class extends te{constructor(){super("docs","Documentation"),this.sections=[],this.sectionDefinitions=[{id:"display-options",title:"Display Options & UI Controls",file:"docs/display-options.md"},{id:"vector-fields",title:"Vector Fields",file:"docs/vector-fields.md"},{id:"integrators",title:"Integration Methods",file:"docs/integrators.md"},{id:"color-modes",title:"Color Modes",file:"docs/color-modes.md"},{id:"projection",title:"2D Projection",file:"docs/projection.md"},{id:"coordinate-systems",title:"Coordinate Systems",file:"docs/coordinate-systems.md"},{id:"domain-transforms",title:"Domain Transforms",file:"docs/domain-transforms.md"},{id:"hdr-rendering",title:"HDR & Tone Mapping",file:"docs/hdr-rendering.md"},{id:"rendering-effects",title:"Rendering Effects",file:"docs/rendering-effects.md"},{id:"particle-settings",title:"Particle Settings",file:"docs/particle-settings.md"},{id:"animation",title:"Animation System",file:"docs/animation.md"},{id:"preset-management",title:"Preset Management",file:"docs/preset-management.md"},{id:"storage-strategy",title:"Storage Strategy",file:"docs/storage-strategy.md"},{id:"keyboard-shortcuts",title:"Keyboard Shortcuts",file:"docs/keyboard-shortcuts.md"}]}async _loadMarkdown(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.statusText}`);let i=await t.text();return typeof marked>"u"?(console.error("marked.js not loaded"),"<p>Error: Markdown parser not available</p>"):marked.parse(i)}catch(t){return console.error("Error loading markdown:",t),`<p>Error loading documentation: ${t.message}</p>`}}render(e){let t=document.createElement("div");return t.id="docs-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div class="docs-container">
                <p style="text-align: center; padding: 40px; color: #888;">Loading documentation...</p>
            </div>
        `,e.appendChild(t),this._loadAllSections(t),t}async _loadAllSections(e){let t=e.querySelector(".docs-container"),i=this.sectionDefinitions.map(async s=>{let a=await this._loadMarkdown(s.file);return{id:s.id,title:s.title,html:a}}),n=(await Promise.all(i)).map(s=>this._renderSection(s.id,s.title,s.html)).join("");t.innerHTML=n,this._setupCollapsibles(e),this._pendingSection&&(this.openToSection(this._pendingSection),this._pendingSection=null)}_renderSection(e,t,i){return`
            <div class="docs-section collapsed" id="docs-${e}">
                <div class="docs-section-header">
                    <h3>${t}</h3>
                    <span class="docs-toggle">\u25B6</span>
                </div>
                <div class="docs-section-content" style="max-height: 0;">
                    ${i}
                </div>
            </div>
        `}_setupCollapsibles(e){e.querySelectorAll(".docs-section-header").forEach(i=>{i.addEventListener("click",()=>{let r=i.parentElement,n=r.querySelector(".docs-section-content"),s=i.querySelector(".docs-toggle");r.classList.contains("collapsed")?(r.classList.remove("collapsed"),n.style.maxHeight="5000px",s.textContent="\u25BC",setTimeout(()=>{r.classList.contains("collapsed")||(n.style.maxHeight=n.scrollHeight+"px")},350)):(r.classList.add("collapsed"),n.style.maxHeight="0",s.textContent="\u25B6")})})}openToSection(e){if(!this._contentElement)return;let t=this._contentElement.querySelector(`#docs-${e}`);if(!t){console.warn(`Documentation section '${e}' not found`);return}t.classList.contains("collapsed")&&t.querySelector(".docs-section-header").click(),setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"start"})},400)}onActivate(){this._pendingSection&&(this.openToSection(this._pendingSection),this._pendingSection=null)}setPendingSection(e){this._pendingSection=e}};ne();fe();ne();var Ie=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:1,minValue:.01,maxValue:100}),this._displayFormat=null,this.sliderInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Value",this.minValue=this.getNumberAttribute("min-value",.01),this.maxValue=this.getNumberAttribute("max-value",100),this.transform=this.getNumberAttribute("transform",1),this.curve=this.getNumberAttribute("curve",1),this.defaultValue=this.getNumberAttribute("default",1);let e=this.getAttribute("display-format");if(e!==null){let t=parseInt(e);this._displayFormat=i=>i!=null?i.toFixed(t):"0"}else this._displayFormat=t=>t!=null?t.toFixed(3):"0";this.value=this.defaultValue}formatValue(e){return this._displayFormat&&typeof e=="number"?this._displayFormat(e):super.formatValue(e)}linearToLog(e){let t=e/100,r=Math.pow(t,this.curve)*100,n=Math.log(this.minValue),a=(Math.log(this.maxValue)-n)/100;return Math.exp(n+a*r)}logToLinear(e){let t=Math.log(this.minValue),r=(Math.log(this.maxValue)-t)/100,s=(Math.log(e)-t)/r/100;return Math.pow(s,1/this.curve)*100}attachInternalListeners(){if(this.sliderInput=this.findByRole("slider",'input[type="range"]'),!this.sliderInput)return;let e=()=>{let t=parseFloat(this.sliderInput.value);this.value=this.linearToLog(t)/this.transform,this.triggerChange()};this.addInputListener(this.sliderInput,e),this.sliderInput.addEventListener("change",e),this.sliderInput.addEventListener("click",t=>{e()}),this.registerActionButtons(["decrease","increase","decrease-large","increase-large","reset"])}getValue(){if(this.sliderInput){let e=parseFloat(this.sliderInput.value);return this.linearToLog(e)/this.transform}return this.value}setValue(e){if(this.value=e,this.sliderInput){let t=this.logToLinear(e*this.transform);this.sliderInput.value=t}}handleButtonAction(e){if(!this.sliderInput)return!1;let t=parseFloat(this.sliderInput.value),i=t,r=1;if((e==="increase-large"||e==="decrease-large")&&(r=10),e==="increase"||e==="increase-large")i=Math.min(100,t+r);else if(e==="decrease"||e==="decrease-large")i=Math.max(0,t-r);else if(e==="reset")i=this.logToLinear(this.defaultValue);else return!1;return i!==t?(this.sliderInput.value=i,this.value=this.linearToLog(i)/this.transform,this.triggerChange(),!0):!1}};fe();var le=class extends Y{constructor(){super(),this.transform=100,this._displayMultiplier=100,this._displaySuffix="%"}initializeProperties(){super.initializeProperties(),this.transform=100,this.hasAttribute("display-multiplier")||(this._displayMultiplier=100),this.hasAttribute("display-suffix")||(this._displaySuffix="%")}};Be();Be();var De=class extends oe{constructor(){super(),this.smallIncrement=.001,this.largeIncrement=.01}initializeProperties(){super.initializeProperties();let e=this.getAttribute("small-increment"),t=this.getAttribute("large-increment");e!==null&&(this.smallIncrement=parseFloat(e)),t!==null&&(this.largeIncrement=parseFloat(t))}handleButtonAction(e){let t=this.getValue(),i=this.min||0,r=this.max||100,n;if(e==="increase"||e==="decrease")n=this.smallIncrement;else if(e==="increase-large"||e==="decrease-large")n=this.largeIncrement;else if(e==="reset"){let a=this.defaultValue;return a!==t?(this.setValue(a),this.triggerChange(),!0):!1}else return!1;let s=t;return e==="increase"||e==="increase-large"?s=Math.min(r,t+n):(e==="decrease"||e==="decrease-large")&&(s=Math.max(i,t-n)),s!==t?(this.setValue(s),this.triggerChange(),!0):!1}};var ge=class extends le{constructor(){super(),this._controller=null,this._animateButton=null,this._isAnimating=!1}setController(e){this._controller=e,this._controller&&this._controller.onAlphaChanged(t=>{this.value=t,this.sliderInput&&(this.sliderInput.value=t*this.transform)})}connectedCallback(){super.connectedCallback(),this._renderAnimateButton()}_renderAnimateButton(){let e=this.querySelector(".slider-control");if(!e){console.warn("AnimationAlpha: No .slider-control found in template");return}this._animateButton=document.createElement("button"),this._animateButton.className="slider-btn",this._animateButton.style.marginLeft="8px",this._animateButton.style.background="#4CAF50",this._animateButton.style.color="white",this._animateButton.title="Auto-animate",this._animateButton.textContent="\u25B6",this._animateButton.addEventListener("click",t=>{t.stopPropagation(),this._handleAnimateClick()}),e.appendChild(this._animateButton)}_handleAnimateClick(){if(!this._controller){console.warn("AnimationAlpha: No controller set");return}this._isAnimating?(this._controller.stop(),this._isAnimating=!1,this._animateButton.textContent="\u25B6",this._animateButton.style.background="#4CAF50",this._animateButton.title="Auto-animate"):(this._controller.start(),this._isAnimating=!0,this._animateButton.textContent="\u23F8",this._animateButton.style.background="#FFA726",this._animateButton.title="Stop auto-animate")}_handleValueChange(){super._handleValueChange(),this._controller&&!this._isAnimating&&this._controller.setAlpha(this.value)}};customElements.define("animation-alpha",ge);fe();var be=class extends Y{constructor(){super(),this._controller=null}setController(e){this._controller=e,this._controller&&this.value&&this._controller.setSpeed(this.value)}attachInternalListeners(){super.attachInternalListeners(),this.addEventListener("change",()=>{this._controller&&this._controller.setSpeed(this.value)})}saveToSettings(e){}restoreFromSettings(e){}};customElements.define("animation-speed",be);ne();var xe=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:100}),this.numberInput=null,this._min=1,this._max=1e4}initializeProperties(){this.label=this.getAttribute("label")||"Value",this._min=this.getNumberAttribute("min",1),this._max=this.getNumberAttribute("max",1e4),this.defaultValue=this.getNumberAttribute("default",100),this.value=this.defaultValue}attachInternalListeners(){this.numberInput=this.findByRole("input",'input[type="number"]'),this.numberInput&&(this.numberInput.setAttribute("min",this._min),this.numberInput.setAttribute("max",this._max),this.addInputListener(this.numberInput,()=>{let e=parseInt(this.numberInput.value);this.value=isNaN(e)?this.defaultValue:Math.max(this._min,Math.min(this._max,e)),this.triggerChange()}))}getValue(){if(this.numberInput){let e=parseInt(this.numberInput.value);return isNaN(e)?this.defaultValue:Math.max(this._min,Math.min(this._max,e))}return this.value}setValue(e){let t=typeof e=="number"?e:parseInt(e);this.value=isNaN(t)?this.defaultValue:Math.max(this._min,Math.min(this._max,t)),this.numberInput&&(this.numberInput.value=this.value)}reset(){this.setValue(this.defaultValue),this.triggerChange()}saveToSettings(e){}restoreFromSettings(e){}};customElements.define("number-input",xe);var ye=class extends HTMLElement{constructor(){super(),this._label="Action",this._icon="",this._enabled=!0,this._loading=!1,this._button=null}connectedCallback(){this._label=this.getAttribute("label")||"Action",this._icon=this.getAttribute("icon")||"",this._button=document.createElement("button"),this._button.className="action-btn",this._updateButtonText(),this._button.addEventListener("click",e=>{this._enabled&&!this._loading&&this.dispatchEvent(new CustomEvent("action",{bubbles:!0}))}),this.appendChild(this._button)}_updateButtonText(){if(!this._button)return;let e=this._icon?`${this._icon} ${this._label}`:this._label;this._button.textContent=e}setLabel(e){this._label=e,this._updateButtonText()}setIcon(e){this._icon=e,this._updateButtonText()}setEnabled(e){this._enabled=e,this._button&&(this._button.disabled=!e)}setLoading(e,t=null){if(this._loading=e,this._button)if(this._button.disabled=e,e&&t){let i=this._label;this._label=t,this._updateButtonText(),this._originalLabel=i}else!e&&this._originalLabel&&(this._label=this._originalLabel,this._updateButtonText(),delete this._originalLabel)}setStyle(e){this._button&&(this._button.style.background=e)}isEnabled(){return this._enabled&&!this._loading}isLoading(){return this._loading}};customElements.define("action-button",ye);ne();var ve=class extends H{constructor(){super(),this.createReactiveProperties({label:"Checkbox",checked:!1}),this.checkboxInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Checkbox",this.defaultValue=this.getBooleanAttribute("default",!1),this.checked=this.defaultValue}attachInternalListeners(){this.checkboxInput=this.findByRole("checkbox",'input[type="checkbox"]'),this.checkboxInput||(this._createDefaultTemplate(),this.checkboxInput=this.querySelector('input[type="checkbox"]')),this.checkboxInput&&(this.checkboxInput.checked=this.checked,this.checkboxInput.addEventListener("change",()=>{this.checked=this.checkboxInput.checked,this.triggerChange(),this.dispatchEvent(new Event("change",{bubbles:!0}))}))}_createDefaultTemplate(){let e=document.createElement("label");e.style.cssText="display: flex; align-items: center; cursor: pointer; padding: 4px 0;";let t=document.createElement("input");t.type="checkbox",t.style.marginRight="8px";let i=document.createElement("span");i.textContent=this.label,e.appendChild(t),e.appendChild(i),this.appendChild(e)}getValue(){return this.checkboxInput?this.checkboxInput.checked:this.checked}setValue(e){this.checked=!!e,this.checkboxInput&&(this.checkboxInput.checked=this.checked)}set disabled(e){this.checkboxInput&&(this.checkboxInput.disabled=e)}get disabled(){return this.checkboxInput?this.checkboxInput.disabled:!1}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};customElements.define("check-box",ve);ne();var _e=class extends H{constructor(){super(),this.selectElement=null}initializeProperties(){this.defaultValue=this.getAttribute("default")||null}attachInternalListeners(){if(this.selectElement=this.querySelector("select"),this.selectElement||(this._wrapOptionsInSelect(),this.selectElement=this.querySelector("select")),!!this.selectElement){if(!this.defaultValue){let e=this.selectElement.querySelector("option[selected]");if(e)this.defaultValue=e.value;else{let t=this.selectElement.querySelector("option");t&&(this.defaultValue=t.value)}}this.defaultValue&&(this.selectElement.value=this.defaultValue),this.selectElement.addEventListener("change",()=>{this.triggerChange(),this.dispatchEvent(new Event("change",{bubbles:!0}))})}}_wrapOptionsInSelect(){let e=this.querySelectorAll(":scope > option, :scope > optgroup");if(e.length===0)return;let t=document.createElement("select");for(let i of Array.from(e))t.appendChild(i);this.appendChild(t)}getValue(){return this.selectElement?this.selectElement.value:this.defaultValue}setValue(e){this.selectElement&&(this.selectElement.value=e)}set disabled(e){this.selectElement&&(this.selectElement.disabled=e)}get disabled(){return this.selectElement?this.selectElement.disabled:!1}getSelectedText(){return this.selectElement&&this.selectElement.selectedOptions.length>0?this.selectElement.selectedOptions[0].text:""}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};customElements.define("select-control",_e);ne();st();var ht=class extends Pe(H,Kt,Jt){constructor(){super(),this._defaultValue={timestep:.01,frameLimitEnabled:!0,frameLimit:200},this._timestepCurve=.4,this._fps="--",this._timestep=this._defaultValue.timestep,this._timestepLog=Math.log10(this._timestep),this._frameLimitEnabled=this._defaultValue.frameLimitEnabled,this._frameLimit=this._defaultValue.frameLimit}static get observedAttributes(){return["settings-key","default-timestep","default-frame-limit","default-frame-limit-enabled"]}initializeProperties(){this.hasAttribute("default-timestep")&&(this._defaultValue.timestep=parseFloat(this.getAttribute("default-timestep")),this._timestep=this._defaultValue.timestep,this._timestepLog=Math.log10(this._timestep)),this.hasAttribute("default-frame-limit")&&(this._defaultValue.frameLimit=parseInt(this.getAttribute("default-frame-limit")),this._frameLimit=this._defaultValue.frameLimit),this.hasAttribute("default-frame-limit-enabled")&&(this._defaultValue.frameLimitEnabled=this.getAttribute("default-frame-limit-enabled")==="true",this._frameLimitEnabled=this._defaultValue.frameLimitEnabled)}connectedCallback(){this._initialized||(this.initializeControlProperties(),this.initializeProperties(),this.render(),this.initializeChildren(),this.attachInternalListeners(),this.updateTheme(),this._themeObserver=new MutationObserver(()=>this.updateTheme()),this._themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]}),this._initialized=!0)}initializeChildren(){this.registerChildControl("timestep",()=>this._timestep,e=>this.setTimestep(e),()=>this.setTimestep(this._defaultValue.timestep)),this.registerChildControl("frameLimitEnabled",()=>this._frameLimitEnabled,e=>this.setFrameLimitEnabled(e),()=>this.setFrameLimitEnabled(this._defaultValue.frameLimitEnabled)),this.registerChildControl("frameLimit",()=>this._frameLimit,e=>this.setFrameLimit(e),()=>this.setFrameLimit(this._defaultValue.frameLimit))}disconnectedCallback(){this._themeObserver&&this._themeObserver.disconnect()}updateTheme(){document.body.classList.contains("light-theme")?this.classList.add("light-theme"):this.classList.remove("light-theme")}render(){this.renderToShadow(`
            <style>
                :host {
                    display: block;
                }

                .container {
                    background: rgba(30, 30, 30, 0.9);
                    border: 1px solid #444;
                    border-radius: 4px;
                    padding: 6px 8px;
                    font-size: 10px;
                    color: #4CAF50;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                }

                :host(.light-theme) .container {
                    background: rgba(255, 255, 255, 0.9);
                    border-color: #ccc;
                    color: #2E7D32;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                }

                .fps-display {
                    text-align: right;
                    font-weight: bold;
                    margin-bottom: 3px;
                    font-size: 10px;
                }

                .controls-grid {
                    display: grid;
                    grid-template-columns: 1fr 1px 1fr;
                    gap: 6px;
                    align-items: start;
                }

                .divider {
                    width: 1px;
                    height: 100%;
                    background: #444;
                    justify-self: center;
                }

                :host(.light-theme) .divider {
                    background: #ccc;
                }

                /* Timestep section */
                .timestep-section {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                    min-width: 0; /* Allow grid to shrink this properly */
                }

                .timestep-label {
                    font-size: 11px;
                    font-weight: bold;
                    text-align: center;
                    /* Inherits color from .container (#4CAF50 or #2E7D32) */
                }

                .timestep-controls {
                    display: flex;
                    align-items: center;
                    gap: 3px;
                }

                .btn {
                    padding: 0px 4px;
                    font-size: 11px;
                    min-width: 20px;
                    height: 20px;
                    line-height: 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid #555;
                    border-radius: 2px;
                    color: #fff;
                    cursor: pointer;
                    flex-shrink: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .btn:active {
                    background: rgba(255, 255, 255, 0.2);
                }

                :host(.light-theme) .btn {
                    background: rgba(0, 0, 0, 0.05);
                    border-color: #bbb;
                    color: #333;
                }

                :host(.light-theme) .btn:active {
                    background: rgba(0, 0, 0, 0.1);
                }

                .timestep-slider {
                    flex: 1;
                    min-width: 0;
                }

                /* Frame limit section */
                .frame-limit-section {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                    min-width: 0; /* Allow grid to shrink this properly */
                }

                .frame-limit-header {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }

                .frame-limit-label {
                    color: #aaa;
                    font-size: 11px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    cursor: pointer;
                    user-select: none;
                }

                :host(.light-theme) .frame-limit-label {
                    color: #666;
                }

                .frame-limit-checkbox {
                    margin: 0;
                    cursor: pointer;
                }

                .frame-limit-value {
                    color: #4CAF50;
                    font-weight: bold;
                    font-size: 10px;
                    margin-left: auto;
                }

                :host(.light-theme) .frame-limit-value {
                    color: #2E7D32;
                }

                .frame-limit-slider {
                    width: 100%;
                }

                /* Slider styling */
                input[type="range"] {
                    -webkit-appearance: none;
                    appearance: none;
                    background: transparent;
                    cursor: pointer;
                }

                input[type="range"]::-webkit-slider-track {
                    background: #333;
                    height: 6px;
                    border-radius: 3px;
                }

                :host(.light-theme) input[type="range"]::-webkit-slider-track {
                    background: #ddd;
                }

                input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 14px;
                    height: 14px;
                    border-radius: 50%;
                    background: #4CAF50;
                    cursor: pointer;
                    margin-top: -4px;
                }

                :host(.light-theme) input[type="range"]::-webkit-slider-thumb {
                    background: #2E7D32;
                }

                input[type="range"]::-moz-range-track {
                    background: #333;
                    height: 6px;
                    border-radius: 3px;
                }

                :host(.light-theme) input[type="range"]::-moz-range-track {
                    background: #ddd;
                }

                input[type="range"]::-moz-range-thumb {
                    width: 14px;
                    height: 14px;
                    border: none;
                    border-radius: 50%;
                    background: #4CAF50;
                    cursor: pointer;
                }

                :host(.light-theme) input[type="range"]::-moz-range-thumb {
                    background: #2E7D32;
                }
            </style>

            <div class="container">
                <div class="fps-display">FPS: ${this._fps}</div>

                <div class="controls-grid">
                <!-- Timestep section -->
                <div class="timestep-section">
                    <div class="timestep-label">Time Step: <span id="timestep-value">${this._timestep.toFixed(4)}</span></div>
                    <div class="timestep-controls">
                        <button class="btn" id="timestep-decrease">-</button>
                        <input type="range" class="timestep-slider" id="timestep-slider"
                               min="-3" max="0.4" step="0.01" value="${this.timestepLogToSlider(this._timestepLog)}">
                        <button class="btn" id="timestep-increase">+</button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="divider"></div>

                <!-- Frame limit section -->
                <div class="frame-limit-section">
                    <div class="frame-limit-header">
                        <label class="frame-limit-label" for="frame-limit-checkbox">
                            <input type="checkbox" class="frame-limit-checkbox" id="frame-limit-checkbox" ${this._frameLimitEnabled?"checked":""}>
                            Stop at:
                        </label>
                        <span class="frame-limit-value" id="frame-limit-value">${Math.round(this._frameLimit)}</span>
                    </div>
                    <input type="range" class="frame-limit-slider" id="frame-limit-slider"
                           min="0" max="100" step="1" value="${this.frameToSlider(this._frameLimit)}">
                </div>
            </div>
            </div>
        `)}attachInternalListeners(){let e=this.querySelector("#timestep-slider"),t=this.querySelector("#timestep-value"),i=this.querySelector("#timestep-decrease"),r=this.querySelector("#timestep-increase");e.addEventListener("input",()=>{let l=parseFloat(e.value);this._timestepLog=this.sliderToTimestepLog(l),this._timestep=Math.pow(10,this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)}),i.addEventListener("click",()=>{let l=Math.pow(10,-3);this._timestep=Math.max(l,this._timestep*.98),this._timestepLog=Math.log10(this._timestep),e.value=this.timestepLogToSlider(this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)}),r.addEventListener("click",()=>{let l=Math.pow(10,.4);this._timestep=Math.min(l,this._timestep*1.02),this._timestepLog=Math.log10(this._timestep),e.value=this.timestepLogToSlider(this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)});let n=this.querySelector("#frame-limit-checkbox"),s=this.querySelector("#frame-limit-slider"),a=this.querySelector("#frame-limit-value");n.addEventListener("change",()=>{this._frameLimitEnabled=n.checked,this.triggerChange(),this.onFrameLimitEnabledChange&&this.onFrameLimitEnabledChange(this._frameLimitEnabled)}),s.addEventListener("input",()=>{let l=parseFloat(s.value);this._frameLimit=this.sliderToFrame(l),a.textContent=Math.round(this._frameLimit),this.triggerChange(),this.onFrameLimitChange&&this.onFrameLimitChange(this._frameLimit)})}frameToSlider(e){return Math.log10(Math.max(1,e))/Math.log10(1e5)*100}sliderToFrame(e){return Math.round(Math.pow(10,e/100*Math.log10(1e5)))}sliderToTimestepLog(e){let n=(e- -3)/3.4;return-3+Math.pow(n,this._timestepCurve)*3.4}timestepLogToSlider(e){let n=(e- -3)/3.4;return-3+Math.pow(n,1/this._timestepCurve)*3.4}setFPS(e){if(this._fps=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector(".fps-display");t&&(t.textContent=`FPS: ${e}`)}setTimestep(e){if(this._timestep=e,this._timestepLog=Math.log10(e),!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#timestep-slider"),i=this.shadowRoot.querySelector("#timestep-value");t&&(t.value=this.timestepLogToSlider(this._timestepLog)),i&&(i.textContent=e.toFixed(4))}setFrameLimitEnabled(e){if(this._frameLimitEnabled=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#frame-limit-checkbox");t&&(t.checked=e)}setFrameLimit(e){if(this._frameLimit=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#frame-limit-slider"),i=this.shadowRoot.querySelector("#frame-limit-value");t&&(t.value=this.frameToSlider(e)),i&&(i.textContent=Math.round(e))}getTimestep(){return this._timestep}getFrameLimitEnabled(){return this._frameLimitEnabled}getFrameLimit(){return this._frameLimit}};customElements.define("mobile-controls",ht);fe();Be();function pr(){customElements.get("linear-slider")||customElements.define("linear-slider",Y),customElements.get("log-slider")||customElements.define("log-slider",Ie),customElements.get("percent-slider")||customElements.define("percent-slider",le),customElements.get("animatable-slider")||customElements.define("animatable-slider",oe),customElements.get("animatable-timestep")||customElements.define("animatable-timestep",De),customElements.get("animation-alpha")||customElements.define("animation-alpha",ge),customElements.get("animation-speed")||customElements.define("animation-speed",be),customElements.get("number-input")||customElements.define("number-input",xe),customElements.get("action-button")||customElements.define("action-button",ye),customElements.get("check-box")||customElements.define("check-box",ve),customElements.get("select-control")||customElements.define("select-control",_e)}window.MathParser={setCustomFunctions:ni,getCustomFunctions:oi};pr();$(document).ready(function(){window.logger=c,c.hookConsole(),c.info("Logger initialized");function o(a){let l=document.getElementById("canvas"),u=null;function d(){if(l.width=window.innerWidth,l.height=window.innerHeight,u){u.resize(l.width,l.height);let h=l.width/l.height,p=u.bbox,m=(p.min[0]+p.max[0])/2,f=(p.min[1]+p.max[1])/2,x=(p.max[1]-p.min[1])*h;p.min[0]=m-x/2,p.max[0]=m+x/2,u.updateConfig({bbox:p})}}d(),window.addEventListener("resize",d);try{let p=new URLSearchParams(window.location.search).get("storage")||"float";u=new Ke(l,{storageStrategy:p}),a(u,l)}catch(h){c.error("Failed to initialize renderer",h),alert("Failed to initialize WebGL renderer: "+(h.message||h))}}function e(a,l){let u=dr(a,function(d){let{manager:h,state:p,saveSettings:m}=d,f=h.getSettings();a.updateConfig(f),a.start(),n(a,h),window.renderer=a,window.loadPreset=ot,window.logger=c,window.saveSettings=m,window.manager=h;let b=mr(),x=new ut(c);b.registerTab(x);let g=h.debouncedApply.bind(h),y=new ct(window.MathParser,g);b.registerTab(y);let _=new dt;b.registerTab(_),window.appModal=b,c.info("N-Dimensional Vector Field Renderer initialized!"),c.info("Available presets: "+Object.keys(window.presets).join(", ")),c.info('Try: loadPreset("3d_lorenz")')})}function t(a,l){let u=!1,d=0,h=0,p=null;function m(){p&&clearTimeout(p),p=setTimeout(()=>{window.saveSettings&&window.saveSettings()},500)}l.addEventListener("mousedown",g=>{g.target===l&&(u=!0,d=g.clientX,h=g.clientY)}),l.addEventListener("mousemove",g=>{if(u){let y=g.clientX-d,_=g.clientY-h,E=a.bbox,R=E.max[0]-E.min[0],w=E.max[1]-E.min[1],S=R/l.width;E.min[0]-=y*S,E.max[0]-=y*S,E.min[1]+=_*S,E.max[1]+=_*S,a.updateConfig({bbox:E}),d=g.clientX,h=g.clientY}}),l.addEventListener("mouseup",()=>{u=!1,m()}),l.addEventListener("mouseleave",()=>{u=!1,u||m()}),l.addEventListener("wheel",g=>{g.preventDefault();let y=g.deltaY>0?1.1:.9,_=l.getBoundingClientRect(),E=g.clientX-_.left,R=g.clientY-_.top,w=a.bbox,S=w.max[0]-w.min[0],M=w.max[1]-w.min[1],B=w.min[0]+S*(E/l.width),v=w.max[1]-M*(R/l.height),F=M*y,A=l.width/l.height,L=F*A,T=(B-w.min[0])/S,C=(w.max[1]-v)/M;w.min[0]=B-L*T,w.max[0]=B+L*(1-T),w.min[1]=v-F*(1-C),w.max[1]=v+F*C,a.updateConfig({bbox:w}),m()});let f=0;l.addEventListener("touchstart",g=>{if(g.touches.length===1)u=!0,d=g.touches[0].clientX,h=g.touches[0].clientY;else if(g.touches.length===2){u=!1;let y=g.touches[1].clientX-g.touches[0].clientX,_=g.touches[1].clientY-g.touches[0].clientY;f=Math.sqrt(y*y+_*_)}g.preventDefault()}),l.addEventListener("touchmove",g=>{if(g.touches.length===1&&u){let y=g.touches[0].clientX-d,_=g.touches[0].clientY-h,E=a.bbox,R=E.max[0]-E.min[0],w=E.max[1]-E.min[1],S=R/l.width;E.min[0]-=y*S,E.max[0]-=y*S,E.min[1]+=_*S,E.max[1]+=_*S,a.updateConfig({bbox:E}),d=g.touches[0].clientX,h=g.touches[0].clientY}else if(g.touches.length===2){let y=g.touches[1].clientX-g.touches[0].clientX,_=g.touches[1].clientY-g.touches[0].clientY,E=Math.sqrt(y*y+_*_);if(f>0){let R=f/E,w=a.bbox,S=w.max[1]-w.min[1],M=(w.min[0]+w.max[0])/2,B=(w.min[1]+w.max[1])/2,v=S*R,F=l.width/l.height,A=v*F;w.min[0]=M-A/2,w.max[0]=M+A/2,w.min[1]=B-v/2,w.max[1]=B+v/2,a.updateConfig({bbox:w})}f=E}g.preventDefault()}),l.addEventListener("touchend",()=>{u=!1,f=0,m()});function b(g){let y=a.bbox,_=y.max[0]-y.min[0],E=y.max[1]-y.min[1],R=(y.min[0]+y.max[0])/2,w=(y.min[1]+y.max[1])/2,S=E*g,M=l.width/l.height,B=S*M;y.min[0]=R-B/2,y.max[0]=R+B/2,y.min[1]=w-S/2,y.max[1]=w+S/2,a.updateConfig({bbox:y}),m()}function x(g,y){let _=a.bbox,E=_.max[0]-_.min[0],R=_.max[1]-_.min[1],w=E*g*.1,S=R*y*.1;_.min[0]+=w,_.max[0]+=w,_.min[1]+=S,_.max[1]+=S,a.updateConfig({bbox:_}),m()}$("#zoom-in").on("click",()=>b(.9)),$("#zoom-out").on("click",()=>b(1.11)),$("#pan-up").on("click",()=>x(0,1)),$("#pan-down").on("click",()=>x(0,-1)),$("#pan-left").on("click",()=>x(-1,0)),$("#pan-right").on("click",()=>x(1,0)),$("#pan-up-left").on("click",()=>x(-1,1)),$("#pan-up-right").on("click",()=>x(1,1)),$("#pan-down-left").on("click",()=>x(-1,-1)),$("#pan-down-right").on("click",()=>x(1,-1)),$("#pan-reset").on("click",function(){let g=a.bbox,y=g.max[0]-g.min[0],_=g.max[1]-g.min[1];a.updateConfig({bbox:{min:[-y/2,-_/2],max:[y/2,_/2]},reinitializeParticles:!1}),m()}),$("#mobile-zoom-in").on("click",()=>b(.9)),$("#mobile-zoom-out").on("click",()=>b(1.11)),$("#mobile-center").on("click",function(){let g=a.bbox,y=g.max[0]-g.min[0],_=g.max[1]-g.min[1];a.updateConfig({bbox:{min:[-y/2,-_/2],max:[y/2,_/2]},reinitializeParticles:!1}),m()})}function i(a,l){let u=document.getElementById("grid-canvas"),d=u.getContext("2d"),h=$("#cursor-position"),p=document.getElementById("show-grid"),m=p?.getValue?p.getValue():!0,f=0,b=0;function x(){u.width=l.width,u.height=l.height,E()}function g(T,C){let P=a.bbox,U=P.max[0]-P.min[0],V=P.max[1]-P.min[1],O=P.min[0]+T/l.width*U,D=P.max[1]-C/l.height*V;return{x:O,y:D}}function y(T,C){let P=a.bbox,U=P.max[0]-P.min[0],V=P.max[1]-P.min[1],O=(T-P.min[0])/U*l.width,D=(P.max[1]-C)/V*l.height;return{x:O,y:D}}function _(){let T=a.bbox,U=(T.max[0]-T.min[0])/10,V=Math.pow(10,Math.floor(Math.log10(U))),O=U/V,D;return O<1.5?D=1*V:O<3.5?D=2*V:O<7.5?D=5*V:D=10*V,D}function E(){if(!m){d.clearRect(0,0,u.width,u.height);return}d.clearRect(0,0,u.width,u.height);let T=a.bbox,C=_(),P=Math.floor(T.min[0]/C)*C,U=Math.ceil(T.max[0]/C)*C;d.strokeStyle="rgba(255, 255, 255, 0.1)",d.lineWidth=1,d.font="10px Courier New",d.fillStyle="rgba(255, 255, 255, 0.5)";for(let N=P;N<=U;N+=C){let q=y(N,0);if(d.beginPath(),d.moveTo(q.x,0),d.lineTo(q.x,u.height),d.stroke(),Math.abs(N)<1e-4)continue;let Ee=N.toFixed(Math.max(0,-Math.floor(Math.log10(C))));d.fillText(Ee,q.x+3,u.height-5)}let V=Math.floor(T.min[1]/C)*C,O=Math.ceil(T.max[1]/C)*C;for(let N=V;N<=O;N+=C){let q=y(0,N);if(d.beginPath(),d.moveTo(0,q.y),d.lineTo(u.width,q.y),d.stroke(),Math.abs(N)<1e-4)continue;let Ee=N.toFixed(Math.max(0,-Math.floor(Math.log10(C))));d.fillText(Ee,5,q.y-3)}let D=y(0,0);d.strokeStyle="rgba(255, 255, 255, 0.3)",d.lineWidth=2,D.y>=0&&D.y<=u.height&&(d.beginPath(),d.moveTo(0,D.y),d.lineTo(u.width,D.y),d.stroke(),d.fillText("0",D.x+3,D.y-3)),D.x>=0&&D.x<=u.width&&(d.beginPath(),d.moveTo(D.x,0),d.lineTo(D.x,u.height),d.stroke())}function R(){let T=g(f,b),C=l.getBoundingClientRect(),P=f-C.left,U=b-C.top,V=a.readPixelAt(P,U),O=`x: ${T.x.toFixed(3)}, y: ${T.y.toFixed(3)}`;if(V){if(V.hdr){let[D,N,q]=V.hdr;O+=`
HDR: (${D.toFixed(3)}, ${N.toFixed(3)}, ${q.toFixed(3)})`}if(V.ldr){let[D,N,q]=V.ldr;O+=`
LDR: (${D.toFixed(3)}, ${N.toFixed(3)}, ${q.toFixed(3)})`}}h.html(O.replace(/\n/g,"<br>"))}l.addEventListener("mousemove",T=>{f=T.clientX,b=T.clientY,R()}),p&&p.addEventListener("change",function(){m=p.getValue(),E()}),window.addEventListener("resize",x),setInterval(E,100);let w=document.querySelector("#fps-counter .fps-display"),S=document.getElementById("mobile-controls");function M(T){if(T>=1e3){let C=T/1e3;return C%1===0?`${Math.floor(C)}k`:`${C.toFixed(1)}k`}return T.toString()}function B(){if(a&&a.fps!==void 0){let T=a.totalFrames!==void 0?` | ${M(a.totalFrames)} frames`:"",C=`${a.fps}${T}`;w&&(w.textContent=`FPS: ${C}`),S&&S.setFPS&&S.setFPS(C)}}setInterval(B,500);let v=$("#histogram-panel"),F=document.getElementById("histogram-canvas"),A=F.getContext("2d");$("#histogram-header").on("click",function(){v.toggleClass("collapsed"),$("#histogram-expand").text(v.hasClass("collapsed")?"\u25B6":"\u25BC")});function L(){if(!a)return;let T=a.getBufferStats();if(!T||!T.histogram||T.histogram.length===0)return;let C=F,P=A,U=window.devicePixelRatio||1;C.width=C.clientWidth*U,C.height=C.clientHeight*U,P.scale(U,U);let V=C.clientWidth,O=C.clientHeight;P.fillStyle="rgba(0, 0, 0, 0.3)",P.fillRect(0,0,V,O);let D=Math.max(...T.histogram);if(D===0)return;let N=V/T.histogram.length;P.fillStyle="#4CAF50",T.histogram.forEach((q,Ee)=>{let Qt=q/D*(O-4),fr=Ee*N,gr=O-Qt;P.fillRect(fr,gr,N-1,Qt)}),$("#hist-avg").text(T.avgBrightness.toFixed(1)),$("#hist-max").text(T.maxBrightness.toFixed(0)),T.maxVelocity!==void 0&&T.maxVelocity!==null?$("#hist-vel").text(T.maxVelocity.toFixed(2)):$("#hist-vel").text("--")}setInterval(L,1e3),x(),R()}function r(a){document.addEventListener("keydown",l=>{if(l.key==="Escape"){if(window.mobilePanelManager&&window.mobilePanelManager.getCurrentPanel()){l.preventDefault(),window.mobilePanelManager.hideAllPanels(),c.verbose("Mobile panel closed via Escape key");return}let u=$(".floating-panel:visible");if(u.length>0){l.preventDefault(),u.hide(),c.verbose("Floating panel closed via Escape key");return}}if(l.key==="c"&&!l.ctrlKey&&!l.altKey&&!l.metaKey&&!l.shiftKey){if(l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA")return;l.preventDefault(),a.clearScreen(),c.info("Screen cleared via keyboard shortcut (C)")}})}function n(a,l){let u=null;$("#animation-script-input").on("change",function(d){let h=d.target.files[0];if(!h)return;let p=new FileReader;p.onload=function(m){try{let f=JSON.parse(m.target.result);u=new at(a,l);let b=u.loadScript(f);$("#anim-name").text(b.name);let x=b.timeline[b.timeline.length-1].time,g=Math.ceil(x*b.fps);$("#anim-param").text(`${b.timeline.length} keyframes`),$("#anim-range").text(`0s \u2192 ${x}s`),$("#anim-frames").text(g),$("#anim-fps").text(b.fps),$("#anim-duration").text(`${x.toFixed(1)}s`),$("#animation-info").show(),$("#animation-run-btn").prop("disabled",!1),$("#animation-download-btn").prop("disabled",!0),c.info(`Animation script loaded: ${b.name}`)}catch(f){alert("Failed to load animation script: "+f.message),c.error("Animation script load failed",f)}},p.readAsText(h)}),$("#animation-run-btn").on("click",async function(){if(u)try{$("#animation-run-btn").prop("disabled",!0),$("#animation-pause-btn").prop("disabled",!1),$("#animation-stop-btn").prop("disabled",!1),$("#animation-script-input").prop("disabled",!0),$("#animation-progress").show(),await u.run((d,h,p)=>{let m=d/h*100;$("#progress-bar").css("width",m+"%"),$("#progress-text").text(`Frame ${d} / ${h}`),$("#progress-param").text(`Time: ${p.toFixed(2)}s`)}),c.info("Animation complete!"),alert("Animation complete! "+u.frames.length+" frames captured."),$("#animation-download-btn").prop("disabled",!1)}catch(d){c.error("Animation failed",d),alert("Animation failed: "+d.message)}finally{$("#animation-run-btn").prop("disabled",!1),$("#animation-pause-btn").prop("disabled",!0),$("#animation-stop-btn").prop("disabled",!0),$("#animation-script-input").prop("disabled",!1)}}),$("#animation-pause-btn").on("click",function(){u&&(u.isPaused?(u.resume(),$(this).text("\u23F8 Pause"),c.info("Animation resumed")):(u.pause(),$(this).text("\u25B6 Resume"),c.info("Animation paused")))}),$("#animation-stop-btn").on("click",function(){u&&(u.stop(),c.info("Animation stopped"),$("#animation-run-btn").prop("disabled",!1),$("#animation-pause-btn").prop("disabled",!0),$("#animation-stop-btn").prop("disabled",!0),$("#animation-script-input").prop("disabled",!1))}),$("#animation-download-btn").on("click",async function(){if(!(!u||u.frames.length===0))try{$(this).prop("disabled",!0),$(this).text("\u{1F4BE} Downloading..."),await u.downloadFrames(),$(this).text("\u2713 Downloaded"),setTimeout(()=>{$(this).text("\u{1F4BE} Download Frames (ZIP)"),$(this).prop("disabled",!1)},2e3)}catch(d){c.error("Download failed",d),alert("Download failed: "+d.message),$(this).text("\u{1F4BE} Download Frames (ZIP)"),$(this).prop("disabled",!1)}}),c.info("Animation panel initialized")}function s(){let a="accordionState",l={};try{let u=localStorage.getItem(a);u&&(l=JSON.parse(u))}catch(u){console.warn("Failed to load accordion state",u)}$("#controls h2").each(function(u){let d=$(this),h=d.next(".accordion-section");if(h.length===0)return;let p=d.text().trim();(l.hasOwnProperty(p)?l[p]:u>0)?(d.addClass("collapsed"),h.addClass("collapsed")):h.css("max-height",h[0].scrollHeight+"px"),d.on("click",function(){let b=$(this),x=b.next(".accordion-section"),g=b.hasClass("collapsed");g?(b.removeClass("collapsed"),x.css("max-height",x[0].scrollHeight+"px"),x.removeClass("collapsed")):(x.css("max-height",x[0].scrollHeight+"px"),x[0].offsetHeight,x.css("max-height","0"),b.addClass("collapsed"),x.addClass("collapsed")),l[p]=!g;try{localStorage.setItem(a,JSON.stringify(l))}catch(y){console.warn("Failed to save accordion state",y)}});let f=()=>{h.hasClass("collapsed")||h.css("max-height",h[0].scrollHeight+"px")};typeof ResizeObserver<"u"&&new ResizeObserver(f).observe(h[0])}),c.info("Accordion initialized with "+$("#controls h2").length+" sections")}s(),o(function(a,l){t(a,l),i(a,l),r(a),e(a,l)})});})();
//# sourceMappingURL=app.min.js.map
