var DeRender=(()=>{var Ut=Object.defineProperty;var rn=Object.getOwnPropertyDescriptor;var nn=Object.getOwnPropertyNames;var on=Object.prototype.hasOwnProperty;var G=(n,e)=>()=>(n&&(e=n(n=0)),e);var Ot=(n,e)=>{for(var t in e)Ut(n,t,{get:e[t],enumerable:!0})},sn=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of nn(e))!on.call(n,r)&&r!==t&&Ut(n,r,{get:()=>e[r],enumerable:!(i=rn(e,r))||i.enumerable});return n};var an=n=>sn(Ut({},"__esModule",{value:!0}),n);var Gt,a,M=G(()=>{Gt=class{constructor(){this.enabled=!0,this.verbosity="info",this.maxLogs=100,this.logs=[],this.consoleHooked=!1,this.originalConsole={},this.outputElement=null,this.showLineNumbers=!1;try{let e=localStorage.getItem("debugShowLineNumbers");this.showLineNumbers=e==="true"}catch{}this.silenced=!1,this.silencedBuffer=[],this.maxSilencedLogs=5e3}setShowLineNumbers(e){this.showLineNumbers=e;try{localStorage.setItem("debugShowLineNumbers",e?"true":"false")}catch{}}_getCallerInfo(){if(!this.showLineNumbers)return null;try{let e=new Error().stack;if(!e)return null;let t=e.split(`
`);for(let i=0;i<t.length;i++){let r=t[i];if(r.includes("debug-logger.js"))continue;let o=r.match(/([^\/]+\.js):(\d+):\d+\)?$/);if(o)return`${o[1]}:${o[2]}`}return null}catch{return null}}setOutputElement(e){this.outputElement=e}setEnabled(e){this.enabled=e}setVerbosity(e){let t=this.verbosity==="silent";this.verbosity=e;let i=e==="silent";t&&!i?this.unsilence():!t&&i&&this.silence()}silence(){this.silenced||(this.silenced=!0,this.info("Entering silent mode - logs will be buffered",null,!1))}unsilence(){if(!this.silenced)return;let e=this.silencedBuffer.length;this.silenced=!1,this.flush(),this.info(`Exited silent mode - flushed ${e} buffered logs`,null,!1)}flush(){if(this.silencedBuffer.length===0)return;let e=this.silencedBuffer.length;this.info(`Flushing ${e} silenced logs...`,null,!1);let t=this.consoleHooked?this.originalConsole.log:console.log;for(let i of this.silencedBuffer){let r=i.caller?`[${i.caller}] `:"",o=`[${i.timestamp}] ${r}${i.message}`;i.data?t(o,i.data):t(o),i.stack&&t("Stack trace:",i.stack)}this.logs.push(...this.silencedBuffer),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs)),this.silencedBuffer=[],this.updateUI()}clearSilencedBuffer(){let e=this.silencedBuffer.length;this.silencedBuffer=[],this.info(`Cleared ${e} buffered logs`,null,!1)}shouldLog(e){if(!this.enabled)return!1;let t={verbose:0,debug:1,info:2,warn:3,error:4,silent:0};return t[e]>=t[this.verbosity]}log(e,t,i=null,r=!0){if(!this.shouldLog(e))return;let o=new Date().toLocaleTimeString(),s=this._getCallerInfo(),l=null;i instanceof Error&&(l=i.stack,i={message:i.message,name:i.name,stack:i.stack});let c={timestamp:o,level:e,message:t,data:i,stack:l,caller:s};if(this.silenced&&r){this.silencedBuffer.push(c),this.silencedBuffer.length>this.maxSilencedLogs&&this.silencedBuffer.shift();return}this.logs.push(c),this.logs.length>this.maxLogs&&this.logs.shift();let u=this.consoleHooked?this.originalConsole.log:console.log,d=s?`[${s}] `:"",h=`[${o}] ${d}${t}`;i?u(h,i):u(h),l&&u("Stack trace:",l),this.updateUI()}verbose(e,t=null,i=!0){this.log("verbose",e,t,i)}debug(e,t=null,i=!0){this.log("debug",e,t,i)}info(e,t=null,i=!0){this.log("info",e,t,i)}warn(e,t=null,i=!0){this.log("warn",e,t,i)}error(e,t=null,i=!0){this.log("error",e,t,i)}clear(){this.logs=[],this.updateUI()}updateUI(){let e=this.outputElement?$(this.outputElement):$("#debug-output");if(!(!e||e.length===0)){e.empty();for(let t of this.logs){let i=$('<div class="debug-log"></div>').addClass(t.level),r=$('<span class="debug-timestamp"></span>').text(t.timestamp);if(t.caller){let s=$('<span class="debug-caller"></span>').text(`[${t.caller}] `).css({color:"#64B5F6","font-family":"monospace","font-size":"11px"});i.append(r).append(s)}else i.append(r);let o=$("<span></span>").text(t.message);if(i.append(o),t.data){let s=typeof t.data=="object"?JSON.stringify(t.data,null,2):String(t.data),l=$("<span></span>").text(" | "+s).css("color","#888");i.append(l)}if(t.stack){let s=$("<span></span>").text(" [stack]").css({color:"#ff6b6b",cursor:"pointer","text-decoration":"underline"}),l=$("<pre></pre>").text(t.stack).css({display:"none",color:"#ff6b6b","font-size":"9px",margin:"4px 0 0 20px",padding:"4px",background:"#2a0000","border-left":"2px solid #ff6b6b","overflow-x":"auto"});s.on("click",function(){l.toggle()}),i.append(s),i.append(l)}e.append(i)}e.scrollTop(e[0].scrollHeight)}}getLogs(){return this.logs}getSilencedBuffer(){return this.silencedBuffer}isSilenced(){return this.silenced}getBufferStats(){return{silenced:this.silenced,bufferSize:this.silencedBuffer.length,maxBufferSize:this.maxSilencedLogs,bufferUsagePercent:Math.round(this.silencedBuffer.length/this.maxSilencedLogs*100)}}hookConsole(){if(this.consoleHooked){this.warn("Console already hooked");return}this.originalConsole={log:console.log,info:console.info,warn:console.warn,error:console.error};let e=this;console.log=function(...t){e.originalConsole.log.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.debug("[console.log] "+i)},console.info=function(...t){e.originalConsole.info.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.debug("[console.info] "+i)},console.warn=function(...t){e.originalConsole.warn.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.warn("[console] "+i)},console.error=function(...t){e.originalConsole.error.apply(console,t);let i=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");e.error("[console] "+i)},this.consoleHooked=!0,this.info("Console hooked - browser console calls will echo to debug console")}unhookConsole(){if(!this.consoleHooked){this.warn("Console not hooked");return}console.log=this.originalConsole.log,console.info=this.originalConsole.info,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,this.consoleHooked=!1,this.info("Console unhooked - restored original behavior")}},a=new Gt});function it(n){let e=[],t=0,i=null;for(;t<n.length;){let r=n[t];if(/\s/.test(r)){t++;continue}if(/\d/.test(r)||r==="."&&/\d/.test(n[t+1])){let o="";for(;t<n.length&&/[\d.]/.test(n[t]);)o+=n[t++];let s={type:D.NUMBER,value:parseFloat(o)};e.push(s),i=s;continue}if(/[a-zA-Z_]/.test(r)){let o="";for(;t<n.length&&/[a-zA-Z_0-9]/.test(n[t]);)o+=n[t++];let s;Fi.has(o)||ee.hasOwnProperty(o)?s={type:D.FUNCTION,value:o}:Xt.hasOwnProperty(o)?s={type:D.NUMBER,value:Xt[o],isConstant:!0}:s={type:D.VARIABLE,value:o},e.push(s),i=s;continue}if(Qe.hasOwnProperty(r)){if(r==="-"&&(i===null||i.type===D.OPERATOR||i.type===D.UNARY_MINUS||i.type===D.LPAREN||i.type===D.COMMA)){let s={type:D.UNARY_MINUS};e.push(s),i=s,t++;continue}let o={type:D.OPERATOR,value:r};e.push(o),i=o,t++;continue}if(r==="("){let o={type:D.LPAREN};e.push(o),i=o,t++;continue}if(r===")"){let o={type:D.RPAREN};e.push(o),i=o,t++;continue}if(r===","){let o={type:D.COMMA};e.push(o),i=o,t++;continue}throw new Error(`Unexpected character: ${r} at position ${t}`)}return e.push({type:D.EOF}),e}function rt(n){let e=[],t=[],i=0,r=()=>n[i],o=()=>n[i++];for(;r().type!==D.EOF;){let s=o();if(s.type===D.NUMBER)e.push(s);else if(s.type===D.VARIABLE)e.push(s);else if(s.type===D.FUNCTION)t.push(s);else if(s.type===D.UNARY_MINUS){for(;t.length>0&&t[t.length-1].type===D.UNARY_MINUS;)e.push(t.pop());t.push(s)}else if(s.type===D.COMMA)for(;t.length>0&&t[t.length-1].type!==D.LPAREN;)e.push(t.pop());else if(s.type===D.OPERATOR){let l=s;for(;t.length>0;){let c=t[t.length-1];if(c.type===D.OPERATOR){let u=Qe[l.value],d=Qe[c.value];if(u.associativity==="L"&&u.precedence<=d.precedence||u.associativity==="R"&&u.precedence<d.precedence)e.push(t.pop());else break}else if(c.type===D.UNARY_MINUS)if(Qe[l.value].precedence<=2)e.push(t.pop());else break;else break}t.push(l)}else if(s.type===D.LPAREN)t.push(s);else if(s.type===D.RPAREN){for(;t.length>0&&t[t.length-1].type!==D.LPAREN;)e.push(t.pop());if(t.length===0)throw new Error("Mismatched parentheses");t.pop(),t.length>0&&t[t.length-1].type===D.FUNCTION&&e.push(t.pop())}}for(;t.length>0;){let s=t.pop();if(s.type===D.LPAREN)throw new Error("Mismatched parentheses");e.push(s)}return ln(e)}function ln(n){let e=[];for(let t of n)if(t.type===D.NUMBER)e.push(new et(t.value,t.isConstant));else if(t.type===D.VARIABLE)e.push(new tt(t.value));else if(t.type===D.UNARY_MINUS){if(e.length<1)throw new Error("Invalid expression");let i=e.pop();e.push(new be("-",i))}else if(t.type===D.OPERATOR){if(e.length<2)throw new Error("Invalid expression");let i=e.pop(),r=e.pop();e.push(new ge(t.value,r,i))}else if(t.type===D.FUNCTION){let i=dn(t.value);if(e.length<i)throw new Error(`Not enough arguments for ${t.value}`);let r=[];for(let o=0;o<i;o++)r.unshift(e.pop());e.push(new xe(t.value,r))}if(e.length!==1)throw new Error("Invalid expression");return e[0]}function re(n){if(n.type==="number")return new et(n.value,n.isConstant);if(n.type==="variable")return new tt(n.name);if(n.type==="unaryOp")return new be(n.operator,re(n.operand));if(n.type==="binaryOp")return new ge(n.operator,re(n.left),re(n.right));if(n.type==="functionCall")return new xe(n.name,n.args.map(e=>re(e)));throw new Error(`Unknown node type: ${n.type}`)}function Be(n,e){if(n.type==="number")return re(n);if(n.type==="variable")return e[n.name]?re(e[n.name]):re(n);if(n.type==="unaryOp")return new be(n.operator,Be(n.operand,e));if(n.type==="binaryOp")return new ge(n.operator,Be(n.left,e),Be(n.right,e));if(n.type==="functionCall"){let t=n.args.map(i=>Be(i,e));return new xe(n.name,t)}throw new Error(`Unknown node type: ${n.type}`)}function fe(n,e){if(n.type==="number"||n.type==="variable")return re(n);if(n.type==="unaryOp")return new be(n.operator,fe(n.operand,e));if(n.type==="binaryOp")return new ge(n.operator,fe(n.left,e),fe(n.right,e));if(n.type==="functionCall")if(e[n.name]){let t=e[n.name],i=n.args.map(o=>fe(o,e)),r={};return t.params.forEach((o,s)=>{r[o]=i[s]}),Be(t.bodyAST,r)}else{let t=n.args.map(i=>fe(i,e));return new xe(n.name,t)}throw new Error(`Unknown node type: ${n.type}`)}function Ve(n,e=0){let t="  ".repeat(e);if(n.type==="number")return n.isConstant?`${t}NumberNode(${n.value} [constant])`:`${t}NumberNode(${n.value})`;if(n.type==="variable")return`${t}VariableNode(${n.name})`;if(n.type==="unaryOp"){let i=Ve(n.operand,e+1);return`${t}UnaryOpNode(${n.operator})
${i}`}else if(n.type==="binaryOp"){let i=Ve(n.left,e+1),r=Ve(n.right,e+1);return`${t}BinaryOpNode(${n.operator})
${i}
${r}`}else if(n.type==="functionCall"){let i=n.args.map(r=>Ve(r,e+1)).join(`
`);return`${t}FunctionCallNode(${n.name})
${i}`}return`${t}Unknown(${n.type})`}function Ri(n,e){let t=new Set(e);["dx","dy","dz","dw","du","dv"].forEach(o=>t.add(o)),t.add("a");function r(o){if(o.type==="number")return o.isConstant&&{PI:"Math.PI",E:"Math.E"}[o.value]||o.value.toString();if(o.type==="variable"){if(t.has(o.name))return o.name;throw new Error(`Unknown variable: ${o.name}. Available: ${e.join(", ")}, dx, dy, dz, dw, du, dv, a`)}else{if(o.type==="unaryOp")return`(-${r(o.operand)})`;if(o.type==="binaryOp"){let s=r(o.left),l=r(o.right);return o.operator==="^"?`Math.pow(${s}, ${l})`:`(${s} ${o.operator} ${l})`}else if(o.type==="functionCall"){let s=o.args.map(u=>r(u));return`${{mod:"%",fract:"(x => x - Math.floor(x))",mix:"(a, b, t) => a * (1 - t) + b * t"}[o.name]||`Math.${o.name}`}(${s.join(", ")})`}}throw new Error(`Unknown node type: ${o.type}`)}return r(n)}function cn(n,e){if(e==="(-1.0)"||e==="-1.0")return`(1.0 / ${n})`;let t=e.match(/^(\d+)\.0$/);if(t){let i=parseInt(t[1]);if(i===0)return"1.0";if(i===1)return n;if(i<=4)return`(${Array(i).fill(n).join(" * ")})`}return`pow(${n}, ${e})`}function Li(n,e,t=!1,i="pos"){let r={};if(t)e.forEach(s=>{r[s]=s});else{let s=["x","y","z","w","u","v"],l=["dx","dy","dz","dw","du","dv"];e.forEach((c,u)=>{u<6?r[c]=`${i}.${s[u]}`:r[c]=`${i}[${u}]`}),l.forEach((c,u)=>{u<6?r[c]=`velocity.${s[u]}`:r[c]=`velocity[${u}]`}),r.a="u_alpha"}function o(s){if(s.type==="number"){if(s.isConstant)return{PI:"3.14159265359",E:"2.71828182846"}[s.value]||s.value.toString();{let l=s.value.toString();return!l.includes(".")&&!l.includes("e")&&!l.includes("E")&&(l+=".0"),l}}else if(s.type==="variable"){if(r.hasOwnProperty(s.name))return r[s.name];throw new Error(`Unknown variable: ${s.name}. Available: ${e.join(", ")}`)}else{if(s.type==="unaryOp")return`(-${o(s.operand)})`;if(s.type==="binaryOp"){let l=o(s.left),c=o(s.right);return s.operator==="^"?cn(l,c):s.operator==="%"?`mod(${l}, ${c})`:`(${l} ${s.operator} ${c})`}else if(s.type==="functionCall"){let l=s.args.map(u=>o(u)),c=s.name;return s.name==="atan2"&&(c="atan"),`${c}(${l.join(", ")})`}}throw new Error(`Unknown node type: ${s.type}`)}return o(n)}function un(n,e){let t=new Set(e);["dx","dy","dz","dw","du","dv"].forEach(l=>t.add(l)),t.add("a");function r(l){return l.type==="binaryOp"||l.type==="unaryOp"}function o(l){return l.type==="binaryOp"&&(l.operator==="+"||l.operator==="-")}function s(l){if(l.type==="number")return l.isConstant&&{PI:"\\pi",E:"e"}[l.value]||l.value.toString();if(l.type==="variable"){if(t.has(l.name))return l.name;throw new Error(`Unknown variable: ${l.name}`)}else if(l.type==="unaryOp"){let c=s(l.operand);return c.includes(" ")||c.includes("+")||c.includes("-")?`-(${c})`:`-${c}`}else if(l.type==="binaryOp"){let c=s(l.left),u=s(l.right);if(l.operator==="^")return`{${r(l.left)?`\\left(${c}\\right)`:c}}^{${u}}`;if(l.operator==="*"){let d=o(l.left)?`\\left(${c}\\right)`:c,h=o(l.right)?`\\left(${u}\\right)`:u;return`${d} \\cdot ${h}`}else return l.operator==="/"?`\\frac{${c}}{${u}}`:l.operator==="-"?`${c} - ${u}`:l.operator==="+"?`${c} + ${u}`:`${c} ${l.operator} ${u}`}else if(l.type==="functionCall"){let c=l.args.map(u=>s(u));return l.name==="sqrt"?`\\sqrt{${c[0]}}`:l.name==="sin"?`\\sin(${c[0]})`:l.name==="cos"?`\\cos(${c[0]})`:l.name==="tan"?`\\tan(${c[0]})`:l.name==="exp"?`\\exp(${c[0]})`:l.name==="log"?`\\log(${c[0]})`:l.name==="abs"?`\\left|${c[0]}\\right|`:`${l.name}(${c.join(", ")})`}throw new Error(`Unknown node type: ${l.type}`)}return s(n)}function dn(n){return ee.hasOwnProperty(n)?ee[n].params.length:new Set(["min","max","pow","mod","dot","atan2"]).has(n)?2:1}function hn(n){let e="";for(let[t,i]of Object.entries(ee)){let r=it(i.body),o=rt(r),s=Li(o,i.params,!0);e+=`float ${t}(`,e+=i.params.map(l=>`float ${l}`).join(", "),e+=`) {
`,e+=`    return ${s};
`,e+=`}

`}return e}function Mi(n,e,t=null){let i=t||["x","y","z","w","u","v"].slice(0,e);try{let r=it(n),o=rt(r);return a.verbose(`Parsed expression: "${n}"`),a.verbose(`AST tree:
`+Ve(o)),new jt(o)}catch(r){throw new Error(`Parse error: ${r.message}`)}}function W(n,e,t=null,i="pos"){let r=t||["x","y","z","w","u","v"].slice(0,e);return Mi(n,e,t).toGLSL(r,{useDirectMapping:!1,posVarName:i})}function nt(){return hn([])}function Pi(n,e=null,t="pos"){let i=n.length;return n.map((r,o)=>{try{return W(r.trim(),i,e,t)}catch(s){throw new Error(`Error in dimension ${o}: ${s.message}`)}})}function qt(n,e=null){let t=n.length,i=e||["x","y","z","w","u","v"].slice(0,t);return n.map((r,o)=>{try{let s=it(r.trim()),l=rt(s),u=`return ${Ri(l,i)};`;return new Function(...i,u)}catch(s){throw new Error(`Error creating evaluator for dimension ${o}: ${s.message}`)}})}function Ii(n,e,t=null){let i=t||["x","y","z","w","u","v"].slice(0,e);return Mi(n,e,t).toTeX(i)}function Di(n){for(let t in ee)delete ee[t];if(!n||!n.trim())return;let e=n.split(`
`);for(let t=0;t<e.length;t++){let i=e[t].trim();if(!i||i.startsWith("//")||i.startsWith("#"))continue;let r=i.match(/^([a-zA-Z_][a-zA-Z_0-9]*)\s*\(([^)]*)\)\s*=\s*(.+)$/);if(!r)throw new Error(`Line ${t+1}: Invalid function definition syntax. Expected: functionName(arg1, arg2) = expression`);let[,o,s,l]=r;if(Fi.has(o))throw new Error(`Line ${t+1}: Cannot override built-in function '${o}'`);if(Xt.hasOwnProperty(o))throw new Error(`Line ${t+1}: Cannot use constant name '${o}' as function name`);let c=s.split(",").map(u=>u.trim()).filter(u=>u);for(let u of c)if(!/^[a-zA-Z_][a-zA-Z_0-9]*$/.test(u))throw new Error(`Line ${t+1}: Invalid parameter name '${u}'`);try{let u=it(l);rt(u)}catch(u){throw new Error(`Line ${t+1}: Error parsing function body: ${u.message}`)}ee[o]={params:c,body:l}}}function ki(){return{...ee}}var Ht,jt,de,et,tt,ge,be,xe,D,Qe,Fi,ee,Xt,se=G(()=>{M();Ht=class{toGLSL(e,t={}){throw new Error("Must implement toGLSL()")}toTeX(e){throw new Error("Must implement toTeX()")}toJS(e){throw new Error("Must implement toJS()")}clone(){throw new Error("Must implement clone()")}substitute(e){throw new Error("Must implement substitute()")}},jt=class n extends Ht{constructor(e){super(),this.ast=e}toGLSL(e,t={}){return Li(this.ast,e,t.useDirectMapping||!1,t.posVarName||"pos")}toTeX(e){return un(this.ast,e)}toJS(e){return Ri(this.ast,e)}clone(){return new n(re(this.ast))}substitute(e){let t={};for(let[r,o]of Object.entries(e))o instanceof n&&ee[r]&&(t[r]={params:ee[r].params,bodyAST:o.ast});let i=fe(this.ast,t);return new n(i)}},de=class{constructor(e){this.type=e}},et=class extends de{constructor(e,t=!1){super("number"),this.value=e,this.isConstant=t}},tt=class extends de{constructor(e){super("variable"),this.name=e}},ge=class extends de{constructor(e,t,i){super("binaryOp"),this.operator=e,this.left=t,this.right=i}},be=class extends de{constructor(e,t){super("unaryOp"),this.operator=e,this.operand=t}},xe=class extends de{constructor(e,t){super("functionCall"),this.name=e,this.args=t}},D={NUMBER:"NUMBER",VARIABLE:"VARIABLE",FUNCTION:"FUNCTION",OPERATOR:"OPERATOR",UNARY_MINUS:"UNARY_MINUS",LPAREN:"LPAREN",RPAREN:"RPAREN",COMMA:"COMMA",EOF:"EOF"},Qe={"+":{precedence:1,associativity:"L"},"-":{precedence:1,associativity:"L"},"*":{precedence:2,associativity:"L"},"/":{precedence:2,associativity:"L"},"^":{precedence:3,associativity:"R"},"%":{precedence:2,associativity:"L"}},Fi=new Set(["sin","cos","tan","asin","acos","atan","atan2","sinh","cosh","tanh","exp","log","log2","sqrt","abs","floor","ceil","fract","sign","min","max","pow","mod","length","normalize","dot"]),ee={},Xt={pi:"PI",e:"E",PI:"PI",E:"E"}});function ji(n){Z=n,a.info("Jacobian: Notebook set (CAS engine:",Z.casEngine.getName()+")")}function ne(n,e){if(a.verbosity="verbose",a.info("=== JACOBIAN COMPUTATION START ==="),a.info("Timestamp:",new Date().toISOString()),a.info("Notebook:",Z?"set":"not set"),a.info("CAS Engine:",Z?Z.casEngine.getName():"not available"),a.info("Input expressions:",n.toString()),a.info("Dimensions:",e),!Z)return a.error("Notebook not set - cannot compute Jacobian"),null;if(!Z.casEngine.isReady())return a.error("CAS engine not ready - cannot compute Jacobian"),null;try{let t=n.map(r=>{let o=r.replace(/atan2\s*\(\s*([^,]+)\s*,\s*([^)]+)\s*\)/g,"atan(($1)/($2))");return o!==r&&a.verbose(`Replaced atan2 for differentiation: "${r}" \u2192 "${o}"`),o}),i=[];for(let r=0;r<e;r++){let o=[],s=t[r];a.verbose(`Row ${r}: differentiating expression "${s}"`);for(let l=0;l<e;l++){let c=yn[l];try{a.verbose(`  Computing \u2202(${s})/\u2202${c}...`);let u=Z.differentiate(s,c);a.verbose(`  Derivative: ${u}`),o.push(u)}catch(u){a.warn(`Failed to differentiate expression "${s}" w.r.t. ${c}: ${u.message}`),o.push("0")}}i.push(o)}a.info("=== JACOBIAN COMPUTATION COMPLETE ==="),a.info("Final Jacobian matrix:");for(let r=0;r<i.length;r++)a.info(`  Row ${r}: [${i[r].join(", ")}]`);return i}catch(t){return a.error("Failed to compute Jacobian matrix",t),null}}function ze(n){if(!n||!Array.isArray(n))return!1;for(let e of n){if(!Array.isArray(e))return!1;for(let t of e)if(typeof t!="string"||t==="")return!1}return!0}function Wt(n){if(!n||!Array.isArray(n))return a.error("Invalid Jacobian for inversion"),null;if(!Z)return a.error("Notebook not set - cannot invert Jacobian"),null;let e=n.length;if(e<2||e>4)return a.error(`Jacobian inversion only supported for 2x2, 3x3, and 4x4 matrices (got ${e}x${e})`),null;try{a.verbose("Inverting Jacobian matrix using",Z.casEngine.getName());let t=Z.invertMatrix(n);if(t){a.verbose("Inverted Jacobian:");for(let i=0;i<t.length;i++)a.verbose(`  Row ${i}: [${t[i].join(", ")}]`)}return t}catch(t){return a.error("Failed to invert Jacobian:",t.message),null}}var Z,yn,ut=G(()=>{M();Z=null;yn=["x","y","z","w","u","v"]});function Pn(n){let e=[],t=/atan2\s*\(\s*([^,]+)\s*,\s*([^)]+)\s*\)/g,i;for(;(i=t.exec(n))!==null;)e.push({fullMatch:i[0],numerator:i[1].trim(),denominator:i[2].trim()});return e}function nr(n,e){let{numerator:t,denominator:i,fullMatch:r}=e,o=`PI/2 - atan2(${i}, ${t})`,s=n.map(c=>c.replace(r,o));return{condition:`abs(${i}) <= abs(${t})`,forwardTransforms:s}}function or(n,e){let t=[],i=[];if(n.forEach((r,o)=>{Pn(r).forEach(l=>{i.push({...l,transformIndex:o})})}),i.length===0)return[{condition:"true",forwardTransforms:n}];if(e===2||e===3&&i.length===1){let r=i[0];return t.push({condition:`abs(${r.denominator}) >= abs(${r.numerator})`,forwardTransforms:n}),t.push(nr(n,r)),t}if(e===3&&i.length>=2){let r=i[i.length-1];return t.push({condition:`abs(${r.denominator}) >= abs(${r.numerator})`,forwardTransforms:n}),t.push(nr(n,r)),t}return[{condition:"true",forwardTransforms:n}]}function sr(n,e){if(n==="true")return"true";let t=n;return e.forEach((i,r)=>{let o=["x","y","z","w"][r],s=new RegExp(`\\b${i}\\b`,"g");t=t.replace(s,`pos.${o}`)}),t=t.replace(/\bPI\b/g,"3.14159265359"),t}var ar=G(()=>{});var cr={};Ot(cr,{CoordinateSystem:()=>O,PRESET_COORDINATE_SYSTEMS:()=>he,createCartesianSystem:()=>lr,getCartesianSystem:()=>j,getCoordinateSystem:()=>In,getPresetsForDimension:()=>ai});function In(n){return he[n]||null}function ai(n){let e=[];for(let[t,i]of Object.entries(he))i.dimensions===n&&e.push({key:t,system:i});return e}function j(n){let e=`cartesian${n}d`;return he[e]||lr(n)}function lr(n){let e=["x","y","z","w","u","v"].slice(0,n);return new O(`Cartesian ${n}D`,n,e.map(t=>({label:t,displayLabel:t})),e)}var O,he,ae=G(()=>{ut();ar();O=class n{constructor(e,t,i,r,o=null,s=!1,l=null){this.name=e,this.dimensions=t,this.variables=i,this.forwardTransforms=r,this.inverseTransforms=o,this.useIterativeSolver=s,this.charts=l||or(r,t)}getVariableNames(){return this.variables.map(e=>e.label)}getDisplayLabels(){return this.variables.map(e=>e.displayLabel)}generateForwardTransformGLSL(e,t){let i=this.getVariableNames(),r=`vec${this.dimensions}`,o=this.forwardTransforms.map((s,l)=>{let c=t(s,e);return`    result.${["x","y","z","w"][l]} = ${c};`}).join(`
`);return`
// Forward transform: Cartesian \u2192 ${this.name}
${r} transformToNative(${r} pos) {
    ${r} result;
    float ${e.map((s,l)=>`${s} = pos.${["x","y","z","w"][l]}`).join(", ")};
${o}
    return result;
}`}generateVelocityTransformGLSL(e,t){if(this.charts&&this.charts.length>1)return this.generateMultiChartVelocityTransformGLSL(e,t);let i=this.charts&&this.charts.length===1?this.charts[0].forwardTransforms:this.forwardTransforms,r=ne(i,this.dimensions);if(!r)return console.error("Failed to compute Jacobian for coordinate system:",this.name),`
// Velocity transform: ${this.name} \u2192 Cartesian (IDENTITY FALLBACK - ERROR)
// WARNING: Jacobian computation failed, using identity transform
vec${this.dimensions} transformVelocityToCartesian(vec${this.dimensions} vel_native, vec${this.dimensions} pos) {
    return vel_native; // INCORRECT: Should use inverse Jacobian
}`;let o=Wt(r);if(!o)return console.error("Failed to invert Jacobian for coordinate system:",this.name),console.error("Forward Jacobian was:",r),`
// Velocity transform: ${this.name} \u2192 Cartesian (IDENTITY FALLBACK - ERROR)
// WARNING: Jacobian inversion failed, using identity transform
// This will produce INCORRECT results for non-Cartesian coordinates!
vec${this.dimensions} transformVelocityToCartesian(vec${this.dimensions} vel_native, vec${this.dimensions} pos) {
    return vel_native; // INCORRECT: Jacobian inversion failed
}`;let s=`vec${this.dimensions}`,l=["x","y","z","w"],c=[];for(let u=0;u<this.dimensions;u++){let h=o[u].map((p,m)=>`(${t(p,e)}) * vel_native.${l[m]}`);c.push(`    result.${l[u]} = ${h.join(" + ")};`)}return`
// Velocity transform: ${this.name} \u2192 Cartesian via Inverse Jacobian
// J_forward = [${r.map(u=>"["+u.join(", ")+"]").join(`,
//             `)}]
// J_inverse = [${o.map(u=>"["+u.join(", ")+"]").join(`,
//             `)}]
${s} transformVelocityToCartesian(${s} vel_native, ${s} pos) {
    ${s} result;
    float ${e.map((u,d)=>`${u} = pos.${l[d]}`).join(", ")};
${c.join(`
`)}
    return result;
}`}generateMultiChartVelocityTransformGLSL(e,t){let i=`vec${this.dimensions}`,r=["x","y","z","w"],o=this.charts.map((c,u)=>{let d=ne(c.forwardTransforms,this.dimensions);if(!d)return console.warn(`Failed to compute Jacobian for chart ${u} of ${this.name}`),null;let h=Wt(d);if(!h)return console.warn(`Failed to invert Jacobian for chart ${u} of ${this.name}`),null;let p=[];for(let m=0;m<this.dimensions;m++){let b=h[m].map((x,g)=>`(${t(x,e)}) * vel_native.${r[g]}`);p.push(`        result.${r[m]} = ${b.join(" + ")};`)}return{condition:c.condition,jacobian:d,inverseJacobian:h,matrixMultCode:p}}).filter(c=>c!==null);if(o.length===0)return console.error("All charts failed for coordinate system:",this.name),`
// Velocity transform: ${this.name} \u2192 Cartesian (ERROR: All charts failed)
${i} transformVelocityToCartesian(${i} vel_native, ${i} pos) {
    return vel_native; // FALLBACK: All charts failed
}`;let s=o.map((c,u)=>{let d=sr(c.condition,e),h=u===0?"if":"else if",p=d==="true"?"":` (${d})`;return`    ${h}${p} {
        // Chart ${u+1}: Avoid singularities when ${c.condition}
${c.matrixMultCode.join(`
`)}
    }`}).join(" "),l=o.map((c,u)=>`// Chart ${u+1}: condition=${c.condition}
//   J_forward = [${c.jacobian.map(d=>"["+d.join(", ")+"]").join(`,
//               `)}]
//   J_inverse = [${c.inverseJacobian.map(d=>"["+d.join(", ")+"]").join(`,
//               `)}]`).join(`
`);return`
// Velocity transform: ${this.name} \u2192 Cartesian via Multiple Charts
// Using ${o.length} charts to handle coordinate singularities
${l}
${i} transformVelocityToCartesian(${i} vel_native, ${i} pos) {
    ${i} result;
    float ${e.map((c,u)=>`${c} = pos.${r[u]}`).join(", ")};
${s}
    return result;
}`}generateInverseTransformGLSL(e,t){let i=`vec${this.dimensions}`,r=["x","y","z","w"],o=["x","y","z","w","u","v"].slice(0,this.dimensions);if(this.inverseTransforms&&this.inverseTransforms.length===this.dimensions){let s=this.inverseTransforms.map((l,c)=>`    result.${r[c]} = ${l};`).join(`
`);return`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// Using explicit inverse transform (Tier 1)
${i} transformToCartesian(${i} native_pos) {
    ${i} result;
    float ${e.map((l,c)=>`${l} = native_pos.${r[c]}`).join(", ")};
${s}
    return result;
}`}return this.useIterativeSolver?this.generateNewtonSolverGLSL(o,e,t):(console.warn(`No inverse transform defined for ${this.name}, using identity`),`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// WARNING: Using identity fallback - no inverse defined!
${i} transformToCartesian(${i} native_pos) {
    return native_pos; // INCORRECT: Identity fallback
}`)}generateNewtonSolverGLSL(e,t,i){let r=`vec${this.dimensions}`,o=`mat${this.dimensions}`,s=["x","y","z","w"],l=this.forwardTransforms.map((d,h)=>{let p=i(d,e);return`        native.${s[h]} = ${p};`}).join(`
`),c=ne(this.forwardTransforms,this.dimensions);if(!c)return console.error("Failed to compute Jacobian for Newton solver:",this.name),`
// Newton solver failed: could not compute Jacobian
${r} transformToCartesian(${r} native_pos) {
    return native_pos; // ERROR FALLBACK
}`;let u=[];for(let d=0;d<this.dimensions;d++)for(let h=0;h<this.dimensions;h++){let p=i(c[d][h],e);u.push(`        J[${d}][${h}] = ${p};`)}return`
// Inverse transform: ${this.name} (Native \u2192 Cartesian)
// Using Newton's method iterative solver (Tier 3)
${r} transformToCartesian(${r} native_target) {
    // Use previous position as initial guess (stored in global)
    ${r} guess = vec${this.dimensions}(0.0); // TODO: Use previous frame position

    const int MAX_ITERATIONS = 10;
    const float TOLERANCE = 1e-6;

    for(int iter = 0; iter < MAX_ITERATIONS; iter++) {
        // Evaluate forward transform at current guess
        ${r} native;
        float ${e.map((d,h)=>`${d} = guess.${s[h]}`).join(", ")};
${l}

        // Compute error
        ${r} error = native - native_target;
        if(length(error) < TOLERANCE) {
            break; // Converged
        }

        // Build Jacobian matrix J = \u2202(native)/\u2202(cartesian)
        ${o} J;
${u.join(`
`)}

        // Newton step: guess -= inverse(J) * error
        guess -= inverse(J) * error;
    }

    return guess;
}`}toJSON(){return{name:this.name,dimensions:this.dimensions,variables:this.variables,forwardTransforms:this.forwardTransforms,inverseTransforms:this.inverseTransforms,useIterativeSolver:this.useIterativeSolver}}static fromJSON(e){return new n(e.name,e.dimensions,e.variables,e.forwardTransforms,e.inverseTransforms||null,e.useIterativeSolver||!1)}},he={cartesian2d:new O("Cartesian 2D",2,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"}],["x","y"],["x","y"]),polar2d:new O("Polar 2D",2,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"}],["sqrt(x^2 + y^2)","atan2(y, x)"],["r*cos(theta)","r*sin(theta)"]),cartesian3d:new O("Cartesian 3D",3,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"},{label:"z",displayLabel:"z"}],["x","y","z"],["x","y","z"]),cylindrical3d:new O("Cylindrical 3D",3,[{label:"rho",displayLabel:"\u03C1"},{label:"phi",displayLabel:"\u03C6"},{label:"z",displayLabel:"z"}],["sqrt(x^2 + y^2)","atan2(y, x)","z"],["rho*cos(phi)","rho*sin(phi)","z"]),spherical3d:new O("Spherical 3D",3,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"},{label:"phi",displayLabel:"\u03C6"}],["sqrt(x^2 + y^2 + z^2)","acos(z / sqrt(x^2 + y^2 + z^2))","atan2(y, x)"],["r*sin(theta)*cos(phi)","r*sin(theta)*sin(phi)","r*cos(theta)"]),cartesian4d:new O("Cartesian 4D",4,[{label:"x",displayLabel:"x"},{label:"y",displayLabel:"y"},{label:"z",displayLabel:"z"},{label:"w",displayLabel:"w"}],["x","y","z","w"],["x","y","z","w"]),hyperspherical4d:new O("Hyperspherical 4D",4,[{label:"r",displayLabel:"r"},{label:"theta",displayLabel:"\u03B8"},{label:"phi",displayLabel:"\u03C6"},{label:"psi",displayLabel:"\u03C8"}],["sqrt(x^2 + y^2 + z^2 + w^2)","acos(w / sqrt(x^2 + y^2 + z^2 + w^2))","acos(z / sqrt(x^2 + y^2 + z^2))","atan2(y, x)"],["r*sin(theta)*sin(phi)*cos(psi)","r*sin(theta)*sin(phi)*sin(psi)","r*sin(theta)*cos(phi)","r*cos(theta)"])}});var ur={};Ot(ur,{decodeFloatRGBA:()=>ci,encodeFloatRGBA:()=>li,getDecodeGLSL:()=>Bn,getEncodeGLSL:()=>kn,getFixedPointConstantsGLSL:()=>Dn});function li(n,e,t){n=Math.max(0,Math.min(1,n));let i=Math.floor(n*4294967295);e[t+0]=i>>>24&255,e[t+1]=i>>>16&255,e[t+2]=i>>>8&255,e[t+3]=i&255}function ci(n,e,t,i){return((n<<24|e<<16|t<<8|i)>>>0)/4294967295}function Dn(){return`
// Map to [0, 1] range for maximum precision at any zoom level
const float FIXED_POINT_SCALE = 4294967295.0; // 2^32 - 1
`}function kn(){return`
// Encode float in [0, 1] range to RGBA bytes
vec4 encodeFloat(float v) {
    // Clamp to [0, 1]
    v = clamp(v, 0.0, 1.0);

    // Map to [0, 2^32-1]
    float normalized = v * FIXED_POINT_SCALE;

    // Split into 4 bytes (big-endian)
    float byte0 = floor(normalized / 16777216.0);  // 2^24
    normalized -= byte0 * 16777216.0;
    float byte1 = floor(normalized / 65536.0);      // 2^16
    normalized -= byte1 * 65536.0;
    float byte2 = floor(normalized / 256.0);        // 2^8
    normalized -= byte2 * 256.0;
    float byte3 = floor(normalized);

    return vec4(byte0, byte1, byte2, byte3) / 255.0;
}

// Helper to normalize world coordinate to [0, 1] relative to viewport
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return (worldValue - minVal) / (maxVal - minVal);
}

// Helper to denormalize from [0, 1] back to world coordinates
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return minVal + normalized * (maxVal - minVal);
}
`}function Bn(){return`
// Decode RGBA bytes back to float in [0, 1] range
float decodeFloat(vec4 rgba) {
    // Reconstruct 32-bit integer from bytes (big-endian)
    vec4 bytes = rgba * 255.0;
    float intValue = bytes.r * 16777216.0 + bytes.g * 65536.0 + bytes.b * 256.0 + bytes.a;

    // Map from [0, 2^32-1] back to [0, 1]
    return intValue / FIXED_POINT_SCALE;
}
`}var ui=G(()=>{});function We(n,...e){return e.reduce((t,i)=>i(t),n)}var xi,yi,vi,Vr=G(()=>{xi=n=>class extends n{constructor(){super(),this.settingsKey=null,this.defaultValue=null,this.onChange=null,this._callback=null}initializeControlProperties(){this.settingsKey=this.getAttribute("settings-key")||this.id;let e=this.getAttribute("default");e!==null&&this.defaultValue===null&&(this.defaultValue=parseFloat(e))}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}reset(){this.defaultValue!==null&&this.defaultValue!==void 0&&this.setValue(this.defaultValue)}attachListeners(e){this._callback=e}triggerChange(){let e=this.getValue();this.onChange&&typeof this.onChange=="function"&&this.onChange(e),this._callback&&typeof this._callback=="function"&&this._callback(),this.dispatchEvent(new CustomEvent("control-change",{detail:{value:e},bubbles:!0}))}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}},yi=n=>class extends n{handleButtonAction(e){return e==="reset"?(this.reset(),!0):!1}registerActionButtons(e){for(let t of e){let i=this.querySelectorAll(`[${t}]`);for(let r of i)r.addEventListener("click",()=>{this.handleButtonAction(t)&&this.triggerChange})}}},vi=n=>class extends n{getNumberAttribute(e,t=0){let i=this.getAttribute(e);if(i===null)return t;let r=parseFloat(i);return isNaN(r)?t:r}getBooleanAttribute(e,t=!1){let i=this.getAttribute(e);return i===null?t:i===""||i===e?!0:i==="true"}}});var wi,zr=G(()=>{wi=n=>class extends n{constructor(){super(),this.animationEnabled=!1,this.animationMin=null,this.animationMax=null,this.currentAlpha=0,this.isAnimating=!1}connectedCallback(){super.connectedCallback();let e=this.getAttribute("animation-min"),t=this.getAttribute("animation-max");e!==null&&(this.animationMin=parseFloat(e)),t!==null&&(this.animationMax=parseFloat(t)),this.animationMin===null&&(this.animationMin=this.min||0),this.animationMax===null&&(this.animationMax=this.max||100)}attachInternalListeners(){super.attachInternalListeners(),this.addAnimationButton(),this.addAnimationBoundsUI(),this.attachThumbDragHandlers()}addAnimationButton(){let e=this.querySelector(".slider-control");if(!e)return;let t=document.createElement("button");t.id=`${this.id}-anim-btn`,t.className="slider-btn anim-btn",t.title="Enable animation (\u{1F3AC})",t.textContent="\u{1F3AC}",t.addEventListener("click",i=>{i.stopPropagation(),this.setAnimationEnabled(!this.animationEnabled)}),e.appendChild(t)}addAnimationBoundsUI(){let e=this.querySelector(".slider-control");if(!e)return;let t=`
            <div id="${this.id}-animation-bounds" class="animation-bounds-slider" style="display: none;">
                <div class="bounds-labels">
                    <span>Min: <span id="${this.id}-min-display">${this.formatValue(this.animationMin)}</span></span>
                    <span>Max: <span id="${this.id}-max-display">${this.formatValue(this.animationMax)}</span></span>
                </div>
                <div class="multi-thumb-slider">
                    <div class="slider-track"></div>
                    <div id="${this.id}-range" class="slider-range"></div>
                    <div id="${this.id}-current-indicator" class="slider-current-indicator"></div>
                    <div id="${this.id}-min-handle" class="slider-thumb min-thumb" data-bound="min">
                        <span class="thumb-label">MIN</span>
                    </div>
                    <div id="${this.id}-max-handle" class="slider-thumb max-thumb" data-bound="max">
                        <span class="thumb-label">MAX</span>
                    </div>
                </div>
            </div>
        `;e.insertAdjacentHTML("afterend",t)}setAnimationEnabled(e){this.animationEnabled=e,this.updateAnimationUI()}updateAnimationUI(){let e=document.getElementById(`${this.id}-animation-bounds`),t=document.getElementById(`${this.id}-anim-btn`);!e||!t||(this.animationEnabled?(typeof $<"u"?$(e).slideDown(200,()=>{this.triggerAccordionResize&&this.triggerAccordionResize()}):(e.style.display="block",this.triggerAccordionResize&&this.triggerAccordionResize()),t.classList.add("active"),t.title="Disable animation (\u{1F3AC})",this.updateBoundsDisplay()):(typeof $<"u"?$(e).slideUp(200,()=>{this.triggerAccordionResize&&this.triggerAccordionResize()}):(e.style.display="none",this.triggerAccordionResize&&this.triggerAccordionResize()),t.classList.remove("active"),t.title="Enable animation (\u{1F3AC})"))}setAnimationBounds(e,t){this.animationMin=Math.min(e,t),this.animationMax=Math.max(e,t),this.updateBoundsDisplay()}updateFromAlpha(e){if(!this.animationEnabled)return;this.currentAlpha=e;let t=this.animationMin+e*(this.animationMax-this.animationMin);this.isAnimating=!0,this.setValue(t),this.updateCurrentIndicator(e),this.isAnimating=!1}updateCurrentIndicator(e){let t=document.getElementById(`${this.id}-current-indicator`);t&&(t.style.left=`${e*100}%`)}updateBoundsDisplay(){let e=document.getElementById(`${this.id}-min-handle`),t=document.getElementById(`${this.id}-max-handle`),i=document.getElementById(`${this.id}-min-display`),r=document.getElementById(`${this.id}-max-display`),o=document.getElementById(`${this.id}-range`);if(!e||!t)return;let s=this.valueToPercent(this.animationMin),l=this.valueToPercent(this.animationMax);e.style.left=`${s}%`,t.style.left=`${l}%`,o&&(o.style.left=`${s}%`,o.style.width=`${l-s}%`),i&&(i.textContent=this.formatValue(this.animationMin)),r&&(r.textContent=this.formatValue(this.animationMax))}valueToPercent(e){let t=this.min||0,i=this.max||100;return(e-t)/(i-t)*100}percentToValue(e){let t=this.min||0,i=this.max||100;return t+e/100*(i-t)}attachThumbDragHandlers(){let e=document.getElementById(`${this.id}-min-handle`),t=document.getElementById(`${this.id}-max-handle`);if(!e||!t)return;let i=e.parentElement;[{handle:e,bound:"min"},{handle:t,bound:"max"}].forEach(({handle:r,bound:o})=>{let s=!1;r.addEventListener("mousedown",l=>{s=!0,r.classList.add("dragging"),document.body.style.userSelect="none",l.preventDefault()}),document.addEventListener("mousemove",l=>{if(!s)return;let c=i.getBoundingClientRect(),u=l.clientX-c.left,d=c.width,h=u/d*100;h=Math.max(0,Math.min(100,h));let p=this.percentToValue(h);o==="min"?p<=this.animationMax&&(this.animationMin=p):p>=this.animationMin&&(this.animationMax=p),this.updateBoundsDisplay()}),document.addEventListener("mouseup",()=>{s&&(s=!1,r.classList.remove("dragging"),document.body.style.userSelect="")})})}saveToSettings(e){super.saveToSettings(e),this.animationEnabled&&(e.animations||(e.animations={}),e.animations[this.settingsKey]={enabled:!0,min:this.animationMin,max:this.animationMax})}restoreFromSettings(e){if(super.restoreFromSettings(e),e&&e.animations&&e.animations[this.settingsKey]){let t=e.animations[this.settingsKey];this.animationEnabled=t.enabled||!1,this.animationMin=t.min,this.animationMax=t.max,requestAnimationFrame(()=>{this.updateAnimationUI()})}}}});var _i,Nr=G(()=>{_i=n=>class extends n{constructor(){super(),this._resizeObserver=null,this._accordionSection=null}connectedCallback(){super.connectedCallback(),requestAnimationFrame(()=>{this.setupAccordionResize()})}disconnectedCallback(){super.disconnectedCallback&&super.disconnectedCallback(),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null)}setupAccordionResize(){if(this._accordionSection=this.closest(".accordion-section"),!!this._accordionSection){if(typeof ResizeObserver>"u"){console.warn("ResizeObserver not available, accordion auto-resize disabled");return}this._resizeObserver=new ResizeObserver(e=>{this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(()=>{this.resizeAccordion()},50)}),this._resizeObserver.observe(this)}}resizeAccordion(){if(!this._accordionSection||this._accordionSection.classList.contains("collapsed"))return;let e=this._accordionSection.scrollHeight+"px";this._accordionSection.style.maxHeight=e}triggerAccordionResize(){this._accordionSection&&requestAnimationFrame(()=>{this.resizeAccordion()})}}});var Ei,Ur=G(()=>{Ei=n=>class extends n{constructor(){super(),this._shadowRoot=null}ensureShadowRoot(){return this._shadowRoot||(this._shadowRoot=this.attachShadow({mode:"open"})),this._shadowRoot}getShadowRoot(){return this.ensureShadowRoot()}renderToShadow(e){let t=this.ensureShadowRoot();t.innerHTML=e}shadowQuery(e){return this._shadowRoot?this._shadowRoot.querySelector(e):null}shadowQueryAll(e){return this._shadowRoot?this._shadowRoot.querySelectorAll(e):[]}querySelector(e){return this._shadowRoot?this._shadowRoot.querySelector(e):super.querySelector(e)}querySelectorAll(e){return this._shadowRoot?this._shadowRoot.querySelectorAll(e):super.querySelectorAll(e)}}});var $i,Or=G(()=>{$i=n=>class extends n{constructor(){super(),this._childControls=new Map}registerChildControl(e,t,i,r){this._childControls.set(e,{getValue:t,setValue:i,reset:r})}getValue(){let e={};for(let[t,i]of this._childControls.entries())e[t]=i.getValue();return e}setValue(e){if(!(typeof e!="object"||e===null))for(let[t,i]of this._childControls.entries())e[t]!==void 0&&i.setValue(e[t])}reset(){for(let e of this._childControls.values())e.reset()}initializeChildren(){throw new Error("Subclass must implement initializeChildren()")}}});var Ct=G(()=>{Vr();zr();Nr();Ur();Or()});var H,ce=G(()=>{Ct();H=class extends We(HTMLElement,xi,yi,vi,_i){constructor(){super(),this.transform=1,this._bindings=new Map,this._boundProperties=new Set,this._initialized=!1}connectedCallback(){this._initialized||(this.id||(this.id=this.generateId()),this.initializeControlProperties(),this.initializeProperties(),this.discoverBoundProperties(),this.processTemplate(),this.attachInternalListeners(),this._initialized=!0)}generateId(){return`control-${Math.random().toString(36).substr(2,9)}`}initializeProperties(){}discoverBoundProperties(){for(let e of this.attributes)if(e.name.startsWith("bind-")){let t=e.value;this._boundProperties.add(t)}}processTemplate(){let e=null,t=this.getAttribute("template");if(t){let c=document.getElementById(t);c&&c.tagName==="TEMPLATE"&&(e=c.content.cloneNode(!0))}if(!e){let c=this.querySelector(":scope > template");c&&(e=c.content.cloneNode(!0))}let i;e?(this.innerHTML="",this.appendChild(e),i=this):i=this;let r=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT,null,!1),o=[],s;for(;s=r.nextNode();)if(s!==this)for(let c of Array.from(s.attributes)){let u=c.value.match(/\{\{(\w+)\}\}/g);if(u){let d=c.value;u.forEach(h=>{let p=h.slice(2,-2);if(p in this&&this[p]!==void 0){let m=this[p];d=d.replace(h,m),o.push({element:s,attrName:c.name,varName:p})}}),c.value=d}}let l=this.innerHTML;l=l.replace(/\{\{(\w+)\}\}/g,(c,u)=>u in this&&this[u]!==void 0?this.formatValue(this[u]):c),this.innerHTML=l;for(let c of o)this.registerAttributeBinding(c.varName,c.attrName);this.registerBindings(this)}registerAttributeBinding(e,t){let i=this.querySelectorAll(`[${t}]`);for(let r of i)this._bindings.has(e)||this._bindings.set(e,new Set),this._bindings.get(e).add({element:r,type:"attr",attr:t})}registerBindings(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1),i;for(;i=t.nextNode();)if(i!==this)for(let r of i.attributes)r.name.startsWith("bind-")&&this.registerBinding(i,r.name,r.value)}registerBinding(e,t,i){this._bindings.has(i)||this._bindings.set(i,new Set);let r=this._bindings.get(i);if(t==="bind-text")r.add({element:e,type:"text",attr:null});else if(t.startsWith("bind-attr-")){let o=t.substring(10);r.add({element:e,type:"attr",attr:o})}else if(t==="bind-value")r.add({element:e,type:"value",attr:null});else if(t.startsWith("bind-class-")){let o=t.substring(11);r.add({element:e,type:"class",attr:o})}else t==="bind-show"&&r.add({element:e,type:"show",attr:null})}updateBindings(e,t){if(!this._bindings.has(e))return;let i=this._bindings.get(e);for(let r of i)switch(r.type){case"text":r.element.textContent=this.formatValue(t);break;case"attr":r.element.setAttribute(r.attr,t);break;case"value":r.element.value=t;break;case"class":r.element.classList.toggle(r.attr,!!t);break;case"show":r.element.style.display=t?"":"none";break}}formatValue(e){return e==null?"":String(e)}attachInternalListeners(){}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}findInput(e=null,t="input"){let i=this.querySelector(`[data-role="${t}"]`);return i||e&&(i=this.querySelector(`input[type="${e}"]`),i)?i:this.querySelector("input")}createReactiveProperty(e,t){let i=`_${e}`;this[i]=t,Object.defineProperty(this,e,{get(){return this[i]},set(r){this[i]=r,this.updateBindings(e,r)},enumerable:!0,configurable:!0})}createReactiveProperties(e){for(let[t,i]of Object.entries(e))this.createReactiveProperty(t,i)}addInputListener(e,t,i=0){if(e)if(i>0){let r;e.addEventListener("input",()=>{clearTimeout(r),r=setTimeout(t,i)})}else e.addEventListener("input",t)}findByRole(e,t=null){let i=this.querySelector(`[data-role="${e}"]`);return!i&&t&&(i=this.querySelector(t)),i}findAllByRole(e){return this.querySelectorAll(`[data-role="${e}"]`)}}});var Q,Te=G(()=>{ce();Q=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:50,min:0,max:100,step:1}),this._displayFormat=null,this._displayMultiplier=1,this._displaySuffix="",this.sliderInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Value",this.min=this.getNumberAttribute("min",0),this.max=this.getNumberAttribute("max",100),this.step=this.getNumberAttribute("step",1),this.transform=this.getNumberAttribute("transform",1),this.defaultValue=this.getNumberAttribute("default",50),this._displayMultiplier=this.getNumberAttribute("display-multiplier",1),this._displaySuffix=this.getAttribute("display-suffix")||"";let e=this.getAttribute("display-format");if(e!==null){let t=parseInt(e);this._displayFormat=i=>i!=null?i.toFixed(t):"0"}else this._displayFormat=t=>t!=null?t.toFixed(2):"0";this.value=this.defaultValue}formatValue(e){if(this._displayFormat&&typeof e=="number"){let t=e*this._displayMultiplier;return this._displayFormat(t)+this._displaySuffix}return super.formatValue(e)}attachInternalListeners(){if(this.sliderInput=this.findByRole("slider",'input[type="range"]'),!this.sliderInput)return;let e=()=>{this.value=parseFloat(this.sliderInput.value)/this.transform,this.triggerChange()};this.addInputListener(this.sliderInput,e),this.sliderInput.addEventListener("change",e),this.sliderInput.addEventListener("click",t=>{e()}),this.registerActionButtons(["decrease","increase","decrease-large","increase-large","reset"])}getValue(){return this.sliderInput?parseFloat(this.sliderInput.value)/this.transform:this.value}setValue(e){this.value=e,this.sliderInput&&(this.sliderInput.value=e*this.transform)}handleButtonAction(e){let t=this.value,i=t,r=this.step/this.transform,o=this.min/this.transform,s=this.max/this.transform;if(e==="increase")i=Math.min(s,t+r);else if(e==="decrease")i=Math.max(o,t-r);else if(e==="increase-large")i=Math.min(s,t+r*10);else if(e==="decrease-large")i=Math.max(o,t-r*10);else if(e==="reset")i=this.defaultValue;else return!1;return i!==t?(this.setValue(i),this.triggerChange(),!0):!1}}});var Hr={};Ot(Hr,{AnimatableSlider:()=>ue,createFadeTransform:()=>Gr});function Gr(){let t=Math.log(.9),r=(Math.log(.9999)-t)/100;return{transform:o=>{let s=100-o;return Math.exp(t+r*s)},inverseTransform:o=>100-(Math.log(o)-t)/r}}var ue,Je=G(()=>{Te();Ct();ue=class extends wi(Q){constructor(){super()}valueToPercent(e){if(this._customTransform&&this._customInverseTransform){let t=this._customInverseTransform(e),i=this.min||0,r=this.max||100;return(t-i)/(r-i)*100}return super.valueToPercent?super.valueToPercent(e):(e-this.min)/(this.max-this.min)*100}percentToValue(e){if(this._customTransform&&this._customInverseTransform){let t=this.min||0,i=this.max||100,r=t+e/100*(i-t);return this._customTransform(r)}return super.percentToValue?super.percentToValue(e):this.min+e/100*(this.max-this.min)}getValue(){if(this._customTransform&&this.sliderInput){let e=parseFloat(this.sliderInput.value);return this._customTransform(e)}return super.getValue()}setValue(e){if(this._customInverseTransform&&this.sliderInput){this.value=e;let t=this._customInverseTransform(e);this.sliderInput.value=t}else super.setValue(e)}setCustomTransform(e,t){if(this._customTransform=e,this._customInverseTransform=t,this.value!==void 0&&this.sliderInput){let i=this._customInverseTransform(this.value);this.sliderInput.value=i}this.animationEnabled&&this.updateBoundsDisplay()}}});var De=class{constructor(e,t,i,r){this.gl=e,this.dimensions=t,this.resolution=i,this.strategy=r,this.readTextures=[],this.writeTextures=[];for(let o=0;o<t;o++)this.readTextures.push(this.createTexture()),this.writeTextures.push(this.createTexture());this.lineMode=!1,this.prevTextures=[];for(let o=0;o<t;o++)this.prevTextures.push(this.createTexture());this.textureUnitOffset=0}createTexture(){let e=this.gl,t=e.createTexture(),i=this.strategy.getTextureFormat();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,null),t}setLineMode(e){this.lineMode=e}setNeedsPrevTextures(e){}initializeData(e){let t=this.gl,i=this.strategy.getTextureFormat();for(let s=0;s<this.dimensions;s++)t.bindTexture(t.TEXTURE_2D,this.readTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,e[s]),t.bindTexture(t.TEXTURE_2D,this.writeTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,null),t.bindTexture(t.TEXTURE_2D,this.prevTextures[s]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,e[s]);let r=this.strategy.getArrayType(),o=this.strategy.getComponentsPerValue();if(i.format===t.RGBA){let s=e[0];for(let l=0;l<this.resolution*this.resolution;l++)o===4&&(s[l*4+3]=1);t.bindTexture(t.TEXTURE_2D,this.readTextures[0]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,s),t.bindTexture(t.TEXTURE_2D,this.prevTextures[0]),t.texImage2D(t.TEXTURE_2D,0,i.internalFormat,this.resolution,this.resolution,0,i.format,i.type,s)}}bindReadTextures(e){let t=this.gl;for(let i=0;i<this.dimensions;i++){let r=`u_pos_${i}`,o=t.getUniformLocation(e,r);o!==null&&(t.activeTexture(t.TEXTURE0+this.textureUnitOffset+i),t.bindTexture(t.TEXTURE_2D,this.readTextures[i]),t.uniform1i(o,this.textureUnitOffset+i))}}bindPrevTextures(e){let t=this.gl;for(let i=0;i<this.dimensions;i++){let r=`u_prev_pos_${i}`,o=t.getUniformLocation(e,r);if(o!==null){let s=this.textureUnitOffset+this.dimensions+i;t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,this.prevTextures[i]),t.uniform1i(o,s)}}}getWriteTexture(e){return this.writeTextures[e]}swap(){let e=this.prevTextures;this.prevTextures=this.readTextures,this.readTextures=this.writeTextures,this.writeTextures=e}resize(e){let t=this.gl;this.resolution=e;for(let i=0;i<this.dimensions;i++)t.deleteTexture(this.readTextures[i]),t.deleteTexture(this.writeTextures[i]),t.deleteTexture(this.prevTextures[i]);this.readTextures=[],this.writeTextures=[],this.prevTextures=[];for(let i=0;i<this.dimensions;i++)this.readTextures.push(this.createTexture()),this.writeTextures.push(this.createTexture()),this.prevTextures.push(this.createTexture())}dispose(){let e=this.gl;for(let t=0;t<this.dimensions;t++)e.deleteTexture(this.readTextures[t]),e.deleteTexture(this.writeTextures[t]),e.deleteTexture(this.prevTextures[t]);this.readTextures=[],this.writeTextures=[],this.prevTextures=[]}getReadTextures(){return this.readTextures}readTexture(e){let t=this.gl,i=this.strategy.getTextureFormat(),r=this.strategy.getArrayType(),o=this.strategy.getComponentsPerValue(),s=new r(this.resolution*this.resolution*o),l=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,l),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.readTextures[e],0),t.readPixels(0,0,this.resolution,this.resolution,i.format,i.type,s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(l),s}};M();var ke=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.useHDR=r.useHDR!==void 0?r.useHDR:!0,this.usePingPong=r.usePingPong!==void 0?r.usePingPong:!0,this.checkExtensions(),this.initialize(),a.info("FramebufferManager initialized",{width:t,height:i,useHDR:this.useHDR,hdrSupported:this.hdrSupported,textureFormat:this.getTextureFormatName()})}checkExtensions(){let e=this.gl;a.verbose("Checking WebGL extensions for HDR support..."),this.floatTextureExt=e.getExtension("OES_texture_float"),this.halfFloatTextureExt=e.getExtension("OES_texture_half_float"),this.floatColorBufferExt=e.getExtension("WEBGL_color_buffer_float")||e.getExtension("EXT_color_buffer_float"),this.halfFloatColorBufferExt=e.getExtension("EXT_color_buffer_half_float"),this.floatLinearExt=e.getExtension("OES_texture_float_linear"),this.halfFloatLinearExt=e.getExtension("OES_texture_half_float_linear"),this.floatBlendExt=e.getExtension("EXT_float_blend"),a.verbose("WebGL extension support:",{OES_texture_float:!!this.floatTextureExt,OES_texture_half_float:!!this.halfFloatTextureExt,WEBGL_color_buffer_float:!!this.floatColorBufferExt,EXT_color_buffer_half_float:!!this.halfFloatColorBufferExt,OES_texture_float_linear:!!this.floatLinearExt,OES_texture_half_float_linear:!!this.halfFloatLinearExt,EXT_float_blend:!!this.floatBlendExt}),this.hdrSupported=!!(this.floatColorBufferExt||this.halfFloatColorBufferExt),a.verbose(`HDR support determined: ${this.hdrSupported?"SUPPORTED":"NOT SUPPORTED"}`),this.useHDR&&!this.hdrSupported&&(a.warn("HDR rendering requested but not supported by device. Falling back to LDR."),this.useHDR=!1),this.useHDR?this.floatColorBufferExt?(this.hdrType=e.FLOAT,this.hdrTypeExt=this.floatTextureExt,this.linearExt=this.floatLinearExt,a.info("Selected RGBA32F (full float) for HDR framebuffers")):this.halfFloatColorBufferExt&&(this.hdrType=this.halfFloatTextureExt.HALF_FLOAT_OES,this.hdrTypeExt=this.halfFloatTextureExt,this.linearExt=this.halfFloatLinearExt,a.info("Selected RGBA16F (half float) for HDR framebuffers")):a.verbose("Using LDR (RGBA8) framebuffers")}initialize(){let e=this.gl;if(a.verbose(`Creating ${this.usePingPong?"ping-pong":"single"} framebuffers...`),this.usePingPong){this.framebuffers=[e.createFramebuffer(),e.createFramebuffer()],this.textures=[this.createTexture(),this.createTexture()],this.depthBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height);for(let t=0;t<2;t++)e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[t]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textures[t],0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(t);this.currentIndex=0}else this.framebuffers=[e.createFramebuffer()],this.textures=[this.createTexture()],this.depthBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[0]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textures[0],0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(0),this.currentIndex=0;e.bindFramebuffer(e.FRAMEBUFFER,null)}createTexture(){let e=this.gl,t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let i=this.useHDR&&this.linearExt?e.LINEAR:e.NEAREST,r=this.useHDR&&this.linearExt?e.LINEAR:e.NEAREST;return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),this.useHDR?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,this.hdrType,null):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),t}checkFramebufferStatus(e){let t=this.gl;if(t.isContextLost())throw new Error("WebGL context lost");let i=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i!==t.FRAMEBUFFER_COMPLETE){let r=this.getFramebufferStatusString(i);throw a.error(`Framebuffer ${e} is not complete: ${r}`,{format:this.getTextureFormatName(),size:`${this.width}x${this.height}`,status:i,contextLost:t.isContextLost()}),new Error(`Framebuffer ${e} incomplete: ${r}`)}a.verbose(`Framebuffer ${e} created successfully: ${this.getTextureFormatName()} at ${this.width}x${this.height}`)}getFramebufferStatusString(e){let t=this.gl;switch(e){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:return"UNSUPPORTED";default:return`UNKNOWN (${e})`}}getTextureFormatName(){return this.useHDR?this.hdrType===this.gl.FLOAT?"RGBA32F (Full HDR)":"RGBA16F (Half HDR)":"RGBA8 (LDR)"}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[this.currentIndex]),e.viewport(0,0,this.width,this.height)}bindCanvas(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}getCurrentTexture(){return this.textures[this.currentIndex]}getPreviousTexture(){return this.usePingPong?this.textures[1-this.currentIndex]:this.textures[0]}swap(){this.usePingPong&&(this.currentIndex=1-this.currentIndex)}clear(e=0,t=0,i=0,r=1){let o=this.gl;this.bind(),o.clearColor(e,t,i,r),o.clear(o.COLOR_BUFFER_BIT)}clearAll(e=0,t=0,i=0,r=1){let o=this.gl;for(let s=0;s<this.framebuffers.length;s++)o.bindFramebuffer(o.FRAMEBUFFER,this.framebuffers[s]),o.clearColor(e,t,i,r),o.clear(o.COLOR_BUFFER_BIT);o.bindFramebuffer(o.FRAMEBUFFER,null)}resize(e,t){if(e===this.width&&t===this.height)return;a.info("Resizing HDR framebuffers",{from:`${this.width}x${this.height}`,to:`${e}x${t}`,format:this.getTextureFormatName()}),this.width=e,this.height=t;let i=this.gl;for(let r of this.textures)i.deleteTexture(r);this.depthBuffer&&i.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this.depthBuffer),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),this.textures=[];for(let r=0;r<this.framebuffers.length;r++)this.textures.push(this.createTexture()),i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffers[r]),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.textures[r],0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this.depthBuffer),this.checkFramebufferStatus(r);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.clearAll()}dispose(){let e=this.gl;for(let t of this.framebuffers)e.deleteFramebuffer(t);for(let t of this.textures)e.deleteTexture(t);this.framebuffers=[],this.textures=[],a.verbose("FramebufferManager disposed")}isHDR(){return this.useHDR&&this.hdrSupported}getHDRSupport(){return{supported:this.hdrSupported,enabled:this.useHDR,format:this.getTextureFormatName(),hasFloatColorBuffer:!!this.floatColorBufferExt,hasHalfFloatColorBuffer:!!this.halfFloatColorBufferExt,hasLinearFiltering:!!this.linearExt}}};M();se();function Bi(n,e,t){let i=n.createShader(e);if(n.shaderSource(i,t),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS)){let r=n.getShaderInfoLog(i);throw n.deleteShader(i),new Error(`Shader compilation error: ${r}

Source:
${pn(t)}`)}return i}function mn(n,e,t){let i=n.createProgram();if(n.attachShader(i,e),n.attachShader(i,t),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS)){let r=n.getProgramInfoLog(i);throw n.deleteProgram(i),new Error(`Program linking error: ${r}`)}return i}function K(n,e,t){let i=Bi(n,n.VERTEX_SHADER,e),r=Bi(n,n.FRAGMENT_SHADER,t),o=mn(n,i,r);return n.deleteShader(i),n.deleteShader(r),o}function pn(n){return n.split(`
`).map((e,t)=>`${t+1}: ${e}`).join(`
`)}function Vi(){return`
precision highp float;

attribute vec2 a_pos;

void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`}function zi(n,e,t,i,r=null,o=null){let s=Array.from({length:n},(g,y)=>`uniform sampler2D u_pos_${y};`).join(`
`),l=`vec${n}`,c=Array.from({length:n},(g,y)=>`decodeFloat(texture2D(u_pos_${y}, v_texcoord))`).join(", "),u=["x","y","z","w"],d=e.map((g,y)=>`    result.${u[y]} = ${g};`).join(`
`),h=o&&o.forwardTransform,p=h?`
// Coordinate system transformation functions (native-space integration)
${o.forwardTransform}
${o.inverseTransform}
// Note: velocityTransform not needed with native-space integration
`:"",m=r&&r.forward,f=m?`
// Domain transformation functions
${r.helpers||""}
${r.forward}
${r.inverse}
${r.jacobian}
`:"",b=h?`
// User-defined velocity field in native coordinates (${o.name||"custom"})
${l} get_velocity_native(${l} pos_native) {
    ${l} result;
    // Extract native coordinates for use in expressions
    float ${o.nativeVars?o.nativeVars.map((g,y)=>`${g} = pos_native.${u[y]}`).join(", "):u.slice(0,n).map((g,y)=>`${g} = pos_native.${g}`).join(", ")};
${d}
    return result;
}

// Velocity function in Cartesian (redirects to native, for use by integrator)
${l} get_velocity(${l} pos_native) {
    return get_velocity_native(pos_native);
}
`:m?`
// Original velocity field in world coordinates
${l} get_velocity_original(${l} pos) {
    ${l} result;
    float x = pos.x;
    ${n>1?"float y = pos.y;":""}
    ${n>2?"float z = pos.z;":""}
    ${n>3?"float w = pos.w;":""}

${d}

    return result;
}

// Transformed velocity field: dy/dt = J_T(x) * f(x)
// where y = T(x)
${l} get_velocity(${l} pos_transformed) {
    // Transform back to world coordinates
    ${l} pos = transform_inverse(pos_transformed);

    // Evaluate original velocity field
    ${l} vel_original = get_velocity_original(pos);

    // Apply Jacobian: component-wise multiplication
    ${l} jacobian = transform_jacobian(pos);
    return vel_original * jacobian;
}
`:`
// User-defined velocity field (no transform)
${l} get_velocity(${l} pos) {
    ${l} result;
    float x = pos.x;
    ${n>1?"float y = pos.y;":""}
    ${n>2?"float z = pos.z;":""}
    ${n>3?"float w = pos.w;":""}

${d}

    return result;
}
`,x=nt();return`
precision highp float;

${i.getGLSLConstants()}
${i.getGLSLDecodeFunction()}
${i.getGLSLEncodeFunction()}
${i.getGLSLNormalizeFunction()}
${i.getGLSLDenormalizeFunction()}

${x}

${s}

uniform vec2 u_min;
uniform vec2 u_max;
uniform float u_h;
uniform float u_rand_seed;
uniform float u_drop_rate;
uniform float u_respawn_margin;
uniform int u_out_coordinate;
uniform float u_particles_res;
uniform float u_max_velocity;
uniform float u_alpha;
${m?"uniform vec4 u_transform_params;":""}

${p}

${f}

${b}

${t}

// High-quality hash-based random number generator
// Returns value in [0, 1] with good distribution
float rand(vec2 co) {
    // Hash the input
    vec2 p = co + vec2(u_rand_seed, u_rand_seed * 1.61803398875);
    // Use a better hash function
    p = fract(p * vec2(443.897, 441.423));
    p += dot(p.yx, p.xy + vec2(19.19, 17.17));
    return fract(p.x * p.y);
}

// Secondary independent random function
float rand2(vec2 co) {
    vec2 p = co + vec2(u_rand_seed * 2.71828, u_rand_seed * 3.14159);
    p = fract(p * vec2(269.5, 271.3));
    p += dot(p.yx, p.xy + vec2(23.23, 29.29));
    return fract(p.x * p.y);
}

void main() {
    vec2 texcoord = gl_FragCoord.xy / u_particles_res;

    // Read current age from alpha channel of u_pos_0
    float current_age = texture2D(u_pos_0, texcoord).a;

    // Read current position from textures
    // Positions are stored as normalized [0,1] values, denormalize to world coords
    ${l} pos;
    ${Array.from({length:n},(g,y)=>{let _=["x","y","z","w"][y];return y===0?`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), u_min.x, u_max.x);`:y===1?`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), u_min.y, u_max.y);`:`pos.${_} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${y}, texcoord)), -10.0, 10.0);`}).join(`
    `)}

    // Integrate to get new position
    ${l} new_pos;
    ${h?`
    // NATIVE-SPACE INTEGRATION:
    // 1. Transform position to native coordinates
    // 2. Integrate in native space (using velocity defined in native coords)
    // 3. Transform result back to Cartesian
    ${l} pos_native = transformToNative(pos);
    ${l} new_pos_native = integrate(pos_native, u_h);
    new_pos = transformToCartesian(new_pos_native);
    `:m?`
    // Transform to y-space, integrate, then transform back to x-space
    ${l} pos_transformed = transform_forward(pos);
    ${l} new_pos_transformed = integrate(pos_transformed, u_h);
    new_pos = transform_inverse(new_pos_transformed);
    `:`
    // Direct integration (no transform)
    new_pos = integrate(pos, u_h);
    `}

    // Check if particle is outside viewport bounds with configurable margin
    // Margin allows particles to flow off-screen before respawning
    float width = u_max.x - u_min.x;
    float height = u_max.y - u_min.y;
    bool outside = new_pos.x < (u_min.x - width * u_respawn_margin) || new_pos.x > (u_max.x + width * u_respawn_margin) ||
                   new_pos.y < (u_min.y - height * u_respawn_margin) || new_pos.y > (u_max.y + height * u_respawn_margin);

    // Random drop: reset particle to random position with small probability
    // Also reset if particle exits the viewport
    float drop_chance = rand(texcoord);
    bool should_respawn = drop_chance < u_drop_rate || outside;
    if (should_respawn) {
        // Spawn particles 2% OUTSIDE viewport for natural flow-in effect (negative margin)
        // Use texcoord + rand_seed for truly independent random values per particle per frame
        const float margin = -0.02;
        ${n===2?`new_pos.x = u_min.x + width * margin + rand(texcoord * 1.234 + vec2(u_rand_seed)) * width * (1.0 - 2.0 * margin);
        new_pos.y = u_min.y + height * margin + rand2(texcoord * 5.678 + vec2(u_rand_seed * 2.345)) * height * (1.0 - 2.0 * margin);`:Array.from({length:n},(g,y)=>{let _=["x","y","z","w"];return y===0?"new_pos.x = u_min.x + width * margin + rand(texcoord * 1.234 + vec2(u_rand_seed)) * width * (1.0 - 2.0 * margin);":y===1?"new_pos.y = u_min.y + height * margin + rand2(texcoord * 5.678 + vec2(u_rand_seed * 2.345)) * height * (1.0 - 2.0 * margin);":`new_pos.${_[y]} = -10.4 + rand(texcoord * ${y+1}.37 + vec2(u_rand_seed * ${y+3}.5)) * 20.8;`}).join(`
        `)}
    }

    // Calculate new age (based on all spawn conditions)
    float new_age;
    if (should_respawn) {
        new_age = 0.0; // Reset age for newly spawned particles
    } else {
        new_age = min(current_age + 0.5, 1.0); // Increment age, cap at 1.0
    }

    // Output the selected coordinate
    // Normalize world coords back to [0, 1] before encoding
    ${Array.from({length:n},(g,y)=>{let _=["x","y","z","w"][y],S;return y===0?S=`normalizeToViewport(new_pos.${_}, u_min.x, u_max.x)`:y===1?S=`normalizeToViewport(new_pos.${_}, u_min.y, u_max.y)`:S=`normalizeToViewport(new_pos.${_}, -10.0, 10.0)`,y===0?`if (u_out_coordinate == ${y}) {
        gl_FragColor = encodeFloat(${S});
        gl_FragColor.a = new_age; // Store age in alpha channel
    }`:y===n-1?` else {
        gl_FragColor = encodeFloat(${S});
    }`:` else if (u_out_coordinate == ${y}) {
        gl_FragColor = encodeFloat(${S});
    }`}).join("")}
}
`}function Ni(n,e,t,i,r=!1,o=null){let s=o&&o.forwardTransform,l=Array.from({length:n},(b,x)=>`uniform sampler2D u_pos_${x};`).join(`
`),c=Array.from({length:n},(b,x)=>`uniform sampler2D u_prev_pos_${x};`).join(`
`),u=`vec${n}`,d=["x","y","z","w"],h=t.map((b,x)=>`    result.${d[x]} = ${b};`).join(`
`),p=s?`
// Coordinate system transformation functions
${o.forwardTransform}
${o.inverseTransform}
// Note: inverseTransform needed for computing Cartesian velocity via finite differences
`:"",m=s?`
// User-defined velocity field in native coordinates
${u} get_velocity_native(${u} pos_native) {
    ${u} result;
${h}
    return result;
}

// Velocity field for visualization (no Cartesian transform needed with native-space integration)
${u} get_velocity(${u} pos_cartesian) {
    ${u} pos_native = transformToNative(pos_cartesian);
    return get_velocity_native(pos_native);
}
`:`
// User-defined velocity field
${u} get_velocity(${u} pos) {
    ${u} result;
    float x = pos.x;
    ${n>1?"float y = pos.y;":""}
    ${n>2?"float z = pos.z;":""}
    ${n>3?"float w = pos.w;":""}

${h}

    return result;
}
`,f=nt();return`
precision highp float;

${i.getGLSLConstants()}
${i.getGLSLDecodeFunction()}
${i.getGLSLDenormalizeFunction()}

${f}

attribute float a_index;
${r?"attribute float a_vertex_id; // 0 = prev, 1 = current":""}

${l}
${c}

uniform float u_particles_res;
uniform vec2 u_min;
uniform vec2 u_max;
uniform float u_alpha;
uniform float u_particle_size;
uniform vec2 u_viewport_size;  // Actual render resolution (renderWidth, renderHeight)
uniform vec2 u_canvas_size;    // Canvas resolution (canvas.width, canvas.height)

varying vec${n} v_pos;
varying vec${n} v_velocity;          // Actual particle velocity (pos - prev_pos)
varying vec${n} v_field_velocity;    // Vector field at particle position
varying vec${n} v_velocity_projected; // Projected 2D velocity (for angle-based color modes)

${e}

${p}

${m}

void main() {
    ${r?`
    // Line mode: index buffer has [0,0,1,1,2,2,3,3,...], vertex ID buffer has [0,1,0,1,0,1,...]
    // a_vertex_id = 0 means previous position, 1 means current position
    float particle_index = a_index;
    bool is_current = a_vertex_id > 0.5;
    `:`
    // Point mode: one vertex per particle
    float particle_index = a_index;
    `}

    // Calculate texture coordinate from particle index
    // Add 0.5 to sample from texel centers
    vec2 texcoord = vec2(
        (mod(particle_index, u_particles_res) + 0.5) / u_particles_res,
        (floor(particle_index / u_particles_res) + 0.5) / u_particles_res
    );

    // Read age from alpha channel of u_pos_0
    float age = texture2D(u_pos_0, texcoord).a;

    // Read position from textures and denormalize to world coordinates
    ${u} pos;
    ${r?`
    if (is_current) {
        // Current position
        ${Array.from({length:n},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
        `)}
    } else {
        // Previous position
        ${Array.from({length:n},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
        `)}
    }
    `:`
    ${Array.from({length:n},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), u_min.y, u_max.y);`:`pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
    `)}
    `}

    // Calculate ACTUAL particle velocity for coloring (not vector field!)
    // This gives correct colors based on particle motion, not field strength
    ${u} prev_pos;
    ${Array.from({length:n},(b,x)=>{let g=["x","y","z","w"][x];return x===0?`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.x, u_max.x);`:x===1?`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), u_min.y, u_max.y);`:`prev_pos.${g} = denormalizeFromViewport(decodeFloat(texture2D(u_prev_pos_${x}, texcoord)), -10.0, 10.0);`}).join(`
    `)}

    // Actual particle velocity from position difference
    ${u} velocity = pos - prev_pos;

    // Also compute vector field at current position (for field-based color modes)
    ${u} field_velocity = get_velocity(pos);

    // Pass N-dimensional position and full velocity to fragment shader
    v_pos = pos;
    v_velocity = velocity; // Actual particle velocity for expression mode
    v_field_velocity = field_velocity; // Vector field at position

    // Skip newly spawned particles (age < 1) by moving them off-screen
    if (age < 1.0) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0); // Far outside clip space
        gl_PointSize = 0.0;
        v_velocity_projected = velocity; // Won't be used since particle is off-screen
    } else {
        // Project position to 3D (with depth)
        vec3 pos_3d = project_to_3d(pos);

        // Project velocity to 2D (using same mapper)
        // For linear projections, this is correct for tangent vectors
        vec2 velocity_2d = project_to_2d(velocity);

        // Create 2D velocity vector (pad to match dimensions for varying)
        ${u} velocity_projected;
        velocity_projected.x = velocity_2d.x;
        velocity_projected.y = velocity_2d.y;
        ${n>2?"velocity_projected.z = 0.0;":""}
        ${n>3?"velocity_projected.w = 0.0;":""}

        // Pass projected 2D velocity to fragment shader (for angle-based color modes)
        v_velocity_projected = velocity_projected;

        // Map to screen space
        vec2 normalized = (pos_3d.xy - u_min) / (u_max - u_min);

        // Use depth value (normalized to [-1, 1] range)
        // For now, assume depth is in similar range to x/y coordinates
        float depth_normalized = (pos_3d.z - (u_min.x + u_min.y) * 0.5) / ((u_max.x - u_min.x + u_max.y - u_min.y) * 0.5);
        depth_normalized = clamp(depth_normalized, -1.0, 1.0);

        gl_Position = vec4(normalized * 2.0 - 1.0, depth_normalized, 1.0);

        // Scale particle size by render scale to maintain consistent visual size
        // Calculate render scale as viewport size / canvas size
        float render_scale = u_viewport_size.x / u_canvas_size.x;
        gl_PointSize = u_particle_size * render_scale;
    }
}
`}function Ui(n,e,t){return`
precision highp float;

${nt()}

varying vec${n} v_pos;
varying vec${n} v_velocity;          // Actual particle velocity (pos - prev_pos)
varying vec${n} v_field_velocity;    // Vector field at particle position
varying vec${n} v_velocity_projected; // Projected 2D velocity (for angle-based color modes)

${t?`uniform float u_max_velocity;
uniform float u_velocity_log_scale;`:""}
uniform float u_particle_intensity;
uniform float u_color_saturation;
uniform float u_alpha;
uniform vec2 u_viewport_size;  // Actual render resolution
uniform vec2 u_canvas_size;    // Canvas resolution

${e}

void main() {
    // Get color based on position, particle velocity, and field velocity
    vec3 color = getColor(v_pos, v_velocity, v_field_velocity, v_velocity_projected);

    // Apply saturation adjustment (for attractor visualization)
    // 0.0 = grayscale, 1.0 = full saturation
    if (u_color_saturation < 1.0) {
        float luminance = dot(color, vec3(0.2126, 0.7152, 0.0722));
        vec3 grayscale = vec3(luminance);
        color = mix(grayscale, color, u_color_saturation);
    }

    // Scale by intensity for HDR (allows colors > 1.0)
    color *= u_particle_intensity;

    // Calculate render scale factor
    float render_scale = u_viewport_size.x / u_canvas_size.x;

    // Compensate alpha for particle size scaling to maintain constant brightness
    // Particle area scales with render_scale\xB2, so divide alpha by render_scale\xB2
    // This ensures that larger particles contribute the same total brightness
    float area_compensation = 1.0 / (render_scale * render_scale);
    float adjusted_alpha = 0.35 * area_compensation;

    // Alpha blending allows proper fade to black
    gl_FragColor = vec4(color, adjusted_alpha);
}
`}function Oi(){return`
precision highp float;

attribute vec2 a_pos;
varying vec2 v_texcoord;

void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`}function Gi(){return`
precision highp float;

uniform sampler2D u_screen;
uniform float u_fade;

varying vec2 v_texcoord;

void main() {
    vec4 color = texture2D(u_screen, v_texcoord);
    vec3 faded = color.rgb * u_fade;

    // Snap to black if very dark (prevents floating point precision issues)
    // This ensures trails fade completely to black
    float brightness = max(max(faded.r, faded.g), faded.b);
    if (brightness < 0.003) {
        faded = vec3(0.0);
    }

    gl_FragColor = vec4(faded, 1.0);
}
`}function Hi(n=""){return n||(n=`
vec3 tonemap(vec3 color) {
    return color * u_exposure;
}

vec3 applyGamma(vec3 color) {
    return pow(color, vec3(1.0 / u_gamma));
}
`),`
precision highp float;

uniform sampler2D u_screen;
uniform float u_exposure;
uniform float u_gamma;
uniform float u_whitePoint;
uniform float u_brightness_desat;
uniform float u_brightness_sat;
uniform float u_hdr_max_brightness;
uniform float u_hdr_avg_brightness;
uniform float u_highlight_compression;
uniform float u_compression_threshold;

varying vec2 v_texcoord;

// Logarithmic highlight compression (pre-tone mapping)
// Only compresses values above threshold to help tone mapper cover full dynamic range
// Preserves hue by compressing luminance only, then scaling RGB to match
vec3 compressHighlights(vec3 color, float strength, float threshold) {
    if (strength < 0.0001) return color; // Disabled

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return color;

    // Compress luminance only
    float compressedLuma;
    if (luma <= threshold) {
        compressedLuma = luma; // Below threshold: unchanged
    } else {
        // Above threshold: compress the excess
        float excess = luma - threshold;
        float compressed = log(1.0 + excess * strength) / strength;
        compressedLuma = threshold + compressed;
    }

    // Scale RGB to match compressed luminance (preserves hue and saturation)
    return color * (compressedLuma / luma);
}

${n}

void main() {
    // Read HDR color from framebuffer
    vec3 hdrColor = texture2D(u_screen, v_texcoord).rgb;

    // Calculate HDR brightness once for both effects (Rec. 709 luminance)
    float hdrBrightness = dot(hdrColor, vec3(0.2126, 0.7152, 0.0722));
    vec3 hdrGray = vec3(hdrBrightness);

    // Get adaptive thresholds based on actual HDR buffer statistics
    float avgBrightness = max(u_hdr_avg_brightness, 0.1); // Avoid division by zero
    float maxBrightness = max(u_hdr_max_brightness, 1.0);

    // Work in log space to handle the massive dynamic range (0.1 to 100,000+)
    float logAvg = log2(avgBrightness + 1.0);
    float logMax = log2(maxBrightness + 1.0);
    float logBrightness = log2(hdrBrightness + 1.0);

    // Apply brightness-based DESATURATION (desaturates BRIGHT regions)
    // Prevents oversaturation and RGB clipping in dense accumulations
    if (u_brightness_desat > 0.0) {
        // Target brighter-than-average regions (where particles accumulate)
        // Start desaturating at 2x average, full desat at 100x average
        // This hits the actual bright accumulations, not just the max peaks
        float brightStart = avgBrightness * 2.0;
        float brightEnd = avgBrightness * 100.0;
        float logBrightStart = log2(brightStart + 1.0);
        float logBrightEnd = log2(brightEnd + 1.0);
        float desatFactor = smoothstep(logBrightStart, logBrightEnd, logBrightness) * u_brightness_desat;

        // Blend toward grayscale
        hdrColor = mix(hdrColor, hdrGray, desatFactor);
    }

    // Apply brightness-based SATURATION BUILDUP (desaturates DIM regions)
    // Creates effect where sparse particles are washed out, dense accumulations pop with color
    if (u_brightness_sat > 0.0) {
        // Slider controls the threshold: higher values = more aggressive desaturation
        // - At 0.3: pixels below ~1000x average are desaturated
        // - At 0.5: pixels below ~4000x average are desaturated
        // - At 1.0: pixels below ~137,000 (max) are desaturated (very aggressive)
        float threshold = avgBrightness * pow(10.0, u_brightness_sat * 3.0); // 1x to 1000x average
        float logThreshold = log2(threshold + 1.0);

        // Narrow transition for sharp cutoff
        float logTransitionStart = log2(avgBrightness * 0.1 + 1.0); // 10% of average
        float satFactor = smoothstep(logTransitionStart, logThreshold, logBrightness);

        // Apply the effect: low brightness gets desaturated AND dimmed
        float desatAmount = (1.0 - satFactor) * u_brightness_sat;
        hdrColor = mix(hdrColor, hdrGray, desatAmount);

        // Also reduce brightness in desaturated regions
        // This makes sparse trails even more subtle (both dim and colorless)
        hdrColor *= (1.0 - desatAmount * 0.5); // Reduce brightness by up to 50%
    }

    // Apply gamma correction in HDR space (before tone mapping)
    // This prevents clipping and gives the tone mapper more headroom
    vec3 gammaCorrected = applyGamma(hdrColor);

    // Apply luminance gamma in HDR space (hue-preserving brightness adjustment)
    vec3 hdrGammaCorrected = applyLuminanceGamma(gammaCorrected);

    // Apply highlight compression to compress bright values before tone mapping
    // This helps the tone mapper cover the full dynamic range more effectively
    vec3 compressed = compressHighlights(hdrGammaCorrected, u_highlight_compression, u_compression_threshold);

    // Apply tone mapping operator to compress HDR values into LDR range
    vec3 ldrColor = tonemap(compressed);

    gl_FragColor = vec4(ldrColor, 1.0);
}
`}function fn(){return`
precision highp float;

uniform sampler2D u_screen;
uniform vec2 u_resolution;
uniform float u_spatialSigma;   // Spatial blur radius
uniform float u_intensitySigma; // Edge preservation threshold

varying vec2 v_uv;

// Gaussian function
float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma));
}

// Luminance for edge detection
float luminance(vec3 color) {
    return dot(color, vec3(0.299, 0.587, 0.114));
}

void main() {
    vec2 texelSize = 1.0 / u_resolution;

    vec3 centerColor = texture2D(u_screen, v_uv).rgb;
    float centerLum = luminance(centerColor);

    // Single-pass noise detection using simple statistics
    const float brightnessThreshold = 0.05;

    // Sample 3x3 neighborhood (unrolled - no arrays)
    float s0 = luminance(texture2D(u_screen, v_uv + vec2(-1.0, -1.0) * texelSize).rgb);
    float s1 = luminance(texture2D(u_screen, v_uv + vec2( 0.0, -1.0) * texelSize).rgb);
    float s2 = luminance(texture2D(u_screen, v_uv + vec2( 1.0, -1.0) * texelSize).rgb);
    float s3 = luminance(texture2D(u_screen, v_uv + vec2(-1.0,  0.0) * texelSize).rgb);
    float s4 = luminance(texture2D(u_screen, v_uv + vec2( 0.0,  0.0) * texelSize).rgb);
    float s5 = luminance(texture2D(u_screen, v_uv + vec2( 1.0,  0.0) * texelSize).rgb);
    float s6 = luminance(texture2D(u_screen, v_uv + vec2(-1.0,  1.0) * texelSize).rgb);
    float s7 = luminance(texture2D(u_screen, v_uv + vec2( 0.0,  1.0) * texelSize).rgb);
    float s8 = luminance(texture2D(u_screen, v_uv + vec2( 1.0,  1.0) * texelSize).rgb);

    // Compute statistics
    float sum = s0 + s1 + s2 + s3 + s4 + s5 + s6 + s7 + s8;
    float sumSquares = s0*s0 + s1*s1 + s2*s2 + s3*s3 + s4*s4 + s5*s5 + s6*s6 + s7*s7 + s8*s8;

    float brightCount = 0.0;
    if (s0 > brightnessThreshold) brightCount += 1.0;
    if (s1 > brightnessThreshold) brightCount += 1.0;
    if (s2 > brightnessThreshold) brightCount += 1.0;
    if (s3 > brightnessThreshold) brightCount += 1.0;
    if (s4 > brightnessThreshold) brightCount += 1.0;
    if (s5 > brightnessThreshold) brightCount += 1.0;
    if (s6 > brightnessThreshold) brightCount += 1.0;
    if (s7 > brightnessThreshold) brightCount += 1.0;
    if (s8 > brightnessThreshold) brightCount += 1.0;

    float mean = sum / 9.0;
    float variance = (sumSquares / 9.0) - (mean * mean);

    // Simple edge detection: check gradient magnitude
    float gradX = abs(s5 - s3); // right - left
    float gradY = abs(s7 - s1); // bottom - top
    float gradient = gradX + gradY;

    // Noise detection: sparse scattered particles
    // If there's ANY variance in a dark region with low gradient, it's probably noise

    bool isDarkAndSparse = (mean < 0.2) && (brightCount < 5.0);
    bool hasNoEdges = (gradient < 0.15);

    // Apply blur to dark sparse regions with no strong edges
    bool shouldBlur = isDarkAndSparse && hasNoEdges;

    if (!shouldBlur) {
        // Structured region - pass through unchanged
        gl_FragColor = vec4(centerColor, 1.0);
        return;
    }

    // Sparse region - apply aggressive gaussian blur
    vec3 colorSum = vec3(0.0);
    float weightSum = 0.0;

    // Larger kernel radius for stronger smoothing
    const int radius = 5; // 11x11 kernel

    for (int x = -radius; x <= radius; x++) {
        for (int y = -radius; y <= radius; y++) {
            vec2 offset = vec2(float(x), float(y)) * texelSize;
            vec3 sampleColor = texture2D(u_screen, v_uv + offset).rgb;

            // Only spatial weight (pure gaussian blur in sparse regions)
            float spatialDist = length(vec2(float(x), float(y)));
            float weight = gaussian(spatialDist, u_spatialSigma);

            colorSum += sampleColor * weight;
            weightSum += weight;
        }
    }

    // Normalize
    vec3 result = colorSum / weightSum;

    gl_FragColor = vec4(result, 1.0);
}
`}var ot=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.enabled=r.enabled!==void 0?r.enabled:!1,this.spatialSigma=r.spatialSigma!==void 0?r.spatialSigma:4,this.intensitySigma=r.intensitySigma!==void 0?r.intensitySigma:.2,this.framebuffer=null,this.texture=null,this.program=null,this.quadBuffer=null,this.initialize(),a.info("BilateralFilterManager initialized",{size:`${t}x${i}`,enabled:this.enabled,spatialSigma:this.spatialSigma,intensitySigma:this.intensitySigma})}initialize(){let e=this.gl;if(this.createFramebuffer(),this.compileShader(),!this.quadBuffer){let t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)}}createFramebuffer(){let e=this.gl;this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),this.framebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0);let t=e.checkFramebufferStatus(e.FRAMEBUFFER);t!==e.FRAMEBUFFER_COMPLETE&&a.error("Bilateral filter framebuffer incomplete",{status:t}),e.bindFramebuffer(e.FRAMEBUFFER,null)}compileShader(){let e=this.gl,t=`
attribute vec2 a_pos;
varying vec2 v_uv;

void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=fn();this.program=K(e,t,i),this.program||a.error("Failed to compile bilateral filter shader")}apply(e){if(!this.enabled)return e;let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.viewport(0,0,this.width,this.height),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),t.uniform1i(t.getUniformLocation(this.program,"u_screen"),0),t.uniform2f(t.getUniformLocation(this.program,"u_resolution"),this.width,this.height),t.uniform1f(t.getUniformLocation(this.program,"u_spatialSigma"),this.spatialSigma),t.uniform1f(t.getUniformLocation(this.program,"u_intensitySigma"),this.intensitySigma);let i=t.getAttribLocation(this.program,"a_pos");return t.bindBuffer(t.ARRAY_BUFFER,this.quadBuffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,6),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture}updateConfig(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.spatialSigma!==void 0&&(this.spatialSigma=e.spatialSigma),e.intensitySigma!==void 0&&(this.intensitySigma=e.intensitySigma)}isEnabled(){return this.enabled}resize(e,t){this.width=e,this.height=t,this.cleanup(),this.createFramebuffer()}cleanup(){let e=this.gl;this.framebuffer&&(e.deleteFramebuffer(this.framebuffer),this.framebuffer=null),this.texture&&(e.deleteTexture(this.texture),this.texture=null)}setQuadBuffer(e){this.quadBuffer=e}};M();function gn(){return`
precision highp float;

uniform sampler2D u_screen;
uniform vec2 u_resolution;
uniform float u_threshold;

varying vec2 v_uv;

float luminance(vec3 color) {
    return dot(color, vec3(0.299, 0.587, 0.114));
}

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    // Sample center
    vec3 center = texture2D(u_screen, v_uv).rgb;
    float lumC = luminance(center);

    // Sample neighbors
    float lumL = luminance(texture2D(u_screen, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).rgb);
    float lumR = luminance(texture2D(u_screen, v_uv + vec2(1.0, 0.0) * inverseScreenSize).rgb);
    float lumT = luminance(texture2D(u_screen, v_uv + vec2(0.0, -1.0) * inverseScreenSize).rgb);
    float lumB = luminance(texture2D(u_screen, v_uv + vec2(0.0, 1.0) * inverseScreenSize).rgb);

    // Compute delta (edge strength)
    float deltaL = abs(lumC - lumL);
    float deltaR = abs(lumC - lumR);
    float deltaT = abs(lumC - lumT);
    float deltaB = abs(lumC - lumB);

    // Horizontal and vertical edges
    vec2 edges = vec2(0.0);

    // Horizontal edge (top-bottom difference)
    float maxDeltaH = max(deltaT, deltaB);
    if (maxDeltaH > u_threshold) {
        edges.x = maxDeltaH;
    }

    // Vertical edge (left-right difference)
    float maxDeltaV = max(deltaL, deltaR);
    if (maxDeltaV > u_threshold) {
        edges.y = maxDeltaV;
    }

    gl_FragColor = vec4(edges, 0.0, 1.0);
}
`}function bn(){return`
precision highp float;

uniform sampler2D u_edgesTex;
uniform vec2 u_resolution;

varying vec2 v_uv;

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    vec2 edges = texture2D(u_edgesTex, v_uv).xy;
    vec4 weights = vec4(0.0);

    // If no edges detected, skip
    if (dot(edges, vec2(1.0)) < 0.001) {
        gl_FragColor = weights;
        return;
    }

    // Simplified weight calculation
    // For horizontal edge, blend vertically
    if (edges.x > 0.0) {
        // Check how far edge extends
        float edgeT = texture2D(u_edgesTex, v_uv + vec2(0.0, -1.0) * inverseScreenSize).x;
        float edgeB = texture2D(u_edgesTex, v_uv + vec2(0.0, 1.0) * inverseScreenSize).x;

        // Weight based on edge continuity
        weights.x = edges.x * 0.5; // Top blend
        weights.y = edges.x * 0.5; // Bottom blend

        // Reduce weight if edge continues (sharp feature, not aliasing)
        if (edgeT > 0.0 && edgeB > 0.0) {
            weights.x *= 0.25;
            weights.y *= 0.25;
        }
    }

    // For vertical edge, blend horizontally
    if (edges.y > 0.0) {
        float edgeL = texture2D(u_edgesTex, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).y;
        float edgeR = texture2D(u_edgesTex, v_uv + vec2(1.0, 0.0) * inverseScreenSize).y;

        weights.z = edges.y * 0.5; // Left blend
        weights.w = edges.y * 0.5; // Right blend

        // Reduce weight if edge continues
        if (edgeL > 0.0 && edgeR > 0.0) {
            weights.z *= 0.25;
            weights.w *= 0.25;
        }
    }

    gl_FragColor = weights;
}
`}function xn(){return`
precision highp float;

uniform sampler2D u_colorTex;
uniform sampler2D u_blendTex;
uniform vec2 u_resolution;
uniform float u_intensity;

varying vec2 v_uv;

void main() {
    vec2 inverseScreenSize = 1.0 / u_resolution;

    // Get blend weights
    vec4 weights = texture2D(u_blendTex, v_uv) * u_intensity;

    // If no blending needed, return original color
    if (dot(weights, vec4(1.0)) < 0.001) {
        gl_FragColor = texture2D(u_colorTex, v_uv);
        return;
    }

    // Sample neighbors
    vec3 colorC = texture2D(u_colorTex, v_uv).rgb;
    vec3 colorT = texture2D(u_colorTex, v_uv + vec2(0.0, -1.0) * inverseScreenSize).rgb;
    vec3 colorB = texture2D(u_colorTex, v_uv + vec2(0.0, 1.0) * inverseScreenSize).rgb;
    vec3 colorL = texture2D(u_colorTex, v_uv + vec2(-1.0, 0.0) * inverseScreenSize).rgb;
    vec3 colorR = texture2D(u_colorTex, v_uv + vec2(1.0, 0.0) * inverseScreenSize).rgb;

    // Blend based on weights
    vec3 result = colorC;
    result += colorT * weights.x;
    result += colorB * weights.y;
    result += colorL * weights.z;
    result += colorR * weights.w;

    // Normalize
    float totalWeight = 1.0 + weights.x + weights.y + weights.z + weights.w;
    result /= totalWeight;

    gl_FragColor = vec4(result, 1.0);
}
`}var st=class{constructor(e,t,i,r={}){this.gl=e,this.width=t,this.height=i,this.enabled=r.enabled!==void 0?r.enabled:!0,this.intensity=r.intensity!==void 0?r.intensity:.75,this.threshold=r.threshold!==void 0?r.threshold:.1,this.edgesFramebuffer=null,this.edgesTexture=null,this.blendFramebuffer=null,this.blendTexture=null,this.edgeDetectionProgram=null,this.blendingWeightProgram=null,this.neighborhoodBlendProgram=null,this.quadBuffer=null,this.initialize(),a.info("SMAAManager initialized",{size:`${t}x${i}`,enabled:this.enabled,intensity:this.intensity,threshold:this.threshold})}initialize(){let e=this.gl;if(this.createFramebuffers(),this.compileShaders(),!this.quadBuffer){let t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)}}createFramebuffers(){let e=this.gl;this.edgesTexture=this.createTexture(),this.edgesFramebuffer=this.createFramebuffer(this.edgesTexture),this.blendTexture=this.createTexture(),this.blendFramebuffer=this.createFramebuffer(this.blendTexture)}createTexture(){let e=this.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),t}createFramebuffer(e){let t=this.gl,i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0);let r=t.checkFramebufferStatus(t.FRAMEBUFFER);return r!==t.FRAMEBUFFER_COMPLETE&&a.error("SMAA framebuffer incomplete",{status:r}),t.bindFramebuffer(t.FRAMEBUFFER,null),i}compileShaders(){let e=this.gl,t=`
attribute vec2 a_pos;
varying vec2 v_uv;

void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`;this.edgeDetectionProgram=K(e,t,gn()),this.blendingWeightProgram=K(e,t,bn()),this.neighborhoodBlendProgram=K(e,t,xn()),(!this.edgeDetectionProgram||!this.blendingWeightProgram||!this.neighborhoodBlendProgram)&&a.error("Failed to compile SMAA shaders")}applyToFramebuffer(e,t,i){if(!this.enabled||this.intensity<=0){let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),o.viewport(0,0,this.width,this.height),this.copyToFramebuffer(e,i);return}let r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.edgesFramebuffer),r.viewport(0,0,this.width,this.height),r.useProgram(this.edgeDetectionProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.uniform1i(r.getUniformLocation(this.edgeDetectionProgram,"u_screen"),0),r.uniform2f(r.getUniformLocation(this.edgeDetectionProgram,"u_resolution"),this.width,this.height),r.uniform1f(r.getUniformLocation(this.edgeDetectionProgram,"u_threshold"),this.threshold),this.drawQuad(this.edgeDetectionProgram,i),r.bindFramebuffer(r.FRAMEBUFFER,this.blendFramebuffer),r.viewport(0,0,this.width,this.height),r.useProgram(this.blendingWeightProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.edgesTexture),r.uniform1i(r.getUniformLocation(this.blendingWeightProgram,"u_edgesTex"),0),r.uniform2f(r.getUniformLocation(this.blendingWeightProgram,"u_resolution"),this.width,this.height),this.drawQuad(this.blendingWeightProgram,i),r.bindFramebuffer(r.FRAMEBUFFER,t),r.viewport(0,0,this.width,this.height),r.useProgram(this.neighborhoodBlendProgram),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.uniform1i(r.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.blendTexture),r.uniform1i(r.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),r.uniform2f(r.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),r.uniform1f(r.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),this.intensity),this.drawQuad(this.neighborhoodBlendProgram,i)}applyToCanvas(e,t){this.applyToFramebuffer(e,null,t)}applyToCanvas_OLD(e,t){if(!this.enabled||this.intensity<=0){this.copyToCanvas(e,t);return}let i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.edgesFramebuffer),i.viewport(0,0,this.width,this.height),i.useProgram(this.edgeDetectionProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.edgeDetectionProgram,"u_screen"),0),i.uniform2f(i.getUniformLocation(this.edgeDetectionProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.edgeDetectionProgram,"u_threshold"),this.threshold),this.drawQuad(this.edgeDetectionProgram,t),i.bindFramebuffer(i.FRAMEBUFFER,this.blendFramebuffer),i.viewport(0,0,this.width,this.height),i.useProgram(this.blendingWeightProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.edgesTexture),i.uniform1i(i.getUniformLocation(this.blendingWeightProgram,"u_edgesTex"),0),i.uniform2f(i.getUniformLocation(this.blendingWeightProgram,"u_resolution"),this.width,this.height),this.drawQuad(this.blendingWeightProgram,t),i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.width,this.height),i.useProgram(this.neighborhoodBlendProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.blendTexture),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),i.uniform2f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),this.intensity),this.drawQuad(this.neighborhoodBlendProgram,t)}drawQuad(e,t){let i=this.gl,r=i.getAttribLocation(e,"a_pos");i.bindBuffer(i.ARRAY_BUFFER,t),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,2,i.FLOAT,!1,0,0),i.drawArrays(i.TRIANGLES,0,6)}copyToFramebuffer(e,t){let i=this.gl;i.useProgram(this.neighborhoodBlendProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_colorTex"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.blendTexture),i.uniform1i(i.getUniformLocation(this.neighborhoodBlendProgram,"u_blendTex"),1),i.uniform2f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_resolution"),this.width,this.height),i.uniform1f(i.getUniformLocation(this.neighborhoodBlendProgram,"u_intensity"),0),this.drawQuad(this.neighborhoodBlendProgram,t)}copyToCanvas(e,t){let i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.width,this.height),this.copyToFramebuffer(e,t)}updateConfig(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.intensity!==void 0&&(this.intensity=e.intensity),e.threshold!==void 0&&(this.threshold=e.threshold)}isEnabled(){return this.enabled&&this.intensity>0}resize(e,t){this.width=e,this.height=t,this.cleanup(),this.createFramebuffers()}cleanup(){let e=this.gl;this.edgesFramebuffer&&e.deleteFramebuffer(this.edgesFramebuffer),this.blendFramebuffer&&e.deleteFramebuffer(this.blendFramebuffer),this.edgesTexture&&e.deleteTexture(this.edgesTexture),this.blendTexture&&e.deleteTexture(this.blendTexture),this.edgesFramebuffer=null,this.blendFramebuffer=null,this.edgesTexture=null,this.blendTexture=null}setQuadBuffer(e){this.quadBuffer=e}get framebuffer(){return null}};M();var at=class{constructor(e){this.gl=e,this.reductionProgram=null,this.finalProgram=null,this.quadBuffer=null,this.reductionFBOs=[],this.reductionTextures=[],this.stats={red:{min:0,max:0,avg:0},green:{min:0,max:0,avg:0},blue:{min:0,max:0,avg:0},maxBrightness:0,avgBrightness:0,histogram:[],timestamp:0},this.initialized=!1}initialize(){let e=this.gl;this.quadBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW);let t=`
attribute vec2 a_pos;
varying vec2 v_texcoord;
void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=`
precision highp float;
uniform sampler2D u_texture;
uniform vec2 u_texel_size;
varying vec2 v_texcoord;

void main() {
    // Sample 2x2 block
    vec2 base = v_texcoord;
    vec3 s0 = texture2D(u_texture, base).rgb;
    vec3 s1 = texture2D(u_texture, base + vec2(u_texel_size.x, 0.0)).rgb;
    vec3 s2 = texture2D(u_texture, base + vec2(0.0, u_texel_size.y)).rgb;
    vec3 s3 = texture2D(u_texture, base + u_texel_size).rgb;

    // Compute min/max across the 2x2 block
    vec3 minVal = min(min(s0, s1), min(s2, s3));
    vec3 maxVal = max(max(s0, s1), max(s2, s3));

    // Store: R=min, G=max, B=sum (for averaging)
    // We'll pack min in R channel, max in G channel, sum in B channel
    // Actually, we need all three channels for each stat, so let's use a different approach
    // Let's just compute the max for now (most useful for saturation buildup)

    gl_FragColor = vec4(maxVal, 1.0);
}
`;return this.reductionProgram=this.createProgram(t,i),this.reductionProgram?(this.initialized=!0,!0):(a.error("Failed to create reduction shader"),!1)}createProgram(e,t){let i=this.gl,r=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))return a.error("Vertex shader compile error:",i.getShaderInfoLog(r)),null;let o=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(o,t),i.compileShader(o),!i.getShaderParameter(o,i.COMPILE_STATUS))return a.error("Fragment shader compile error:",i.getShaderInfoLog(o)),null;let s=i.createProgram();return i.attachShader(s,r),i.attachShader(s,o),i.linkProgram(s),i.getProgramParameter(s,i.LINK_STATUS)?s:(a.error("Program link error:",i.getProgramInfoLog(s)),null)}compute(e,t,i,r=!0){if(!this.initialized&&!this.initialize())return this.stats;let o=this.gl,s=r?16:2;return this.computeCPUSampled(e,t,i,s)}computeCPUSampled(e,t,i,r){let o=this.gl,s=o.createFramebuffer();if(o.bindFramebuffer(o.FRAMEBUFFER,s),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,e,0),o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE)return a.error("Framebuffer not complete for stats readback"),o.deleteFramebuffer(s),this.stats;let l=4,c=16,u=l*l*c*c,d=new Float32Array(u*4),h=0;for(let v=0;v<l;v++)for(let C=0;C<l;C++){let w=Math.floor(t/l*C+(t/l-c)/2),T=Math.floor(i/l*v+(i/l-c)/2),R=new Float32Array(c*c*4);o.readPixels(w,T,c,c,o.RGBA,o.FLOAT,R),d.set(R,h*4),h+=c*c}o.deleteFramebuffer(s),o.bindFramebuffer(o.FRAMEBUFFER,null);let p=1/0,m=-1/0,f=0,b=1/0,x=-1/0,g=0,y=1/0,_=-1/0,S=0,F=u;for(let v=0;v<F;v++){let C=v*4,w=d[C],T=d[C+1],R=d[C+2];p=Math.min(p,w),m=Math.max(m,w),f+=w,b=Math.min(b,T),x=Math.max(x,T),g+=T,y=Math.min(y,R),_=Math.max(_,R),S+=R}let E=F>0?f/F:0,L=F>0?g/F:0,k=F>0?S/F:0,A=20,B=new Array(A).fill(0),z=Math.max(m,x,_);if(z>0){let v=Math.log2(z+1);for(let C=0;C<F;C++){let w=C*4,T=Math.max(d[w],d[w+1],d[w+2]),R=Math.log2(T+1),P=Math.min(Math.floor(R/v*A),A-1);B[P]++}}return this.stats={red:{min:p,max:m,avg:E},green:{min:b,max:x,avg:L},blue:{min:y,max:_,avg:k},maxBrightness:Math.max(m,x,_),avgBrightness:(E+L+k)/3,histogram:B,timestamp:Date.now(),sampledPixels:F,sampleRate:r},this.stats}getCached(){return this.stats}dispose(){let e=this.gl;this.quadBuffer&&e.deleteBuffer(this.quadBuffer),this.reductionProgram&&e.deleteProgram(this.reductionProgram),this.finalProgram&&e.deleteProgram(this.finalProgram),this.reductionFBOs.forEach(t=>e.deleteFramebuffer(t)),this.reductionTextures.forEach(t=>e.deleteTexture(t)),this.reductionFBOs=[],this.reductionTextures=[]}};M();var lt=class{constructor(e){this.gl=e,this.program=null,this.quadBuffer=null,this.resultTexture=null,this.resultFBO=null,this.stats={maxVelocity:5,avgVelocity:2,sampleCount:0,timestamp:0},this.initialized=!1,this.shaderSource=null}initialize(e,t,i=null){let r=this.gl;if(this.quadBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.quadBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r.STATIC_DRAW),this.resultTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.resultTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,64,1,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.resultFBO=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this.resultFBO),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.resultTexture,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)return a.error("Velocity stats framebuffer not complete"),this.dispose(),!1;r.bindFramebuffer(r.FRAMEBUFFER,null);let o=`vec${e}`,s=["x","y","z","w"],l=t.map((f,b)=>`    result.${s[b]} = ${f};`).join(`
`),c=i&&i.forwardTransform,u=c?`
// User-defined velocity field in native coordinates
${o} get_velocity_native(${o} pos_native) {
    ${o} result;
${l}
    return result;
}

// Velocity field for statistics (native-space integration)
${o} get_velocity(${o} pos_cartesian) {
    ${o} pos_native = transformToNative(pos_cartesian);
    return get_velocity_native(pos_native);
}
`:`
// User-defined velocity field
${o} get_velocity(${o} pos) {
    ${o} result;
    float x = pos.x;
    ${e>1?"float y = pos.y;":""}
    ${e>2?"float z = pos.z;":""}
    ${e>3?"float w = pos.w;":""}

${l}

    return result;
}
`,d=`
attribute vec2 a_pos;
varying vec2 v_texcoord;
void main() {
    v_texcoord = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,h=`
precision highp float;

${Array.from({length:e},(f,b)=>`uniform sampler2D u_pos_${b};`).join(`
`)}
uniform vec2 u_bbox_min;
uniform vec2 u_bbox_max;
uniform float u_resolution;
uniform float u_sample_count;
uniform float u_alpha;

varying vec2 v_texcoord;

${c?i.forwardTransform:""}

${u}

void main() {
    // Each output pixel computes velocity for one sampled particle
    float particleIndex = floor(v_texcoord.x * u_sample_count);

    // Random sampling across all particles
    float totalParticles = u_resolution * u_resolution;
    float stride = totalParticles / u_sample_count;
    float sampleIdx = particleIndex * stride;

    // Convert to texture coordinates
    float x = mod(sampleIdx, u_resolution);
    float y = floor(sampleIdx / u_resolution);
    vec2 texCoord = (vec2(x, y) + 0.5) / u_resolution;

    // Read position from textures
    vec${e} position;
    ${Array.from({length:e},(f,b)=>`position[${b}] = texture2D(u_pos_${b}, texCoord).r;`).join(`
    `)}

    // Compute velocity
    vec${e} velocity = get_velocity(position);

    // Compute magnitude
    float speed = length(velocity);

    // Output: R = velocity magnitude, G = 1.0 (for counting), B/A unused
    gl_FragColor = vec4(speed, 1.0, 0.0, 1.0);
}
`,p=r.createShader(r.VERTEX_SHADER);if(r.shaderSource(p,d),r.compileShader(p),!r.getShaderParameter(p,r.COMPILE_STATUS))return a.error("Velocity stats vertex shader error:",r.getShaderInfoLog(p)),!1;let m=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(m,h),r.compileShader(m),r.getShaderParameter(m,r.COMPILE_STATUS)?(this.program=r.createProgram(),r.attachShader(this.program,p),r.attachShader(this.program,m),r.linkProgram(this.program),r.getProgramParameter(this.program,r.LINK_STATUS)?(this.initialized=!0,this.dimensions=e,this.shaderSource=h,a.verbose("VelocityStatsManager initialized"),!0):(a.error("Velocity stats program link error:",r.getProgramInfoLog(this.program)),!1)):(a.error("Velocity stats fragment shader error:",r.getShaderInfoLog(m)),a.error(`Generated shader code:
`+h),!1)}compute(e,t,i,r=0){if(!this.initialized)return this.stats;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,this.resultFBO),o.viewport(0,0,64,1),o.useProgram(this.program);for(let b=0;b<this.dimensions;b++)o.activeTexture(o.TEXTURE0+b),o.bindTexture(o.TEXTURE_2D,e[b]),o.uniform1i(o.getUniformLocation(this.program,`u_pos_${b}`),b);o.uniform2f(o.getUniformLocation(this.program,"u_bbox_min"),t.min[0],t.min[1]),o.uniform2f(o.getUniformLocation(this.program,"u_bbox_max"),t.max[0],t.max[1]),o.uniform1f(o.getUniformLocation(this.program,"u_resolution"),i),o.uniform1f(o.getUniformLocation(this.program,"u_sample_count"),64),o.uniform1f(o.getUniformLocation(this.program,"u_alpha"),r),o.bindBuffer(o.ARRAY_BUFFER,this.quadBuffer);let s=o.getAttribLocation(this.program,"a_pos");o.enableVertexAttribArray(s),o.vertexAttribPointer(s,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6);let l=new Float32Array(256);o.readPixels(0,0,64,1,o.RGBA,o.FLOAT,l),o.bindFramebuffer(o.FRAMEBUFFER,null);let c=[],u=0,d=0;for(let b=0;b<64;b++){let x=l[b*4];isFinite(x)&&x>0&&(c.push(x),u=Math.max(u,x),d+=x)}let h=c.length,p=h>0?d/h:0,m=p,f=p;if(h>0){c.sort((g,y)=>g-y);let b=Math.floor(h*.9),x=Math.floor(h*.95);m=c[Math.min(b,h-1)],f=c[Math.min(x,h-1)]}return this.stats={maxVelocity:u>0?u:this.stats.maxVelocity,avgVelocity:p>0?p:this.stats.avgVelocity,percentile90:m>0?m:this.stats.percentile90||p,percentile95:f>0?f:this.stats.percentile95||p,sampleCount:h,timestamp:Date.now()},this.stats}getCached(){return this.stats}dispose(){let e=this.gl;this.quadBuffer&&e.deleteBuffer(this.quadBuffer),this.program&&e.deleteProgram(this.program),this.resultTexture&&e.deleteTexture(this.resultTexture),this.resultFBO&&e.deleteFramebuffer(this.resultFBO),this.initialized=!1}needsRecompile(){return!0}getShaderSource(){return this.shaderSource}};M();var ct=class{constructor(e,t,i,r){this.particleCount=e,this.dimensions=t,this.bbox=i||this.getDefaultBBox(t),this.strategy=r,this.resolution=Math.ceil(Math.sqrt(e)),this.actualParticleCount=this.resolution*this.resolution,this.initializeParticles()}getDefaultBBox(e){return{min:new Array(e).fill(-5),max:new Array(e).fill(5)}}initializeParticles(){this.data=[];let e=[],t=this.strategy.getArrayType(),i=this.strategy.getComponentsPerValue();for(let r=0;r<this.dimensions;r++){let o=new t(this.actualParticleCount*i);for(let s=0;s<this.actualParticleCount;s++){let c;if(r<2&&this.bbox.min&&this.bbox.max){let m=r===0?this.bbox.min[0]:this.bbox.min[1],b=(r===0?this.bbox.max[0]:this.bbox.max[1])-m;c=m+b*-.02+Math.random()*b*(1-2*-.02)}else c=-10.4+Math.random()*20.8;let u=r<2?r===0?this.bbox.min[0]:this.bbox.min[1]:-10,d=r<2?r===0?this.bbox.max[0]:this.bbox.max[1]:10,h=this.strategy.encodeValue(c,u,d),p=s*i;for(let m=0;m<i;m++)o[p+m]=h[m];if(s<10&&r<2){let m=new t(i);for(let x=0;x<i;x++)m[x]=o[p+x];let f=this.strategy.decodeValue(m,u,d);e[s]||(e[s]={});let b;i===4?b=`[${h[0].toFixed?.(0)||h[0]}, ${h[1].toFixed?.(0)||h[1]}, ${h[2].toFixed?.(0)||h[2]}, ${h[3].toFixed?.(0)||h[3]}]`:b=h[0].toString(),e[s][r===0?"x":"y"]={worldValue:c.toFixed(4),encoded:b,decodedWorld:f.toFixed(4),error:Math.abs(c-f).toFixed(6)}}}this.data.push(o)}e.length>0&&a.info("Particle initialization - first 10 particles:",{strategy:this.strategy.getName(),bbox:`[${this.bbox.min[0]}, ${this.bbox.min[1]}] to [${this.bbox.max[0]}, ${this.bbox.max[1]}]`,samples:e.filter(r=>r)}),this.indices=new Float32Array(this.actualParticleCount);for(let r=0;r<this.actualParticleCount;r++)this.indices[r]=r}getDimensionData(e){return this.data[e]}getAllData(){return this.data}getIndices(){return this.indices}setParticleCount(e){this.particleCount=e,this.resolution=Math.ceil(Math.sqrt(e)),this.actualParticleCount=this.resolution*this.resolution,this.initializeParticles()}setDimensions(e){this.dimensions=e,this.bbox=this.getDefaultBBox(e),this.initializeParticles()}setBBox(e){this.bbox=e}getResolution(){return this.resolution}getActualParticleCount(){return this.actualParticleCount}};se();ut();se();M();var vn=["x","y","z","w","u","v"];function Ge(n){let e=n===2?"mat2":n===3?"mat3":"mat4",t=`inverse${n}`;if(n===2)return`
// Compute inverse of 2x2 matrix (closed form)
// For matrix [a c; b d] (column-major), inverse is [d -c; -b a] / det
mat2 inverse2(mat2 m) {
    float det = m[0][0]*m[1][1] - m[1][0]*m[0][1];
    return mat2(m[1][1], -m[1][0], -m[0][1], m[0][0]) / det;
}`;let i=`
// Compute inverse of ${n}x${n} matrix using Gauss-Jordan elimination
${e} ${t}(${e} m) {
    // Create augmented matrix [m | I] stored as ${n} column vectors
`;for(let r=0;r<n;r++){i+=`    vec${n} aug${r} = vec${n}(`;for(let o=0;o<n;o++)o>0&&(i+=", "),i+=`m[${r}][${o}]`;i+=`);
`}for(let r=0;r<n;r++){i+=`    vec${n} aug${n+r} = vec${n}(`;for(let o=0;o<n;o++)o>0&&(i+=", "),i+=o===r?"1.0":"0.0";i+=`);
`}i+=`
`;for(let r=0;r<n;r++){i+=`    // Pivot ${r}: Make diagonal element = 1 and eliminate column ${r}
`,i+=`    float scale${r} = aug${r}[${r}];
`,i+=`    if (abs(scale${r}) < 0.0001) scale${r} = 0.0001;
`;for(let o=0;o<2*n;o++)i+=`    aug${o}[${r}] /= scale${r};
`;i+=`
`;for(let o=0;o<n;o++)if(o!==r){i+=`    // Eliminate row ${o}
`,i+=`    float factor${r}_${o} = aug${r}[${o}];
`;for(let s=0;s<2*n;s++)i+=`    aug${s}[${o}] -= factor${r}_${o} * aug${s}[${r}];
`;i+=`
`}}i+=`    // Extract inverse from augmented matrix
`,i+=`    return ${e}(
`;for(let r=0;r<n;r++)r>0&&(i+=`,
`),i+=`        aug${n+r}`;return i+=`
    );
`,i+=`}
`,i}function dt(n,e){let t=e===2?"mat2":e===3?"mat3":"mat4",i=`vec${e}`,r="";for(let l=0;l<e;l++)r+=`    float ${vn[l]} = pos.${["x","y","z","w"][l]};
`;let o=[];for(let l=0;l<e;l++)for(let c=0;c<e;c++){let u=n[c][l];try{let d=W(u,e);o.push(d)}catch(d){a.warn(`Failed to compile Jacobian element [${c}][${l}]: ${u}`,d),o.push("0.0")}}return`
${Ge(e)}

// Compute Jacobian matrix at given position
${t} computeJacobian(${i} pos) {
${r}
    return ${t}(
        ${o.join(`,
        `)}
    );
}`}function te(n,e,t){let i=e(n);return`        ${n} = ${i};`}function Ne(n,e,t){let i=`vec${t}`,r=`${n}_pred`,o=`${n}_mid`,s=e(n),l=e(o);return`        // Predictor: standard fixed-point step
        ${i} ${r} = ${s};

        // Corrector: evaluate at midpoint between current and predictor
        ${i} ${o} = (${n} + ${r}) * 0.5;
        ${n} = ${l};`}function Ue(n,e,t,i){let r=`vec${i}`,o=i===2?"mat2":i===3?"mat3":"mat4",s=`inverse${i}`,l=e(n),c=t(n);return`        ${r} F_${n} = ${l};
        ${o} J_${n} = ${c};

        // Newton step: x -= J^(-1) * F
        ${r} delta_${n} = ${s}(J_${n}) * F_${n};
        ${n} -= delta_${n};`}function Oe(n,e,t,i="h",r=null){let o=`vec${t}`,s=t===2?"mat2":t===3?"mat3":"mat4",l=`inverse${t}`,c=["x","y","z","w"],u="1e-4",d="",h=[];for(let f=0;f<t;f++){let b=`Df_col${f}_${n}`,x=Array.from({length:t},(_,S)=>S===f?u:"0.0").join(", "),g=e(`${n} + ${o}(${x})`),y=e(n);d+=`
        // Velocity Jacobian column ${f}: d(velocity)/d${c[f]}
        ${o} ${b} = (${g} - ${y}) / ${u};`,h.push(b)}d+=`

        // Velocity Jacobian matrix Df
        ${s} Df_${n} = ${s}(${h.join(", ")});

        // Residual Jacobian: J_F = I - ${i} * Df
        ${s} J_${n} = ${s}(1.0) - ${i} * Df_${n};`;let p=e(n),m=r||`pos + ${i} * ${p}`;return`        // Finite difference Jacobian approximation (epsilon = ${u})${d}

        // Compute residual: F(x) = x - RHS
        ${o} F_${n} = ${n} - (${m});

        // Newton step: x -= J^(-1) * F
        ${o} delta_${n} = ${l}(J_${n}) * F_${n};
        ${n} -= delta_${n};`}function wn(n){return{name:"Euler",costFactor:1,code:`
// Euler integration
vec${n} integrate(vec${n} pos, float h) {
    vec${n} velocity = get_velocity(pos);
    return pos + h * velocity;
}
`}}function Xi(n){return{name:"Explicit Midpoint",costFactor:2,code:`
// Explicit Midpoint (RK2) integration
vec${n} integrate(vec${n} pos, float h) {
    vec${n} k1 = get_velocity(pos);
    vec${n} k2 = get_velocity(pos + h * 0.5 * k1);
    return pos + h * k2;
}
`}}function _n(n){return{name:"Heun (Explicit Trapezoidal)",costFactor:2,code:`
// Heun's Method (Explicit Trapezoidal) integration
vec${n} integrate(vec${n} pos, float h) {
    vec${n} k1 = get_velocity(pos);
    vec${n} k2 = get_velocity(pos + h * k1);
    return pos + h * 0.5 * (k1 + k2);
}
`}}function qi(n){return{name:"RK4",costFactor:4,code:`
// Runge-Kutta 4 integration
vec${n} integrate(vec${n} pos, float h) {
    vec${n} k1 = get_velocity(pos);
    vec${n} k2 = get_velocity(pos + h * 0.5 * k1);
    vec${n} k3 = get_velocity(pos + h * 0.5 * k2);
    vec${n} k4 = get_velocity(pos + h * k3);

    return pos + h * (k1 / 6.0 + k2 / 3.0 + k3 / 3.0 + k4 / 6.0);
}
`}}function Wi(n,e=3,t="fixed-point",i=null){a.info(`*** Implicit Euler integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${n}`,o=n===2?"mat2":n===3?"mat3":"mat4",s="pos + h * get_velocity(pos)",l=p=>`pos + h * get_velocity(${p})`,c=p=>`get_velocity(${p})`,u,d,h="";if(t==="newton"&&i){a.info("Computing Jacobian for Newton's method");let p=ne(i,n);ze(p)?(a.info("\u2713 Successfully using Newton's method for Implicit Euler"),h=dt(p,n),u=Ue("x_new",b=>`${b} - pos - h * get_velocity(${b})`,b=>`${o}(1.0) - h * computeJacobian(${b})`,n),d="Newton"):(a.warn("\u2717 Failed to compute Jacobian for Newton's method"),a.warn("Falling back to fixed-point iteration"),u=te("x_new",l,n),d="Fixed-Point")}else t==="newton-fd"?(a.info("\u2713 Using finite difference Newton's method for Implicit Euler"),h=Ge(n),u=Oe("x_new",c,n),d="Newton (FD)"):t==="midpoint"?(u=Ne("x_new",l,n),d="Midpoint"):(u=te("x_new",l,n),d="Fixed-Point");return{name:`Implicit Euler (${d})`,costFactor:1,code:`
${h}
// Implicit Euler integration (${d.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    // Start with initial guess
    ${r} x_new = ${s};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${u}
    }

    return x_new;
}
`}}function En(n,e=4,t="fixed-point",i=null){a.info(`*** Implicit Midpoint integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${n}`,o=n===2?"mat2":n===3?"mat3":"mat4",l="pos + h * get_velocity(pos + h * 0.5 * get_velocity(pos))",c=m=>`pos + h * get_velocity((pos + ${m}) * 0.5)`,u=m=>`get_velocity((pos + ${m}) * 0.5)`,d,h,p="";if(t==="newton"&&i){a.info("Computing Jacobian for Newton's method (Implicit Midpoint)");let m=ne(i,n);ze(m)?(a.info("\u2713 Successfully using Newton's method for Implicit Midpoint"),p=dt(m,n),d=Ue("x_new",x=>`${x} - pos - h * get_velocity((pos + ${x}) * 0.5)`,x=>`${o}(1.0) - (h * 0.5) * computeJacobian((pos + ${x}) * 0.5)`,n),h="Newton"):(a.warn("\u2717 Failed to compute Jacobian for Newton's method (Implicit Midpoint)"),a.warn("Falling back to fixed-point iteration"),d=te("x_new",c,n),h="Fixed-Point")}else t==="newton-fd"?(a.info("\u2713 Using finite difference Newton's method for Implicit Midpoint"),p=Ge(n),d=Oe("x_new",u,n,"h * 0.5"),h="Newton (FD)"):t==="midpoint"?(d=Ne("x_new",c,n),h="Midpoint"):(d=te("x_new",c,n),h="Fixed-Point");return{name:`Implicit Midpoint (${h})`,costFactor:2,code:`
${p}
// Implicit Midpoint integration (${h.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    // Start with initial guess
    ${r} x_new = ${l};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${d}
    }

    return x_new;
}
`}}function $n(n,e=4,t="fixed-point",i=null){a.info(`*** Trapezoidal integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${n}`,o=n===2?"mat2":n===3?"mat3":"mat4",s="pos + h * f0",l=p=>`pos + h * 0.5 * (f0 + get_velocity(${p}))`,c=p=>`get_velocity(${p})`,u,d,h="";if(t==="newton"&&i){a.info("Computing Jacobian for Newton's method (Trapezoidal)");let p=ne(i,n);ze(p)?(a.info("\u2713 Successfully using Newton's method for Trapezoidal"),h=dt(p,n),u=Ue("x_new",b=>`${b} - pos - h * 0.5 * (f0 + get_velocity(${b}))`,b=>`${o}(1.0) - (h * 0.5) * computeJacobian(${b})`,n),d="Newton"):(a.warn("\u2717 Failed to compute Jacobian for Newton's method (Trapezoidal)"),a.warn("Falling back to fixed-point iteration"),u=te("x_new",l,n),d="Fixed-Point")}else t==="newton-fd"?(a.info("\u2713 Using finite difference Newton's method for Trapezoidal"),h=Ge(n),u=Oe("x_new",c,n,"h * 0.5","pos + h * 0.5 * (f0 + "+c("x_new")+")"),d="Newton (FD)"):t==="midpoint"?(u=Ne("x_new",l,n),d="Midpoint"):(u=te("x_new",l,n),d="Fixed-Point");return{name:`Trapezoidal (${d})`,costFactor:2,code:`
${h}
// Trapezoidal Rule integration (${d.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
    ${r} f0 = get_velocity(pos);

    // Start with initial guess
    ${r} x_new = ${s};

    // Iterative solver
    for (int i = 0; i < ${e}; i++) {
${u}
    }

    return x_new;
}
`}}function Sn(n,e=5,t="fixed-point",i=null){a.info(`*** Implicit RK4 integrator requested: solutionMethod=${t}, hasExpressions=${!!i}`);let r=`vec${n}`,o=n===2?"mat2":n===3?"mat3":"mat4",s=`
    // Gauss-Legendre coefficients for 2-stage method
    const float a11 = 0.25;
    const float a12 = 0.25 - sqrt(3.0) / 6.0;
    const float a21 = 0.25 + sqrt(3.0) / 6.0;
    const float a22 = 0.25;
    const float b1 = 0.5;
    const float b2 = 0.5;
    const float c1 = 0.5 - sqrt(3.0) / 6.0;
    const float c2 = 0.5 + sqrt(3.0) / 6.0;`,l=`
    // Start with explicit RK4 as initial guess
    ${r} k1_guess = get_velocity(pos);
    ${r} k2_guess = get_velocity(pos + h * 0.5 * k1_guess);

    ${r} k1 = k1_guess;
    ${r} k2 = k2_guess;`,c=g=>`get_velocity(pos + h * (a11 * ${g} + a12 * k2))`,u=g=>`get_velocity(pos + h * (a21 * k1 + a22 * ${g}))`,d=g=>`get_velocity(pos + h * (a11 * ${g} + a12 * k2))`,h=g=>`get_velocity(pos + h * (a21 * k1 + a22 * ${g}))`,p,m,f,b="";if(t==="newton"&&i){a.info("Computing Jacobian for Newton's method (Implicit RK4 - simplified)");let g=ne(i,n);if(ze(g)){a.info("\u2713 Successfully using simplified Newton's method for Implicit RK4"),b=dt(g,n);let y=E=>`${E} - get_velocity(pos + h * (a11 * ${E} + a12 * k2))`,_=E=>`${o}(1.0) - (h * a11) * computeJacobian(pos + h * (a11 * ${E} + a12 * k2))`,S=E=>`${E} - get_velocity(pos + h * (a21 * k1 + a22 * ${E}))`,F=E=>`${o}(1.0) - (h * a22) * computeJacobian(pos + h * (a21 * k1 + a22 * ${E}))`;p=Ue("k1",y,_,n),m=Ue("k2",S,F,n),f="Newton"}else a.warn("\u2717 Failed to compute Jacobian for Newton's method (Implicit RK4)"),a.warn("Falling back to fixed-point iteration"),p=te("k1",c,n),m=te("k2",u,n),f="Fixed-Point"}else t==="newton-fd"?(a.info("\u2713 Using finite difference Newton's method for Implicit RK4 (simplified)"),b=Ge(n),p=Oe("k1",d,n,"h * a11"),m=Oe("k2",h,n,"h * a22"),f="Newton (FD)"):t==="midpoint"?(p=Ne("k1",c,n),m=Ne("k2",u,n),f="Midpoint"):(p=te("k1",c,n),m=te("k2",u,n),f="Fixed-Point");let x=`
    // Iterative solver for coupled stages (Gauss-Seidel style)
    for (int i = 0; i < ${e}; i++) {
        // Stage 1
${p}

        // Stage 2
${m}
    }`;return{name:`Implicit RK4 (${f})`,costFactor:4,code:`
${b}
// Implicit RK4 (Gauss-Legendre 2-stage) integration (${f.toLowerCase()} solver)
${r} integrate(${r} pos, float h) {
${s}
${l}
${x}

    return pos + h * (b1 * k1 + b2 * k2);
}
`}}function Ji(n,e,t={}){let i=t.iterations||3,r=t.solutionMethod||"fixed-point",o=t.expressions||null;switch(n){case"euler":return wn(e);case"explicit-midpoint":return Xi(e);case"heun":return _n(e);case"rk4":return qi(e);case"implicit-euler":return Wi(e,i,r,o);case"implicit-midpoint":return En(e,t.iterations||4,r,o);case"trapezoidal":return $n(e,t.iterations||4,r,o);case"implicit-rk4":return Sn(e,t.iterations||5,r,o);case"rk2":return Xi(e);case"implicit":return Wi(e,i,r,o);default:return qi(e)}}se();function ht(n,e,t,i=null){i===null&&(i=t>=3?2:-1);let r=i>=0&&i<t;return{name:"Select",params:{dim1:n,dim2:e,depthDim:i},code:`
// Select 2 dimensions for display${r?" (with depth)":""}
vec2 project_to_2d(vec${t} pos) {
    return vec2(pos[${n}], pos[${e}]);
}

vec3 project_to_3d(vec${t} pos) {
    return vec3(pos[${n}], pos[${e}], ${r?`pos[${i}]`:"0.0"});
}
`}}function Tn(n,e){let t=n[0].map((o,s)=>`${o.toFixed(6)} * pos[${s}]`).join(" + "),i=n[1].map((o,s)=>`${o.toFixed(6)} * pos[${s}]`).join(" + "),r=n[2]?n[2].map((o,s)=>`${o.toFixed(6)} * pos[${s}]`).join(" + "):null;return{name:"Linear Projection",params:{matrix:n},code:`
// Linear projection matrix
vec2 project_to_2d(vec${e} pos) {
    return vec2(
        ${t},
        ${i}
    );
}

vec3 project_to_3d(vec${e} pos) {
    return vec3(
        ${t},
        ${i},
        ${r||"0.0"}
    );
}
`}}function Cn(n,e){let t=n===0?1:0,i=t+1;return i===n&&i++,{name:"Orthographic",params:{axis:n},code:`
// Orthographic projection (remove axis ${n}, use as depth)
vec2 project_to_2d(vec${e} pos) {
    return vec2(pos[${t}], pos[${i}]);
}

vec3 project_to_3d(vec${e} pos) {
    return vec3(pos[${t}], pos[${i}], pos[${n}]);
}
`}}function An(){return{name:"Spherical",params:{},code:`
// Spherical projection (3D only)
vec2 project_to_2d(vec3 pos) {
    float r = length(pos);
    if (r < 0.001) return vec2(0.0, 0.0);

    float theta = atan(pos.y, pos.x);
    float phi = acos(pos.z / r);

    return vec2(theta, phi);
}

vec3 project_to_3d(vec3 pos) {
    float r = length(pos);
    if (r < 0.001) return vec3(0.0, 0.0, 0.0);

    float theta = atan(pos.y, pos.x);
    float phi = acos(pos.z / r);

    return vec3(theta, phi, r);  // Use radius as depth
}
`}}function Fn(n){return{name:"Stereographic",params:{},code:`
// Stereographic projection
vec2 project_to_2d(vec${n} pos) {
    float denom = 1.0 - pos[${n-1}];
    if (abs(denom) < 0.001) denom = 0.001;
    return vec2(pos[0] / denom, pos[1] / denom);
}

vec3 project_to_3d(vec${n} pos) {
    float denom = 1.0 - pos[${n-1}];
    if (abs(denom) < 0.001) denom = 0.001;
    return vec3(pos[0] / denom, pos[1] / denom, pos[${n-1}]);
}
`}}function Yi(n,e,t={}){switch(n){case"select":{let i=t.dim1!==void 0?t.dim1:0,r=t.dim2!==void 0?t.dim2:Math.min(1,e-1),o=t.depthDim!==void 0?t.depthDim:null;return ht(i,r,e,o)}case"project":{let i=t.matrix||[[1,0,...Array(Math.max(0,e-2)).fill(0)],[0,1,...Array(Math.max(0,e-2)).fill(0)]];return Tn(i,e)}case"orthographic":{let i=t.axis!==void 0?t.axis:e-1;return Cn(i,e)}case"spherical":return e===3?An():ht(0,1,e);case"stereographic":return e>=3?Fn(e):ht(0,1,e);case"custom":{let i=t.horizontalExpr||"x",r=t.verticalExpr||"y",o=t.depthExpr||"";return Rn(i,r,o,e)}default:return ht(0,1,e)}}function Rn(n,e,t,i){let r=W(n||"x",i),o=W(e||"y",i),s=t?W(t,i):"0.0";return{name:"Custom",params:{horizontalExpr:n,verticalExpr:e,depthExpr:t},code:`
// Custom mapper
vec2 project_to_2d(vec${i} pos) {
    return vec2(
        ${r},
        ${o}
    );
}

vec3 project_to_3d(vec${i} pos) {
    return vec3(
        ${r},
        ${o},
        ${s}
    );
}
`}}var J=class{constructor(e,t){this.name=e,this.description=t}generateHelpers(e){return""}generateForward(e){throw new Error("generateForward must be implemented")}generateInverse(e){throw new Error("generateInverse must be implemented")}generateJacobian(e){throw new Error("generateJacobian must be implemented")}getParameters(){return[]}},ye=class extends J{constructor(){super("identity","No transformation (identity)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    return x;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    return y;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    return ${t}(1.0);
}`}},Jt=class extends J{constructor(){super("power","Power transform (zoom lens effect)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`    result.${o} = sign(x.${o}) * pow(abs(x.${o}) + 1e-8, alpha);`}).join(`
`)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    float inv_alpha = 1.0 / alpha;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`    result.${o} = sign(y.${o}) * pow(abs(y.${o}) + 1e-8, inv_alpha);`}).join(`
`)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`    result.${o} = alpha * pow(abs(x.${o}) + 1e-8, alpha - 1.0);`}).join(`
`)}
    return result;
}`}getParameters(){return[{name:"alpha",label:"Exponent (\u03B1)",type:"slider",min:1e-4,max:25,step:1e-4,default:.5,info:"\u03B1 < 1.0: zoom into origin; \u03B1 > 1.0: compress origin"}]}},Yt=class extends J{constructor(){super("tanh","Hyperbolic tangent (compress infinity)")}generateHelpers(e){return`
// Helper: tanh(x) = (exp(2x) - 1) / (exp(2x) + 1)
float tanh_scalar(float x) {
    float e2x = exp(2.0 * x);
    return (e2x - 1.0) / (e2x + 1.0);
}
`}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float beta = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = tanh_scalar(beta * x.${o});`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float beta = u_transform_params.x;
    // atanh(y) = 0.5 * log((1+y)/(1-y))
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${o}, -0.99999, 0.99999);
        result.${o} = 0.5 * log((1.0 + y_clamped) / (1.0 - y_clamped)) / beta;
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float beta = u_transform_params.x;
    // Jacobian of tanh: d/dx tanh(x) = 1 - tanh^2(x)
    ${t} tanh_vals;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`tanh_vals.${o} = tanh_scalar(beta * x.${o});`}).join(`
    `)}
    return beta * (${t}(1.0) - tanh_vals * tanh_vals);
}`}getParameters(){return[{name:"beta",label:"Compression (\u03B2)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Higher = more compression. Maps infinite space to [-1,1]"}]}},Kt=class extends J{constructor(){super("sigmoid","Logistic Sigmoid (smooth S-curve)")}generateHelpers(e){return`
// Helper: sigmoid(x) = 1 / (1 + exp(-x))
float sigmoid_scalar(float x) {
    return 1.0 / (1.0 + exp(-x));
}
`}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float k = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = 2.0 * sigmoid_scalar(k * x.${o}) - 1.0;`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float k = u_transform_params.x;
    // Inverse: x = ln((y+1)/(1-y)) / k
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${o}, -0.99999, 0.99999);
        result.${o} = log((y_clamped + 1.0) / (1.0 - y_clamped)) / k;
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float k = u_transform_params.x;
    // Jacobian: d/dx [2*sigmoid(k*x) - 1] = 2k * sigmoid(k*x) * (1 - sigmoid(k*x))
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float sig = sigmoid_scalar(k * x.${o});
        result.${o} = 2.0 * k * sig * (1.0 - sig);
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"k",label:"Steepness (k)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Higher = steeper transition. Maps infinite space to [-1,1] with logistic curve."}]}},Zt=class extends J{constructor(){super("rational","Rational (bell-shaped Jacobian)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float a = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = x.${o} / sqrt(x.${o} * x.${o} + a);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float a = u_transform_params.x;
    // Inverse: x = y * sqrt(a / (1 - y^2))
    // Note: y is bounded to [-1, 1] regardless of a
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${o}, -0.99999, 0.99999);
        float y_sq = y_clamped * y_clamped;
        result.${o} = y_clamped * sqrt(a / (1.0 - y_sq));
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float a = u_transform_params.x;
    // Jacobian: d/dx [x/sqrt(x^2+a)] = a/(x^2+a)^(3/2)
    // This is bell-shaped! Peaks at x=0, decays at infinity
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float x_sq = x.${o} * x.${o};
        float denom = x_sq + a;
        result.${o} = a / (denom * sqrt(denom));
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"a",label:"Width (a)",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Controls bell curve width. Higher = wider/shallower, lower = narrower/sharper."}]}},Qt=class extends J{constructor(){super("sine","Sine wave distortion (periodic speed bumps)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;
    return x + amplitude * sin(frequency * x);
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;

    // Newton's method: x_{n+1} = x_n - (f(x_n) - y) / f'(x_n)
    // where f(x) = x + a*sin(f*x)
    // f'(x) = 1 + a*f*cos(f*x)
    ${t} x = y; // Initial guess
    for (int iter = 0; iter < 5; iter++) {
        ${t} fx = x + amplitude * sin(frequency * x);
        ${t} dfx = ${t}(1.0) + amplitude * frequency * cos(frequency * x);
        x = x - (fx - y) / dfx;
    }
    return x;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float amplitude = u_transform_params.x;
    float frequency = u_transform_params.y;
    return ${t}(1.0) + amplitude * frequency * cos(frequency * x);
}`}getParameters(){return[{name:"amplitude",label:"Amplitude",type:"slider",min:1e-4,max:25,step:1e-4,default:.5,info:"Strength of distortion"},{name:"frequency",label:"Frequency",type:"slider",min:1e-4,max:25,step:1e-4,default:1,info:"Number of waves per unit length"}]}},ei=class extends J{constructor(){super("radial_power","Radial power (compress/expand by distance)")}generateForward(e){let t=`vec${e}`;return e===2?`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    if (r < 1e-8) return x;
    float r_new = pow(r, alpha);
    return x * (r_new / r);
}`:`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    if (r < 1e-8) return x;
    float r_new = pow(r, alpha);
    return x * (r_new / r);
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    float inv_alpha = 1.0 / alpha;
    float r = length(y);
    if (r < 1e-8) return y;
    float r_new = pow(r, inv_alpha);
    return y * (r_new / r);
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    float r = length(x);
    float jacobian_scalar = alpha * pow(r + 1e-8, alpha - 1.0);
    return ${t}(jacobian_scalar);
}`}getParameters(){return[{name:"alpha",label:"Radial Exponent (\u03B1)",type:"slider",min:.1,max:3,step:.1,default:.5,info:"\u03B1 < 1.0: zoom into origin; \u03B1 > 1.0: compress origin"}]}},ti=class extends J{constructor(){super("log","Logarithmic (stretch near zero)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = sign(x.${o}) * log(abs(x.${o}) + 1.0);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = sign(y.${o}) * (exp(abs(y.${o})) - 1.0);`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    // Jacobian: d/dx [sign(x)*log(|x|+1)] = 1/(|x|+1)
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = 1.0 / (abs(x.${o}) + 1.0);`}).join(`
    `)}
    return result;
}`}getParameters(){return[]}},ii=class extends J{constructor(){super("exp","Exponential (compress near zero)")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = sign(x.${o}) * (exp(alpha * abs(x.${o})) - 1.0);`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    float alpha = u_transform_params.x;
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = sign(y.${o}) * log(abs(y.${o}) + 1.0) / alpha;`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    float alpha = u_transform_params.x;
    // Jacobian: d/dx [sign(x)*(exp(\u03B1|x|)-1)] = \u03B1*exp(\u03B1|x|)
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = alpha * exp(alpha * abs(x.${o}));`}).join(`
    `)}
    return result;
}`}getParameters(){return[{name:"alpha",label:"Growth Rate (\u03B1)",type:"slider",min:.1,max:2,step:.1,default:.5,info:"Higher \u03B1 = stronger exponential growth. Use small values (0.1-0.5) to avoid overflow."}]}},ri=class extends J{constructor(){super("softsign","Soft-sign (smooth compression to [-1,1])")}generateForward(e){let t=`vec${e}`;return`
${t} transform_forward(${t} x) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`result.${o} = x.${o} / (1.0 + abs(x.${o}));`}).join(`
    `)}
    return result;
}`}generateInverse(e){let t=`vec${e}`;return`
${t} transform_inverse(${t} y) {
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float y_clamped = clamp(y.${o}, -0.99999, 0.99999);
        result.${o} = y_clamped / (1.0 - abs(y_clamped));
    }`}).join(`
    `)}
    return result;
}`}generateJacobian(e){let t=`vec${e}`;return`
${t} transform_jacobian(${t} x) {
    // Jacobian: d/dx [x/(1+|x|)] = 1/(1+|x|)^2
    ${t} result;
    ${Array.from({length:e},(i,r)=>{let o=["x","y","z","w"][r]||`[${r}]`;return`{
        float denom = 1.0 + abs(x.${o});
        result.${o} = 1.0 / (denom * denom);
    }`}).join(`
    `)}
    return result;
}`}getParameters(){return[]}},ni=class extends J{constructor(){super("custom","Custom (user-defined GLSL)"),this.forwardCode="",this.inverseCode="",this.jacobianCode=""}setCode(e,t,i){this.forwardCode=e,this.inverseCode=t,this.jacobianCode=i}generateForward(e){return this.forwardCode||new ye().generateForward(e)}generateInverse(e){return this.inverseCode||new ye().generateInverse(e)}generateJacobian(e){return this.jacobianCode||new ye().generateJacobian(e)}},Ki={identity:new ye,power:new Jt,log:new ti,exp:new ii,softsign:new ri,tanh:new Yt,sigmoid:new Kt,rational:new Zt,sine:new Qt,radial_power:new ei,custom:new ni};function mt(n){return Ki[n]||Ki.identity}function Zi(n,e){let t=`vec${e}`,r={white:{name:"Solid White",code:`
// Simple solid white particles
vec3 getColor(${t} pos, ${t} velocity, ${t} field_velocity, ${t} velocity_proj) {
    return vec3(1.0, 1.0, 1.0);
}
`},velocity_magnitude:{name:"Velocity Magnitude",usesMaxVelocity:!0,usesGradient:!0},velocity_angle:{name:"Velocity Angle",usesGradient:!0},velocity_combined:{name:"Velocity Angle + Magnitude",usesMaxVelocity:!0,usesGradient:!0},field_magnitude:{name:"Field Magnitude",usesMaxVelocity:!0,usesGradient:!0},field_angle:{name:"Field Angle",usesGradient:!0},field_combined:{name:"Field Angle + Magnitude",usesMaxVelocity:!0,usesGradient:!0},expression:{name:"Expression",usesMaxVelocity:!1,requiresExpression:!0,code:null},custom:{name:"Custom (Advanced)",code:`
// Custom color function
// Inputs: pos (position vector), velocity (full N-D velocity), velocity_proj (projected 2D velocity)
// Output: RGB color vec3
vec3 getColor(${t} pos, ${t} velocity, ${t} field_velocity, ${t} velocity_proj) {
    return vec3(1.0, 1.0, 1.0);
}
`}}[n];if(!r)throw new Error(`Unknown color mode: ${n}`);return r}function Qi(n,e,t){let i=`vec${n}`,r=[],o=["x","y","z","w","u","v"],s=["dx","dy","dz","dw","du","dv"];for(let l=0;l<n;l++)r.push(`float ${o[l]} = pos.${o[l]};`),r.push(`float ${s[l]} = velocity.${o[l]};`);return`
${t}

vec3 getColor(${i} pos, ${i} velocity, ${i} field_velocity, ${i} velocity_proj) {
    // Unpack position and FULL velocity components for user expression
    ${r.join(`
    `)}

    // Evaluate user expression
    float value = ${e};

    // Map through gradient
    return evaluateGradient(value);
}
`}function er(n,e,t){let i=`vec${e}`,r;switch(n){case"velocity_magnitude":r=`
    // Use full N-dimensional velocity magnitude
    float speed = length(velocity);
    float normalized;
    if (u_velocity_log_scale > 0.5) {
        // Logarithmic scaling: log(1 + speed) / log(1 + max_velocity)
        normalized = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        // Linear scaling
        normalized = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }
    return evaluateGradient(normalized);`;break;case"velocity_angle":r=`
    // Use projected 2D velocity angle
    float angle = atan(velocity_proj.y, velocity_proj.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    return evaluateGradient(hue);`;break;case"velocity_combined":r=`
    // Full velocity for magnitude, projected velocity for angle
    float speed = length(velocity);
    float angle = atan(velocity_proj.y, velocity_proj.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    float saturation;
    if (u_velocity_log_scale > 0.5) {
        // Logarithmic scaling: log(1 + speed) / log(1 + max_velocity)
        saturation = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        // Linear scaling
        saturation = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }

    // Get color from gradient based on angle
    vec3 fullColor = evaluateGradient(hue);

    // Desaturate based on speed (slow \u2192 grey, fast \u2192 full color)
    const vec3 grey = vec3(0.5, 0.5, 0.5);
    return mix(grey, fullColor, saturation);`;break;case"field_magnitude":r=`
    // Use field velocity magnitude
    float speed = length(field_velocity);
    float normalized;
    if (u_velocity_log_scale > 0.5) {
        normalized = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        normalized = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }
    return evaluateGradient(normalized);`;break;case"field_angle":r=`
    // Use field velocity angle in 2D
    vec2 field_2d = vec2(field_velocity.x, field_velocity.y);
    float angle = atan(field_2d.y, field_2d.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    return evaluateGradient(hue);`;break;case"field_combined":r=`
    // Field velocity for both magnitude and angle
    float speed = length(field_velocity);
    vec2 field_2d = vec2(field_velocity.x, field_velocity.y);
    float angle = atan(field_2d.y, field_2d.x);
    float hue = (angle + 3.14159265) / (2.0 * 3.14159265);
    float saturation;
    if (u_velocity_log_scale > 0.5) {
        saturation = clamp(log(1.0 + speed) / log(1.0 + max(u_max_velocity, 0.1)), 0.0, 1.0);
    } else {
        saturation = clamp(speed / max(u_max_velocity, 0.1), 0.0, 1.0);
    }

    vec3 fullColor = evaluateGradient(hue);
    const vec3 grey = vec3(0.5, 0.5, 0.5);
    return mix(grey, fullColor, saturation);`;break;default:throw new Error(`Cannot create gradient version of color mode: ${n}`)}return`
${t}

vec3 getColor(${i} pos, ${i} velocity, ${i} field_velocity, ${i} velocity_proj) {
    ${r}
}
`}function oi(n){let e=[...n].sort((i,r)=>i.position-r.position);if(e.length<2)throw new Error("Gradient must have at least 2 color stops");e.forEach(i=>{if(i.position<0||i.position>1)throw new Error(`Stop position must be in [0, 1], got ${i.position}`)});let t=`vec3 evaluateGradient(float t) {
    t = clamp(t, 0.0, 1.0);
`;for(let i=0;i<e.length-1;i++){let r=e[i],o=e[i+1],s=tr(r.color),l=tr(o.color),c=r.position.toFixed(6),u=o.position.toFixed(6);i===0?t+=`    if (t <= ${u}) {
`:i===e.length-2?t+=`    } else {
`:t+=`    } else if (t <= ${u}) {
`,t+=`        float segmentT = (t - ${c}) / (${u} - ${c});
`,t+=`        return mix(${s}, ${l}, segmentT);
`}return t+=`    }
`,t+=`}
`,t}function tr(n){return`vec3(${n[0].toFixed(6)}, ${n[1].toFixed(6)}, ${n[2].toFixed(6)})`}function Ln(){return[{position:0,color:[1,0,0]},{position:.17,color:[1,1,0]},{position:.33,color:[0,1,0]},{position:.5,color:[0,1,1]},{position:.67,color:[0,0,1]},{position:.83,color:[1,0,1]},{position:1,color:[1,0,0]}]}function ve(){return Ln()}function ir(n){n=n.replace("#","");let e=parseInt(n.substring(0,2),16)/255,t=parseInt(n.substring(2,4),16)/255,i=parseInt(n.substring(4,6),16)/255;return[e,t,i]}function si(n){let e=Math.round(n[0]*255).toString(16).padStart(2,"0"),t=Math.round(n[1]*255).toString(16).padStart(2,"0"),i=Math.round(n[2]*255).toString(16).padStart(2,"0");return`#${e}${t}${i}`}function Mn(n){let e={linear:{name:"Linear (No Tone Mapping)",description:"Direct exposure and gamma, no compression. Values > 1 will clip.",usesWhitePoint:!1,defaultExposure:1},reinhard:{name:"Reinhard",description:"Simple, preserves hues. Formula: color / (1 + color)",usesWhitePoint:!1,defaultExposure:1},reinhard_extended:{name:"Reinhard Extended",description:"Reinhard with adjustable white point for highlight control",usesWhitePoint:!0,defaultExposure:1,defaultWhitePoint:2},filmic:{name:"Filmic (ACES Approximation)",description:"Film-like S-curve, industry standard look",usesWhitePoint:!1,defaultExposure:1},uncharted2:{name:"Uncharted 2",description:"Popular in games, punchy highlights and saturated colors",usesWhitePoint:!0,defaultExposure:2,defaultWhitePoint:11.2},aces:{name:"ACES (Academy Color)",description:"Academy standard, natural film-like response",usesWhitePoint:!1,defaultExposure:1},hable:{name:"Hable (Uncharted 2 Filmic)",description:"John Hable's filmic curve, excellent highlight rolloff",usesWhitePoint:!0,defaultExposure:2,defaultWhitePoint:11.2},luminance_reinhard:{name:"Luminance Reinhard (Hue Preserving)",description:"Tone maps brightness only, preserves color hue/saturation perfectly. Ideal for attractors.",usesWhitePoint:!1,defaultExposure:1},luminance_extended:{name:"Luminance Extended (Hue Preserving)",description:"Extended Reinhard on luminance only. Best for colorful attractor density visualization.",usesWhitePoint:!0,defaultExposure:1,defaultWhitePoint:5}};return e[n]||e.linear}function rr(n,e={}){let t=Mn(n),i=e.exposure!==void 0?e.exposure:t.defaultExposure,r=e.gamma!==void 0?e.gamma:2.2,o=e.whitePoint!==void 0?e.whitePoint:t.defaultWhitePoint||1,s=e.luminanceGamma!==void 0?e.luminanceGamma:1,l=`
// Tone mapping operator: ${t.name}
// ${t.description}

`;switch(n){case"linear":l+=`
vec3 tonemap(vec3 color) {
    // Simple exposure, no compression
    return color * ${i.toFixed(6)};
}
`;break;case"reinhard":l+=`
vec3 tonemap(vec3 color) {
    // Reinhard tone mapping: color / (1 + color)
    color *= ${i.toFixed(6)};
    return color / (vec3(1.0) + color);
}
`;break;case"reinhard_extended":l+=`
vec3 tonemap(vec3 color) {
    // Reinhard with white point
    color *= ${i.toFixed(6)};
    float whitePoint = ${o.toFixed(6)};
    vec3 numerator = color * (vec3(1.0) + (color / (whitePoint * whitePoint)));
    return numerator / (vec3(1.0) + color);
}
`;break;case"filmic":case"aces":l+=`
// ACES approximation (simplified)
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // ACES fitted curve
    const float a = 2.51;
    const float b = 0.03;
    const float c = 2.43;
    const float d = 0.59;
    const float e = 0.14;

    return clamp((color * (a * color + b)) / (color * (c * color + d) + e), 0.0, 1.0);
}
`;break;case"uncharted2":case"hable":l+=`
// Uncharted 2 filmic tone mapping by John Hable
vec3 uncharted2Curve(vec3 x) {
    const float A = 0.15; // Shoulder strength
    const float B = 0.50; // Linear strength
    const float C = 0.10; // Linear angle
    const float D = 0.20; // Toe strength
    const float E = 0.02; // Toe numerator
    const float F = 0.30; // Toe denominator
    return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;
}

vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Apply curve
    vec3 curr = uncharted2Curve(color);

    // White point scaling
    float whitePoint = ${o.toFixed(6)};
    vec3 whiteScale = vec3(1.0) / uncharted2Curve(vec3(whitePoint));

    return curr * whiteScale;
}
`;break;case"luminance_reinhard":l+=`
// Luminance-based Reinhard (hue-preserving)
// Tone maps brightness only, keeps color ratios intact
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Apply Reinhard to luminance only
    float toneMappedLuma = luma / (1.0 + luma);

    // Scale color to match tone-mapped luminance
    // This preserves hue and saturation perfectly
    return color * (toneMappedLuma / luma);
}
`;break;case"luminance_extended":l+=`
// Luminance-based Extended Reinhard (hue-preserving)
// Best for attractor visualization with dense bright regions
vec3 tonemap(vec3 color) {
    color *= ${i.toFixed(6)};

    // Calculate luminance (Rec. 709)
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Extended Reinhard with white point on luminance only
    float whitePoint = ${o.toFixed(6)};
    float numerator = luma * (1.0 + (luma / (whitePoint * whitePoint)));
    float toneMappedLuma = numerator / (1.0 + luma);

    // Scale color to match tone-mapped luminance
    // This preserves hue and saturation perfectly
    return color * (toneMappedLuma / luma);
}
`;break;default:l+=`
vec3 tonemap(vec3 color) {
    return color * ${i.toFixed(6)};
}
`}return l+=`
vec3 applyGamma(vec3 color) {
    return pow(color, vec3(1.0 / ${r.toFixed(6)}));
}

vec3 applyLuminanceGamma(vec3 color) {
    // Luminance-preserving gamma: adjusts brightness only, preserves hue
    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));

    // Avoid division by zero
    if (luma < 0.0001) return vec3(0.0);

    // Apply gamma to luminance only
    float gammaCorrectedLuma = pow(luma, 1.0 / ${s.toFixed(6)});

    // Scale color to match gamma-corrected luminance
    // This preserves hue and saturation perfectly
    return color * (gammaCorrectedLuma / luma);
}
`,l}ae();M();var we=class{constructor(e){this.gl=e}getTextureFormat(){throw new Error("getTextureFormat() must be implemented by subclass")}getArrayType(){throw new Error("getArrayType() must be implemented by subclass")}getComponentsPerValue(){throw new Error("getComponentsPerValue() must be implemented by subclass")}requiresExtension(){return!1}getExtensionName(){return null}encodeValue(e,t,i){throw new Error("encodeValue() must be implemented by subclass")}decodeValue(e,t,i){throw new Error("decodeValue() must be implemented by subclass")}normalizeWorld(e,t,i){throw new Error("normalizeWorld() must be implemented by subclass")}denormalizeWorld(e,t,i){throw new Error("denormalizeWorld() must be implemented by subclass")}getGLSLConstants(){throw new Error("getGLSLConstants() must be implemented by subclass")}getGLSLDecodeFunction(){throw new Error("getGLSLDecodeFunction() must be implemented by subclass")}getGLSLEncodeFunction(){throw new Error("getGLSLEncodeFunction() must be implemented by subclass")}getGLSLNormalizeFunction(){throw new Error("getGLSLNormalizeFunction() must be implemented by subclass")}getGLSLDenormalizeFunction(){throw new Error("getGLSLDenormalizeFunction() must be implemented by subclass")}getName(){throw new Error("getName() must be implemented by subclass")}};ui();var He=class extends we{constructor(e){super(e)}getName(){return"RGBA Fixed-Point Encoding"}getTextureFormat(){let e=this.gl;return{internalFormat:e.RGBA,format:e.RGBA,type:e.UNSIGNED_BYTE}}getArrayType(){return Uint8Array}getComponentsPerValue(){return 4}requiresExtension(){return!1}getExtensionName(){return null}encodeValue(e,t,i){let r=(e-t)/(i-t),o=new Uint8Array(4);return li(r,o,0),o}decodeValue(e,t,i){let r=ci(e[0],e[1],e[2],e[3]);return t+r*(i-t)}normalizeWorld(e,t,i){return(e-t)/(i-t)}denormalizeWorld(e,t,i){return t+e*(i-t)}getGLSLConstants(){return`
// Map to [0, 1] range for maximum precision at any zoom level
const float FIXED_POINT_SCALE = 4294967295.0; // 2^32 - 1
`}getGLSLDecodeFunction(){return`
// Decode RGBA bytes back to float in [0, 1] range
float decodeFloat(vec4 rgba) {
    // Reconstruct 32-bit integer from bytes (big-endian)
    vec4 bytes = rgba * 255.0;
    float intValue = bytes.r * 16777216.0 + bytes.g * 65536.0 + bytes.b * 256.0 + bytes.a;

    // Map from [0, 2^32-1] back to [0, 1]
    return intValue / FIXED_POINT_SCALE;
}
`}getGLSLEncodeFunction(){return`
// Encode float in [0, 1] range to RGBA bytes
vec4 encodeFloat(float v) {
    // Clamp to [0, 1]
    v = clamp(v, 0.0, 1.0);

    // Map to [0, 2^32-1]
    float normalized = v * FIXED_POINT_SCALE;

    // Split into 4 bytes (big-endian)
    float byte0 = floor(normalized / 16777216.0);  // 2^24
    normalized -= byte0 * 16777216.0;
    float byte1 = floor(normalized / 65536.0);      // 2^16
    normalized -= byte1 * 65536.0;
    float byte2 = floor(normalized / 256.0);        // 2^8
    normalized -= byte2 * 256.0;
    float byte3 = floor(normalized);

    return vec4(byte0, byte1, byte2, byte3) / 255.0;
}
`}getGLSLNormalizeFunction(){return`
// Helper to normalize world coordinate to [0, 1] relative to viewport
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return (worldValue - minVal) / (maxVal - minVal);
}
`}getGLSLDenormalizeFunction(){return`
// Helper to denormalize from [0, 1] back to world coordinates
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return minVal + normalized * (maxVal - minVal);
}
`}};M();var pt=class extends we{constructor(e){if(super(e),!e.getExtension("OES_texture_float"))throw new Error("OES_texture_float extension not supported");a.info("Float texture support detected",{extension:"OES_texture_float"})}getName(){return"Float Textures (Direct Storage)"}getTextureFormat(){let e=this.gl;return{internalFormat:e.RGBA,format:e.RGBA,type:e.FLOAT}}getArrayType(){return Float32Array}getComponentsPerValue(){return 4}requiresExtension(){return!0}getExtensionName(){return"OES_texture_float"}encodeValue(e,t,i){let r=new Float32Array(4);return r[0]=e,r[1]=0,r[2]=0,r[3]=1,r}decodeValue(e,t,i){return e[0]}normalizeWorld(e,t,i){return e}denormalizeWorld(e,t,i){return e}getGLSLConstants(){return`
// Float strategy: no constants needed
`}getGLSLDecodeFunction(){return`
// Decode float from RGBA - just read the red channel directly
float decodeFloat(vec4 rgba) {
    return rgba.r;
}
`}getGLSLEncodeFunction(){return`
// Encode float to RGBA - store in red channel
vec4 encodeFloat(float v) {
    return vec4(v, 0.0, 0.0, 1.0);
}
`}getGLSLNormalizeFunction(){return`
// Float strategy: no normalization needed, pass through directly
float normalizeToViewport(float worldValue, float minVal, float maxVal) {
    return worldValue;
}
`}getGLSLDenormalizeFunction(){return`
// Float strategy: no denormalization needed, pass through directly
float denormalizeFromViewport(float normalized, float minVal, float maxVal) {
    return normalized;
}
`}};var ft=class{constructor(e,t={}){if(this.canvas=e,this.gl=e.getContext("webgl",{alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!0}),!this.gl)throw new Error("WebGL not supported");let i=this.gl;i.disable(i.DEPTH_TEST),i.disable(i.STENCIL_TEST),i.enable(i.BLEND);let r=t.storageStrategy||"rgba";try{r==="float"?(this.strategy=new pt(i),a.info("Using Float texture strategy")):(this.strategy=new He(i),a.info("Using RGBA encoded texture strategy"))}catch(b){a.warn(`Failed to initialize ${r} strategy: ${b.message}`),a.info("Falling back to RGBA strategy"),this.strategy=new He(i)}this.dimensions=2,this.expressions=["-y","x"],this.coordinateSystem=j(this.dimensions);try{let b=this.coordinateSystem.getVariableNames();this.velocityEvaluators=qt(this.expressions,b),a.verbose("Initial velocity evaluators created",{coordinateSystem:this.coordinateSystem.name,variables:b})}catch(b){a.warn("Failed to create initial velocity evaluators",b),this.velocityEvaluators=null}this.integratorType="rk4",this.integratorParams={iterations:3},this.integratorCostFactor=1,this.solutionMethod="fixed-point",this.transformType="identity",this.transformParams={},this.mapperType="select",this.mapperParams={dim1:0,dim2:1},this.colorMode="white",this.colorExpression="x * y",this.colorGradient=ve(),this.velocityScaleMode="percentile95",this.velocityLogScale=!1,this.useHDR=t.useHDR!==void 0?t.useHDR:!0,this.tonemapOperator=t.tonemapOperator||"aces",this.exposure=t.exposure!==void 0?t.exposure:1,this.gamma=t.gamma!==void 0?t.gamma:2.2,this.luminanceGamma=t.luminanceGamma!==void 0?t.luminanceGamma:1,this.highlightCompression=t.highlightCompression!==void 0?t.highlightCompression:0,this.compressionThreshold=t.compressionThreshold!==void 0?t.compressionThreshold:1,this.whitePoint=t.whitePoint!==void 0?t.whitePoint:2,this.particleIntensity=t.particleIntensity!==void 0?t.particleIntensity:1,this.particleSize=t.particleSize!==void 0?t.particleSize:1,this.particleRenderMode=t.particleRenderMode||"points",this.useDepthTest=t.useDepthTest!==void 0?t.useDepthTest:!1,this.colorSaturation=t.colorSaturation!==void 0?t.colorSaturation:1,this.brightnessDesaturation=t.brightnessDesaturation!==void 0?t.brightnessDesaturation:0,this.brightnessSaturation=t.brightnessSaturation!==void 0?t.brightnessSaturation:0,this.smaaEnabled=t.smaaEnabled!==void 0?t.smaaEnabled:!0,this.smaaIntensity=t.smaaIntensity!==void 0?t.smaaIntensity:.75,this.smaaThreshold=t.smaaThreshold!==void 0?t.smaaThreshold:.1,this.bilateralEnabled=t.bilateralEnabled!==void 0?t.bilateralEnabled:!1,this.bilateralSpatialSigma=t.bilateralSpatialSigma!==void 0?t.bilateralSpatialSigma:4,this.bilateralIntensitySigma=t.bilateralIntensitySigma!==void 0?t.bilateralIntensitySigma:.2;let o=t.supersampleFactor!==void 0?t.supersampleFactor:1;(typeof o!="number"||isNaN(o)||o<=0)&&(a.warn(`Invalid supersampleFactor: ${o}, using default 1.0`),o=1),this.supersampleFactor=Math.max(.5,Math.min(4,o)),a.info(`Initial render scale factor set to: ${this.supersampleFactor}`),this.timestep=.01,this.fadeOpacity=.99,this.dropProbability=.003,this.respawnMargin=.2,this.animationAlpha=0,this.lockShaderRecompilation=!1,this.enableDebugStats=!1,this.maxVelocity=5,this.prevMaxVelocity=5,this.velocityEMAAlpha=.1,this.velocitySampleInterval=10,this.velocitySampleIntervalMin=5,this.velocitySampleIntervalMax=60,this.framesSinceLastSample=0,this.lowVelocityThreshold=.02;let c=10*(e.width/e.height);this.bbox={min:[-c/2,-5],max:[c/2,5]},this.particleSystem=new ct(1e4,this.dimensions,this.bbox,this.strategy),this.textureManager=new De(i,this.dimensions,this.particleSystem.getResolution(),this.strategy),this.particleRenderMode==="lines"&&this.textureManager.setLineMode(!0),this.updateFramebuffer=i.createFramebuffer();let u=Math.max(1,e.width||800),d=Math.max(1,e.height||600);this.renderWidth=Math.max(1,Math.floor(u*this.supersampleFactor)),this.renderHeight=Math.max(1,Math.floor(d*this.supersampleFactor)),a.verbose("Render dimensions calculated",{canvasSize:`${u}x${d}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),a.info("Initializing HDR rendering system...",{requested:this.useHDR,canvasSize:`${e.width}x${e.height}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),this.framebufferManager=new ke(i,this.renderWidth,this.renderHeight,{useHDR:this.useHDR,usePingPong:!0});let h=this.framebufferManager.getHDRSupport();a.info("HDR rendering system initialized",{hdrEnabled:h.enabled,hdrSupported:h.supported,textureFormat:h.format,extensions:{floatColorBuffer:h.hasFloatColorBuffer,halfFloatColorBuffer:h.hasHalfFloatColorBuffer,linearFiltering:h.hasLinearFiltering},exposure:this.exposure,gamma:this.gamma}),this.useHDR&&!h.supported&&a.warn("HDR rendering requested but not supported by device. Using LDR fallback."),this.smaaManager=new st(i,this.renderWidth,this.renderHeight,{enabled:this.smaaEnabled,intensity:this.smaaIntensity,threshold:this.smaaThreshold}),a.info("SMAA system initialized",{enabled:this.smaaManager.isEnabled(),intensity:this.smaaIntensity,threshold:this.smaaThreshold}),this.bilateralManager=new ot(i,this.renderWidth,this.renderHeight,{enabled:this.bilateralEnabled,spatialSigma:this.bilateralSpatialSigma,intensitySigma:this.bilateralIntensitySigma}),a.info("Bilateral filter initialized",{enabled:this.bilateralManager.isEnabled(),spatialSigma:this.bilateralSpatialSigma,intensitySigma:this.bilateralIntensitySigma}),this.ldrFramebuffer=i.createFramebuffer(),this.ldrTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.ldrTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindFramebuffer(i.FRAMEBUFFER,this.ldrFramebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.ldrTexture,0);let p=i.checkFramebufferStatus(i.FRAMEBUFFER);p!==i.FRAMEBUFFER_COMPLETE&&a.error("LDR framebuffer incomplete",{status:p}),i.bindFramebuffer(i.FRAMEBUFFER,null),a.info("LDR framebuffer created for tone mapping output"),this.finalFramebuffer=i.createFramebuffer(),this.finalTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.finalTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindFramebuffer(i.FRAMEBUFFER,this.finalFramebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.finalTexture,0);let m=i.checkFramebufferStatus(i.FRAMEBUFFER);m!==i.FRAMEBUFFER_COMPLETE&&a.error("Final framebuffer incomplete",{status:m}),i.bindFramebuffer(i.FRAMEBUFFER,null),a.info("Final framebuffer created for supersampling output"),this.bufferStatsManager=new at(i),this.velocityStatsManager=new lt(i),this.statsUpdateInterval=60,this.statsUpdateIntervalSlow=120,this.statsCoarseMode=!0,this.quadBuffer=this.createBuffer(new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])),this.smaaManager.setQuadBuffer(this.quadBuffer),this.bilateralManager.setQuadBuffer(this.quadBuffer),a.info("Compiling shaders...",{dimensions:this.dimensions,integrator:this.integratorType});let f=this.compileShaders();if(f)throw a.error("Shader compilation failed",f),new Error(`Shader compilation failed: ${f}`);a.info("Shaders compiled successfully"),a.info("Initializing particle textures...",{resolution:this.particleSystem.getResolution(),particleCount:this.particleSystem.getActualParticleCount()}),this.textureManager.initializeData(this.particleSystem.getAllData()),this.indexBufferPoints=this.createBuffer(this.particleSystem.getIndices()),this.indexBufferLines=this.createLineIndexBuffer(this.particleSystem.getActualParticleCount()),this.vertexIdBufferLines=this.createLineVertexIdBuffer(this.particleSystem.getActualParticleCount()),this.isRunning=!1,this.frame=0,this.hdrLogged=!1}createBuffer(e){let t=this.gl,i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i}createLineIndexBuffer(e){let t=this.gl,i=new Float32Array(e*2);for(let o=0;o<e;o++)i[o*2]=o,i[o*2+1]=o;let r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),r}createLineVertexIdBuffer(e){let t=this.gl,i=new Float32Array(e*2);for(let o=0;o<e*2;o++)i[o]=o%2;let r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),r}compileShaders(){let e=this.gl;try{let t=this.coordinateSystem.getVariableNames(),i=this.coordinateSystem.name.includes("Cartesian"),r;if(this.velocityGLSL)r=this.velocityGLSL,a.verbose("Using pre-generated velocity GLSL",{glsl:r});else{let E=i?"pos":"pos_native";r=Pi(this.expressions,t,E),a.verbose("Generated velocity GLSL from expressions",{expressions:this.expressions,coordinateSystem:this.coordinateSystem.name,variables:t,posVarName:E,glsl:r})}let o=null;if(!i){let E=["x","y","z","w","u","v"].slice(0,this.dimensions),L=this.coordinateSystem.getVariableNames();o={name:this.coordinateSystem.name,nativeVars:L,forwardTransform:this.coordinateSystem.generateForwardTransformGLSL(E,(k,A)=>W(k,A.length,A)),inverseTransform:this.coordinateSystem.generateInverseTransformGLSL(L,(k,A)=>W(k,A.length,A))},a.verbose("Generated coordinate system code",{name:o.name,forward:o.forwardTransform,inverse:o.inverseTransform})}let s={...this.integratorParams,expressions:this.expressions,solutionMethod:this.solutionMethod},l=Ji(this.integratorType,this.dimensions,s);this.integratorCostFactor=l.costFactor||1;let c=Yi(this.mapperType,this.dimensions,this.mapperParams),u=null;if(this.transformType!=="identity"){let E=mt(this.transformType);u={helpers:E.generateHelpers(this.dimensions),forward:E.generateForward(this.dimensions),inverse:E.generateInverse(this.dimensions),jacobian:E.generateJacobian(this.dimensions)}}let d=Zi(this.colorMode,this.dimensions),h=d.code,p=d.usesMaxVelocity||!1;if(this.colorMode==="expression"){let E=W(this.colorExpression,this.dimensions),L=oi(this.colorGradient);h=Qi(this.dimensions,E,L)}else if(d.usesGradient){let E=oi(this.colorGradient);h=er(this.colorMode,this.dimensions,E)}let m=Vi(),f=zi(this.dimensions,r,l.code,this.strategy,u,o);this.updateProgram=K(e,m,f);let b=this.particleRenderMode==="lines",x=Ni(this.dimensions,c.code,r,this.strategy,b,o),g=Ui(this.dimensions,h,p);this.drawProgram=K(e,x,g),this.usesMaxVelocity=p,this.shaderSource={updateVertex:m,updateFragment:f,drawVertex:x,drawFragment:g,velocityField:r},this.dumpShadersOnCompile&&(console.log(`
========== SHADER DUMP ==========`),console.log(`Config: ${this.dimensions}D, ${this.integratorType}, ${this.mapperType}, ${this.colorMode}`),console.log(`
--- UPDATE VERTEX SHADER ---`),console.log(m),console.log(`
--- UPDATE FRAGMENT SHADER ---`),console.log(f),console.log(`
--- DRAW VERTEX SHADER ---`),console.log(x),console.log(`
--- DRAW FRAGMENT SHADER ---`),console.log(g),console.log(`
=================================
`),this.dumpShadersOnCompile=!1),this.velocityStatsManager&&(this.velocityStatsManager.dispose(),this.velocityStatsManager.initialize(this.dimensions,r,o)?a.verbose("Velocity stats manager initialized"):a.warn("Failed to initialize velocity stats manager"));let y=Oi(),_=Gi(),S=rr(this.tonemapOperator,{exposure:this.exposure,gamma:this.gamma,luminanceGamma:this.luminanceGamma,whitePoint:this.whitePoint}),F=Hi(S);return this.screenFadeProgram=K(e,y,_),this.tonemapProgram=K(e,y,F),this.shaderSource.screenFade=_,this.shaderSource.tonemap=F,a.verbose("Tone mapping operator compiled",{operator:this.tonemapOperator,exposure:this.exposure,gamma:this.gamma,whitePoint:this.whitePoint}),this.shadersJustRecompiled=!0,null}catch(t){return t.message}}updatePositions(){let e=this.gl,t=this.updateProgram;this.enableDebugStats&&this.frame%60===0&&this.sampleParticleData(),this.frame%600===0&&a.verbose(`Frame ${this.frame}: Shader uniforms`,{u_min:[this.bbox.min[0],this.bbox.min[1]],u_max:[this.bbox.max[0],this.bbox.max[1]],u_h:this.timestep*(this.integratorCostFactor||1),timestep_base:this.timestep,costFactor:this.integratorCostFactor||1,u_drop_rate:this.dropProbability}),e.useProgram(t);let i=e.getAttribLocation(t,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.textureManager.bindReadTextures(t);let r=this.particleSystem.getResolution(),o=Math.random();e.uniform2f(e.getUniformLocation(t,"u_min"),this.bbox.min[0],this.bbox.min[1]),e.uniform2f(e.getUniformLocation(t,"u_max"),this.bbox.max[0],this.bbox.max[1]),e.uniform1f(e.getUniformLocation(t,"u_h"),this.timestep*(this.integratorCostFactor||1)),e.uniform1f(e.getUniformLocation(t,"u_rand_seed"),o),e.uniform1f(e.getUniformLocation(t,"u_drop_rate"),this.dropProbability),e.uniform1f(e.getUniformLocation(t,"u_respawn_margin"),this.respawnMargin),e.uniform1f(e.getUniformLocation(t,"u_particles_res"),r);let s=this.getVelocityScale();e.uniform1f(e.getUniformLocation(t,"u_max_velocity"),s);let l=e.getUniformLocation(t,"u_alpha");if(l!==null&&e.uniform1f(l,this.animationAlpha),this.transformType!=="identity"){let c=this.transformParams||{},u=[c.alpha||c.beta||c.k||c.amplitude||.5,c.frequency||0,0,0];e.uniform4f(e.getUniformLocation(t,"u_transform_params"),u[0],u[1],u[2],u[3])}for(let c=0;c<this.dimensions;c++){e.uniform1i(e.getUniformLocation(t,"u_out_coordinate"),c);let u=this.textureManager.getWriteTexture(c);e.bindFramebuffer(e.FRAMEBUFFER,this.updateFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,u,0),e.viewport(0,0,r,r),e.drawArrays(e.TRIANGLES,0,6)}this.textureManager.swap(),this.frame++}drawParticles(){let e=this.gl,t=this.drawProgram;if(e.useProgram(t),e.blendFunc(e.SRC_ALPHA,e.ONE),this.framesSinceLastSample++,this.framesSinceLastSample>=this.velocitySampleInterval){if(this.framesSinceLastSample=0,this.velocityStatsManager&&this.velocityStatsManager.initialized){let u=this.textureManager.getReadTextures(),d=this.velocityStatsManager.compute(u,this.bbox,this.particleSystem.getResolution(),this.animationAlpha);if(this.frame%600===0&&d.sampleCount>0&&a.debug(`GPU velocity stats: avg=${d.avgVelocity.toFixed(3)}, max=${d.maxVelocity.toFixed(3)} (${d.sampleCount} samples)`),d.maxVelocity>0){let h=d.maxVelocity>this.maxVelocity?this.velocityEMAAlpha*2:this.velocityEMAAlpha;this.prevMaxVelocity=this.maxVelocity,this.maxVelocity=h*d.maxVelocity+(1-h)*this.maxVelocity}}else this.velocityStatsWarningLogged||(a.warn("Velocity stats manager not initialized - max velocity will not be computed"),this.velocityStatsWarningLogged=!0);let s=Math.abs(this.maxVelocity-this.prevMaxVelocity)/Math.max(this.maxVelocity,.1),l=.05,c=.01;if(s>l)this.velocitySampleInterval=this.velocitySampleIntervalMin;else if(s<c)this.velocitySampleInterval=this.velocitySampleIntervalMax;else{let u=(s-c)/(l-c);this.velocitySampleInterval=Math.round(this.velocitySampleIntervalMax*(1-u)+this.velocitySampleIntervalMin*u)}}this.maxVelocity=Math.max(this.maxVelocity,.5);let i=e.getAttribLocation(t,"a_index"),r=this.particleRenderMode==="lines"?this.indexBufferLines:this.indexBufferPoints;if(e.bindBuffer(e.ARRAY_BUFFER,r),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,1,e.FLOAT,!1,0,0),this.particleRenderMode==="lines"){let s=e.getAttribLocation(t,"a_vertex_id");s!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,this.vertexIdBufferLines),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,1,e.FLOAT,!1,0,0))}this.textureManager.bindReadTextures(t),this.textureManager.bindPrevTextures(t),e.uniform1f(e.getUniformLocation(t,"u_particles_res"),this.particleSystem.getResolution()),e.uniform2f(e.getUniformLocation(t,"u_min"),this.bbox.min[0],this.bbox.min[1]),e.uniform2f(e.getUniformLocation(t,"u_max"),this.bbox.max[0],this.bbox.max[1]),e.uniform1f(e.getUniformLocation(t,"u_particle_intensity"),this.particleIntensity),e.uniform1f(e.getUniformLocation(t,"u_particle_size"),this.particleSize),e.uniform2f(e.getUniformLocation(t,"u_viewport_size"),this.renderWidth,this.renderHeight),e.uniform2f(e.getUniformLocation(t,"u_canvas_size"),this.canvas.width,this.canvas.height),e.uniform1f(e.getUniformLocation(t,"u_color_saturation"),this.colorSaturation);let o=e.getUniformLocation(t,"u_alpha");if(o!==null&&e.uniform1f(o,this.animationAlpha),this.usesMaxVelocity){let s=this.getVelocityScale();e.uniform1f(e.getUniformLocation(t,"u_max_velocity"),s),e.uniform1f(e.getUniformLocation(t,"u_velocity_log_scale"),this.velocityLogScale?1:0)}this.particleRenderMode==="lines"?e.drawArrays(e.LINES,0,this.particleSystem.getActualParticleCount()*2):e.drawArrays(e.POINTS,0,this.particleSystem.getActualParticleCount())}getVelocityScale(){if(!this.velocityStatsManager||!this.velocityStatsManager.initialized)return this.maxVelocity;let e=this.velocityStatsManager.getCached();switch(this.velocityScaleMode){case"max":return e.maxVelocity||this.maxVelocity;case"average":return e.avgVelocity||this.maxVelocity;case"percentile90":return e.percentile90||e.avgVelocity||this.maxVelocity;case"percentile95":return e.percentile95||e.avgVelocity||this.maxVelocity;default:return this.maxVelocity}}fadeScreen(){let e=this.gl,t=this.framebufferManager.getCurrentTexture();this.framebufferManager.swap(),this.framebufferManager.bind(),e.viewport(0,0,this.renderWidth,this.renderHeight),e.disable(e.BLEND),e.useProgram(this.screenFadeProgram);let i=e.getAttribLocation(this.screenFadeProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),e.uniform1i(e.getUniformLocation(this.screenFadeProgram,"u_screen"),0),e.uniform1f(e.getUniformLocation(this.screenFadeProgram,"u_fade"),this.fadeOpacity),e.drawArrays(e.TRIANGLES,0,6),e.enable(e.BLEND)}downsampleToCanvas(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.canvas.width,this.canvas.height),e.useProgram(this.screenFadeProgram);let t=e.getAttribLocation(this.screenFadeProgram,"a_pos");e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.finalTexture),e.uniform1i(e.getUniformLocation(this.screenFadeProgram,"u_screen"),0),e.uniform1f(e.getUniformLocation(this.screenFadeProgram,"u_fade"),1),e.drawArrays(e.TRIANGLES,0,6)}render(e=!0){let t=this.gl;if(!this.hdrLogged){let l=this.framebufferManager.getHDRSupport();a.info("First frame render",{renderingMode:l.enabled?"HDR":"LDR",textureFormat:l.format,exposure:this.exposure,gamma:this.gamma}),this.hdrLogged=!0}this.updatePositions(),this.fadeScreen(),this.framebufferManager.bind(),this.useDepthTest&&(t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.clear(t.DEPTH_BUFFER_BIT)),this.drawParticles(),this.useDepthTest&&t.disable(t.DEPTH_TEST),t.bindFramebuffer(t.FRAMEBUFFER,this.ldrFramebuffer),t.viewport(0,0,this.renderWidth,this.renderHeight),t.disable(t.BLEND),t.useProgram(this.tonemapProgram);let i=t.getAttribLocation(this.tonemapProgram,"a_pos");t.bindBuffer(t.ARRAY_BUFFER,this.quadBuffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.framebufferManager.getCurrentTexture()),t.uniform1i(t.getUniformLocation(this.tonemapProgram,"u_screen"),0);let r=this.bufferStatsManager.getCached();t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_exposure"),this.exposure),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_gamma"),this.gamma),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_whitePoint"),this.whitePoint),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_highlight_compression"),this.highlightCompression),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_compression_threshold"),this.compressionThreshold),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_brightness_desat"),this.brightnessDesaturation),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_brightness_sat"),this.brightnessSaturation),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_hdr_max_brightness"),r.maxBrightness),t.uniform1f(t.getUniformLocation(this.tonemapProgram,"u_hdr_avg_brightness"),r.avgBrightness),t.drawArrays(t.TRIANGLES,0,6);let o=this.bilateralManager.apply(this.ldrTexture);this.smaaManager.applyToFramebuffer(o,this.finalFramebuffer,this.quadBuffer),e&&this.downsampleToCanvas(),this.frame||(this.frame=0),this.frame++;let s=this.isRunning?this.statsUpdateInterval:this.statsUpdateIntervalSlow;if(this.frame%s===0){let l=this.framebufferManager.getCurrentTexture(),c=this.bufferStatsManager.compute(l,this.renderWidth,this.renderHeight,!0);this.enableDebugStats&&this.frame%(s*10)===0&&a.info("HDR Buffer Stats (sampled)",{avgBrightness:c.avgBrightness.toFixed(2),maxBrightness:c.maxBrightness.toFixed(2),sampledPixels:c.sampledPixels,sampleRate:c.sampleRate})}}getBufferStats(){let e=this.bufferStatsManager.getCached(),t=this.velocityStatsManager?this.velocityStatsManager.getCached():null;return e.maxVelocity=this.maxVelocity,e.avgVelocity=t?t.avgVelocity:0,e.velocitySampleCount=t?t.sampleCount:0,e}logBufferStats(){let e=this.getBufferStats(),t=Date.now()-e.timestamp;a.info("=== HDR Buffer Statistics (Sampled) ==="),a.info(`Cached age: ${(t/1e3).toFixed(1)}s`),a.info(`Sample rate: every ${e.sampleRate}th pixel (${e.sampledPixels} total)`),a.info(`Red   - Min: ${e.red.min.toFixed(6)}, Max: ${e.red.max.toFixed(6)}, Avg: ${e.red.avg.toFixed(6)}`),a.info(`Green - Min: ${e.green.min.toFixed(6)}, Max: ${e.green.max.toFixed(6)}, Avg: ${e.green.avg.toFixed(6)}`),a.info(`Blue  - Min: ${e.blue.min.toFixed(6)}, Max: ${e.blue.max.toFixed(6)}, Avg: ${e.blue.avg.toFixed(6)}`),a.info(`Max Brightness: ${e.maxBrightness.toFixed(6)}`),a.info(`Avg Brightness: ${e.avgBrightness.toFixed(6)}`),a.info(`Max Velocity: ${e.maxVelocity.toFixed(6)} (GPU-sampled, ${e.velocitySampleCount} particles, EMA-smoothed)`),e.avgVelocity&&a.info(`Avg Velocity: ${e.avgVelocity.toFixed(6)}`)}calculateParticleStatistics_REMOVED(){let e=this.particleSystem.getResolution(),t=[];for(let c=0;c<this.dimensions;c++)t.push(this.textureManager.readTexture(c));let i=[],r=[],o=this.strategy.getComponentsPerValue(),s=this.strategy.getArrayType(),l=[];for(let c=0;c<this.particleSystem.getActualParticleCount();c++){let u=[];for(let d=0;d<this.dimensions;d++){let h=t[d],p=c*o,m=new s(o);for(let g=0;g<o;g++)m[g]=h[p+g];let f=d===0?this.bbox.min[0]:d===1?this.bbox.min[1]:-10,b=d===0?this.bbox.max[0]:d===1?this.bbox.max[1]:10,x=this.strategy.decodeValue(m,f,b);u.push(x)}l.push(u)}for(let c=0;c<this.dimensions;c++){let u=1/0,d=-1/0,h=0;for(let m of l)u=Math.min(u,m[c]),d=Math.max(d,m[c]),h+=m[c];let p=["x","y","z","w"][c]||`dim${c}`;i.push({dim:p,min:u.toFixed(3),max:d.toFixed(3),avg:(h/l.length).toFixed(3)})}if(this.velocityEvaluators)for(let c=0;c<this.dimensions;c++){let u=1/0,d=-1/0,h=0;try{for(let m of l){let f=this.velocityEvaluators[c](...m);u=Math.min(u,f),d=Math.max(d,f),h+=f}let p=["x","y","z","w"][c]||`dim${c}`;r.push({dim:`v${p}`,min:u.toFixed(3),max:d.toFixed(3),avg:(h/l.length).toFixed(3)})}catch(p){a.warn(`Error computing velocity for dim ${c}`,p)}}a.verbose(`Frame ${this.frame}: Particle statistics`,{bounds:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`,position:i,velocity:r.length>0?r:"N/A"})}sampleParticleVelocity(){let e=this.gl,t=[];for(let c=0;c<this.dimensions;c++)t.push(this.textureManager.readTexture(c));let i=this.strategy.getComponentsPerValue(),r=this.strategy.getArrayType(),s=Math.floor(Math.random()*this.particleSystem.getActualParticleCount())*i,l=[];for(let c=0;c<this.dimensions;c++){let u=t[c],d=new r(i);for(let f=0;f<i;f++)d[f]=u[s+f];let h=c===0?this.bbox.min[0]:c===1?this.bbox.min[1]:-10,p=c===0?this.bbox.max[0]:c===1?this.bbox.max[1]:10,m=this.strategy.decodeValue(d,h,p);l.push(m)}if(!this.velocityEvaluators||this.velocityEvaluators.length===0)return 0;try{let c=[];for(let h=0;h<this.dimensions;h++){let p=this.velocityEvaluators[h](...l);c.push(p)}let u=c.reduce((h,p)=>h+p*p,0),d=Math.sqrt(u);return isFinite(d)?d:(this.velocityNaNWarningLogged||(a.warn("Invalid velocity magnitude detected",{position:l,velocity:c,magnitude:d}),this.velocityNaNWarningLogged=!0),0)}catch(c){return this.velocityErrorLogged||(a.error("Error computing velocity",c),this.velocityErrorLogged=!0),0}}sampleParticleData(){let t=this.particleSystem.getResolution(),i=[],r=[];for(let l=0;l<this.dimensions;l++)r.push(this.textureManager.readTexture(l));let o=this.strategy.getComponentsPerValue(),s=this.strategy.getArrayType();for(let l=0;l<5;l++){let c=Math.floor(Math.random()*this.particleSystem.getActualParticleCount()),u=c*o,d=[];for(let m=0;m<this.dimensions;m++){let f=r[m],b=new s(o);for(let _=0;_<o;_++)b[_]=f[u+_];let x=m===0?this.bbox.min[0]:m===1?this.bbox.min[1]:-10,g=m===0?this.bbox.max[0]:m===1?this.bbox.max[1]:10,y=this.strategy.decodeValue(b,x,g);d.push(y.toFixed(3))}let h=r[0],p=o===4?h[u+3]:1;i.push({particle:c,position:d.join(", "),age:p.toFixed(2)})}a.verbose(`Frame ${this.frame}: Sampled 5 particles (with age)`,{bounds:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`,samples:i})}decodeFloatRGBA(e,t,i,r){return((e<<24|t<<16|i<<8|r)>>>0)/4294967295}start(){this.isRunning=!0,this.frameCount=0,this.totalFrames=0,this.lastFpsUpdate=performance.now(),this.fps=0,this.frameLimitEnabled===void 0&&(this.frameLimitEnabled=!1),this.frameLimit===void 0&&(this.frameLimit=1e3),a.verbose(`Starting render loop (frameLimitEnabled: ${this.frameLimitEnabled}, frameLimit: ${this.frameLimit})`);let e=()=>{if(!this.isRunning)return;this.frameCount++,this.totalFrames++;let t=performance.now(),i=t-this.lastFpsUpdate;if(i>=500&&(this.fps=Math.round(this.frameCount*1e3/i),this.frameCount=0,this.lastFpsUpdate=t),this.render(),this.frameLimitEnabled&&this.totalFrames>=this.frameLimit){let o=performance.now()-this.lastFpsUpdate;o>0&&(this.fps=Math.round(this.frameCount*1e3/o)),a.info(`Frame limit reached (${this.frameLimit} frames), stopping render loop`),this.stop();return}requestAnimationFrame(e)};e()}stop(){this.isRunning=!1}setAnimationAlpha(e){this.animationAlpha=Math.max(0,Math.min(1,e))}clearRenderBuffer(e=!1){this.framebufferManager.clearAll(0,0,0,1),this.totalFrames=0,!this.isRunning&&!e&&(a.info("Restarting render loop after render buffer clear"),this.start()),a.verbose("Render buffer cleared (particles preserved)")}resetParticles(e=!1){if(this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),a.verbose("Particles reinitialized to random positions"),e){a.info("Recompiling shaders after particle reset...");try{this.compileShaders(),a.info("Shaders recompiled successfully")}catch(t){a.error("Failed to recompile shaders:",t)}}}step(e=1){for(let t=0;t<e;t++)this.updatePositions()}clearScreen(){this.framebufferManager.clearAll(0,0,0,1),this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),this.totalFrames=0,this.isRunning||(a.info("Restarting render loop after screen clear"),this.start()),a.verbose("Screen cleared and particles reinitialized")}captureRenderBuffer(){return new Promise((e,t)=>{let i=this.gl;try{i.bindFramebuffer(i.FRAMEBUFFER,this.finalFramebuffer);let r=new Uint8Array(this.renderWidth*this.renderHeight*4);i.readPixels(0,0,this.renderWidth,this.renderHeight,i.RGBA,i.UNSIGNED_BYTE,r),i.bindFramebuffer(i.FRAMEBUFFER,null);let o=document.createElement("canvas");o.width=this.renderWidth,o.height=this.renderHeight;let s=o.getContext("2d"),l=s.createImageData(this.renderWidth,this.renderHeight);l.data.set(r),s.save(),s.scale(1,-1),s.translate(0,-this.renderHeight),s.putImageData(l,0,0),s.restore(),o.toBlob(c=>{c?e(c):t(new Error("Failed to create blob from canvas"))},"image/png")}catch(r){a.error("Failed to capture render buffer:",r),t(r)}})}resize(e,t){let i=this.gl;if(!e||!t||e<=0||t<=0){a.warn(`Invalid resize dimensions: ${e}x${t}, skipping resize`);return}this.canvas.width=e,this.canvas.height=t,this.renderWidth=Math.max(1,Math.floor(e*this.supersampleFactor)),this.renderHeight=Math.max(1,Math.floor(t*this.supersampleFactor)),a.info("Resizing renderer",{canvasSize:`${e}x${t}`,renderSize:`${this.renderWidth}x${this.renderHeight}`,supersampleFactor:this.supersampleFactor}),this.framebufferManager.resize(this.renderWidth,this.renderHeight),this.bilateralManager.resize(this.renderWidth,this.renderHeight),this.smaaManager.resize(this.renderWidth,this.renderHeight),i.bindTexture(i.TEXTURE_2D,this.ldrTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindTexture(i.TEXTURE_2D,null),i.bindTexture(i.TEXTURE_2D,this.finalTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.renderWidth,this.renderHeight,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindTexture(i.TEXTURE_2D,null),this.gl.viewport(0,0,e,t),this.clearScreen()}updateConfig(e){a.info("Updating configuration",e);let t=!1;if(e.dimensions!==void 0&&e.dimensions!==this.dimensions&&(a.info(`Changing dimensions: ${this.dimensions} \u2192 ${e.dimensions}`),this.dimensions=e.dimensions,t=!0,this.coordinateSystem=j(this.dimensions),a.info(`Updated coordinate system to ${this.dimensions}D Cartesian`),this.particleSystem.setDimensions(this.dimensions),this.textureManager.dispose(),this.textureManager=new De(this.gl,this.dimensions,this.particleSystem.getResolution(),this.strategy),this.particleRenderMode==="lines"&&this.textureManager.setLineMode(!0),this.textureManager.initializeData(this.particleSystem.getAllData())),e.coordinateSystem!==void 0&&(a.info(`Updating coordinate system: ${this.coordinateSystem.name} \u2192 ${e.coordinateSystem.name}`),this.coordinateSystem=e.coordinateSystem,t=!0,a.info("  needsRecompile flag set to true (coordinate system change)")),e.expressions!==void 0){a.info("Updating vector field expressions",e.expressions),this.expressions=e.expressions;try{let i;this.coordinateSystem&&typeof this.coordinateSystem.getVariableNames=="function"?i=this.coordinateSystem.getVariableNames():(a.warn("coordinateSystem missing getVariableNames(), using Cartesian fallback"),i=["x","y","z","w","u","v"].slice(0,this.dimensions)),this.velocityEvaluators=qt(this.expressions,i),a.verbose("Velocity evaluators created successfully",{coordinateSystem:this.coordinateSystem?this.coordinateSystem.name:"unknown",variables:i})}catch(i){a.warn("Failed to create velocity evaluators",i),this.velocityEvaluators=null}t=!0,a.info("  needsRecompile flag set to true (expressions change)")}if(e.velocityGLSL!==void 0&&(a.info("Updating pre-generated velocity GLSL",e.velocityGLSL),this.velocityGLSL=e.velocityGLSL,t=!0,a.info("  needsRecompile flag set to true (velocityGLSL change)")),e.integratorType!==void 0&&e.integratorType!==this.integratorType&&(a.info(`Changing integrator: ${this.integratorType} \u2192 ${e.integratorType}`),this.integratorType=e.integratorType,t=!0),e.integratorParams!==void 0&&(a.verbose("Updating integrator parameters",e.integratorParams),this.integratorParams={...this.integratorParams,...e.integratorParams},t=!0),e.solutionMethod!==void 0&&e.solutionMethod!==this.solutionMethod&&(a.info(`Changing solution method: ${this.solutionMethod} \u2192 ${e.solutionMethod}`),this.solutionMethod=e.solutionMethod,t=!0,a.info("  needsRecompile flag set to true (solutionMethod change)")),a.info("Solution method update complete, continuing..."),e.transformType!==void 0&&e.transformType!==this.transformType&&(a.info(`Changing transform: ${this.transformType} \u2192 ${e.transformType}`),this.transformType=e.transformType,t=!0),e.transformParams!==void 0&&(a.verbose("Updating transform parameters",e.transformParams),this.transformParams=e.transformParams,t=!0),e.mapperType!==void 0&&e.mapperType!==this.mapperType&&(a.info(`Changing mapper: ${this.mapperType} \u2192 ${e.mapperType}`),this.mapperType=e.mapperType,t=!0),e.mapperParams!==void 0&&(a.verbose("Updating mapper parameters",e.mapperParams),this.mapperParams=e.mapperParams,t=!0),e.colorMode!==void 0&&e.colorMode!==this.colorMode&&(a.info(`Changing color mode: ${this.colorMode} \u2192 ${e.colorMode}`),this.colorMode=e.colorMode,t=!0),e.colorExpression!==void 0&&e.colorExpression!==this.colorExpression&&(a.info(`Changing color expression: ${this.colorExpression} \u2192 ${e.colorExpression}`),this.colorExpression=e.colorExpression,t=!0),e.colorGradient!==void 0&&JSON.stringify(e.colorGradient)!==JSON.stringify(this.colorGradient)&&(a.info("Changing color gradient"),this.colorGradient=e.colorGradient,t=!0),e.velocityScaleMode!==void 0&&e.velocityScaleMode!==this.velocityScaleMode&&(a.info(`Changing velocity scale mode: ${this.velocityScaleMode} \u2192 ${e.velocityScaleMode}`),this.velocityScaleMode=e.velocityScaleMode),e.velocityLogScale!==void 0&&e.velocityLogScale!==this.velocityLogScale&&(a.info(`Changing velocity log scale: ${this.velocityLogScale} \u2192 ${e.velocityLogScale}`),this.velocityLogScale=e.velocityLogScale,t=!0),e.timestep!==void 0&&(a.verbose(`Timestep: ${this.timestep} \u2192 ${e.timestep}`),this.timestep=e.timestep),e.fadeOpacity!==void 0&&(a.verbose(`Fade opacity: ${this.fadeOpacity} \u2192 ${e.fadeOpacity}`),this.fadeOpacity=e.fadeOpacity),e.dropProbability!==void 0&&(a.verbose(`Drop probability: ${this.dropProbability} \u2192 ${e.dropProbability}`),this.dropProbability=e.dropProbability),e.respawnMargin!==void 0&&(a.verbose(`Respawn margin: ${this.respawnMargin} \u2192 ${e.respawnMargin}`),this.respawnMargin=e.respawnMargin),e.lockShaderRecompilation!==void 0&&(a.info(`Shader recompilation lock: ${this.lockShaderRecompilation} \u2192 ${e.lockShaderRecompilation}`),this.lockShaderRecompilation=e.lockShaderRecompilation),e.useHDR!==void 0&&e.useHDR!==this.useHDR){a.info(`Changing HDR rendering: ${this.useHDR} \u2192 ${e.useHDR}`),this.useHDR=e.useHDR,this.framebufferManager.dispose(),this.framebufferManager=new ke(this.gl,this.canvas.width,this.canvas.height,{useHDR:this.useHDR,usePingPong:!0});let i=this.framebufferManager.getHDRSupport();a.info("HDR rendering system reconfigured",{hdrEnabled:i.enabled,hdrSupported:i.supported,textureFormat:i.format}),this.useHDR&&!i.supported&&a.warn("HDR requested but not supported. Falling back to LDR."),this.clearScreen()}if(e.exposure!==void 0&&(a.verbose(`Exposure: ${this.exposure} \u2192 ${e.exposure}`),this.exposure=e.exposure,t=!0),e.gamma!==void 0&&(a.verbose(`Gamma: ${this.gamma} \u2192 ${e.gamma}`),this.gamma=e.gamma,t=!0),e.luminanceGamma!==void 0&&(a.verbose(`Luminance Gamma: ${this.luminanceGamma} \u2192 ${e.luminanceGamma}`),this.luminanceGamma=e.luminanceGamma,t=!0),e.highlightCompression!==void 0&&(a.verbose(`Highlight Compression: ${this.highlightCompression} \u2192 ${e.highlightCompression}`),this.highlightCompression=e.highlightCompression),e.compressionThreshold!==void 0&&(a.verbose(`Compression Threshold: ${this.compressionThreshold} \u2192 ${e.compressionThreshold}`),this.compressionThreshold=e.compressionThreshold),e.whitePoint!==void 0&&(a.verbose(`White point: ${this.whitePoint} \u2192 ${e.whitePoint}`),this.whitePoint=e.whitePoint,t=!0),e.tonemapOperator!==void 0&&e.tonemapOperator!==this.tonemapOperator&&(a.info(`Tone mapping operator: ${this.tonemapOperator} \u2192 ${e.tonemapOperator}`),this.tonemapOperator=e.tonemapOperator,t=!0),e.particleIntensity!==void 0&&(a.verbose(`Particle intensity: ${this.particleIntensity} \u2192 ${e.particleIntensity}`),this.particleIntensity=e.particleIntensity),e.particleSize!==void 0&&(a.verbose(`Particle size: ${this.particleSize} \u2192 ${e.particleSize}`),this.particleSize=e.particleSize),e.particleRenderMode!==void 0&&e.particleRenderMode!==this.particleRenderMode){a.info(`Particle render mode: ${this.particleRenderMode} \u2192 ${e.particleRenderMode}`),this.particleRenderMode=e.particleRenderMode;let i=this.particleRenderMode==="lines";this.textureManager.setLineMode(i),t=!0}if(e.colorSaturation!==void 0&&(a.verbose(`Color saturation: ${this.colorSaturation} \u2192 ${e.colorSaturation}`),this.colorSaturation=e.colorSaturation),e.brightnessDesaturation!==void 0&&(a.verbose(`Brightness desaturation: ${this.brightnessDesaturation} \u2192 ${e.brightnessDesaturation}`),this.brightnessDesaturation=e.brightnessDesaturation),e.brightnessSaturation!==void 0&&(a.verbose(`Brightness saturation: ${this.brightnessSaturation} \u2192 ${e.brightnessSaturation}`),this.brightnessSaturation=e.brightnessSaturation),e.useDepthTest!==void 0&&(a.verbose(`Depth testing: ${this.useDepthTest} \u2192 ${e.useDepthTest}`),this.useDepthTest=e.useDepthTest),e.smaaEnabled!==void 0&&(a.verbose(`SMAA enabled: ${this.smaaEnabled} \u2192 ${e.smaaEnabled}`),this.smaaEnabled=e.smaaEnabled,this.smaaManager.updateConfig({enabled:e.smaaEnabled})),e.smaaIntensity!==void 0&&(a.verbose(`SMAA intensity: ${this.smaaIntensity} \u2192 ${e.smaaIntensity}`),this.smaaIntensity=e.smaaIntensity,this.smaaManager.updateConfig({intensity:e.smaaIntensity})),e.smaaThreshold!==void 0&&(a.verbose(`SMAA threshold: ${this.smaaThreshold} \u2192 ${e.smaaThreshold}`),this.smaaThreshold=e.smaaThreshold,this.smaaManager.updateConfig({threshold:e.smaaThreshold})),e.bilateralEnabled!==void 0&&(a.verbose(`Bilateral filter enabled: ${this.bilateralEnabled} \u2192 ${e.bilateralEnabled}`),this.bilateralEnabled=e.bilateralEnabled,this.bilateralManager.updateConfig({enabled:e.bilateralEnabled})),e.bilateralSpatialSigma!==void 0&&(a.verbose(`Bilateral spatial sigma: ${this.bilateralSpatialSigma} \u2192 ${e.bilateralSpatialSigma}`),this.bilateralSpatialSigma=e.bilateralSpatialSigma,this.bilateralManager.updateConfig({spatialSigma:e.bilateralSpatialSigma})),e.bilateralIntensitySigma!==void 0&&(a.verbose(`Bilateral intensity sigma: ${this.bilateralIntensitySigma} \u2192 ${e.bilateralIntensitySigma}`),this.bilateralIntensitySigma=e.bilateralIntensitySigma,this.bilateralManager.updateConfig({intensitySigma:e.bilateralIntensitySigma})),e.supersampleFactor!==void 0&&e.supersampleFactor!==this.supersampleFactor){a.info(`Render scale factor: ${this.supersampleFactor} \u2192 ${e.supersampleFactor}`);let i=Math.max(.5,Math.min(4,e.supersampleFactor));i!==e.supersampleFactor&&a.warn(`Invalid render scale factor ${e.supersampleFactor}, clamping to ${i}`),this.supersampleFactor=i,a.info(`Applying render scale factor: ${this.supersampleFactor}`),this.resize(this.canvas.width,this.canvas.height)}if(e.particleCount!==void 0&&e.particleCount!==this.particleSystem.particleCount&&(this.particleSystem.setParticleCount(e.particleCount),this.textureManager.resize(this.particleSystem.getResolution()),this.textureManager.initializeData(this.particleSystem.getAllData()),this.gl.deleteBuffer(this.indexBufferPoints),this.gl.deleteBuffer(this.indexBufferLines),this.gl.deleteBuffer(this.vertexIdBufferLines),this.indexBufferPoints=this.createBuffer(this.particleSystem.getIndices()),this.indexBufferLines=this.createLineIndexBuffer(this.particleSystem.getActualParticleCount()),this.vertexIdBufferLines=this.createLineVertexIdBuffer(this.particleSystem.getActualParticleCount())),e.bbox!==void 0&&(this.bbox=e.bbox,this.particleSystem.setBBox(this.bbox),e.reinitializeParticles&&(this.particleSystem.initializeParticles(),this.textureManager.initializeData(this.particleSystem.getAllData()),a.info("Particles reinitialized to new viewport bounds")),this.clearScreen()),a.info(`Checking needsRecompile flag: ${t}`),t)if(this.lockShaderRecompilation)a.info("Shader recompilation needed but LOCKED - skipping recompilation");else{a.info("Recompiling shaders...");try{let i=this.compileShaders();if(i){a.error("Recompilation failed",i),a.warn("Shader compilation failed - visualization will not render until error is resolved");return}this.frame=0,a.info("Clearing screen after recompilation..."),this.clearScreen(),a.info("Configuration updated successfully, shaders recompiled")}catch(i){a.error("EXCEPTION during shader recompilation:",i),a.error("Stack trace:",i.stack),a.warn("Shader compilation exception - visualization will not render until error is resolved")}}else a.info("Configuration updated (no recompile needed)");a.info("Current settings applied",{dimensions:this.dimensions,expressions:this.expressions,integrator:this.integratorType,mapper:this.mapperType,timestep:this.timestep,particleCount:this.particleSystem.particleCount,fadeOpacity:this.fadeOpacity,dropProbability:this.dropProbability,bbox:`[${this.bbox.min[0].toFixed(3)}, ${this.bbox.min[1].toFixed(3)}] to [${this.bbox.max[0].toFixed(3)}, ${this.bbox.max[1].toFixed(3)}]`})}testEncodeDecodeSymmetry(){let{encodeFloatRGBA:e,decodeFloatRGBA:t}=(ui(),an(ur)),i=[0,.1,.25,.5,.75,.9,1];for(let d=0;d<100;d++)i.push(Math.random());let r=0,o=0,s=[],l=[];a.info("Testing encode/decode symmetry...");for(let d of i){let h=new Uint8Array(4);e(d,h,0);let p=t(h[0],h[1],h[2],h[3]),m=Math.abs(d-p);s.push(m),o+=m,r=Math.max(r,m),m>1e-6&&l.push({original:d,encoded:`[${h[0]}, ${h[1]}, ${h[2]}, ${h[3]}]`,decoded:p,error:m})}o/=i.length,a.info("Encode/Decode symmetry test results:",{testCount:i.length,maxError:r.toExponential(3),avgError:o.toExponential(3),problematicCount:l.length,problematicSamples:l.slice(0,5)}),a.info("Testing world coordinate round-trip [-5, 5]...");let c=[-5,-4,-2.5,0,2.5,4,5],u=[];for(let d of c){let h=(d-this.bbox.min[0])/(this.bbox.max[0]-this.bbox.min[0]),p=new Uint8Array(4);e(h,p,0);let m=t(p[0],p[1],p[2],p[3]),f=this.bbox.min[0]+m*(this.bbox.max[0]-this.bbox.min[0]),b=Math.abs(d-f);u.push({world:d.toFixed(3),normalized:h.toFixed(6),decoded:f.toFixed(6),error:b.toExponential(3)})}return a.info("World coordinate round-trip results:",{tests:u}),{maxError:r,avgError:o,problematic:l.length}}logBufferStats(){let e=this.gl;if(!this.framebufferManager){a.warn("No framebuffer manager available");return}let t=this.framebufferManager.currentIndex;e.bindFramebuffer(e.FRAMEBUFFER,this.framebufferManager.framebuffers[t]);let i=this.canvas.width,r=this.canvas.height,o=i*r,s=this.framebufferManager.isHDR(),l=s?new Float32Array(o*4):new Uint8Array(o*4);e.readPixels(0,0,i,r,e.RGBA,s?e.FLOAT:e.UNSIGNED_BYTE,l);let c=1/0,u=1/0,d=1/0,h=-1/0,p=-1/0,m=-1/0,f=0,b=0,x=0,g=-1/0,y=0;for(let E=0;E<o;E++){let L=E*4,k=l[L],A=l[L+1],B=l[L+2];s||(k/=255,A/=255,B/=255),c=Math.min(c,k),u=Math.min(u,A),d=Math.min(d,B),h=Math.max(h,k),p=Math.max(p,A),m=Math.max(m,B),f+=k,b+=A,x+=B;let z=Math.max(k,A,B);g=Math.max(g,z),z>1&&y++}let _=f/o,S=b/o,F=x/o;a.info("=== HDR Buffer Statistics ==="),a.info(`Framebuffer: ${i}x${r} (${o.toLocaleString()} pixels)`),a.info(`Format: ${s?"HDR Float":"LDR RGBA8"}`),a.info(`Red   - Min: ${c.toFixed(6)}, Max: ${h.toFixed(6)}, Avg: ${_.toFixed(6)}`),a.info(`Green - Min: ${u.toFixed(6)}, Max: ${p.toFixed(6)}, Avg: ${S.toFixed(6)}`),a.info(`Blue  - Min: ${d.toFixed(6)}, Max: ${m.toFixed(6)}, Avg: ${F.toFixed(6)}`),a.info(`Max Brightness (max of R/G/B): ${g.toFixed(6)}`),a.info(`Pixels above 1.0: ${y.toLocaleString()} (${(y/o*100).toFixed(2)}%)`),e.bindFramebuffer(e.FRAMEBUFFER,null)}logShaders(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== UPDATE VERTEX SHADER ==="),console.log(this.shaderSource.updateVertex),console.log(`=== END SHADER ===
`),console.log("=== UPDATE FRAGMENT SHADER ==="),console.log(this.shaderSource.updateFragment),console.log(`=== END SHADER ===
`),console.log("=== DRAW VERTEX SHADER ==="),console.log(this.shaderSource.drawVertex),console.log(`=== END SHADER ===
`),console.log("=== DRAW FRAGMENT SHADER ==="),console.log(this.shaderSource.drawFragment),console.log("=== END SHADER ==="),a.info("Shaders logged to console")}logUpdateShader(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== UPDATE FRAGMENT SHADER (Integrator + Jacobian) ==="),console.log(this.shaderSource.updateFragment),console.log("=== END SHADER ==="),a.info("Update shader logged to browser console")}logDrawShader(){if(!this.shaderSource){console.warn("No shader source available");return}console.log("=== DRAW VERTEX SHADER ==="),console.log(this.shaderSource.drawVertex),console.log("=== END VERTEX SHADER ==="),console.log(""),console.log("=== DRAW FRAGMENT SHADER (Color Mode) ==="),console.log(this.shaderSource.drawFragment),console.log("=== END FRAGMENT SHADER ==="),a.info("Draw shaders (vertex + fragment) logged to browser console")}logScreenShader(){if(!this.shaderSource||!this.shaderSource.screenFragment){console.warn("No screen shader source available");return}console.log("=== SCREEN FRAGMENT SHADER (Tone Mapping) ==="),console.log(this.shaderSource.screenFragment),console.log("=== END SHADER ==="),a.info("Screen shader logged to browser console")}logStatsShaders(){if(a.info("=== DIAGNOSTIC STATS SHADERS ==="),this.velocityStatsManager&&this.velocityStatsManager.getShaderSource){let e=this.velocityStatsManager.getShaderSource();e?(console.log("=== VELOCITY STATS FRAGMENT SHADER ==="),console.log(e),console.log("=== END SHADER ===")):console.warn("Velocity stats shader not available")}else console.warn("VelocityStatsManager not initialized or no getShaderSource method");if(this.bufferStatsManager&&this.bufferStatsManager.getShaderSource){let e=this.bufferStatsManager.getShaderSource();e?(console.log("=== BRIGHTNESS STATS FRAGMENT SHADER ==="),console.log(e),console.log("=== END SHADER ===")):console.warn("Buffer stats shader not available")}else console.warn("BufferStatsManager not initialized or no getShaderSource method");a.info("Stats shaders logged to browser console")}readPixelAt(e,t){let i=this.gl,r=Math.floor(e*(this.renderWidth/this.canvas.width)),o=Math.floor(t*(this.renderHeight/this.canvas.height)),s=this.renderHeight-o-1;if(r<0||r>=this.renderWidth||s<0||s>=this.renderHeight)return null;let l={hdr:null,ldr:null};if(this.useHDR&&this.framebufferManager){let c=this.framebufferManager.getCurrentTexture(),u=this.framebufferManager.framebuffers[this.framebufferManager.currentIndex];if(i.bindFramebuffer(i.FRAMEBUFFER,u),this.framebufferManager.hdrType===i.FLOAT){let d=new Float32Array(4);i.readPixels(r,s,1,1,i.RGBA,i.FLOAT,d),l.hdr=[d[0],d[1],d[2]]}else{let d=new Uint8Array(4);i.readPixels(r,s,1,1,i.RGBA,i.UNSIGNED_BYTE,d),l.hdr=[d[0]/255,d[1]/255,d[2]/255]}}if(this.ldrFramebuffer&&this.ldrTexture){i.bindFramebuffer(i.FRAMEBUFFER,this.ldrFramebuffer);let c=new Uint8Array(4);i.readPixels(r,s,1,1,i.RGBA,i.UNSIGNED_BYTE,c),l.ldr=[c[0]/255,c[1]/255,c[2]/255]}return i.bindFramebuffer(i.FRAMEBUFFER,null),l}};ae();var ie=class{constructor(e,t,i={}){this.id=e,this.defaultValue=t,this.settingsKey=i.settingsKey||e,this.onChange=i.onChange||null,this.element=null}getValue(){throw new Error("getValue() must be implemented by subclass")}setValue(e){throw new Error("setValue() must be implemented by subclass")}reset(){this.setValue(this.defaultValue)}attachListeners(e){throw new Error("attachListeners() must be implemented by subclass")}getMousePositionInElement(e,t){let r=$(t).offset();return{x:e.pageX-r.left,y:e.pageY-r.top}}handleButtonAction(e){return!1}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};var gt=class extends ie{constructor(e,t,i={}){super(e,t,i),this.trim=i.trim!==void 0?i.trim:!0}getValue(){let t=$(`#${this.id}`).val();return this.trim&&(t=t.trim()),t}setValue(e){$(`#${this.id}`).val(e)}attachListeners(e){let t=$(`#${this.id}`);this.element=t,this.setValue(this.defaultValue),t.on("input",()=>{let i=this.getValue();this.onChange&&this.onChange(i),e&&e()})}};var bt=class{constructor(e={}){this.controls=new Map,this.storageKey=e.storageKey||"settings",this.onApply=e.onApply||null,this.debounceTime=e.debounceTime||300,this.applyTimeout=null,this.renderer=e.renderer||null}register(e){return this.controls.set(e.id,e),e}registerAll(e){e.forEach(t=>this.register(t))}initializeControls(){let e=()=>this.debouncedApply();for(let t of this.controls.values())t.attachListeners(e)}attachAllListeners(){this.initializeControls()}applySettings(e){this.setSettings(e)}get(e){return this.controls.get(e)}getSettings(){let e={};for(let t of this.controls.values())t.saveToSettings(e);return e}setSettings(e){if(e.coordinateSystem&&e.dimensions)try{let t=e.coordinateSystem,i=O.fromJSON(t);if(i.dimensions===e.dimensions){this.renderer&&(this.renderer.coordinateSystem=i);let r=this.get("dimension-inputs");r&&r.setCoordinateSystem&&r.setCoordinateSystem(i,!1)}}catch(t){console.error("Failed to restore coordinate system from settings:",t)}for(let t of this.controls.values())t.restoreFromSettings(e);for(let t of this.controls.values())t.onChange&&e&&e[t.settingsKey]!==void 0&&t.onChange(t.getValue())}resetAll(){for(let e of this.controls.values())e.reset()}saveToStorage(){let e=this.getSettings();return localStorage.setItem(this.storageKey,JSON.stringify(e)),e}loadFromStorage(){try{let e=localStorage.getItem(this.storageKey);if(e){let t=JSON.parse(e);return this.setSettings(t),t}}catch(e){console.warn("Failed to load settings from localStorage:",e)}return null}clearStorage(){localStorage.removeItem(this.storageKey)}debouncedApply(){this.applyTimeout&&clearTimeout(this.applyTimeout),this.applyTimeout=setTimeout(()=>{if(this.onApply){let e=this.getSettings();this.onApply(e)}},this.debounceTime)}apply(){if(this.onApply){let e=this.getSettings();this.onApply(e)}}};function Vn(n=2,e=10){return t=>{let i=Math.abs(t);return i>=e||i<1/e&&i!==0?t.toExponential(n):t.toFixed(n+1)}}function zn(n=2){return e=>e.toFixed(n)}function Nn(){return n=>n.toFixed(0)}function dr(n,e,t){return n>0&&e/n>1e3?"adaptive":"linear"}function hr(n,e,t=!1){let i=Math.abs(n),r=i<e?e:Math.pow(10,Math.floor(Math.log10(i))-1);return r=Math.max(e,r),t&&(r*=10),r}function mr(n=!1){return n?10:1}function pr(n,e=!1){return e?n*10:n}function fr(n){if(typeof n.displayFormat=="function")return n.displayFormat;let e=n.displayPrecision??2;switch(n.displayFormat){case"scientific":return Vn(e,n.scientificThreshold??10);case"integer":return Nn();case"decimal":default:return zn(e)}}function me(n,e=0){setTimeout(()=>{let t;if(typeof n=="string"?t=$(n):t=n,!t.length){console.warn("resizeAccordion: Element not found",n);return}let i=t.closest(".accordion-section");i.length&&!i.hasClass("collapsed")&&i.css("max-height",i[0].scrollHeight+"px")},e)}var di=class extends ie{constructor(e,t,i,r={}){super(e,i,r),this.parameterDef=t,this.scale=t.scale||dr(t.min,t.max,t.step),this.formatter=fr(t),this.displayElement=null}calculateIncrement(e,t=!1){switch(this.scale){case"adaptive":return hr(e,this.parameterDef.step,t);case"log":return mr(t);case"linear":default:return pr(this.parameterDef.step,t)}}handleButtonAction(e){let t=$(`#${this.id}`);if(!t.length)return!1;let i=this.getValue(),r=this.parameterDef.min,o=this.parameterDef.max,s=i;if(e==="reset")s=this.defaultValue;else{let l=this.calculateIncrement(i,e.includes("large"));if(e.startsWith("increase"))s=Math.min(o,i+l);else if(e.startsWith("decrease"))s=Math.max(r,i-l);else return!1}return s!==i?(this.setValue(s),t.trigger("input"),!0):!1}render(){let e=`${this.id}-display`,t=this.defaultValue;return`
            <div class="control-group">
                <label>
                    ${this.parameterDef.label}:
                    <span class="range-value" id="${e}">
                        ${this.formatter(t)}
                    </span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease-large">--</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease">-</button>
                    <input type="range" id="${this.id}">
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase-large">++</button>
                </div>
                ${this.parameterDef.info?`<div class="info">${this.parameterDef.info}</div>`:""}
            </div>
        `}attachListeners(e){let t=$(`#${this.id}`);if(this.element=t,this.displayElement=$(`#${this.id}-display`),!t.length){console.error(`ParameterControl: Element #${this.id} not found in DOM`);return}t.attr("min",this.parameterDef.min),t.attr("max",this.parameterDef.max),t.attr("step",this.parameterDef.step),t.val(this.defaultValue),this.updateDisplay(this.defaultValue),t.on("input",()=>{let i=this.getValue();this.updateDisplay(i),this.onChange&&this.onChange(i),e&&e()})}updateDisplay(e){this.displayElement&&this.displayElement.length&&this.displayElement.text(this.formatter(e))}getValue(){return!this.element||!this.element.length?this.defaultValue:parseFloat(this.element.val())}setValue(e){this.element&&this.element.length&&(this.element.val(e),this.updateDisplay(e))}reset(){this.setValue(this.defaultValue)}},_e=class extends di{constructor(e,t,i,r={}){super(e,t,i,r),this.animationEnabled=!1;let o=t.max-t.min;this.animationMin=r.animationMin??t.min+o*.25,this.animationMax=r.animationMax??t.min+o*.75,this.currentAlpha=0,this.isAnimating=!1}setAnimationEnabled(e){this.animationEnabled=e,this.updateAnimationUI()}setAnimationBounds(e,t){this.animationMin=Math.min(e,t),this.animationMax=Math.max(e,t),this.updateBoundsDisplay()}updateFromAlpha(e){if(!this.animationEnabled)return;this.currentAlpha=e;let t=this.animationMin+e*(this.animationMax-this.animationMin);this.isAnimating=!0,this.setValue(t),this.updateCurrentIndicator(e),this.isAnimating=!1}updateCurrentIndicator(e){let t=$(`#${this.id}-current-indicator`);t.length&&t.css("left",`${e*100}%`)}updateBoundsDisplay(){let e=$(`#${this.id}-min-handle`),t=$(`#${this.id}-max-handle`),i=$(`#${this.id}-min-display`),r=$(`#${this.id}-max-display`),o=$(`#${this.id}-range`);if(e.length&&t.length){let s=this.parameterDef.min,l=this.parameterDef.max,c=(this.animationMin-s)/(l-s)*100,u=(this.animationMax-s)/(l-s)*100;e.css("left",`${c}%`),t.css("left",`${u}%`),o.css({left:`${c}%`,width:`${u-c}%`}),i.length&&i.text(this.formatter(this.animationMin)),r.length&&r.text(this.formatter(this.animationMax))}}updateAnimationUI(){let e=$(`#${this.id}-animation-bounds`),t=$(`#${this.id}-anim-btn`);this.animationEnabled?(e.slideDown(200),t.addClass("active"),t.attr("title","Disable animation (\u{1F3AC})"),this.updateBoundsDisplay(),setTimeout(()=>{this.updateAccordionHeight()},0),setTimeout(()=>{this.updateAccordionHeight()},250)):(e.slideUp(200),t.removeClass("active"),t.attr("title","Enable animation (\u{1F3AC})"),setTimeout(()=>{this.updateAccordionHeight()},250))}updateAccordionHeight(){me("#transform-controls",0)}render(){let e=`${this.id}-display`,t=this.defaultValue;return`
            <div class="control-group">
                <label>
                    ${this.parameterDef.label}:
                    <span class="range-value" id="${e}">
                        ${this.formatter(t)}
                    </span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease-large">--</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="decrease">-</button>
                    <input type="range" id="${this.id}">
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="${this.id}" data-action="increase-large">++</button>
                    <button class="slider-btn anim-btn" id="${this.id}-anim-btn" title="Enable animation (\u{1F3AC})">\u{1F3AC}</button>
                </div>
                ${this.parameterDef.info?`<div class="info">${this.parameterDef.info}</div>`:""}
            </div>
        `}attachListeners(e){super.attachListeners(e),setTimeout(()=>{let t=$(`#${this.id}`);if(!t.length)return;let i=$(`#${this.id}-anim-btn`);if(!i.length)return;i.on("click",s=>{s.stopPropagation(),this.setAnimationEnabled(!this.animationEnabled)});let r=`
                <div id="${this.id}-animation-bounds" class="animation-bounds-slider" style="display: none;">
                    <div class="bounds-labels">
                        <span>Min: <span id="${this.id}-min-display">${this.formatter(this.animationMin)}</span></span>
                        <span>Max: <span id="${this.id}-max-display">${this.formatter(this.animationMax)}</span></span>
                    </div>
                    <div class="multi-thumb-slider">
                        <div class="slider-track"></div>
                        <div id="${this.id}-range" class="slider-range"></div>
                        <div id="${this.id}-current-indicator" class="slider-current-indicator"></div>
                        <div id="${this.id}-min-handle" class="slider-thumb min-thumb" data-bound="min">
                            <span class="thumb-label">MIN</span>
                        </div>
                        <div id="${this.id}-max-handle" class="slider-thumb max-thumb" data-bound="max">
                            <span class="thumb-label">MAX</span>
                        </div>
                    </div>
                </div>
            `,o=t.closest(".control-group");o.length?(o.after(r),this.attachThumbDragHandlers()):console.warn(`AnimatableParameterControl: Could not find .control-group parent for #${this.id}`)},0)}attachThumbDragHandlers(){let e=$(`#${this.id}-min-handle`),t=$(`#${this.id}-max-handle`),i=e.parent();[{handle:e,bound:"min"},{handle:t,bound:"max"}].forEach(({handle:o,bound:s})=>{let l=!1,c=0,u=0;o.on("mousedown",d=>{l=!0,c=d.pageX,u=parseFloat(o.css("left"))||0,o.addClass("dragging"),e.css("z-index","10"),t.css("z-index","10"),o.css("z-index","11"),$("body").css("user-select","none"),d.preventDefault()}),$(document).on("mousemove",d=>{if(!l)return;let h=i.offset(),p=i.width(),f=(d.pageX-h.left)/p*100;f=Math.max(0,Math.min(100,f));let b=this.parameterDef.min,x=this.parameterDef.max,g=b+f/100*(x-b);s==="min"?g<=this.animationMax&&(this.animationMin=g):g>=this.animationMin&&(this.animationMax=g),this.updateBoundsDisplay()}),$(document).on("mouseup",()=>{l&&(l=!1,o.removeClass("dragging"),$("body").css("user-select",""))})})}saveToSettings(e){super.saveToSettings(e),this.animationEnabled&&(e.animations||(e.animations={}),e.animations[this.settingsKey]={enabled:!0,min:this.animationMin,max:this.animationMax})}restoreFromSettings(e){if(super.restoreFromSettings(e),e.animations&&e.animations[this.settingsKey]){let t=e.animations[this.settingsKey];this.animationEnabled=t.enabled||!1,this.animationMin=t.min,this.animationMax=t.max,this.updateAnimationUI()}}};M();var xt=class extends ie{constructor(e,t={}){super("dimension-inputs",e,t),this.dimensionsControl=null,this.varNames=["x","y","z","w","u","v"],this.coordinateSystem=null}setDimensionsControl(e){this.dimensionsControl=e}setCoordinateSystem(e,t=!0){this.coordinateSystem=e,e&&e.getDisplayLabels?this.varNames=e.getDisplayLabels():this.varNames=["x","y","z","w","u","v"],t&&this.updateInputs()}getDimensions(){if(this.dimensionsControl)return this.dimensionsControl.getValue();let e=document.getElementById("dimensions");return e&&e.getValue?e.getValue():2}getValue(){let e=this.getDimensions(),t=[];for(let i=0;i<e;i++){let r=$(`#expr-${i}`).val(),o=r?r.trim():"0";o&&window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii&&(o=window.UnicodeAutocomplete.unicodeToAscii(o)),t.push(o||"0")}return t}setValue(e){Array.isArray(e)&&this.updateInputs(e.length,e)}updateInputs(e=null,t=null){e===null&&(e=this.getDimensions()),a.verbose("updateInputs called with dimensions:",e);let i=$("#dimension-inputs");if(a.verbose("Container found:",i.length),i.length===0){a.error("Could not find #dimension-inputs element");return}let r;if(t&&Array.isArray(t))r=t,a.verbose("Using provided newValues");else{let o=$("#expr-0");a.verbose("firstElement exists:",o.length>0);try{if(o.length>0){let s=[],l=0;for(;$(`#expr-${l}`).length>0;){let c=$(`#expr-${l}`).val();s.push(c?c.trim():"0"),l++}r=s,a.verbose("Got current values from existing inputs:",r)}else r=this.defaultValue,a.verbose("Using defaultValue")}catch(s){a.error("Error getting values:",s),r=this.defaultValue}}if(r.length<e){let o=[...r];for(let s=r.length;s<e;s++)o[s]="0";r=o,a.verbose("Padded values to match dimensions:",r)}a.verbose("Values to use:",r),i.empty(),a.verbose("Container emptied, now creating",e,"inputs");for(let o=0;o<e;o++){let s=["x","y","z","w","u","v"],l=this.varNames[o]||s[o]||`v${o}`,c=r[o]||"0",u=$('<div class="dimension-input"></div>');u.append(`<label>d${l}/dt =</label>`),u.append(`<input type="text" id="expr-${o}" value="${c}">`),i.append(u),a.verbose("Created input",o,"with value:",c)}a.verbose("All inputs created, container now has",i.children().length,"children"),this.attachInputListeners(),window.unicodeAutocomplete&&window.unicodeAutocomplete.attachToAll('[id^="expr-"]'),this.updateAccordionHeight()}updateAccordionHeight(){me("#dimension-inputs",0)}attachInputListeners(){let e=this.onChangeCallback;$(document).off("input",'[id^="expr-"]'),$(document).on("input",'[id^="expr-"]',()=>{this.onChange&&this.onChange(this.getValue()),e&&e()})}attachListeners(e){this.onChangeCallback=e,this.updateInputs(),this.attachInputListeners()}reset(){this.setValue(this.defaultValue)}},yt=class extends ie{constructor(e,t={}){super("mapper-params",e,t),this.dimensionsControl=null,this.mapperControl=null,this.varNames=["x","y","z","w","u","v"]}setRelatedControls(e,t){this.dimensionsControl=e,this.mapperControl=t}getContext(){let e=this.dimensionsControl?this.dimensionsControl.getValue():2,t=this.mapperControl?this.mapperControl.getValue():"select";return{dimensions:e,mapper:t}}getValue(){let{mapper:e}=this.getContext();if(e==="custom"){let r=$("#mapper-horizontal-expr"),o=$("#mapper-vertical-expr"),s=$("#mapper-depth-expr");return r.length&&o.length?{horizontalExpr:r.val()||"x",verticalExpr:o.val()||"y",depthExpr:s.val()||""}:this.currentParams||{horizontalExpr:"x",verticalExpr:"y",depthExpr:""}}let t=$("#mapper-dim1"),i=$("#mapper-dim2");if(t.length&&i.length){let r=parseInt(t.val()),o=parseInt(i.val());return isNaN(r)||isNaN(o)?(console.warn("Invalid mapper dimensions, using defaults"),this.defaultValue):{dim1:r,dim2:o}}return this.defaultValue}setValue(e){this.currentParams=e,this.updateControls()}updateControls(){let{dimensions:e,mapper:t}=this.getContext(),i=$("#mapper-controls");if(i.length!==0){if(i.empty(),t==="select"){let r=$('<div class="control-row"></div>'),o=$('<div class="control-group" style="flex: 1;"></div>');o.append("<label>Horizontal</label>");let s=$('<select id="mapper-dim1"></select>'),l=this.currentParams?this.currentParams.dim1:this.defaultValue.dim1;for(let h=0;h<e;h++){let p=h===l?"selected":"";s.append(`<option value="${h}" ${p}>${this.varNames[h]}</option>`)}o.append(s);let c=$('<div class="control-group" style="flex: 1;"></div>');c.append("<label>Vertical</label>");let u=$('<select id="mapper-dim2"></select>'),d=this.currentParams?this.currentParams.dim2:this.defaultValue.dim2;for(let h=0;h<e;h++){let p=h===d?"selected":"";u.append(`<option value="${h}" ${p}>${this.varNames[h]}</option>`)}c.append(u),r.append(o),r.append(c),i.append(r),this.attachSelectListeners()}else if(t==="project"){let r=$('<div class="info">Linear projection uses default 2D projection</div>');i.append(r)}else if(t==="custom"){let r=this.varNames.slice(0,e).join(", "),o=$('<div class="control-group"></div>');o.append("<label>Horizontal (X):</label>");let s=this.currentParams?.horizontalExpr||"x",l=$(`<input type="text" id="mapper-horizontal-expr" value="${s}" placeholder="e.g., sin(x) + sin(y)" style="font-family: monospace; width: 100%;" />`);o.append(l),i.append(o);let c=$('<div class="control-group"></div>');c.append("<label>Vertical (Y):</label>");let u=this.currentParams?.verticalExpr||"y",d=$(`<input type="text" id="mapper-vertical-expr" value="${u}" placeholder="e.g., -cos(x) - cos(y)" style="font-family: monospace; width: 100%;" />`);c.append(d),i.append(c);let h=$('<div class="control-group"></div>');h.append("<label>Depth (Z, optional):</label>");let p=this.currentParams?.depthExpr||"",m=$(`<input type="text" id="mapper-depth-expr" value="${p}" placeholder="optional, e.g., z" style="font-family: monospace; width: 100%;" />`);h.append(m),i.append(h);let f=$('<div class="info">Define math expressions using variables: '+r+". Functions: sin, cos, tan, exp, log, sqrt, abs, etc.</div>");i.append(f),this.attachCustomListener()}}}attachSelectListeners(){let e=this.onChangeCallback;$(document).off("change","#mapper-dim1, #mapper-dim2"),$("#mapper-dim1, #mapper-dim2").on("change",()=>{this.currentParams=this.getValue(),this.onChange&&this.onChange(this.currentParams),e&&e()})}attachCustomListener(){let e=this.onChangeCallback;$(document).off("input","#mapper-horizontal-expr, #mapper-vertical-expr, #mapper-depth-expr"),$("#mapper-horizontal-expr, #mapper-vertical-expr, #mapper-depth-expr").on("input",()=>{this.currentParams=this.getValue(),this.onChange&&this.onChange(this.currentParams),e&&e()})}attachListeners(e){this.onChangeCallback=e,this.currentParams=this.defaultValue,this.updateControls()}reset(){this.currentParams=this.defaultValue,this.updateControls()}},vt=class extends ie{constructor(e,t={}){super("color-gradient",e,t),this.gradientEditor=null}setGradientEditor(e){this.gradientEditor=e}getValue(){return this.gradientEditor&&this.gradientEditor.getGradient?this.gradientEditor.getGradient():this.currentGradient||this.defaultValue}setValue(e){this.currentGradient=e,this.gradientEditor&&this.gradientEditor.setGradient&&this.gradientEditor.setGradient(e)}attachListeners(e){this.onChangeCallback=e}notifyChange(e){this.currentGradient=e,this.onChange&&this.onChange(e),this.onChangeCallback&&this.onChangeCallback()}reset(){this.setValue(this.defaultValue)}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!==void 0&&this.setValue(e[this.settingsKey])}},wt=class extends ie{constructor(e,t={}){super("transform-params",e,t),this.transformControl=null,this.currentParams=e||{},this.parameterControls=new Map}setTransformControl(e){this.transformControl=e}getTransformType(){return this.transformControl?this.transformControl.getValue():"identity"}getValue(){let e={};for(let[t,i]of this.parameterControls.entries()){let r=i.settingsKey;e[r]=i.getValue()}return e}setValue(e){this.currentParams=e||{},this.updateControls()}updateControls(){let e=this.getTransformType(),t=$("#transform-controls");if(t.length===0)return;t.empty(),this.parameterControls.clear();let i=mt(e);if(!i){a.warn(`Transform not found: ${e}`),this.updateAccordionHeight();return}let r=i.getParameters();if(r.length===0){this.updateAccordionHeight();return}r.forEach((o,s)=>{let l=`transform-param-${s}`,c=this.currentParams[o.name]??o.default,u=new _e(l,o,c,{settingsKey:o.name,onChange:d=>{this.currentParams[o.name]=d,this.onChange&&this.onChange(this.currentParams)}});t.append(u.render()),u.attachListeners(this.onChangeCallback),this.parameterControls.set(l,u)}),this.updateAccordionHeight()}updateAccordionHeight(){me("#transform-controls",0)}handleTransformParamButton(e,t){let i=this.parameterControls.get(e);return i?i.handleButtonAction(t):!1}attachListeners(e){this.onChangeCallback=e,this.updateControls()}reset(){this.currentParams=this.defaultValue,this.updateControls()}saveToSettings(e){e[this.settingsKey]=this.getValue()}restoreFromSettings(e){e&&e[this.settingsKey]!==void 0&&this.setValue(e[this.settingsKey])}};function gr(n,e,t){let i=$(`#${n}`);if(!i.length)return console.error(`Gradient editor container #${n} not found`),null;let r=e.map(u=>({...u}));function o(){let u=[...r].sort((h,p)=>h.position-p.position),d='<div class="gradient-stops">';u.forEach((h,p)=>{let m=r.indexOf(h),f=si(h.color);d+=`
                <div class="gradient-stop" data-index="${m}">
                    <input type="color" class="color-picker" value="${f}" data-index="${m}">
                    <input type="number" class="stop-position" min="0" max="1" step="0.01" value="${h.position.toFixed(2)}" data-index="${m}">
                    ${r.length>2?`<button class="remove-stop" data-index="${m}">\xD7</button>`:""}
                </div>
            `}),d+="</div>",d+='<button id="add-stop" class="secondary" style="margin-top: 5px;">Add Color Stop</button>',d+='<div class="gradient-preview" id="gradient-preview"></div>',i.html(d),s(),l()}function s(){let u=$("#gradient-preview");if(!u.length)return;let h=[...r].sort((p,m)=>p.position-m.position).map(p=>`${si(p.color)} ${(p.position*100).toFixed(1)}%`).join(", ");u.css("background",`linear-gradient(to right, ${h})`)}function l(){$(".color-picker").off("change").on("change",function(){let u=parseInt($(this).data("index")),d=$(this).val();r[u].color=ir(d),s(),t(r)}),$(".stop-position").off("change").on("change",function(){let u=parseInt($(this).data("index")),d=parseFloat($(this).val());d=Math.max(0,Math.min(1,d)),r[u].position=d,o(),t(r)}),$(".remove-stop").off("click").on("click",function(){let u=parseInt($(this).data("index"));r.length>2&&(r.splice(u,1),o(),t(r))}),$("#add-stop").off("click").on("click",function(){let u=[...r].sort((f,b)=>f.position-b.position),d=.5,h=0,p=.5;for(let f=0;f<u.length-1;f++){let b=u[f+1].position-u[f].position;b>h&&(h=b,p=(u[f].position+u[f+1].position)/2)}d=p;let m=c(r,d);r.push({position:d,color:m}),o(),t(r)})}function c(u,d){let h=[...u].sort((p,m)=>p.position-m.position);if(d<=h[0].position)return[...h[0].color];if(d>=h[h.length-1].position)return[...h[h.length-1].color];for(let p=0;p<h.length-1;p++)if(d>=h[p].position&&d<=h[p+1].position){let m=h[p].position,f=h[p+1].position,b=(d-m)/(f-m),x=h[p].color,g=h[p+1].color;return[x[0]+(g[0]-x[0])*b,x[1]+(g[1]-x[1])*b,x[2]+(g[2]-x[2])*b]}return[.5,.5,.5]}return o(),{getGradient:()=>r.map(u=>({...u})),setGradient:u=>{r=u.map(d=>({...d})),o()}}}ae();M();var je=null;function br(n){je=n,a.info("Inverse Solver: Notebook set (CAS engine:",je.casEngine.getName()+")")}function xr(n,e,t,i){if(a.info("=== SYMBOLIC INVERSE SOLVING ==="),a.info("Forward transforms:",n),a.info("Cartesian vars:",t),a.info("Native vars:",i),!je)return a.error("Notebook not set - cannot solve inverse symbolically"),null;if(!je.casEngine.isReady())return a.error("CAS engine not ready - cannot solve inverse symbolically"),null;try{let r=[];if(e===2&&Un(n))return a.info("Detected 2D polar coordinates - using standard inverse"),[`${i[0]}*cos(${i[1]})`,`${i[0]}*sin(${i[1]})`];if(e===3&&On(n))return a.info("Detected 3D cylindrical coordinates - using standard inverse"),[`${i[0]}*cos(${i[1]})`,`${i[0]}*sin(${i[1]})`,i[2]];if(e===3&&Gn(n))return a.info("Detected 3D spherical coordinates - using standard inverse"),[`${i[0]}*sin(${i[1]})*cos(${i[2]})`,`${i[0]}*sin(${i[1]})*sin(${i[2]})`,`${i[0]}*cos(${i[1]})`];a.info("Attempting general symbolic solve...");for(let o=0;o<e;o++){let s=t[o],l=null;for(let c=0;c<e;c++){let u=i[c],d=n[c];try{let h=`${u} - (${d})`,p=je.solve(h,s);if(p){let m=typeof p=="string"?p:p.toString();if(a.verbose(`Solved ${s} from equation ${c}:`,m),!t.some((b,x)=>x!==o&&m.includes(b))){l=m;break}}}catch(h){a.verbose(`Failed to solve ${s} from equation ${c}:`,h.message)}}if(!l)return a.warn(`Could not solve for ${s} - symbolic solving failed`),null;r.push(l)}return a.info("Successfully solved inverse transforms:",r),r}catch(r){return a.error("Symbolic inverse solving failed:",r.message),null}}function Un(n){if(n.length!==2)return!1;let e=n[0],t=n[1],i=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2/.test(e),r=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(t);return i&&r}function On(n){if(n.length!==3)return!1;let e=n[0],t=n[1],i=n[2],r=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2/.test(e),o=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(t),s=i.trim()==="z";return r&&o&&s}function Gn(n){if(n.length!==3)return!1;let e=n[0],t=n[1],i=n[2],r=/sqrt\s*\(\s*x\s*\^?\*?\*?\s*2\s*\+\s*y\s*\^?\*?\*?\s*2\s*\+\s*z\s*\^?\*?\*?\s*2/.test(e),o=/acos/.test(t),s=/atan2\s*\(\s*y\s*,\s*x\s*\)/.test(i);return r&&o&&s}function Hn(n,e,t,i){let r=$(`#${n}`);if(!r.length)return console.error(`Coordinate editor container #${n} not found`),null;let o=t||j(e),s=e,l={render:c,update:h,getCurrentSystem:()=>o,setDimensions:p};function c(){let m=ai(s),f='<div class="coordinate-editor-content">';f+='<div class="control-group">',f+='<label for="coord-preset">Preset</label>',f+='<select id="coord-preset">';let b="custom";for(let[g,y]of Object.entries(he))if(y.name===o.name&&y.dimensions===o.dimensions){b=g;break}f+='<option value="custom">Custom</option>',m.forEach(({key:g,system:y})=>{f+=`<option value="${g}" ${g===b?"selected":""}>${y.name}</option>`}),f+="</select>",f+="</div>",f+='<div class="coordinate-variables">',f+='<div style="font-weight: bold;">Coordinate Variables:</div>';for(let g=0;g<s;g++){let y=o.variables[g]||{label:"x",displayLabel:"x"},_=o.forwardTransforms[g]||"x",S=["x","y","z","w","u","v"][g];f+='<div class="coord-var-row">',f+=`<input type="text" class="coord-var-label" data-index="${g}" value="${y.displayLabel}" placeholder="${S}" title="Variable label (can use Greek letters like \u03B8)">`,f+="<span>=</span>",f+=`<input type="text" class="coord-var-transform coord-math-input" data-index="${g}" value="${_}" placeholder="${S}" title="Transformation expression in Cartesian coordinates">`,f+="</div>"}f+="</div>",f+='<div class="coordinate-inverse">',f+='<div style="font-weight: bold; margin-top: 15px;">Inverse Transform (Native \u2192 Cartesian):</div>';let x=o.useIterativeSolver||!1;for(let g=0;g<s;g++){let y=["x","y","z","w","u","v"][g],_=o.inverseTransforms&&o.inverseTransforms[g]?o.inverseTransforms[g]:"",S=o.variables.map(F=>F.label||F.displayLabel).join(", ");f+='<div class="coord-var-row">',f+=`<span style="min-width: 20px;">${y}</span>`,f+="<span>=</span>",f+=`<input type="text" class="coord-inverse-transform coord-math-input" data-index="${g}" value="${_}" placeholder="(e.g., r*cos(theta))" title="Inverse transformation from native coordinates" ${x?"disabled":""}>`,f+="</div>"}f+="</div>",f+='<div class="coordinate-tools" style="margin-top: 10px;">',f+='<button id="coord-solve-inverse" class="secondary" title="Attempt to solve inverse transforms automatically using symbolic math">\u26A1 Solve Inverse Symbolically</button>',f+='<div style="margin-top: 8px;">',f+='<label style="display: flex; align-items: center; font-size: 0.9em;">',f+=`<input type="checkbox" id="coord-use-iterative" ${x?"checked":""} style="margin-right: 5px;">`,f+=`<span title="Use GPU-based Newton's method to compute inverse. Slower but works for any transform.">Use iterative Newton solver (GLSL)</span>`,f+="</label>",f+="</div>",f+="</div>",f+='<div class="info-text" style="margin-top: 15px;">',f+="<strong>Forward Transform:</strong> Define each native coordinate in terms of Cartesian variables (x, y, z, w, ...). ",f+="<strong>Inverse Transform:</strong> Define each Cartesian coordinate in terms of native variables. ",f+='Use the "Solve" button to attempt automatic computation, or enable iterative solver for complex transforms. ',f+='Type "theta", "phi", etc. to insert Greek letters.',f+="</div>",f+='<div class="coordinate-editor-buttons">',f+='<button id="coord-apply" class="primary">Apply</button>',f+='<button id="coord-cancel" class="secondary">Cancel</button>',f+="</div>",f+="</div>",r.html(f),u(),window.unicodeAutocomplete&&($(".coord-math-input").each(function(){window.unicodeAutocomplete.attach(this)}),$(".coord-var-label").each(function(){window.unicodeAutocomplete.attach(this)}))}function u(){$("#coord-preset").off("change").on("change",function(){let m=$(this).val();if(m==="custom")return;let f=he[m];f&&(o=f,c())}),$(".coord-var-label").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();o.variables[m]||(o.variables[m]={label:"",displayLabel:""}),o.variables[m].displayLabel=f,o.variables[m].label=f,$("#coord-preset").val("custom")}),$(".coord-var-transform").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();o.forwardTransforms[m],o.forwardTransforms[m]=f,$("#coord-preset").val("custom")}),$(".coord-inverse-transform").off("input").on("input",function(){let m=parseInt($(this).data("index")),f=$(this).val().trim();o.inverseTransforms||(o.inverseTransforms=new Array(s).fill("")),o.inverseTransforms[m]=f,$("#coord-preset").val("custom")}),$("#coord-solve-inverse").off("click").on("click",function(){let m=$(this);m.prop("disabled",!0);let f=m.text();m.text("Solving...");try{let b=["x","y","z","w","u","v"].slice(0,s),x=o.variables.map(y=>y.label||y.displayLabel),g=xr(o.forwardTransforms,s,b,x);g?(o.inverseTransforms=g,$(".coord-inverse-transform").each(function(){let y=parseInt($(this).data("index"));$(this).val(g[y])}),m.text("\u2713 Solved!"),setTimeout(()=>{m.text(f),m.prop("disabled",!1)},1500)):(alert(`Could not solve inverse transforms symbolically. You can:
1. Define the inverse transforms manually
2. Enable "Use iterative Newton solver" checkbox`),m.text(f),m.prop("disabled",!1)),$("#coord-preset").val("custom")}catch(b){console.error("Error solving inverse:",b),alert("Error solving inverse: "+b.message),m.text(f),m.prop("disabled",!1)}}),$("#coord-use-iterative").off("change").on("change",function(){let m=$(this).is(":checked");o.useIterativeSolver=m,$(".coord-inverse-transform").prop("disabled",m),m?$(".coord-inverse-transform").css("opacity","0.5"):$(".coord-inverse-transform").css("opacity","1.0"),$("#coord-preset").val("custom")}),$("#coord-apply").off("click").on("click",function(){let m=$(this);m.prop("disabled",!0);let f=m.text();m.text("Applying...");try{if(d()){let x=o.forwardTransforms.map(_=>window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(_):_),g=o.inverseTransforms?o.inverseTransforms.map(_=>window.UnicodeAutocomplete&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(_):_):null,y=new O(o.name,o.dimensions,o.variables,x,g,o.useIterativeSolver||!1);setTimeout(()=>{i(y),m.prop("disabled",!1),m.text(f)},100)}else alert("Invalid coordinate system. Please check your expressions."),m.prop("disabled",!1),m.text(f)}catch(b){console.error("Error in apply handler:",b),m.prop("disabled",!1),m.text(f)}}),$("#coord-cancel").off("click").on("click",function(){i(null)})}function d(){for(let m=0;m<s;m++)if(!o.variables[m]||!o.variables[m].label||!o.forwardTransforms[m]||o.forwardTransforms[m].trim()==="")return!1;return!0}function h(m){o=m,c()}function p(m){m!==s&&(s=m,o=j(m),c())}return c(),l}function yr(n,e,t){let i=$("#coordinate-editor-panel");i.length||($("body").append(`
            <div id="coordinate-editor-panel" class="floating-panel" style="display: none;">
                <button class="floating-panel-close" style="display: none;">&times;</button>
                <div class="floating-panel-header">
                    <h3>Coordinate System</h3>
                </div>
                <div id="coordinate-editor-container" class="floating-panel-content">
                </div>
            </div>
        `),i=$("#coordinate-editor-panel")),i.show();let r=Hn("coordinate-editor-container",n,e,c=>{c===null||t(c),i.hide()});$(".floating-panel-close",i).off("click").on("click",function(){i.hide()});let o=!1,s=0,l=0;return $(".panel-header",i).off("mousedown").on("mousedown",function(c){o=!0,s=c.clientX-i.offset().left,l=c.clientY-i.offset().top,$(document).on("mousemove.panelDrag",function(u){o&&i.css({left:u.clientX-s,top:u.clientY-l})})}),$(document).on("mouseup.panelDrag",function(){o=!1,$(document).off("mousemove.panelDrag")}),r}ae();M();M();var _t=class{constructor(e){if(!e)throw new Error("GLSLWorkflow requires a generator instance");this.generator=e}getGenerationContext(e,t){throw new Error("GLSLWorkflow subclass must implement getGenerationContext()")}applyToRenderer(e,t,i){throw new Error("GLSLWorkflow subclass must implement applyToRenderer()")}async executeInteractive(e,t,i,r){let o=e.length,s=[],l=e.map(u=>u.getMath());for(let u=0;u<l.length;u++){let d=this.getGenerationContext(u,o),h=this.generator.validate(l[u],d);h.valid||s.push({index:u,error:h.error})}if(s.length>0)return this._displayErrors(r,s),{success:!1,errors:s};let c=[];for(let u=0;u<l.length;u++)try{let d=this.getGenerationContext(u,o),h=this.generator.generate(l[u],t,d);c.push(h)}catch(d){s.push({index:u,error:d.message})}if(s.length>0)return this._displayErrors(r,s),{success:!1,errors:s};try{this.applyToRenderer(c,i,l),a.info(`Applied ${c.length} expressions to renderer`)}catch(u){return this._displayErrors(r,[{index:-1,error:`Failed to apply to renderer: ${u.message}`}]),{success:!1,errors:[{index:-1,error:u.message}]}}return r.hide(),{success:!0,glslArray:c,expressions:l}}executeAutomated(e,t,i){let r=e.length,o=[];for(let l=0;l<e.length;l++){let c=this.getGenerationContext(l,r),u=this.generator.validate(e[l],c);u.valid||o.push({index:l,error:u.error})}if(o.length>0){let l=o.map(c=>`Index ${c.index}: ${c.error}`).join("; ");throw new Error(`Validation failed: ${l}`)}let s=[];for(let l=0;l<e.length;l++)try{let c=this.getGenerationContext(l,r),u=this.generator.generate(e[l],t,c);s.push(u)}catch(c){throw new Error(`Failed to generate GLSL at index ${l}: ${c.message}`)}try{this.applyToRenderer(s,i,e),a.info(`Applied ${s.length} expressions to renderer (automated)`)}catch(l){throw new Error(`Failed to apply to renderer: ${l.message}`)}return{success:!0,glslArray:s,expressions:e}}_displayErrors(e,t){let i=t.map(r=>`<div style="color: #f44336; margin: 4px 0;">
                <strong>${r.index>=0?`Index ${r.index}`:"Global"}:</strong> ${r.error}
            </div>`).join("");e.showError(i)}};M();var Et=class{generate(e,t,i={}){throw new Error("IGLSLGenerator.generate() must be implemented by subclass")}validate(e,t={}){throw new Error("IGLSLGenerator.validate() must be implemented by subclass")}getDescription(){return"GLSL Generator"}getMathPlaceholder(){return"Enter math expression..."}getGLSLPlaceholder(){return"Generated GLSL code..."}};se();M();var Ee=class extends Et{constructor(e={}){super(),this.variableNames=e.variableNames||null}validate(e,t={}){return!e||!e.trim()?{valid:!1,error:"Expression is empty"}:t.dimension===void 0?{valid:!1,error:"Context must include dimension index"}:t.totalDims===void 0?{valid:!1,error:"Context must include totalDims"}:{valid:!0}}generate(e,t,i={}){let r=this.validate(e,i);if(!r.valid)throw new Error(`Validation failed: ${r.error}`);let{dimension:o,totalDims:s}=i,l=e;if(t)try{l=t.expandFunctions(e),a.verbose(`Field equation ${o}: "${e}" \u2192 "${l}"`)}catch(u){a.warn(`Failed to expand functions for dimension ${o}:`,u.message)}let c=this.variableNames||this._getDefaultVariableNames(s);try{let u=W(l,s,c,"pos");return a.verbose(`Field equation ${o} GLSL: ${u}`),u}catch(u){throw new Error(`Failed to parse expression for dimension ${o}: ${u.message}`)}}_getDefaultVariableNames(e){return["x","y","z","w","u","v"].slice(0,e)}getDescription(){return"Vector field equation (dx/dt = ...)"}getMathPlaceholder(){return"Enter field equation (e.g., -y, sin(x), etc.)"}getGLSLPlaceholder(){return"Generated GLSL expression..."}};M();var le=class extends _t{constructor(e=null){super(e||new Ee)}getGenerationContext(e,t){return{dimension:e,totalDims:t}}applyToRenderer(e,t,i){let r=i.map((o,s)=>{if(window.notebook)try{return window.notebook.expandFunctions(o)}catch(l){return a.warn(`Failed to expand "${o}" for JS evaluator:`,l.message),o}return o});t.updateConfig({dimensions:i.length,expressions:r,velocityGLSL:e})}_displayErrors(e,t){let i=t.map(r=>`<div style="color: #f44336; margin: 4px 0;">
                <strong>${r.index>=0?`Dimension ${r.index}`:"Global"}:</strong> ${r.error}
            </div>`).join("");e.showError(i)}};var $t=class{constructor(e){this.manager=e,this.registrationPromises=[]}register(e,t){let i=customElements.whenDefined(e).then(()=>new Promise(r=>{requestAnimationFrame(()=>{let o=document.getElementById(t);if(o&&o._initialized){this.manager.register(o);let s=()=>this.manager.debouncedApply();o.attachListeners(s),r(o)}else console.warn(`Web Component ${e}#${t} not found or not initialized`),r(null)})}));return this.registrationPromises.push(i),i}whenAllReady(){return Promise.all(this.registrationPromises)}async restoreSettings(e){let t=await this.whenAllReady();for(let i of t)i&&e[i.settingsKey]!==void 0&&i.setValue(e[i.settingsKey])}async applyWhenReady(e=null){await this.whenAllReady(),e&&(this.manager.applySettings(e),await this.restoreSettings(e)),this.manager.apply()}};M();M();se();async function vr(){if(window.MathJax&&window.MathJax.startup&&window.MathJax.startup.promise){await window.MathJax.startup.promise,a.info("MathJax fully initialized via startup.promise");return}return window.MathJax&&window.MathJax.typesetPromise?(a.info("MathJax already available"),Promise.resolve()):(a.info("Waiting for MathJax to load..."),new Promise(n=>{let e=setInterval(()=>{window.MathJax&&window.MathJax.typesetPromise&&(clearInterval(e),a.info("MathJax loaded and ready"),n())},100);setTimeout(()=>{clearInterval(e),window.MathJax||a.error("MathJax failed to load after 10 seconds"),n()},1e4)}))}async function wr(n,e){if(await vr(),!window.MathJax){a.error("MathJax not available after wait, falling back to plain text"),n.textContent=e;return}try{n.innerHTML="",a.info("Rendering LaTeX:",e);let t=window.MathJax.tex2svg(e,{display:!0});n.appendChild(t),a.info("Rendered LaTeX successfully")}catch(t){a.error("Failed to render LaTeX:",t),a.error("Error stack:",t.stack),a.error("LaTeX content:",e),n.textContent=e}}async function _r(n,e,t=null){if(await vr(),!window.MathJax){a.error("MathJax not available after wait, falling back to plain text"),n.textContent=e;return}try{n.innerHTML="";let i=window.MathJax.tex2svg(e,{display:!0}),r=document.createElement("div"),o=document.createElement("div");o.style.cssText=`
            transform-origin: right center;
            display: inline-block;
            position: absolute;
            right: 0;
        `,o.appendChild(i);let s=document.createElement("div");s.style.cssText="visibility: hidden",r.appendChild(o),r.appendChild(s),n.appendChild(r);let l=r.getBoundingClientRect(),c=o.offsetWidth,u=t||n.clientWidth;a.info(`Rendered TeX size: ${c}px (measured), target: ${u}px`);let d=1;c>u&&u>0?(d=u/c,a.info(`Scaling TeX: ${c}px -> ${u}px (scale: ${d.toFixed(3)}x)`)):a.info(`No scaling needed: rendered ${c}px, target ${u}px`);let h=o.offsetHeight;r.style.display="block",r.style.position="relative",r.style.minHeight=`${h}px`,r.style.maxWidth=`${u}px`,o.style.transform=`scale(${d})`,s.style.height=`height: ${h*d}px`,o.style.visibility="visible",r.style.visibility="visible",a.info(`Actual rendered: wrapper=${r.offsetWidth}px, scaler=${o.offsetWidth}px, spacer=${s.offsetHeight}px`),a.info(`Rendered LaTeX successfully with scale ${d.toFixed(3)}`)}catch(i){a.error("Failed to render LaTeX:",i),n.textContent=e}}function jn(n,e,t){a.verbose(`Converting to derivative notation: d${e}/dt = ${n}`);let i=Ii(n,t);return a.verbose(`Generated LaTeX: ${i}`),`\\frac{d${e}}{dt} = ${i}`}function Er(n,e){if(a.verbose(`createSystemLatex called with ${n.length} expressions:`,n),a.verbose("Variables:",e),!n||n.length===0)return"";let t=n.length;return`\\begin{array}{l}
${n.map((r,o)=>{let s=e[o]||`x_{${o}}`;return`\\displaystyle ${jn(r,s,t)}`}).join(` \\\\
`)}
\\end{array}`}var hi=class{constructor(){this.overlayElement=null,this.visible=!1,this.currentExpressions=[],this.currentVariables=[],this.visibleOpacity="60%"}initialize(e="equation-overlay"){if(this.overlayElement=document.getElementById(e),!this.overlayElement){a.error(`Equation overlay element not found: #${e}`);return}this.contentElement=document.createElement("div"),this.contentElement.className="equation-content",this.overlayElement.appendChild(this.contentElement),window.addEventListener("resize",()=>{this.visible&&this.scaleToFit()}),a.info("Equation overlay initialized")}show(){this.overlayElement&&(this.visible=!0,this.overlayElement.classList.add("visible"),this.overlayElement.style.opacity=this.visibleOpacity||"1",a.verbose("Equation overlay shown"))}hide(){this.overlayElement&&(this.visible=!1,this.overlayElement.classList.remove("visible"),this.overlayElement.style.opacity="0",a.verbose("Equation overlay hidden"))}setVisible(e){e?this.show():this.hide()}async updateEquations(e,t){if(!(!this.overlayElement||!this.contentElement)&&(this.currentExpressions=e,this.currentVariables=t,!!this.visible))try{let i=Er(e,t);if(!i){this.contentElement.innerHTML="<em>No equations</em>";return}await wr(this.contentElement,i),this.scaleToFit(),a.verbose(`Updated equation overlay with ${e.length} equations`)}catch(i){a.error("Failed to update equation overlay:",i),this.contentElement.innerHTML="<em>Error rendering equations</em>"}}scaleToFit(){if(!this.overlayElement||!this.contentElement)return;let e=this.contentElement.querySelector("mjx-container");e&&(this.overlayElement.style.opacity="0",e.style.transform="",e.style.transformOrigin="top left",e.style.fontSize="",setTimeout(()=>{e.offsetWidth;let t=window.innerWidth-810,i=t-40,r=e.querySelector("svg"),o;r?o=r.getBoundingClientRect().width:o=e.scrollWidth,a.verbose(`Equation sizing: SVG content=${o.toFixed(1)}px, available=${i}px (max-width=${t}px - 40px padding)`),a.verbose(`  mjx-container: getBBox=${e.getBoundingClientRect().width.toFixed(1)}px, scrollWidth=${e.scrollWidth}px`);let s=()=>{setTimeout(()=>{let l=e.querySelector("svg"),c=l?l.getBoundingClientRect():e.getBoundingClientRect(),u=Math.ceil(c.width+40),d=Math.ceil(c.height+32);this.overlayElement.style.width=`${u}px`,this.overlayElement.style.height=`${d}px`,this.overlayElement.style.opacity=this.visibleOpacity||"1",a.verbose(`Final panel size: ${u}px \xD7 ${d}px (SVG: ${c.width.toFixed(1)}px \xD7 ${c.height.toFixed(1)}px)`)},100)};if(o>i){let l=o/i;if(l<1.5){let c=Math.max(.7,1/l);e.style.fontSize=`${(c*100).toFixed(0)}%`,a.verbose(`Reduced equation font size to ${(c*100).toFixed(0)}% to fit (${o.toFixed(1)}px \u2192 ${i}px)`)}else{e.style.fontSize="70%";let c=Math.max(.4,i/(o*.7));e.style.transform=`scale(${c})`,a.verbose(`Reduced font to 70% and scaled by ${(c*100).toFixed(0)}% to fit (${o.toFixed(1)}px \u2192 ${i}px)`)}s()}else a.verbose("Equations fit naturally (no scaling needed)"),s()},250))}async refresh(){this.currentExpressions.length>0&&await this.updateEquations(this.currentExpressions,this.currentVariables)}isVisible(){return this.visible}},Y=new hi;M();var St=class{constructor(e,t){this.renderer=e,this.controlManager=t,this.isRunning=!1,this.animationFrameId=null,this.direction=1,this.alpha=0,this.stepsPerIncrement=10,this.stepCounter=0,this.options={clearParticles:!1,clearScreen:!1,smoothTiming:!1,lockShaders:!1},this.ALPHA_STEP_TIME_TARGET_PERCENTILE=95,this.ALPHA_STEP_TIME_DECAY=.002,this.ALPHA_STEP_TIME_UPWARD=this.ALPHA_STEP_TIME_TARGET_PERCENTILE/(100-this.ALPHA_STEP_TIME_TARGET_PERCENTILE)*this.ALPHA_STEP_TIME_DECAY,this.ALPHA_STEP_TIME_WARMUP_CYCLES=3,this.ALPHA_STEP_TIME_DISPLAY_INTERVAL=10,this.alphaStepTimeEMA=null,this.alphaStepStartTime=null,this.alphaStepWarmupCounter=0,this.alphaStepDisplayCounter=0,this.cachedAnimatableControls=null,this.cachedAnimatableParams=null,this.lastAppliedSettings=null,this.shaderLockWasEnabled=!1,this.savedLoggerVerbosity=null,this.frameCaptureMode=null,this.frameCaptureTotal=0,this.frameCaptureCount=0,this.frameCaptureAlphaIncrement=.01,this.capturedFrames=[],this.frameCaptureOnProgress=null,this.frameCaptureOnComplete=null,this._alphaChangedListeners=[]}setAlpha(e,t=!0){this.alpha=Math.max(0,Math.min(1,e)),this.renderer&&this.renderer.setAnimationAlpha(this.alpha),t&&(this._updateAnimatableControls(this.alpha),this._applyChangedSettings(),this.options.clearParticles&&this.renderer&&this.renderer.resetParticles(),this.options.clearScreen&&this.renderer&&this.renderer.clearRenderBuffer()),this._emitAlphaChanged(this.alpha)}getAlpha(){return this.alpha}setSpeed(e){this.stepsPerIncrement=Math.max(1,Math.round(e))}setOptions(e){Object.assign(this.options,e)}start(e={}){if(this.isRunning)return;let{captureFrames:t=!1,totalFrames:i=0,loops:r=1,halfLoops:o=!1,onProgress:s=null,onComplete:l=null}=e;if(t){this.frameCaptureMode="fixed",this.frameCaptureTotal=i,this.frameCaptureCount=0,this.capturedFrames=[],this.frameCaptureOnProgress=s,this.frameCaptureOnComplete=l;let c=o?1:2;this.frameCaptureAlphaIncrement=r*c/i}else this.frameCaptureMode="continuous",this.frameCaptureAlphaIncrement=.01;this.isRunning=!0,this.renderer&&this.renderer.stop(),this._resetTimingState(),this.options.lockShaders&&this.renderer?(this.renderer.lockShaderRecompilation=!0,this.shaderLockWasEnabled=!0,a.info("Shader recompilation lock ENABLED (animation started)",null,!1)):this.shaderLockWasEnabled=!1,this.savedLoggerVerbosity=a.verbosity,a.setVerbosity("silent"),this._cacheAnimatableControls(),this._renderLoop()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.renderer&&!this.renderer.isRunning&&this.renderer.start();let e=document.getElementById("step-time-counter");e&&(e.style.display="none"),this.cachedAnimatableControls=null,this.cachedAnimatableParams=null,this.lastAppliedSettings=null,this.savedLoggerVerbosity!==null&&(a.setVerbosity(this.savedLoggerVerbosity),this.savedLoggerVerbosity=null),this.shaderLockWasEnabled&&this.renderer&&(this.renderer.lockShaderRecompilation=!1,this.shaderLockWasEnabled=!1,a.info("Shader recompilation lock DISABLED (animation stopped)")),this.frameCaptureMode=null}getFrames(){return this.capturedFrames}onAlphaChanged(e){this._alphaChangedListeners.push(e)}offAlphaChanged(e){let t=this._alphaChangedListeners.indexOf(e);t!==-1&&this._alphaChangedListeners.splice(t,1)}_resetTimingState(){this.stepCounter=0,this.alphaStepTimeEMA=null,this.alphaStepStartTime=null,this.alphaStepWarmupCounter=0,this.alphaStepDisplayCounter=0,this.lastAppliedSettings=null}_cacheAnimatableControls(){this.cachedAnimatableControls=[],this.controlManager.controls.forEach(t=>{t&&typeof t.animationEnabled<"u"&&t.updateFromAlpha&&this.cachedAnimatableControls.push(t)}),this.cachedAnimatableParams=[];let e=this.controlManager.controls.get("transform-params");e&&e.parameterControls&&e.parameterControls.forEach(t=>{t instanceof _e&&this.cachedAnimatableParams.push(t)})}_updateAnimatableControls(e){this.cachedAnimatableControls||this._cacheAnimatableControls();for(let t=0;t<this.cachedAnimatableControls.length;t++){let i=this.cachedAnimatableControls[t];i.animationEnabled&&i.updateFromAlpha(e)}for(let t=0;t<this.cachedAnimatableParams.length;t++){let i=this.cachedAnimatableParams[t];i.animationEnabled&&i.updateFromAlpha(e)}}_applyChangedSettings(){if(!this.renderer||!this.cachedAnimatableControls)return;let e={};for(let t=0;t<this.cachedAnimatableControls.length;t++){let i=this.cachedAnimatableControls[t],r=i.getValue();(this.lastAppliedSettings===null||r!==this.lastAppliedSettings[i.settingsKey])&&(e[i.settingsKey]=r)}for(let t=0;t<this.cachedAnimatableParams.length;t++){let i=this.cachedAnimatableParams[t],r=i.getValue(),o=i.parameterName;e.transformParams||(e.transformParams=this.lastAppliedSettings?.transformParams?{...this.lastAppliedSettings.transformParams}:{}),(this.lastAppliedSettings===null||r!==this.lastAppliedSettings.transformParams?.[o])&&(e.transformParams[o]=r)}if(Object.keys(e).length>0)try{this.renderer.updateConfig(e),this.lastAppliedSettings===null&&(this.lastAppliedSettings={}),Object.assign(this.lastAppliedSettings,e)}catch(t){a.error("Failed to apply animation settings:",t)}else this.lastAppliedSettings===null&&(this.lastAppliedSettings={})}_renderLoop(){if(this.isRunning){if(this.stepCounter++,this.stepCounter===1&&(this.renderer&&this.renderer.shadersJustRecompiled&&(this.renderer.shadersJustRecompiled=!1),this.alphaStepStartTime=performance.now()),this.stepCounter>=this.stepsPerIncrement){this.stepCounter=0,this.options.clearScreen&&this.renderer&&this.renderer.render(!0);let t=performance.now()-this.alphaStepStartTime;if(this._updateTimingEMA(t),this.alpha+=this.direction*this.frameCaptureAlphaIncrement,this.alpha>=1?(this.alpha=1,this.direction=-1):this.alpha<=0&&(this.alpha=0,this.direction=1),this._updateAnimatableControls(this.alpha),this.renderer&&this.renderer.setAnimationAlpha(this.alpha),this._applyChangedSettings(),this._emitAlphaChanged(this.alpha),this.options.clearParticles&&this.renderer&&this.renderer.resetParticles(),this.renderer&&(this.options.clearScreen||this.renderer.render(!0),this.options.clearScreen&&this.renderer.clearRenderBuffer(!0)),this.frameCaptureMode==="fixed"&&this._captureFrame(),this.options.smoothTiming&&this.alphaStepTimeEMA!==null&&t<this.alphaStepTimeEMA){let i=this.alphaStepTimeEMA-t;setTimeout(()=>{this.isRunning&&(this.animationFrameId=requestAnimationFrame(()=>this._renderLoop()))},i);return}}else this.renderer&&(this.options.clearScreen?this.renderer.render(!1):this.renderer.render(!0));this.isRunning&&(this.animationFrameId=requestAnimationFrame(()=>this._renderLoop()))}}_updateTimingEMA(e){if(this.alphaStepWarmupCounter<this.ALPHA_STEP_TIME_WARMUP_CYCLES?this.alphaStepWarmupCounter++:this.alphaStepTimeEMA===null?this.alphaStepTimeEMA=e:e>this.alphaStepTimeEMA?this.alphaStepTimeEMA=this.ALPHA_STEP_TIME_UPWARD*e+(1-this.ALPHA_STEP_TIME_UPWARD)*this.alphaStepTimeEMA:this.alphaStepTimeEMA=this.ALPHA_STEP_TIME_DECAY*e+(1-this.ALPHA_STEP_TIME_DECAY)*this.alphaStepTimeEMA,this.options.smoothTiming){if(this.alphaStepDisplayCounter++,this.alphaStepDisplayCounter>=this.ALPHA_STEP_TIME_DISPLAY_INTERVAL){this.alphaStepDisplayCounter=0;let t=document.getElementById("step-time-counter");t&&(this.alphaStepTimeEMA===null?t.textContent=`Step: ${e.toFixed(1)}ms (warming up...)`:t.textContent=`Step: ${e.toFixed(1)}ms (EMA: ${this.alphaStepTimeEMA.toFixed(1)}ms)`,t.style.display="block")}}else{let t=document.getElementById("step-time-counter");t&&(t.style.display="none")}}async _captureFrame(){if(this.renderer)try{let e=await this.renderer.captureRenderBuffer();this.capturedFrames.push(e),this.frameCaptureCount++,this.frameCaptureOnProgress&&this.frameCaptureOnProgress(this.frameCaptureCount,this.frameCaptureTotal,this.alpha),this.frameCaptureCount>=this.frameCaptureTotal&&(this.stop(),this.frameCaptureOnComplete&&this.frameCaptureOnComplete(this.capturedFrames))}catch(e){console.error("Failed to capture animation frame:",e),this.stop(),alert("Failed to capture animation frame. Check console for details.")}}_emitAlphaChanged(e){for(let t of this._alphaChangedListeners)t(e)}};var X={GRID:1,COUNTERS:10,CONTROLS_PANEL:200,COORDINATE_EDITOR:300,GRADIENT_PANEL:325,RENDERING_PANEL:350,MOBILE_VIEW_CONTROLS:9998,MOBILE_MENU_BAR:1e4,MENU_BAR:10001,MENU_BAR_LOWERED:1,MOBILE_PANEL:2e4,CLOSE_BUTTON:99999};function $r(){$("#menu-bar").css("z-index",X.MENU_BAR_LOWERED)}function Sr(){$("#menu-bar").css("z-index",X.MENU_BAR)}function $e(){return window.innerWidth<=768}var Se=class{constructor(e,t={}){this.panel=$(e),this.panelSelector=e,this.closeButton=this.panel.find(".floating-panel-close, .mobile-overlay-close"),this.onShow=t.onShow,this.onHide=t.onHide,this.zIndex=t.zIndex||X.MOBILE_PANEL,this.manageMobileOnly=t.manageMobileOnly!==!1,this.panel.length||console.warn(`PanelManager: Panel not found: ${e}`)}show(){this.panel.length&&(this.panel.show(),(!this.manageMobileOnly||$e())&&(this.panel.css("z-index",this.zIndex),this.closeButton.css("z-index",X.CLOSE_BUTTON),$r()),this.onShow&&this.onShow())}hide(){this.panel.length&&(this.panel.hide(),(!this.manageMobileOnly||$e())&&Sr(),this.onHide&&this.onHide())}toggle(){this.isVisible()?this.hide():this.show()}isVisible(){return this.panel.is(":visible")}setZIndex(e){this.zIndex=e,this.isVisible()&&(!this.manageMobileOnly||$e())&&this.panel.css("z-index",e)}getPanel(){return this.panel}wireCloseButton(){this.closeButton.off("click.panelManager").on("click.panelManager",()=>{this.hide()})}enableClickOutside(e=[]){this.clickOutsideExclusions=[this.panelSelector,...e],$(document).off("click.panelManager"+this.panelSelector),$(document).on("click.panelManager"+this.panelSelector,t=>{for(let i of this.clickOutsideExclusions)if($(t.target).is(i)||$(t.target).closest(i).length>0)return;this.isVisible()&&this.hide()}),this.panel.off("click.panelManagerStop").on("click.panelManagerStop",t=>{t.stopPropagation()})}disableClickOutside(){$(document).off("click.panelManager"+this.panelSelector),this.panel.off("click.panelManagerStop"),this.clickOutsideExclusions=null}destroy(){this.closeButton.off("click.panelManager"),this.disableClickOutside()}};function Xe(n){let t=["reinhard_extended","uncharted2","hable","luminance_extended"].includes(n);$("#white-point-control").toggle(t)}function mi(n){n==="expression"?$("#expression-controls").show():$("#expression-controls").hide()}function pi(n){n==="expression"||n==="velocity_magnitude"||n==="velocity_angle"||n==="velocity_combined"?$("#gradient-button-container").show():$("#gradient-button-container").hide(),n==="expression"?$("#gradient-preset-toggle").hide():$("#gradient-preset-toggle").show()}function fi(n){n==="velocity_magnitude"||n==="velocity_combined"?($("#velocity-scaling-container").show(),$("#velocity-log-container").show()):($("#velocity-scaling-container").hide(),$("#velocity-log-container").hide())}ae();M();function Xn(n){try{let e=n.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";let t=atob(e);return JSON.parse(t)}catch(e){return console.error("Failed to decode settings:",e),null}}function qn(n){try{let e=JSON.stringify(n);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){return console.error("Failed to encode settings:",e),null}}function Tr(){try{let n=new URLSearchParams(window.location.search),e=n.get("s"),t=null;if(e){if(t=Xn(e),t){console.log("Loaded settings from URL parameter"),localStorage.setItem("vectorFieldSettings",JSON.stringify(t)),n.delete("s");let i=n.toString(),r=window.location.pathname+(i?"?"+i:"");window.history.replaceState({},"",r),console.log("URL cleaned, settings now in localStorage")}}else{let i=localStorage.getItem("vectorFieldSettings");i&&(t=JSON.parse(i),console.log("Loaded settings from localStorage"))}return t}catch(n){return console.warn("Failed to load settings:",n),null}}function Cr(n,e){let t=n.getSettings();return e&&e.bbox&&(t.bbox={min:[...e.bbox.min],max:[...e.bbox.max]}),e&&e.coordinateSystem&&(t.coordinateSystem=e.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(t)),t}function Ar(n){let e=qn(n);if(!e){alert("Failed to encode settings");return}let t=new URL(window.location.href);t.search="";let i=new URLSearchParams(window.location.search).get("storage");i&&t.searchParams.set("storage",i),t.searchParams.set("s",e);let r=t.toString();if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(r).then(()=>{let o=$("#share-url"),s=o.text();o.text("URL Copied!"),setTimeout(()=>{o.text(s)},2e3)}).catch(o=>{console.error("Failed to copy URL to clipboard:",o),alert(`Share this URL:

`+r)});else{let o=document.createElement("input");o.value=r,document.body.appendChild(o),o.select(),o.setSelectionRange(0,99999);try{let s=document.execCommand("copy");if(document.body.removeChild(o),s){let l=$("#share-url"),c=l.text();l.text("URL Copied!"),setTimeout(()=>{l.text(c)},2e3)}else throw new Error("execCommand failed")}catch{document.body.removeChild(o),alert(`Copy this URL to share:

`+r)}}}function Wn(n,e,t){if(!n||!n.coordinateSystem||!n.dimensions)return!1;try{let i=n.coordinateSystem;i.forwardTransforms&&window.UnicodeAutocomplete&&(i.forwardTransforms=i.forwardTransforms.map(o=>typeof o=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(o):o));let r=O.fromJSON(i);if(r.dimensions===n.dimensions)return e.coordinateSystem=r,t.setCoordinateSystem(r,!1),console.log("Restored coordinate system:",r.name),!0;{console.warn(`Coordinate system dimension mismatch: system has ${r.dimensions}D but settings use ${n.dimensions}D. Resetting to Cartesian.`);let o=j(n.dimensions);return e.coordinateSystem=o,t.setCoordinateSystem(o,!1),!1}}catch(i){if(console.warn("Failed to restore coordinate system:",i),n.dimensions){let r=j(n.dimensions);e.coordinateSystem=r,t.setCoordinateSystem(r,!1)}return!1}}function Jn(n){n.expressions&&Array.isArray(n.expressions)&&window.UnicodeAutocomplete&&(n.expressions=n.expressions.map(e=>typeof e=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(e):e))}function Yn(n){if(n.mapperParams){let e=n.mapperParams;e.dim1!==void 0&&e.dim2!==void 0&&e.dim1===e.dim2&&(console.warn("Invalid mapper params: dim1 and dim2 are the same, fixing to default"),n.mapperParams={dim1:0,dim2:1})}}function Kn(n,e){if(!e)return n;let t=e.width/e.height,i=n.max[0]-n.min[0],r=n.max[1]-n.min[1],o=i/r,s=(n.min[0]+n.max[0])/2,l=(n.min[1]+n.max[1])/2,c=i,u=r;return t>o?c=r*t:u=i/t,{min:[s-c/2,l-u/2],max:[s+c/2,l+u/2]}}function Fr(n,e,t,i){if(!n){i&&i();return}let r=e.get("dimension-inputs");r&&Wn(n,t,r),Jn(n),Yn(n),e.webComponentRegistry?e.webComponentRegistry.applyWhenReady(n).then(()=>{i&&i()}):(e.applySettings(n),e.apply(),i&&i())}function Rr(n,e){if(n&&n.bbox&&e){let t=e.gl?.canvas,i=Kn(n.bbox,t);e.updateConfig({bbox:i,reinitializeParticles:!1}),a.verbose("Restored bbox expanded for aspect ratio")}}ae();M();var bi="customPresets";function Lr(){window.presets={"2d_rotation":{dimensions:2,expressions:["-y","x"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"Simple Rotation",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"2d_vortex":{dimensions:2,expressions:["-y + x*(1 - x*x - y*y)","x + y*(1 - x*x - y*y)"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,bbox:{min:[-3,-3],max:[3,3]},name:"Vortex",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"2d_vanderpol":{dimensions:2,expressions:["y","(1 - x*x)*y - x"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"Van der Pol Oscillator",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"3d_lorenz":{dimensions:3,expressions:["10*(y - x)","x*(28 - z) - y","x*y - 2.67*z"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"Lorenz Attractor",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"3d_rossler":{dimensions:3,expressions:["-y - z","x + 0.2*y","0.2 + z*(x - 5.7)"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"R\xF6ssler Attractor",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"4d_hypersphere":{dimensions:4,expressions:["-y","x","-w","z"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"4D Hypersphere Rotation",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"2d_fluid_stirring":{dimensions:2,expressions:["-y + sin(x)*cos(y)*3.0 - 0.1*x","x + cos(x)*sin(y)*3.0 - 0.1*y"],colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,name:"Fluid Transport with Stirring",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"4d_double_pendulum":{dimensions:4,expressions:["z","w","(-10*(2*sin(x) + sin(x - 2*y)) - 2*sin(x - y)*(w*w + z*z*cos(x - y))) / (3 - cos(2*x - 2*y))","(2*sin(x - y)*(2*z*z + 20*cos(x) + w*w*cos(x - y))) / (3 - cos(2*x - 2*y))"],name:"Double Pendulum (Chaotic)",timestep:.005,colorMode:"velocity_angle",integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.001,implicitIterations:3,particleCount:5e5,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,mapperType:"custom",mapperParams:{horizontalExpr:"sin(x) + sin(y)",verticalExpr:"-cos(x) - cos(y)",depthExpr:""},supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13},"2d_strange_attractor":{dimensions:2,expressions:["-y + x*(1 - x*x*x*x - y*y*y*y)","x + y*(1 - x*x*x*x - y*y*y*y)"],bbox:{min:[-3.5719104227544065,-1.7259582784950003],max:[3.5719104227544065,1.7259582784950003]},integratorType:"implicit-euler",solutionMethod:"fixed-point",timestep:.472,implicitIterations:3,particleCount:880100,fadeOpacity:.9999,frameLimit:300,frameLimitEnabled:!0,dropProbability:.03,colorMode:"velocity_angle",supersampleFactor:2,smaaEnabled:!0,"smaa-intensity":1,"smaa-threshold":0,bilateralEnabled:!0,bilateralSpatialSigma:5,bilateralIntensitySigma:.5,tonemapOperator:"luminance_extended",exposure:.010232929922807544,gamma:.7803178779033633,luminanceGamma:1.2188608780748513,highlightCompression:9.999999999999993,compressionThreshold:100000.00000000001,whitePoint:3.443499307633384,particleIntensity:47.31512589614813,particleSize:.10000000000000002,particleRenderMode:"points",colorSaturation:.429,brightnessDesaturation:.685,brightnessSaturation:.13,name:"Strange Attractor (Chaotic Limit Cycle)"}}}function Zn(n,e){if(!e)return n;let t=e.width/e.height,i=n.max[0]-n.min[0],r=n.max[1]-n.min[1],o=i/r,s=(n.min[0]+n.max[0])/2,l=(n.min[1]+n.max[1])/2,c=i,u=r;return t>o?c=r*t:u=i/t,{min:[s-c/2,l-u/2],max:[s+c/2,l+u/2]}}function Tt(n,e){let t=window.presets[n];if(t||(t=qe()[n]),!t){console.error("Preset not found:",n),a.error(`Preset not found: ${n}`);return}if(a.info(`Loading preset: ${t.name||n} (dimensions=${t.dimensions}, expressions=${t.expressions.length})`),e.resetAll(),t.dimensions){let c;t.coordinateSystem?c=O.fromJSON(t.coordinateSystem):c=j(t.dimensions),window.renderer&&(window.renderer.coordinateSystem=c);let u=e.get("dimension-inputs");u&&u.setCoordinateSystem(c),a.info(`Preset loaded with coordinate system: ${c.name}`)}e.webComponentRegistry?e.webComponentRegistry.applyWhenReady(t):(e.applySettings(t),e.apply());let i=e.get("dimension-inputs");i&&t.dimensions&&i.updateInputs(t.dimensions);let r=e.get("mapper-params");r&&r.updateControls();let o=e.get("transform-params");o&&o.updateControls();let s=e.getSettings();if(t.bbox){let c=window.renderer?.gl?.canvas,u=Zn(t.bbox,c);s.bbox=u;let d=t.bbox.max[0]-t.bbox.min[0],h=t.bbox.max[1]-t.bbox.min[1],p=u.max[0]-u.min[0],m=u.max[1]-u.min[1];c?a.info(`Preset bbox expanded from [${d.toFixed(2)} x ${h.toFixed(2)}] to [${p.toFixed(2)} x ${m.toFixed(2)}] for aspect ratio ${(c.width/c.height).toFixed(2)}`):a.info(`Preset bbox: min=${t.bbox.min}, max=${t.bbox.max}`)}s.implicitIterations!==void 0&&(s.integratorParams={iterations:s.implicitIterations});let l=s.expressions;if(delete s.expressions,window.renderer&&window.renderer.updateConfig(s),l&&l.length>0&&window.renderer&&window.notebook)try{new le().executeAutomated(l,window.notebook,window.renderer),a.info(`Applied ${l.length} field equations via workflow`)}catch(c){a.error("Failed to apply field equations from preset:",c.message)}a.info(`Preset ${t.name||n} loaded successfully`)}function qe(){try{let n=localStorage.getItem(bi);return n?JSON.parse(n):{}}catch(n){return console.error("Failed to load custom presets:",n),{}}}function Qn(n,e){let t=qe();t[n]=e;try{localStorage.setItem(bi,JSON.stringify(t))}catch(i){console.error("Failed to save custom preset:",i),alert("Failed to save preset: "+i.message)}}function eo(n){let e=qe();delete e[n];try{localStorage.setItem(bi,JSON.stringify(e))}catch(t){console.error("Failed to delete custom preset:",t)}}function gi(){let n=qe(),e=$("#custom-presets-group");e.empty();let t=Object.keys(n).sort();t.length>0?(e.show(),t.forEach(i=>{let o=n[i].name||i;e.append(`<option value="${i}">${o}</option>`)})):e.hide()}function Mr(n){$("#preset-selector").on("change",function(){let e=$(this).val();e&&(Tt(e,n),$(this).val(""),qe()[e]?($("#preset-name-input").val(e),$("#delete-preset-btn").show()):($("#preset-name-input").val(""),$("#delete-preset-btn").hide()))}),$("#save-preset-btn").on("click",function(){let e=$("#preset-name-input").val().trim();if(!e){alert("Please enter a preset name");return}let i={...n.getSettings(),name:e};Qn(e,i),gi(),$("#delete-preset-btn").show(),a.info("Preset saved: "+e)}),$("#delete-preset-btn").on("click",function(){let e=$("#preset-name-input").val().trim();e&&confirm(`Delete preset "${e}"?`)&&(eo(e),gi(),$("#preset-name-input").val(""),$("#delete-preset-btn").hide(),a.info("Preset deleted: "+e))}),gi()}function to(n){n==="expression"||n==="velocity_magnitude"||n==="velocity_angle"||n==="velocity_combined"?$("#gradient-button-container").show():$("#gradient-button-container").hide(),n==="expression"?$("#gradient-preset-toggle").hide():$("#gradient-preset-toggle").show()}function Pr(n,e){let t=null,i=new Se("#gradient-panel",{zIndex:X.GRADIENT_PANEL,onShow:()=>{to(n.get("color-mode").getValue()),t?t.setGradient(e.getValue()):(t=gr("main-gradient-editor",e.getValue(),s=>{e.notifyChange(s)}),e.setGradientEditor(t))}});function r(){i.show()}function o(){i.hide()}return $("#open-gradient-editor").on("click",function(){r()}),$("#reset-gradient").on("click",function(){let s=ve();t&&(t.setGradient(s),e.notifyChange(s))}),i.enableClickOutside(["#open-gradient-editor"]),{showGradientPanel:r,hideGradientPanel:o,gradientEditor:t}}function Ir(n){let e=new Se("#rendering-panel",{zIndex:X.RENDERING_PANEL,onShow:()=>{Xe(n.get("tonemap-operator").getValue())}});function t(){e.show()}function i(){e.hide()}return $("#open-rendering-settings").on("click",function(){t()}),$("#rendering-panel .floating-panel-close").on("click",function(){window.mobilePanelManager&&window.mobilePanelManager.getCurrentPanel()==="rendering"?window.mobilePanelManager.hidePanel("rendering"):i()}),e.enableClickOutside(["#open-rendering-settings","#mobile-menu-rendering"]),{showRenderingPanel:t,hideRenderingPanel:i,renderingPanelManager:e}}M();function Dr(n,e,t){let i=new St(e,n);window.animationController=i;let r=document.getElementById("animation-alpha"),o=document.getElementById("animation-speed");r&&(r.setController(i),t.register("animation-alpha","animation-alpha"),a.info("Animation alpha web component registered")),o&&(o.setController(i),a.info("Animation speed web component registered"));let s=document.getElementById("frame-limit"),l=document.getElementById("frame-limit-enabled"),c=document.getElementById("sync-steps-to-frame-limit");function u(){try{if(console.log("syncStepsToFrameLimit called"),typeof c?.getValue!="function"){console.log("bail: syncCheckbox no getValue");return}if(!c.getValue()){console.log("bail: syncCheckbox not checked");return}if(typeof o?.getValue!="function"){console.log("bail: animationSpeed no getValue");return}if(typeof s?.setValue!="function"){console.log("bail: frameLimit no setValue");return}let y=o.getValue();console.log("syncing steps:",y),s.setValue(y),l&&!l.getValue()&&l.setValue(!0),window.renderer&&(window.renderer.frameLimit=y,window.renderer.frameLimitEnabled=!0,window.renderer.totalFrames=0,window.renderer.clearRenderBuffer(),window.renderer.resetParticles(),window.renderer.isRunning||window.renderer.start())}catch(y){console.warn("syncStepsToFrameLimit error:",y)}}c?.addEventListener("change",function(){try{typeof c.getValue=="function"&&c.getValue()&&u()}catch(y){console.warn("sync checkbox change error:",y)}}),o&&(o.onChange=u),c&&t.register("check-box","sync-steps-to-frame-limit");let d=document.getElementById("animation-clear-particles"),h=document.getElementById("animation-clear-screen"),p=document.getElementById("animation-smooth-timing"),m=document.getElementById("animation-lock-shaders");d&&d.addEventListener("change",function(){i.setOptions({clearParticles:d.getValue()})}),h&&h.addEventListener("change",function(){i.setOptions({clearScreen:h.getValue()})}),p&&p.addEventListener("change",function(){i.setOptions({smoothTiming:p.getValue()})}),m&&m.addEventListener("change",function(){i.setOptions({lockShaders:m.getValue()})});let f=document.getElementById("animation-half-loops");f&&f.addEventListener("change",function(){let _=f.getValue()?"Number of half cycles (1 = 0.0 \u2192 1.0, 2 = 0.0 \u2192 1.0 \u2192 0.0)":"Number of complete alpha cycles (0.0 \u2192 1.0 \u2192 0.0)";$("#animation-loops-info").text(_)});let b=document.getElementById("animation-create-btn");b&&b.addEventListener("action",function(){if(i.isRunning){i.stop(),b.setLabel("Create Animation"),b.setIcon("\u25B6"),b.setStyle("#4CAF50");let A=document.getElementById("animation-frames"),B=document.getElementById("animation-loops"),z=document.getElementById("animation-half-loops"),v=document.getElementById("animation-download-btn");A&&(A.disabled=!1),B&&(B.disabled=!1),z&&(z.disabled=!1),v&&v.setEnabled(i.getFrames().length>0),$("#progress-text").text(`Stopped: ${i.getFrames().length} frames captured`),a.info(`Animation stopped early: ${i.getFrames().length} frames captured`);return}let y=document.getElementById("animation-frames"),_=document.getElementById("animation-loops"),S=document.getElementById("animation-half-loops"),F=document.getElementById("animation-download-btn"),E=y?y.getValue():100,L=_?_.getValue():1,k=S?.getValue?S.getValue():!1;b.setLabel("Stop Animation"),b.setIcon("\u23F9"),b.setStyle("#f44336"),y&&(y.disabled=!0),_&&(_.disabled=!0),S&&(S.disabled=!0),F&&F.setEnabled(!1),$("#animation-progress").show(),$("#progress-bar").css("width","0%"),$("#progress-text").text(`Frame 0 / ${E}`),$("#progress-alpha").text("\u03B1: 0.00"),i.start({captureFrames:!0,totalFrames:E,loops:L,halfLoops:k,onProgress:(A,B,z)=>{let v=A/B*100;$("#progress-bar").css("width",`${v}%`),$("#progress-text").text(`Frame ${A} / ${B}`),$("#progress-alpha").text(`\u03B1: ${z.toFixed(2)}`)},onComplete:A=>{b.setLabel("Create Animation"),b.setIcon("\u25B6"),b.setStyle("#4CAF50"),y&&(y.disabled=!1),_&&(_.disabled=!1),S&&(S.disabled=!1),F&&F.setEnabled(!0),$("#progress-bar").css("width","100%"),$("#progress-text").text(`Complete: ${A.length} frames`),a.info(`Animation creation complete: ${A.length} frames captured`)}})});let x=document.getElementById("animation-download-btn");x&&x.addEventListener("action",async function(){let y=i.getFrames();if(y.length===0){alert("No frames to download. Create an animation first.");return}x.setLoading(!0,"Creating ZIP...");try{let S=y.length,F=Math.ceil(S/300),E=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);a.info(`Splitting ${S} frames into ${F} ZIP file(s)`);for(let L=0;L<F;L++){let k=L*300,A=Math.min((L+1)*300,S);x.setLoading(!0,`Creating ZIP ${L+1}/${F}...`);let B=new JSZip,z=B.folder("frames");for(let R=k;R<A;R++){let P=String(R).padStart(5,"0");z.file(`frame_${P}.png`,y[R])}let v=await B.generateAsync({type:"blob"}),C=URL.createObjectURL(v),w=document.createElement("a"),T=F>1?`.${L+1}`:"";w.download=`animation-${E}${T}.zip`,w.href=C,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(C),a.info(`Part ${L+1}/${F} downloaded: frames ${k}-${A-1}`),L<F-1&&await new Promise(R=>setTimeout(R,500))}a.info(`Animation download complete: ${S} frames in ${F} ZIP file(s)`),F>1&&alert(`Animation split into ${F} ZIP files. Use create-video.sh with the base filename (without .1, .2, etc) to reconstruct.`)}catch(_){a.error("Failed to create ZIP:",_),alert("Failed to create ZIP file: "+_.message)}finally{x.setLoading(!1)}});let g=document.getElementById("export-animation-json");return g&&g.addEventListener("action",function(){let y=n.getSettings();e&&e.bbox&&(y.bbox={min:[e.bbox.min[0],e.bbox.min[1]],max:[e.bbox.max[0],e.bbox.max[1]]}),delete y.animationAlpha;let _={name:"Untitled Animation",description:"Animation created from current settings",fps:30,baseSettings:y,timeline:[{time:0,settings:{},easing:"linear"},{time:10,settings:{},easing:"linear"}],frameConfig:{burnInSteps:5e3,clearAfterBurnIn:!0,accumulationSteps:2e3}},S=new Blob([JSON.stringify(_,null,2)],{type:"application/json"}),F=URL.createObjectURL(S),E=document.createElement("a");E.href=F,E.download="animation-template.json",document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(F),a.info("Exported animation template JSON")}),i}M();function kr(n){let e={controls:$("#controls"),rendering:$("#rendering-panel")},t=null;function i(s){t&&r(t);let l=e[s];if(!l){a.warn(`Mobile panel not found: ${s}`);return}s==="rendering"?n.show():(l.addClass("mobile-overlay active"),l.find(".mobile-overlay-close").show(),l.css("z-index",X.MOBILE_PANEL),l.find(".mobile-overlay-close").css("z-index",X.CLOSE_BUTTON),$("#menu-bar").css("z-index",X.MENU_BAR_LOWERED)),$(`#mobile-menu-${s}`).addClass("active"),t=s}function r(s){let l=e[s];l&&(s==="rendering"?n.hide():(l.removeClass("mobile-overlay active"),l.find(".mobile-overlay-close").hide(),$("#menu-bar").css("z-index",X.MENU_BAR)),$(`#mobile-menu-${s}`).removeClass("active"),t===s&&(t=null))}function o(){Object.keys(e).forEach(r)}return $("#mobile-menu-controls").on("click",function(){t==="controls"?r("controls"):i("controls")}),$("#mobile-menu-rendering").on("click",function(){t==="rendering"?r("rendering"):i("rendering")}),$(".mobile-overlay-close").on("click",function(){let l=$(this).closest("[id]").attr("id"),u={controls:"controls"}[l];u&&r(u)}),{showPanel:i,hidePanel:r,hideAllPanels:o,getCurrentPanel:()=>t}}function Br(n,e){let t=document.getElementById("mobile-controls");if(!t){a.info("Mobile controls component not found, skipping sync setup");return}function i(){let o=n.get("timestep");o&&t.setTimestep(o.getValue())}$("#timestep").on("input change",i),t.onTimestepChange=o=>{let s=n.get("timestep");s&&(s.setValue(o),n.debouncedApply())},t.onFrameLimitEnabledChange=o=>{let s=n.get("frame-limit-enabled");s&&(s.setValue(o),n.debouncedApply())},t.onFrameLimitChange=o=>{let s=n.get("frame-limit");s&&(s.setValue(o),n.debouncedApply())};let r=n.webComponentRegistry;r?r.whenAllReady().then(()=>{setTimeout(()=>{i();let o=n.get("frame-limit-enabled"),s=n.get("frame-limit");o&&t.setFrameLimitEnabled(o.getValue()),s&&t.setFrameLimit(s.getValue())},100)}):a.warn("Web component registry not found on manager, mobile controls sync may not work properly")}function jr(n,e){let t=null,i=new bt({renderer:n,storageKey:"vectorFieldSettings",debounceTime:300,onApply:v=>{v.implicitIterations!==void 0&&(v.integratorParams={iterations:v.implicitIterations});let C=v.dimensions;if(C!==t){let P=i.get("dimension-inputs");P&&(P.updateInputs(C),v.expressions=P.getValue());let V=i.get("mapper-params");V&&V.updateControls(),t=C}let w=v.expressions?[...v.expressions]:null,T=v.expressions;if(delete v.expressions,n.updateConfig(v),T&&T.length>0&&window.notebook)try{new le().executeAutomated(T,window.notebook,n),a.info(`Applied ${T.length} field equations via workflow`)}catch(P){a.error("Failed to apply field equations:",P.message),io(`Failed to apply field equations: ${P.message}`);return}if(n.coordinateSystem){let P=i.get("dimension-inputs");P&&P.setCoordinateSystem(n.coordinateSystem,!1)}if(Y.isVisible()&&w&&n.coordinateSystem){let P=n.coordinateSystem.getVariableNames(),V=w.map(N=>{if(window.notebook)try{return window.notebook.expandFunctions(N)}catch(I){return a.warn(`Failed to expand "${N}" for LaTeX:`,I.message),N}return N});Y.updateEquations(V,P)}let R=i.getSettings();n&&n.bbox&&(R.bbox={min:[...n.bbox.min],max:[...n.bbox.max]}),n&&n.coordinateSystem&&(R.coordinateSystem=n.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(R)),ro()}}),r=new $t(i);i.webComponentRegistry=r,r.register("select-control","integrator");let o=document.getElementById("integrator");o&&o.addEventListener("change",()=>{let v=o.getValue(),C=v.startsWith("implicit-")||v==="trapezoidal";$("#implicit-iterations-group").toggle(C),$("#solution-method-group").toggle(C),me("#integrator",0)}),r.register("select-control","solution-method"),r.register("animatable-timestep","timestep"),r.register("animatable-slider","fade").then(v=>{v&&Promise.resolve().then(()=>(Je(),Hr)).then(C=>{let{createFadeTransform:w}=C,{transform:T,inverseTransform:R}=w();v.setCustomTransform(T,R),v.updateBoundsDisplay&&v.updateBoundsDisplay()})}),r.register("select-control","transform");let s=document.getElementById("transform");s&&s.addEventListener("change",()=>{let v=i.get("transform-params");v&&v.updateControls()}),i.register(new wt({},{settingsKey:"transformParams"})).setTransformControl(s),r.register("select-control","mapper");let c=document.getElementById("mapper");c&&c.addEventListener("change",()=>{let v=i.get("mapper-params");v&&v.updateControls()});let u=i.register(new yt({dim1:0,dim2:1},{settingsKey:"mapperParams"})),d=document.getElementById("dimensions");u.setRelatedControls(d,c),r.register("select-control","color-mode");let h=document.getElementById("color-mode");h&&h.addEventListener("change",()=>{let v=h.getValue();mi(v),pi(v),fi(v)});let p=i.register(new gt("color-expression","x * y",{settingsKey:"colorExpression"})),m=i.register(new vt(ve(),{settingsKey:"colorGradient"}));r.register("select-control","velocity-scale-mode");let f=i.register(new xt(["-y","x"],{settingsKey:"expressions"}));r.register("select-control","tonemap-operator");let b=document.getElementById("tonemap-operator");b&&b.addEventListener("change",()=>{let v=b.getValue();Xe(v)}),r.register("select-control","particle-render-mode"),r.register("linear-slider","dimensions").then(v=>{v&&(v.onChange=C=>{a.verbose("Dimensions changed to:",C);let w=i.get("dimension-inputs");w&&(a.verbose("Updating dimension inputs with dimensions:",C),w.updateInputs(C))})}),r.register("linear-slider","implicit-iterations"),r.register("linear-slider","particles"),r.register("linear-slider","drop"),r.register("linear-slider","supersample-factor"),r.register("linear-slider","bilateral-spatial"),r.register("linear-slider","bilateral-intensity"),r.register("log-slider","exposure"),r.register("log-slider","gamma"),r.register("log-slider","luminance-gamma"),r.register("log-slider","highlight-compression"),r.register("log-slider","compression-threshold"),r.register("log-slider","white-point"),r.register("log-slider","particle-intensity"),r.register("log-slider","particle-size"),r.register("log-slider","frame-limit").then(v=>{v&&(v.onChange=C=>{window.renderer&&(window.renderer.frameLimit=C)})}),r.register("percent-slider","smaa-intensity"),r.register("percent-slider","smaa-threshold"),r.register("percent-slider","color-saturation"),r.register("percent-slider","brightness-desat"),r.register("percent-slider","saturation-buildup"),r.register("percent-slider","respawn-margin"),r.register("check-box","velocity-log-scale"),r.register("check-box","show-grid"),r.register("check-box","show-equations"),r.register("check-box","frame-limit-enabled"),r.register("check-box","use-hdr"),r.register("check-box","smaa-enabled"),r.register("check-box","bilateral-enabled"),r.register("check-box","animation-clear-particles"),r.register("check-box","animation-clear-screen"),r.register("check-box","animation-smooth-timing"),r.register("check-box","animation-lock-shaders"),r.register("check-box","animation-half-loops");let x=document.getElementById("frame-limit-enabled");x&&x.addEventListener("change",()=>{window.renderer&&(window.renderer.frameLimitEnabled=x.getValue())});let g=document.getElementById("show-equations");if(g){let v=async()=>{let C=g.getValue();Y.setVisible(C),C&&await Y.refresh()};g.addEventListener("change",v)}r.register("select-control","theme-selector");let y=document.getElementById("theme-selector");y&&y.addEventListener("change",()=>{y.getValue()==="light"?$("body").addClass("light-theme"):$("body").removeClass("light-theme"),i.saveToStorage()}),$("#default-settings").on("click",function(){i.resetAll(),i.clearStorage(),i.apply()}),$("#share-url").on("click",function(){let v=i.getSettings();Ar(v)}),$("#reset").on("click",function(){let v=n.gl.canvas,T=10*(v.width/v.height);n.updateConfig({bbox:{min:[-T/2,-5],max:[T/2,5]},reinitializeParticles:!0})}),$("#reset-particles").on("click",function(){n.clearScreen()}),$("#save-image").on("click",async function(){try{let v=await n.captureRenderBuffer(),C=URL.createObjectURL(v),w=document.createElement("a"),T=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),R=`${n.renderWidth}x${n.renderHeight}`;w.download=`vector-field-${T}-${R}.png`,w.href=C,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(C),a.info("Image saved: "+w.download)}catch(v){a.error("Failed to save image:",v),alert("Failed to save image. Check console for details.")}});let S=new URLSearchParams(window.location.search).get("storage")||"float";$("#storage-strategy").val(S),$("#storage-strategy").on("change",function(){let v=$(this).val(),C=i.getSettings();n&&n.bbox&&(C.bbox={min:[...n.bbox.min],max:[...n.bbox.max]}),n&&n.coordinateSystem&&(C.coordinateSystem=n.coordinateSystem.toJSON()),localStorage.setItem("vectorFieldSettings",JSON.stringify(C));let w=new URL(window.location);w.searchParams.set("storage",v),window.location.href=w.toString()}),$(document).on("click",".slider-btn",function(){let v=$(this).data("slider"),C=$(this).data("action");if(!v){console.warn("Slider button missing data-slider attribute");return}let w=i.get(v);if(w&&w.handleButtonAction){w.handleButtonAction(C);return}if(v.startsWith("transform-param-")){let T=i.get("transform-params");T&&T.handleTransformParamButton&&T.handleTransformParamButton(v,C);return}console.warn(`No button handler found for slider: ${v}`)}),$("#configure-coordinates").on("click",function(){let v=n.dimensions,C=n.coordinateSystem;(!C||C.dimensions!==v)&&(console.warn("Coordinate system dimension mismatch, resetting to Cartesian"),C=j(v),n.coordinateSystem=C),yr(v,C,w=>{n.updateConfig({coordinateSystem:w}),f.setCoordinateSystem(w),i.apply()})});let F=Pr(i,m),E=Ir(i),L=Dr(i,n,r);Mr(i),Lr();let k=kr(E.renderingPanelManager);window.mobilePanelManager=k,Br(i,r),$(document).on("click","#menu-settings",function(){window.appModal&&window.appModal.show()}),$(document).on("click","#menu-docs",function(){window.appModal&&window.appModal.show("docs")}),$(document).on("click","#menu-notebook",function(){window.notebookEditor&&window.notebookEditor.open()}),$(document).on("keydown",function(v){(v.ctrlKey||v.metaKey)&&v.key===","&&(v.preventDefault(),window.appModal&&window.appModal.show())}),$("#animation-section-toggle").on("click",function(){let v=$("#animation-section-content"),C=$("#animation-section-arrow"),w=$("#histogram-panel"),T=$("#cursor-position");v.is(":visible")?(v.slideUp(200),C.text("\u25BC"),w.removeClass("shifted"),T.removeClass("shifted")):(v.slideDown(200),C.text("\u25B2"),w.addClass("shifted"),T.addClass("shifted"))}),i.initializeControls(),Y.initialize("equation-overlay");let A=Tr();if($e()&&(!A||A.frameLimitEnabled===void 0&&A.frameLimit===void 0)){x&&x.setValue(!0);let v=document.getElementById("frame-limit");v&&v.setValue(200),window.renderer&&(window.renderer.frameLimitEnabled=!0,window.renderer.frameLimit=200),a.info("Mobile detected: frame limit enabled at 200 frames")}r.whenAllReady().then(()=>{if(A&&(Fr(A,i,n),A.expressions&&Array.isArray(A.expressions)&&window.UnicodeAutocomplete&&(A.expressions=A.expressions.map(v=>typeof v=="string"&&window.UnicodeAutocomplete.unicodeToAscii?window.UnicodeAutocomplete.unicodeToAscii(v):v)),A.mapperParams)){let v=A.mapperParams;v.dim1!==void 0&&v.dim2!==void 0&&v.dim1===v.dim2&&(console.warn("Invalid mapper params: dim1 and dim2 are the same, fixing to default"),A.mapperParams={dim1:0,dim2:1})}r.applyWhenReady(A).then(()=>{let v=document.getElementById("animation-clear-particles"),C=document.getElementById("animation-clear-screen"),w=document.getElementById("animation-smooth-timing"),T=document.getElementById("animation-lock-shaders");if(L.setOptions({clearParticles:v?.getValue?v.getValue():!1,clearScreen:C?.getValue?C.getValue():!1,smoothTiming:w?.getValue?w.getValue():!1,lockShaders:T?.getValue?T.getValue():!1}),n){n.frameLimitEnabled=x?.getValue?x.getValue():!1;let I=document.getElementById("frame-limit");I&&(n.frameLimit=I.getValue())}Xe(i.get("tonemap-operator").getValue());let R=i.get("color-mode").getValue();mi(R),pi(R),fi(R);let P=i.get("integrator").getValue()||"rk2",V=P.startsWith("implicit-")||P==="trapezoidal";if($("#implicit-iterations-group").toggle(V),$("#solution-method-group").toggle(V),g?.getValue&&g.getValue()&&(Y.setVisible(!0),n&&n.coordinateSystem)){let I=n.expressions;if(I){let U=n.coordinateSystem.getVariableNames();Y.updateEquations(I,U)}}i.get("theme-selector").getValue()==="light"&&$("body").addClass("light-theme")})}),window.unicodeAutocomplete&&(window.unicodeAutocomplete.setEnabled(!0),window.unicodeAutocomplete.attachToAll('[id^="expr-"]'),window.unicodeAutocomplete.attachToAll("#mapper-expression"),window.unicodeAutocomplete.attachToAll("#color-expression"),window.unicodeAutocomplete.attachToAll("#custom-color-code"),window.unicodeAutocomplete.attachToAll("#custom-integrator-code"),console.log("Unicode autocomplete enabled for all math inputs"));function B(){if(!n)return;a.info("Syncing UI from renderer state");let v=document.getElementById("dimensions");if(v&&v.setValue&&n.dimensions!==void 0){let w=v.getValue();w!==n.dimensions&&(a.info(`Syncing dimensions: ${w} \u2192 ${n.dimensions}`),v.setValue(n.dimensions))}let C=i.get("dimension-inputs");if(C&&n.expressions&&(a.info("Syncing expressions from renderer:",n.expressions),C.setValue(n.expressions)),Y&&Y.isVisible&&Y.isVisible()&&n.expressions&&n.coordinateSystem){let w=n.coordinateSystem.getVariableNames();Y.updateEquations(n.expressions,w),a.info("Updated equation overlay with new expressions")}a.info("UI sync complete")}window.syncUIFromRenderer=B,window.manager=i,window.equationOverlay=Y;function z(){return Cr(i,n)}return e&&e({manager:i,state:i.getSettings(),saveSettings:z}),A&&A.bbox&&Rr(A,n),i}function io(n){$("#error-message").text(n).show()}function ro(){$("#error-message").hide()}M();M();var Xr={linear:n=>n,easeIn:n=>n*n,easeOut:n=>1-Math.pow(1-n,2),easeInOut:n=>n<.5?2*n*n:1-Math.pow(-2*n+2,2)/2,easeInCubic:n=>n*n*n,easeOutCubic:n=>1-Math.pow(1-n,3),easeInOutCubic:n=>n<.5?4*n*n*n:1-Math.pow(-2*n+2,3)/2,elastic:n=>{let e=2*Math.PI/3;return n===0?0:n===1?1:-Math.pow(2,10*n-10)*Math.sin((n*10-10.75)*e)},bounce:n=>n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},At=class{constructor(e,t){this.renderer=e,this.manager=t,this.frames=[],this.isRunning=!1,this.isPaused=!1,this.script=null}loadScript(e){if(!e.baseSettings)throw new Error("Animation script missing baseSettings");if(!e.timeline||!Array.isArray(e.timeline))throw new Error("Animation script missing timeline array");if(e.timeline.length<2)throw new Error("Timeline must have at least 2 keyframes");for(let r=1;r<e.timeline.length;r++)if(e.timeline[r].time<=e.timeline[r-1].time)throw new Error("Timeline keyframes must be sorted by time");this.script={name:e.name||"Untitled Animation",description:e.description||"",fps:e.fps||30,baseSettings:e.baseSettings,timeline:e.timeline.map(r=>({time:r.time,settings:r.settings||{},easing:r.easing||"linear",convergenceSteps:r.convergenceSteps||0})),frameConfig:{burnInSteps:e.frameConfig?.burnInSteps||5e3,clearAfterBurnIn:e.frameConfig?.clearAfterBurnIn!==void 0?e.frameConfig.clearAfterBurnIn:!0,accumulationSteps:e.frameConfig?.accumulationSteps||2e3}};let t=this.script.timeline[this.script.timeline.length-1].time,i=Math.ceil(t*this.script.fps);return a.info(`Loaded animation: ${this.script.name}`),a.info(`  Duration: ${t}s @ ${this.script.fps} fps = ${i} frames`),a.info(`  Keyframes: ${this.script.timeline.length}`),this.script}getKeyframeIndices(e){let t=this.script.timeline;if(e<=t[0].time)return{prev:0,next:0,t:0};if(e>=t[t.length-1].time)return{prev:t.length-1,next:t.length-1,t:1};for(let i=1;i<t.length;i++)if(e<=t[i].time){let r=i-1,o=i,s=(e-t[r].time)/(t[o].time-t[r].time);return{prev:r,next:o,t:s}}return{prev:t.length-1,next:t.length-1,t:1}}interpolateValue(e,t,i,r="linear"){let s=(Xr[r]||Xr.linear)(i);if(typeof e=="number"&&typeof t=="number")return e+(t-e)*s;if(Array.isArray(e)&&Array.isArray(t))return e.map((l,c)=>{let u=t[c]!==void 0?t[c]:l;return typeof l=="number"?l+(u-l)*s:s<.5?l:u});if(typeof e=="object"&&e!==null&&typeof t=="object"&&t!==null){let l={...e};for(let c in t)e[c]!==void 0?l[c]=this.interpolateValue(e[c],t[c],s,r):l[c]=t[c];return l}return s<.5?e:t}getInterpolatedSettings(e){let{prev:t,next:i,t:r}=this.getKeyframeIndices(e),o=this.script.timeline;if(t===i)return{...this.script.baseSettings,...o[t].settings};let s={...this.script.baseSettings,...o[t].settings},l={...this.script.baseSettings,...o[i].settings},c=o[i].easing,u={...s};for(let d in l)s[d]!==void 0?u[d]=this.interpolateValue(s[d],l[d],r,c):u[d]=l[d];return u}getAnimationAlpha(e){let t=this.script.timeline[this.script.timeline.length-1].time;return Math.max(0,Math.min(1,e/t))}waitFrame(){return new Promise(e=>requestAnimationFrame(e))}async captureFrame(){return this.renderer.captureRenderBuffer()}async renderAnimationFrame(e,t,i){let{frameConfig:r}=this.script,o=this.getInterpolatedSettings(e),s=this.getAnimationAlpha(e);if(a.info(`Frame ${t+1}/${i}: t=${e.toFixed(3)}s, alpha=${s.toFixed(3)}`),this.manager.setSettings(o),this.renderer.setAnimationAlpha(s),await this.waitFrame(),this.renderer.clearRenderBuffer(),this.renderer.resetParticles(),r.burnInSteps>0&&(a.verbose(`  Burn-in: ${r.burnInSteps} steps`),this.renderer.step(r.burnInSteps)),r.clearAfterBurnIn&&this.renderer.clearRenderBuffer(),r.accumulationSteps>0){a.verbose(`  Accumulation: ${r.accumulationSteps} steps`);for(let c=0;c<r.accumulationSteps;c++)this.renderer.updatePositions(),this.renderer.drawParticles(),this.renderer.fadeScreen()}return this.renderer.render(),await this.waitFrame(),await this.captureFrame()}async run(e){if(this.isRunning)throw new Error("Animation already running");if(!this.script)throw new Error("No animation script loaded");this.isRunning=!0,this.isPaused=!1,this.frames=[];let t=this.script.timeline[this.script.timeline.length-1].time,i=Math.ceil(t*this.script.fps);try{a.info("Applying base settings...");let r={...this.script.baseSettings};if(delete r.coordinateSystem,this.manager.setSettings(r),this.script.baseSettings.coordinateSystem){let{CoordinateSystem:o}=await Promise.resolve().then(()=>(ae(),cr)),s=o.fromJSON(this.script.baseSettings.coordinateSystem);this.renderer.coordinateSystem=s,a.info(`Set coordinate system: ${s.name}`),this.renderer.compileShaders(),a.info("Shaders recompiled with coordinate system")}await this.waitFrame();for(let o=0;o<i;o++){for(;this.isPaused&&this.isRunning;)await new Promise(c=>setTimeout(c,100));if(!this.isRunning){a.info("Animation stopped");break}let s=o/this.script.fps,l=await this.renderAnimationFrame(s,o,i);this.frames.push({frameNum:o,time:s,blob:l,timestamp:Date.now()}),e&&e(o+1,i,s)}return a.info(`Animation complete: ${this.frames.length} frames captured`),this.frames}catch(r){throw a.error("Animation failed:",r),r}finally{this.isRunning=!1}}pause(){this.isPaused=!0}resume(){this.isPaused=!1}stop(){this.isRunning=!1,this.isPaused=!1}async downloadFrames(){if(this.frames.length===0)throw new Error("No frames to download");return window.JSZip?await this.downloadAsZip():await this.downloadIndividually()}async downloadAsZip(){let e=window.JSZip,t=new e;for(let{frameNum:s,blob:l}of this.frames){let c=`frame_${String(s).padStart(6,"0")}.png`;t.file(c,l)}let i={script:this.script,captureDate:new Date().toISOString(),frameCount:this.frames.length};t.file("metadata.json",JSON.stringify(i,null,2)),a.info("Generating ZIP archive...");let r=await t.generateAsync({type:"blob"}),o=`${this.script.name.replace(/\s+/g,"_")}.zip`;this.downloadBlob(r,o),a.info(`Downloaded ${o}`)}async downloadIndividually(){for(let{frameNum:e,blob:t}of this.frames){let i=`frame_${String(e).padStart(6,"0")}.png`;this.downloadBlob(t,i),await new Promise(r=>setTimeout(r,100))}a.info(`Downloaded ${this.frames.length} frames`)}downloadBlob(e,t){let i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}};se();var oe=class{constructor(e,t){this.id=e,this.title=t,this._isRendered=!1,this._isActive=!1,this._contentElement=null}get isRendered(){return this._isRendered}get isActive(){return this._isActive}render(e){throw new Error("Tab subclass must implement render() method")}onActivate(){}onDeactivate(){}_activate(e){this._isRendered||(this._contentElement=this.render(e),this._isRendered=!0),this._contentElement&&(this._contentElement.style.display="block"),this._isActive=!0,this.onActivate()}_deactivate(){this._contentElement&&(this._contentElement.style.display="none"),this._isActive=!1,this.onDeactivate()}destroy(){this._contentElement&&this._contentElement.parentNode&&this._contentElement.parentNode.removeChild(this._contentElement),this._contentElement=null,this._isRendered=!1,this._isActive=!1}},Ft=class{constructor(){this._tabs=new Map,this._activeTab=null,this._tabBarElement=null,this._contentElement=null}register(e){if(!(e instanceof oe))throw new Error("Tab must be an instance of Tab class");if(this._tabs.has(e.id))throw new Error(`Tab with id '${e.id}' already registered`);this._tabs.set(e.id,e),this._tabBarElement&&this._addTabButton(e)}unregister(e){let t=this._tabs.get(e);if(t&&(t===this._activeTab&&(this._activeTab=null),t.destroy(),this._tabs.delete(e),this._tabBarElement)){let i=this._tabBarElement.querySelector(`[data-tab-id="${e}"]`);i&&i.remove()}}activate(e){let t=this._tabs.get(e);return t?(this._activeTab&&this._activeTab!==t&&(this._activeTab._deactivate(),this._updateTabButton(this._activeTab.id,!1)),this._activeTab=t,t._activate(this._contentElement),this._updateTabButton(e,!0),!0):(console.warn(`Tab '${e}' not found`),!1)}getActiveTab(){return this._activeTab}getAllTabs(){return Array.from(this._tabs.values())}initializeUI(e,t){this._tabBarElement=e,this._contentElement=t;for(let i of this._tabs.values())this._addTabButton(i)}_addTabButton(e){if(!this._tabBarElement)return;let t=document.createElement("button");t.className="modal-tab-button",t.textContent=e.title,t.dataset.tabId=e.id,t.addEventListener("click",()=>{this.activate(e.id)}),this._tabBarElement.appendChild(t)}_updateTabButton(e,t){if(!this._tabBarElement)return;let i=this._tabBarElement.querySelector(`[data-tab-id="${e}"]`);i&&(t?i.classList.add("active"):i.classList.remove("active"))}destroy(){for(let e of this._tabs.values())e.destroy();this._tabs.clear(),this._activeTab=null,this._tabBarElement=null,this._contentElement=null}};var Ti=class{constructor(){this.tabManager=new Ft,this._modalElement=null,this._isVisible=!1,this._onCloseCallback=null,this._wasPaused=!1}initialize(){if(this._modalElement=document.getElementById("modal-overlay"),!this._modalElement){console.error("Modal overlay element not found");return}let e=document.getElementById("modal-tab-bar"),t=document.getElementById("modal-content");if(!e||!t){console.error("Modal tab bar or content element not found");return}this.tabManager.initializeUI(e,t);let i=document.getElementById("modal-close");i&&i.addEventListener("click",()=>this.hide()),this._modalElement.addEventListener("click",r=>{r.target===this._modalElement&&this.hide()}),document.addEventListener("keydown",r=>{r.key==="Escape"&&this._isVisible&&this.hide()})}registerTab(e){this.tabManager.register(e)}show(e=null,t=null){if(!this._modalElement){console.error("Modal not initialized");return}if(!e){let i=this.tabManager.getAllTabs();i.length>0&&(e=i[0].id)}if(e&&(this.tabManager.activate(e),t)){let i=this.tabManager.getAllTabs().find(r=>r.id===e);i&&typeof i.openToSection=="function"&&(i.isRendered?i.openToSection(t):typeof i.setPendingSection=="function"&&i.setPendingSection(t))}this._modalElement.style.display="flex",this._isVisible=!0,document.body.style.overflow="hidden",window.renderer&&window.renderer.isRunning?(window.renderer.stop(),this._wasPaused=!1):this._wasPaused=!0}hide(){this._modalElement&&(this._modalElement.style.display="none",this._isVisible=!1,document.body.style.overflow="",window.renderer&&!this._wasPaused&&window.renderer.start(),this._onCloseCallback&&this._onCloseCallback())}isVisible(){return this._isVisible}onClose(e){this._onCloseCallback=e}getActiveTab(){return this.tabManager.getActiveTab()}},Si=null;function no(){return Si||(Si=new Ti),Si}function qr(){let n=no();return n.initialize(),n}var Rt=class extends oe{constructor(){super("notebook-debug","Notebook Debug"),this.contextTextarea=null,this.refreshButton=null}render(e){let t=document.createElement("div");return t.id="notebook-debug-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div class="info" style="margin-bottom: 16px;">
                Debug view of the current notebook context. Shows all defined functions and cells.
            </div>

            <h4 style="margin: 0 0 8px 0; padding: 0; font-size: 14px; color: #4CAF50;">Notebook Context</h4>
            <div class="control-group">
                <textarea id="notebook-debug-context"
                    readonly
                    rows="20"
                    style="width: 100%; font-family: 'Courier New', monospace; font-size: 11px; background: #0a0a0a; color: #4CAF50; border: 1px solid #444; border-radius: 4px; padding: 10px; resize: vertical;"></textarea>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="refresh-notebook-debug" style="padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    Refresh Context
                </button>
            </div>
        `,e.appendChild(t),this.contextTextarea=t.querySelector("#notebook-debug-context"),this.refreshButton=t.querySelector("#refresh-notebook-debug"),this.refreshButton.addEventListener("click",()=>this._refreshContext()),this._refreshContext(),t}onActivate(){this._refreshContext()}_refreshContext(){if(this.contextTextarea)try{if(!window.notebook){this.contextTextarea.value="Error: Notebook not initialized";return}let e=window.notebook,t=e.cells||[],i=`Notebook Context (${t.length} cells)
`;i+="=".repeat(60)+`

`,t.length===0?i+=`(No cells defined)
`:t.forEach((r,o)=>{i+=`Cell ${o+1} [${r.type}]:
`,i+=`  ID: ${r.id}
`,i+=`  Input: ${r.input||"(empty)"}
`,r.output&&(i+=`  Output: ${r.output}
`),r.error&&(i+=`  Error: ${r.error}
`),i+=`
`}),i+="=".repeat(60)+`
`,i+=`CAS Engine:
`,e.casEngine?i+=`  Name: ${e.casEngine.getName()}
`:i+=`  (Not available)
`,this.contextTextarea.value=i}catch(e){this.contextTextarea.value=`Error refreshing context: ${e.message}`,console.error("Error refreshing notebook debug context:",e)}}};var Lt=class extends oe{constructor(e){super("debug","Debug Console"),this.logger=e,this.debugToggle=null,this.debugVerbosity=null,this.debugOutput=null,this.bufferSizeSpan=null,this.bufferPercentSpan=null,this.bufferStatusDiv=null}render(e){let t=document.createElement("div");t.id="debug-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="debug-toggle" checked style="margin-right: 8px;">
                    <span style="font-weight: bold;">Enable Debug Logging</span>
                </label>
            </div>

            <div id="debug-controls" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                <select id="debug-verbosity" style="flex: 0 0 auto;">
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                    <option value="verbose">Verbose</option>
                    <option value="warn">Warnings Only</option>
                    <option value="error">Errors Only</option>
                    <option value="silent">Silent (Buffer)</option>
                </select>
                <button id="debug-log-update-shader" class="secondary" style="padding: 4px 8px;" title="Particle integration shader (updates positions each frame)">Update Shader</button>
                <button id="debug-log-draw-shader" class="secondary" style="padding: 4px 8px;" title="Particle rendering shaders (vertex + fragment for color/display)">Draw Shaders</button>
                <button id="debug-log-screen-shader" class="secondary" style="padding: 4px 8px;" title="Screen fade shader (trail decay)">Fade Shader</button>
                <button id="debug-log-stats-shaders" class="secondary" style="padding: 4px 8px;" title="Velocity statistics shader (max velocity tracking)">Velocity Stats</button>
                <button id="debug-buffer-stats" class="secondary" style="padding: 4px 8px;">Buffer Stats</button>
                <button id="debug-copy" class="secondary" style="padding: 4px 8px;">Copy Log</button>
                <button id="debug-clear" class="secondary" style="padding: 4px 8px;">Clear</button>
            </div>

            <div id="debug-buffer-status" style="display: none; padding: 8px; background: #2a2a2a; border-radius: 4px; margin-bottom: 12px; font-size: 11px; color: #888;">
                <span style="color: #FFA726; font-weight: bold;">SILENT MODE:</span>
                Buffering <span id="buffer-size" style="color: #4CAF50;">0</span> logs
                (<span id="buffer-percent">0</span>% of max)
                <button id="debug-flush-buffer" class="secondary" style="padding: 2px 6px; margin-left: 8px; font-size: 10px;">Flush Buffer</button>
                <button id="debug-clear-buffer" class="secondary" style="padding: 2px 6px; margin-left: 4px; font-size: 10px;">Clear Buffer</button>
            </div>

            <div style="padding: 8px; margin-bottom: 12px; background: #1f1f1f; border-radius: 4px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px; margin-bottom: 8px;" title="Enable particle sampling and detailed logging (expensive GPU readback). Buffer stats for tone mapping are always enabled but optimized.">
                    <input type="checkbox" id="debug-enable-stats" style="margin-right: 6px;">
                    <span>Enable Particle Sampling (expensive GPU readback)</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px;" title="Show file name and line number for each log entry (extracts caller info from stack trace)">
                    <input type="checkbox" id="debug-show-line-numbers" style="margin-right: 6px;">
                    <span>Show Line Numbers (file:line)</span>
                </label>
            </div>

            <div id="debug-output" style="background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 12px; height: calc(100vh - 450px); overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;"></div>
        `,e.appendChild(t),this.debugToggle=t.querySelector("#debug-toggle"),this.debugVerbosity=t.querySelector("#debug-verbosity"),this.debugOutput=t.querySelector("#debug-output"),this.bufferSizeSpan=t.querySelector("#buffer-size"),this.bufferPercentSpan=t.querySelector("#buffer-percent"),this.bufferStatusDiv=t.querySelector("#debug-buffer-status"),this._setupEventListeners(t),this.logger.setEnabled(this.debugToggle.checked);let i=this.debugVerbosity.value;this.logger.setVerbosity(i),i==="silent"&&(this.bufferStatusDiv.style.display="block",this._updateBufferStatus()),this.logger.setOutputElement(this.debugOutput);let r=localStorage.getItem("debugShowLineNumbers")==="true",o=t.querySelector("#debug-show-line-numbers");return o&&(o.checked=r,this.logger.setShowLineNumbers(r)),t}_setupEventListeners(e){this.debugToggle.addEventListener("change",()=>{this.logger.setEnabled(this.debugToggle.checked),this.logger.info("Debug logging "+(this.debugToggle.checked?"enabled":"disabled"))}),this.debugVerbosity.addEventListener("change",()=>{let t=this.debugVerbosity.value;this.logger.setVerbosity(t),this.logger.info("Verbosity set to: "+t),t==="silent"?(this.bufferStatusDiv.style.display="block",this._updateBufferStatus()):this.bufferStatusDiv.style.display="none"}),e.querySelector("#debug-copy").addEventListener("click",()=>{let t=this.logger.getLogs(),i=`N-Dimensional Vector Field Renderer - Debug Log
`;i+="=".repeat(60)+`

`;for(let r of t){if(i+=`[${r.timestamp}] [${r.level.toUpperCase()}] ${r.message}`,r.data){let o=typeof r.data=="object"?JSON.stringify(r.data):String(r.data);i+=` | Data: ${o}`}r.stack&&(i+=`
Stack Trace:
${r.stack}`),i+=`
`}navigator.clipboard.writeText(i).then(()=>{this.logger.info("Log copied to clipboard ("+t.length+" entries)")}).catch(r=>{this.logger.error("Failed to copy log to clipboard",r)})}),e.querySelector("#debug-clear").addEventListener("click",()=>{this.logger.clear()}),e.querySelector("#debug-flush-buffer").addEventListener("click",()=>{this.logger.flush(),this._updateBufferStatus()}),e.querySelector("#debug-clear-buffer").addEventListener("click",()=>{this.logger.clearSilencedBuffer(),this._updateBufferStatus()}),e.querySelector("#debug-show-line-numbers").addEventListener("change",t=>{this.logger.setShowLineNumbers(t.target.checked),this.logger.info("Line numbers "+(t.target.checked?"enabled":"disabled")),this.logger.updateUI()}),e.querySelector("#debug-log-update-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logUpdateShader=="function"?window.renderer.logUpdateShader():this.logger.warn("Renderer not initialized - cannot log update shader")}),e.querySelector("#debug-log-draw-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logDrawShader=="function"?window.renderer.logDrawShader():this.logger.warn("Renderer not initialized - cannot log draw shader")}),e.querySelector("#debug-log-screen-shader").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logScreenShader=="function"?window.renderer.logScreenShader():this.logger.warn("Renderer not initialized - cannot log screen shader")}),e.querySelector("#debug-log-stats-shaders").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logStatsShaders=="function"?window.renderer.logStatsShaders():this.logger.warn("Renderer not initialized - cannot log stats shaders")}),e.querySelector("#debug-buffer-stats").addEventListener("click",()=>{window.renderer&&typeof window.renderer.logBufferStats=="function"?window.renderer.logBufferStats():this.logger.warn("Renderer not initialized - cannot log buffer stats")}),e.querySelector("#debug-enable-stats").addEventListener("change",t=>{if(window.renderer){let i=t.target.checked;window.renderer.enableDebugStats=i,this.logger.info(`GPU debug stats ${i?"ENABLED":"DISABLED"}`)}})}_updateBufferStatus(){let e=this.logger.getBufferStats();this.bufferSizeSpan.textContent=e.bufferSize,this.bufferPercentSpan.textContent=e.bufferUsagePercent,e.bufferUsagePercent>80?this.bufferSizeSpan.style.color="#EF5350":e.bufferUsagePercent>50?this.bufferSizeSpan.style.color="#FFA726":this.bufferSizeSpan.style.color="#4CAF50"}onActivate(){this._bufferUpdateInterval||(this._bufferUpdateInterval=setInterval(()=>{this.logger.isSilenced()&&this._isActive&&this._updateBufferStatus()},1e3))}onDeactivate(){this._bufferUpdateInterval&&(clearInterval(this._bufferUpdateInterval),this._bufferUpdateInterval=null)}destroy(){this._bufferUpdateInterval&&(clearInterval(this._bufferUpdateInterval),this._bufferUpdateInterval=null),super.destroy()}};var Mt=class extends oe{constructor(){super("docs","Documentation"),this.sections=[],this.sectionDefinitions=[{id:"display-options",title:"Display Options & UI Controls",file:"docs/display-options.md"},{id:"vector-fields",title:"Vector Fields",file:"docs/vector-fields.md"},{id:"integrators",title:"Integration Methods",file:"docs/integrators.md"},{id:"color-modes",title:"Color Modes",file:"docs/color-modes.md"},{id:"projection",title:"2D Projection",file:"docs/projection.md"},{id:"coordinate-systems",title:"Coordinate Systems",file:"docs/coordinate-systems.md"},{id:"domain-transforms",title:"Domain Transforms",file:"docs/domain-transforms.md"},{id:"hdr-rendering",title:"HDR & Tone Mapping",file:"docs/hdr-rendering.md"},{id:"rendering-effects",title:"Rendering Effects",file:"docs/rendering-effects.md"},{id:"particle-settings",title:"Particle Settings",file:"docs/particle-settings.md"},{id:"animation",title:"Animation System",file:"docs/animation.md"},{id:"preset-management",title:"Preset Management",file:"docs/preset-management.md"},{id:"storage-strategy",title:"Storage Strategy",file:"docs/storage-strategy.md"},{id:"keyboard-shortcuts",title:"Keyboard Shortcuts",file:"docs/keyboard-shortcuts.md"}]}async _loadMarkdown(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.statusText}`);let i=await t.text();return typeof marked>"u"?(console.error("marked.js not loaded"),"<p>Error: Markdown parser not available</p>"):marked.parse(i)}catch(t){return console.error("Error loading markdown:",t),`<p>Error loading documentation: ${t.message}</p>`}}render(e){let t=document.createElement("div");return t.id="docs-tab-content",t.className="modal-tab-content",t.style.display="none",t.innerHTML=`
            <div class="docs-container">
                <p style="text-align: center; padding: 40px; color: #888;">Loading documentation...</p>
            </div>
        `,e.appendChild(t),this._loadAllSections(t),t}async _loadAllSections(e){let t=e.querySelector(".docs-container"),i=this.sectionDefinitions.map(async s=>{let l=await this._loadMarkdown(s.file);return{id:s.id,title:s.title,html:l}}),o=(await Promise.all(i)).map(s=>this._renderSection(s.id,s.title,s.html)).join("");t.innerHTML=o,this._setupCollapsibles(e),this._pendingSection&&(this.openToSection(this._pendingSection),this._pendingSection=null)}_renderSection(e,t,i){return`
            <div class="docs-section collapsed" id="docs-${e}">
                <div class="docs-section-header">
                    <h3>${t}</h3>
                    <span class="docs-toggle">\u25B6</span>
                </div>
                <div class="docs-section-content" style="max-height: 0;">
                    ${i}
                </div>
            </div>
        `}_setupCollapsibles(e){e.querySelectorAll(".docs-section-header").forEach(i=>{i.addEventListener("click",()=>{let r=i.parentElement,o=r.querySelector(".docs-section-content"),s=i.querySelector(".docs-toggle");r.classList.contains("collapsed")?(r.classList.remove("collapsed"),o.style.maxHeight="5000px",s.textContent="\u25BC",setTimeout(()=>{r.classList.contains("collapsed")||(o.style.maxHeight=o.scrollHeight+"px")},350)):(r.classList.add("collapsed"),o.style.maxHeight="0",s.textContent="\u25B6")})})}openToSection(e){if(!this._contentElement)return;let t=this._contentElement.querySelector(`#docs-${e}`);if(!t){console.warn(`Documentation section '${e}' not found`);return}t.classList.contains("collapsed")&&t.querySelector(".docs-section-header").click(),setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"start"})},400)}onActivate(){this._pendingSection&&(this.openToSection(this._pendingSection),this._pendingSection=null)}setPendingSection(e){this._pendingSection=e}};ce();Te();ce();var Ye=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:1,minValue:.01,maxValue:100}),this._displayFormat=null,this.sliderInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Value",this.minValue=this.getNumberAttribute("min-value",.01),this.maxValue=this.getNumberAttribute("max-value",100),this.transform=this.getNumberAttribute("transform",1),this.curve=this.getNumberAttribute("curve",1),this.defaultValue=this.getNumberAttribute("default",1);let e=this.getAttribute("display-format");if(e!==null){let t=parseInt(e);this._displayFormat=i=>i!=null?i.toFixed(t):"0"}else this._displayFormat=t=>t!=null?t.toFixed(3):"0";this.value=this.defaultValue}formatValue(e){return this._displayFormat&&typeof e=="number"?this._displayFormat(e):super.formatValue(e)}linearToLog(e){let t=e/100,r=Math.pow(t,this.curve)*100,o=Math.log(this.minValue),l=(Math.log(this.maxValue)-o)/100;return Math.exp(o+l*r)}logToLinear(e){let t=Math.log(this.minValue),r=(Math.log(this.maxValue)-t)/100,s=(Math.log(e)-t)/r/100;return Math.pow(s,1/this.curve)*100}attachInternalListeners(){if(this.sliderInput=this.findByRole("slider",'input[type="range"]'),!this.sliderInput)return;let e=()=>{let t=parseFloat(this.sliderInput.value);this.value=this.linearToLog(t)/this.transform,this.triggerChange()};this.addInputListener(this.sliderInput,e),this.sliderInput.addEventListener("change",e),this.sliderInput.addEventListener("click",t=>{e()}),this.registerActionButtons(["decrease","increase","decrease-large","increase-large","reset"])}getValue(){if(this.sliderInput){let e=parseFloat(this.sliderInput.value);return this.linearToLog(e)/this.transform}return this.value}setValue(e){if(this.value=e,this.sliderInput){let t=this.logToLinear(e*this.transform);this.sliderInput.value=t}}handleButtonAction(e){if(!this.sliderInput)return!1;let t=parseFloat(this.sliderInput.value),i=t,r=1;if((e==="increase-large"||e==="decrease-large")&&(r=10),e==="increase"||e==="increase-large")i=Math.min(100,t+r);else if(e==="decrease"||e==="decrease-large")i=Math.max(0,t-r);else if(e==="reset")i=this.logToLinear(this.defaultValue);else return!1;return i!==t?(this.sliderInput.value=i,this.value=this.linearToLog(i)/this.transform,this.triggerChange(),!0):!1}};Te();var pe=class extends Q{constructor(){super(),this.transform=100,this._displayMultiplier=100,this._displaySuffix="%"}initializeProperties(){super.initializeProperties(),this.transform=100,this.hasAttribute("display-multiplier")||(this._displayMultiplier=100),this.hasAttribute("display-suffix")||(this._displaySuffix="%")}};Je();Je();var Ke=class extends ue{constructor(){super(),this.smallIncrement=.001,this.largeIncrement=.01}initializeProperties(){super.initializeProperties();let e=this.getAttribute("small-increment"),t=this.getAttribute("large-increment");e!==null&&(this.smallIncrement=parseFloat(e)),t!==null&&(this.largeIncrement=parseFloat(t))}handleButtonAction(e){let t=this.getValue(),i=this.min||0,r=this.max||100,o;if(e==="increase"||e==="decrease")o=this.smallIncrement;else if(e==="increase-large"||e==="decrease-large")o=this.largeIncrement;else if(e==="reset"){let l=this.defaultValue;return l!==t?(this.setValue(l),this.triggerChange(),!0):!1}else return!1;let s=t;return e==="increase"||e==="increase-large"?s=Math.min(r,t+o):(e==="decrease"||e==="decrease-large")&&(s=Math.max(i,t-o)),s!==t?(this.setValue(s),this.triggerChange(),!0):!1}};var Ce=class extends pe{constructor(){super(),this._controller=null,this._animateButton=null,this._isAnimating=!1}setController(e){this._controller=e,this._controller&&this._controller.onAlphaChanged(t=>{this.value=t,this.sliderInput&&(this.sliderInput.value=t*this.transform)})}connectedCallback(){super.connectedCallback(),this._renderAnimateButton()}_renderAnimateButton(){let e=this.querySelector(".slider-control");if(!e){console.warn("AnimationAlpha: No .slider-control found in template");return}this._animateButton=document.createElement("button"),this._animateButton.className="slider-btn",this._animateButton.style.marginLeft="8px",this._animateButton.style.background="#4CAF50",this._animateButton.style.color="white",this._animateButton.title="Auto-animate",this._animateButton.textContent="\u25B6",this._animateButton.addEventListener("click",t=>{t.stopPropagation(),this._handleAnimateClick()}),e.appendChild(this._animateButton)}_handleAnimateClick(){if(!this._controller){console.warn("AnimationAlpha: No controller set");return}this._isAnimating?(this._controller.stop(),this._isAnimating=!1,this._animateButton.textContent="\u25B6",this._animateButton.style.background="#4CAF50",this._animateButton.title="Auto-animate"):(this._controller.start(),this._isAnimating=!0,this._animateButton.textContent="\u23F8",this._animateButton.style.background="#FFA726",this._animateButton.title="Stop auto-animate")}_handleValueChange(){super._handleValueChange(),this._controller&&!this._isAnimating&&this._controller.setAlpha(this.value)}};customElements.define("animation-alpha",Ce);Te();var Ae=class extends Q{constructor(){super(),this._controller=null}setController(e){this._controller=e,this._controller&&this.value&&this._controller.setSpeed(this.value)}attachInternalListeners(){super.attachInternalListeners(),this.addEventListener("change",()=>{this._controller&&this._controller.setSpeed(this.value)})}saveToSettings(e){}restoreFromSettings(e){}};customElements.define("animation-speed",Ae);ce();var Fe=class extends H{constructor(){super(),this.createReactiveProperties({label:"Value",value:100}),this.numberInput=null,this._min=1,this._max=1e4}initializeProperties(){this.label=this.getAttribute("label")||"Value",this._min=this.getNumberAttribute("min",1),this._max=this.getNumberAttribute("max",1e4),this.defaultValue=this.getNumberAttribute("default",100),this.value=this.defaultValue}attachInternalListeners(){this.numberInput=this.findByRole("input",'input[type="number"]'),this.numberInput&&(this.numberInput.setAttribute("min",this._min),this.numberInput.setAttribute("max",this._max),this.addInputListener(this.numberInput,()=>{let e=parseInt(this.numberInput.value);this.value=isNaN(e)?this.defaultValue:Math.max(this._min,Math.min(this._max,e)),this.triggerChange()}))}getValue(){if(this.numberInput){let e=parseInt(this.numberInput.value);return isNaN(e)?this.defaultValue:Math.max(this._min,Math.min(this._max,e))}return this.value}setValue(e){let t=typeof e=="number"?e:parseInt(e);this.value=isNaN(t)?this.defaultValue:Math.max(this._min,Math.min(this._max,t)),this.numberInput&&(this.numberInput.value=this.value)}reset(){this.setValue(this.defaultValue),this.triggerChange()}saveToSettings(e){}restoreFromSettings(e){}};customElements.define("number-input",Fe);var Re=class extends HTMLElement{constructor(){super(),this._label="Action",this._icon="",this._enabled=!0,this._loading=!1,this._button=null}connectedCallback(){this._label=this.getAttribute("label")||"Action",this._icon=this.getAttribute("icon")||"",this._button=document.createElement("button"),this._button.className="action-btn",this._updateButtonText(),this._button.addEventListener("click",e=>{this._enabled&&!this._loading&&this.dispatchEvent(new CustomEvent("action",{bubbles:!0}))}),this.appendChild(this._button)}_updateButtonText(){if(!this._button)return;let e=this._icon?`${this._icon} ${this._label}`:this._label;this._button.textContent=e}setLabel(e){this._label=e,this._updateButtonText()}setIcon(e){this._icon=e,this._updateButtonText()}setEnabled(e){this._enabled=e,this._button&&(this._button.disabled=!e)}setLoading(e,t=null){if(this._loading=e,this._button)if(this._button.disabled=e,e&&t){let i=this._label;this._label=t,this._updateButtonText(),this._originalLabel=i}else!e&&this._originalLabel&&(this._label=this._originalLabel,this._updateButtonText(),delete this._originalLabel)}setStyle(e){this._button&&(this._button.style.background=e)}isEnabled(){return this._enabled&&!this._loading}isLoading(){return this._loading}};customElements.define("action-button",Re);ce();var Le=class extends H{constructor(){super(),this.createReactiveProperties({label:"Checkbox",checked:!1}),this.checkboxInput=null}initializeProperties(){this.label=this.getAttribute("label")||"Checkbox",this.defaultValue=this.getBooleanAttribute("default",!1),this.checked=this.defaultValue}attachInternalListeners(){this.checkboxInput=this.findByRole("checkbox",'input[type="checkbox"]'),this.checkboxInput||(this._createDefaultTemplate(),this.checkboxInput=this.querySelector('input[type="checkbox"]')),this.checkboxInput&&(this.checkboxInput.checked=this.checked,this.checkboxInput.addEventListener("change",()=>{this.checked=this.checkboxInput.checked,this.triggerChange(),this.dispatchEvent(new Event("change",{bubbles:!0}))}))}_createDefaultTemplate(){let e=document.createElement("label");e.style.cssText="display: flex; align-items: center; cursor: pointer; padding: 4px 0;";let t=document.createElement("input");t.type="checkbox",t.style.marginRight="8px";let i=document.createElement("span");i.textContent=this.label,e.appendChild(t),e.appendChild(i),this.appendChild(e)}getValue(){return this.checkboxInput?this.checkboxInput.checked:this.checked}setValue(e){this.checked=!!e,this.checkboxInput&&(this.checkboxInput.checked=this.checked)}set disabled(e){this.checkboxInput&&(this.checkboxInput.disabled=e)}get disabled(){return this.checkboxInput?this.checkboxInput.disabled:!1}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};customElements.define("check-box",Le);ce();var Me=class extends H{constructor(){super(),this.selectElement=null}initializeProperties(){this.defaultValue=this.getAttribute("default")||null}attachInternalListeners(){if(this.selectElement=this.querySelector("select"),this.selectElement||(this._wrapOptionsInSelect(),this.selectElement=this.querySelector("select")),!!this.selectElement){if(!this.defaultValue){let e=this.selectElement.querySelector("option[selected]");if(e)this.defaultValue=e.value;else{let t=this.selectElement.querySelector("option");t&&(this.defaultValue=t.value)}}this.defaultValue&&(this.selectElement.value=this.defaultValue),this.selectElement.addEventListener("change",()=>{this.triggerChange(),this.dispatchEvent(new Event("change",{bubbles:!0}))})}}_wrapOptionsInSelect(){let e=this.querySelectorAll(":scope > option, :scope > optgroup");if(e.length===0)return;let t=document.createElement("select");for(let i of Array.from(e))t.appendChild(i);this.appendChild(t)}getValue(){return this.selectElement?this.selectElement.value:this.defaultValue}setValue(e){this.selectElement&&(this.selectElement.value=e)}set disabled(e){this.selectElement&&(this.selectElement.disabled=e)}get disabled(){return this.selectElement?this.selectElement.disabled:!1}getSelectedText(){return this.selectElement&&this.selectElement.selectedOptions.length>0?this.selectElement.selectedOptions[0].text:""}saveToSettings(e){this.settingsKey&&(e[this.settingsKey]=this.getValue())}restoreFromSettings(e){e&&this.settingsKey&&e[this.settingsKey]!=null&&this.setValue(e[this.settingsKey])}};customElements.define("select-control",Me);ce();Ct();var Pt=class extends We(H,$i,Ei){constructor(){super(),this._defaultValue={timestep:.01,frameLimitEnabled:!0,frameLimit:200},this._timestepCurve=.4,this._fps="--",this._timestep=this._defaultValue.timestep,this._timestepLog=Math.log10(this._timestep),this._frameLimitEnabled=this._defaultValue.frameLimitEnabled,this._frameLimit=this._defaultValue.frameLimit}static get observedAttributes(){return["settings-key","default-timestep","default-frame-limit","default-frame-limit-enabled"]}initializeProperties(){this.hasAttribute("default-timestep")&&(this._defaultValue.timestep=parseFloat(this.getAttribute("default-timestep")),this._timestep=this._defaultValue.timestep,this._timestepLog=Math.log10(this._timestep)),this.hasAttribute("default-frame-limit")&&(this._defaultValue.frameLimit=parseInt(this.getAttribute("default-frame-limit")),this._frameLimit=this._defaultValue.frameLimit),this.hasAttribute("default-frame-limit-enabled")&&(this._defaultValue.frameLimitEnabled=this.getAttribute("default-frame-limit-enabled")==="true",this._frameLimitEnabled=this._defaultValue.frameLimitEnabled)}connectedCallback(){this._initialized||(this.initializeControlProperties(),this.initializeProperties(),this.render(),this.initializeChildren(),this.attachInternalListeners(),this.updateTheme(),this._themeObserver=new MutationObserver(()=>this.updateTheme()),this._themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]}),this._initialized=!0)}initializeChildren(){this.registerChildControl("timestep",()=>this._timestep,e=>this.setTimestep(e),()=>this.setTimestep(this._defaultValue.timestep)),this.registerChildControl("frameLimitEnabled",()=>this._frameLimitEnabled,e=>this.setFrameLimitEnabled(e),()=>this.setFrameLimitEnabled(this._defaultValue.frameLimitEnabled)),this.registerChildControl("frameLimit",()=>this._frameLimit,e=>this.setFrameLimit(e),()=>this.setFrameLimit(this._defaultValue.frameLimit))}disconnectedCallback(){this._themeObserver&&this._themeObserver.disconnect()}updateTheme(){document.body.classList.contains("light-theme")?this.classList.add("light-theme"):this.classList.remove("light-theme")}render(){this.renderToShadow(`
            <style>
                :host {
                    display: block;
                }

                .container {
                    background: rgba(30, 30, 30, 0.9);
                    border: 1px solid #444;
                    border-radius: 4px;
                    padding: 6px 8px;
                    font-size: 10px;
                    color: #4CAF50;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                }

                :host(.light-theme) .container {
                    background: rgba(255, 255, 255, 0.9);
                    border-color: #ccc;
                    color: #2E7D32;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                }

                .fps-display {
                    text-align: right;
                    font-weight: bold;
                    margin-bottom: 3px;
                    font-size: 10px;
                }

                .controls-grid {
                    display: grid;
                    grid-template-columns: 1fr 1px 1fr;
                    gap: 6px;
                    align-items: start;
                }

                .divider {
                    width: 1px;
                    height: 100%;
                    background: #444;
                    justify-self: center;
                }

                :host(.light-theme) .divider {
                    background: #ccc;
                }

                /* Timestep section */
                .timestep-section {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                    min-width: 0; /* Allow grid to shrink this properly */
                }

                .timestep-label {
                    font-size: 11px;
                    font-weight: bold;
                    text-align: center;
                    /* Inherits color from .container (#4CAF50 or #2E7D32) */
                }

                .timestep-controls {
                    display: flex;
                    align-items: center;
                    gap: 3px;
                }

                .btn {
                    padding: 0px 4px;
                    font-size: 11px;
                    min-width: 20px;
                    height: 20px;
                    line-height: 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid #555;
                    border-radius: 2px;
                    color: #fff;
                    cursor: pointer;
                    flex-shrink: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .btn:active {
                    background: rgba(255, 255, 255, 0.2);
                }

                :host(.light-theme) .btn {
                    background: rgba(0, 0, 0, 0.05);
                    border-color: #bbb;
                    color: #333;
                }

                :host(.light-theme) .btn:active {
                    background: rgba(0, 0, 0, 0.1);
                }

                .timestep-slider {
                    flex: 1;
                    min-width: 0;
                }

                /* Frame limit section */
                .frame-limit-section {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                    min-width: 0; /* Allow grid to shrink this properly */
                }

                .frame-limit-header {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }

                .frame-limit-label {
                    color: #aaa;
                    font-size: 11px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    cursor: pointer;
                    user-select: none;
                }

                :host(.light-theme) .frame-limit-label {
                    color: #666;
                }

                .frame-limit-checkbox {
                    margin: 0;
                    cursor: pointer;
                }

                .frame-limit-value {
                    color: #4CAF50;
                    font-weight: bold;
                    font-size: 10px;
                    margin-left: auto;
                }

                :host(.light-theme) .frame-limit-value {
                    color: #2E7D32;
                }

                .frame-limit-slider {
                    width: 100%;
                }

                /* Slider styling */
                input[type="range"] {
                    -webkit-appearance: none;
                    appearance: none;
                    background: transparent;
                    cursor: pointer;
                }

                input[type="range"]::-webkit-slider-track {
                    background: #333;
                    height: 6px;
                    border-radius: 3px;
                }

                :host(.light-theme) input[type="range"]::-webkit-slider-track {
                    background: #ddd;
                }

                input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 14px;
                    height: 14px;
                    border-radius: 50%;
                    background: #4CAF50;
                    cursor: pointer;
                    margin-top: -4px;
                }

                :host(.light-theme) input[type="range"]::-webkit-slider-thumb {
                    background: #2E7D32;
                }

                input[type="range"]::-moz-range-track {
                    background: #333;
                    height: 6px;
                    border-radius: 3px;
                }

                :host(.light-theme) input[type="range"]::-moz-range-track {
                    background: #ddd;
                }

                input[type="range"]::-moz-range-thumb {
                    width: 14px;
                    height: 14px;
                    border: none;
                    border-radius: 50%;
                    background: #4CAF50;
                    cursor: pointer;
                }

                :host(.light-theme) input[type="range"]::-moz-range-thumb {
                    background: #2E7D32;
                }
            </style>

            <div class="container">
                <div class="fps-display">FPS: ${this._fps}</div>

                <div class="controls-grid">
                <!-- Timestep section -->
                <div class="timestep-section">
                    <div class="timestep-label">Time Step: <span id="timestep-value">${this._timestep.toFixed(4)}</span></div>
                    <div class="timestep-controls">
                        <button class="btn" id="timestep-decrease">-</button>
                        <input type="range" class="timestep-slider" id="timestep-slider"
                               min="-3" max="0.4" step="0.01" value="${this.timestepLogToSlider(this._timestepLog)}">
                        <button class="btn" id="timestep-increase">+</button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="divider"></div>

                <!-- Frame limit section -->
                <div class="frame-limit-section">
                    <div class="frame-limit-header">
                        <label class="frame-limit-label" for="frame-limit-checkbox">
                            <input type="checkbox" class="frame-limit-checkbox" id="frame-limit-checkbox" ${this._frameLimitEnabled?"checked":""}>
                            Stop at:
                        </label>
                        <span class="frame-limit-value" id="frame-limit-value">${Math.round(this._frameLimit)}</span>
                    </div>
                    <input type="range" class="frame-limit-slider" id="frame-limit-slider"
                           min="0" max="100" step="1" value="${this.frameToSlider(this._frameLimit)}">
                </div>
            </div>
            </div>
        `)}attachInternalListeners(){let e=this.querySelector("#timestep-slider"),t=this.querySelector("#timestep-value"),i=this.querySelector("#timestep-decrease"),r=this.querySelector("#timestep-increase");e.addEventListener("input",()=>{let c=parseFloat(e.value);this._timestepLog=this.sliderToTimestepLog(c),this._timestep=Math.pow(10,this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)}),i.addEventListener("click",()=>{let c=Math.pow(10,-3);this._timestep=Math.max(c,this._timestep*.98),this._timestepLog=Math.log10(this._timestep),e.value=this.timestepLogToSlider(this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)}),r.addEventListener("click",()=>{let c=Math.pow(10,.4);this._timestep=Math.min(c,this._timestep*1.02),this._timestepLog=Math.log10(this._timestep),e.value=this.timestepLogToSlider(this._timestepLog),t.textContent=this._timestep.toFixed(4),this.triggerChange(),this.onTimestepChange&&this.onTimestepChange(this._timestep)});let o=this.querySelector("#frame-limit-checkbox"),s=this.querySelector("#frame-limit-slider"),l=this.querySelector("#frame-limit-value");o.addEventListener("change",()=>{this._frameLimitEnabled=o.checked,this.triggerChange(),this.onFrameLimitEnabledChange&&this.onFrameLimitEnabledChange(this._frameLimitEnabled)}),s.addEventListener("input",()=>{let c=parseFloat(s.value);this._frameLimit=this.sliderToFrame(c),l.textContent=Math.round(this._frameLimit),this.triggerChange(),this.onFrameLimitChange&&this.onFrameLimitChange(this._frameLimit)})}frameToSlider(e){return Math.log10(Math.max(1,e))/Math.log10(1e5)*100}sliderToFrame(e){return Math.round(Math.pow(10,e/100*Math.log10(1e5)))}sliderToTimestepLog(e){let o=(e- -3)/3.4;return-3+Math.pow(o,this._timestepCurve)*3.4}timestepLogToSlider(e){let o=(e- -3)/3.4;return-3+Math.pow(o,1/this._timestepCurve)*3.4}setFPS(e){if(this._fps=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector(".fps-display");t&&(t.textContent=`FPS: ${e}`)}setTimestep(e){if(this._timestep=e,this._timestepLog=Math.log10(e),!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#timestep-slider"),i=this.shadowRoot.querySelector("#timestep-value");t&&(t.value=this.timestepLogToSlider(this._timestepLog)),i&&(i.textContent=e.toFixed(4))}setFrameLimitEnabled(e){if(this._frameLimitEnabled=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#frame-limit-checkbox");t&&(t.checked=e)}setFrameLimit(e){if(this._frameLimit=e,!this.shadowRoot)return;let t=this.shadowRoot.querySelector("#frame-limit-slider"),i=this.shadowRoot.querySelector("#frame-limit-value");t&&(t.value=this.frameToSlider(e)),i&&(i.textContent=Math.round(e))}getTimestep(){return this._timestep}getFrameLimitEnabled(){return this._frameLimitEnabled}getFrameLimit(){return this._frameLimit}};customElements.define("mobile-controls",Pt);Te();Je();function Wr(){customElements.get("linear-slider")||customElements.define("linear-slider",Q),customElements.get("log-slider")||customElements.define("log-slider",Ye),customElements.get("percent-slider")||customElements.define("percent-slider",pe),customElements.get("animatable-slider")||customElements.define("animatable-slider",ue),customElements.get("animatable-timestep")||customElements.define("animatable-timestep",Ke),customElements.get("animation-alpha")||customElements.define("animation-alpha",Ce),customElements.get("animation-speed")||customElements.define("animation-speed",Ae),customElements.get("number-input")||customElements.define("number-input",Fe),customElements.get("action-button")||customElements.define("action-button",Re),customElements.get("check-box")||customElements.define("check-box",Le),customElements.get("select-control")||customElements.define("select-control",Me)}M();M();M();M();var It=class{constructor(e,t={}){this.cellData=e,this.callbacks=t,this.element=null,this.inputField=null,this.outputDiv=null,this.errorDiv=null,this._createUI()}_createUI(){this.element=document.createElement("div"),this.element.className="notebook-cell",this.element.dataset.cellId=this.cellData.id,this.element.style.cssText=`
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        `;let e=document.createElement("div");e.style.cssText=`
            display: flex;
            align-items: center;
            gap: 6px;
        `,this.inputField=document.createElement("input"),this.inputField.type="text",this.inputField.value=this.cellData.input||"",this.inputField.placeholder="Enter expression or function definition (e.g., f(x) = sin(x))",this.inputField.style.cssText=`
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: #0a0a0a;
            color: #4CAF50;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 6px 8px;
        `,this.inputField.addEventListener("input",()=>{this.callbacks.onInputChange&&this.callbacks.onInputChange(this.cellData.id,this.inputField.value)}),this.inputField.addEventListener("keydown",c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),this._evaluate())});let t=this._createIconButton("\u2192","Evaluate (Enter)",()=>this._evaluate());t.style.color="#4CAF50",t.style.fontSize="18px";let i=document.createElement("div");i.style.flex="0 0 8px";let r=this._createIconButton("\u2191","Move up",()=>{this.callbacks.onMoveUp&&this.callbacks.onMoveUp(this.cellData.id)}),o=this._createIconButton("\u2193","Move down",()=>{this.callbacks.onMoveDown&&this.callbacks.onMoveDown(this.cellData.id)}),s=this._createIconButton("\u2715","Delete cell",()=>{this.callbacks.onDelete&&this.callbacks.onDelete(this.cellData.id)});s.style.color="#f44336";let l=this._createIconButton("+","Insert cell below",()=>{this.callbacks.onInsertBelow&&this.callbacks.onInsertBelow(this.cellData.id)});l.style.color="#4CAF50",e.appendChild(this.inputField),e.appendChild(t),e.appendChild(i),e.appendChild(r),e.appendChild(o),e.appendChild(s),e.appendChild(l),this.outputDiv=document.createElement("div"),this.outputDiv.className="notebook-cell-output",this.outputDiv.style.cssText=`
            display: none;
            text-align: right;
            color: #e0e0e0;
            font-size: 14px;
            padding: 0;
            margin: 2px 0 0 0;
            line-height: 1;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        `,this.errorDiv=document.createElement("div"),this.errorDiv.className="notebook-cell-error",this.errorDiv.style.cssText=`
            display: none;
            padding: 6px 8px;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 4px;
            color: #f44336;
            font-size: 11px;
        `,this.element.appendChild(e),this.element.appendChild(this.outputDiv),this.element.appendChild(this.errorDiv),(this.cellData.output||this.cellData.error)&&this.updateOutput(this.cellData)}_createIconButton(e,t,i){let r=document.createElement("button");return r.textContent=e,r.title=t,r.style.cssText=`
            width: 28px;
            height: 28px;
            padding: 0;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #444;
            border-radius: 4px;
            color: #4CAF50;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        `,r.addEventListener("click",i),r.addEventListener("mouseenter",()=>{r.style.background="rgba(76, 175, 80, 0.2)",r.style.borderColor="#4CAF50"}),r.addEventListener("mouseleave",()=>{r.style.background="rgba(76, 175, 80, 0.1)",r.style.borderColor="#444"}),r}_evaluate(){this.callbacks.onEvaluate&&this.callbacks.onEvaluate(this.cellData.id)}async updateOutput(e){if(this.cellData.output=e.output,this.cellData.tex=e.tex,this.cellData.error=e.error,this.outputDiv.style.display="none",this.errorDiv.style.display="none",e.error)this.errorDiv.textContent=e.error,this.errorDiv.style.display="block";else if(e.tex||e.output)if(this.outputDiv.style.display="block",e.tex)try{let t=this.element.clientWidth;a.info(`Cell width: ${t}px, using for TeX scaling`),await _r(this.outputDiv,e.tex,t)}catch(t){a.warn("Failed to render TeX, falling back to plain text:",t),this.outputDiv.textContent=e.output||e.tex}else this.outputDiv.textContent=e.output}getElement(){return this.element}getInput(){return this.inputField.value}setInput(e){this.inputField.value=e}getId(){return this.cellData.id}focus(){this.inputField&&this.inputField.focus()}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.inputField=null,this.outputDiv=null,this.errorDiv=null}};var Dt=class{constructor(e={}){if(this.notebook=e.notebook||window.notebook,this.showExport=e.showExport!==!1,!this.notebook)throw new Error("No notebook instance provided");this.element=null,this.cellsContainer=null,this.cellComponents=new Map,this._createUI(),this._renderCells()}_createUI(){this.element=document.createElement("div"),this.element.className="notebook-repl",this.element.style.cssText=`
            display: flex;
            flex-direction: column;
            gap: 8px;
        `,this.cellsContainer=document.createElement("div"),this.cellsContainer.className="notebook-cells",this.cellsContainer.style.cssText=`
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 50px;
        `,this.element.appendChild(this.cellsContainer)}_renderCells(){this.cellComponents.forEach(t=>t.destroy()),this.cellComponents.clear(),this.cellsContainer.innerHTML="";let e=this.notebook.cells||[];if(e.length===0){this.addCell();return}e.forEach(t=>{this._renderCell(t)})}_renderCell(e){let t=new It(e,{onEvaluate:i=>this.evaluateCell(i),onMoveUp:i=>this.moveCellUp(i),onMoveDown:i=>this.moveCellDown(i),onDelete:i=>this.deleteCell(i),onInsertBelow:i=>this.insertCellBelow(i),onInputChange:(i,r)=>this.updateCellInput(i,r)});this.cellComponents.set(e.id,t),this.cellsContainer.appendChild(t.getElement())}addCell(){let e=this.notebook.addCell("code","");a.info("Added new cell:",e);let t=this.notebook.cells.find(i=>i.id===e);return t&&this._renderCell(t),e}insertCellBelow(e){let t=this.notebook.cells||[],i=t.findIndex(s=>s.id===e);if(i===-1)return a.warn("Cell not found:",e),this.addCell();let r=this.notebook.addCell("code",""),o=t.findIndex(s=>s.id===r);if(o!==-1){let s=i+1;for(let l=o;l>s;l--)this.notebook.moveCellUp(r)}return a.info("Inserted new cell below:",e),this._renderCells(),setTimeout(()=>{let s=this.cellComponents.get(r);s&&s.focus()},50),r}deleteCell(e){this.notebook.deleteCell(e),a.info("Deleted cell:",e),this._renderCells()}moveCellUp(e){this.notebook.moveCellUp(e),a.verbose("Moved cell up:",e),this._renderCells()}moveCellDown(e){this.notebook.moveCellDown(e),a.verbose("Moved cell down:",e),this._renderCells()}updateCellInput(e,t){this.notebook.updateCell(e,t),a.verbose("Updated cell input:",e)}async evaluateCell(e){a.info("Evaluating cell:",e);let t=this.notebook.cells||[],r=t.findIndex(o=>o.id===e)===t.length-1;try{let o=await this.notebook.evaluateCell(e),s=this.cellComponents.get(e);if(s&&await s.updateOutput(o),a.info("Cell evaluated successfully:",e),r){let l=this.addCell();setTimeout(()=>{let c=this.cellComponents.get(l);c&&c.focus()},50)}}catch(o){a.error("Error evaluating cell:",o);let s=this.cellComponents.get(e);s&&await s.updateOutput({output:null,tex:null,error:o.message})}}async evaluateAll(){a.info("Evaluating all cells");try{await this.notebook.evaluateAll();for(let[e,t]of this.cellComponents.entries()){let i=this.notebook.cells.find(r=>r.id===e);i&&await t.updateOutput(i)}a.info("All cells evaluated successfully")}catch(e){a.error("Error evaluating all cells:",e)}}exportNotebook(){try{this.notebook.exportJSON("notebook.json"),a.info("Exported notebook")}catch(e){a.error("Failed to export notebook:",e),alert(`Export failed: ${e.message}`)}}importNotebook(){let e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",async t=>{let i=t.target.files[0];if(i)try{await this.notebook.importJSON(i),a.info("Imported notebook"),this._renderCells()}catch(r){a.error("Failed to import notebook:",r),alert(`Import failed: ${r.message}`)}}),e.click()}refresh(){this._renderCells()}cleanupEmptyCells(){let t=(this.notebook.cells||[]).filter(i=>!i.input||!i.input.trim());t.length>0&&(a.info(`Cleaning up ${t.length} empty cells`),t.forEach(i=>{this.notebook.deleteCell(i.id)}),this._renderCells())}getElement(){return this.element}destroy(){this.cellComponents.forEach(e=>e.destroy()),this.cellComponents.clear(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.cellsContainer=null}};var Pe=class{constructor(e){this.config={title:e.title||"Notebook Editor",customContent:e.customContent||null,onApply:e.onApply||(()=>({success:!0})),onCancel:e.onCancel||null,applyButtonText:e.applyButtonText||"Apply",showNotebook:e.showNotebook!==!1,showExport:e.showExport!==!1},this.overlay=null,this.modalContainer=null,this.notebookRepl=null,this.customContentContainer=null,this.errorContainer=null,this.isVisible=!1,this._createUI()}_createUI(){this.overlay=document.createElement("div"),this.overlay.className="notebook-modal-overlay",this.overlay.addEventListener("click",u=>{u.target===this.overlay&&this.hide()}),this.modalContainer=document.createElement("div"),this.modalContainer.className="notebook-modal-container";let e=document.createElement("div");e.className="notebook-modal-header";let t=document.createElement("h2");t.className="notebook-modal-title",t.textContent=this.config.title;let i=document.createElement("div");if(i.style.cssText="display: flex; gap: 8px; align-items: center;",this.config.showExport){let u=document.createElement("button");u.className="notebook-modal-header-button",u.textContent="Export",u.title="Export notebook as JSON",u.addEventListener("click",()=>{this.notebookRepl&&this.notebookRepl.exportNotebook()});let d=document.createElement("button");d.className="notebook-modal-header-button",d.textContent="Import",d.title="Import notebook from JSON",d.addEventListener("click",()=>{this.notebookRepl&&this.notebookRepl.importNotebook()}),i.appendChild(u),i.appendChild(d)}let r=document.createElement("button");r.className="notebook-modal-close",r.textContent="\xD7",r.title="Close",r.addEventListener("click",()=>this.hide()),i.appendChild(r),e.appendChild(t),e.appendChild(i);let o=document.createElement("div");if(o.className="notebook-modal-content",this.customContentContainer=document.createElement("div"),this.customContentContainer.className="notebook-modal-custom-content",this.config.customContent&&(typeof this.config.customContent=="string"?this.customContentContainer.innerHTML=this.config.customContent:this.config.customContent instanceof HTMLElement&&this.customContentContainer.appendChild(this.config.customContent),o.appendChild(this.customContentContainer)),this.config.showNotebook){let u=document.createElement("div");u.className="notebook-modal-notebook-section",this.notebookRepl=new Dt({showExport:!1}),u.appendChild(this.notebookRepl.getElement()),o.appendChild(u)}this.errorContainer=document.createElement("div"),this.errorContainer.className="notebook-modal-error";let s=document.createElement("div");s.className="notebook-modal-footer";let l=document.createElement("button");l.className="notebook-modal-button-cancel",l.textContent="Cancel",l.addEventListener("click",()=>this.hide());let c=document.createElement("button");c.className="notebook-modal-button-apply",c.textContent=this.config.applyButtonText,c.addEventListener("click",()=>this._handleApply()),s.appendChild(l),s.appendChild(c),this.modalContainer.appendChild(e),this.modalContainer.appendChild(o),this.modalContainer.appendChild(this.errorContainer),this.modalContainer.appendChild(s),this.overlay.appendChild(this.modalContainer),document.body.appendChild(this.overlay),this._escapeHandler=u=>{u.key==="Escape"&&this.isVisible&&this.hide()},document.addEventListener("keydown",this._escapeHandler)}async _handleApply(){try{this.notebookRepl&&this.notebookRepl.cleanupEmptyCells();let e=this._gatherCustomFields(),t=await this.config.onApply(window.notebook,e);t.success?(a.info("Modal apply successful"),this.hide()):(alert(`Error: ${t.error||"Unknown error"}`),a.error("Modal apply failed:",t.error))}catch(e){alert(`Error: ${e.message}`),a.error("Modal apply error:",e)}}_gatherCustomFields(){let e={};return this.customContentContainer&&this.customContentContainer.querySelectorAll("input, textarea, select").forEach(i=>{i.id&&(i.type==="checkbox"?e[i.id]=i.checked:e[i.id]=i.value)}),e}show(){this.overlay.style.display="block",this.isVisible=!0,this.hideError(),this.notebookRepl&&this.notebookRepl.refresh(),a.info("Opened notebook modal:",this.config.title)}hide(){this.notebookRepl&&this.notebookRepl.cleanupEmptyCells(),this.overlay.style.display="none",this.isVisible=!1,this.config.onCancel&&this.config.onCancel(),a.info("Closed notebook modal")}isOpen(){return this.isVisible}getCustomContentContainer(){return this.customContentContainer}getNotebookREPL(){return this.notebookRepl}showError(e){this.errorContainer.innerHTML=e,this.errorContainer.style.display="block"}hideError(){this.errorContainer.style.display="none",this.errorContainer.innerHTML=""}destroy(){document.removeEventListener("keydown",this._escapeHandler),this.notebookRepl&&this.notebookRepl.destroy(),this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.modalContainer=null,this.notebookRepl=null,this.customContentContainer=null}};var Ci=class{constructor(){this.modal=null,this._initialized=!1}_initialize(){this._initialized||(this.modal=new Pe({title:"Notebook",customContent:null,applyButtonText:"Close",showNotebook:!0,showExport:!0,onApply:()=>({success:!0})}),this._initialized=!0,a.info("Notebook editor initialized"))}_createInfoSection(){let e=document.createElement("div");return e.style.cssText="margin-bottom: 16px; font-size: 13px; color: #e0e0e0;",e.innerHTML=`
            <p style="margin: 0 0 8px 0;">
                Define mathematical functions and expressions that can be used throughout the application.
            </p>
            <p style="margin: 0; font-family: monospace; color: #888; font-size: 11px;">
                Example: <span style="color: #4CAF50;">f(x) = sin(x) * exp(-x)</span>
            </p>
        `,e}open(){this._initialize(),this.modal.show()}isOpen(){return this.modal&&this.modal.isOpen()}getModal(){return this.modal}},Jr=new Ci;var kt=class{constructor(){this._ready=!1}async initialize(){throw new Error("initialize() must be implemented by subclass")}isReady(){return this._ready}parse(e){throw new Error("parse() must be implemented by subclass")}evaluate(e){throw new Error("evaluate() must be implemented by subclass")}differentiate(e,t){throw new Error("differentiate() must be implemented by subclass")}simplify(e){throw new Error("simplify() must be implemented by subclass")}solve(e,t){throw new Error("solve() must be implemented by subclass")}invertMatrix(e){throw new Error("invertMatrix() must be implemented by subclass")}matrixElement(e,t,i){throw new Error("matrixElement() must be implemented by subclass")}setVariable(e,t){throw new Error("setVariable() must be implemented by subclass")}toGLSL(e){throw new Error("toGLSL() must be implemented by subclass")}toTeX(e){throw new Error("toTeX() must be implemented by subclass")}clearCache(){throw new Error("clearCache() must be implemented by subclass")}toString(e){throw new Error("toString() must be implemented by subclass")}getName(){throw new Error("getName() must be implemented by subclass")}getCapabilities(){throw new Error("getCapabilities() must be implemented by subclass")}getVersion(){return"unknown"}};M();function Yr(n){return n=n.replace(/([a-z]+)\^(\d+)/g,(e,t,i)=>{let r=parseInt(i);return r===0?"1":r===1?t:Array(r).fill(t).join("*")}),n=n.replace(/pow\(([a-z]+),\s*(\d+)\)/g,(e,t,i)=>{let r=parseInt(i);return r===0?"1":r===1?t:r<=4?Array(r).fill(t).join("*"):e}),n}var Bt=class extends kt{constructor(){super()}async initialize(){if(!window.nerdamer)throw new Error("Nerdamer not loaded - ensure nerdamer CDN script is included in index.html");if(typeof window.nerdamer!="function")throw new Error("Nerdamer is not a function - invalid state");if(!window.nerdamer.diff)throw new Error("Nerdamer.diff not available - incomplete initialization");this._ready=!0,a.info("NerdamerEngine initialized successfully")}parse(e){if(!this._ready)throw new Error("NerdamerEngine not initialized");return window.nerdamer(e)}evaluate(e){if(!this._ready)throw new Error("NerdamerEngine not initialized");try{let i=window.nerdamer(e).toString(),r=window.nerdamer.convertToLaTeX(i);return r=this._cleanupTeX(r),{result:i,tex:r}}catch(t){return{result:"",tex:"",error:t.message}}}differentiate(e,t){if(!this._ready)throw new Error("NerdamerEngine not initialized");try{let i=window.nerdamer(e),o=window.nerdamer.diff(i,t).toString();return Yr(o)}catch(i){return a.warn(`Failed to differentiate "${e}" w.r.t. ${t}:`,i.message),"0"}}simplify(e){if(!this._ready)throw new Error("NerdamerEngine not initialized");try{return window.nerdamer(`simplify(${e})`).toString()}catch(t){return a.warn(`Failed to simplify "${e}":`,t.message),e}}solve(e,t){if(!this._ready)throw new Error("NerdamerEngine not initialized");try{let i=window.nerdamer.solve(e,t);return i?i.toString():null}catch(i){return a.warn(`Failed to solve "${e}" for ${t}:`,i.message),null}}invertMatrix(e){if(!this._ready)throw new Error("NerdamerEngine not initialized");let t=e.length;if(t<2||t>4)return a.error(`Matrix inversion only supported for 2x2, 3x3, and 4x4 matrices (got ${t}x${t})`),null;try{let i=e.map(o=>`[${o.join(",")}]`).join(",");a.verbose("Inverting matrix:",`matrix(${i})`),window.nerdamer.setVar("J_temp",`matrix(${i})`),window.nerdamer.setVar("J_inv","invert(J_temp)");let r=[];for(let o=0;o<t;o++){let s=[];for(let l=0;l<t;l++){let c=window.nerdamer(`matget(J_inv, ${o}, ${l})`).toString(),u=Yr(c);s.push(u)}r.push(s)}return a.verbose("Inverted matrix successfully"),r}catch(i){return a.error("Failed to invert matrix:",i.message),null}}matrixElement(e,t,i){if(!this._ready)throw new Error("NerdamerEngine not initialized");try{return window.nerdamer(`matget(${e}, ${t}, ${i})`).toString()}catch(r){return a.error(`Failed to get matrix element [${t},${i}]:`,r.message),"0"}}setVariable(e,t){if(!this._ready)throw new Error("NerdamerEngine not initialized");window.nerdamer.setVar(e,t)}toGLSL(e){let t=e;return t=t.replace(/([a-zA-Z0-9_]+)\^([a-zA-Z0-9_]+)/g,"pow($1, $2)"),t=t.replace(/\bln\(/g,"log("),t}toTeX(e){let t=window.nerdamer.convertToLaTeX(e);return this._cleanupTeX(t)}_cleanupTeX(e){return e=e.replace(/\^\{1\}/g,""),e}_basicTexConversion(e){let t=e;return t=t.replace(/([a-zA-Z0-9_]+)\^([0-9]+)/g,"$1^{$2}"),t=t.replace(/([a-zA-Z0-9_]+)\^([a-zA-Z]+)/g,"$1^{$2}"),t=t.replace(/sqrt\(([^)]+)\)/g,"\\sqrt{$1}"),t=t.replace(/([a-zA-Z0-9_]+)\/([a-zA-Z0-9_]+)/g,"\\frac{$1}{$2}"),t}clearCache(){this._ready&&window.nerdamer&&window.nerdamer.clear&&(a.verbose("Clearing Nerdamer cache (all definitions cleared)"),window.nerdamer.clear("all"))}toString(e){return typeof e=="string"?e:e&&typeof e.toString=="function"?e.toString():String(e)}getName(){return"Nerdamer"}getCapabilities(){return{differentiate:!0,integrate:!1,solve:!0,matrices:!0,simplify:!0,persistentNotebookContext:!1}}getVersion(){return window.nerdamer?"loaded":"not loaded"}};M();var Ze={NERDAMER:"nerdamer",MAXIMA:"maxima"};async function Kr(n=Ze.NERDAMER){a.info(`Creating CAS engine: ${n}`);let e;switch(n){case Ze.NERDAMER:e=new Bt;break;case Ze.MAXIMA:throw new Error("Maxima engine not yet implemented (Phase 10-11)");default:throw new Error(`Unknown CAS engine type: ${n}`)}try{return await e.initialize(),a.info(`CAS engine ${n} initialized successfully`),e}catch(t){throw a.error(`Failed to initialize CAS engine ${n}:`,t.message),t}}function Zr(){let n=localStorage.getItem("casEngine");return n&&Object.values(Ze).includes(n)?n:Ze.NERDAMER}M();var Qr="de-render-notebook";function oo(){return`cell-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}var Vt=class{constructor(e){this.casEngine=e,this.cells=[],this.contextDirty=!1,a.info("Notebook initialized with CAS engine:",e.getName())}addCell(e,t=""){let i=oo(),r={id:i,type:e,input:t,output:null,tex:null,error:null};return this.cells.push(r),this.save(),a.info(`Added ${e} cell:`,i),i}updateCell(e,t){let i=this.cells.find(r=>r.id===e);if(!i){a.warn(`Cell not found: ${e}`);return}i.input=t,i.output=null,i.tex=null,i.error=null,this.save(),this.markContextDirty()}deleteCell(e){let t=this.cells.findIndex(i=>i.id===e);if(t===-1){a.warn(`Cell not found: ${e}`);return}this.cells.splice(t,1),this.save(),this.markContextDirty(),a.info(`Deleted cell: ${e}`)}moveCellUp(e){let t=this.cells.findIndex(i=>i.id===e);t<=0||([this.cells[t-1],this.cells[t]]=[this.cells[t],this.cells[t-1]],this.save(),this.markContextDirty())}moveCellDown(e){let t=this.cells.findIndex(i=>i.id===e);t===-1||t>=this.cells.length-1||([this.cells[t],this.cells[t+1]]=[this.cells[t+1],this.cells[t]],this.save(),this.markContextDirty())}async evaluateCell(e){let t=this.cells.find(i=>i.id===e);if(!t)return a.warn(`Cell not found: ${e}`),{result:"",tex:"",error:"Cell not found"};if(t.type!=="code")return{result:"",tex:"",error:"Not a code cell"};try{await this.evaluateUpTo(e),a.verbose(`Evaluating cell ${e}: "${t.input}"`);let i=this.evaluate(t.input);return t.output=i.result,t.tex=i.tex,t.error=i.error||null,this.save(),a.info(`Cell ${e} evaluated successfully:`,i.result),i}catch(i){return a.error(`Error evaluating cell ${e}:`,i.message),t.error=i.message,t.output=null,t.tex=null,this.save(),{result:"",tex:"",error:i.message}}}async evaluateUpTo(e){let t=this.cells.findIndex(i=>i.id===e);if(t!==-1)for(let i=0;i<t;i++){let r=this.cells[i];r.type==="code"&&!r.output&&!r.error&&await this.evaluateCell(r.id)}}async evaluateAll(){a.info("Evaluating all notebook cells");for(let e of this.cells)e.type==="code"&&await this.evaluateCell(e.id);a.info("All cells evaluated")}markContextDirty(){this.contextDirty=!0}ensureContext(){if(!this.contextDirty)return;a.verbose("Re-applying notebook context to CAS engine");let e=this.contextDirty;this.contextDirty=!1;for(let t of this.cells)if(t.type==="code"&&t.output&&!t.error)try{this.evaluate(t.input)}catch(i){a.warn(`Failed to re-apply cell ${t.id}:`,i.message)}a.verbose("Notebook context applied")}expandFunctions(e){this.ensureContext();try{let t=[];for(let o of this.cells)if(o.type==="code"&&o.output&&!o.error){let s=o.input.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(([^)]*)\)\s*=\s*(.+)$/);if(s){let[,l]=s;t.push(l)}}let i=!1;for(let o of t)if(new RegExp(`\\b${o}\\s*\\(`).test(e)){i=!0;break}if(!i)return a.verbose(`No custom functions in "${e}", skipping expansion`),e;let r=this.casEngine.evaluate(e);if(r.result&&r.result!==e){let o=t.filter(s=>new RegExp(`\\b${s}\\s*\\(`).test(e));return o.length>0&&a.verbose(`Expanded with: ${o.join(", ")}`),a.verbose(`  "${e}" -> "${r.result}"`),r.result}return e}catch(t){return a.warn(`Failed to expand functions in "${e}":`,t.message),e}}differentiate(e,t){return this.ensureContext(),this.casEngine.differentiate(e,t)}solve(e,t){return this.ensureContext(),this.casEngine.solve(e,t)}invertMatrix(e){return this.ensureContext(),this.casEngine.invertMatrix(e)}evaluate(e){this.ensureContext(),a.verbose(`Notebook.evaluate() called with: "${e}"`);let t=e.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(([^)]*)\)\s*=\s*(.+)$/);if(a.verbose("Function definition regex match:",t?"YES":"NO"),t){let[,i,r,o]=t,s=r.split(",").map(l=>l.trim()).filter(l=>l);if(a.verbose(`Parsed function: name="${i}", args=[${s.join(", ")}], body="${o}"`),this.casEngine.getName()==="Nerdamer"&&window.nerdamer&&window.nerdamer.setFunction)try{a.verbose(`Calling nerdamer.setFunction("${i}", [${s.join(", ")}], "${o}")`),window.nerdamer.setFunction(i,s,o),a.info(`Defined function: ${i}(${s.join(", ")}) = ${o}`);let l=`${i}(${s.join(", ")})`,c={result:`${l} = ${o}`,tex:`${l} = ${o}`};return a.verbose("Returning result:",c),c}catch(l){return a.error(`Error defining function: ${l.message}`),{result:"",tex:"",error:`Failed to define function ${i}: ${l.message}`}}else{a.warn("CAS engine does not support setFunction, function definition ignored");let l=`${i}(${s.join(", ")})`;return{result:`${l} = ${o} (not supported by engine)`,tex:`${l} = ${o}`,error:"Function definitions not supported by current CAS engine"}}}return a.verbose("Not a function definition, evaluating normally"),this.casEngine.evaluate(e)}parse(e){return this.ensureContext(),this.casEngine.parse(e)}save(){try{let e=this.toJSON();localStorage.setItem(Qr,JSON.stringify(e)),a.verbose("Notebook saved to localStorage")}catch(e){a.error("Failed to save notebook:",e.message)}}load(){try{let e=localStorage.getItem(Qr);if(!e){a.info("No saved notebook found");return}let t=JSON.parse(e);this.fromJSON(t),a.info(`Loaded notebook with ${this.cells.length} cells`),this.evaluateAll()}catch(e){a.error("Failed to load notebook:",e.message)}}toJSON(){return{version:1,cells:this.cells.map(e=>({id:e.id,type:e.type,input:e.input,output:e.output,tex:e.tex,error:e.error}))}}fromJSON(e){if(e.version!==1)throw new Error(`Unsupported notebook version: ${e.version}`);this.cells=e.cells||[],this.markContextDirty()}exportJSON(e="notebook.json"){let t=this.toJSON(),i=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(i),o=document.createElement("a");o.href=r,o.download=e,o.click(),URL.revokeObjectURL(r),a.info(`Exported notebook to ${e}`)}async importJSON(e){return new Promise((t,i)=>{let r=new FileReader;r.onload=async o=>{try{let s=JSON.parse(o.target.result);this.fromJSON(s),this.save(),await this.evaluateAll(),a.info("Imported notebook successfully"),t()}catch(s){a.error("Failed to import notebook:",s.message),i(s)}},r.onerror=()=>i(new Error("Failed to read file")),r.readAsText(e)})}clear(){this.cells=[],this.save(),this.markContextDirty(),a.info("Notebook cleared")}};ut();M();var zt=class{constructor(e={}){if(this.config={generator:e.generator||null,onGenerate:e.onGenerate||null,context:e.context||{},mathPlaceholder:e.mathPlaceholder||(e.generator?e.generator.getMathPlaceholder():"Enter math expression..."),glslPlaceholder:e.glslPlaceholder||(e.generator?e.generator.getGLSLPlaceholder():"Generated GLSL code..."),initialMath:e.initialMath||"",initialGLSL:e.initialGLSL||"",readonly:e.readonly||!1},!this.config.generator&&!this.config.onGenerate)throw new Error("MathToGLSLControl requires either generator or onGenerate");this.element=null,this.mathInput=null,this.glslOutput=null,this.generateButton=null,this.errorDiv=null,this._createUI()}_createUI(){this.element=document.createElement("div"),this.element.className="math-to-glsl-control",this.element.style.cssText=`
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: start;
            margin: 12px 0;
        `;let e=document.createElement("div");e.style.cssText="display: flex; flex-direction: column; gap: 4px;";let t=document.createElement("label");t.textContent="Math Expression",t.style.cssText="font-size: 12px; color: #4CAF50; font-weight: bold;",this.mathInput=document.createElement("textarea"),this.mathInput.placeholder=this.config.mathPlaceholder,this.mathInput.value=this.config.initialMath,this.mathInput.rows=6,this.mathInput.readOnly=this.config.readonly,this.mathInput.style.cssText=`
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #1a1a1a;
            color: #4CAF50;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            resize: vertical;
            width: 100%;
            box-sizing: border-box;
        `,e.appendChild(t),e.appendChild(this.mathInput);let i=document.createElement("div");i.style.cssText="display: flex; align-items: center; padding-top: 20px;",this.generateButton=document.createElement("button"),this.generateButton.textContent="\u2192",this.generateButton.title="Generate GLSL",this.generateButton.disabled=this.config.readonly,this.generateButton.style.cssText=`
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: ${this.config.readonly?"not-allowed":"pointer"};
            font-size: 16px;
            font-weight: bold;
            opacity: ${this.config.readonly?"0.5":"1"};
        `,this.config.readonly||this.generateButton.addEventListener("click",()=>this.generate()),i.appendChild(this.generateButton);let r=document.createElement("div");r.style.cssText="display: flex; flex-direction: column; gap: 4px;";let o=document.createElement("label");o.textContent="GLSL Code",o.style.cssText="font-size: 12px; color: #4CAF50; font-weight: bold;",this.glslOutput=document.createElement("textarea"),this.glslOutput.placeholder=this.config.glslPlaceholder,this.glslOutput.value=this.config.initialGLSL,this.glslOutput.rows=6,this.glslOutput.readOnly=this.config.readonly,this.glslOutput.style.cssText=`
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #1a1a1a;
            color: #64B5F6;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            resize: vertical;
            width: 100%;
            box-sizing: border-box;
        `,r.appendChild(o),r.appendChild(this.glslOutput),this.errorDiv=document.createElement("div"),this.errorDiv.style.cssText=`
            grid-column: 1 / -1;
            display: none;
            padding: 8px;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 4px;
            color: #f44336;
            font-size: 11px;
        `,this.element.appendChild(e),this.element.appendChild(i),this.element.appendChild(r),this.element.appendChild(this.errorDiv)}generate(){let e=this.mathInput.value.trim();this.errorDiv.style.display="none";let t;if(this.config.generator?t=this.config.generator.validate(e,this.config.context):t=e?{valid:!0}:{valid:!1,error:"Expression is empty"},!t.valid){this._showError(t.error||"Invalid expression");return}try{let i;this.config.onGenerate?i=this.config.onGenerate(e,window.notebook,this.config.context):this.config.generator&&(i=this.config.generator.generate(e,window.notebook,this.config.context)),this.glslOutput.value=i,a.info("Generated GLSL from math expression")}catch(i){this._showError(i.message),a.error("Failed to generate GLSL:",i)}}_showError(e){this.errorDiv.textContent=`Error: ${e}`,this.errorDiv.style.display="block"}getElement(){return this.element}getMath(){return this.mathInput.value.trim()}getGLSL(){return this.glslOutput.value.trim()}setMath(e){this.mathInput.value=e}setGLSL(e){this.glslOutput.value=e}getValues(){return{math:this.getMath(),glsl:this.getGLSL()}}};M();var Nt=class{constructor(e){this.renderer=e,this.modal=null,this.controls=[],this.controlsContainer=null,this.dimensionSelector=null,this.generator=new Ee,this.workflow=new le(this.generator),this._createModal()}_createModal(){let e=document.createElement("div");e.className="field-equations-editor-content";let t=document.createElement("div");t.className="field-equations-dimension-row";let i=document.createElement("label");i.textContent="Number of Dimensions:",i.style.cssText="font-size: 14px; color: #4CAF50; font-weight: bold;",this.dimensionSelector=document.createElement("select"),this.dimensionSelector.className="field-equations-dimension-select";for(let r=2;r<=6;r++){let o=document.createElement("option");o.value=r,o.textContent=`${r}D`,this.dimensionSelector.appendChild(o)}this.dimensionSelector.addEventListener("change",()=>{this._updateControls(parseInt(this.dimensionSelector.value))}),t.appendChild(i),t.appendChild(this.dimensionSelector),this.controlsContainer=document.createElement("div"),this.controlsContainer.className="field-equations-controls",e.appendChild(t),e.appendChild(this.controlsContainer),this.modal=new Pe({title:"Field Equations Editor",customContent:e,applyButtonText:"Apply to Renderer",onApply:async(r,o)=>{let s=await this.workflow.executeInteractive(this.controls,r,this.renderer,this.modal);if(s.success){let l=document.getElementById("dimensions");l&&l.setValue&&l.setValue(this.controls.length);let c=window.manager?.get("dimension-inputs");if(c&&s.expressions&&c.setValue(s.expressions),window.equationOverlay&&window.equationOverlay.isVisible&&window.equationOverlay.isVisible()){let u=this.renderer.coordinateSystem.getVariableNames();window.equationOverlay.updateEquations(this.renderer.expressions,u)}}return s}}),this._updateControls(2)}_updateControls(e,t=null){this.controlsContainer.innerHTML="",this.controls=[];let i=t||this.renderer.expressions||[],r=["x","y","z","w","u","v"];for(let o=0;o<e;o++){let s=r[o]||`x${o}`,l=i[o]||"",c=new zt({generator:this.generator,context:{dimension:o,totalDims:e},mathPlaceholder:`d${s}/dt = ...`,glslPlaceholder:"Generated GLSL...",initialMath:l,initialGLSL:""}),u=document.createElement("div");u.className="field-equation-label",u.textContent=`Dimension ${o}: d${s}/dt`,this.controlsContainer.appendChild(u),this.controlsContainer.appendChild(c.getElement()),this.controls.push(c)}a.info(`Created ${e} field equation controls`)}show(){let e=this.renderer.dimensions||2;this.dimensionSelector.value=e;let t=null;if(window.manager){let i=window.manager.get("dimension-inputs");i&&(t=i.getValue())}t||(t=this.renderer.expressions),this._updateControls(e,t),this.modal.show()}hide(){this.modal.hide()}isOpen(){return this.modal.isOpen()}destroy(){this.modal&&this.modal.destroy(),this.controls=[]}};window.MathParser={setCustomFunctions:Di,getCustomFunctions:ki};window.showDocs=function(n,e){n.stopPropagation(),window.appModal?.show("docs",e)};window.showFieldEditor=function(n){n.stopPropagation(),window.getFieldEquationsEditor?.()?.show()};Wr();$(document).ready(async function(){window.logger=a,a.hookConsole(),a.info("Logger initialized");try{let l=Zr();a.info(`Initializing CAS engine: ${l}`);let c=await Kr(l),u=new Vt(c);u.load(),ji(u),br(u),window.notebook=u,window.casEngine=c,a.info(`Notebook initialized with ${c.getName()} engine`)}catch(l){a.error("Failed to initialize math system:",l),alert("Failed to initialize math engine: "+l.message);return}function n(l){let c=document.getElementById("canvas"),u=null;function d(){if(c.width=window.innerWidth,c.height=window.innerHeight,u){u.resize(c.width,c.height);let h=c.width/c.height,p=u.bbox,m=(p.min[0]+p.max[0])/2,f=(p.min[1]+p.max[1])/2,x=(p.max[1]-p.min[1])*h;p.min[0]=m-x/2,p.max[0]=m+x/2,u.updateConfig({bbox:p})}}d(),window.addEventListener("resize",d);try{let p=new URLSearchParams(window.location.search).get("storage")||"float";u=new ft(c,{storageStrategy:p}),l(u,c)}catch(h){a.error("Failed to initialize renderer",h),alert("Failed to initialize WebGL renderer: "+(h.message||h))}}function e(l,c){let u=jr(l,function(d){let{manager:h,state:p,saveSettings:m}=d,f=h.getSettings();l.updateConfig(f),l.start(),o(l,h),window.renderer=l,window.loadPreset=Tt,window.logger=a,window.saveSettings=m,window.manager=h;let b=qr(),x=new Lt(a);b.registerTab(x);let g=new Rt;b.registerTab(g);let y=new Mt;b.registerTab(y),window.appModal=b,window.notebookEditor=Jr,window.fieldEquationsEditor=null,window.getFieldEquationsEditor=()=>(window.fieldEquationsEditor||(window.fieldEquationsEditor=new Nt(l)),window.fieldEquationsEditor),a.info("N-Dimensional Vector Field Renderer initialized!"),a.info("Available presets: "+Object.keys(window.presets).join(", ")),a.info('Try: loadPreset("3d_lorenz")')})}function t(l,c){let u=!1,d=0,h=0,p=null;function m(){p&&clearTimeout(p),p=setTimeout(()=>{window.saveSettings&&window.saveSettings()},500)}c.addEventListener("mousedown",g=>{g.target===c&&(u=!0,d=g.clientX,h=g.clientY)}),c.addEventListener("mousemove",g=>{if(u){let y=g.clientX-d,_=g.clientY-h,S=l.bbox,F=S.max[0]-S.min[0],E=S.max[1]-S.min[1],L=F/c.width;S.min[0]-=y*L,S.max[0]-=y*L,S.min[1]+=_*L,S.max[1]+=_*L,l.updateConfig({bbox:S}),d=g.clientX,h=g.clientY}}),c.addEventListener("mouseup",()=>{u=!1,m()}),c.addEventListener("mouseleave",()=>{u=!1,u||m()}),c.addEventListener("wheel",g=>{g.preventDefault();let y=g.deltaY>0?1.1:.9,_=c.getBoundingClientRect(),S=g.clientX-_.left,F=g.clientY-_.top,E=l.bbox,L=E.max[0]-E.min[0],k=E.max[1]-E.min[1],A=E.min[0]+L*(S/c.width),B=E.max[1]-k*(F/c.height),z=k*y,v=c.width/c.height,C=z*v,w=(A-E.min[0])/L,T=(E.max[1]-B)/k;E.min[0]=A-C*w,E.max[0]=A+C*(1-w),E.min[1]=B-z*(1-T),E.max[1]=B+z*T,l.updateConfig({bbox:E}),m()});let f=0;c.addEventListener("touchstart",g=>{if(g.touches.length===1)u=!0,d=g.touches[0].clientX,h=g.touches[0].clientY;else if(g.touches.length===2){u=!1;let y=g.touches[1].clientX-g.touches[0].clientX,_=g.touches[1].clientY-g.touches[0].clientY;f=Math.sqrt(y*y+_*_)}g.preventDefault()}),c.addEventListener("touchmove",g=>{if(g.touches.length===1&&u){let y=g.touches[0].clientX-d,_=g.touches[0].clientY-h,S=l.bbox,F=S.max[0]-S.min[0],E=S.max[1]-S.min[1],L=F/c.width;S.min[0]-=y*L,S.max[0]-=y*L,S.min[1]+=_*L,S.max[1]+=_*L,l.updateConfig({bbox:S}),d=g.touches[0].clientX,h=g.touches[0].clientY}else if(g.touches.length===2){let y=g.touches[1].clientX-g.touches[0].clientX,_=g.touches[1].clientY-g.touches[0].clientY,S=Math.sqrt(y*y+_*_);if(f>0){let F=f/S,E=l.bbox,L=E.max[1]-E.min[1],k=(E.min[0]+E.max[0])/2,A=(E.min[1]+E.max[1])/2,B=L*F,z=c.width/c.height,v=B*z;E.min[0]=k-v/2,E.max[0]=k+v/2,E.min[1]=A-B/2,E.max[1]=A+B/2,l.updateConfig({bbox:E})}f=S}g.preventDefault()}),c.addEventListener("touchend",()=>{u=!1,f=0,m()});function b(g){let y=l.bbox,_=y.max[0]-y.min[0],S=y.max[1]-y.min[1],F=(y.min[0]+y.max[0])/2,E=(y.min[1]+y.max[1])/2,L=S*g,k=c.width/c.height,A=L*k;y.min[0]=F-A/2,y.max[0]=F+A/2,y.min[1]=E-L/2,y.max[1]=E+L/2,l.updateConfig({bbox:y}),m()}function x(g,y){let _=l.bbox,S=_.max[0]-_.min[0],F=_.max[1]-_.min[1],E=S*g*.1,L=F*y*.1;_.min[0]+=E,_.max[0]+=E,_.min[1]+=L,_.max[1]+=L,l.updateConfig({bbox:_}),m()}$("#zoom-in").on("click",()=>b(.9)),$("#zoom-out").on("click",()=>b(1.11)),$("#pan-up").on("click",()=>x(0,1)),$("#pan-down").on("click",()=>x(0,-1)),$("#pan-left").on("click",()=>x(-1,0)),$("#pan-right").on("click",()=>x(1,0)),$("#pan-up-left").on("click",()=>x(-1,1)),$("#pan-up-right").on("click",()=>x(1,1)),$("#pan-down-left").on("click",()=>x(-1,-1)),$("#pan-down-right").on("click",()=>x(1,-1)),$("#pan-reset").on("click",function(){let g=l.bbox,y=g.max[0]-g.min[0],_=g.max[1]-g.min[1];l.updateConfig({bbox:{min:[-y/2,-_/2],max:[y/2,_/2]},reinitializeParticles:!1}),m()}),$("#mobile-zoom-in").on("click",()=>b(.9)),$("#mobile-zoom-out").on("click",()=>b(1.11)),$("#mobile-center").on("click",function(){let g=l.bbox,y=g.max[0]-g.min[0],_=g.max[1]-g.min[1];l.updateConfig({bbox:{min:[-y/2,-_/2],max:[y/2,_/2]},reinitializeParticles:!1}),m()})}function i(l,c){let u=document.getElementById("grid-canvas"),d=u.getContext("2d"),h=$("#cursor-position"),p=document.getElementById("show-grid"),m=p?.getValue?p.getValue():!0,f=0,b=0;function x(){u.width=c.width,u.height=c.height,S()}function g(w,T){let R=l.bbox,P=R.max[0]-R.min[0],V=R.max[1]-R.min[1],N=R.min[0]+w/c.width*P,I=R.max[1]-T/c.height*V;return{x:N,y:I}}function y(w,T){let R=l.bbox,P=R.max[0]-R.min[0],V=R.max[1]-R.min[1],N=(w-R.min[0])/P*c.width,I=(R.max[1]-T)/V*c.height;return{x:N,y:I}}function _(){let w=l.bbox,P=(w.max[0]-w.min[0])/10,V=Math.pow(10,Math.floor(Math.log10(P))),N=P/V,I;return N<1.5?I=1*V:N<3.5?I=2*V:N<7.5?I=5*V:I=10*V,I}function S(){if(!m){d.clearRect(0,0,u.width,u.height);return}d.clearRect(0,0,u.width,u.height);let w=l.bbox,T=_(),R=Math.floor(w.min[0]/T)*T,P=Math.ceil(w.max[0]/T)*T;d.strokeStyle="rgba(255, 255, 255, 0.1)",d.lineWidth=1,d.font="10px Courier New",d.fillStyle="rgba(255, 255, 255, 0.5)";for(let U=R;U<=P;U+=T){let q=y(U,0);if(d.beginPath(),d.moveTo(q.x,0),d.lineTo(q.x,u.height),d.stroke(),Math.abs(U)<1e-4)continue;let Ie=U.toFixed(Math.max(0,-Math.floor(Math.log10(T))));d.fillText(Ie,q.x+3,u.height-5)}let V=Math.floor(w.min[1]/T)*T,N=Math.ceil(w.max[1]/T)*T;for(let U=V;U<=N;U+=T){let q=y(0,U);if(d.beginPath(),d.moveTo(0,q.y),d.lineTo(u.width,q.y),d.stroke(),Math.abs(U)<1e-4)continue;let Ie=U.toFixed(Math.max(0,-Math.floor(Math.log10(T))));d.fillText(Ie,5,q.y-3)}let I=y(0,0);d.strokeStyle="rgba(255, 255, 255, 0.3)",d.lineWidth=2,I.y>=0&&I.y<=u.height&&(d.beginPath(),d.moveTo(0,I.y),d.lineTo(u.width,I.y),d.stroke(),d.fillText("0",I.x+3,I.y-3)),I.x>=0&&I.x<=u.width&&(d.beginPath(),d.moveTo(I.x,0),d.lineTo(I.x,u.height),d.stroke())}function F(){let w=g(f,b),T=c.getBoundingClientRect(),R=f-T.left,P=b-T.top,V=l.readPixelAt(R,P),N=`x: ${w.x.toFixed(3)}, y: ${w.y.toFixed(3)}`;if(V){if(V.hdr){let[I,U,q]=V.hdr;N+=`
HDR: (${I.toFixed(3)}, ${U.toFixed(3)}, ${q.toFixed(3)})`}if(V.ldr){let[I,U,q]=V.ldr;N+=`
LDR: (${I.toFixed(3)}, ${U.toFixed(3)}, ${q.toFixed(3)})`}}h.html(N.replace(/\n/g,"<br>"))}c.addEventListener("mousemove",w=>{f=w.clientX,b=w.clientY,F()}),p&&p.addEventListener("change",function(){m=p.getValue(),S()}),window.addEventListener("resize",x),setInterval(S,100);let E=document.querySelector("#fps-counter .fps-display"),L=document.getElementById("mobile-controls");function k(w){if(w>=1e3){let T=w/1e3;return T%1===0?`${Math.floor(T)}k`:`${T.toFixed(1)}k`}return w.toString()}function A(){if(l&&l.fps!==void 0){let w=l.totalFrames!==void 0?` | ${k(l.totalFrames)} frames`:"",T=`${l.fps}${w}`;E&&(E.textContent=`FPS: ${T}`),L&&L.setFPS&&L.setFPS(T)}}setInterval(A,500);let B=$("#histogram-panel"),z=document.getElementById("histogram-canvas"),v=z.getContext("2d");$("#histogram-header").on("click",function(){B.toggleClass("collapsed"),$("#histogram-expand").text(B.hasClass("collapsed")?"\u25B6":"\u25BC")});function C(){if(!l)return;let w=l.getBufferStats();if(!w||!w.histogram||w.histogram.length===0)return;let T=z,R=v,P=window.devicePixelRatio||1;T.width=T.clientWidth*P,T.height=T.clientHeight*P,R.scale(P,P);let V=T.clientWidth,N=T.clientHeight;R.fillStyle="rgba(0, 0, 0, 0.3)",R.fillRect(0,0,V,N);let I=Math.max(...w.histogram);if(I===0)return;let U=V/w.histogram.length;R.fillStyle="#4CAF50",w.histogram.forEach((q,Ie)=>{let Ai=q/I*(N-4),en=Ie*U,tn=N-Ai;R.fillRect(en,tn,U-1,Ai)}),$("#hist-avg").text(w.avgBrightness.toFixed(1)),$("#hist-max").text(w.maxBrightness.toFixed(0)),w.maxVelocity!==void 0&&w.maxVelocity!==null?$("#hist-vel").text(w.maxVelocity.toFixed(2)):$("#hist-vel").text("--")}setInterval(C,1e3),x(),F()}function r(l){document.addEventListener("keydown",c=>{if(c.key==="Escape"){if(window.mobilePanelManager&&window.mobilePanelManager.getCurrentPanel()){c.preventDefault(),window.mobilePanelManager.hideAllPanels(),a.verbose("Mobile panel closed via Escape key");return}let u=$(".floating-panel:visible");if(u.length>0){c.preventDefault(),u.hide(),a.verbose("Floating panel closed via Escape key");return}}if(c.key==="c"&&!c.ctrlKey&&!c.altKey&&!c.metaKey&&!c.shiftKey){if(c.target.tagName==="INPUT"||c.target.tagName==="TEXTAREA")return;c.preventDefault(),l.clearScreen(),a.info("Screen cleared via keyboard shortcut (C)")}})}function o(l,c){let u=null;$("#animation-script-input").on("change",function(d){let h=d.target.files[0];if(!h)return;let p=new FileReader;p.onload=function(m){try{let f=JSON.parse(m.target.result);u=new At(l,c);let b=u.loadScript(f);$("#anim-name").text(b.name);let x=b.timeline[b.timeline.length-1].time,g=Math.ceil(x*b.fps);$("#anim-param").text(`${b.timeline.length} keyframes`),$("#anim-range").text(`0s \u2192 ${x}s`),$("#anim-frames").text(g),$("#anim-fps").text(b.fps),$("#anim-duration").text(`${x.toFixed(1)}s`),$("#animation-info").show(),$("#animation-run-btn").prop("disabled",!1),$("#animation-download-btn").prop("disabled",!0),a.info(`Animation script loaded: ${b.name}`)}catch(f){alert("Failed to load animation script: "+f.message),a.error("Animation script load failed",f)}},p.readAsText(h)}),$("#animation-run-btn").on("click",async function(){if(u)try{$("#animation-run-btn").prop("disabled",!0),$("#animation-pause-btn").prop("disabled",!1),$("#animation-stop-btn").prop("disabled",!1),$("#animation-script-input").prop("disabled",!0),$("#animation-progress").show(),await u.run((d,h,p)=>{let m=d/h*100;$("#progress-bar").css("width",m+"%"),$("#progress-text").text(`Frame ${d} / ${h}`),$("#progress-param").text(`Time: ${p.toFixed(2)}s`)}),a.info("Animation complete!"),alert("Animation complete! "+u.frames.length+" frames captured."),$("#animation-download-btn").prop("disabled",!1)}catch(d){a.error("Animation failed",d),alert("Animation failed: "+d.message)}finally{$("#animation-run-btn").prop("disabled",!1),$("#animation-pause-btn").prop("disabled",!0),$("#animation-stop-btn").prop("disabled",!0),$("#animation-script-input").prop("disabled",!1)}}),$("#animation-pause-btn").on("click",function(){u&&(u.isPaused?(u.resume(),$(this).text("\u23F8 Pause"),a.info("Animation resumed")):(u.pause(),$(this).text("\u25B6 Resume"),a.info("Animation paused")))}),$("#animation-stop-btn").on("click",function(){u&&(u.stop(),a.info("Animation stopped"),$("#animation-run-btn").prop("disabled",!1),$("#animation-pause-btn").prop("disabled",!0),$("#animation-stop-btn").prop("disabled",!0),$("#animation-script-input").prop("disabled",!1))}),$("#animation-download-btn").on("click",async function(){if(!(!u||u.frames.length===0))try{$(this).prop("disabled",!0),$(this).text("\u{1F4BE} Downloading..."),await u.downloadFrames(),$(this).text("\u2713 Downloaded"),setTimeout(()=>{$(this).text("\u{1F4BE} Download Frames (ZIP)"),$(this).prop("disabled",!1)},2e3)}catch(d){a.error("Download failed",d),alert("Download failed: "+d.message),$(this).text("\u{1F4BE} Download Frames (ZIP)"),$(this).prop("disabled",!1)}}),a.info("Animation panel initialized")}function s(){let l="accordionState",c={};try{let u=localStorage.getItem(l);u&&(c=JSON.parse(u))}catch(u){console.warn("Failed to load accordion state",u)}$("#controls h2").each(function(u){let d=$(this),h=d.next(".accordion-section");if(h.length===0)return;let p=d.text().trim();(c.hasOwnProperty(p)?c[p]:u>0)?(d.addClass("collapsed"),h.addClass("collapsed")):h.css("max-height",h[0].scrollHeight+"px"),d.on("click",function(){let b=$(this),x=b.next(".accordion-section"),g=b.hasClass("collapsed");g?(b.removeClass("collapsed"),x.css("max-height",x[0].scrollHeight+"px"),x.removeClass("collapsed")):(x.css("max-height",x[0].scrollHeight+"px"),x[0].offsetHeight,x.css("max-height","0"),b.addClass("collapsed"),x.addClass("collapsed")),c[p]=!g;try{localStorage.setItem(l,JSON.stringify(c))}catch(y){console.warn("Failed to save accordion state",y)}});let f=()=>{h.hasClass("collapsed")||h.css("max-height",h[0].scrollHeight+"px")};typeof ResizeObserver<"u"&&new ResizeObserver(f).observe(h[0])}),a.info("Accordion initialized with "+$("#controls h2").length+" sections")}s(),n(function(l,c){t(l,c),i(l,c),r(l),e(l,c)})});})();
//# sourceMappingURL=app.min.js.map
