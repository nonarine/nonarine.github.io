<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>N-Dimensional Vector Field Flow</title>
    <link rel="stylesheet" href="src/ui/floating-panels.css">

    <!-- Modular CSS Architecture (Phase 2 Refactoring) -->
    <link rel="stylesheet" href="src/ui/styles/z-index.css">
    <link rel="stylesheet" href="src/ui/styles/layout.css">
    <link rel="stylesheet" href="src/ui/styles/theme.css">
    <link rel="stylesheet" href="src/ui/styles/controls.css">
    <link rel="stylesheet" href="src/ui/styles/panels.css">
    <link rel="stylesheet" href="src/ui/styles/mobile.css">
    <link rel="stylesheet" href="src/ui/styles/equation-overlay.css">
    <link rel="stylesheet" href="src/ui/styles/notebook-modal.css">
    <link rel="stylesheet" href="src/ui/styles/notebook-cell.css">
</head>
<body>
    <!-- Menu Bar -->
    <div id="menu-bar">
        <div class="menu-item" id="menu-settings" title="Advanced Settings (Ctrl+,)">
            <span style="font-size: 16px; margin-right: 6px;">‚öôÔ∏è</span>
            <span>Settings</span>
        </div>
        <div class="menu-item" id="menu-notebook" title="Notebook (Function Definitions)">
            <span style="font-size: 16px; margin-right: 6px;">üìì</span>
            <span>Notebook</span>
        </div>
        <div class="menu-item" id="menu-docs" title="Documentation">
            <span style="font-size: 16px; margin-right: 6px;">üìö</span>
            <span>Docs</span>
        </div>
        <div class="menu-spacer"></div>
        <a href="https://github.com/nonarine/diffeq-flow" target="_blank" class="menu-item" title="View source on GitHub">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px;">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            <span>GitHub</span>
        </a>
    </div>

    <!-- Mobile Menu Bar (visible only on mobile) -->
    <div id="mobile-menu-bar">
        <button class="mobile-menu-btn" id="mobile-menu-controls" title="Main Controls" aria-label="Main Controls">
            <span style="font-size: 20px;">‚öôÔ∏è</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-rendering" title="Rendering Effects" aria-label="Rendering Effects">
            <span style="font-size: 20px;">‚ú®</span>
        </button>
    </div>

    <!-- Compact Mobile View Controls (visible only on mobile) -->
    <div id="mobile-view-controls">
        <button class="mobile-view-btn" id="mobile-zoom-in" title="Zoom In" aria-label="Zoom In">+</button>
        <button class="mobile-view-btn" id="mobile-zoom-out" title="Zoom Out" aria-label="Zoom Out">‚àí</button>
        <button class="mobile-view-btn" id="mobile-center" title="Center View" aria-label="Center View">‚äô</button>
    </div>

    <canvas id="canvas"></canvas>

    <!-- Equation Overlay (MathJax rendered equations) -->
    <div id="equation-overlay"></div>

    <div id="controls">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>N-Dimensional Vector Field</h1>

        <div class="control-row">
            <div class="control-group" style="flex: 1;">
                <label>Theme:</label>
                <select-control
                    id="theme-selector"
                    settings-key="theme"
                    default="dark">
                    <select>
                        <option value="dark" selected>Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group" style="flex: 1;">
                <label>Preset Examples:</label>
                <select id="preset-selector">
                    <option value="">-- Select Preset --</option>
                    <optgroup label="Built-in Presets">
                        <option value="2d_rotation">Simple Rotation (2D)</option>
                        <option value="2d_vortex">Vortex (2D)</option>
                        <option value="2d_vanderpol">Van der Pol Oscillator (2D)</option>
                        <option value="2d_fluid_stirring">Fluid Transport with Stirring (2D)</option>
                        <option value="2d_strange_attractor">Strange Attractor (2D Chaotic)</option>
                        <option value="3d_lorenz">Lorenz Attractor (3D)</option>
                        <option value="3d_rossler">R√∂ssler Attractor (3D)</option>
                        <option value="4d_hypersphere">4D Hypersphere Rotation</option>
                        <option value="4d_double_pendulum">Double Pendulum (4D Chaotic)</option>
                    </optgroup>
                    <optgroup label="Custom Presets" id="custom-presets-group" style="display: none;">
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Save Current as Preset:</label>
            <div style="display: flex; gap: 6px;">
                <input type="text" id="preset-name-input" placeholder="Enter preset name..." style="flex: 1; padding: 6px; border: 1px solid #444; background: #222; color: white; border-radius: 4px; font-size: 11px;">
                <button id="save-preset-btn" class="secondary">Save</button>
                <button id="delete-preset-btn" class="secondary" style="display: none;">Delete</button>
            </div>
        </div>

        <div class="control-group">
            <linear-slider
                id="dimensions"
                settings-key="dimensions"
                label="Dimensions"
                default="2"
                min="2"
                max="6"
                step="1"
                display-format="0">
                <label>
                    <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" decrease>-</button>
                    <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                    <button class="slider-btn" increase>+</button>
                </div>
            </linear-slider>
        </div>

        <h2>Vector Field Equations<span class="help-icon" onclick="showFieldEditor(event)" title="Advanced Editor">üîß</span><span class="help-icon" onclick="showDocs(event, 'vector-fields')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div id="dimension-inputs" class="dimension-inputs">
                <!-- Dynamically generated -->
            </div>
        </div>

        <h2>Integrator<span class="help-icon" onclick="showDocs(event, 'integrators')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select-control
                    id="integrator"
                    settings-key="integratorType"
                    default="rk4">
                    <select>
                        <optgroup label="Explicit Methods">
                            <option value="euler">Euler (1st order)</option>
                            <option value="explicit-midpoint">Explicit Midpoint (2nd order)</option>
                            <option value="heun">Heun (Explicit Trapezoidal, 2nd order)</option>
                            <option value="rk4" selected>RK4 (4th order)</option>
                        </optgroup>
                        <optgroup label="Implicit Methods (A-stable)">
                            <option value="implicit-euler">Implicit Euler (1st order)</option>
                            <option value="implicit-midpoint">Implicit Midpoint (2nd order)</option>
                            <option value="trapezoidal">Trapezoidal (2nd order)</option>
                            <option value="implicit-rk4">Implicit RK4 (4th order)</option>
                        </optgroup>
                        <optgroup label="Special Methods">
                            <option value="custom">Custom (Advanced)</option>
                        </optgroup>
                    </select>
                </select-control>
            </div>

            <div class="control-group" id="solution-method-group" style="display: none;">
                <label>Solution Method</label>
                <select-control
                    id="solution-method"
                    settings-key="solutionMethod"
                    default="fixed-point">
                    <select>
                        <option value="fixed-point">Fixed-Point Iteration</option>
                        <option value="midpoint">Midpoint Solver</option>
                        <option value="newton">Newton's Method</option>
                        <option value="newton-fd">Newton (Finite Diff)</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group">
                <animatable-timestep
                    id="timestep"
                    settings-key="timestep"
                    label="Time Step"
                    default="0.01"
                    min="0.001"
                    max="2.5"
                    step="0.001"
                    small-increment="0.001"
                    large-increment="0.01"
                    animation-min="0.001"
                    animation-max="0.1"
                    display-format="3">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease-large title="Decrease by 0.01">--</button>
                        <button class="slider-btn" decrease title="Decrease by 0.001">-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase title="Increase by 0.001">+</button>
                        <button class="slider-btn" increase-large title="Increase by 0.01">++</button>
                        <button class="slider-btn" reset title="Reset to {{default}}">‚Ü∫</button>
                        <!-- Animation button will be added by AnimatableSliderMixin -->
                    </div>
                </animatable-timestep>
            </div>

            <div class="control-group" id="implicit-iterations-group" style="display: none;">
                <linear-slider
                    id="implicit-iterations"
                    settings-key="implicitIterations"
                    label="Solver Iterations"
                    default="4"
                    min="1"
                    max="10"
                    step="1"
                    display-format="0">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                    </div>
                </linear-slider>
            </div>
        </div>

        <h2>Domain Transform<span class="help-icon" onclick="showDocs(event, 'domain-transforms')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select-control
                    id="transform"
                    settings-key="transformType"
                    default="identity">
                    <select>
                        <option value="identity" selected>No Transform (Identity)</option>
                        <optgroup label="Stretch/Compress Near Zero">
                            <option value="log">Logarithmic (Stretch Near Zero)</option>
                            <option value="exp">Exponential (Compress Near Zero)</option>
                            <option value="power">Power Transform (Configurable)</option>
                        </optgroup>
                        <optgroup label="Bounded Compression">
                            <option value="softsign">Soft-sign (To [-1,1], Simple)</option>
                            <option value="tanh">Hyperbolic Tangent (To [-1,1], Smooth)</option>
                            <option value="sigmoid">Logistic Sigmoid (To [-1,1], S-curve)</option>
                            <option value="rational">Rational (To [-1,1], Bell Jacobian)</option>
                        </optgroup>
                        <optgroup label="Special Effects">
                            <option value="sine">Sine Wave (Periodic Speed Bumps)</option>
                            <option value="radial_power">Radial Power (Distance-based)</option>
                        </optgroup>
                        <optgroup label="Advanced">
                            <option value="custom">Custom (User GLSL)</option>
                        </optgroup>
                    </select>
                </select-control>
            </div>

            <div id="transform-controls">
                <!-- Dynamically generated based on transform type -->
            </div>
        </div>

        <h2>2D Projection<span class="help-icon" onclick="showDocs(event, 'projection')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select-control
                    id="mapper"
                    settings-key="mapperType"
                    default="select">
                    <select>
                        <option value="select" selected>Select 2 Variables</option>
                        <option value="project">Linear Projection</option>
                        <option value="custom">Custom (Advanced)</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group">
                <button id="configure-coordinates" class="secondary" style="width: 100%;">Configure Coordinates</button>
            </div>

            <div id="mapper-controls">
                <!-- Dynamically generated based on mapper type -->
            </div>
        </div>

        <h2>Rendering<span class="help-icon" onclick="showDocs(event, 'particle-settings')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Color Mode:<span class="help-icon" onclick="showDocs(event, 'color-modes')" title="View documentation">üìù</span></label>
                <select-control
                    id="color-mode"
                    settings-key="colorMode"
                    default="velocity_angle">
                    <select>
                        <option value="white">Solid White</option>
                        <option value="velocity_magnitude">Velocity Magnitude</option>
                        <option value="velocity_angle">Velocity Angle</option>
                        <option value="velocity_combined">Velocity Angle + Magnitude</option>
                        <option value="field_magnitude">Field Magnitude</option>
                        <option value="field_angle">Field Angle</option>
                        <option value="field_combined">Field Angle + Magnitude</option>
                        <option value="expression">Expression</option>
                        <option value="custom">Custom (Advanced)</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group" id="gradient-button-container" style="display: none;">
                <button id="open-gradient-editor" class="secondary" style="width: 100%;">Edit Gradient</button>
            </div>

            <div class="control-group" id="velocity-scaling-container" style="display: none;">
                <label>Velocity Scaling:</label>
                <select-control
                    id="velocity-scale-mode"
                    settings-key="velocityScaleMode"
                    default="percentile95">
                    <select>
                        <option value="percentile95">95th Percentile (Recommended)</option>
                        <option value="percentile90">90th Percentile</option>
                        <option value="average">Average</option>
                        <option value="max">Maximum</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group" id="velocity-log-container" style="display: none;">
                <check-box
                    id="velocity-log-scale"
                    settings-key="velocityLogScale"
                    default="false"
                    label="Logarithmic Velocity Scale">
                </check-box>
            </div>

            <div id="expression-controls" style="display: none;">
                <div class="control-group">
                    <label>Color Expression:</label>
                    <input type="text" id="color-expression" placeholder="e.g., sin(x*y), length(pos), dx*dy" value="x * y">
                </div>
            </div>

            <div class="control-group">
                <linear-slider
                    id="particles"
                    label="Particle Count"
                    default="1000"
                    min="100"
                    max="5000000"
                    step="10000"
                    settings-key="particleCount"
                    display-format="0">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                    </div>
                </linear-slider>
            </div>

            <div class="control-group">
                <animatable-slider
                    id="fade"
                    settings-key="fadeOpacity"
                    label="Fade Speed"
                    default="0.999"
                    min="0"
                    max="100"
                    step="0.1"
                    animation-min="0.9995"
                    animation-max="0.95"
                    display-format="4">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <!-- Animation button will be added by AnimatableSliderMixin -->
                    </div>
                </animatable-slider>
            </div>

            <div class="control-group">
                <linear-slider
                    id="drop"
                    settings-key="dropProbability"
                    label="Drop Probability"
                    default="0.0"
                    min="0"
                    max="0.2"
                    step="0.001"
                    display-format="4">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                    </div>
                </linear-slider>
            </div>

            <div class="control-group">
                <button id="open-rendering-settings" class="secondary" style="width: 100%;">Rendering Effects</button>
            </div>

        </div>

        <h2>Advanced<span class="help-icon" onclick="showDocs(event, 'storage-strategy')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Storage Strategy:</label>
                <select id="storage-strategy">
                    <option value="rgba">RGBA Encoded (Compatible)</option>
                    <option value="float" selected>Float Textures (Default)</option>
                </select>
            </div>

            <div class="control-group">
                <percent-slider
                    id="respawn-margin"
                    settings-key="respawnMargin"
                    label="Respawn Margin"
                    default="0.2"
                    min="0"
                    max="300"
                    step="1"
                    display-format="0">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                    </div>
                </percent-slider>
            </div>
        </div>

        <div id="error-message"></div>
    </div>

    <div id="zoom-pan-controls">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>View<span class="help-icon" onclick="showDocs(event, 'keyboard-shortcuts')" title="View documentation">üìù</span></h1>

        <!-- Pan controls in a 3x3 grid -->
        <div class="zoom-pan-grid">
            <button class="zoom-pan-btn" id="pan-up-left" title="Pan Up-Left">‚Üñ</button>
            <button class="zoom-pan-btn" id="pan-up" title="Pan Up">‚ñ≤</button>
            <button class="zoom-pan-btn" id="pan-up-right" title="Pan Up-Right">‚Üó</button>
            <button class="zoom-pan-btn" id="pan-left" title="Pan Left">‚óÄ</button>
            <button class="zoom-pan-btn" id="pan-reset" title="Center View at Origin">‚äô</button>
            <button class="zoom-pan-btn" id="pan-right" title="Pan Right">‚ñ∂</button>
            <button class="zoom-pan-btn" id="pan-down-left" title="Pan Down-Left">‚Üô</button>
            <button class="zoom-pan-btn" id="pan-down" title="Pan Down">‚ñº</button>
            <button class="zoom-pan-btn" id="pan-down-right" title="Pan Down-Right">‚Üò</button>
        </div>

        <!-- Zoom controls -->
        <div class="zoom-btn-group">
            <button class="zoom-pan-btn zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
            <button class="zoom-pan-btn zoom-btn" id="zoom-in" title="Zoom In">+</button>
        </div>
    </div>

    <div id="display-options">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>Display<span class="help-icon" onclick="showDocs(event, 'display-options')" title="View documentation">üìù</span></h1>

        <div class="control-group">
            <check-box
                id="show-grid"
                settings-key="showGrid"
                default="true"
                label="Show coordinate grid">
            </check-box>
        </div>

        <div class="control-group">
            <check-box
                id="show-equations"
                settings-key="showEquations"
                default="false"
                label="Show equations overlay">
            </check-box>
        </div>

        <div class="control-group">
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="reset" class="secondary" style="flex: 1;">Reset View</button>
                <button id="reset-particles" class="secondary" style="flex: 1;">Clear Screen (C)</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="default-settings" class="secondary" style="flex: 1;">Default Settings</button>
                <button id="share-url" class="secondary" style="flex: 1;">Share URL</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%;">
                <button id="save-image" class="secondary" style="flex: 1;">Save Image</button>
            </div>
        </div>

        <!-- Animation Section -->
        <h1 style="cursor: pointer; user-select: none;" id="animation-section-toggle">
            Animation <span id="animation-section-arrow">‚ñº</span>
        </h1>
        <div id="animation-section-content" style="display: none;">
            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Interactive Testing</h4>

            <!-- Animation alpha control (web component) -->
            <animation-alpha id="animation-alpha" settings-key="animationAlpha" default="0.0">
                <label>
                    Animation Alpha (a): <span bind-text="value">{{value}}</span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" decrease>-</button>
                    <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                    <button class="slider-btn" increase>+</button>
                    <button class="slider-btn" reset title="Reset to 0.0">‚Ü∫</button>
                </div>
            </animation-alpha>

            <!-- Animation speed control (web component, not saved) -->
            <animation-speed id="animation-speed" default="10" min="1" max="200" display-format="0">
                <label>
                    Steps per Alpha Increment: <span bind-text="value">{{value}}</span>
                </label>
                <div class="slider-control">
                    <button class="slider-btn" decrease>-</button>
                    <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                    <button class="slider-btn" increase>+</button>
                    <button class="slider-btn" reset title="Reset to 10">‚Ü∫</button>
                </div>
            </animation-speed>

            <check-box
                id="sync-steps-to-frame-limit"
                settings-key="syncStepsToFrameLimit"
                default="false"
                label="Sync to frame limit"
                title="Set frame limit to match steps per alpha increment (preview one alpha step)"
                style="margin-top: 8px;">
            </check-box>

            <check-box
                id="animation-clear-particles"
                settings-key="animationClearParticles"
                default="false"
                label="Reset particles on alpha change"
                title="Reinitialize particle positions when alpha updates"
                style="margin-top: 12px;">
            </check-box>

            <check-box
                id="animation-clear-screen"
                settings-key="animationClearScreen"
                default="false"
                label="Freeze screen between alpha changes"
                title="Clear screen and freeze rendering between alpha updates for clean transitions">
            </check-box>

            <check-box
                id="animation-smooth-timing"
                settings-key="animationSmoothTiming"
                default="false"
                label="Alpha step time smoothing"
                title="Maintain consistent frame time by adding delays to faster alpha steps">
            </check-box>

            <check-box
                id="animation-lock-shaders"
                settings-key="animationLockShaders"
                default="false"
                label="Lock shaders during playback"
                title="When enabled, prevents shader recompilation while animation is playing (prevents hiccups from parameter changes)">
            </check-box>

            <div class="control-group" style="margin-top: 12px;">
                <action-button id="export-animation-json" label="Export Settings as Animation JSON" icon="üíæ"></action-button>
            </div>

            <hr style="border: none; border-top: 1px solid #333; margin: 16px 0;">

            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Create Animation</h4>

            <number-input id="animation-frames" label="Frames" default="100" min="1" max="10000">
                <label>Frames:</label>
                <input type="number" value="{{value}}" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </number-input>

            <number-input id="animation-loops" label="Loops" default="1" min="1" max="100">
                <label>Loops:</label>
                <input type="number" value="{{value}}" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </number-input>

            <check-box
                id="animation-half-loops"
                default="false"
                label="Count as half-loops">
            </check-box>
            <div class="info" id="animation-loops-info" style="font-size: 10px; color: #999; margin-top: 4px;">
                Number of complete alpha cycles (0.0 ‚Üí 1.0 ‚Üí 0.0)
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <action-button id="animation-create-btn" label="Create Animation" icon="‚ñ∂"></action-button>
            </div>

            <div id="animation-progress" style="display: none; margin-top: 12px;">
                <div style="font-size: 10px; margin-bottom: 4px;">
                    <span id="progress-text">Frame 0 / 0</span>
                    <span id="progress-alpha" style="float: right; color: #4CAF50;">Œ±: 0.00</span>
                </div>
                <div style="background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 16px; border: 1px solid #444;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <action-button id="animation-download-btn" label="Download Animation (ZIP)" icon="üíæ"></action-button>
            </div>
        </div>
    </div>

    <canvas id="grid-canvas"></canvas>

    <div id="cursor-position"></div>

    <div id="histogram-panel">
        <div id="histogram-header">
            <h4>HDR Brightness Histogram</h4>
            <span id="histogram-expand">‚ñº</span>
        </div>
        <div id="histogram-body">
            <canvas id="histogram-canvas"></canvas>
            <div id="histogram-info">
                Avg: <span id="hist-avg">--</span> | Max: <span id="hist-max">--</span><br>
                Max Vel: <span id="hist-vel">--</span>
            </div>
        </div>
    </div>

    <div id="step-time-counter" style="display: none;">Step: --ms</div>

    <div id="fps-counter">
        <div class="fps-display">FPS: --</div>
        <div class="frame-limit-controls">
            <!-- Frame limit controls (desktop only, hidden on mobile) -->
            <label>
                <check-box id="frame-limit-enabled" settings-key="frameLimitEnabled" default="false">
                    <input type="checkbox" checked>
                </check-box>
                Stop at:
            </label>
            <log-slider
                id="frame-limit"
                label=""
                settings-key="frameLimit"
                default="1000"
                min-value="100"
                max-value="100000"
                display-format="0">
                <input type="range" min="0" max="100" step="1" value="30">
                <span class="range-value" bind-text="value">{{value}}</span>
            </log-slider>
        </div>
    </div>

    <!-- Mobile unified controls (hidden on desktop) -->
    <mobile-controls id="mobile-controls"></mobile-controls>

    <!-- Floating gradient panel -->
    <div id="gradient-panel" class="floating-panel" style="display: none;">
        <button class="floating-panel-close" style="display: none;">&times;</button>
        <div class="floating-panel-header">
            <h3>Gradient Editor<span class="help-icon" onclick="showDocs(event, 'color-modes')" title="View documentation">üìù</span></h3>
        </div>
        <div class="floating-panel-content">
            <div id="main-gradient-editor"></div>
            <button id="reset-gradient" class="secondary" style="width: 100%; margin-top: 12px;">Reset to Default</button>
        </div>
    </div>

    <!-- Floating rendering settings panel -->
    <div id="rendering-panel" class="floating-panel" style="display: none;">
        <button class="floating-panel-close" style="display: none;">&times;</button>
        <div class="floating-panel-header">
            <h3>Rendering Effects<span class="help-icon" onclick="showDocs(event, 'rendering-effects')" title="View documentation">üìù</span></h3>
        </div>
        <div class="floating-panel-content">
            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">HDR Rendering</h4>
            <div class="control-group">
                <check-box
                    id="use-hdr"
                    settings-key="useHDR"
                    default="true"
                    label="Enable HDR (float framebuffers)">
                </check-box>
            </div>

            <div class="control-group">
                <check-box
                    id="use-depth-test"
                    settings-key="useDepthTest"
                    default="false"
                    label="Enable Depth Testing (Plasma Mode)">
                </check-box>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Render Scale</h4>
            <div class="control-group">
                <linear-slider
                    id="supersample-factor"
                    settings-key="supersampleFactor"
                    label="Resolution Scale"
                    default="1.0"
                    min="0.5"
                    max="4.0"
                    step="0.5"
                    display-format="1">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}x</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0x)">‚Ü∫</button>
                    </div>
                </linear-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">SMAA Antialiasing</h4>
            <div class="control-group">
                <check-box
                    id="smaa-enabled"
                    settings-key="smaaEnabled"
                    default="true"
                    label="Enable SMAA (morphological AA)">
                </check-box>
            </div>

            <div class="control-group">
                <percent-slider
                    id="smaa-intensity"
                    settings-key="smaaIntensity"
                    label="SMAA Intensity"
                    default="0.75"
                    min="0"
                    max="100"
                    step="1"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.75)">‚Ü∫</button>
                    </div>
                </percent-slider>
            </div>

            <div class="control-group">
                <percent-slider
                    id="smaa-threshold"
                    settings-key="smaaThreshold"
                    label="SMAA Threshold"
                    default="0.10"
                    min="0"
                    max="100"
                    step="1"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.10)">‚Ü∫</button>
                    </div>
                </percent-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Bilateral Filter (Noise Reduction)</h4>
            <div class="control-group">
                <check-box
                    id="bilateral-enabled"
                    settings-key="bilateralEnabled"
                    default="false"
                    label="Enable Bilateral Filter">
                </check-box>
            </div>

            <div class="control-group">
                <linear-slider
                    id="bilateral-spatial"
                    settings-key="bilateralSpatialSigma"
                    label="Spatial Sigma"
                    default="4.0"
                    min="10"
                    max="100"
                    step="1"
                    transform="20"
                    display-format="1">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (4.0)">‚Ü∫</button>
                    </div>
                </linear-slider>
            </div>

            <div class="control-group">
                <linear-slider
                    id="bilateral-intensity"
                    settings-key="bilateralIntensitySigma"
                    label="Intensity Sigma"
                    default="0.20"
                    min="1"
                    max="50"
                    step="0.1"
                    transform="100"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.20)">‚Ü∫</button>
                    </div>
                </linear-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Tone Mapping</h4>
            <div class="control-group">
                <label>Operator:</label>
                <select-control
                    id="tonemap-operator"
                    settings-key="tonemapOperator"
                    default="aces">
                    <select>
                        <option value="aces" selected>ACES (Film-like)</option>
                        <option value="reinhard">Reinhard (Simple)</option>
                        <option value="reinhard_extended">Reinhard Extended</option>
                        <option value="luminance_reinhard">Luminance Reinhard (Hue Preserving)</option>
                        <option value="luminance_extended">Luminance Extended (Best for Attractors)</option>
                        <option value="filmic">Filmic</option>
                        <option value="uncharted2">Uncharted 2 (Game-style)</option>
                        <option value="hable">Hable Filmic</option>
                        <option value="linear">Linear (No Tone Mapping)</option>
                    </select>
                </select-control>
            </div>

            <div class="control-group">
                <log-slider
                    id="exposure"
                    label="Exposure"
                    default="1.0"
                    min-value="0.0001"
                    max-value="10.0"
                    display-format="4">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <div class="control-group">
                <log-slider
                    id="gamma"
                    label="Gamma"
                    default="2.2"
                    min-value="0.2"
                    max-value="10.0"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (2.2)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <div class="control-group">
                <log-slider
                    id="luminance-gamma"
                    settings-key="luminanceGamma"
                    label="Luminance Gamma"
                    default="1.0"
                    min-value="0.2"
                    max-value="10.0"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <div class="control-group">
                <log-slider
                    id="highlight-compression"
                    settings-key="highlightCompression"
                    label="Highlight Compression"
                    default="0.01"
                    min-value="0.001"
                    max-value="10.0"
                    display-format="3">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <div class="control-group">
                <log-slider
                    id="compression-threshold"
                    settings-key="compressionThreshold"
                    label="Compression Threshold"
                    default="1.0"
                    min-value="0.0001"
                    max-value="100000.0"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <div class="control-group" id="white-point-control">
                <log-slider
                    id="white-point"
                    settings-key="whitePoint"
                    label="White Point"
                    default="2.0"
                    min-value="1.0"
                    max-value="1000.0"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (2.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Intensity</h4>
            <div class="control-group">
                <log-slider
                    id="particle-intensity"
                    settings-key="particleIntensity"
                    label="Intensity"
                    default="1.0"
                    min-value="0.001"
                    max-value="100.0"
                    display-format="3">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Size</h4>
            <div class="control-group">
                <log-slider
                    id="particle-size"
                    settings-key="particleSize"
                    label="Size"
                    default="1.0"
                    min-value="0.1"
                    max-value="10.0"
                    display-format="1">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="0" max="100" step="0.1">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </log-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Render Mode</h4>
            <div class="control-group">
                <label>Mode:</label>
                <select-control
                    id="particle-render-mode"
                    settings-key="particleRenderMode"
                    default="points">
                    <select>
                        <option value="points">Points</option>
                        <option value="lines">Lines (Motion Trails)</option>
                    </select>
                </select-control>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Color Saturation</h4>
            <div class="control-group">
                <percent-slider
                    id="color-saturation"
                    settings-key="colorSaturation"
                    label="Saturation"
                    default="1.0"
                    min="0"
                    max="100"
                    step="1"
                    settings-key="colorSaturation"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </percent-slider>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Brightness Desaturation</h4>
            <div class="control-group">
                <percent-slider
                    id="brightness-desat"
                    settings-key="brightnessDesaturation"
                    label="Bright Desat"
                    default="0.0"
                    min="0"
                    max="100"
                    step="1"
                    settings-key="brightnessDesaturation"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.0)">‚Ü∫</button>
                    </div>
                </percent-slider>
            </div>

            <div class="control-group">
                <percent-slider
                    id="saturation-buildup"
                    settings-key="brightnessSaturation"
                    label="Saturation Buildup"
                    default="0.0"
                    min="0"
                    max="100"
                    step="1"
                    settings-key="brightnessSaturation"
                    display-format="2">
                    <label>
                        <span>{{label}}</span>: <span class="range-value" bind-text="value">{{value}}</span>
                    </label>
                    <div class="slider-control">
                        <button class="slider-btn" decrease>-</button>
                        <input type="range" min="{{min}}" max="{{max}}" step="{{step}}" value="{{value}}">
                        <button class="slider-btn" increase>+</button>
                        <button class="slider-btn" reset title="Reset to default (0.0)">‚Ü∫</button>
                    </div>
                </percent-slider>
            </div>
        </div>
    </div>

    <!-- Nerdamer for symbolic differentiation (Jacobian computation) -->
    <!-- MathJax for equation rendering -->
    <script>
        // MathJax v3 Configuration (must be defined before loading MathJax)
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    console.log('MathJax is loaded and ready');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/all.min.js"></script>
    <!-- JSZip for bundling animation frames -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Marked.js for markdown parsing in documentation -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Coordinate System Modules (loaded before main.js) -->
    

    <!-- Modal Window -->
    <div id="modal-overlay">
        <div id="modal-window">
            <div id="modal-header">
                <h2 id="modal-title">Advanced Settings</h2>
                <button id="modal-close">&times;</button>
            </div>
            <div id="modal-tab-bar">
                <!-- Tab buttons will be added dynamically -->
            </div>
            <div id="modal-content">
                <!-- Tab content will be rendered here -->
            </div>
        </div>
    </div>
    <script src="app.min.js"></script>
</body>
</html>
