<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>N-Dimensional Vector Field Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Light theme */
        body.light-theme {
            background: #f5f5f5;
            color: #212121;
        }

        body.light-theme #canvas {
            filter: invert(1);
        }

        body.light-theme #grid-canvas {
            filter: invert(1);
        }

        body.light-theme #controls {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #controls h1 {
            color: #2E7D32;
        }

        body.light-theme #controls h2 {
            color: #1976D2;
            border-color: #ddd;
        }

        body.light-theme #controls h2:hover {
            background: rgba(25, 118, 210, 0.1);
        }

        body.light-theme label {
            color: #555;
        }

        body.light-theme input[type="text"],
        body.light-theme input[type="number"],
        body.light-theme textarea,
        body.light-theme select {
            background: #fff;
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme .slider-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .slider-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .info {
            color: #666;
        }

        body.light-theme #cursor-position {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #2E7D32;
        }

        body.light-theme #step-time-counter {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #F57C00;
        }

        body.light-theme #fps-counter {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #2E7D32;
        }

        body.light-theme #fps-counter .frame-limit-controls label {
            color: #666;
        }

        body.light-theme #fps-counter .frame-limit-controls .range-value {
            color: #2E7D32;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: move;
        }

        #grid-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        #cursor-position {
            position: absolute;
            bottom: 220px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #4CAF50;
            z-index: 100;
            transition: left 0.3s ease-in-out;
        }

        #cursor-position.shifted {
            right: 390px;
            left: auto;
        }

        #histogram-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            z-index: 100;
            transition: left 0.3s ease-in-out, right 0.3s ease-in-out;
        }

        #histogram-panel.shifted {
            right: 390px;
            left: auto;
        }

        #histogram-panel.collapsed #histogram-body {
            display: none;
        }

        #histogram-header {
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #histogram-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        #histogram-header h4 {
            margin: 0;
            font-size: 12px;
            color: #4CAF50;
            flex: 1;
        }

        #histogram-expand {
            font-size: 10px;
            color: #888;
        }

        #histogram-body {
            padding: 8px 12px;
            border-top: 1px solid #444;
        }

        #histogram-canvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        #histogram-info {
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #888;
        }

        #step-time-counter {
            position: absolute;
            bottom: 100px;
            right: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #FFA726;
            z-index: 10;
        }

        #fps-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
            z-index: 10;
        }

        #fps-counter .fps-display {
            margin-bottom: 6px;
        }

        #fps-counter .frame-limit-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 6px;
        }

        #fps-counter .frame-limit-controls label {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #aaa;
            font-weight: normal;
        }

        #fps-counter .frame-limit-controls input[type="checkbox"] {
            margin: 0;
        }

        #fps-counter .frame-limit-controls input[type="range"] {
            width: 100px;
            height: 4px;
        }

        #fps-counter .frame-limit-controls .range-value {
            color: #4CAF50;
            width: 50px;
            text-align: right;
            display: inline-block;
        }

        #controls {
            position: absolute;
            top: calc(32px + 25px); /* Menu bar + offset */
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            width: 340px;
            max-height: calc(90vh - 57px - 20px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 200;
        }

        #controls h1 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        #zoom-pan-controls {
            position: absolute;
            top: calc(32px + 25px); /* Menu bar + offset */
            right: 380px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            width: 130px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 150;
        }

        #zoom-pan-controls h1 {
            font-size: 12px;
            margin-bottom: 6px;
            color: #4CAF50;
            text-align: center;
        }

        body.light-theme #zoom-pan-controls {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #zoom-pan-controls h1 {
            color: #2E7D32;
        }

        .zoom-pan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }

        .zoom-pan-btn {
            background: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            user-select: none;
            transition: background 0.2s, border-color 0.2s;
        }

        .zoom-pan-btn:hover {
            background: #444;
            border-color: #666;
        }

        .zoom-pan-btn:active {
            background: #222;
        }

        body.light-theme .zoom-pan-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .zoom-pan-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .zoom-pan-btn:active {
            background: #c0c0c0;
        }

        .zoom-btn-group {
            display: flex;
            gap: 4px;
        }

        .zoom-btn {
            flex: 1;
        }

        #display-options {
            position: absolute;
            top: calc(32px + 25px); /* Menu bar + offset */
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            width: 240px;
            max-height: calc(90vh - 60px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        #display-options h1 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        body.light-theme #display-options {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #display-options h1 {
            color: #2E7D32;
        }

        #animation-section-content {
            max-height: calc(70vh - 200px);
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Scrollbar styling for animation sections */
        #animation-section-content::-webkit-scrollbar,
        #display-options::-webkit-scrollbar {
            width: 8px;
        }

        #animation-section-content::-webkit-scrollbar-track,
        #display-options::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        #animation-section-content::-webkit-scrollbar-thumb,
        #display-options::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 4px;
        }

        #animation-section-content::-webkit-scrollbar-thumb:hover,
        #display-options::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.7);
        }

        #controls h2 {
            font-size: 13px;
            margin: 10px 0 6px 0;
            color: #64B5F6;
            border-bottom: 1px solid #333;
            padding: 6px 30px 6px 0;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }

        #controls h2:hover {
            background: rgba(100, 181, 246, 0.1);
        }

        #controls h2 .help-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
        }

        #controls h2::after {
            content: '‚ñº';
            font-size: 10px;
            transition: transform 0.2s;
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
        }

        #controls h2.collapsed::after {
            transform: translateY(-50%) rotate(-90deg);
        }

        .accordion-section {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .accordion-section.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-row .control-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 11px;
            margin-bottom: 3px;
            color: #aaa;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 6px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        textarea {
            resize: vertical;
            min-height: 32px;
        }

        input[type="range"] {
            width: 100%;
            margin: 3px 0;
            flex: 1;
        }

        .range-value {
            display: inline-block;
            float: right;
            font-size: 10px;
            color: #888;
        }

        .slider-control {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .slider-btn {
            background: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 1px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            user-select: none;
            flex-shrink: 0;
        }

        .slider-btn:hover {
            background: #444;
            border-color: #666;
        }

        .slider-btn:active {
            background: #222;
        }

        .slider-btn.anim-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* Animation bounds slider */
        .animation-bounds-slider {
            margin: 8px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .bounds-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .bounds-labels span {
            font-weight: bold;
        }

        /* Multi-thumb slider */
        .multi-thumb-slider {
            position: relative;
            height: 32px;
            margin: 4px 0;
        }

        .slider-track {
            position: absolute;
            top: 14px;
            left: 0;
            right: 0;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        .slider-range {
            position: absolute;
            top: 14px;
            height: 4px;
            background: #4CAF50;
            border-radius: 2px;
            pointer-events: none;
        }

        .slider-current-indicator {
            position: absolute;
            top: 12px;
            width: 2px;
            height: 8px;
            background: #FFA726;
            pointer-events: none;
            z-index: 5;
            transform: translateX(-1px);
        }

        .slider-thumb {
            position: absolute;
            top: 0;
            width: 16px;
            height: 32px;
            background: #555;
            border: 2px solid #888;
            border-radius: 4px;
            cursor: grab;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background 0.2s, border-color 0.2s;
        }

        .slider-thumb:hover {
            background: #666;
            border-color: #aaa;
        }

        .slider-thumb.dragging {
            cursor: grabbing;
            background: #777;
            border-color: #ccc;
            z-index: 11;
        }

        .slider-thumb.min-thumb {
            border-color: #2196F3;
        }

        .slider-thumb.max-thumb {
            border-color: #F44336;
        }

        .slider-thumb.min-thumb:hover {
            border-color: #42A5F5;
        }

        .slider-thumb.max-thumb:hover {
            border-color: #EF5350;
        }

        .thumb-label {
            font-size: 7px;
            font-weight: bold;
            color: #ccc;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 3px 3px 3px 0;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        .dimension-inputs {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dimension-input {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dimension-input label {
            min-width: 22px;
            margin: 0;
        }

        .dimension-input input {
            flex: 1;
        }

        .info {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }

        .floating-panel {
            position: fixed;
            right: 330px;
            top: calc(32px + 25px); /* Menu bar + offset */
            width: 320px;
            max-height: calc(90vh - 67px); /* Account for menu bar + offset */
            background: rgba(30, 30, 30, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* Wider panel for coordinate editor */
        #coordinate-editor-panel {
            width: 480px;
            z-index: 300; /* Above controls panel (z-index: 200) */
        }

        /* Rendering effects panel on top */
        #rendering-panel {
            z-index: 350; /* Above all other panels */
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        body.light-theme .floating-panel {
            background: rgba(255, 255, 255, 0.98);
            border-color: #ccc;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .floating-panel-header {
            padding: 12px;
            background: #252525;
            border-bottom: 1px solid #444;
        }

        body.light-theme .floating-panel-header {
            background: #f5f5f5;
            border-bottom-color: #ddd;
        }

        .floating-panel-header h3 {
            margin: 0;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
        }

        body.light-theme .floating-panel-header h3 {
            color: #212121;
        }

        /* Alias for coordinate editor */
        .panel-header {
            padding: 12px 16px;
            background: #252525;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        body.light-theme .panel-header {
            background: #f5f5f5;
            border-bottom-color: #ddd;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
        }

        body.light-theme .panel-header h3 {
            color: #212121;
        }

        .panel-close {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        body.light-theme .panel-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #212121;
        }

        .panel-content {
            padding: 20px;
            max-height: calc(90vh - 117px); /* Account for menu bar + offset + header */
            overflow-y: auto;
        }

        .floating-panel-content {
            padding: 12px;
            max-height: calc(90vh - 117px); /* Account for menu bar + offset + header */
            overflow-y: auto;
        }

        /* Coordinate Editor Styles */
        .coordinate-editor-content {
            min-width: 400px;
        }

        .coordinate-variables {
            margin: 20px 0 15px 0;
        }

        .coordinate-variables > div:first-child {
            margin-bottom: 12px;
        }

        .coord-var-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .coord-var-label {
            width: 60px !important;
            flex-shrink: 0;
            text-align: center;
            font-weight: 500;
        }

        .coord-var-transform {
            flex: 1;
            min-width: 0; /* Allow flex item to shrink below content size */
        }

        .coordinate-editor-buttons {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
        }

        body.light-theme .coordinate-editor-buttons {
            border-top-color: #ddd;
        }

        .coordinate-editor-buttons button {
            flex: 1;
            transition: all 0.2s;
        }

        .coordinate-editor-buttons button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .info-text {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 11px;
            line-height: 1.4;
            color: #999;
        }

        body.light-theme .info-text {
            background: rgba(0, 0, 0, 0.03);
            color: #666;
        }

        #gradient-preset-toggle {
            border-bottom-color: #444 !important;
        }

        body.light-theme #gradient-preset-toggle {
            border-bottom-color: #ddd !important;
        }

        #error-message {
            background: #d32f2f;
            color: white;
            padding: 6px;
            border-radius: 4px;
            margin-top: 6px;
            display: none;
            font-size: 10px;
        }

        /* Gradient editor styles */
        .gradient-stops {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 8px;
        }

        .gradient-stop {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .gradient-stop .color-picker {
            width: 40px;
            height: 25px;
            padding: 0;
            border: 1px solid #444;
            cursor: pointer;
        }

        .gradient-stop .stop-position {
            width: 60px;
            padding: 4px;
        }

        .gradient-stop .remove-stop {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .gradient-stop .remove-stop:hover {
            background: #b71c1c;
        }

        .gradient-preview {
            width: 100%;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #444;
            margin-top: 8px;
        }

        /* Modal Window */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100000;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        #modal-window {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
            width: calc(100% - 20px);
            height: calc(100% - 20px);
            max-width: none;
            max-height: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        body.light-theme #modal-window {
            background: #ffffff;
            border-color: #ccc;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
        }

        #modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #252525;
            border-bottom: 1px solid #444;
        }

        body.light-theme #modal-header {
            background: #f5f5f5;
            border-bottom-color: #ddd;
        }

        #modal-title {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
        }

        body.light-theme #modal-title {
            color: #212121;
        }

        #modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        #modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        body.light-theme #modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #212121;
        }

        #modal-tab-bar {
            display: flex;
            gap: 0;
            background: #1f1f1f;
            border-bottom: 1px solid #444;
            overflow-x: auto;
        }

        body.light-theme #modal-tab-bar {
            background: #e8e8e8;
            border-bottom-color: #ccc;
        }

        .modal-tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .modal-tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        body.light-theme .modal-tab-button:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #212121;
        }

        .modal-tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        body.light-theme .modal-tab-button.active {
            color: #2E7D32;
            border-bottom-color: #2E7D32;
            background: rgba(46, 125, 50, 0.1);
        }

        #modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        /* Documentation Tab Styles */
        .docs-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .docs-section {
            margin-bottom: 16px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #1f1f1f;
            overflow: hidden;
        }

        body.light-theme .docs-section {
            background: #f9f9f9;
            border-color: #ddd;
        }

        .docs-section-header {
            padding: 14px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252525;
            transition: background 0.2s;
        }

        body.light-theme .docs-section-header {
            background: #f0f0f0;
        }

        .docs-section-header:hover {
            background: #2a2a2a;
        }

        body.light-theme .docs-section-header:hover {
            background: #e8e8e8;
        }

        .docs-section-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 500;
            color: #4CAF50;
        }

        body.light-theme .docs-section-header h3 {
            color: #2E7D32;
        }

        .docs-toggle {
            color: #888;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .docs-section.collapsed .docs-toggle {
            transform: rotate(-90deg);
        }

        .docs-section-content {
            padding: 20px 32px;
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            line-height: 1.6;
        }

        .docs-section.collapsed .docs-section-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .docs-section-content p {
            margin: 0 0 10px 0;
            color: #ccc;
            font-size: 12px;
        }

        body.light-theme .docs-section-content p {
            color: #444;
        }

        .docs-section-content h5 {
            margin: 16px 0 8px 0;
            font-size: 12px;
            font-weight: 600;
            color: #4CAF50;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
        }

        body.light-theme .docs-section-content h5 {
            color: #2E7D32;
            border-bottom-color: #ddd;
        }

        .docs-section-content h5:first-child {
            margin-top: 0;
        }

        .docs-section-content code {
            background: #2a2a2a;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #4CAF50;
        }

        body.light-theme .docs-section-content code {
            background: #e8e8e8;
            color: #2E7D32;
        }

        .code-example {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        body.light-theme .code-example {
            background: #fff;
            border-color: #ddd;
        }

        .code-example strong {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Help Icon Styles */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            vertical-align: middle;
        }

        .help-icon:hover {
            opacity: 1;
        }

        label .help-icon {
            margin-left: 4px;
        }

        /* Menu Bar */
        #menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 12px;
            z-index: 10001;
            gap: 8px;
        }

        body.light-theme #menu-bar {
            background: #f5f5f5;
            border-bottom-color: #ccc;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
            user-select: none;
        }

        body.light-theme .menu-item {
            color: #333;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        body.light-theme .menu-item:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #000;
        }

        .menu-item.icon {
            padding: 4px 8px;
            font-size: 16px;
        }

        .menu-spacer {
            flex: 1;
        }

        /* GitHub link styling */
        .menu-item svg {
            fill: currentColor;
        }

        /* Adjust canvas and grid to account for menu bar */
        #canvas {
            top: 32px;
            height: calc(100vh - 32px);
        }

        #grid-canvas {
            top: 32px;
            height: calc(100vh - 32px);
        }

        /* Mobile Menu Bar (hidden on desktop) */
        #mobile-menu-bar {
            display: none; /* Hidden by default, shown in media query */
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-right: none;
            border-radius: 8px 0 0 8px;
            padding: 8px 6px;
            flex-direction: column;
            gap: 12px;
            z-index: 10000;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
        }

        body.light-theme #mobile-menu-bar {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.15);
        }

        .mobile-menu-btn {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
            transition: background 0.2s, border-color 0.2s, transform 0.1s;
            user-select: none;
        }

        .mobile-menu-btn:hover {
            background: #444;
            border-color: #666;
        }

        .mobile-menu-btn:active {
            background: #222;
            transform: scale(0.95);
        }

        .mobile-menu-btn.active {
            background: #4CAF50;
            border-color: #66BB6A;
        }

        body.light-theme .mobile-menu-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .mobile-menu-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .mobile-menu-btn:active {
            background: #c0c0c0;
        }

        body.light-theme .mobile-menu-btn.active {
            background: #4CAF50;
            border-color: #66BB6A;
            color: #fff;
        }

        /* Mobile Overlay Panel Styles */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 30, 30, 0.98);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
            padding-top: 60px; /* Space for close button */
            animation: slideInRight 0.3s ease-out;
        }

        body.light-theme .mobile-overlay {
            background: rgba(255, 255, 255, 0.98);
        }

        .mobile-overlay.active {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .mobile-overlay-close {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            transition: background 0.2s, transform 0.1s;
        }

        .mobile-overlay-close:hover {
            background: #444;
            transform: scale(1.1);
        }

        .mobile-overlay-close:active {
            background: #222;
            transform: scale(0.95);
        }

        body.light-theme .mobile-overlay-close {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .mobile-overlay-close:hover {
            background: #d0d0d0;
        }

        body.light-theme .mobile-overlay-close:active {
            background: #c0c0c0;
        }

        /* Compact Mobile View Controls (hidden on desktop) */
        #mobile-view-controls {
            display: none; /* Hidden by default, shown in media query */
            position: fixed;
            bottom: 20px;
            right: 8px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 6px;
            flex-direction: column;
            gap: 8px;
            z-index: 9998; /* Below mobile menu bar */
            box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        body.light-theme #mobile-view-controls {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.15);
        }

        .mobile-view-btn {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
            font-size: 20px;
            font-weight: bold;
            transition: background 0.2s, border-color 0.2s, transform 0.1s;
            user-select: none;
        }

        .mobile-view-btn:hover {
            background: #444;
            border-color: #666;
        }

        .mobile-view-btn:active {
            background: #222;
            transform: scale(0.95);
        }

        body.light-theme .mobile-view-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .mobile-view-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .mobile-view-btn:active {
            background: #c0c0c0;
        }

        /* Mobile Layout - Tablet and below */
        @media screen and (max-width: 768px) {
            /* Show mobile menu bar */
            #mobile-menu-bar {
                display: flex;
            }

            /* Show compact mobile view controls */
            #mobile-view-controls {
                display: flex;
            }

            /* Hide desktop panels by default */
            #controls,
            #zoom-pan-controls,
            #display-options {
                display: none;
            }

            /* When panels are opened as overlays on mobile, they take full screen */
            #controls.mobile-overlay,
            #zoom-pan-controls.mobile-overlay,
            #display-options.mobile-overlay {
                display: block;
            }

            /* Adjust panel widths for full-screen mobile */
            #controls.mobile-overlay {
                width: 100%;
                max-width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 0;
                max-height: 100vh;
            }

            #zoom-pan-controls.mobile-overlay {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
                position: static;
            }

            #display-options.mobile-overlay {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
                position: static;
            }

            /* Hide bottom overlays except FPS counter */
            #histogram-panel,
            #cursor-position,
            #step-time-counter {
                display: none;
            }

            /* Compact FPS counter for mobile */
            #fps-counter {
                top: 40px;
                right: 8px;
                bottom: auto;
                font-size: 11px;
                padding: 4px 8px;
                background: rgba(30, 30, 30, 0.7);
                opacity: 0.8;
            }

            body.light-theme #fps-counter {
                background: rgba(255, 255, 255, 0.7);
            }

            /* Floating panels become full-screen modals on mobile */
            #gradient-panel.mobile-active,
            #rendering-settings-panel.mobile-active,
            #coordinate-editor-panel.mobile-active {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100vh;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                z-index: 10002;
            }

            /* Reduce font sizes slightly on mobile */
            body {
                font-size: 13px;
            }

            h1 {
                font-size: 16px;
            }

            h2 {
                font-size: 14px;
            }

            label {
                font-size: 12px;
            }

            /* Increase touch target sizes */
            button,
            input[type="range"],
            select {
                min-height: 36px;
            }

            .slider-btn {
                min-width: 36px;
                min-height: 36px;
                font-size: 14px;
            }

            /* Compact top menu bar on mobile */
            #menu-bar {
                padding: 4px 8px;
                height: 32px;
            }

            .menu-item {
                padding: 4px 10px;
                font-size: 12px;
            }

            .menu-item span:not(:first-child) {
                display: none; /* Hide text labels, keep only icons */
            }

            .menu-item svg {
                margin-right: 0 !important;
            }

            /* Animation panel adjustments */
            #animation-panel {
                left: 10px;
                right: 10px;
                width: auto;
                max-width: calc(100vw - 80px);
            }
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div id="menu-bar">
        <div class="menu-item" id="menu-settings" title="Advanced Settings (Ctrl+,)">
            <span style="font-size: 16px; margin-right: 6px;">‚öôÔ∏è</span>
            <span>Settings</span>
        </div>
        <div class="menu-item" id="menu-docs" title="Documentation">
            <span style="font-size: 16px; margin-right: 6px;">üìö</span>
            <span>Docs</span>
        </div>
        <div class="menu-spacer"></div>
        <a href="https://github.com/nonarine/diffeq-flow" target="_blank" class="menu-item" title="View source on GitHub">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px;">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            <span>GitHub</span>
        </a>
    </div>

    <!-- Mobile Menu Bar (visible only on mobile) -->
    <div id="mobile-menu-bar">
        <button class="mobile-menu-btn" id="mobile-menu-controls" title="Main Controls" aria-label="Main Controls">
            <span style="font-size: 20px;">‚öôÔ∏è</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-view" title="View Controls" aria-label="View Controls">
            <span style="font-size: 20px;">üîç</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-display" title="Display Options" aria-label="Display Options">
            <span style="font-size: 20px;">üé®</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-animation" title="Animation" aria-label="Animation" style="display: none;">
            <span style="font-size: 20px;">‚ñ∂Ô∏è</span>
        </button>
    </div>

    <!-- Compact Mobile View Controls (visible only on mobile) -->
    <div id="mobile-view-controls">
        <button class="mobile-view-btn" id="mobile-zoom-in" title="Zoom In" aria-label="Zoom In">+</button>
        <button class="mobile-view-btn" id="mobile-zoom-out" title="Zoom Out" aria-label="Zoom Out">‚àí</button>
        <button class="mobile-view-btn" id="mobile-center" title="Center View" aria-label="Center View">‚äô</button>
    </div>

    <canvas id="canvas"></canvas>

    <div id="controls">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>N-Dimensional Vector Field</h1>

        <div class="control-row">
            <div class="control-group" style="flex: 1;">
                <label>Theme:</label>
                <select id="theme-selector">
                    <option value="dark" selected>Dark Mode</option>
                    <option value="light">Light Mode</option>
                </select>
            </div>

            <div class="control-group" style="flex: 1;">
                <label>Preset Examples:</label>
                <select id="preset-selector">
                    <option value="">-- Select Preset --</option>
                    <optgroup label="Built-in Presets">
                        <option value="2d_rotation">Simple Rotation (2D)</option>
                        <option value="2d_vortex">Vortex (2D)</option>
                        <option value="2d_vanderpol">Van der Pol Oscillator (2D)</option>
                        <option value="2d_fluid_stirring">Fluid Transport with Stirring (2D)</option>
                        <option value="2d_strange_attractor">Strange Attractor (2D Chaotic)</option>
                        <option value="3d_lorenz">Lorenz Attractor (3D)</option>
                        <option value="3d_rossler">R√∂ssler Attractor (3D)</option>
                        <option value="4d_hypersphere">4D Hypersphere Rotation</option>
                        <option value="4d_double_pendulum">Double Pendulum (4D Chaotic)</option>
                    </optgroup>
                    <optgroup label="Custom Presets" id="custom-presets-group" style="display: none;">
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Save Current as Preset:</label>
            <div style="display: flex; gap: 6px;">
                <input type="text" id="preset-name-input" placeholder="Enter preset name..." style="flex: 1; padding: 6px; border: 1px solid #444; background: #222; color: white; border-radius: 4px; font-size: 11px;">
                <button id="save-preset-btn" class="secondary">Save</button>
                <button id="delete-preset-btn" class="secondary" style="display: none;">Delete</button>
            </div>
        </div>

        <div class="control-group">
            <label>Dimensions: <span class="range-value" id="dim-value">2</span></label>
            <div class="slider-control">
                <button class="slider-btn" data-slider="dimensions" data-action="decrease">-</button>
                <input type="range" id="dimensions">
                <button class="slider-btn" data-slider="dimensions" data-action="increase">+</button>
            </div>
        </div>

        <h2>Vector Field Equations<span class="help-icon" onclick="window.appModal?.show('docs', 'vector-fields')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div id="dimension-inputs" class="dimension-inputs">
                <!-- Dynamically generated -->
            </div>
        </div>

        <h2>Integrator<span class="help-icon" onclick="window.appModal?.show('docs', 'integrators')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="integrator">
                    <optgroup label="Explicit Methods">
                        <option value="euler">Euler (1st order)</option>
                        <option value="explicit-midpoint">Explicit Midpoint (2nd order)</option>
                        <option value="heun">Heun (Explicit Trapezoidal, 2nd order)</option>
                        <option value="rk4" selected>RK4 (4th order)</option>
                    </optgroup>
                    <optgroup label="Implicit Methods (A-stable)">
                        <option value="implicit-euler">Implicit Euler (1st order)</option>
                        <option value="implicit-midpoint">Implicit Midpoint (2nd order)</option>
                        <option value="trapezoidal">Trapezoidal (2nd order)</option>
                        <option value="implicit-rk4">Implicit RK4 (4th order)</option>
                    </optgroup>
                    <optgroup label="Special Methods">
                        <option value="custom">Custom (Advanced)</option>
                    </optgroup>
                </select>
            </div>

            <div class="control-group" id="solution-method-group" style="display: none;">
                <label>Solution Method</label>
                <select id="solution-method">
                    <option value="fixed-point">Fixed-Point Iteration</option>
                    <option value="midpoint">Midpoint Solver</option>
                    <option value="newton">Newton's Method</option>
                    <option value="newton-fd">Newton (Finite Diff)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Time Step: <span class="range-value" id="timestep-value">0.01</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="timestep" data-action="decrease-large" title="Decrease by 0.01">--</button>
                    <button class="slider-btn" data-slider="timestep" data-action="decrease" title="Decrease by 0.001">-</button>
                    <input type="range" id="timestep">
                    <button class="slider-btn" data-slider="timestep" data-action="increase" title="Increase by 0.001">+</button>
                    <button class="slider-btn" data-slider="timestep" data-action="increase-large" title="Increase by 0.01">++</button>
                    <button class="slider-btn" data-slider="timestep" data-action="reset" title="Reset to 0.01">‚Ü∫</button>
                    <!-- Animation button will be added by AnimatableTimestepControl -->
                </div>
            </div>

            <div class="control-group" id="implicit-iterations-group" style="display: none;">
                <label>Solver Iterations: <span class="range-value" id="implicit-iterations-value">4</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="implicit-iterations" data-action="decrease">-</button>
                    <input type="range" id="implicit-iterations">
                    <button class="slider-btn" data-slider="implicit-iterations" data-action="increase">+</button>
                </div>
            </div>
        </div>

        <h2>Domain Transform<span class="help-icon" onclick="window.appModal?.show('docs', 'domain-transforms')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="transform">
                    <option value="identity" selected>No Transform (Identity)</option>
                    <optgroup label="Stretch/Compress Near Zero">
                        <option value="log">Logarithmic (Stretch Near Zero)</option>
                        <option value="exp">Exponential (Compress Near Zero)</option>
                        <option value="power">Power Transform (Configurable)</option>
                    </optgroup>
                    <optgroup label="Bounded Compression">
                        <option value="softsign">Soft-sign (To [-1,1], Simple)</option>
                        <option value="tanh">Hyperbolic Tangent (To [-1,1], Smooth)</option>
                        <option value="sigmoid">Logistic Sigmoid (To [-1,1], S-curve)</option>
                        <option value="rational">Rational (To [-1,1], Bell Jacobian)</option>
                    </optgroup>
                    <optgroup label="Special Effects">
                        <option value="sine">Sine Wave (Periodic Speed Bumps)</option>
                        <option value="radial_power">Radial Power (Distance-based)</option>
                    </optgroup>
                    <optgroup label="Advanced">
                        <option value="custom">Custom (User GLSL)</option>
                    </optgroup>
                </select>
            </div>

            <div id="transform-controls">
                <!-- Dynamically generated based on transform type -->
            </div>
        </div>

        <h2>2D Projection<span class="help-icon" onclick="window.appModal?.show('docs', 'projection')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="mapper">
                    <option value="select" selected>Select 2 Variables</option>
                    <option value="project">Linear Projection</option>
                    <option value="custom">Custom (Advanced)</option>
                </select>
            </div>

            <div class="control-group">
                <button id="configure-coordinates" class="secondary" style="width: 100%;">Configure Coordinates</button>
            </div>

            <div id="mapper-controls">
                <!-- Dynamically generated based on mapper type -->
            </div>
        </div>

        <h2>Rendering<span class="help-icon" onclick="window.appModal?.show('docs', 'particle-settings')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Color Mode:<span class="help-icon" onclick="window.appModal?.show('docs', 'color-modes')" title="View documentation">üìù</span></label>
                <select id="color-mode">
                    <option value="white">Solid White</option>
                    <option value="velocity_magnitude">Velocity Magnitude</option>
                    <option value="velocity_angle">Velocity Angle</option>
                    <option value="velocity_combined">Velocity Angle + Magnitude</option>
                    <option value="expression">Expression</option>
                    <option value="custom">Custom (Advanced)</option>
                </select>
            </div>

            <div class="control-group" id="gradient-button-container" style="display: none;">
                <button id="open-gradient-editor" class="secondary" style="width: 100%;">Edit Gradient</button>
            </div>

            <div class="control-group" id="velocity-scaling-container" style="display: none;">
                <label>Velocity Scaling:</label>
                <select id="velocity-scale-mode">
                    <option value="percentile95">95th Percentile (Recommended)</option>
                    <option value="percentile90">90th Percentile</option>
                    <option value="average">Average</option>
                    <option value="max">Maximum</option>
                </select>
            </div>

            <div class="control-group" id="velocity-log-container" style="display: none;">
                <label>
                    <input type="checkbox" id="velocity-log-scale">
                    Logarithmic Velocity Scale
                </label>
            </div>

            <div id="expression-controls" style="display: none;">
                <div class="control-group">
                    <label>Color Expression:</label>
                    <input type="text" id="color-expression" placeholder="e.g., sin(x*y), length(pos), dx*dy" value="x * y">
                </div>
            </div>

            <div class="control-group">
                <label>Particle Count: <span class="range-value" id="particles-value">1000</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particles" data-action="decrease">-</button>
                    <input type="range" id="particles">
                    <button class="slider-btn" data-slider="particles" data-action="increase">+</button>
                </div>
            </div>

            <div class="control-group">
                <label>Fade Speed: <span class="range-value" id="fade-value">0.999</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="fade" data-action="decrease">-</button>
                    <input type="range" id="fade">
                    <button class="slider-btn" data-slider="fade" data-action="increase">+</button>
                </div>
            </div>

            <div class="control-group">
                <label>Drop Probability: <span class="range-value" id="drop-value">0.000</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="drop" data-action="decrease">-</button>
                    <input type="range" id="drop">
                    <button class="slider-btn" data-slider="drop" data-action="increase">+</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="drop-low-velocity">
                    Drop low velocity particles (&lt;2% max speed)
                </label>
            </div>


            <div class="control-group">
                <button id="open-rendering-settings" class="secondary" style="width: 100%;">Rendering Effects</button>
            </div>

        </div>

        <h2>Advanced<span class="help-icon" onclick="window.appModal?.show('docs', 'storage-strategy')" title="View documentation">üìù</span></h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Storage Strategy:</label>
                <select id="storage-strategy">
                    <option value="rgba">RGBA Encoded (Compatible)</option>
                    <option value="float" selected>Float Textures (Default)</option>
                </select>
                </div>
        </div>

        <div id="error-message"></div>
    </div>

    <div id="zoom-pan-controls">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>View<span class="help-icon" onclick="window.appModal?.show('docs', 'keyboard-shortcuts')" title="View documentation">üìù</span></h1>

        <!-- Pan controls in a 3x3 grid -->
        <div class="zoom-pan-grid">
            <button class="zoom-pan-btn" id="pan-up-left" title="Pan Up-Left">‚Üñ</button>
            <button class="zoom-pan-btn" id="pan-up" title="Pan Up">‚ñ≤</button>
            <button class="zoom-pan-btn" id="pan-up-right" title="Pan Up-Right">‚Üó</button>
            <button class="zoom-pan-btn" id="pan-left" title="Pan Left">‚óÄ</button>
            <button class="zoom-pan-btn" id="pan-reset" title="Center View at Origin">‚äô</button>
            <button class="zoom-pan-btn" id="pan-right" title="Pan Right">‚ñ∂</button>
            <button class="zoom-pan-btn" id="pan-down-left" title="Pan Down-Left">‚Üô</button>
            <button class="zoom-pan-btn" id="pan-down" title="Pan Down">‚ñº</button>
            <button class="zoom-pan-btn" id="pan-down-right" title="Pan Down-Right">‚Üò</button>
        </div>

        <!-- Zoom controls -->
        <div class="zoom-btn-group">
            <button class="zoom-pan-btn zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
            <button class="zoom-pan-btn zoom-btn" id="zoom-in" title="Zoom In">+</button>
        </div>
    </div>

    <div id="display-options">
        <button class="mobile-overlay-close" style="display: none;">&times;</button>
        <h1>Display<span class="help-icon" onclick="window.appModal?.show('docs', 'display-options')" title="View documentation">üìù</span></h1>

        <div class="control-group">
            <label>
                <input type="checkbox" id="show-grid" checked>
                Show coordinate grid
            </label>
        </div>

        <div class="control-group">
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="reset" class="secondary" style="flex: 1;">Reset View</button>
                <button id="reset-particles" class="secondary" style="flex: 1;">Clear Screen (C)</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="default-settings" class="secondary" style="flex: 1;">Default Settings</button>
                <button id="share-url" class="secondary" style="flex: 1;">Share URL</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%;">
                <button id="save-image" class="secondary" style="flex: 1;">Save Image</button>
            </div>
        </div>

        <!-- Animation Section -->
        <h1 style="cursor: pointer; user-select: none;" id="animation-section-toggle">
            Animation <span id="animation-section-arrow">‚ñº</span>
        </h1>
        <div id="animation-section-content" style="display: none;">
            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Interactive Testing</h4>

            <!-- Animation alpha control will be injected here -->
            <div id="animation-alpha-container"></div>

            <!-- Animation speed control -->
            <div id="animation-speed-container"></div>

            <div class="control-group" style="margin-top: 12px;">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Reinitialize particle positions when alpha updates">
                    <input type="checkbox" id="animation-clear-particles" style="margin-right: 8px;">
                    <span>Reset particles on alpha change</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Clear screen and freeze rendering between alpha updates for clean transitions">
                    <input type="checkbox" id="animation-clear-screen" style="margin-right: 8px;">
                    <span>Freeze screen between alpha changes</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Maintain consistent frame time by adding delays to faster alpha steps">
                    <input type="checkbox" id="animation-smooth-timing" style="margin-right: 8px;">
                    <span>Alpha step time smoothing</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="When enabled, prevents shader recompilation while animation is playing (prevents hiccups from parameter changes)">
                    <input type="checkbox" id="animation-lock-shaders" style="margin-right: 8px;">
                    <span>Lock shaders during playback</span>
                </label>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="export-animation-json" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    üíæ Export Settings as Animation JSON
                </button>
                </div>

            <hr style="border: none; border-top: 1px solid #333; margin: 16px 0;">


            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Create Animation</h4>

            <div class="control-group">
                <label>Frames:</label>
                <input type="number" id="animation-frames" value="100" min="1" max="10000" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </div>

            <div class="control-group">
                <label>Loops:</label>
                <input type="number" id="animation-loops" value="1" min="1" max="100" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="animation-half-loops" style="margin-right: 8px;">
                    <span>Count as half-loops</span>
                </label>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="animation-create-btn" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ‚ñ∂ Create Animation
                </button>
            </div>

            <div id="animation-progress" style="display: none; margin-top: 12px;">
                <div style="font-size: 10px; margin-bottom: 4px;">
                    <span id="progress-text">Frame 0 / 0</span>
                    <span id="progress-alpha" style="float: right; color: #4CAF50;">Œ±: 0.00</span>
                </div>
                <div style="background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 16px; border: 1px solid #444;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="animation-download-btn" style="width: 100%; padding: 6px; background: #42A5F5; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>
                    üíæ Download Animation (ZIP)
                </button>
            </div>
        </div>
    </div>

    <canvas id="grid-canvas"></canvas>

    <div id="cursor-position"></div>

    <div id="histogram-panel">
        <div id="histogram-header">
            <h4>HDR Brightness Histogram</h4>
            <span id="histogram-expand">‚ñº</span>
        </div>
        <div id="histogram-body">
            <canvas id="histogram-canvas"></canvas>
            <div id="histogram-info">
                Avg: <span id="hist-avg">--</span> | Max: <span id="hist-max">--</span><br>
                Max Vel: <span id="hist-vel">--</span>
            </div>
        </div>
    </div>

    <div id="step-time-counter" style="display: none;">Step: --ms</div>
    <div id="fps-counter">
        <div class="fps-display">FPS: --</div>
        <div class="frame-limit-controls">
            <label>
                <input type="checkbox" id="frame-limit-enabled">
                Stop at:
            </label>
            <input type="range" id="frame-limit" min="0" max="100" step="1" value="30">
            <span class="range-value" id="frame-limit-value">1k</span>
        </div>
    </div>

    <!-- Floating gradient panel -->
    <div id="gradient-panel" class="floating-panel" style="display: none;">
        <div class="floating-panel-header">
            <h3>Gradient Editor<span class="help-icon" onclick="window.appModal?.show('docs', 'color-modes')" title="View documentation">üìù</span></h3>
        </div>
        <div class="floating-panel-content">
            <div id="gradient-preset-toggle" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #444;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="use-custom-gradient" style="margin-right: 8px;">
                    <span>Apply to preset color modes</span>
                </label>
            </div>
            <div id="main-gradient-editor"></div>
        </div>
    </div>

    <!-- Floating rendering settings panel -->
    <div id="rendering-panel" class="floating-panel" style="display: none;">
        <div class="floating-panel-header">
            <h3>Rendering Effects<span class="help-icon" onclick="window.appModal?.show('docs', 'rendering-effects')" title="View documentation">üìù</span></h3>
        </div>
        <div class="floating-panel-content">
            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">HDR Rendering</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="use-hdr" checked>
                    Enable HDR (float framebuffers)
                </label>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="use-depth-test">
                    Enable Depth Testing (Plasma Mode)
                </label>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Render Scale</h4>
            <div class="control-group">
                <label>Resolution Scale: <span class="range-value" id="supersample-factor-value">1.0x</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="supersample-factor" data-action="decrease">-</button>
                    <input type="range" id="supersample-factor">
                    <button class="slider-btn" data-slider="supersample-factor" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="supersample-factor" data-action="reset" title="Reset to default (1.0x)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">SMAA Antialiasing</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="smaa-enabled" checked>
                    Enable SMAA (morphological AA)
                </label>
            </div>

            <div class="control-group">
                <label>SMAA Intensity: <span class="range-value" id="smaa-intensity-value">0.75</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="decrease">-</button>
                    <input type="range" id="smaa-intensity">
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="reset" title="Reset to default (0.75)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>SMAA Threshold: <span class="range-value" id="smaa-threshold-value">0.10</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="decrease">-</button>
                    <input type="range" id="smaa-threshold">
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="reset" title="Reset to default (0.10)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Bilateral Filter (Noise Reduction)</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="bilateral-enabled">
                    Enable Bilateral Filter
                </label>
            </div>

            <div class="control-group">
                <label>Spatial Sigma: <span class="range-value" id="bilateral-spatial-value">4.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="decrease">-</button>
                    <input type="range" id="bilateral-spatial">
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="reset" title="Reset to default (4.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Intensity Sigma: <span class="range-value" id="bilateral-intensity-value">0.20</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="decrease">-</button>
                    <input type="range" id="bilateral-intensity">
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="reset" title="Reset to default (0.20)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Tone Mapping</h4>
            <div class="control-group">
                <label>Operator:</label>
                <select id="tonemap-operator">
                    <option value="aces" selected>ACES (Film-like)</option>
                    <option value="reinhard">Reinhard (Simple)</option>
                    <option value="reinhard_extended">Reinhard Extended</option>
                    <option value="luminance_reinhard">Luminance Reinhard (Hue Preserving)</option>
                    <option value="luminance_extended">Luminance Extended (Best for Attractors)</option>
                    <option value="filmic">Filmic</option>
                    <option value="uncharted2">Uncharted 2 (Game-style)</option>
                    <option value="hable">Hable Filmic</option>
                    <option value="linear">Linear (No Tone Mapping)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Exposure: <span class="range-value" id="exposure-value">1.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="exposure" data-action="decrease">-</button>
                    <input type="range" id="exposure">
                    <button class="slider-btn" data-slider="exposure" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="exposure" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Gamma: <span class="range-value" id="gamma-value">2.2</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="gamma" data-action="decrease">-</button>
                    <input type="range" id="gamma">
                    <button class="slider-btn" data-slider="gamma" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="gamma" data-action="reset" title="Reset to default (2.2)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Luminance Gamma: <span class="range-value" id="luminance-gamma-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="decrease">-</button>
                    <input type="range" id="luminance-gamma">
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Highlight Compression: <span class="range-value" id="highlight-compression-value">0.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="highlight-compression" data-action="decrease">-</button>
                    <input type="range" id="highlight-compression">
                    <button class="slider-btn" data-slider="highlight-compression" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="highlight-compression" data-action="reset" title="Reset to default (0.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Compression Threshold: <span class="range-value" id="compression-threshold-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="compression-threshold" data-action="decrease">-</button>
                    <input type="range" id="compression-threshold">
                    <button class="slider-btn" data-slider="compression-threshold" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="compression-threshold" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group" id="white-point-control">
                <label>White Point: <span class="range-value" id="white-point-value">2.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="white-point" data-action="decrease">-</button>
                    <input type="range" id="white-point">
                    <button class="slider-btn" data-slider="white-point" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="white-point" data-action="reset" title="Reset to default (2.0)">‚Ü∫</button>
                </div>
            </div>

            <!-- Bloom Effect (Hidden - WIP) -->
            <div style="display: none;">
                <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Bloom Effect</h4>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="bloom-enabled">
                        Enable Bloom (bright regions glow)
                    </label>
                </div>

                <div class="control-group">
                    <label>Bloom Intensity: <span class="range-value" id="bloom-intensity-value">0.30</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="decrease">-</button>
                        <input type="range" id="bloom-intensity">
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="reset" title="Reset to default (0.3)">‚Ü∫</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Bloom Radius: <span class="range-value" id="bloom-radius-value">1.0</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-radius" data-action="decrease">-</button>
                        <input type="range" id="bloom-radius">
                        <button class="slider-btn" data-slider="bloom-radius" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-radius" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Bloom Alpha: <span class="range-value" id="bloom-alpha-value">1.00</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="decrease">-</button>
                        <input type="range" id="bloom-alpha">
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                    </div>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Intensity</h4>
            <div class="control-group">
                <label>Intensity: <span class="range-value" id="particle-intensity-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particle-intensity" data-action="decrease">-</button>
                    <input type="range" id="particle-intensity">
                    <button class="slider-btn" data-slider="particle-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="particle-intensity" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Size</h4>
            <div class="control-group">
                <label>Size: <span class="range-value" id="particle-size-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particle-size" data-action="decrease">-</button>
                    <input type="range" id="particle-size">
                    <button class="slider-btn" data-slider="particle-size" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="particle-size" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Render Mode</h4>
            <div class="control-group">
                <label>Mode:</label>
                <select id="particle-render-mode">
                    <option value="points">Points</option>
                    <option value="lines">Lines (Motion Trails)</option>
                </select>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Color Saturation</h4>
            <div class="control-group">
                <label>Saturation: <span class="range-value" id="color-saturation-value">1.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="color-saturation" data-action="decrease">-</button>
                    <input type="range" id="color-saturation">
                    <button class="slider-btn" data-slider="color-saturation" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="color-saturation" data-action="reset" title="Reset to default (1.0)">‚Ü∫</button>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Brightness Desaturation</h4>
            <div class="control-group">
                <label>Bright Desat: <span class="range-value" id="brightness-desat-value">0.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="brightness-desat" data-action="decrease">-</button>
                    <input type="range" id="brightness-desat">
                    <button class="slider-btn" data-slider="brightness-desat" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="brightness-desat" data-action="reset" title="Reset to default (0.0)">‚Ü∫</button>
                </div>
            </div>

            <div class="control-group">
                <label>Saturation Buildup: <span class="range-value" id="saturation-buildup-value">0.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="decrease">-</button>
                    <input type="range" id="saturation-buildup">
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="reset" title="Reset to default (0.0)">‚Ü∫</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Floating animation panel -->
    <div id="animation-panel" class="floating-panel" style="display: none; left: 20px; right: auto; z-index: 10000;">
        <div class="floating-panel-header">
            <h3>Animation<span class="help-icon" onclick="window.appModal?.show('docs', 'animation')" title="View documentation">üìù</span></h3>
            <button id="animation-panel-lock" style="background: none; border: 1px solid #666; color: #666; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 16px; margin-left: auto;" title="Lock panel open">üîì</button>
        </div>
        <div class="floating-panel-content">
            <!-- Animation Testing Section -->
            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Interactive Testing</h4>

            <!-- Animation alpha control will be injected here -->
            <div id="animation-alpha-container"></div>

            <!-- Animation speed control -->
            <div id="animation-speed-container"></div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="export-animation-json" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    üíæ Export Settings as Animation JSON
                </button>
                </div>

            <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;">

            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Create Animation</h4>

            <div class="control-group">
                <label>Frames:</label>
                <input type="number" id="animation-frames" value="100" min="1" max="10000" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </div>

            <div class="control-group">
                <label>Loops:</label>
                <input type="number" id="animation-loops" value="1" min="1" max="100" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="animation-half-loops" style="margin-right: 8px;">
                    <span>Count as half-loops</span>
                </label>
            </div>

            <div class="control-group" style="margin-top: 16px;">
                <button id="animation-create-btn" style="width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    ‚ñ∂ Create Animation
                </button>
            </div>

            <div id="animation-progress" style="display: none; margin-top: 12px;">
                <div style="font-size: 11px; margin-bottom: 6px;">
                    <span id="progress-text">Frame 0 / 0</span>
                    <span id="progress-alpha" style="float: right; color: #4CAF50;">Œ±: 0.00</span>
                </div>
                <div style="background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 20px; border: 1px solid #444;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 16px;">
                <button id="animation-download-btn" style="width: 100%; padding: 8px; background: #42A5F5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;" disabled>
                    üíæ Download Animation (ZIP)
                </button>
            </div>
        </div>
    </div>

    <!-- Nerdamer for symbolic differentiation (Jacobian computation) -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/all.min.js"></script>
    <!-- JSZip for bundling animation frames -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Marked.js for markdown parsing in documentation -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Coordinate System Modules (loaded before main.js) -->
    <!-- Register Service Worker and wait for it to be ready before loading modules -->
    <script>
        (async function() {
            // Use timestamp as version
            const version = Date.now();

            // Check if we're on HTTPS or localhost (service workers require secure context)
            const isSecureContext = location.protocol === 'https:' ||
                                   location.hostname === 'localhost' ||
                                   location.hostname === '127.0.0.1';

            // Register and activate service worker first (if available and in secure context)
            if (isSecureContext && 'serviceWorker' in navigator) {
                try {
                    // Unregister all existing service workers first (clean slate)
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('Unregistered old service worker');
                    }

                    // Register fresh service worker
                    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('Service Worker registered for cache-busting', registration);

                    // Wait for service worker to be active
                    await new Promise((resolve) => {
                        if (registration.active) {
                            resolve();
                        } else if (registration.installing) {
                            registration.installing.addEventListener('statechange', function() {
                                if (this.state === 'activated') {
                                    resolve();
                                }
                            });
                        } else if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            resolve();
                        }
                    });

                    // Wait for controller
                    if (!navigator.serviceWorker.controller) {
                        console.log('Waiting for service worker to take control...');
                        await new Promise((resolve) => {
                            navigator.serviceWorker.addEventListener('controllerchange', resolve, { once: true });
                        });
                    }

                    console.log('Service Worker is active and controlling page');
                    console.log('Controller:', navigator.serviceWorker.controller);
                } catch (error) {
                    console.warn('Service Worker registration failed:', error);
                }
            } else if (!isSecureContext) {
                console.log('Service Worker disabled: not running on HTTPS or localhost (this is OK for static hosting)');
            } else {
                console.warn('Service Workers not supported in this browser');
            }

            // Load main.js with version
            const script = document.createElement('script');
            script.type = 'module';
            script.src = `src/main.js?v=${version}`;
            document.body.appendChild(script);

            console.log(`Loading main.js entry point with version: ${version}`);
        })();
    </script>

    <!-- Modal Window -->
    <div id="modal-overlay">
        <div id="modal-window">
            <div id="modal-header">
                <h2 id="modal-title">Advanced Settings</h2>
                <button id="modal-close">&times;</button>
            </div>
            <div id="modal-tab-bar">
                <!-- Tab buttons will be added dynamically -->
            </div>
            <div id="modal-content">
                <!-- Tab content will be rendered here -->
            </div>
        </div>
    </div>
    <script src="app.min.js"></script>
</body>
</html>
